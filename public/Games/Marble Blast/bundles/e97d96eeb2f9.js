!function(){"use strict";const e={modification:null,level:null,menu:null};class t{constructor(e=0,t=0,i=0,s=1){this.x=e,this.y=t,this.z=i,this.w=s}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}clone(){return new t(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}setFromEuler(e){const t=e.x,i=e.y,s=e.z,n=e.order,r=Math.cos,a=Math.sin,o=r(t/2),l=r(i/2),h=r(s/2),d=a(t/2),c=a(i/2),u=a(s/2);switch(n){case"XYZ":this.x=d*l*h+o*c*u,this.y=o*c*h-d*l*u,this.z=o*l*u+d*c*h,this.w=o*l*h-d*c*u;break;case"YXZ":this.x=d*l*h+o*c*u,this.y=o*c*h-d*l*u,this.z=o*l*u-d*c*h,this.w=o*l*h+d*c*u;break;case"ZXY":this.x=d*l*h-o*c*u,this.y=o*c*h+d*l*u,this.z=o*l*u+d*c*h,this.w=o*l*h-d*c*u;break;case"ZYX":this.x=d*l*h-o*c*u,this.y=o*c*h+d*l*u,this.z=o*l*u-d*c*h,this.w=o*l*h+d*c*u;break;case"YZX":this.x=d*l*h+o*c*u,this.y=o*c*h+d*l*u,this.z=o*l*u-d*c*h,this.w=o*l*h-d*c*u;break;case"XZY":this.x=d*l*h-o*c*u,this.y=o*c*h-d*l*u,this.z=o*l*u+d*c*h,this.w=o*l*h+d*c*u;break;default:console.warn("Quaternion: .setFromEuler() encountered an unknown order: "+n)}return this}setFromAxisAngle(e,t){const i=t/2,s=Math.sin(i);return this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=Math.cos(i),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],s=t[4],n=t[8],r=t[1],a=t[5],o=t[9],l=t[2],h=t[6],d=t[10],c=i+a+d;if(c>0){const e=.5/Math.sqrt(c+1);this.w=.25/e,this.x=(h-o)*e,this.y=(n-l)*e,this.z=(r-s)*e}else if(i>a&&i>d){const e=2*Math.sqrt(1+i-a-d);this.w=(h-o)/e,this.x=.25*e,this.y=(s+r)/e,this.z=(n+l)/e}else if(a>d){const e=2*Math.sqrt(1+a-i-d);this.w=(n-l)/e,this.x=(s+r)/e,this.y=.25*e,this.z=(o+h)/e}else{const e=2*Math.sqrt(1+d-i-a);this.w=(r-s)/e,this.x=(n+l)/e,this.y=(o+h)/e,this.z=.25*e}return this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this.x=-e.y,this.y=e.x,this.z=0,this.w=i):(this.x=0,this.y=-e.z,this.z=e.y,this.w=i)):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(I.clamp(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const s=Math.min(1,t/i);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){let e=this.length();return 0===e?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e.x,s=e.y,n=e.z,r=e.w,a=t.x,o=t.y,l=t.z,h=t.w;return this.x=i*h+r*a+s*l-n*o,this.y=s*h+r*o+n*a-i*l,this.z=n*h+r*l+i*o-s*a,this.w=r*h-i*a-s*o-n*l,this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this.x,s=this.y,n=this.z,r=this.w;let a=r*e.w+i*e.x+s*e.y+n*e.z;if(a<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,a=-a):this.copy(e),a>=1)return this.w=r,this.x=i,this.y=s,this.z=n,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this.w=e*r+t*this.w,this.x=e*i+t*this.x,this.y=e*s+t*this.y,this.z=e*n+t*this.z,this.normalize(),this}const l=Math.sqrt(o),h=Math.atan2(l,a),d=Math.sin((1-t)*h)/l,c=Math.sin(t*h)/l;return this.w=r*d+this.w*c,this.x=i*d+this.x*c,this.y=s*d+this.y*c,this.z=n*d+this.z*c,this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=Math.random(),t=Math.sqrt(1-e),i=Math.sqrt(e),s=2*Math.PI*Math.random(),n=2*Math.PI*Math.random();return this.set(t*Math.cos(s),i*Math.sin(n),i*Math.cos(n),t*Math.sin(s))}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}}class i{constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}set(e,t,i){return this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new i(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(n.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(n.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*s,this.y=n[1]*t+n[4]*i+n[7]*s,this.z=n[2]*t+n[5]*i+n[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=e.elements,r=1/(n[3]*t+n[7]*i+n[11]*s+n[15]);return this.x=(n[0]*t+n[4]*i+n[8]*s+n[12])*r,this.y=(n[1]*t+n[5]*i+n[9]*s+n[13])*r,this.z=(n[2]*t+n[6]*i+n[10]*s+n[14])*r,this}applyQuaternion(e){const t=this.x,i=this.y,s=this.z,n=e.x,r=e.y,a=e.z,o=e.w,l=o*t+r*s-a*i,h=o*i+a*t-n*s,d=o*s+n*i-r*t,c=-n*t-r*i-a*s;return this.x=l*o+c*-n+h*-a-d*-r,this.y=h*o+c*-r+d*-n-l*-a,this.z=d*o+c*-a+l*-r-h*-n,this}transformDirection(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*s,this.y=n[1]*t+n[5]*i+n[9]*s,this.z=n[2]*t+n[6]*i+n[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,s=e.y,n=e.z,r=t.x,a=t.y,o=t.z;return this.x=s*o-n*a,this.y=n*r-i*o,this.z=i*a-s*r,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return s.copy(this).projectOnVector(e),this.sub(s)}reflect(e){return this.sub(s.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(I.clamp(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,s=this.z-e.z;return t*t+i*i+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=2*(Math.random()-.5),t=Math.random()*Math.PI*2,i=Math.sqrt(1-e**2);return this.x=i*Math.cos(t),this.y=i*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const s=new i,n=new t;class r{constructor(e=new i(1/0,1/0,1/0),t=new i(-1/0,-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=1/0,i=1/0,s=1/0,n=-1/0,r=-1/0,a=-1/0;for(let o=0,l=e.length;o<l;o+=3){const l=e[o],h=e[o+1],d=e[o+2];l<t&&(t=l),h<i&&(i=h),d<s&&(s=d),l>n&&(n=l),h>r&&(r=h),d>a&&(a=d)}return this.min.set(t,i,s),this.max.set(n,r,a),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=o.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}clone(){return(new r).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return o.copy(e).clamp(this.min,this.max).sub(e).length()}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()?this:(a[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),a[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),a[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),a[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),a[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),a[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),a[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),a[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(a),this)}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const a=[new i,new i,new i,new i,new i,new i,new i,new i],o=new i;class l{constructor(){this.elements=[1,0,0,0,1,0,0,0,1]}set(e,t,i,s,n,r,a,o,l){const h=this.elements;return h[0]=e,h[1]=s,h[2]=a,h[3]=t,h[4]=n,h[5]=o,h[6]=i,h[7]=r,h[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,r=i[0],a=i[3],o=i[6],l=i[1],h=i[4],d=i[7],c=i[2],u=i[5],m=i[8],p=s[0],g=s[3],f=s[6],y=s[1],b=s[4],v=s[7],w=s[2],x=s[5],S=s[8];return n[0]=r*p+a*y+o*w,n[3]=r*g+a*b+o*x,n[6]=r*f+a*v+o*S,n[1]=l*p+h*y+d*w,n[4]=l*g+h*b+d*x,n[7]=l*f+h*v+d*S,n[2]=c*p+u*y+m*w,n[5]=c*g+u*b+m*x,n[8]=c*f+u*v+m*S,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}add(e){for(let t=0;t<9;t++)this.elements[t]+=e.elements[t];return this}sub(e){for(let t=0;t<9;t++)this.elements[t]-=e.elements[t];return this}determinant(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],l=e[7],h=e[8];return t*r*h-t*a*l-i*n*h+i*a*o+s*n*l-s*r*o}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],l=e[7],h=e[8],d=h*r-a*l,c=a*o-h*n,u=l*n-r*o,m=t*d+i*c+s*u;if(0===m)return this.set(0,0,0,0,0,0,0,0,0);const p=1/m;return e[0]=d*p,e[1]=(s*l-h*i)*p,e[2]=(a*i-s*r)*p,e[3]=c*p,e[4]=(h*t-s*o)*p,e[5]=(s*n-a*t)*p,e[6]=u*p,e[7]=(i*o-l*t)*p,e[8]=(r*t-i*n)*p,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,s,n,r,a){const o=Math.cos(n),l=Math.sin(n);return this.set(i*o,i*l,-i*(o*r+l*a)+r+e,-s*l,s*o,-s*(-l*r+o*a)+a+t,0,0,1),this}scale(e,t){const i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=t,i[4]*=t,i[7]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),s=this.elements,n=s[0],r=s[3],a=s[6],o=s[1],l=s[4],h=s[7];return s[0]=t*n+i*o,s[3]=t*r+i*l,s[6]=t*a+i*h,s[1]=-i*n+t*o,s[4]=-i*r+t*l,s[7]=-i*a+t*h,this}translate(e,t){const i=this.elements;return i[0]+=e*i[2],i[3]+=e*i[5],i[6]+=e*i[8],i[1]+=t*i[2],i[4]+=t*i[5],i[7]+=t*i[8],this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new l).fromArray(this.elements)}}class h{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}set(e,t,i,s,n,r,a,o,l,h,d,c,u,m,p,g){const f=this.elements;return f[0]=e,f[4]=t,f[8]=i,f[12]=s,f[1]=n,f[5]=r,f[9]=a,f[13]=o,f[2]=l,f[6]=h,f[10]=d,f[14]=c,f[3]=u,f[7]=m,f[11]=p,f[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new h).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,s=1/d.setFromMatrixColumn(e,0).length(),n=1/d.setFromMatrixColumn(e,1).length(),r=1/d.setFromMatrixColumn(e,2).length();return t[0]=i[0]*s,t[1]=i[1]*s,t[2]=i[2]*s,t[3]=0,t[4]=i[4]*n,t[5]=i[5]*n,t[6]=i[6]*n,t[7]=0,t[8]=i[8]*r,t[9]=i[9]*r,t[10]=i[10]*r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,i=e.x,s=e.y,n=e.z,r=Math.cos(i),a=Math.sin(i),o=Math.cos(s),l=Math.sin(s),h=Math.cos(n),d=Math.sin(n);if("XYZ"===e.order){const e=r*h,i=r*d,s=a*h,n=a*d;t[0]=o*h,t[4]=-o*d,t[8]=l,t[1]=i+s*l,t[5]=e-n*l,t[9]=-a*o,t[2]=n-e*l,t[6]=s+i*l,t[10]=r*o}else if("YXZ"===e.order){const e=o*h,i=o*d,s=l*h,n=l*d;t[0]=e+n*a,t[4]=s*a-i,t[8]=r*l,t[1]=r*d,t[5]=r*h,t[9]=-a,t[2]=i*a-s,t[6]=n+e*a,t[10]=r*o}else if("ZXY"===e.order){const e=o*h,i=o*d,s=l*h,n=l*d;t[0]=e-n*a,t[4]=-r*d,t[8]=s+i*a,t[1]=i+s*a,t[5]=r*h,t[9]=n-e*a,t[2]=-r*l,t[6]=a,t[10]=r*o}else if("ZYX"===e.order){const e=r*h,i=r*d,s=a*h,n=a*d;t[0]=o*h,t[4]=s*l-i,t[8]=e*l+n,t[1]=o*d,t[5]=n*l+e,t[9]=i*l-s,t[2]=-l,t[6]=a*o,t[10]=r*o}else if("YZX"===e.order){const e=r*o,i=r*l,s=a*o,n=a*l;t[0]=o*h,t[4]=n-e*d,t[8]=s*d+i,t[1]=d,t[5]=r*h,t[9]=-a*h,t[2]=-l*h,t[6]=i*d+s,t[10]=e-n*d}else if("XZY"===e.order){const e=r*o,i=r*l,s=a*o,n=a*l;t[0]=o*h,t[4]=-d,t[8]=l*h,t[1]=e*d+n,t[5]=r*h,t[9]=i*d-s,t[2]=s*d-i,t[6]=a*h,t[10]=n*d+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(u,e,m)}lookAt(e,t,i){const s=this.elements;return f.subVectors(e,t),0===f.lengthSq()&&(f.z=1),f.normalize(),p.crossVectors(i,f),0===p.lengthSq()&&(1===Math.abs(i.z)?f.x+=1e-4:f.z+=1e-4,f.normalize(),p.crossVectors(i,f)),p.normalize(),g.crossVectors(f,p),s[0]=p.x,s[4]=g.x,s[8]=f.x,s[1]=p.y,s[5]=g.y,s[9]=f.y,s[2]=p.z,s[6]=g.z,s[10]=f.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,r=i[0],a=i[4],o=i[8],l=i[12],h=i[1],d=i[5],c=i[9],u=i[13],m=i[2],p=i[6],g=i[10],f=i[14],y=i[3],b=i[7],v=i[11],w=i[15],x=s[0],S=s[4],T=s[8],M=s[12],C=s[1],k=s[5],A=s[9],_=s[13],I=s[2],E=s[6],B=s[10],P=s[14],L=s[3],R=s[7],F=s[11],z=s[15];return n[0]=r*x+a*C+o*I+l*L,n[4]=r*S+a*k+o*E+l*R,n[8]=r*T+a*A+o*B+l*F,n[12]=r*M+a*_+o*P+l*z,n[1]=h*x+d*C+c*I+u*L,n[5]=h*S+d*k+c*E+u*R,n[9]=h*T+d*A+c*B+u*F,n[13]=h*M+d*_+c*P+u*z,n[2]=m*x+p*C+g*I+f*L,n[6]=m*S+p*k+g*E+f*R,n[10]=m*T+p*A+g*B+f*F,n[14]=m*M+p*_+g*P+f*z,n[3]=y*x+b*C+v*I+w*L,n[7]=y*S+b*k+v*E+w*R,n[11]=y*T+b*A+v*B+w*F,n[15]=y*M+b*_+v*P+w*z,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}add(e){for(let t=0;t<16;t++)this.elements[t]+=e.elements[t];return this}sub(e){for(let t=0;t<16;t++)this.elements[t]-=e.elements[t];return this}determinant(){const e=this.elements,t=e[0],i=e[4],s=e[8],n=e[12],r=e[1],a=e[5],o=e[9],l=e[13],h=e[2],d=e[6],c=e[10],u=e[14];return e[3]*(+n*o*d-s*l*d-n*a*c+i*l*c+s*a*u-i*o*u)+e[7]*(+t*o*u-t*l*c+n*r*c-s*r*u+s*l*h-n*o*h)+e[11]*(+t*l*d-t*a*u-n*r*d+i*r*u+n*a*h-i*l*h)+e[15]*(-s*a*h-t*o*d+t*a*c+s*r*d-i*r*c+i*o*h)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e){const t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],a=e[5],o=e[6],l=e[7],h=e[8],d=e[9],c=e[10],u=e[11],m=e[12],p=e[13],g=e[14],f=e[15],y=d*g*l-p*c*l+p*o*u-a*g*u-d*o*f+a*c*f,b=m*c*l-h*g*l-m*o*u+r*g*u+h*o*f-r*c*f,v=h*p*l-m*d*l+m*a*u-r*p*u-h*a*f+r*d*f,w=m*d*o-h*p*o-m*a*c+r*p*c+h*a*g-r*d*g,x=t*y+i*b+s*v+n*w;if(0===x)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const S=1/x;return e[0]=y*S,e[1]=(p*c*n-d*g*n-p*s*u+i*g*u+d*s*f-i*c*f)*S,e[2]=(a*g*n-p*o*n+p*s*l-i*g*l-a*s*f+i*o*f)*S,e[3]=(d*o*n-a*c*n-d*s*l+i*c*l+a*s*u-i*o*u)*S,e[4]=b*S,e[5]=(h*g*n-m*c*n+m*s*u-t*g*u-h*s*f+t*c*f)*S,e[6]=(m*o*n-r*g*n-m*s*l+t*g*l+r*s*f-t*o*f)*S,e[7]=(r*c*n-h*o*n+h*s*l-t*c*l-r*s*u+t*o*u)*S,e[8]=v*S,e[9]=(m*d*n-h*p*n-m*i*u+t*p*u+h*i*f-t*d*f)*S,e[10]=(r*p*n-m*a*n+m*i*l-t*p*l-r*i*f+t*a*f)*S,e[11]=(h*a*n-r*d*n-h*i*l+t*d*l+r*i*u-t*a*u)*S,e[12]=w*S,e[13]=(h*p*s-m*d*s+m*i*c-t*p*c-h*i*g+t*d*g)*S,e[14]=(m*a*s-r*p*s-m*i*o+t*p*o+r*i*g-t*a*g)*S,e[15]=(r*d*s-h*a*s+h*i*o-t*d*o-r*i*c+t*a*c)*S,this}scale(e){const t=this.elements,i=e.x,s=e.y,n=e.z;return t[0]*=i,t[4]*=s,t[8]*=n,t[1]*=i,t[5]*=s,t[9]*=n,t[2]*=i,t[6]*=s,t[10]*=n,t[3]*=i,t[7]*=s,t[11]*=n,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,s))}makeTranslation(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),s=Math.sin(t),n=1-i,r=e.x,a=e.y,o=e.z,l=n*r,h=n*a;return this.set(l*r+i,l*a-s*o,l*o+s*a,0,l*a+s*o,h*a+i,h*o-s*r,0,l*o-s*a,h*o+s*r,n*o*o+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,s,n,r){return this.set(1,i,n,0,e,1,r,0,t,s,1,0,0,0,0,1),this}compose(e,t,i){const s=this.elements,n=t.x,r=t.y,a=t.z,o=t.w,l=n+n,h=r+r,d=a+a,c=n*l,u=n*h,m=n*d,p=r*h,g=r*d,f=a*d,y=o*l,b=o*h,v=o*d,w=i.x,x=i.y,S=i.z;return s[0]=(1-(p+f))*w,s[1]=(u+v)*w,s[2]=(m-b)*w,s[3]=0,s[4]=(u-v)*x,s[5]=(1-(c+f))*x,s[6]=(g+y)*x,s[7]=0,s[8]=(m+b)*S,s[9]=(g-y)*S,s[10]=(1-(c+p))*S,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,i){const s=this.elements;let n=d.set(s[0],s[1],s[2]).length();const r=d.set(s[4],s[5],s[6]).length(),a=d.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),e.x=s[12],e.y=s[13],e.z=s[14],c.copy(this);const o=1/n,l=1/r,h=1/a;return c.elements[0]*=o,c.elements[1]*=o,c.elements[2]*=o,c.elements[4]*=l,c.elements[5]*=l,c.elements[6]*=l,c.elements[8]*=h,c.elements[9]*=h,c.elements[10]*=h,t.setFromRotationMatrix(c),i.x=n,i.y=r,i.z=a,this}makePerspective(e,t,i,s,n,r){const a=this.elements,o=2*n/(t-e),l=2*n/(i-s),h=(t+e)/(t-e),d=(i+s)/(i-s),c=-(r+n)/(r-n),u=-2*r*n/(r-n);return a[0]=o,a[4]=0,a[8]=h,a[12]=0,a[1]=0,a[5]=l,a[9]=d,a[13]=0,a[2]=0,a[6]=0,a[10]=c,a[14]=u,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(e,t,i,s,n,r){const a=this.elements,o=1/(t-e),l=1/(i-s),h=1/(r-n),d=(t+e)*o,c=(i+s)*l,u=(r+n)*h;return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-d,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-c,a[2]=0,a[6]=0,a[10]=-2*h,a[14]=-u,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}const d=new i,c=new h,u=new i(0,0,0),m=new i(1,1,1),p=new i,g=new i,f=new i;let y=new i,b=new i,v=new i,w=new i,x=new i,S=new h,T=new t;class M{constructor(){this.body=null,this.boundingBox=new r,this.margin=0,this.broadphaseShape=null,this.collisionDetectionMask=1,this.collisionResponseMask=1,this.friction=1,this.restitution=1,this.mass=1,this.inertia=new l,this.invInertia=new l,this.materialOverrides=new Map}updateBoundingBox(){var e,t;if(S.compose(this.body.position,this.body.orientation,y.setScalar(1)),this.boundingBox.applyMatrix4(S),this.boundingBox.min.subScalar(this.margin),this.boundingBox.max.addScalar(this.margin),this.body.prevValid){let e=y.copy(this.body.position).sub(this.body.prevPosition);b.copy(this.boundingBox.min).sub(e),v.copy(this.boundingBox.max).sub(e),this.boundingBox.expandByPoint(b).expandByPoint(v)}null===(t=null===(e=this.body)||void 0===e?void 0:e.world)||void 0===t||t.octree.update(this)}}class C extends M{constructor(e){super(),this.radius=e,this.updateInertiaTensor()}updateInertiaTensor(){let e=.4*this.mass*this.radius**2;this.inertia.identity().multiplyScalar(e),this.invInertia.copy(this.inertia).invert()}support(e,t){return e.copy(t).setLength(this.radius).add(this.body.position),this.margin>0&&e.add(y.copy(t).setLength(this.margin)),e}getCenter(e){return e.copy(this.body.position)}updateBoundingBox(){this.boundingBox.min.setScalar(-this.radius),this.boundingBox.max.setScalar(this.radius),super.updateBoundingBox()}}class k extends M{constructor(e){super(),this.localCenter=new i,this.localAabb=new r,this.points=e,this.computeLocalBoundingBox(),this.updateInertiaTensor()}computeLocalBoundingBox(){this.localCenter.setScalar(0);for(let e of this.points)this.localCenter.addScaledVector(e,1/this.points.length);this.localAabb.setFromPoints(this.points)}updateInertiaTensor(){}support(e,t){T.copy(this.body.orientation).conjugate();let i=y.copy(t).applyQuaternion(T),s=-1/0;for(let t=0;t<this.points.length;t++){let n=this.points[t],r=n.dot(i);r>s&&(s=r,e.copy(n))}return this.body.transformPoint(e),this.margin>0&&e.add(y.copy(t).setLength(this.margin)),e}getCenter(e){return this.body.transformPoint(e.copy(this.localCenter))}updateBoundingBox(){this.boundingBox.copy(this.localAabb),super.updateBoundingBox()}}class A extends M{updateInertiaTensor(){}support(e){return e.copy(this.body.position)}getCenter(e){return e.copy(this.body.position)}}class _{constructor(e=0,t=0){this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new _(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,s=e.elements;return this.x=s[0]*t+s[3]*i+s[6],this.y=s[1]*t+s[4]*i+s[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}rotateAround(e,t){const i=Math.cos(t),s=Math.sin(t),n=this.x-e.x,r=this.y-e.y;return this.x=n*i-r*s+e.x,this.y=n*s+r*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class I{static async init(){var e;try{this.keyboardMap=await(null===(e=navigator.keyboard)||void 0===e?void 0:e.getLayoutMap())}catch(e){}}static degToRad(e){return e/180*Math.PI}static randomFromArray(e){return e[Math.floor(Math.random()*e.length)]}static modifyImageWithCanvas(e,t,i=!1){let s=document.createElement("canvas");s.setAttribute("width",e.width.toString()),s.setAttribute("height",e.height.toString());let n=s.getContext("2d");return n.translate(e.width/2,e.height/2),i&&n.scale(1,-1),n.rotate(t),n.translate(-e.width/2,-e.height/2),n.drawImage(e,0,0,e.width,e.height),s}static removeAlphaChannel(e){let t=document.createElement("canvas");t.setAttribute("width",e.width.toString()),t.setAttribute("height",e.height.toString());let i=t.getContext("2d");i.drawImage(e,0,0);let s=i.getImageData(0,0,e.width,e.height);for(let e=0;e<s.data.length;e+=4)s.data[e+3]=255;return i.putImageData(s,0,0),t}static async resampleImage(e,t,i){let s=document.createElement("canvas");s.setAttribute("width",t.toString()),s.setAttribute("height",i.toString()),s.getContext("2d").drawImage(e,0,0,t,i);let n=s.toDataURL(),r=new Image;return r.src=n,await new Promise(e=>r.onload=e),r}static clamp(e,t,i){return e<t?t:e>i?i:e}static lerp(e,t,i){return(1-i)*e+i*t}static avg(e,t){return(e+t)/2}static isSameVector(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}static addToVectorCapped(e,t,i){let s=t.clone().normalize(),n=Math.max(0,e.dot(s));if(n+t.length()>i){let e=Math.max(0,i-n);t.normalize().multiplyScalar(e)}e.add(t)}static leftPadZeroes(e,t){return"0".repeat(Math.max(0,t-e.length))+e}static forceLayout(e){e.clientWidth}static getKeyForButtonCode(e){e:if(this.keyboardMap){let t=this.keyboardMap.get(e);if(!t)break e;return t.toUpperCase().length>1?t:t.toUpperCase()}return e.startsWith("Key")?e.slice(3):e.startsWith("Digit")?e.slice(5):e.startsWith("Arrow")?e.slice(5):"Space"===e?"Space Bar":"LMB"===e?"the Left Mouse Button":"MMB"===e?"the Middle Mouse Button":"RMB"===e?"the Right Mouse Button":e}static setsHaveOverlap(e,t){for(let i of e)if(t.has(i))return!0;return!1}static catmullRom(e,t,i,s,n){let r=e*e*e*(-1*t+3*i-3*s+n)/2;return r+=e*e*(2*t-5*i+4*s-n)/2,r+=e*(-1*t+s)/2,r+=i}static jsonClone(e){return JSON.parse(JSON.stringify(e))}static lerpColors(e,t,i){return{r:Math.floor(I.lerp(e.r,t.r,i)),g:Math.floor(I.lerp(e.g,t.g,i)),b:Math.floor(I.lerp(e.b,t.b,i)),a:Math.floor(I.lerp(e.a,t.a,i))}}static randomPointInUnitCircle(){let e=Math.sqrt(Math.random()),t=Math.random()*Math.PI*2;return new _(e*Math.cos(t),e*Math.sin(t))}static removeFromArray(e,t){let i=e.indexOf(t);-1!==i&&e.splice(i,1)}static m_matF_x_vectorF(e,t){let i=e.transpose().elements,s=t.x,n=t.y,r=t.z,a=i[0],o=i[1],l=i[2],h=i[4],d=i[5],c=i[6],u=i[8],m=i[9],p=i[10];e.transpose();let g=a*s+o*n+l*r,f=h*s+d*n+c*r,y=u*s+m*n+p*r;t.set(g,f,y)}static createCylinderConvexHull(e,t,s=32,n=new i(1,1,1)){let r=[];for(let a=0;a<2;a++)for(let o=0;o<s;o++){let l=o/s*Math.PI*2,h=Math.cos(l),d=Math.sin(l);r.push(new i(h*e*n.x,(a?t:-t)*n.y,d*e*n.z))}return new k(r)}static uppercaseFirstLetter(e){return e?e[0].toUpperCase()+e.slice(1):e}static wait(e){return new Promise(t=>setTimeout(t,e))}static adjustedMod(e,t){return(e%t+t)%t}static concatArrays(e){return 0===e.length?[]:e[0].concat(...e.slice(1))}static isInFullscreen(){var e,t;return window.innerHeight===screen.height||(null===(t=null===(e=screen.orientation)||void 0===e?void 0:e.type)||void 0===t?void 0:t.includes("portrait"))&&window.innerHeight===screen.width||!!document.fullscreenElement}static swapInArray(e,t,i){let s=e[t];e[t]=e[i],e[i]=s}static cameraLookAtDirect(e,s){let n=new i(0,0,-1);n.applyQuaternion(e.orientation);let r=new t;r.setFromUnitVectors(n,s.clone().sub(e.position).normalize()),e.orientation.copy(r.multiply(e.orientation))}static arrayBufferToString(e){let t="",i=new Uint8Array(e);for(let s=0;s<e.byteLength;s++)t+=String.fromCharCode(i[s]);return t}static stringToArrayBuffer(e){let t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t.buffer}static stringIsOnlyWhitespace(e){return 0===e.trim().length}static unescape(e){let t=/(^|[^\\])\\x([0-9a-f]{2})/gi,i=null;for(;null!==(i=t.exec(e));){let s=Number.parseInt(i[2],16),n=this.macRomanToUtf8(s);e=e.slice(0,i.index)+i[1]+n+e.slice(i.index+i[0].length),t.lastIndex-=3}let s=/\\(.)/g,n={"\\":"\\",t:"\t",v:"\v",0:"\0",f:"\f",n:"\n",r:"\r"};for(;null!==(i=s.exec(e));){let t;t=n[i[1]]?n[i[1]]:i[1],e=e.slice(0,i.index)+t+e.slice(i.index+i[0].length),s.lastIndex--}return e}static splitIgnoreStringLiterals(e,t,i='"'){let s=[],n=!1;for(let r=0;r<e.length;r++){let a=e[r];n?a===i&&"\\"!==e[r-1]&&(n=!1):a===i?n=!0:a===t&&s.push(r)}let r=[],a=e;for(let t=0;t<s.length;t++){let i=s[t]-(e.length-a.length),n=a.slice(0,i);a=a.slice(i+1),r.push(n)}return r.push(a),r}static indexOfIgnoreStringLiterals(e,t,i=0,s='"'){let n=!1;for(let r=i;r<e.length;r++){let i=e[r];if(n)i===s&&"\\"!==e[r-1]&&(n=!1);else if(i===s)n=!0;else if(e.startsWith(t,r))return r}return-1}static indexIsInStringLiteral(e,t,i='"'){let s=!1;for(let n=0;n<e.length;n++){let r=e[n];if(s){if(n===t)return!0;r===i&&"\\"!==e[n-1]&&(s=!1)}else r===i&&(s=!0)}return!1}static remapIndices(e,t){return t.map(t=>e[t])}static findLast(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return e[i]}static findLastIndex(e,t,i=e.length-1){for(let s=i;s>=0;s--)if(t(e[s]))return s;return-1}static normalizeString(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}static removeSpecialCharacters(e){return e.replace(/[-!$%^&*()_+|~=`{}\[\]:";'<>?,.\/]/g,"")}static last(e){return e[e.length-1]}static isSafari(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}static isFirefox(){return navigator.userAgent.includes("Firefox")}static download(e,t){let i=document.createElement("a");i.setAttribute("href",e),i.setAttribute("download",t),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}static removeSpecialChars(e){let t=/[^\w\d]/gi,i=null;for(;null!==(i=t.exec(e));)e=e.slice(0,i.index)+e.slice(i.index+i[0].length),t.lastIndex-=i[0].length;return e}static isNaughty(e){let t=e.toLowerCase().split(" ");for(let e of t)if(this.naughtyWords.includes(e))return!0;return!1}static shallowClone(e){let t={};for(let i in e)t[i]=e[i];return t}static isMac(){return window.navigator.platform.toLowerCase().includes("mac")}static isIOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}static secondsToTimeString(e,t=this.getDefaultSecondsToTimeStringDecimalDigits()){let i=Math.abs(e),s=Math.floor(i/60),n=I.leftPadZeroes(s.toString(),2)+":"+I.leftPadZeroes(Math.floor(i%60).toString(),2)+"."+I.leftPadZeroes(Math.floor(i*10**t%10**t).toString(),t);return e<0&&(n="-"+n),n}static async arrayBufferToBase64(e){let t=new Blob([e]),i=await new Promise(e=>{let i=new FileReader;i.onload=(t=>e(t.target.result)),i.readAsDataURL(t)});return i.slice(i.indexOf(",")+1)}static popRandomNumber(){return this.randomNumberQueue.length>0?this.randomNumberQueue.shift():Math.random()}static peekRandomNumber(e=0){for(;this.randomNumberQueue.length<=e;)this.randomNumberQueue.push(Math.random());return this.randomNumberQueue[e]}static compareVersions(e,t){let i=e.split(".").map(e=>Number(e)),s=t.split(".").map(e=>Number(e));for(let e=0;e<i.length;e++){let t=i[e],n=s[e];if(t>n)return 1;if(t<n)return-1}return 0}static checkIsTouchDevice(){return"ontouchstart"in window}static signedSqrt(e){return Math.sign(e)*Math.sqrt(Math.abs(e))}static signedSquare(e){return e*Math.abs(e)}static htmlEscape(e){return this.htmlEscapeElem.textContent=e,this.htmlEscapeElem.innerHTML}static getRandomId(){return Math.random().toString()}static roundToMultiple(e,t){return t?Math.round(e/t)*t:e}static rayIntersectsBox(e,t,i,s){let n=(i.min.x-e.x)/t.x,r=(i.max.x-e.x)/t.x,a=Math.min(n,r),o=Math.max(n,r),l=(i.min.y-e.y)/t.y,h=(i.max.y-e.y)/t.y;a=Math.max(a,Math.min(l,h)),o=Math.min(o,Math.max(l,h));let d=(i.min.z-e.z)/t.z,c=(i.max.z-e.z)/t.z;return a=Math.max(a,Math.min(d,c)),o=Math.min(o,Math.max(d,c)),s&&o>=a&&s.copy(e).addScaledVector(t,a>=0?a:o),o>=a}static macRomanToUtf8(e){return e<128?String.fromCharCode(e):this.macRomanToUtf8Map[e-128]}static monospaceNumbers(e,t=.5){e.innerHTML=e.textContent.split("").map(e=>e>="0"&&e<="9"?`<span style="width: ${t}em; display: inline-block; text-align: center;">${e}</span>`:e).join("")}static onLongTouch(e,t){let i,s=!1;e.addEventListener("touchstart",e=>{i=setTimeout(()=>{t(e),s=!0},500)}),e.addEventListener("touchend",e=>{clearTimeout(i),s&&(e.stopPropagation(),e.preventDefault(),s=!1)})}static absVector(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}static getPermutations(e){if(0===e.length)return[];if(1===e.length)return[e.slice()];let t=[];for(let i=0;i<e.length;i++){let s=e[i],n=e.slice();n.splice(i,1);let r=this.getPermutations(n);t.push(...r.map(e=>(e.unshift(s),e)))}return t}static pushArray(e,t){for(let i of t)e.push(i)}static requestPointerLock(){var e,t;let i=null===(t=(e=document.documentElement).requestPointerLock)||void 0===t?void 0:t.call(e);i&&i instanceof Promise&&i.catch(()=>{})}static isSubsequenceOf(e,t){if(e.length>t.length)return!1;let i=0;for(let s=0;s<e.length;s++){for(;t[i]!==e[s]&&i<t.length;)i++;if(i===t.length)return!1;i++}return!0}static isPowerOf2(e){return!(e&e-1)}static ceilPowerOf2(e){let t=1;for(;t<e;)t*=2;return t}static assert(e){if(!e)throw new Error("Assertion failed: "+e)}static getBoxVertices(e){let t=new i(e.max.x-e.min.x,0,0),s=new i(0,e.max.y-e.min.y,0),n=new i(0,0,e.max.z-e.min.z);return[e.min.clone(),e.min.clone().add(t),e.min.clone().add(s),e.min.clone().add(n),e.min.clone().add(t).add(s),e.min.clone().add(t).add(n),e.min.clone().add(s).add(n),e.max.clone()]}static cursedRound(e,t){return Math.floor((t-1)*e-Number.EPSILON+1)/t}static async checkDatabaseExists(e){return new Promise((t,i)=>{let s=!0;const n=indexedDB.open(e);n.onsuccess=function(){n.result.close(),s||indexedDB.deleteDatabase(e),t(s)},n.onerror=function(){i(new Error("Error opening database"))},n.onupgradeneeded=function(){s=!1}})}}I.naughtyWords=["2g1c","2 girls 1 cup","acrotomophilia","alabama hot pocket","alaskan pipeline","anal","anilingus","anus","apeshit","arsehole","ass","asshole","assmunch","auto erotic","autoerotic","babeland","baby batter","baby juice","ball gag","ball gravy","ball kicking","ball licking","ball sack","ball sucking","bangbros","bangbus","bareback","barely legal","barenaked","bastard","bastardo","bastinado","bbw","bdsm","beaner","beaners","beaver cleaver","beaver lips","beastiality","bestiality","big black","big breasts","big knockers","big tits","bimbos","birdlock","bitch","bitches","black cock","blonde action","blonde on blonde action","blowjob","blow job","blow your load","blue waffle","blumpkin","bollocks","bondage","boner","boob","boobs","booty call","brown showers","brunette action","bukkake","bulldyke","bullet vibe","bullshit","bung hole","bunghole","busty","butt","buttcheeks","butthole","camel toe","camgirl","camslut","camwhore","carpet muncher","carpetmuncher","chocolate rosebuds","cialis","circlejerk","cleveland steamer","clit","clitoris","clover clamps","clusterfuck","cock","cocks","coprolagnia","coprophilia","cornhole","coon","coons","creampie","cum","cumming","cumshot","cumshots","cunnilingus","cunt","darkie","date rape","daterape","deep throat","deepthroat","dendrophilia","dick","dildo","dingleberry","dingleberries","dirty pillows","dirty sanchez","doggie style","doggiestyle","doggy style","doggystyle","dog style","dolcett","domination","dominatrix","dommes","donkey punch","double dong","double penetration","dp action","dry hump","dvda","eat my ass","ecchi","ejaculation","erotic","erotism","escort","eunuch","fag","faggot","fecal","felch","fellatio","feltch","female squirting","femdom","figging","fingerbang","fingering","fisting","foot fetish","footjob","frotting","fuck","fuck buttons","fuckin","fucking","fucktards","fudge packer","fudgepacker","futanari","gangbang","gang bang","gay sex","genitals","giant cock","girl on","girl on top","girls gone wild","goatcx","goatse","god damn","gokkun","golden shower","goodpoop","goo girl","goregasm","grope","group sex","g-spot","guro","hand job","handjob","hard core","hardcore","hentai","homoerotic","honkey","hooker","horny","hot carl","hot chick","how to kill","how to murder","huge fat","humping","incest","intercourse","jack off","jail bait","jailbait","jelly donut","jerk off","jigaboo","jiggaboo","jiggerboo","jizz","juggs","kike","kinbaku","kinkster","kinky","knobbing","leather restraint","leather straight jacket","lemon party","livesex","lolita","lovemaking","make me come","male squirting","masturbate","masturbating","masturbation","menage a trois","milf","missionary position","mong","motherfucker","mound of venus","mr hands","muff diver","muffdiving","nambla","nawashi","negro","neonazi","nigga","nigger","nig nog","nimphomania","nipple","nipples","nsfw","nsfw images","nude","nudity","nutten","nympho","nymphomania","octopussy","omorashi","one cup two girls","one guy one jar","orgasm","orgy","paedophile","paki","panties","panty","pedobear","pedophile","pegging","penis","phone sex","piece of shit","pikey","pissing","piss pig","pisspig","playboy","pleasure chest","pole smoker","ponyplay","poof","poon","poontang","punany","poop chute","poopchute","porn","porno","pornography","prince albert piercing","pthc","pubes","pussy","queaf","queef","quim","raghead","raging boner","rape","raping","rapist","rectum","reverse cowgirl","rimjob","rimming","rosy palm","rosy palm and her 5 sisters","rusty trombone","sadism","santorum","scat","schlong","scissoring","semen","sex","sexcam","sexo","sexy","sexual","sexually","sexuality","shaved beaver","shaved pussy","shemale","shibari","shit","shitblimp","shitty","shota","shrimping","skeet","slanteye","slut","s&m","smut","snatch","snowballing","sodomize","sodomy","spastic","spic","splooge","splooge moose","spooge","spread legs","spunk","strap on","strapon","strappado","strip club","style doggy","suck","sucks","suicide girls","sultry women","swastika","swinger","tainted love","taste my","tea bagging","threesome","throating","thumbzilla","tied up","tight white","tit","tits","titties","titty","tongue in a","topless","tosser","towelhead","tranny","tribadism","tub girl","tubgirl","tushy","twat","twink","twinkie","two girls one cup","undressing","upskirt","urethra play","urophilia","vagina","venus mound","viagra","vibrator","violet wand","vorarephilia","voyeur","voyeurweb","voyuer","vulva","wank","wetback","wet dream","white power","whore","worldsex","wrapping men","wrinkled starfish","xx","xxx","yaoi","yellow showers","yiffy","zoophilia","üñï"],I.getDefaultSecondsToTimeStringDecimalDigits=(()=>3),I.randomNumberQueue=[],I.htmlEscapeElem=document.createElement("p"),I.macRomanToUtf8Map=["√Ñ","√Ö","√á","√â","√ë","√ñ","√ú","√°","√†","√¢","√§","√£","√•","√ß","√©","√®","√™","√´","√≠","√¨","√Æ","√Ø","√±","√≥","√≤","√¥","√∂","√µ","√∫","√π","√ª","√º","‚Ä†","¬∞","¬¢","¬£","¬ß","‚Ä¢","¬∂","√ü","¬Æ","¬©","‚Ñ¢","¬¥","¬®","‚â†","√Ü","√ò","‚àû","¬±","‚â§","‚â•","¬•","¬µ","‚àÇ","‚àë","‚àè","œÄ","‚à´","¬™","¬∫","Œ©","√¶","√∏","¬ø","¬°","¬¨","‚àö","∆í","‚âà","‚àÜ","¬´","¬ª","‚Ä¶","‚ÄØ","√Ä","√É","√ï","≈í","≈ì","‚Äì","‚Äî","‚Äú","‚Äù","‚Äò","‚Äô","√∑","‚óä","√ø","≈∏","‚ÅÑ","‚Ç¨","‚Äπ","‚Ä∫","Ô¨Å","Ô¨Ç","‚Ä°","¬∑","‚Äö","‚Äû","‚Ä∞","√Ç","√ä","√Å","√ã","√à","√ç","√é","√è","√å","√ì","√î","üçé","√í","√ö","√õ","√ô","ƒ±","ÀÜ","Àú","¬Ø","Àò","Àô","Àö","¬∏","Àù","Àõ","Àá"],I.isWeeb=Math.random()<.001,I.isTouchDevice=I.checkIsTouchDevice();class E{constructor(){this.scheduled=[]}tickSchedule(e){for(let t of this.scheduled.slice())e>=t.time&&(I.removeFromArray(this.scheduled,t),t.callback())}schedule(e,t,i=null){this.scheduled.push({time:e,callback:t,id:i})}clearSchedule(){this.scheduled.length=0}clearScheduleId(e){for(let t=0;t<this.scheduled.length;t++)this.scheduled[t].id===e&&this.scheduled.splice(t--,1)}}var B,P;let L=(()=>{let e=null;self.onmessage=(t=>{if(!e)return e=t.data,void self.importScripts(e+"lib/pako.js");let i=t.data;if("compress"===i.command){let e=pako.deflate(i.data);B=t.data.msgId,P=e,self.postMessage({msgId:B,data:P})}})}).toString(),R=L.slice(L.indexOf("{")+1,L.lastIndexOf("}")),F=new Blob([R]),z=new Worker(URL.createObjectURL(F)),D=new Map;z.postMessage(window.location.href.slice(0,window.location.href.lastIndexOf("/")+1)),z.onmessage=(e=>{D.get(e.data.msgId)(e.data.data)});const U=(e,t)=>{let i=I.getRandomId();return z.postMessage({msgId:i,command:e,data:t}),new Promise(e=>{D.set(i,e)})};let V=(()=>{let e=new Map;self.onmessage=(t=>{let i=t.data;if("setTimeout"===i.command){let t=setTimeout(()=>{self.postMessage({externalId:i.externalId})},i.timeout);e.set(i.externalId,t)}else if("setInterval"===i.command){let t=setInterval(()=>{self.postMessage({externalId:i.externalId})},i.timeout);e.set(i.externalId,t)}else"clear"===i.command&&(clearTimeout(e.get(i.externalId)),clearInterval(e.get(i.externalId)))})}).toString(),O=V.slice(V.indexOf("{")+1,V.lastIndexOf("}")),N=new Worker(URL.createObjectURL(new Blob([O]))),q=0,j=new Map;N.onmessage=(e=>{let t=j.get(e.data.externalId);null===t||void 0===t||t.func(),(null===t||void 0===t?void 0:t.once)&&j.delete(e.data.externalId)});const G=(e,t=0)=>(N.postMessage({command:"setTimeout",timeout:t,externalId:q}),j.set(q,{func:e,once:!0}),q++),W=5999999.99,H={settings:{resolution:2,videoDriver:0,screenStyle:0,colorDepth:1,shadows:!1,musicVolume:.5,soundVolume:.7,gameButtonMapping:{up:"KeyW",down:"KeyS",left:"KeyA",right:"KeyD",jump:"Space",use:"LMB",cameraUp:"ArrowUp",cameraDown:"ArrowDown",cameraLeft:"ArrowLeft",cameraRight:"ArrowRight",freeLook:"RMB",restart:"KeyR",blast:"KeyE"},mouseSensitivity:.2,keyboardSensitivity:.1,invertMouse:0,alwaysFreeLook:!0,marbleReflectivity:0,showFrameRate:!0,showThousandths:!0,fov:60,fancyShaders:!0,pixelRatio:2,inputType:0,frameRateCap:7,canvasDesynchronized:!/(CrOS)/.test(navigator.userAgent),joystickPosition:0,joystickSize:250,joystickLeftOffset:75,joystickVerticalPosition:.5,actionButtonOrder:0,actionButtonSize:120,actionButtonRightOffset:30,actionButtonBottomOffset:30,actionButtonAsJoystickMultiplier:1.5},bestTimes:{},lastUsedName:"",randomId:I.getRandomId(),bestTimeSubmissionQueue:[],lastSeenVersion:null,collectedEggs:[],modification:"platinum",videoRecorderConfig:{width:1280,height:720,kilobitRate:5e3,frameRate:60,playbackSpeed:1,fastMode:!0,bt709:!1,includeAudio:!0,audioKilobitRate:64,musicToSoundRatio:.7}},X={"2.1.5":async()=>{Y.data.settings.marbleReflectivity=0,await Y.store()},"2.3.0":async()=>{Y.data.settings.marbleReflectivity=0,await Y.store()}};class Y{static async init(){indexedDB.databases?(await indexedDB.databases()).find(e=>"mb-database"===e.name)&&(this.hadOldDatabase=!0):I.checkDatabaseExists("mb-database")&&(this.hadOldDatabase=!0),this.idbDatabaseLoading=new Promise(e=>{let t=indexedDB.open("mbw",3);t.onsuccess=(t=>{e(),this.idbDatabase=t.target.result,this.idbDatabaseLoading=null}),t.onupgradeneeded=(e=>{let t=e.target.result,i=e.target.transaction;try{t.createObjectStore("replays",{})}catch(e){i.objectStore("replays")}try{t.createObjectStore("keyvalue",{})}catch(e){i.objectStore("keyvalue")}})}),localStorage.getItem("mb-storage")&&await this.migrate();let e=await this.databaseGet("keyvalue","storageData");this.data=e?this.correctFields(H,e):H,1===this.data.settings.inputType?I.isTouchDevice=!1:2===this.data.settings.inputType&&(I.isTouchDevice=!0),this.data.bestTimes={};let t=await this.databaseGet("keyvalue","bestTimes");if(t)try{let e=pako.inflate(t,{to:"string"}),i=JSON.parse(e);this.data.bestTimes=i}catch(e){console.error("Error decoding best times!",e)}I.getDefaultSecondsToTimeStringDecimalDigits=(()=>this.data.settings.showThousandths?3:2)}static async migrate(){let e=JSON.parse(localStorage.getItem("mb-storage"));this.data=e;for(let t in e.bestTimes)for(let i of e.bestTimes[t])i[3]=0;await this.store(),await this.storeBestTimes(),localStorage.removeItem("mb-storage")}static async store(){let e=I.shallowClone(this.data);delete e.bestTimes,await this.databasePut("keyvalue",e,"storageData")}static async storeBestTimes(){let e=JSON.stringify(this.data.bestTimes),t=await U("compress",e);await this.databasePut("keyvalue",t,"bestTimes")}static getBestTimesForMission(e,t,i){let s=[],n=this.data.bestTimes[e];n&&s.push(...n),s.sort((e,t)=>e[1]-t[1]);let r=t-s.length;for(let e=0;e<r;e++)s.push([i,W,"",0]);return s}static insertNewTime(e,t,i){var s;let n,r=null!==(s=this.data.bestTimes[e])&&void 0!==s?s:[],a=[t,i,I.getRandomId(),Date.now()];for(n=0;n<r.length&&!(r[n][1]>i);n++);if(r.splice(n,0,a),r.length>this.maxScoresPerLevel){let e=r[this.maxScoresPerLevel];r=r.slice(0,this.maxScoresPerLevel),e[2]&&this.databaseGet("replays",e[2]).then(t=>{t&&this.databaseDelete("replays",e[2])})}return this.data.bestTimes[e]=r,this.storeBestTimes(),n===this.maxScoresPerLevel?null:{index:n,score:a}}static async databaseGet(e,t){var i;await this.idbDatabaseLoading;let s=this.idbDatabase.transaction(e,"readonly").objectStore(e).get(t);return await new Promise(e=>s.onsuccess=e),null!==(i=s.result)&&void 0!==i?i:null}static async databasePut(e,t,i){await this.idbDatabaseLoading;let s=this.idbDatabase.transaction(e,"readwrite");s.objectStore(e).put(t,i),await new Promise(e=>s.addEventListener("complete",e))}static async databaseDelete(e,t){await this.idbDatabaseLoading;let i=this.idbDatabase.transaction(e,"readwrite");i.objectStore(e).delete(t),await new Promise(e=>i.addEventListener("complete",e))}static async databaseCount(e,t){var i;await this.idbDatabaseLoading;let s=this.idbDatabase.transaction(e,"readonly").objectStore(e).count(t);return await new Promise(e=>s.onsuccess=e),null!==(i=s.result)&&void 0!==i?i:null}static correctFields(e,t){for(let i in e)i in t||(t[i]=e[i]),e[i]&&"object"==typeof e[i]&&!Array.isArray(e[i])&&Object.keys(e[i]).length&&this.correctFields(e[i],t[i]);for(let i in t)i in e||delete t[i];return t}static async onVersionUpgrade(e){for(let t in X)I.compareVersions(e,t)>=0||await X[t]()}}Y.hadOldDatabase=!1,Y.maxScoresPerLevel=5;class Q{constructor(e,t,i,s=""){this.vertexArrayObjects=new Map,this.uniformLocations=new Map,this.attributeLocations=new Map,this.compileStatusChecked=!1,this.renderer=e;let{gl:n}=e;n instanceof WebGLRenderingContext||([t,i]=this.convertFromGLSL100ToGLSL300(t,i));let r=`\n\t\t\t${n instanceof WebGLRenderingContext&&!e.extensions.EXT_frag_depth?"":"#define LOG_DEPTH_BUF"}\n\t\t\t${n instanceof WebGLRenderingContext?"#define IS_WEBGL1":""}\n\t\t\t${s}\n\t\t`;t=t.replace("#include <definitions>",r),i=i.replace("#include <definitions>",r),this.vertexShader=n.createShader(n.VERTEX_SHADER),this.fragmentShader=n.createShader(n.FRAGMENT_SHADER),n.shaderSource(this.vertexShader,t),n.shaderSource(this.fragmentShader,i),n.compileShader(this.vertexShader),n.compileShader(this.fragmentShader);let a=n.createProgram();n.attachShader(a,this.vertexShader),n.attachShader(a,this.fragmentShader),n.linkProgram(a),this.glProgram=a}convertFromGLSL100ToGLSL300(e,t){t="#version 300 es\n"+t,e=(e=(e="#version 300 es\n"+e).replace(/\nattribute /g,"\nin ")).replace(/\nvarying /g,"\nout "),t=(t=(t=(t=t.replace(/\nvarying /g,"\nin ")).replace("\nvoid main()","out vec4 FragColor;\nvoid main()")).replace(/gl_FragColor/g,"FragColor")).replace(/gl_FragDepthEXT/g,"gl_FragDepth");let i="\n\t\t\t#define texture2D texture\n\t\t\t#define textureCube texture\n\t\t\t#include <definitions>\n\t\t";return[e=e.replace("#include <definitions>",i),t=t.replace("#include <definitions>",i)]}checkCompileStatus(){let{gl:e}=this.renderer;this.compileStatusChecked=!0,e.getShaderParameter(this.vertexShader,e.COMPILE_STATUS)?e.getShaderParameter(this.fragmentShader,e.COMPILE_STATUS)?e.getProgramParameter(this.glProgram,e.LINK_STATUS)||console.error("Unable to initialize the shader program: "+e.getProgramInfoLog(this.glProgram)):console.error("An error occurred compiling the shaders: "+e.getShaderInfoLog(this.fragmentShader)):console.error("An error occurred compiling the shaders: "+e.getShaderInfoLog(this.vertexShader))}use(){var e;this.renderer.currentProgram!==this&&(this.compileStatusChecked||this.checkCompileStatus(),null===(e=this.renderer.currentProgram)||void 0===e||e.unuse(),this.renderer.gl.useProgram(this.glProgram),this.renderer.currentProgram=this)}unuse(){let{gl:e}=this.renderer;this.renderer.bindVertexArray(null);for(let[,t]of this.attributeLocations)e.disableVertexAttribArray(t)}bindVertexBufferGroup(e){if(this.vertexArrayObjects.has(e))return void this.renderer.bindVertexArray(this.vertexArrayObjects.get(e));let{gl:t}=this.renderer,i=this.renderer.createVertexArray();this.renderer.bindVertexArray(i);for(let t of e.buffers)this.bindVertexBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.vertexArrayObjects.set(e,i)}bindVertexBuffer(e){let{gl:t}=this.renderer;t.bindBuffer(t.ARRAY_BUFFER,e.buffer);let i=0;for(let s in e.attributes){let n=e.attributes[s],r=i;i+=n;let a=this.attributeLocations.get(s);void 0===a&&(a=t.getAttribLocation(this.glProgram,s))>=0&&this.attributeLocations.set(s,a),-1!==a&&(t.enableVertexAttribArray(a),t.vertexAttribPointer(a,n,t.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*e.stride,Float32Array.BYTES_PER_ELEMENT*r))}}getUniformLocation(e){if(this.uniformLocations.has(e))return this.uniformLocations.get(e);let{gl:t}=this.renderer,i=t.getUniformLocation(this.glProgram,e);return this.uniformLocations.set(e,i),i}cleanUp(){this.renderer.bindVertexArray(null);for(let[,e]of this.vertexArrayObjects)this.renderer.deleteVertexArray(e);this.vertexArrayObjects.clear()}}var K="precision highp float;\nprecision highp int;\n\n#include <definitions>\n\nattribute vec3 position;\nattribute float meshInfoIndex;\n\nuniform highp sampler2D meshInfos;\nuniform int meshInfoTextureWidth;\nuniform int meshInfoTextureHeight;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nint _mod(int a, int n) {\n\t#ifdef IS_WEBGL1\n\t\treturn a - n * (a / n);\n\t#else\n\t\treturn a % n;\n\t#endif\n}\n\n// Refer to material_vert.glsl for an explanation of what this does\nmat4 getMeshInfo(int index) {\n\tivec2 coords = ivec2(\n\t\t_mod(4 * index, meshInfoTextureWidth),\n\t\t(4 * index) / meshInfoTextureWidth\n\t);\n\n\t#ifdef IS_WEBGL1\n\t\treturn mat4(\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(0, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(1, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(2, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(3, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight))\n\t\t);\n\t#else\n\t\treturn mat4(\n\t\t\ttexelFetch(meshInfos, coords + ivec2(0, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(1, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(2, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(3, 0), 0)\n\t\t);\n\t#endif\n}\n\nvoid main() {\n\tmat4 meshInfo = getMeshInfo(int(meshInfoIndex + 0.1)); // + 0.1 to make sure it casts correctly, lol\n\tmat4 transform = meshInfo;\n\ttransform[0][3] = 0.0;\n\ttransform[1][3] = 0.0;\n\ttransform[2][3] = 0.0;\n\ttransform[3][3] = 1.0;\n\tfloat opacity = meshInfo[0][3];\n\n\tif (opacity < 1.0) {\n\t\t// Non-opaque objects don't cast shadows in our perfect world\n\t\tgl_Position = vec4(0.0);\n\t\treturn;\n\t}\n\n\t// Simply transform the vertex and we're done\n\tmat4 mvp = projectionMatrix * viewMatrix * transform;\n\tgl_Position = mvp * vec4(position, 1.0);\n}",$="precision mediump float;\n\n#include <definitions>\n\nvoid main() {\n\tgl_FragColor = vec4(1.0); // Simple pass-through shader\n}",Z="precision highp float;\n\n#include <definitions>\n\nattribute vec2 position;\nattribute vec2 uv;\nattribute float particleSpawnTime;\nattribute float particleLifetime;\nattribute vec3 particlePosition;\nattribute vec3 particleVelocity;\nattribute float particleInitialSpin;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nuniform float time;\nuniform float acceleration;\nuniform float spinSpeed;\nuniform float dragCoefficient;\nuniform vec4 times;\nuniform vec4 sizes;\nuniform mat4 colors;\n\nvarying vec2 vUv;\nvarying float vFragDepth;\nvarying float vIsPerspective;\nvarying vec4 color;\n\nbool isPerspectiveMatrix(mat4 m) {\n\treturn m[2][3] == -1.0;\n}\n\n// Dynamic access of vecs and mats doesn't work properly in WebGL, so wrap the functionality in a function that does it the ugly way.\nfloat accessDynamically(vec4 data, int idx) {\n\t#ifdef IS_WEBGL1\n\t\t// Since all these indices are known at compile-time, this works just fine\n\t\tif (idx == 0) return data[0];\n\t\tif (idx == 1) return data[1];\n\t\tif (idx == 2) return data[2];\n\t\treturn data[3];\n\t#else\n\t\treturn data[idx];\n\t#endif\n}\n\nvec4 accessDynamically(mat4 data, int idx) {\n\t#ifdef IS_WEBGL1\n\t\tif (idx == 0) return data[0];\n\t\tif (idx == 1) return data[1];\n\t\tif (idx == 2) return data[2];\n\t\treturn data[3];\n\t#else\n\t\treturn data[idx];\n\t#endif\n}\n\nvoid main() {\n\tfloat elapsed = time - particleSpawnTime;\n\tfloat completion = clamp(elapsed / particleLifetime, 0.0, 1.0);\n\n\tif (completion == 1.0) {\n\t\t// We're dead, don't render\n\t\tgl_Position = vec4(0.0);\n\t\treturn;\n\t}\n\n\tfloat velElapsed = elapsed / 1000.0;\n\tvelElapsed = pow(velElapsed, 1.0 - dragCoefficient);\n\n\t// Compute the position\n\tvec3 computedPosition = particlePosition + particleVelocity * (velElapsed + acceleration * velElapsed * velElapsed / 2.0);\n\tfloat rotation = particleInitialSpin + spinSpeed * elapsed / 1000.0;\n\n\t// Check where we are in the times array\n\tint indexLow = 0;\n\tint indexHigh = 1;\n\tfor (int i = 2; i < 4; i++) {\n\t\tif (times[indexHigh] >= completion) break;\n\n\t\tindexLow = indexHigh;\n\t\tindexHigh = i;\n\t}\n\tif (times[1] > 1.0) indexHigh = indexLow; // Basically checking if (this.o.times.length === 1)\n\tfloat timeLow = accessDynamically(times, indexLow);\n\tfloat timeHigh = accessDynamically(times, indexHigh);\n\tfloat t = (completion - timeLow) / (timeHigh - timeLow);\n\n\t// Compute the color to send to the fragment shader\n\tcolor = mix(accessDynamically(colors, indexLow), accessDynamically(colors, indexHigh), t);\n\tcolor.a = pow(color.a, 1.5); // Adjusted because additive mixing can be kind of extreme\n\n\tvec4 viewPosition = viewMatrix * vec4(computedPosition, 1.0);\n\n\tvec2 scale = vec2(1.0);\n\tscale *= mix(accessDynamically(sizes, indexLow), accessDynamically(sizes, indexHigh), t); // Adjust sizing\n\n\t// Enable the following code if you don't want to attenuate the size with growing distance:\n\t// scale *= -viewPosition.z;\n\n\tvec2 center = vec2(0.5, 0.5); // Fixed, for now\n\tvec2 alignedPosition = (position - (center - vec2(0.5))) * scale;\n\tvec2 rotatedPosition;\n\n\trotatedPosition.x = cos(rotation) * alignedPosition.x - sin(rotation) * alignedPosition.y;\n\trotatedPosition.y = sin(rotation) * alignedPosition.x + cos(rotation) * alignedPosition.y;\n\tviewPosition.xy += rotatedPosition;\n\n\tgl_Position = projectionMatrix * viewPosition;\n\n\tvUv = uv;\n\n\t#ifdef LOG_DEPTH_BUF\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float(isPerspectiveMatrix(projectionMatrix));\n\t#endif\n}",J="precision mediump float;\n\n#include <definitions>\n\nvarying vec2 vUv;\nvarying float vFragDepth;\nvarying float vIsPerspective;\nvarying vec4 color;\n\nuniform sampler2D diffuseMap;\nuniform float logDepthBufFC;\n\n#if defined(LOG_DEPTH_BUF) && defined(IS_WEBGL1)\n\t#extension GL_EXT_frag_depth : enable\n#endif\n\nvoid main() {\n\tgl_FragColor = color * texture2D(diffuseMap, vUv);\n\t\n\t#ifdef LOG_DEPTH_BUF\n\t\t// We always need to set gl_FragDepthEXT when it's present in the file, otherwise it gets real weird\n\t\t// Also: Doing a strict comparison with == 1.0 can cause noise artifacts\n\t\tgl_FragDepthEXT = (vIsPerspective != 0.0)? log2(vFragDepth) * logDepthBufFC * 0.5 : gl_FragCoord.z;\n\t#endif\n}";class ee{static async toImage(e){let t=new DataView(e);if(542327876!==t.getUint32(0,!0))throw new Error("Not a valid DDS file");if("DXT1"!==String.fromCharCode(t.getUint8(84),t.getUint8(85),t.getUint8(86),t.getUint8(87)))throw new Error("Only DXT1 format is supported");let i=t.getUint32(12,!0),s=t.getUint32(16,!0),n=new Uint8ClampedArray(s*i*4),r=128;for(let e=0;e<i;e+=4)for(let i=0;i<s;i+=4){let a=t.getUint16(r,!0),o=t.getUint16(r+2,!0),l=(63488&a)>>8,h=(2016&a)>>3,d=(31&a)<<3,c=(63488&o)>>8,u=(2016&o)>>3,m=(31&o)<<3,p=t.getUint32(r+4,!0);for(let t=0;t<4;t++)for(let r=0;r<4;r++){let g=4*((e+t)*s+(i+r)),f=p>>2*(4*t+r)&3;if(a>o)switch(f){case 0:n.set([l,h,d,255],g);break;case 1:n.set([c,u,m,255],g);break;case 2:n.set([(2*l+c)/3,(2*h+u)/3,(2*d+m)/3,255],g);break;case 3:n.set([(l+2*c)/3,(h+2*u)/3,(d+2*m)/3,255],g)}else switch(f){case 0:n.set([l,h,d,255],g);break;case 1:n.set([c,u,m,255],g);break;case 2:n.set([(l+c)/2,(h+u)/2,(d+m)/2,255],g);break;case 3:n.set([0,0,0,0],g)}}r+=8}let a=document.createElement("canvas");a.width=s,a.height=i;let o=a.getContext("2d"),l=new ImageData(n,s,i);o.putImageData(l,0,0);let h=a.toDataURL(),d=new Image;return d.src=h,await new Promise(e=>d.onload=e),d}}class te{constructor(e){if(this.id=I.getRandomId(),this.glTextures=new Map,!e.complete)throw new Error("Can only pass loaded images into Texture.");this.image=e}getGLTexture(e){let t=this.glTextures.get(e);if(t)return t;let{gl:i}=e;t=i.createTexture(),i.bindTexture(i.TEXTURE_2D,t),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this.image),i.generateMipmap(i.TEXTURE_2D),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),e.extensions.EXT_texture_filter_anisotropic&&i.texParameteri(i.TEXTURE_2D,e.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,4),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),this.glTextures.set(e,t)}}const ie=document.querySelector("#image-cache"),se={"assets/data_mbp/sound/gotgem.wav":"assets/data_mbp/sound/gotdiamond.wav","assets/data_mbp/sound/gotallgems.wav":"assets/data_mbp/sound/gotalldiamonds.wav","assets/data_mbp/sound/music/groovepolice":"assets/data_mbp/sound/music/groove police"};class ne{static get mainDataPath(){return"gold"===e.modification?"./assets/data/":"./assets/data_mbp/"}static async init(){let e=this.loadResource("./api/directory_structure"),t=this.loadResource("./api/directory_structure_mbp"),[i,s]=await Promise.all([e,t]);this.dataDirectoryStructure=JSON.parse(await this.readBlobAsText(i)),this.dataMbpDirectoryStructure=JSON.parse(await this.readBlobAsText(s))}static getTexture(e,t=this.mainDataPath){let i=t+e,s=this.textureCache.get(i);if(s)return Promise.resolve(s);if(this.loadTexturePromises.get(i))return this.loadTexturePromises.get(i);let n=new Promise(async e=>{let t=await this.loadImage(i),s=new te(t);s.getGLTexture(he),this.textureCache.set(i,s),this.loadTexturePromises.delete(i),e(s)});return this.loadTexturePromises.set(i,n),n}static getTextureFromCache(e,t=this.mainDataPath){let i=t+e,s=this.textureCache.get(i);return s||null}static getFullNamesOf(t,i="platinum"===e.modification){let s=t.split("/"),n=i?this.dataMbpDirectoryStructure:this.dataDirectoryStructure;for(;s.length;){let e=s.shift();if(0===s.length){let t=[];for(let i in n)!i.toLowerCase().startsWith(e.toLowerCase())||i.length!==e.length&&e.length!==i.lastIndexOf(".")||t.push(i);return t}if(!(n=n[e]))return[]}}static redirectPath(t){if("gold"!==e.modification)for(let e in se)if(t.includes(e))return t.replace(e,se[e]);return t}static loadResource(e){e=this.redirectPath(e);let t=this.cachedResources.get(e);if(t)return Promise.resolve(t);if(this.loadResourcePromises.get(e))return this.loadResourcePromises.get(e);let i=new Promise((t,i)=>{const s=async()=>{try{let n=await fetch(e);if(404===n.status)return this.cachedResources.set(e,null),this.loadResourcePromises.delete(e),void t(null);if(!n.ok)return i(`Error getting resource (${n.status}): `+e),void this.loadResourcePromises.delete(e);let r=await n.blob();this.cachedResources.set(e,r),this.loadResourcePromises.delete(e),t(r)}catch(e){setTimeout(s,1e3)}};s()});return this.loadResourcePromises.set(e,i),i}static loadImage(e,t=e){if(this.loadedImages.get(e))return Promise.resolve(this.loadedImages.get(e));if(this.loadImagePromises.get(e))return this.loadImagePromises.get(e);let i=new Promise(async(i,s)=>{if(t.toLowerCase().endsWith(".dds")){let t=await this.readBlobAsArrayBuffer(await this.loadResource(e));try{let e=await ee.toImage(t);i(e)}catch(e){s(e)}return}let n=new Image;n.src=e,n.onload=(()=>{ie.appendChild(n),this.loadedImages.set(e,n),this.loadImagePromises.delete(e),i(n),n.onload=null}),n.onerror=(e=>{s(e)})});return this.loadImagePromises.set(e,i),i}static loadImages(e){return Promise.all(e.map(e=>this.loadImage(e)))}static getImageFromCache(e){return this.loadedImages.get(e)||null}static readBlobAsText(e,t){return e.text?e.text():new Promise(i=>{let s=new FileReader;s.onload=(e=>i(e.target.result)),s.readAsText(e,t)})}static async readBlobAsJson(e,t){let i=await this.readBlobAsText(e,t);return JSON.parse(i)}static readBlobAsArrayBuffer(e){return e.arrayBuffer?e.arrayBuffer():new Promise(t=>{let i=new FileReader;i.onload=(e=>t(e.target.result)),i.readAsArrayBuffer(e)})}static readBlobAsDataUrl(e){return new Promise(t=>{let i=new FileReader;i.onload=(e=>t(e.target.result)),i.readAsDataURL(e)})}static getUrlToBlob(e){if(this.urlCache.get(e))return this.urlCache.get(e);let t=URL.createObjectURL(e);return this.urlCache.set(e,t),t}static retryFetch(e,t){return new Promise(i=>{const s=async()=>{try{let n=await fetch(e,t);if(404===n.status)return void i(null);let r=await n.blob();i(r)}catch(e){setTimeout(s,1e3)}};s()})}}var re;ne.textureCache=new Map,ne.loadTexturePromises=new Map,ne.dataDirectoryStructure={},ne.dataMbpDirectoryStructure={},ne.loadResourcePromises=new Map,ne.cachedResources=new Map,ne.loadImagePromises=new Map,ne.loadedImages=new Map,ne.urlCache=new Map,function(e){e[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Subtractve=2]="Subtractve"}(re||(re={}));const ae={alpha:!1,desynchronized:!1};class oe{constructor(e){this.currentProgram=null,this.materialShaders=new Map,this.pixelRatio=1,this.currentFramebuffer=null,this.debugMode=0,this.extensions={EXT_texture_filter_anisotropic:null,EXT_frag_depth:null,OES_element_index_uint:null,WEBGL_depth_texture:null,OES_standard_derivatives:null,KHR_parallel_shader_compile:null,OES_texture_float:null,OES_vertex_array_object:null},e=Object.assign(Object.assign({},ae),e),this.options=e;let t={desynchronized:e.desynchronized,depth:!0,stencil:!0,antialias:!1,powerPreference:"high-performance",alpha:e.alpha,premultipliedAlpha:!0};this.gl=e.canvas.getContext("webgl2",t),this.gl||(this.gl=e.canvas.getContext("webgl",t));let{gl:i}=this;this.extensions.EXT_texture_filter_anisotropic=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extensions.EXT_frag_depth=i.getExtension("EXT_frag_depth"),this.extensions.OES_element_index_uint=i.getExtension("OES_element_index_uint"),this.extensions.WEBGL_depth_texture=i.getExtension("WEBGL_depth_texture"),this.extensions.OES_standard_derivatives=i.getExtension("OES_standard_derivatives"),this.extensions.KHR_parallel_shader_compile=i.getExtension("KHR_parallel_shader_compile"),this.extensions.OES_texture_float=i.getExtension("OES_texture_float"),this.extensions.OES_vertex_array_object=i.getExtension("OES_vertex_array_object"),this.shadowMapProgram=new Q(this,K,$),this.particleProgram=new Q(this,Z,J),i.clearColor(0,0,0,Number(!e.alpha)),i.clearDepth(1),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.enable(i.CULL_FACE),i.cullFace(i.BACK),i.frontFace(i.CCW)}setSize(e,t){this.width=e,this.height=t,this.updateCanvasDimensions()}setPixelRatio(e){this.pixelRatio=e,this.updateCanvasDimensions()}updateCanvasDimensions(){this.options.canvas.setAttribute("width",Math.ceil(this.width*this.pixelRatio).toString()),this.options.canvas.setAttribute("height",Math.ceil(this.height*this.pixelRatio).toString())}setClearColor(e,t,i,s){this.gl.clearColor(e,t,i,s)}render(e,t,i=null,s=!0){if(!e.compiled)throw new Error("Scene not compiled! Can't render it.");if(!e.preparedForRender)throw new Error("Scene not prepared for render! Can't render it.");let{gl:n}=this;this.drawCalls=0,i?(n.bindFramebuffer(n.FRAMEBUFFER,i.framebuffer),n.viewport(0,0,i.width,i.height)):(n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,Math.ceil(this.width*this.pixelRatio),Math.ceil(this.height*this.pixelRatio))),this.currentFramebuffer=i,n.depthMask(!0),n.clear(n.DEPTH_BUFFER_BIT),s&&n.clear(n.COLOR_BUFFER_BIT);let r=new Float32Array(t.matrixWorldInverse.elements),a=new Float32Array(t.projectionMatrix.elements),o=new Float32Array(t.projectionMatrix.clone().invert().elements),l=2/(Math.log(t.far+1)/Math.LN2),h=new Float32Array(t.position.toArray());for(let t of e.allDefineChunks){let i=this.materialShaders.get(t);i.use(),n.uniformMatrix4fv(i.getUniformLocation("viewMatrix"),!1,r),n.uniformMatrix4fv(i.getUniformLocation("projectionMatrix"),!1,a),n.uniformMatrix4fv(i.getUniformLocation("inverseProjectionMatrix"),!1,o),n.uniform1f(i.getUniformLocation("logDepthBufFC"),l),n.uniform3fv(i.getUniformLocation("eyePosition"),h),n.uniform1i(i.getUniformLocation("meshInfoTextureWidth"),e.meshInfoTextureWidth),n.uniform1i(i.getUniformLocation("meshInfoTextureHeight"),e.meshInfoTextureHeight),n.uniform3fv(i.getUniformLocation("ambientLight"),e.ambientLightBuffer),n.uniform3fv(i.getUniformLocation("directionalLightColor"),e.directionalLightColorBuffer),n.uniform3fv(i.getUniformLocation("directionalLightDirection"),e.directionalLightDirectionBuffer),n.uniformMatrix4fv(i.getUniformLocation("directionalLightTransform"),!1,e.directionalLightTransformBuffer),n.uniform1i(i.getUniformLocation("meshInfos"),7),this.bindTexture(e.meshInfoTexture,7,n.TEXTURE_2D),n.uniform1i(i.getUniformLocation("diffuseMap"),0),n.uniform1i(i.getUniformLocation("envMap"),1),n.uniform1i(i.getUniformLocation("directionalLightShadowMap"),2),n.uniform1i(i.getUniformLocation("normalMap"),3),n.uniform1i(i.getUniformLocation("specularMap"),4),n.uniform1i(i.getUniformLocation("noiseMap"),5),n.uniform1i(i.getUniformLocation("debugMode"),Number(this.debugMode))}n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.opaqueIndexBuffer),n.disable(n.BLEND),this.renderMaterialGroups(e,e.opaqueMaterialGroups,e.opaqueIndexBuffer,!0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.transparentIndexBuffer),n.enable(n.BLEND),this.renderMaterialGroups(e,e.transparentMaterialGroups,e.transparentIndexBuffer,!1),e.particleManager&&this.renderParticles(e.particleManager,t)}renderMaterialGroups(e,t,i,s){var n,r,a,o,l,h;let{gl:d}=this;for(let c of t){if(0===c.indexGroups.length||0===c.indexGroups[0].indices.length)continue;let t=c.material;if(!t.visible)continue;let u=this.materialShaders.get(c.defineChunk);u.use(),u.bindVertexBufferGroup(e.bufferGroup),d.uniform1i(u.getUniformLocation("skipTransparent"),Number(s)),d.uniform1f(u.getUniformLocation("materialOpacity"),t.opacity),d.uniform1f(u.getUniformLocation("specularIntensity"),t.specularIntensity),d.uniform1f(u.getUniformLocation("shininess"),t.shininess),d.uniform1f(u.getUniformLocation("reflectivity"),t.reflectivity),d.uniform1f(u.getUniformLocation("secondaryMapUvFactor"),t.secondaryMapUvFactor),t.blending===re.Normal?d.blendFunc(d.ONE,d.ONE_MINUS_SRC_ALPHA):t.blending===re.Additive?d.blendFunc(d.SRC_ALPHA,d.ONE):t.blending===re.Subtractve&&d.blendFunc(d.ONE,d.ONE_MINUS_SRC_ALPHA),d.depthMask(t.depthWrite),(t.receiveShadows||t.isShadow)&&(null===(n=e.directionalLights[0])||void 0===n||n.bindShadowMap()),this.bindTexture(null===(r=t.diffuseMap)||void 0===r?void 0:r.getGLTexture(this),0,d.TEXTURE_2D),this.bindTexture(null===(a=t.envMap)||void 0===a?void 0:a.glTexture,1,d.TEXTURE_CUBE_MAP),this.bindTexture(null===(o=t.normalMap)||void 0===o?void 0:o.getGLTexture(this),3,d.TEXTURE_2D),this.bindTexture(null===(l=t.specularMap)||void 0===l?void 0:l.getGLTexture(this),4,d.TEXTURE_2D),this.bindTexture(null===(h=t.noiseMap)||void 0===h?void 0:h.getGLTexture(this),5,d.TEXTURE_2D),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,i),d.drawElements(d.TRIANGLES,c.count,d.UNSIGNED_INT,c.offset*Uint32Array.BYTES_PER_ELEMENT),this.drawCalls++}}renderParticles(e,t){let{gl:i}=this,s=this.particleProgram;s.use(),s.bindVertexBufferGroup(e.bufferGroup);let n=new Float32Array(t.matrixWorldInverse.elements),r=new Float32Array(t.projectionMatrix.elements),a=2/(Math.log(t.far+1)/Math.LN2);i.uniformMatrix4fv(s.getUniformLocation("viewMatrix"),!1,n),i.uniformMatrix4fv(s.getUniformLocation("projectionMatrix"),!1,r),i.uniform1f(s.getUniformLocation("logDepthBufFC"),a),i.uniform1i(s.getUniformLocation("diffuseMap"),0),i.uniform1f(s.getUniformLocation("time"),e.currentRenderTime),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.indexBuffer),i.depthMask(!1),i.enable(i.BLEND);for(let[t,n]of e.particleGroups){if(0===n.particles.length)continue;let e=ne.getTextureFromCache(t.texture);this.bindTexture(e.getGLTexture(this),0,i.TEXTURE_2D),t.blending===re.Normal?i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA):t.blending===re.Additive?i.blendFunc(i.SRC_ALPHA,i.ONE):t.blending===re.Subtractve&&i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.uniform1f(s.getUniformLocation("acceleration"),n.uniforms.acceleration),i.uniform1f(s.getUniformLocation("spinSpeed"),n.uniforms.spinSpeed),i.uniform1f(s.getUniformLocation("dragCoefficient"),n.uniforms.dragCoefficient),i.uniform4fv(s.getUniformLocation("times"),n.uniforms.times),i.uniform4fv(s.getUniformLocation("sizes"),n.uniforms.sizes),i.uniformMatrix4fv(s.getUniformLocation("colors"),!1,n.uniforms.colors),s.bindVertexBuffer(n.vertexBuffer),i.drawElements(i.TRIANGLES,6*n.particles.length,i.UNSIGNED_INT,0),this.drawCalls++}}bindTexture(e,t,i){var s;let{gl:n}=this;n.activeTexture(n.TEXTURE0+t),(null===(s=this.currentFramebuffer)||void 0===s?void 0:s.colorTexture)!==e&&e?n.bindTexture(i,e):n.bindTexture(i,null)}createVertexArray(){let{gl:e}=this,t=this.extensions.OES_vertex_array_object;return e instanceof WebGLRenderingContext?t.createVertexArrayOES():e.createVertexArray()}bindVertexArray(e){let{gl:t}=this,i=this.extensions.OES_vertex_array_object;t instanceof WebGLRenderingContext?i.bindVertexArrayOES(e):t.bindVertexArray(e)}deleteVertexArray(e){let{gl:t}=this,i=this.extensions.OES_vertex_array_object;t instanceof WebGLRenderingContext?i.deleteVertexArrayOES(e):t.deleteVertexArray(e)}cleanUp(){for(let[,e]of this.materialShaders)e.cleanUp()}}const le=document.querySelector("#main-canvas");let he,de=1;const ce=(e,t)=>Math.max(1,640/e,600/t),ue=async(t=!0)=>{var i,s;t&&await I.wait(100);let n=ce(window.innerWidth,window.innerHeight);if(document.body.style.width=Math.ceil(window.innerWidth*n)+"px",document.body.style.height=Math.ceil(window.innerHeight*n)+"px",document.body.style.transform=`scale(${1/n})`,de=n,e.level&&e.level.offline)return;let r=Math.min(window.devicePixelRatio,[.5,1,1.5,2,1/0][null===(i=Y.data)||void 0===i?void 0:i.settings.pixelRatio]);le.style.width="100%",le.style.height="100%",null===he||void 0===he||he.setSize(window.innerWidth,window.innerHeight),null===he||void 0===he||he.setPixelRatio(r),null===(s=e.level)||void 0===s||s.onResize(window.innerWidth,window.innerHeight,Math.max(r,1))};window.addEventListener("resize",ue),ue();let me=!1;const pe=document.querySelector("#fullscreen-enforcer");pe.addEventListener("click",()=>{document.documentElement.requestFullscreen()}),pe.querySelector("img").addEventListener("click",e=>{me=!0,pe.classList.add("hidden"),e.stopPropagation()});const ge=document.querySelector("#enter-fullscreen");ge.addEventListener("click",()=>{document.documentElement.requestFullscreen(),me=!1});let fe=!0;const ye=e=>{fe=e,e&&I.isTouchDevice&&!I.isSafari()&&!I.isInFullscreen()?ge.classList.remove("hidden"):ge.classList.add("hidden")};let be=-1/0;setInterval(()=>{var e,t;"INPUT"===(null===(e=document.activeElement)||void 0===e?void 0:e.tagName)&&(be=performance.now()),I.isTouchDevice&&!I.isSafari()&&(I.isInFullscreen()?pe.classList.add("hidden"):!me&&"INPUT"!==(null===(t=document.activeElement)||void 0===t?void 0:t.tagName)&&performance.now()-be>666&&pe.classList.remove("hidden")),ye(fe)},250),window.addEventListener("dragstart",e=>{var t;"IMG"===(null===(t=e.target.nodeName)||void 0===t?void 0:t.toUpperCase())&&e.preventDefault()});const ve={x:0,y:0};window.addEventListener("mousemove",t=>{var i;ve.x=t.clientX*de,ve.y=t.clientY*de,null===(i=e.level)||void 0===i||i.onMouseMove(t)}),window.addEventListener("touchstart",e=>{let t=e.changedTouches[0];ve.x=t.clientX*de,ve.y=t.clientY*de}),window.addEventListener("touchmove",e=>{let t=e.changedTouches[0];ve.x=t.clientX*de,ve.y=t.clientY*de}),window.addEventListener("mousedown",t=>{if(!Y.data)return;!e.level||e.level.offline||e.level.paused||e.level.finishTime||I.isTouchDevice||I.requestPointerLock();let i=["LMB","MMB","RMB"][t.button];if(i&&document.pointerLockElement)for(let t in Y.data.settings.gameButtonMapping){let s=t;i===Y.data.settings.gameButtonMapping[s]&&(Se(s,i,!0),e.level&&("jump"===s&&Ce(s)&&(e.level.jumpQueued=!0),"use"===s&&Ce(s)&&(e.level.useQueued=!0),"blast"===s&&Ce(s)&&(e.level.blastQueued=!0)))}}),window.addEventListener("mouseup",e=>{if(!Y.data)return;let t=["LMB","MMB","RMB"][e.button];if(t)for(let e in Y.data.settings.gameButtonMapping){let i=e;t===Y.data.settings.gameButtonMapping[i]&&Se(i,t,!1)}}),window.addEventListener("keydown",t=>{if(Y.data)for(let i in Y.data.settings.gameButtonMapping){let s=i;t.code===Y.data.settings.gameButtonMapping[s]&&(Se(s,t.code,!0),e.level&&("jump"===s&&Ce(s)&&(e.level.jumpQueued=!0),"use"===s&&Ce(s)&&(e.level.useQueued=!0)))}}),window.addEventListener("keyup",e=>{if(Y.data)for(let t in Y.data.settings.gameButtonMapping){let i=t;e.code===Y.data.settings.gameButtonMapping[i]&&Se(i,e.code,!1)}}),window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("beforeunload",t=>{e.level&&(t.preventDefault(),t.returnValue="")}),document.addEventListener("pointerlockchange",()=>{var t;document.pointerLockElement||null===(t=e.level)||void 0===t||t.pause()});const we={up:[],down:[],left:[],right:[],jump:[],use:[],cameraUp:[],cameraDown:[],cameraLeft:[],cameraRight:[],freeLook:[],restart:[],pause:[],blast:[]},xe={up:!1,down:!1,left:!1,right:!1,jump:!1,use:!1,cameraUp:!1,cameraDown:!1,cameraLeft:!1,cameraRight:!1,freeLook:!1,restart:!1,pause:!1,blast:!1},Se=(e,t,i)=>{let s=we[e].includes(t);!i&&s?we[e]=we[e].filter(e=>e!==t):i&&!s&&(we[e].push(t),xe[e]=!0)},Te=e=>we[e].length>0,Me=e=>void 0!==we[e].find(e=>e.startsWith("gamepadButton")),Ce=e=>1===we[e].length,ke=e=>xe[e],Ae=e=>{xe[e]=!1},_e=()=>{for(let e in we)"pause"!==e&&(we[e]=[])},Ie={marbleX:0,marbleY:0,cameraX:0,cameraY:0},Ee=["marbleX","marbleY","cameraX","cameraY"],Be=["jump","use","blast","","","blast","jump","use","restart","pause","","","up","down","left","right","",""];let Pe=0;const Le=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];window.setInterval(()=>{var t,i;let s="getGamepads"in navigator?[...navigator.getGamepads()].filter(e=>e):[];if(0!==s.length){for(let e=0;e<s.length;e++)for(let t=0;t<s[e].buttons.length;t++)if(s[e].buttons[t].value>.5){Pe=e;break}for(let e=0;e<s[Pe].buttons.length&&e<18;e++){let t=s[Pe].buttons[e].value>.5,i=Be[e];""!==i&&Se(i,"gamepadButton"+e,t)}for(let e=0;e<s[Pe].axes.length&&e<4;e++){let t=Ee[e];""!==t&&(Ie[t]=s[Pe].axes[e],Math.abs(Ie[t])<.1&&(Ie[t]=0))}(null===(t=e.menu)||void 0===t?void 0:t.levelSelect)&&!e.menu.levelSelect.div.classList.contains("hidden")&&e.menu.levelSelect.handleControllerInput(s[Pe]),(null===(i=e.level)||void 0===i?void 0:i.paused)&&e.menu.pauseScreen.handleGamepadInput(s[Pe]);for(let e=0;e<s[Pe].buttons.length&&e<18;e++)Le[e]=s[Pe].buttons[e].value>.5}else for(let e in Ie)Ie[e]=0},4);const Re=document.querySelector("#touch-input-container"),Fe=document.querySelector("#movement-area"),ze=document.querySelector("#camera-area"),De=document.querySelector("#movement-joystick"),Ue=document.querySelector("#movement-joystick-handle"),Ve=document.querySelector("#action-buttons"),Oe=document.querySelector("#jump-button"),Ne=document.querySelector("#use-button"),qe=document.querySelector("#blast-button"),je=document.querySelector("#pause-button"),Ge=document.querySelector("#restart-button"),We=document.querySelector("#free-look-button"),He=.4;let Xe=null,Ye=null,Qe=null,Ke=null,$e=null,Ze=[],Je=!1;const et=e=>{Je=e};let tt=[];const it=(e,t,i,s,n)=>{let r=null;e.addEventListener("touchstart",s=>{var a;let o=s.changedTouches[0];r=o.identifier;let l=null===(a=null===n||void 0===n?void 0:n().enabled)||void 0===a||a;e.style.opacity=l?"0.9":"0.4",Se(t,"touch",!0),null===i||void 0===i||i(o)}),tt.push((i,a)=>{var o;(a||i.identifier===r)&&(r=null,e.style.opacity=null!==(o=null===n||void 0===n?void 0:n().opacity)&&void 0!==o?o:"",Se(t,"touch",!1),null===s||void 0===s||s(i))})},st=e=>{Ke=e.identifier,$e=e},nt=e=>{st(e),Ze.push(e)},rt=e=>{Ze.splice(Ze.indexOf(e),1)};it(Oe,"jump",nt,rt),it(Ne,"use",nt,rt,()=>({opacity:Je?"0.5":"0.2",enabled:Je})),it(qe,"blast",nt,rt,()=>({opacity:"0.2",enabled:!1})),it(je,"pause"),it(Ge,"restart"),it(We,"freeLook");const at=()=>{Re.style.display="none"},ot=()=>{Re.style.display=I.isTouchDevice?"block":"none"},lt=e=>{"normal"===e?[De,Oe,Ne,qe,We].forEach(e=>e.style.display=""):"replay"===e&&[De,Oe,Ne,qe,We].forEach(e=>e.style.display="none")};Fe.addEventListener("touchstart",e=>{let t,i,s=e.changedTouches[0];Qe=s.identifier;let n=Y.data.settings.joystickSize;0===Y.data.settings.joystickPosition?(t=Y.data.settings.joystickLeftOffset+n/2,i=window.innerHeight*(1-Y.data.settings.joystickVerticalPosition)*de):(t=I.clamp(s.clientX*de,n/2,(window.innerWidth*de-n)/2),i=I.clamp(s.clientY*de,n/2,window.innerHeight*de-n/2)),De.style.visibility="visible",De.style.left=t-n/2+"px",De.style.top=i-n/2+"px",Xe={x:t,y:i},Ye={x:0,y:0},ht(s)}),Fe.addEventListener("touchmove",e=>{let t=[...e.changedTouches].find(e=>e.identifier===Qe);t&&t.identifier===Qe&&ht(t)});const ht=e=>{let t=Y.data.settings.joystickSize,i=He*Y.data.settings.joystickSize,s=(t-i)/2;Ye.x=I.clamp((e.clientX*de-Xe.x)/s,-1,1),Ye.y=I.clamp((e.clientY*de-Xe.y)/s,-1,1),Ue.style.left=Ye.x*s+t/2-i/2+"px",Ue.style.top=Ye.y*s+t/2-i/2+"px"};window.addEventListener("touchend",e=>{for(let t of e.changedTouches){t.identifier===Qe&&(Qe=null,De.style.visibility="hidden",Ye=null),t.identifier===Ke&&(Ke=null);for(let e of tt)e(t,!1)}if(0===e.touches.length){Qe=null,De.style.visibility="hidden",Ye=null,Ke=null;for(let e of tt)e(null,!0)}}),ze.addEventListener("touchstart",e=>{let t=e.changedTouches[0];st(t)}),Re.addEventListener("touchmove",t=>{let i=[...t.changedTouches].find(e=>e.identifier===Ke),s=e.level;if(i&&i.identifier===Ke){let e=(i.clientX-$e.clientX)*de,t=(i.clientY-$e.clientY)*de,n=I.lerp(1/1500,.02,Y.data.settings.mouseSensitivity)*(0!==Ze.length?Y.data.settings.actionButtonAsJoystickMultiplier:1),r=2&Y.data.settings.invertMouse?-1:1,a=Y.data.settings.alwaysFreeLook||Te("freeLook");s.yaw-=e*n,a&&(s.pitch+=t*n*r),$e=i}});const dt=48e3,ct=new Map,ut=new Map;class mt{constructor(){this.audioSources=[],this.currentTimeOverride=null}get currentTime(){var e;return null!==(e=this.currentTimeOverride)&&void 0!==e?e:this.context.currentTime}init(e){window.AudioContext?this.context=e?new OfflineAudioContext(2,e.duration*dt,dt):new AudioContext:this.context=e?new window.webkitOfflineAudioContext(2,e.duration*dt,dt):new window.webkitAudioContext,this.masterGain=this.context.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this.context.destination),this.soundGain=this.context.createGain(),this.soundGain.gain.value=0,this.soundGain.connect(this.masterGain),this.musicGain=this.context.createGain(),this.musicGain.gain.value=0,this.musicGain.connect(this.masterGain),e||this.updateVolumes(),window.onfocus=(()=>{I.isTouchDevice&&(this.masterGain.gain.value=1)}),window.onblur=(()=>{I.isTouchDevice&&(this.masterGain.gain.value=0)})}setAssetPath(e){this.assetPath=e}toFullPath(e){return this.assetPath+e}async loadBuffer(t){var i;let s,n=this.toFullPath(t),r=null===(i=e.level)||void 0===i?void 0:i.mission;if(r&&r.zipDirectory&&r.zipDirectory.files["data/sound/"+t])s=r.zipDirectory.files["data/sound/"+t];else if(await ct.get(n),ut.has(n))return ut.get(n);let a=(async()=>{let e,i=s?await s.async("blob"):await ne.loadResource(n),r=await ne.readBlobAsArrayBuffer(i);if(t.endsWith(".ogg")&&I.isSafari())e=await gt.decodeOggData(r);else if(window.AudioContext)try{let t=r.slice(0,r.byteLength);e=await this.context.decodeAudioData(t)}catch(t){e=await gt.decodeOggData(r)}else e=await new Promise((e,t)=>{this.context.decodeAudioData(r,t=>e(t),e=>t(e))});return ut.set(n,e),ct.delete(n),e})();return s||ct.set(n,a),a}loadBuffers(e){return Promise.all(e.map(e=>this.loadBuffer(e)))}createAudioSource(e,t=this.soundGain,i,s=!1){let n,r="string"==typeof e?e:I.randomFromArray(e),a=this.toFullPath(r);if(r.endsWith(".ogg")&&I.isSafari()&&(s=!1),s)if(ut.has(a))s=!1;else{let e=new Audio;e.src=a,e.preload="auto",n=new pt(this,e,t,i)}if(!s){let e=this.loadBuffer(r);n=new pt(this,e,t,i)}return i&&n.gain.gain.setValueAtTime(0,this.currentTime),this.audioSources.push(n),n}play(e,t=1,i=this.soundGain,s){let n=this.createAudioSource(e,i,s);n.gain.gain.setValueAtTime(s?0:t,this.currentTime),n.play()}updatePositionalAudio(t,s,n){let r=e.level.getOrientationQuat(t);r.conjugate();for(let e of this.audioSources){if(!e.position)continue;let t=e.position.clone().sub(s);t.applyQuaternion(r),t.applyAxisAngle(new i(0,0,1),-n),t.normalize(),t.z=0;let a=e.position.distanceTo(s),o=I.clamp(a/1,0,1);e.setPannerValue(.7*-t.y*o),e.gain.gain.setValueAtTime(I.clamp(1-a/30,0,1)*e.gainFactor,this.currentTime)}}updateVolumes(){this.musicGain.gain.linearRampToValueAtTime(Y.data.settings.musicVolume**2,this.currentTime+.01),this.soundGain.gain.linearRampToValueAtTime(Y.data.settings.soundVolume**2,this.currentTime+.01)}stopAllAudio(){for(let e of this.audioSources.slice())e.stop()}normalizePositionalAudioVolume(){let e=this.audioSources.filter(e=>e.position);for(let t=0;t<e.length;t++){let i=e[t],s=0;for(let n=0;n<e.length;n++){if(t===n)continue;let r=e[n],a=i.position.distanceTo(r.position);s+=I.clamp(1-a/30,0,1)}i.gainFactor=Math.min(1/s,1)}}}class pt{constructor(e,t,i,s){this.stopped=!1,this.playing=!1,this.gainFactor=1,this.loop=!1,this.playbackRate=1,this.manager=e,t instanceof Promise?this.promise=t:(this.audioElement=t,this.promise=new Promise(e=>{t.addEventListener("canplaythrough",()=>e())})),this.destination=i,this.position=s,this.gain=this.manager.context.createGain(),this.manager.context.createStereoPanner?this.panner=this.manager.context.createStereoPanner():this.panner=this.manager.context.createPanner(),this.gain.connect(this.panner),this.panner.connect(this.destination),t instanceof Promise?this.node=this.manager.context.createBufferSource():this.node=this.manager.context.createMediaElementSource(t),this.node.connect(this.gain)}setPannerValue(e){this.manager.context.createStereoPanner?this.panner.pan.setValueAtTime(e,this.manager.currentTime):(this.panner.panningModel="equalpower",this.panner.setPosition(e,0,1-Math.abs(e)))}setLoop(e){this.audioElement?this.audioElement.loop=e:this.node.loop=e,this.loop=e}setPlaybackRate(e){this.audioElement?this.audioElement.playbackRate=e:this.node.playbackRate.setValueAtTime(e,this.manager.currentTime),this.playbackRate=e}async play(){var e,t;if(this.playing)return;this.stopped&&(this.stopped=!1,this.node instanceof AudioBufferSourceNode&&(this.node=this.manager.context.createBufferSource(),this.node.connect(this.gain),this.node.loop=this.loop,this.node.playbackRate.setValueAtTime(this.playbackRate,this.manager.currentTime),this.stopped=!1,this.manager.audioSources.push(this)));let i=await this.promise;if(!this.stopped){if(this.node instanceof AudioBufferSourceNode){if(this.node.buffer)return;this.node.buffer=i,this.node.start(this.manager.currentTime),this.node.onended=(()=>{this.stop()})}else null===(e=this.audioElement)||void 0===e||e.play(),null===(t=this.audioElement)||void 0===t||t.addEventListener("ended",()=>this.stop());this.playing=!0}}stop(){if(!this.stopped){this.stopped=!0,this.playing=!1;try{this.audioElement?(this.audioElement.pause(),this.audioElement.currentTime=0,this.audioElement.load()):this.node.stop(this.manager.currentTime)}catch(e){}I.removeFromArray(this.manager.audioSources,this)}}}const gt=OggdecModule(),ft=new mt;class yt{static async init(){await this.syncLeaderboard()}static loadLocal(){let t=new Set,i=e.menu.levelSelect.sortedMissionArray;for(let s=-5;s<=5;s++){let n=i[e.menu.levelSelect.getCycleMissionIndex(s)];n&&t.add(n.path)}for(let i of e.menu.levelSelect.getNextShuffledMissions())t.add(i.path);this.loadForMissions([...t])}static async loadForMissions(e){if(0===(e=e.filter(e=>!this.loading.has(e)&&!this.scores.has(e))).length)return;e.forEach(e=>this.loading.add(e)),this.registerLeaderboardChange(e);let t=await ne.retryFetch("./api/scores",{method:"POST",body:JSON.stringify({missions:e})}),i=await ne.readBlobAsJson(t);for(let e in i)this.scores.set(e,i[e]),this.loading.delete(e);this.registerLeaderboardChange(e)}static isLoading(e){return this.loading.has(e)}static async submitScore(e,t){Y.data.bestTimeSubmissionQueue.push({missionPath:e,score:t}),Y.store(),this.syncLeaderboard()}static async syncLeaderboard(){var e;let t=Y.data.bestTimeSubmissionQueue,i=[],s={};for(let{missionPath:n,score:r}of t){let t={id:r[2],missionPath:n,score:[r[0],r[1]]};i.push(t);let a=null===(e=this.scores.get(n))||void 0===e?void 0:e[0];if(!a||r[1]<a[1]){let e=await Y.databaseGet("replays",r[2]);if(!e)continue;let i=await I.arrayBufferToBase64(e);s[t.id]=i}}let n={randomId:Y.data.randomId,scores:Object.keys(t).length?await I.arrayBufferToBase64(await U("compress",JSON.stringify(i))):null,latestTimestamp:this.latestTimestamp,replays:s,version:Y.data.lastSeenVersion},r=await ne.retryFetch("./api/submit",{method:"POST",body:JSON.stringify(n)}),a=await ne.readBlobAsJson(r);this.latestTimestamp=a.latestTimestamp;for(let e in a.scores){if(!this.scores.has(e))continue;let t=this.scores.get(e),i=a.scores[e];(t=t.filter(e=>!i.some(t=>t[0]===e[0]))).push(...i),t.sort((e,t)=>e[1]-t[1]),this.scores.set(e,t)}this.registerLeaderboardChange(Object.keys(a.scores)),Y.data.bestTimeSubmissionQueue=[],Y.store()}static registerLeaderboardChange(t){var i;let s=!1,n=Y.data.bestTimeSubmissionQueue;for(let e of t){let t=this.scores.get(e),r=null===(i=Y.data.bestTimes[e])||void 0===i?void 0:i[0];if(!t||!r||n.some(t=>t.missionPath===e))continue;let a=t[0];for(;r&&(!a||r[1]<Number(a[1]));)Y.data.bestTimes[e].splice(0,1),r=Y.data.bestTimes[e][0],s=!0;0===Y.data.bestTimes[e].length&&delete Y.data.bestTimes[e]}s&&Y.storeBestTimes();let r=e.menu.levelSelect.currentMission;t.includes(null===r||void 0===r?void 0:r.path)&&e.menu.levelSelect.displayBestTimes()}}yt.scores=new Map,yt.loading=new Set,yt.latestTimestamp=null;class bt{constructor(e=0,t=0,i=0,s=1){this.x=e,this.y=t,this.z=i,this.w=s}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new bt(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=this.w,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*s+r[12]*n,this.y=r[1]*t+r[5]*i+r[9]*s+r[13]*n,this.z=r[2]*t+r[6]*i+r[10]*s+r[14]*n,this.w=r[3]*t+r[7]*i+r[11]*s+r[15]*n,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,s,n;const r=e.elements,a=r[0],o=r[4],l=r[8],h=r[1],d=r[5],c=r[9],u=r[2],m=r[6],p=r[10];if(Math.abs(o-h)<.01&&Math.abs(l-u)<.01&&Math.abs(c-m)<.01){if(Math.abs(o+h)<.1&&Math.abs(l+u)<.1&&Math.abs(c+m)<.1&&Math.abs(a+d+p-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;const e=(a+1)/2,r=(d+1)/2,g=(p+1)/2,f=(o+h)/4,y=(l+u)/4,b=(c+m)/4;return e>r&&e>g?e<.01?(i=0,s=.707106781,n=.707106781):(s=f/(i=Math.sqrt(e)),n=y/i):r>g?r<.01?(i=.707106781,s=0,n=.707106781):(i=f/(s=Math.sqrt(r)),n=b/s):g<.01?(i=.707106781,s=.707106781,n=0):(i=y/(n=Math.sqrt(g)),s=b/n),this.set(i,s,n,t),this}let g=Math.sqrt((m-c)*(m-c)+(l-u)*(l-u)+(h-o)*(h-o));return Math.abs(g)<.001&&(g=1),this.x=(m-c)/g,this.y=(l-u)/g,this.z=(h-o)/g,this.w=Math.acos((a+d+p-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}var vt;!function(e){e[e.SimGroup=0]="SimGroup",e[e.ScriptObject=1]="ScriptObject",e[e.MissionArea=2]="MissionArea",e[e.Sky=3]="Sky",e[e.Sun=4]="Sun",e[e.InteriorInstance=5]="InteriorInstance",e[e.StaticShape=6]="StaticShape",e[e.Item=7]="Item",e[e.Path=8]="Path",e[e.Marker=9]="Marker",e[e.PathedInterior=10]="PathedInterior",e[e.Trigger=11]="Trigger",e[e.AudioProfile=12]="AudioProfile",e[e.MessageVector=13]="MessageVector",e[e.TSStatic=14]="TSStatic",e[e.ParticleEmitterNode=15]="ParticleEmitterNode"}(vt||(vt={}));const wt=/new\s+(\w+)\((.*?)\)\s*{/g,xt=/\/\*(.|\n)*?\*\//g,St=/\/\/.*/g,Tt=/(\$(?:\w|\d)+)\s*=\s*(.+?);/g,Mt=/setMarbleAttributes\("(\w+)",\s*(.+?)\);/g,Ct=/activatePackage\((.+?)\);/g,kt=/new MaterialProperty *\( *(.+?) *\)\s*{\s*((?:\w+ *= *(\d|\.)+;\s*)*)}/gi,At=/addMaterialMapping *\( *"(.+?)" *, *(.+?) *\)/gi,_t=/([^\s]+?)\s*=\s*"(.*?)"\s*;/g;class It{constructor(e){this.index=0,this.currentElementId=0,this.text=e}parse(){this.text=Et+"\n\n"+this.text;let e=this.text.indexOf("//--- OBJECT WRITE BEGIN ---"),t=this.text.lastIndexOf("//--- OBJECT WRITE END ---"),i=this.text.slice(0,e)+this.text.slice(t);this.variables={$usermods:'""'},Tt.lastIndex=0;let s=null;for(;null!==(s=Tt.exec(i));)this.variables[s[1]]||(this.variables[s[1]]=s[2]);let n={};for(s=null,Mt.lastIndex=0;null!==(s=Mt.exec(i));)n[s[1]]=this.resolveExpression(s[2]);let r=[];for(s=null,Ct.lastIndex=0;null!==(s=Ct.exec(i));)r.push(this.resolveExpression(s[1]));let a={};for(s=null,kt.lastIndex=0;null!==(s=kt.exec(i));){let e=s[2].split(";").filter(e=>e.trim()).map(e=>e.split("=").map(e=>e.trim()));a[s[1]]={};for(let t of e)a[s[1]][t[0]]=Number(t[1])}let o={};for(s=null,At.lastIndex=0;null!==(s=At.exec(i));)o[s[1]]=s[2];-1!==e&&-1!==t&&(this.text=this.text.slice(e,t));let l=0;for(;;){xt.lastIndex=l,St.lastIndex=l;let e=xt.exec(this.text),t=St.exec(this.text);if(e&&I.indexIsInStringLiteral(this.text,e.index)&&(e=null),t&&I.indexIsInStringLiteral(this.text,t.index)&&(t=null),!e&&!t)break;!t||e&&t&&e.index<t.index?(this.text=this.text.slice(0,e.index)+this.text.slice(e.index+e[0].length),l=e.index):(this.text=this.text.slice(0,t.index)+this.text.slice(t.index+t[0].length),l=t.index)}let h=this.text.indexOf("new SimGroup(MissionGroup)");-1!==h&&(this.index=h);let d=[];for(;this.hasNextElement();){let e=this.readElement();e&&d.push(e)}if(1!==d.length)throw console.log(d),new Error("Mission file doesn't have exactly 1 outer element!");return{root:d[0],marbleAttributes:n,activatedPackages:r,materialProperties:a,materialMappings:o}}readElement(){wt.lastIndex=this.index;let e=wt.exec(this.text);this.index=e.index+e[0].length;let t=e[1],i=e[2];this.index=e.index+e[0].length;let s=null;switch(t){case"SimGroup":s=this.readSimGroup(i);break;case"ScriptObject":s=this.readScriptObject(i);break;case"MissionArea":s=this.readMissionArea(i);break;case"Sky":s=this.readSky(i);break;case"Sun":s=this.readSun(i);break;case"InteriorInstance":s=this.readInteriorInstance(i);break;case"StaticShape":s=this.readStaticShape(i);break;case"Item":s=this.readItem(i);break;case"Path":s=this.readPath(i);break;case"Marker":s=this.readMarker(i);break;case"PathedInterior":s=this.readPathedInterior(i);break;case"Trigger":s=this.readTrigger(i);break;case"AudioProfile":s=this.readAudioProfile(i);break;case"MessageVector":s=this.readMessageVector(i);break;case"TSStatic":s=this.readTSStatic(i);break;case"ParticleEmitterNode":s=this.readParticleEmitterNode(i);break;default:{console.warn("Unknown element type! "+t);let e=I.indexOfIgnoreStringLiterals(this.text,"};",this.index);-1===e&&(e=this.text.length),this.index=e+2}}return s&&(s._id=this.currentElementId++),s}hasNextElement(){wt.lastIndex=this.index;let e=wt.exec(this.text);return!!e&&-1===I.indexOfIgnoreStringLiterals(this.text.slice(this.index,e.index),"}")}readSimGroup(e){let t=[],i={};for(;;){wt.lastIndex=this.index,_t.lastIndex=this.index;let e=wt.exec(this.text),s=_t.exec(this.text),n=Math.min(null===e||void 0===e?void 0:e.index,null===s||void 0===s?void 0:s.index);if(!isFinite(n))break;if(-1!==I.indexOfIgnoreStringLiterals(this.text.slice(this.index,n),"}"))break;if(n===(null===e||void 0===e?void 0:e.index)){let e=this.readElement();if(!e)continue;t.push(e)}else i[s[1]]=this.resolveExpression(s[2]),this.index+=s[0].length}let s=I.indexOfIgnoreStringLiterals(this.text,"};",this.index);return-1===s&&(s=this.text.length),this.index=s+2,t?Object.assign(i,{_type:vt.SimGroup,_name:e,elements:t}):null}readValues(){var e;let t={},i=I.indexOfIgnoreStringLiterals(this.text,"};",this.index);-1===i&&(i=this.text.length);let s=this.text.slice(this.index,i).trim(),n=I.splitIgnoreStringLiterals(s,";").map(e=>e.trim());for(let i of n){if(!i)continue;let s=i.indexOf("=");if(-1===s)continue;let n=[i.slice(0,s),i.slice(s+1)].map(e=>e.trim());if(2!==n.length)continue;let r=n[0];if((r=r.toLowerCase()).endsWith("]")){let i=r.indexOf("["),s=r.slice(0,i);(null!==(e=t[s])&&void 0!==e?e:t[s]=[])[Number(r.slice(i+1,-1))]=this.resolveExpression(n[1])}else t[r]=this.resolveExpression(n[1])}return this.index=i+2,t}resolveExpression(e){return I.splitIgnoreStringLiterals(e,"@").map(e=>((e=e.trim()).startsWith("$")&&void 0!==this.variables[e]?e=this.resolveExpression(this.variables[e]):e.startsWith('"')&&e.endsWith('"')&&(e=I.unescape(e.slice(1,-1))),e)).join("")}readScriptObject(e){return Object.assign({_type:vt.ScriptObject,_name:e},this.readValues())}readMissionArea(e){return Object.assign({_type:vt.MissionArea,_name:e},this.readValues())}readSky(e){return Object.assign({_type:vt.Sky,_name:e},this.readValues())}readSun(e){return Object.assign({_type:vt.Sun,_name:e},this.readValues())}readInteriorInstance(e){return Object.assign({_type:vt.InteriorInstance,_name:e},this.readValues())}readStaticShape(e){return Object.assign({_type:vt.StaticShape,_name:e},this.readValues())}readItem(e){return Object.assign({_type:vt.Item,_name:e},this.readValues())}readPath(e){let t=this.readSimGroup(e);return t.markers=t.elements.sort((e,t)=>It.parseNumber(e.seqnum)-It.parseNumber(t.seqnum)),delete t.elements,t._type=vt.Path,t}readMarker(e){return Object.assign({_type:vt.Marker,_name:e},this.readValues())}readPathedInterior(e){return Object.assign({_type:vt.PathedInterior,_name:e},this.readValues())}readTrigger(e){return Object.assign({_type:vt.Trigger,_name:e},this.readValues())}readAudioProfile(e){return Object.assign({_type:vt.AudioProfile,_name:e},this.readValues())}readMessageVector(e){return Object.assign({_type:vt.MessageVector,_name:e},this.readValues())}readTSStatic(e){return Object.assign({_type:vt.TSStatic,_name:e},this.readValues())}readParticleEmitterNode(e){return Object.assign({_type:vt.ParticleEmitterNode,_name:e},this.readValues())}static async loadFile(e){if(this.cachedFiles.get(e))return this.cachedFiles.get(e);let t=await ne.loadResource(e),i=await ne.readBlobAsText(t),s=new It(i).parse();return this.cachedFiles.set(e,s),s}static parseVector3(e){if(!e)return new i;let t=e.split(" ").map(e=>Number(e));return t.length<3?new i:void 0!==t.find(e=>!isFinite(e))?new i:new i(t[0],t[1],t[2])}static parseVector4(e){if(!e)return new bt;let t=e.split(" ").map(e=>Number(e));return t.length<4?new bt:void 0!==t.find(e=>!isFinite(e))?new bt:new bt(t[0],t[1],t[2],t[3])}static parseRotation(e){if(!e)return new t;let s=e.split(" ").map(e=>Number(e));if(s.length<4)return new t;if(void 0!==s.find(e=>!isFinite(e)))return new t;let n=new t;return n.setFromAxisAngle(new i(s[0],s[1],s[2]),-I.degToRad(s[3])),n}static parseNumber(e){if(!e||"string"!=typeof e)return 0;let t=Number(e.split(",")[0]);return isNaN(t)?0:t}static parseNumberList(e){let t=e.split(" "),i=[];for(let e of t){let t=Number(e);if(isNaN(t)){const t=7;for(;e.length>0;){let s=e.indexOf(".");if(-1===s)break;let n=e.slice(0,Math.min(s+t+1,e.length));i.push(Number(n)),e=e.slice(s+t+1)}}else i.push(t)}return i}static parseBoolean(e){return!!e&&"0"!==e}}It.cachedFiles=new Map;const Et="\nnew MaterialProperty(GrassFrictionMaterial) {\n\tfriction = 1.50;\n\trestitution = 0.35;\n};\n\nnew MaterialProperty(TarmacFrictionMaterial) {\n\tfriction = 0.35;\n\trestitution = 0.7;\n};\n\nnew MaterialProperty(RugFrictionMaterial) {\n\tfriction = 6;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(IceFrictionMaterial) {\n\tfriction = 0.03;\n\trestitution = 0.95;\n};\n\nnew MaterialProperty(CarpetFrictionMaterial) {\n\tfriction = 6;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(SandFrictionMaterial) {\n\tfriction = 4;\n\trestitution = 0.1;\n};\n\nnew MaterialProperty(WaterFrictionMaterial) {\n\tfriction = 6;\n\trestitution = 0;\n};\n\nnew MaterialProperty(BouncyFrictionMaterial) {\n\tfriction = 0.2;\n\trestitution = 0;\n\tforce = 15;\n};\n\nnew MaterialProperty(RandomForceMaterial) {\n\tfriction = -1;\n\trestitution = 1;\n};\n\n// MBU/O values...\n\nnew MaterialProperty(HighFrictionMultiplayerMaterial) {\n\tfriction = 6;\n\trestitution = 0.3;\n};\n\n// added to stop the game from popping an error in the console log that it cannot find the\n// material property even though the game runs fine without that minor piece of code\n// so these lines of code are an extra to shut the game up and you can remove them if you wish\n\nnew MaterialProperty(DefaultMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n};\n\n// these values are for a balanced game play with Mini Marble Golf (the levels)\n// they might be a tad different to their MBP equivalent and are more realistic\n\nnew MaterialProperty(MMGGrassMaterial) {\n\tfriction = 0.9;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(MMGSandMaterial) {\n\tfriction = 6;\n\trestitution = 0.1;\n};\n\nnew MaterialProperty(MMGWaterMaterial) {\n\tfriction = 6;\n\trestitution = 0;\n};\n\nnew MaterialProperty(MMGIceMaterial) {\n\tfriction = 0.03;\n\trestitution = 0.95;\n};\n\nnew MaterialProperty(MMGIceShadowMaterial) {\n\tfriction = 0.2;\n\trestitution = 0.95;\n};\n\n// These are some old values\n\nnew MaterialProperty(BumperMaterial) {\n\tfriction = 0.5;\n\trestitution = 0;\n\tforce = 15;\n};\n\nnew MaterialProperty(ButtonMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n};\n\n// MBG Values for their frictions. MBP ones still rock, though.\n\n// Space\n\nnew MaterialProperty(NoFrictionMaterial) {\n\tfriction = 0.01;\n\trestitution = 0.5;\n};\n\n// Mud\n\nnew MaterialProperty(LowFrictionMaterial) {\n\tfriction = 0.20;\n\trestitution = 0.5;\n};\n\n// Grass\n\nnew MaterialProperty(HighFrictionMaterial) {\n\tfriction = 1.50;\n\trestitution = 0.5;\n};\n\n// Yellow ramps with arrows from Three Fold Maze and Escher's Race\n\nnew MaterialProperty(VeryHighFrictionMaterial) {\n\tfriction = 2;\n\trestitution = 1;\n};\n\n// Normal floor\n\nnew MaterialProperty(RubberFloorMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n};\n\n// Oil Slick\n\nnew MaterialProperty(IceMaterial) {\n\tfriction = 0.05;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(XmasSnowMaterial) {\n\tfriction = 3;\n\trestitution = 0.2;\n};\n\n// PlatinumQuest frictions\n\nnew MaterialProperty(PQSpaceMaterial) {\n\tfriction = 0.01;\n\trestitution = 0.35;\n};\n\n// It's elite\nnew MaterialProperty(PQIceMaterial) {\n\tfriction = 0.07331;\n\trestitution = 0.75;\n};\n\nnew MaterialProperty(PQMudMaterial) {\n\tfriction = 0.30;\n\trestitution = 0.5;\n};\n\n// Match 3FM/ER friction\nnew MaterialProperty(PQGrassMaterial) {\n\tfriction = 2;\n\trestitution = 0.5;\n};\n\n// Tad higher on rest. now\nnew MaterialProperty(PQSandMaterial) {\n\tfriction = 4;\n\trestitution = 0.15;\n};\n\nnew MaterialProperty(PQBouncyMaterial) {\n\tfriction = 0.2;\n\trestitution = 0;\n\tforce = 15;\n};\n\nnew MaterialProperty(IceShardMaterial) {\n\tfriction = 0;\n\trestitution = 0;\n\tforce = 0;\n};\n\nnew MaterialProperty(MORepulsionMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n\tforce = 10;\n};\n\nnew MaterialProperty(MOWeakRepulsionMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n\tforce = 5;\n};\n\n// Spooky!!\n\nnew MaterialProperty(SpookyWaterMaterial) {\n\tfriction = 6;\n\trestitution = 0;\n};\n\nnew MaterialProperty(SpookyDirtMaterial) {\n\tfriction = 6;\n\trestitution = 0.3;\n};\n\nnew MaterialProperty(SpookyGrassMaterial) {\n\tfriction = 2;\n\trestitution = 0.75;\n};";class Bt{constructor(e){this.index=0,this.buffer=e,this.view=new DataView(e)}readU8(){return this.view.getUint8(this.index++)}readU16(){return this.view.getUint16((this.index=this.index+2)-2,!0)}readU32(){return this.view.getUint32((this.index=this.index+4)-4,!0)}readS8(){return this.view.getInt8(this.index++)}readS16(){return this.view.getInt16((this.index=this.index+2)-2,!0)}readS32(){return this.view.getInt32((this.index=this.index+4)-4,!0)}readF32(){return this.view.getFloat32((this.index=this.index+4)-4,!0)}readBool(){return 1===this.readU8()}readPoint3F(){return{x:this.readF32(),y:this.readF32(),z:this.readF32()}}readBox3F(){return{min:this.readPoint3F(),max:this.readPoint3F()}}readSphereF(){return{center:this.readPoint3F(),radius:this.readF32()}}readPlaneF(){return{x:this.readF32(),y:this.readF32(),z:this.readF32(),d:this.readF32()}}readString(){let e=this.readU8(),t="";for(let i=0;i<e;i++)t+=String.fromCharCode(this.readU8());for(;0===t.charCodeAt(t.length-1);)t=t.slice(0,-1);return t}}var Pt;!function(e){e[e.Standard=0]="Standard",e[e.Skin=1]="Skin",e[e.Decal=2]="Decal",e[e.Sorted=3]="Sorted",e[e.Null=4]="Null"}(Pt||(Pt={}));class Lt{constructor(e,t,i,s){this.lastGuardValue=0,this.buf=e,this.view=new DataView(this.buf),this.index32=t,this.index16=t+4*i,this.index8=t+4*s}readU32(){let e=this.view.getUint32(this.index32,!0);return this.index32+=4,e}readS32(){let e=this.view.getInt32(this.index32,!0);return this.index32+=4,e}readF32(){let e=this.view.getFloat32(this.index32,!0);return this.index32+=4,e}readPoint2F(){return{x:this.readF32(),y:this.readF32()}}readPoint3F(){return{x:this.readF32(),y:this.readF32(),z:this.readF32()}}readBoxF(){return{min:this.readPoint3F(),max:this.readPoint3F()}}readU16(){let e=this.view.getUint16(this.index16,!0);return this.index16+=2,e}readS16(){let e=this.view.getInt16(this.index16,!0);return this.index16+=2,e}readU8(){let e=this.view.getUint8(this.index8);return this.index8+=1,e}readQuat16(){return{x:this.readS16(),y:this.readS16(),z:this.readS16(),w:this.readS16()}}readMatrixF(){return new Array(16).fill(null).map(()=>this.readF32())}guard(){let e=this.readU32(),t=this.readU16(),i=this.readU8();if(e!==t||t!==i||i!==this.lastGuardValue)throw new Error("Guard fail! Expected "+this.lastGuardValue+" but got "+e+" for 32, "+t+" for 16 and "+i+" for 8.");this.lastGuardValue++}}class Rt{constructor(e,t){this.sourceIndex=0,this.index32=0,this.index16=0,this.index8=0,this.nextGuard=0,this.sourceView=e,this.sourceIndex=t,this.buffer32=new DataView(new ArrayBuffer(25e3)),this.buffer16=new DataView(new ArrayBuffer(25e3)),this.buffer8=new DataView(new ArrayBuffer(25e3))}skip(e){this.sourceIndex+=e}allocate32(e){this.index32+=4*e}allocate16(e){this.index16+=2*e}allocate8(e){this.index8+=1*e}copyInto32(e){for(let t=0;t<e;t++)this.buffer32.setUint32(this.index32+4*t,this.sourceView.getUint32(this.sourceIndex+4*t,!0),!0);this.sourceIndex+=4*e,this.index32+=4*e}copyInto16(e){for(let t=0;t<e;t++)this.buffer16.setUint16(this.index16+2*t,this.sourceView.getUint16(this.sourceIndex+2*t,!0),!0);this.sourceIndex+=2*e,this.index16+=2*e}copyInto8(e){for(let t=0;t<1*e;t++)this.buffer8.setUint8(this.index8+1*t,this.sourceView.getUint8(this.sourceIndex+1*t));this.sourceIndex+=1*e,this.index8+=1*e}readS32(e=this.index32/4){let t=this.sourceView.getInt32(this.sourceIndex,!0);return this.sourceIndex+=4,null!==e&&(this.buffer32.setInt32(4*e,t,!0),4*e===this.index32&&(this.index32+=4)),t}writeS32(e){this.buffer32.setInt32(this.index32,e,!0),this.index32+=4}writeU8(e){this.buffer8.setUint8(this.index8,e),this.index8+=1}guard(){this.buffer32.setUint32(this.index32,this.nextGuard,!0),this.buffer16.setUint16(this.index16,this.nextGuard,!0),this.buffer8.setUint8(this.index8,this.nextGuard),this.nextGuard++,this.index32+=4,this.index16+=2,this.index8+=1}createBuffer(){this.index16=4*Math.ceil(this.index16/4),this.index8=4*Math.ceil(this.index8/4);let e=new ArrayBuffer(this.index32+this.index16+this.index8),t=new Uint8Array(e),i=0;for(let e=0;e<this.index32;e++)t[i++]=this.buffer32.getUint8(e);for(let e=0;e<this.index16;e++)t[i++]=this.buffer16.getUint8(e);for(let e=0;e<this.index8;e++)t[i++]=this.buffer8.getUint8(e);return{buffer:e,start16:this.index32/4,start8:(this.index32+this.index16)/4}}}class Ft extends Bt{parse(e=!1){let t,i,s,n,r,a,o=this.readU16(),l=this.readU16();if(o<19){let e=this.readOldShape(o);t=e.bufferInfo.buffer,i=0,s=e.bufferInfo.start16,n=e.bufferInfo.start8,r=e.sequences,a=e.materialList}else{let e=this.readU32();t=this.buffer,s=this.readU32(),n=this.readU32(),i=this.index,this.index+=4*e;let l=this.readS32();r=[];for(let e=0;e<l;e++)r.push(this.parseSequence());a=this.parseMaterialList(o)}let h={};if(!e){let e=new Lt(t,i,s,n);h=this.assembleShape(e,o)}let d={version:o,exporterVersion:l,sequences:r};return d=Object.assign(d,a),d=Object.assign(d,h)}assembleShape(e,t){let i,s,n,r,a,o=e.readS32(),l=e.readS32(),h=e.readS32(),d=e.readS32(),c=e.readS32();t<22?(i=s=e.readS32()-o,n=r=a=0):(i=e.readS32(),s=e.readS32(),n=e.readS32(),r=e.readS32(),a=e.readS32());let u=0;t>23&&(u=e.readS32());let m=e.readS32(),p=e.readS32(),g=e.readS32(),f=e.readS32(),y=e.readS32();t<23&&e.readS32();let b=e.readS32(),v=e.readF32();e.readS32(),e.guard();let w=e.readF32(),x=e.readF32(),S=e.readPoint3F(),T=e.readBoxF();e.guard();let M=0,C=Array(o).fill(null).map(()=>({index:M++,nameIndex:e.readS32(),parentIndex:e.readS32(),firstObject:e.readS32(),firstChild:e.readS32(),nextSibling:e.readS32()}));e.guard();let k=Array(l).fill(null).map(()=>({nameIndex:e.readS32(),numMeshes:e.readS32(),startMeshIndex:e.readS32(),nodeIndex:e.readS32(),nextSibling:e.readS32(),firstDecal:e.readS32()}));e.guard();let A=Array(h).fill(null).map(()=>({nameIndex:e.readS32(),numMeshes:e.readS32(),startMeshIndex:e.readS32(),objectIndex:e.readS32(),nextSibling:e.readS32()}));e.guard();let _=Array(c).fill(null).map(()=>({nameIndex:e.readS32(),materialSlot:e.readS32(),firstFrame:e.readS32(),firstFrameOffTimeIndex:e.readS32(),numFrames:e.readS32()}));e.guard();let I=Array(d).fill(null).map(()=>e.readS32()),E=Array(d).fill(null).map(()=>e.readS32()),B=Array(d).fill(null).map(()=>e.readS32());e.guard();let P=Array(d).fill(null).map(()=>e.readS32()),L=Array(d).fill(null).map(()=>e.readS32()),R=Array(d).fill(null).map(()=>e.readS32());e.guard();let F=Array(o).fill(null).map(()=>e.readQuat16()),z=Array(o).fill(null).map(()=>e.readPoint3F()),D=Array(i).fill(null).map(()=>e.readQuat16()),U=Array(s).fill(null).map(()=>e.readPoint3F());e.guard();let V=[],O=[],N=[],q=[];t>21&&(V=Array(n).fill(null).map(()=>e.readF32()),O=Array(r).fill(null).map(()=>e.readPoint3F()),N=Array(a).fill(null).map(()=>e.readPoint3F()),q=Array(a).fill(null).map(()=>e.readQuat16()),e.guard());let j=Array(u).fill(null).map(()=>e.readPoint3F()),G=Array(u).fill(null).map(()=>e.readQuat16());t>23&&e.guard();let W=Array(m).fill(null).map(()=>({vis:e.readF32(),frameIndex:e.readS32(),matFrame:e.readS32()}));e.guard();let H=Array(p).fill(null).map(()=>e.readS32());e.guard();let X=Array(g).fill(null).map(()=>({state:e.readU32(),pos:e.readF32()}));e.guard();let Y=Array(f).fill(null).map(()=>({nameIndex:e.readS32(),subShapeNum:e.readS32(),objectDetailNum:e.readS32(),size:e.readF32(),averageError:e.readF32(),maxError:e.readF32(),polyCount:e.readS32()}));e.guard();let Q=[];for(let i=0;i<y;i++){let i=e.readU32();if(i===Pt.Null){Q.push(null);continue}e.guard();let s=e.readS32(),n=e.readS32(),r=e.readS32(),a=e.readBoxF(),o=e.readPoint3F(),l=e.readF32(),h=e.readS32(),d=r<0?Array(h).fill(null).map(()=>e.readPoint3F()):Q[r].verts,c=e.readS32(),u=r<0?Array(c).fill(null).map(()=>e.readPoint2F()):Q[r].tverts,m=r<0?Array(h).fill(null).map(()=>e.readPoint3F()):Q[r].norms,p=[];t>21&&(p=r<0?Array(h).fill(null).map(()=>e.readU8()):Q[r].encodedNorms);let g=e.readS32(),f=Array(g).fill(null).map(()=>({start:e.readU16(),numElements:e.readU16(),matIndex:e.readU32()})),y=e.readS32(),b=Array(y).fill(null).map(()=>e.readS16()),v=e.readS32(),w=Array(v).fill(null).map(()=>e.readS16()),x=e.readS32(),S=e.readS32();e.guard();let T={type:i,numFrames:s,numMatFrames:n,parentMesh:r,bounds:a,center:o,radius:l,verts:d,tverts:u,norms:m,encodedNorms:p,primitives:f,indices:b,mergeIndices:w,vertsPerFrame:x,flags:S};if(i===Pt.Skin){let t=e.readS32(),i=Array(t).fill(null).map(()=>e.readPoint3F()),s=Array(t).fill(null).map(()=>e.readPoint3F()),n=Array(t).fill(null).map(()=>e.readU8()),r=e.readS32(),a=Array(r).fill(null).map(()=>e.readMatrixF()),o=e.readS32(),l=Array(o).fill(null).map(()=>e.readS32()),h=Array(o).fill(null).map(()=>e.readS32()),d=Array(o).fill(null).map(()=>e.readF32()),c=e.readS32(),u=Array(c).fill(null).map(()=>e.readS32());T.verts=i,T.norms=s,T.encodedNorms=n,T.initialTransforms=a,T.vertIndices=l,T.boneIndices=h,T.weights=d,T.nodeIndices=u,e.guard()}Q.push(T)}e.guard();let K=[];for(let t=0;t<b;t++){let t="";for(;;){let i=e.readU8();if(0===i)break;t+=String.fromCharCode(i)}K.push(t)}return e.guard(),{smallestVisibleSize:v,radius:w,tubeRadius:x,center:S,bounds:T,nodes:C,objects:k,decals:A,iflMaterials:_,subShapeFirstNode:I,subShapeFirstObject:E,subShapeFirstDecal:B,subShapeNumNodes:P,subShapeNumObjects:L,subShapeNumDecals:R,defaultRotations:F,defaultTranslations:z,nodeRotations:D,nodeTranslations:U,nodeUniformScales:V,nodeAlignedScales:O,nodeArbScaleFactors:N,nodeArbScaleRots:q,groundTranslations:j,groundRotations:G,objectStates:W,decalStates:H,triggers:X,details:Y,meshes:Q,names:K,alphaIn:new Array(f).fill(null).map(()=>e.readF32()),alphaOut:new Array(f).fill(null).map(()=>e.readF32())}}parseSequence(){return{nameIndex:this.readS32(),flags:this.readU32(),numKeyframes:this.readS32(),duration:this.readF32(),priority:this.readS32(),firstGroundFrame:this.readS32(),numGroundFrames:this.readS32(),baseRotation:this.readS32(),baseTranslation:this.readS32(),baseScale:this.readS32(),baseObjectState:this.readS32(),baseDecalState:this.readS32(),firstTrigger:this.readS32(),numTriggers:this.readS32(),toolBegin:this.readF32(),rotationMatters:this.readBitSet(),translationMatters:this.readBitSet(),scaleMatters:this.readBitSet(),decalMatters:this.readBitSet(),iflMatters:this.readBitSet(),visMatters:this.readBitSet(),frameMatters:this.readBitSet(),matFrameMatters:this.readBitSet()}}parseMaterialList(e){this.readS8();let t=this.readS32(),i=Array(t).fill(null).map(e=>this.readString()),s=Array(t).fill(null).map(e=>this.readU32()),n=Array(t).fill(null).map(e=>this.readS32()),r=Array(t).fill(null).map(e=>this.readS32()),a=Array(t).fill(null).map(e=>this.readS32());return 25===e&&Array(t).fill(null).map(e=>this.readS32()),{matNames:i,matFlags:s,matReflectanceMaps:n,matBumpMaps:r,matDetailMaps:a,matDetailScales:Array(t).fill(null).map(e=>this.readF32()),matReflectance:Array(t).fill(null).map(e=>this.readF32())}}readBitSet(){this.index+=4;let e=this.readS32(),t=[];for(let i=0;i<e;i++)t.push(this.readU32());return t}readOldShape(e){let t=new Rt(this.view,this.index);t.allocate32(15),t.guard(),t.copyInto32(1),t.copyInto32(1),t.copyInto32(3),t.copyInto32(6),t.guard();let i=t.readS32(0);for(let e=0;e<i;e++)t.copyInto32(2),t.allocate32(3);t.guard();let s=t.readS32(1);for(let e=0;e<s;e++)t.copyInto32(4),t.allocate32(2);t.guard();let n=t.readS32(2);for(let e=0;e<n;e++)t.copyInto32(4),t.allocate32(1);t.guard();let r=t.readS32(4);for(let e=0;e<r;e++)t.copyInto32(2),t.allocate32(3);t.guard();let a=t.readS32(3),o=t.index32;t.copyInto32(a),t.skip(4),t.copyInto32(a),t.skip(4),t.copyInto32(a),t.guard();let l,h,d=t.index32;t.allocate32(3*a),t.guard();for(let e=0;e<3;e++){l=0===e?i:1===e?s:n;for(let e=a-1;e>=0;e--)h=t.buffer32.getInt32(o+4*e,!0),t.buffer32.setInt32(d+4*e,l-h,!0),l=h;o+=a,d+=a}let c=t.readS32(5);for(let e=0;e<c;e++)t.copyInto16(4),t.copyInto32(3);t.guard();let u=t.readS32(6);t.copyInto32(3*u),t.guard();let m=t.readS32(7);t.copyInto32(m),t.guard();let p=t.readS32(8);t.copyInto32(2*p),t.guard();let g=t.readS32(9);for(let e=0;e<g;e++)t.copyInto32(4),t.allocate32(3);t.guard(),this.index=t.sourceIndex;let f=this.readS32(),y=[];for(let e=0;e<f;e++){let e=this.parseSequence();y.push(e)}t.sourceIndex=this.index;let b=t.readS32(10);for(let e=0;e<b;e++){let e=t.readS32();this.readAllocMesh(t,e)}t.guard();let v=t.readS32(12);for(let e=0;e<v;e++){let e=t.readS32(null);t.copyInto8(e),t.writeU8(0)}t.guard();let w=null;return this.index=t.sourceIndex,this.readS32()&&(w=this.parseMaterialList(e)),t.sourceIndex=this.index,t.allocate32(16),{bufferInfo:t.createBuffer(),sequences:y,materialList:w}}readAllocMesh(e,t){if(t===Pt.Null)return;e.guard(),e.copyInto32(2),e.writeS32(-1),e.allocate32(10);let i=e.readS32();e.copyInto32(3*i);let s=e.readS32();e.copyInto32(2*s);let n=e.readS32(null);e.copyInto32(3*n);let r=e.readS32();for(let t=0;t<r;t++)e.copyInto16(2),e.copyInto32(1);let a=e.readS32();if(e.copyInto16(a),e.writeS32(0),e.copyInto32(2),e.guard(),t===Pt.Skin){let t=e.readS32();e.copyInto32(3*t);let i=e.readS32(null);e.copyInto32(3*i);let s=e.readS32();e.copyInto32(16*s);let n=e.readS32();e.copyInto32(n);let r=e.readS32(null);e.copyInto32(r);let a=e.index32;e.allocate32(r);let o=e.readS32();e.copyInto32(o);let l=e.index32,h=e.readS32(null);e.index32=a,e.copyInto32(h),e.index32=l,e.guard()}}static async loadFile(e){if(await this.cachedFilePromises.get(e),this.cachedFiles.get(e))return this.cachedFiles.get(e);let t=(async()=>{let t=await ne.loadResource(e);if(!t)throw new Error("Missing DTS resource: "+e);let i=await ne.readBlobAsArrayBuffer(t),s=new Ft(i).parse();return this.cachedFiles.set(e,s),this.cachedFilePromises.delete(e),s})();return this.cachedFilePromises.set(e,t),t}}Ft.cachedFilePromises=new Map,Ft.cachedFiles=new Map;var zt,Dt,Ut=(function(e,t){e.haxe=e.haxe||{},e.haxe.io=e.haxe.io||{},e.math=e.math||{};var i,s=function(){return X.__string_rec(this,"")},n=n||{};class r{constructor(e,t){this.name=e,this.position=t}static read(e){return new r(e.readStr(),K.read(e))}}e.AISpecialNode=r,r.__name__=!0;class a{constructor(e,t,i,s,n){this.nameIndex=e,this.stateIndex=t,this.stateCount=i,this.flags=s,this.duration=n}static read(e){return new a(e.readInt32(),e.readInt32(),e.readInt16(),e.readInt16(),e.readInt32())}}e.AnimatedLight=a,a.__name__=!0;class o{constructor(e,t,i,s,n,r,a){this.planeIndex=e,this.frontIndex=t,this.backIndex=i,this.isFrontLeaf=s,this.isFrontSolid=n,this.isBackLeaf=r,this.isBackSolid=a}static read(e,t){let i,s,n=e.readUInt16(),r=!1,a=!1,l=!1,h=!1;return t.interiorVersion>=14?(i=e.readInt32(),s=e.readInt32(),0!=(524288&i)&&(i=-524289&i|32768,r=!0),0!=(262144&i)&&(i=-262145&i|16384,a=!0),0!=(524288&s)&&(s=-524289&s|32768,l=!0),0!=(262144&s)&&(s=-262145&s|16384,h=!0)):(i=e.readUInt16(),s=e.readUInt16(),0!=(32768&i)&&(r=!0),0!=(16384&i)&&(a=!0),0!=(32768&s)&&(l=!0),0!=(16384&s)&&(h=!0)),new o(n,i,s,r,a,l,h)}}e.BSPNode=o,o.__name__=!0;class l{constructor(e,t){this.surfaceStart=e,this.surfaceCount=t}static read(e){return new l(e.readInt32(),e.readInt16())}}e.BSPSolidLeaf=l,l.__name__=!0;class h{constructor(){this.hullStart=0,this.hullCount=0,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0,this.surfaceStart=0,this.surfaceCount=0,this.planeStart=0,this.polyListPlaneStart=0,this.polyListPointStart=0,this.polyListStringStart=0,this.staticMesh=!1}static read(e,t){let i=new h;return i.hullStart=e.readInt32(),i.hullCount=e.readUInt16(),i.minX=e.readFloat(),i.minY=e.readFloat(),i.minZ=e.readFloat(),i.maxX=e.readFloat(),i.maxY=e.readFloat(),i.maxZ=e.readFloat(),i.surfaceStart=e.readInt32(),i.surfaceCount=e.readUInt16(),i.planeStart=e.readInt32(),i.polyListPlaneStart=e.readInt32(),i.polyListPointStart=e.readInt32(),i.polyListStringStart=e.readInt32(),t.interiorVersion>=12&&(i.staticMesh=e.readByte()>0),i}}e.ConvexHull=h,h.__name__=!0;class d{constructor(){this.binStart=0,this.binCount=0}static read(e){let t=new d;return t.binStart=e.readInt32(),t.binCount=e.readInt32(),t}}e.CoordBin=d,d.__name__=!0;class c{constructor(){this.gameEntities=null,this.vehicleCollision=null}static LoadFromBuffer(e){let t=new H(e);return c.read(t)}static LoadFromArrayBuffer(e){let t=new H(j.ofData(e));return c.read(t)}static read(e){let t=new c,i=new F;return i.difVersion=e.readInt32(),t.difVersion=i.difVersion,t.previewIncluded=e.readByte(),t.interiors=_.readArray(e,function(e){return b.read(e,i)}),t.subObjects=_.readArray(e,function(e){return b.read(e,i)}),t.triggers=_.readArray(e,L.read),t.interiorPathfollowers=_.readArray(e,v.read),t.forceFields=_.readArray(e,g.read),t.aiSpecialNodes=_.readArray(e,r.read),1==e.readInt32()&&(t.vehicleCollision=R.read(e,i)),2==e.readInt32()&&(t.gameEntities=_.readArray(e,f.read)),t}}e.Dif=c,c.__name__=!0;class u{constructor(e,t,i,s){this.pointIndex0=e,this.pointIndex1=t,this.surfaceIndex0=i,this.surfaceIndex1=s}static read(e,t){return new u(e.readInt32(),e.readInt32(),e.readInt32(),e.readInt32())}}e.Edge=u,u.__name__=!0;class m{constructor(){this.vertex0=0,this.vertex1=0,this.normal0=0,this.normal1=0,this.face0=0,this.face1=0}static read(e,t){let i=new m;return i.vertex0=e.readInt32(),i.vertex1=e.readInt32(),i.normal0=e.readInt32(),i.normal1=e.readInt32(),t.interiorVersion>=3&&(i.face0=e.readInt32(),i.face1=e.readInt32()),i}}e.Edge2=m,m.__name__=!0;class p{constructor(){this.windingStart=0,this.windingCount=0,this.planeIndex=0,this.surfaceFlags=0,this.fanMask=0}static read(e){let t=new p;return t.windingStart=e.readInt32(),t.windingCount=e.readByte(),t.planeIndex=e.readInt16(),t.surfaceFlags=e.readByte(),t.fanMask=e.readInt32(),t}}e.FFSurface=p,p.__name__=!0;class g{constructor(){}static read(e){let t=new g;return t.forceFieldFileVersion=e.readInt32(),t.name=e.readStr(),t.triggers=_.readArray(e,function(e){return e.readStr()}),t.boundingBox=Y.read(e),t.boundingSphere=J.read(e),t.normals=_.readArray(e,K.read),t.planes=_.readArray(e,M.read),t.bspNodes=_.readArray(e,function(e){return o.read(e,new F)}),t.bspSolidLeaves=_.readArray(e,l.read),t.windings=_.readArray(e,function(e){return e.readInt32()}),t.surfaces=_.readArray(e,p.read),t.solidLeafSurfaces=_.readArray(e,function(e){return e.readInt32()}),t.color=_.readColorF(e),t}}e.ForceField=g,g.__name__=!0;class f{constructor(){this.datablock="",this.gameClass="",this.position=new K,this.properties=new q}static read(e){let t=new f;return t.datablock=e.readStr(),t.gameClass=e.readStr(),t.position=K.read(e),t.properties=_.readDictionary(e),t}}e.GameEntity=f,f.__name__=!0;class y{static cca(e,t){let i=e.charCodeAt(t);if(i==i)return i}static now(){return Date.now()}}y.__name__=!0;class b{constructor(){}static read(e,t){"?"==t.interiorType&&(t.interiorType="tgea"),t.interiorVersion=e.readInt32();let i=new b;i.detailLevel=e.readInt32(),i.minPixels=e.readInt32(),i.boundingBox=Y.read(e),i.boundingSphere=J.read(e),i.hasAlarmState=e.readByte(),i.numLightStateEntries=e.readInt32(),i.normals=_.readArray(e,K.read),i.planes=_.readArray(e,M.read),i.points=_.readArray(e,K.read),4==t.interiorVersion?i.pointVisibilities=[]:i.pointVisibilities=_.readArray(e,function(e){return e.readByte()}),i.texGenEQs=_.readArray(e,B.read),i.bspNodes=_.readArray(e,function(e){return o.read(e,t)}),i.bspSolidLeaves=_.readArray(e,l.read),i.materialListVersion=e.readByte(),i.materialList=_.readArray(e,function(e){return e.readStr()}),i.windings=_.readArrayAs(e,function(e,t){return t>0},function(e){return e.readInt32()},function(e){return e.readInt16()}),i.windingIndices=_.readArray(e,D.read),t.interiorVersion>=12&&(i.edges=_.readArray(e,function(e){return u.read(e,t)})),i.zones=_.readArray(e,function(e){return U.read(e,t)}),i.zoneSurfaces=_.readArrayAs(e,function(e,t){return!1},function(e){return e.readInt16()},function(e){return e.readInt16()}),t.interiorVersion>=12&&(i.zoneStaticMeshes=_.readArray(e,function(e){return e.readInt32()})),i.zonePortalList=_.readArrayAs(e,function(e,t){return!1},function(e){return e.readInt16()},function(e){return e.readInt16()}),i.portals=_.readArray(e,A.read);let s=e.tell();try{i.surfaces=_.readArray(e,function(e){return E.read(e,t,i)}),"?"==t.interiorType&&(t.interiorType="tge")}catch(n){"tgea"==t.interiorType&&(t.interiorType="tge"),e.seek(s);try{i.surfaces=_.readArray(e,function(e){return E.read(e,t,i)})}catch(n){t.useLargeLightmaps=!0,e.seek(s);try{i.surfaces=_.readArray(e,function(e){return E.read(e,t,i)})}catch(n){let e=V.caught(n);throw V.thrown(e)}}}t.interiorVersion>=2&&t.interiorVersion<=5&&(i.edges2=_.readArray(e,function(e){return m.read(e,t)}),t.interiorVersion>=4&&t.interiorVersion<=5&&(i.normals2=_.readArray(e,K.read),i.normalIndices=_.readArrayAs(e,function(e,t){return!!e&&0==t},function(e){return e.readUInt16()},function(e){return e.readByte()}))),4==t.interiorVersion?(i.normalLMapIndices=_.readArray(e,function(e){return e.readByte()}),i.alarmLMapIndices=[]):t.interiorVersion>=13?(i.normalLMapIndices=_.readArray(e,function(e){return e.readInt32()}),i.alarmLMapIndices=_.readArray(e,function(e){return e.readInt32()})):(i.normalLMapIndices=_.readArray(e,function(e){return e.readByte()}),i.alarmLMapIndices=_.readArray(e,function(e){return e.readByte()})),i.nullSurfaces=_.readArray(e,function(e){return T.read(e,t)}),4!=t.interiorVersion?(i.lightMaps=_.readArray(e,function(e){return w.read(e,t)}),i.lightMaps.length>0&&"mbg"==t.interiorType&&(t.interiorType="tge")):i.lightMaps=[],i.solidLeafSurfaces=_.readArrayAs(e,function(e,t){return e},function(e){return e.readInt32()},function(e){return e.readUInt16()}),i.animatedLights=_.readArray(e,a.read),i.lightStates=_.readArray(e,x.read),4==t.interiorVersion?(i.stateDatas=[],i.stateDataFlags=0,i.stateDataBuffers=[],i.subObjects=[]):(i.stateDatas=_.readArray(e,I.read),i.stateDataBuffers=_.readArrayFlags(e,function(e){return e.readByte()}),i.nameBuffer=_.readArray(e,function(e){return e.readByte()}),i.stateDataFlags=0,i.subObjects=_.readArray(e,function(e){if(1==e.readInt32())return S.read(e,t);throw new V("Unknown SubObject key: ")})),i.convexHulls=_.readArray(e,function(e){return h.read(e,t)}),i.convexHullEmitStrings=_.readArray(e,function(e){return e.readByte()}),0==t.interiorVersion?i.hullIndices=_.readArray(e,function(e){return e.readInt32()}):i.hullIndices=_.readArrayAs(e,function(e,t){return e},function(e){return e.readInt32()},function(e){return e.readUInt16()}),0==t.interiorVersion?i.hullPlaneIndices=_.readArray(e,function(e){return e.readUInt16()}):i.hullPlaneIndices=_.readArrayAs(e,function(e,t){return!0},function(e){return e.readInt32()},function(e){return e.readUInt16()}),0==t.interiorVersion?i.hullEmitStringIndices=_.readArray(e,function(e){return e.readInt32()}):i.hullEmitStringIndices=_.readArrayAs(e,function(e,t){return e},function(e){return e.readInt32()},function(e){return e.readUInt16()}),0==t.interiorVersion?i.hullSurfaceIndices=_.readArray(e,function(e){return e.readInt32()}):i.hullSurfaceIndices=_.readArrayAs(e,function(e,t){return e},function(e){return e.readInt32()},function(e){return e.readUInt16()}),0==t.interiorVersion?i.polyListPlanes=_.readArray(e,function(e){return e.readUInt16()}):i.polyListPlanes=_.readArrayAs(e,function(e,t){return!0},function(e){return e.readInt32()},function(e){return e.readUInt16()}),0==t.interiorVersion?i.polyListPoints=_.readArray(e,function(e){return e.readInt32()}):i.polyListPoints=_.readArrayAs(e,function(e,t){return e},function(e){return e.readInt32()},function(e){return e.readUInt16()}),i.polyListStrings=_.readArray(e,function(e){return e.readByte()}),i.coordBins=[];let n=0;for(;n<256;)n++,i.coordBins.push(d.read(e));return i.coordBinIndices=_.readArrayAs(e,function(e,t){return!0},function(e){return e.readUInt16()},function(e){return e.readUInt16()}),i.coordBinMode=e.readInt32(),4==t.interiorVersion?(i.baseAmbientColor=[0,0,0,255],i.alarmAmbientColor=[0,0,0,255],i.extendedLightMapData=0,i.lightMapBorderSize=0):(i.baseAmbientColor=_.readColorF(e),i.alarmAmbientColor=_.readColorF(e),t.interiorVersion>=10&&(i.numStaticMeshes=e.readInt32()),t.interiorVersion>=11?(i.texNormals=_.readArray(e,K.read),i.texMatrices=_.readArray(e,P.read),i.texMatIndices=_.readArray(e,function(e){return e.readInt32()})):(e.readInt32(),e.readInt32(),e.readInt32()),i.extendedLightMapData=e.readInt32(),i.extendedLightMapData>0&&(i.lightMapBorderSize=e.readInt32(),e.readInt32())),i}}e.Interior=b,b.__name__=!0;class v{constructor(){this.name="",this.datablock="",this.interiorResIndex=0,this.offset=new K,this.properties=new q,this.triggerId=[],this.wayPoint=[],this.totalMS=0}static read(e){let t=new v;return t.name=e.readStr(),t.datablock=e.readStr(),t.interiorResIndex=e.readInt32(),t.offset=K.read(e),t.properties=_.readDictionary(e),t.triggerId=_.readArray(e,function(e){return e.readInt32()}),t.wayPoint=_.readArray(e,z.read),t.totalMS=e.readInt32(),t}}e.InteriorPathFollower=v,v.__name__=!0;class w{constructor(){this.lightmap=[],this.lightdirmap=[],this.keepLightMap=0}static read(e,t){let i=new w;return i.lightmap=_.readPNG(e),"mbg"!=t.interiorType&&"tge"!=t.interiorType&&(i.lightdirmap=_.readPNG(e)),i.keepLightMap=e.readByte(),i}}e.LightMap=w,w.__name__=!0;class x{constructor(e,t,i,s,n,r){this.red=e,this.green=t,this.blue=i,this.activeTime=s,this.dataIndex=n,this.dataCount=r}static read(e){return new x(e.readByte(),e.readByte(),e.readByte(),e.readInt32(),e.readInt32(),e.readInt16())}}e.LightState=x,x.__name__=!0,Math.__name__=!0;class S{constructor(){this.detailLevel=0,this.zone=0,this.alphaLevel=0,this.surfaceCount=0,this.surfaceStart=0,this.centroid=new K}static read(e,t){let i=new S;return i.detailLevel=e.readInt32(),i.zone=e.readInt32(),i.alphaLevel=e.readFloat(),i.surfaceCount=e.readInt32(),i.surfaceStart=e.readInt32(),i.centroid=K.read(e),i}}e.MirrorSubObject=S,S.__name__=!0;class T{constructor(){this.windingStart=0,this.planeIndex=0,this.surfaceFlags=0,this.windingCount=0}static read(e,t){let i=new T;return i.windingStart=e.readInt32(),i.planeIndex=e.readUInt16(),i.surfaceFlags=e.readByte(),t.interiorVersion>=13?i.windingCount=e.readInt32():i.windingCount=e.readByte(),i}}e.NullSurface=T,T.__name__=!0;class M{constructor(e,t){this.normalIndex=e,this.planeDistance=t}static read(e){return new M(e.readInt16(),e.readFloat())}}e.Plane=M,M.__name__=!0;class C{constructor(){this.pointList=[],this.planeList=[],this.edgeList=[]}static read(e){let t=new C;return t.pointList=_.readArray(e,K.read),t.planeList=_.readArray(e,Q.read),t.edgeList=_.readArray(e,k.read),t}}e.Polyhedron=C,C.__name__=!0;class k{constructor(e,t,i,s){this.pointIndex0=i,this.pointIndex1=s,this.faceIndex0=e,this.faceIndex1=t}static read(e){return new k(e.readInt32(),e.readInt32(),e.readInt32(),e.readInt32())}}e.PolyhedronEdge=k,k.__name__=!0;class A{constructor(e,t,i,s,n){this.planeIndex=e,this.triFanCount=t,this.triFanStart=i,this.zoneFront=s,this.zoneBack=n}static read(e){return new A(e.readUInt16(),e.readUInt16(),e.readInt32(),e.readUInt16(),e.readUInt16())}}e.Portal=A,A.__name__=!0;class _{static readDictionary(e){let t=e.readInt32(),i=new q,s=0,n=t;for(;s<n;){s++;let t=e.readStr(),n=e.readStr();i.h[t]=n}return i}static readArray(e,t){let i=[],s=0,n=e.readInt32();for(;s<n;)s++,i.push(t(e));return i}static readArrayAs(e,t,i,s){let n=e.readInt32(),r=!1,a=0;-2147483648==(-2147483648&n)&&(n^=-2147483648,r=!0,a=e.readByte());let o=[],l=0,h=n;for(;l<h;)l++,t(r,a)?o.push(s(e)):o.push(i(e));return o}static readArrayFlags(e,t){let i=e.readInt32(),s=(e.readInt32(),[]),n=0,r=i;for(;n<r;)n++,s.push(t(e));return s}static readPNG(e){let t=[73,69,78,68,174,66,96,130],i=[];for(;;)if(i.push(e.readByte()),i.length>=8){let e=!0,s=0;for(;s<8;){let n=s++;if(i[n+(i.length-8)]!=t[n]){e=!1;break}}if(e)break}return i}static readColorF(e){return[e.readByte(),e.readByte(),e.readByte(),e.readByte()]}}_.__name__=!0;class I{constructor(e,t,i){this.surfaceIndex=e,this.mapIndex=t,this.lightStateIndex=i}static read(e){return new I(e.readInt32(),e.readInt32(),e.readInt16())}}e.StateData=I,I.__name__=!0;class E{constructor(){this.windingStart=0,this.windingCount=0,this.planeIndex=0,this.textureIndex=0,this.texGenIndex=0,this.surfaceFlags=0,this.fanMask=0,this.lightMapFinalWord=0,this.lightMapTexGenXD=0,this.lightMapTexGenYD=0,this.lightCount=0,this.lightStateInfoStart=0,this.mapOffsetX=0,this.mapOffsetY=0,this.mapSizeX=0,this.mapSizeY=0,this.brushId=0}static read(e,t,i){let s=new E;if(s.windingStart=e.readInt32(),i.windings.length<=s.windingStart)throw new V("DIF Type Error interior.windings.length <= ret.windingStart");if(t.interiorVersion>=13?s.windingCount=e.readInt32():s.windingCount=e.readByte(),s.windingStart+s.windingCount>i.windings.length)throw new V("DIF Type Error ret.windingStart + ret.windingCount > interior.windings.length");let n=e.readInt16();s.planeFlipped=n>>15!=0;let r=-32769&n;if((-32769&r)>=i.planes.length)throw new V("DIF Type Error (planeIndexTemp & ~0x8000) >= interior.planes.length");if(s.planeIndex=r,s.textureIndex=e.readInt16(),s.textureIndex>=i.materialList.length)throw new V("DIF Type Error ret.textureIndex >= interior.materialList.length");if(s.texGenIndex=e.readInt32(),s.texGenIndex>=i.texGenEQs.length)throw new V("DIF Type Error ret.texGenIndex >= interior.texGenEQs.length");return s.surfaceFlags=e.readByte(),s.fanMask=e.readInt32(),s.lightMapFinalWord=e.readInt16(),s.lightMapTexGenXD=e.readFloat(),s.lightMapTexGenYD=e.readFloat(),s.lightCount=e.readInt16(),s.lightStateInfoStart=e.readInt32(),t.interiorVersion>=13?(s.mapOffsetX=e.readInt32(),s.mapOffsetY=e.readInt32(),s.mapSizeX=e.readInt32(),s.mapSizeY=e.readInt32()):0==t.interiorVersion&&"tge"==t.interiorType&&t.useLargeLightmaps?(s.mapOffsetX=e.readUInt16(),s.mapOffsetY=e.readUInt16(),s.mapSizeX=e.readUInt16(),s.mapSizeY=e.readUInt16()):(s.mapOffsetX=e.readByte(),s.mapOffsetY=e.readByte(),s.mapSizeX=e.readByte(),s.mapSizeY=e.readByte()),"tge"!=t.interiorType&&"mbg"!=t.interiorType&&(e.readByte(),t.interiorVersion>=2&&t.interiorVersion<=5&&(s.brushId=e.readInt32())),s}}e.Surface=E,E.__name__=!0;class B{constructor(){this.planeX=new Q,this.planeY=new Q}static read(e){let t=new B;return t.planeX=Q.read(e),t.planeY=Q.read(e),t}}e.TexGenEQ=B,B.__name__=!0;class P{constructor(){this.t=0,this.n=0,this.b=0}static read(e){let t=new P;return t.t=e.readInt32(),t.n=e.readInt32(),t.b=e.readInt32(),t}}e.TexMatrix=P,P.__name__=!0;class L{constructor(){this.name="",this.datablock="",this.offset=new K,this.properties=new q,this.polyhedron=new C}static read(e){let t=new L;return t.name=e.readStr(),t.datablock=e.readStr(),t.properties=_.readDictionary(e),t.polyhedron=C.read(e),t.offset=K.read(e),t}}e.Trigger=L,L.__name__=!0;class R{constructor(){}static read(e,t){let i=new R;return i.vehicleCollisionFileVersion=e.readInt32(),i.convexHulls=_.readArray(e,function(e){return h.read(e,t)}),i.convexHullEmitStrings=_.readArray(e,function(e){return e.readByte()}),i.hullIndices=_.readArray(e,function(e){return e.readInt32()}),i.hullPlaneIndices=_.readArray(e,function(e){return e.readInt16()}),i.hullEmitStringIndices=_.readArray(e,function(e){return e.readInt32()}),i.hullSurfaceIndices=_.readArray(e,function(e){return e.readInt32()}),i.polyListPlanes=_.readArray(e,function(e){return e.readInt16()}),i.polyListPoints=_.readArray(e,function(e){return e.readInt32()}),i.polyListStrings=_.readArray(e,function(e){return e.readByte()}),i.nullSurfaces=_.readArray(e,function(e){return T.read(e,new F)}),i.points=_.readArray(e,K.read),i.planes=_.readArray(e,M.read),i.windings=_.readArray(e,function(e){return e.readInt32()}),i.windingIndices=_.readArray(e,D.read),i}}e.VehicleCollision=R,R.__name__=!0;class F{constructor(){this.difVersion=44,this.interiorVersion=0,this.interiorType="?",this.useLargeLightmaps=!1}}e.Version=F,F.__name__=!0;class z{constructor(e,t,i,s){this.position=e,this.rotation=t,this.msToNext=i,this.smoothingType=s}static read(e){return new z(K.read(e),Z.read(e),e.readInt32(),e.readInt32())}}e.WayPoint=z,z.__name__=!0;class D{constructor(e,t){this.windingStart=e,this.windingCount=t}static read(e){return new D(e.readInt32(),e.readInt32())}}e.WindingIndex=D,D.__name__=!0;class U{constructor(){this.portalStart=0,this.portalCount=0,this.surfaceStart=0,this.surfaceCount=0,this.staticMeshStart=0,this.staticMeshCount=0,this.flags=0}static read(e,t){let i=new U;return i.portalStart=e.readUInt16(),i.portalCount=e.readUInt16(),i.surfaceStart=e.readInt32(),"tgea"!=t.interiorType&&"tge"!=t.interiorType||!(t.interiorVersion>=14||0==t.interiorVersion)?i.surfaceCount=e.readInt32():i.surfaceCount=e.readUInt16(),t.interiorVersion>=12&&(i.staticMeshStart=e.readInt32(),i.staticMeshCount=e.readInt32()),"tgea"!=t.interiorType&&"tge"!=t.interiorType||(t.interiorVersion>=14||0==t.interiorVersion)&&(i.flags=e.readUInt16()),i}}e.Zone=U,U.__name__=!0;class V extends Error{constructor(e,t,i){super(e),this.message=e,this.__previousException=t,this.__nativeException=null!=i?i:this}toString(){return this.get_message()}get_message(){return this.message}get_native(){return this.__nativeException}static caught(e){return e instanceof V?e:e instanceof Error?new V(e.message,null,e):new N(e,null,e)}static thrown(e){return e instanceof V?e.get_native():e instanceof Error?e:new N(e)}}V.__name__=!0;class O{constructor(e,t){this.high=e,this.low=t}}O.__name__=!0;class N extends V{constructor(e,t,i){super(String(e),t,i),this.value=e}}N.__name__=!0;class q{constructor(){this.h=Object.create(null)}}q.__name__=!0;class j{constructor(e){this.length=e.byteLength,this.b=new Uint8Array(e),this.b.bufferValue=e,e.hxBytes=this,e.bytes=this.b}get(e){return this.b[e]}set(e,t){this.b[e]=t}blit(e,t,i,s){if(e<0||i<0||s<0||e+s>this.length||i+s>t.length)throw V.thrown(W.OutsideBounds);0==i&&s==t.b.byteLength?this.b.set(t.b,e):this.b.set(t.b.subarray(i,i+s),e)}fill(e,t,i){let s=0,n=t;for(;s<n;)s++,this.b[e++]=i}sub(e,t){if(e<0||t<0||e+t>this.length)throw V.thrown(W.OutsideBounds);return new j(this.b.buffer.slice(e+this.b.byteOffset,e+this.b.byteOffset+t))}compare(e){let t=this.b,i=e.b,s=0,n=this.length<e.length?this.length:e.length;for(;s<n;){let e=s++;if(t[e]!=i[e])return t[e]-i[e]}return this.length-e.length}initData(){null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength))}getDouble(e){return null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.getFloat64(e,!0)}getFloat(e){return null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.getFloat32(e,!0)}setDouble(e,t){null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.setFloat64(e,t,!0)}setFloat(e,t){null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.setFloat32(e,t,!0)}getUInt16(e){return null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.getUint16(e,!0)}setUInt16(e,t){null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.setUint16(e,t,!0)}getInt32(e){return null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.getInt32(e,!0)}setInt32(e,t){null==this.data&&(this.data=new DataView(this.b.buffer,this.b.byteOffset,this.b.byteLength)),this.data.setInt32(e,t,!0)}getInt64(e){return new O(this.getInt32(e+4),this.getInt32(e))}setInt64(e,t){this.setInt32(e,t.low),this.setInt32(e+4,t.high)}getString(e,t,i){if(e<0||t<0||e+t>this.length)throw V.thrown(W.OutsideBounds);null==i&&(i=G.UTF8);let s="",n=this.b,r=e,a=e+t;switch(i._hx_index){case 0:for(;r<a;){let e=n[r++];if(e<128){if(0==e)break;s+=String.fromCodePoint(e)}else if(e<224){let t=(63&e)<<6|127&n[r++];s+=String.fromCodePoint(t)}else if(e<240){let t=(31&e)<<12|(127&n[r++])<<6|127&n[r++];s+=String.fromCodePoint(t)}else{let t=(15&e)<<18|(127&n[r++])<<12|(127&n[r++])<<6|127&n[r++];s+=String.fromCodePoint(t)}}break;case 1:for(;r<a;){let e=n[r++]|n[r++]<<8;s+=String.fromCodePoint(e)}}return s}readString(e,t){return this.getString(e,t)}toString(){return this.getString(0,this.length)}toHex(){let e="",t=[],i="0123456789abcdef",s=0,n=i.length;for(;s<n;){let e=s++;t.push(y.cca(i,e))}let r=0,a=this.length;for(;r<a;){let i=r++,s=this.b[i];e+=String.fromCodePoint(t[s>>4]),e+=String.fromCodePoint(t[15&s])}return e}getData(){return this.b.bufferValue}static alloc(e){return new j(new ArrayBuffer(e))}static ofString(e,t){if(t==G.RawNative){let t=new Uint8Array(e.length<<1),i=0,s=e.length;for(;i<s;){let s=i++,n=e.charCodeAt(s);t[s<<1]=255&n,t[s<<1|1]=n>>8}return new j(t.buffer)}let i=[],s=0;for(;s<e.length;){let t=e.charCodeAt(s++);55296<=t&&t<=56319&&(t=t-55232<<10|1023&e.charCodeAt(s++)),t<=127?i.push(t):t<=2047?(i.push(192|t>>6),i.push(128|63&t)):t<=65535?(i.push(224|t>>12),i.push(128|t>>6&63),i.push(128|63&t)):(i.push(240|t>>18),i.push(128|t>>12&63),i.push(128|t>>6&63),i.push(128|63&t))}return new j(new Uint8Array(i).buffer)}static ofData(e){let t=e.hxBytes;return null!=t?t:new j(e)}static ofHex(e){if(0!=(1&e.length))throw V.thrown("Not a hex string (odd number of digits)");let t=[],i=0,s=e.length>>1;for(;i<s;){let s=e.charCodeAt(2*i),n=e.charCodeAt(2*i+1);s=(15&s)+9*((64&s)>>6),n=(15&n)+9*((64&n)>>6),t.push(255&(s<<4|n)),++i}return new j(new Uint8Array(t).buffer)}static fastGet(e,t){return e.bytes[t]}}e.haxe.io.Bytes=j,j.__name__=!0;var G=n["haxe.io.Encoding"]={__ename__:!0,__constructs__:null,UTF8:{_hx_name:"UTF8",_hx_index:0,__enum__:"haxe.io.Encoding",toString:s},RawNative:{_hx_name:"RawNative",_hx_index:1,__enum__:"haxe.io.Encoding",toString:s}};G.__constructs__=[G.UTF8,G.RawNative];var W=n["haxe.io.Error"]={__ename__:!0,__constructs__:null,Blocked:{_hx_name:"Blocked",_hx_index:0,__enum__:"haxe.io.Error",toString:s},Overflow:{_hx_name:"Overflow",_hx_index:1,__enum__:"haxe.io.Error",toString:s},OutsideBounds:{_hx_name:"OutsideBounds",_hx_index:2,__enum__:"haxe.io.Error",toString:s},Custom:(i=function(e){return{_hx_index:3,e:e,__enum__:"haxe.io.Error",toString:s}},i._hx_name="Custom",i.__params__=["e"],i)};W.__constructs__=[W.Blocked,W.Overflow,W.OutsideBounds,W.Custom];class H{constructor(e){this.bytes=e,this.position=0}readInt32(){let e=this.bytes.getInt32(this.position);return this.position+=4,e}readInt16(){let e=this.bytes.getUInt16(this.position);return this.position+=2,e}readUInt16(){let e=this.bytes.getUInt16(this.position);return this.position+=2,e}readByte(){let e=this.bytes.b[this.position];return this.position+=1,e}readStr(){let e="",t=!0,i=0,s=this.readByte();for(;i<s;){i++;let s=this.readByte();0==s&&(t=!1),t&&(e+=String.fromCodePoint(s))}return e}readFloat(){let e=this.bytes.getFloat(this.position);return this.position+=4,e}tell(){return this.position}seek(e){this.position=e}}H.__name__=!0;class X{static __string_rec(e,t){if(null==e)return"null";if(t.length>=5)return"<...>";let i=typeof e;switch("function"==i&&(e.__name__||e.__ename__)&&(i="object"),i){case"function":return"<function>";case"object":if(e.__enum__){let i=n[e.__enum__].__constructs__[e._hx_index],s=i._hx_name;return i.__params__?(t+="\t",s+"("+function(s){let n=[];{let s=0,r=i.__params__;for(;s<r.length;){let i=r[s];s+=1,n.push(X.__string_rec(e[i],t))}}return n}().join(",")+")"):s}if(e instanceof Array){let i="[";t+="\t";let s=0,n=e.length;for(;s<n;){let n=s++;i+=(n>0?",":"")+X.__string_rec(e[n],t)}return i+="]"}let s;try{s=e.toString}catch(e){return"???"}if(null!=s&&s!=Object.toString&&"function"==typeof s){let t=e.toString();if("[object Object]"!=t)return t}let r="{\n";t+="\t";let a=null!=e.hasOwnProperty,o=null;for(o in e)a&&!e.hasOwnProperty(o)||"prototype"!=o&&"__class__"!=o&&"__super__"!=o&&"__interfaces__"!=o&&"__properties__"!=o&&(2!=r.length&&(r+=", \n"),r+=t+o+" : "+X.__string_rec(e[o],t));return r+="\n"+(t=t.substring(1))+"}";case"string":return e;default:return String(e)}}}X.__name__=!0;class Y{constructor(e,t,i,s,n,r){null==r&&(r=0),null==n&&(n=0),null==s&&(s=0),null==i&&(i=0),null==t&&(t=0),null==e&&(e=0),this.minX=e,this.minY=t,this.minZ=i,this.maxX=s,this.maxY=n,this.maxZ=r}clone(){return new Y(this.minX,this.minY,this.minZ,this.maxX,this.maxY,this.maxZ)}center(){return new K(this.minX+this.maxX,this.minY+this.maxY,this.minZ+this.maxZ).scalarDiv(2)}extend(e){this.minX=Math.min(this.minX,e.minX),this.minY=Math.min(this.minY,e.minY),this.minZ=Math.min(this.minZ,e.minZ),this.maxX=Math.max(this.maxX,e.maxX),this.maxY=Math.max(this.maxY,e.maxY),this.maxZ=Math.max(this.maxZ,e.maxZ)}Expand(e){this.minX>e.x&&(this.minX=e.x),this.minY>e.y&&(this.minY=e.y),this.minZ>e.z&&(this.minZ=e.z),this.maxX<e.x&&(this.maxX=e.x),this.maxY<e.y&&(this.maxY=e.y),this.maxZ<e.z&&(this.maxZ=e.z)}contains(e){return this.minX<=e.x&&e.x<=this.maxX&&this.minY<=e.y&&e.y<=this.maxY&&this.minZ<=e.z&&e.z<=this.maxZ}getClosestPoint(e){let t=new K;return this.minX>e.x?t.x=this.minX:this.maxX<e.x?t.x=this.maxX:t.x=e.x,this.minY>e.y?t.y=this.minY:this.maxY<e.y?t.y=this.maxY:t.y=e.y,this.minZ>e.z?t.z=this.minZ:this.maxZ<e.z?t.z=this.maxZ:t.z=e.z,t}static PointBounds(e,t){let i=new Y;return i.minX=e.x,i.minY=e.y,i.minZ=e.z,i.maxX=e.x+t.x,i.maxY=e.y+t.y,i.maxZ=e.z+t.z,i}static read(e){let t=new Y;return t.minX=e.readFloat(),t.minY=e.readFloat(),t.minZ=e.readFloat(),t.maxX=e.readFloat(),t.maxY=e.readFloat(),t.maxZ=e.readFloat(),t}}e.math.Box3F=Y,Y.__name__=!0;class Q{constructor(e,t,i,s){null==s&&(s=0),null==i&&(i=0),null==t&&(t=0),null==e&&(e=0),this.x=e,this.y=t,this.z=i,this.d=s}static ThreePoints(e,t,i){let s=e.sub(t),n=i.sub(t),r=s.cross(n),a=new Q,o=r.normalized();return a.x=o.x,a.y=o.y,a.z=o.z,a.d=-t.dot(o),a}static NormalD(e,t){let i=new Q;return i.x=e.x,i.y=e.y,i.z=e.z,i.d=t,i}static PointNormal(e,t){let i=new Q,s=t.normalized();return i.x=s.x,i.y=s.y,i.z=s.z,i.d=-e.dot(s),i}static read(e){let t=new Q;return t.x=e.readFloat(),t.y=e.readFloat(),t.z=e.readFloat(),t.d=e.readFloat(),t}}e.math.PlaneF=Q,Q.__name__=!0;class K{constructor(e,t,i){null==i&&(i=0),null==t&&(t=0),null==e&&(e=0),this.x=e,this.y=t,this.z=i}get(e){return 0==e?this.x:1==e?this.y:2==e?this.z:-1}set(e,t){0==e&&(this.x=t),1==e&&(this.y=t),2==e&&(this.z=t)}add(e){return new K(this.x+e.x,this.y+e.y,this.z+e.z)}sub(e){return new K(this.x-e.x,this.y-e.y,this.z-e.z)}scalar(e){return new K(this.x*e,this.y*e,this.z*e)}scalarDiv(e){return new K(this.x/e,this.y/e,this.z/e)}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){return new K(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}normalized(){return 0!=this.length()?this.scalarDiv(this.length()):this}equal(e){return this.x==e.x&&this.y==e.y&&this.z==e.z}copy(){return new K(this.x,this.y,this.z)}static read(e){let t=new K;return t.x=e.readFloat(),t.y=e.readFloat(),t.z=e.readFloat(),t}}e.math.Point3F=K,K.__name__=!0;class ${constructor(){this.x=0,this.y=0,this.z=0,this.w=0}static read(e){let t=new $;return t.x=e.readFloat(),t.y=e.readFloat(),t.z=e.readFloat(),t.w=e.readFloat(),t}}e.math.Point4F=$,$.__name__=!0;class Z{constructor(){this.x=0,this.y=0,this.z=0,this.w=0}static read(e){let t=new Z;return t.x=e.readFloat(),t.y=e.readFloat(),t.z=e.readFloat(),t.w=e.readFloat(),t}}e.math.QuatF=Z,Z.__name__=!0;class J{constructor(){this.originX=0,this.originY=0,this.originZ=0,this.radius=0}static read(e){let t=new J;return t.originX=e.readFloat(),t.originY=e.readFloat(),t.originZ=e.readFloat(),t.radius=e.readFloat(),t}}e.math.Spheref=J,J.__name__=!0,"undefined"!=typeof performance&&"function"==typeof performance.now&&(y.now=performance.now.bind(performance)),null==String.fromCodePoint&&(String.fromCodePoint=function(e){return e<65536?String.fromCharCode(e):String.fromCharCode(55232+(e>>10))+String.fromCharCode(56320+(1023&e))}),String.__name__=!0,Array.__name__=!0,X.__toStr={}.toString}((Dt={path:zt,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}((void 0===t||null===t)&&Dt.path)}}).exports),Dt.exports);class Vt{constructor(e,t){this.qualifyTime=1/0,this.goldTime=-1/0,this.ultimateTime=-1/0,this.type="custom",this.zipDirectory=null,this.fileToBlobPromises=new Map,this.difCachePromises=new Map,this.difCache=new Map,this.isNew=!1,this.createdAt=0,this.hasEasterEgg=!1,this.hasBlast=!1,this.hasUltraMarble=!1,this.path=e,this.misFile=t,t&&(this.root=t.root,this.initAllElements())}static fromMisFile(e,t){var i,s;let n=new Vt(e,t),r=n.allElements.find(e=>e._type===vt.ScriptObject&&"MissionInfo"===e._name);return n.missionInfo=r,n.title=r.name,n.artist=null!==(i=r.artist)&&void 0!==i?i:"",n.description=null!==(s=r.desc)&&void 0!==s?s:"",r.time&&"0"!==r.time&&(n.qualifyTime=It.parseNumber(r.time)),r.goldtime&&(n.goldTime=It.parseNumber(r.goldtime)),r.platinumtime&&(n.goldTime=It.parseNumber(r.platinumtime)),r.ultimatetime&&(n.ultimateTime=It.parseNumber(r.ultimatetime)),n.type=r.type.toLowerCase(),n.modification=e.startsWith("mbp/")?"platinum":e.startsWith("mbu/")?"ultra":"gold",n.hasEasterEgg=n.allElements.some(e=>{var t;return e._type===vt.Item&&"easteregg"===(null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase())}),n.setUltraFlags(),n}static fromCustomLevelInfo(e,t){var i,s;let n="custom/"+e.id;"platinum"===e.modification&&(n="mbp/"+n),"ultra"===e.modification&&(n="mbu/"+n);let r=new Vt(n);return r.title=e.name.trim(),r.artist=null!==(i=e.artist)&&void 0!==i?i:"",r.description=null!==(s=e.desc)&&void 0!==s?s:"",e.qualifyingTime&&(r.qualifyTime=e.qualifyingTime),e.goldTime&&(r.goldTime=e.goldTime),e.platinumTime&&(r.goldTime=e.platinumTime),e.ultimateTime&&(r.ultimateTime=e.ultimateTime),r.id=e.id,r.isNew=t,r.createdAt=e.addedAt,r.modification=e.modification,r.hasEasterEgg=e.hasEasterEgg,r}initAllElements(){this.allElements=[];const e=t=>{for(let i of t.elements)this.allElements.push(i),i._type===vt.SimGroup&&e(i)};e(this.root)}initSearchString(){this.searchString=I.removeSpecialCharacters(I.normalizeString(this.title+" "+this.artist)).toLowerCase().trim()}async load(){if(this.misFile)return;if("custom"!==this.type)return;let e=await ne.loadResource(`./api/custom/${this.id}.zip`),t=await ne.readBlobAsArrayBuffer(e),i=await JSZip.loadAsync(t);this.zipDirectory=i;for(let e in i.files){let t=i.files[e];delete i.files[e],i.files[e.toLowerCase()]=t,i.files[e.toLowerCase().replace("data/","data_mbp/")]=t,"gold"===this.modification&&e.includes("interiors_mbg/")&&(i.files[e.replace("interiors_mbg/","interiors/")]=t)}let s=Object.keys(i.files).find(e=>e.endsWith(".mis")),n=await ne.readBlobAsText(await i.files[s].async("blob"),"ISO-8859-1"),r=new It(n).parse();this.misFile=r,this.root=r.root,this.initAllElements();let a=this.allElements.find(e=>e._type===vt.ScriptObject&&"MissionInfo"===e._name);(null===a||void 0===a?void 0:a.time)&&(this.qualifyTime=It.parseNumber(a.time),this.qualifyTime||(this.qualifyTime=1/0)),(null===a||void 0===a?void 0:a.goldtime)&&(this.goldTime=It.parseNumber(a.goldtime),(null===a||void 0===a?void 0:a.platinumtime)&&(this.goldTime=It.parseNumber(a.platinumtime)),this.goldTime||(this.goldTime=-1/0)),(null===a||void 0===a?void 0:a.ultimatetime)&&(this.ultimateTime=It.parseNumber(a.ultimatetime),this.ultimateTime||(this.ultimateTime=-1/0)),this.missionInfo=a,this.setUltraFlags()}setUltraFlags(){var e,t;It.parseBoolean(this.missionInfo.noblast)||!It.parseBoolean(this.missionInfo.blast)&&"ultra"!==(null===(e=this.missionInfo.game)||void 0===e?void 0:e.toLowerCase())||(this.hasBlast=!0),("ultra"===(null===(t=this.missionInfo.game)||void 0===t?void 0:t.toLowerCase())||It.parseBoolean(this.missionInfo.useultramarble))&&(this.hasUltraMarble=!0)}getDirectoryMissionPath(){return"gold"===this.modification?"missions/"+this.path:"ultra"===this.modification?"missions_mbu/"+this.path.slice(4):"platinum"===this.modification?"missions_mbp/"+this.path.slice(4):void 0}getImagePath(){if("custom"!==this.type){let t=this.getDirectoryMissionPath();"gold"!==e.modification&&(t=t.replace("missions/","missions_mbg/"));let i,s=t.slice(0,-4),n=ne.getFullNamesOf(s,"gold"!==e.modification);for(let e of n)if(!e.endsWith(".mis")){i=e;break}let r=t.slice(0,t.lastIndexOf("/")+1)+i;return"gold"===e.modification?"./assets/data/"+r:"./assets/data_mbp/"+r}return`./api/custom/${this.id}.jpg`}async getDif(e){let t=(e=e.toLowerCase()).slice(e.indexOf("data/"));"gold"===this.modification&&t.includes("interiors_mbg/")&&(t=t.replace("interiors_mbg/","interiors/")),"gold"!==this.modification&&(t=t.replace("data/","data_mbp/"));let i=null;if(await this.difCachePromises.get(t),this.difCache.get(t))i=this.difCache.get(t);else{let e=(async()=>{let e;if(this.zipDirectory&&this.zipDirectory.files[t]){let i=await this.zipDirectory.files[t].async("arraybuffer");e=Ut.Dif.LoadFromArrayBuffer(i)}else{let i=await ne.loadResource("./assets/"+t);if(i){let t=await ne.readBlobAsArrayBuffer(i);e=Ut.Dif.LoadFromArrayBuffer(t)}else e=null}return this.difCache.set(t,e),this.difCachePromises.delete(t),e})();this.difCachePromises.set(t,e),i=await e}return{dif:i,path:t}}async getDts(t){let i=null,s="gold"===e.modification?"data/":"data_mbp/";if(this.zipDirectory&&this.zipDirectory.files["data/"+t]){let e=await this.zipDirectory.files["data/"+t].async("arraybuffer");i=new Ft(e).parse()}else i=await Ft.loadFile("./assets/"+s+t);return i}getFullNamesOf(e){let t=[],i="data/"+(e=e.toLowerCase());if(this.zipDirectory)for(let e in this.zipDirectory.files)if(e.startsWith(i)){if(e.length!==i.length&&i.length!==e.lastIndexOf("."))continue;t.push(e.slice(e.lastIndexOf("/")+1))}return t.push(...ne.getFullNamesOf(e,"gold"!==this.modification)),t}getBlobForFile(e){let t=this.zipDirectory.files[e];if(this.fileToBlobPromises.get(t))return this.fileToBlobPromises.get(t);let i=t.async("blob");return this.fileToBlobPromises.set(t,i),i}async getTexture(e){e=e.toLowerCase();let t="gold"===this.modification?"data/":"data_mbp/";if(this.zipDirectory&&this.zipDirectory.files[t+e]){let i=await this.getBlobForFile(t+e),s=ne.getUrlToBlob(i);return await ne.getTexture(s,"")}return await ne.getTexture(e,"assets/"+t)}async getResource(e){e=e.toLowerCase();let t="gold"===this.modification?"data/":"data_mbp/";return this.zipDirectory&&this.zipDirectory.files[t+e]?await this.getBlobForFile(t+e):await ne.loadResource("./assets/"+t+e)}async getImage(e){e=e.toLowerCase();let t="gold"===this.modification?"data/":"data_mbp/";if(this.zipDirectory&&this.zipDirectory.files[t+e]){let i=await this.getBlobForFile(t+e),s=ne.getUrlToBlob(i);return await ne.loadImage(s,t+e)}return await ne.loadImage("./assets/"+t+e)}matchesSearch(e,t){for(let t=0;t<e.length;t++)if(!this.searchString.includes(e[t]))return!1;return!0}computeAlarmStartTime(){let e=this.qualifyTime;return this.missionInfo.alarmstarttime?e-=1e3*It.parseNumber(this.missionInfo.alarmstarttime):e-=15e3,e=Math.max(0,e)}static compareLexicographically(e,t){return I.normalizeString(e.title).localeCompare(I.normalizeString(t.title),void 0,{numeric:!0,sensitivity:"base"})}static compareChronologically(e,t){return e.createdAt-t.createdAt}}class Ot{static async init(){let e=[],t=[],i=[];const s=(e,t,i)=>{for(let n in t)t[n]?s(e,t[n],i+n+"/"):n.endsWith(".mis")&&e.push(i+n)};s(e,ne.dataDirectoryStructure.missions,""),s(t,ne.dataMbpDirectoryStructure.missions_mbp,""),s(i,ne.dataMbpDirectoryStructure.missions_mbu,"");let n=[],r=[],a=[];for(let t of e)n.push(It.loadFile("./assets/data/missions/"+t));for(let e of t)r.push(It.loadFile("./assets/data_mbp/missions_mbp/"+e));for(let e of i)a.push(It.loadFile("./assets/data_mbp/missions_mbu/"+e));let o=ne.loadResource("/api/customs"),l=await Promise.all(n),h=await Promise.all(r),d=await Promise.all(a),c=new Map;for(let t=0;t<e.length;t++)c.set(l[t],e[t]);for(let e=0;e<t.length;e++)c.set(h[e],t[e]);for(let e=0;e<i.length;e++)c.set(d[e],i[e]);let u=[],m=[],p=[];for(let e of l){let t=Vt.fromMisFile(c.get(e),e);u.push(t)}for(let e of h){let t=Vt.fromMisFile("mbp/"+c.get(e),e);m.push(t)}for(let e of d){let t=Vt.fromMisFile("mbu/"+c.get(e),e);p.push(t)}const g=(e,t)=>It.parseNumber(e.missionInfo.level)-It.parseNumber(t.missionInfo.level);u.sort(g),m.sort(g),p.sort(g);let f=await ne.readBlobAsJson(await o),y=f.filter(e=>"gold"===e.modification),b=f.filter(e=>"platinum"===e.modification),v=f.filter(e=>"ultra"===e.modification);for(let e of[...y,...b,...v]){let t=Vt.fromCustomLevelInfo(e,!1);"gold"===t.modification?u.push(t):"ultra"===t.modification?p.push(t):m.push(t)}for(let e of u){let t=e.type;"beginner"===t?this.goldBeginner.push(e):"intermediate"===t?this.goldIntermediate.push(e):"advanced"===t?this.goldAdvanced.push(e):this.goldCustom.push(e),this.allMissions.push(e)}for(let e of m){let t=e.type;"beginner"===t?this.platinumBeginner.push(e):"intermediate"===t?this.platinumIntermediate.push(e):"advanced"===t?this.platinumAdvanced.push(e):"expert"===t?this.platinumExpert.push(e):this.platinumCustom.push(e),this.allMissions.push(e)}for(let e of p){let t=e.type;"beginner"===t?this.ultraBeginner.push(e):"intermediate"===t?this.ultraIntermediate.push(e):"advanced"===t?this.ultraAdvanced.push(e):this.ultraCustom.push(e),this.allMissions.push(e)}I.swapInArray(this.goldIntermediate,11,12),this.goldCustom.sort(Vt.compareLexicographically),this.platinumCustom.sort(Vt.compareLexicographically),this.ultraCustom.sort(Vt.compareLexicographically);for(let e=0;e<this.goldBeginner.length;e++)this.goldBeginner[e].initSearchString();for(let e=0;e<this.goldIntermediate.length;e++)this.goldIntermediate[e].initSearchString();for(let e=0;e<this.goldAdvanced.length;e++)this.goldAdvanced[e].initSearchString();for(let e=0;e<this.goldCustom.length;e++)this.goldCustom[e].initSearchString();for(let e=0;e<this.platinumBeginner.length;e++)this.platinumBeginner[e].initSearchString();for(let e=0;e<this.platinumIntermediate.length;e++)this.platinumIntermediate[e].initSearchString();for(let e=0;e<this.platinumAdvanced.length;e++)this.platinumAdvanced[e].initSearchString();for(let e=0;e<this.platinumExpert.length;e++)this.platinumExpert[e].initSearchString();for(let e=0;e<this.platinumCustom.length;e++)this.platinumCustom[e].initSearchString();for(let e=0;e<this.ultraBeginner.length;e++)this.ultraBeginner[e].initSearchString();for(let e=0;e<this.ultraIntermediate.length;e++)this.ultraIntermediate[e].initSearchString();for(let e=0;e<this.ultraAdvanced.length;e++)this.ultraAdvanced[e].initSearchString();for(let e=0;e<this.ultraCustom.length;e++)this.ultraCustom[e].initSearchString();this.allCategories.push(this.goldBeginner,this.goldIntermediate,this.goldAdvanced,this.goldCustom,this.platinumBeginner,this.platinumIntermediate,this.platinumAdvanced,this.platinumExpert,this.platinumCustom,this.ultraBeginner,this.ultraIntermediate,this.ultraAdvanced,this.ultraCustom)}static getModification(e){var t,i;return null!==(i=null===(t=e[0])||void 0===t?void 0:t.modification)&&void 0!==i?i:null}static getDifficulty(e){var t,i;return null!==(i=null===(t=e[0])||void 0===t?void 0:t.type)&&void 0!==i?i:null}}Ot.allMissions=[],Ot.allCategories=[],Ot.goldBeginner=[],Ot.goldIntermediate=[],Ot.goldAdvanced=[],Ot.goldCustom=[],Ot.platinumBeginner=[],Ot.platinumIntermediate=[],Ot.platinumAdvanced=[],Ot.platinumExpert=[],Ot.platinumCustom=[],Ot.ultraBeginner=[],Ot.ultraIntermediate=[],Ot.ultraAdvanced=[],Ot.ultraCustom=[];class Nt{constructor(){this.positions=[],this.normals=[],this.uvs=[],this.indices=[],this.materials=[]}fillRest(){for(;this.normals.length/3<this.positions.length/3;)this.normals.push(0,0,0);for(;this.uvs.length/2<this.positions.length/3;)this.uvs.push(0,0)}validate(){if(1!==new Set([this.positions.length/3,this.normals.length/3,this.uvs.length/2]).size)throw console.error(this),new Error(`Geometry is invalid (vertex counts don't match):\nPositions: ${this.positions.length/3}\nNormals: ${this.normals.length/3}\nUvs: ${this.uvs.length/2},\nMaterial Indices: ${this.materials.length/1}\n\t\t\t`);for(let e=0;e<this.indices.length;e++)if(this.indices[e]>=this.positions.length/3)throw console.error(this),new Error("Geometry is invalid (index points out of bounds)");let e=this.indices.length;if(e%3)throw new Error("Geometry is invalid (triangle count isn't a whole number): "+e/3)}static createSphereGeometry(e=1,t=32,s=16,n=0,r=2*Math.PI,a=0,o=Math.PI){let l=new Nt;t=Math.max(3,Math.floor(t)),s=Math.max(2,Math.floor(s));const h=Math.min(a+o,Math.PI);let d=0;const c=[],u=new i,m=new i,p=[],g=[],f=[];for(let i=0;i<=s;i++){const l=[],y=i/s;let b=0;0===i&&0===a?b=.5/t:i===s&&h===Math.PI&&(b=-.5/t);for(let i=0;i<=t;i++){const s=i/t;u.x=-e*Math.cos(n+s*r)*Math.sin(a+y*o),u.y=e*Math.cos(a+y*o),u.z=e*Math.sin(n+s*r)*Math.sin(a+y*o),p.push(u.x,u.y,u.z),m.copy(u).normalize(),g.push(m.x,m.y,m.z),f.push(s+b,1-y),l.push(d++)}c.push(l)}I.pushArray(l.positions,p),I.pushArray(l.normals,g),I.pushArray(l.uvs,f);for(let e=0;e<s;e++)for(let i=0;i<t;i++){const t=c[e][i+1],n=c[e][i],r=c[e+1][i],o=c[e+1][i+1];(0!==e||a>0)&&l.indices.push(t,n,o),(e!==s-1||h<Math.PI)&&l.indices.push(n,r,o)}return I.pushArray(l.materials,Array(l.indices.length).fill(0)),l}}const qt=new h;class jt{constructor(){this.parent=null,this.transform=new h,this.position=new i,this.orientation=new t,this.scale=new i(1,1,1),this.worldTransform=new h,this.needsWorldTransformUpdate=!0}updateWorldTransform(){var e,t;this.worldTransform.copy(null!==(t=null===(e=this.parent)||void 0===e?void 0:e.worldTransform)&&void 0!==t?t:qt).multiply(this.transform),this.needsWorldTransformUpdate=!1,this.transform.decompose(this.position,this.orientation,this.scale)}changedTransform(){this.needsWorldTransformUpdate=!0;let e=this.parent;for(;e&&!e.needsWorldTransformUpdate;)e.needsWorldTransformUpdate=!0,e=e.parent}recomputeTransform(){this.transform.compose(this.position,this.orientation,this.scale),this.changedTransform()}}class Gt extends jt{constructor(e,t){super(),this.needsMeshInfoBufferUpdate=!0,this.needsVertexBufferUpdate=!1,this._opacity=1,this.castShadows=!1,this.materialIndices=[],this.hasTransparentMaterials=!1,this.geometry=e,this.materials=t}changedTransform(){this.needsWorldTransformUpdate||(super.changedTransform(),this.needsMeshInfoBufferUpdate=!0)}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this.needsMeshInfoBufferUpdate=!0)}updateMeshInfoBuffer(e,t){e.set(this.worldTransform.elements,t),e[t+3]=this._opacity,e[t+7]=0,this.needsMeshInfoBufferUpdate=!1}compileMaterialIndices(){let e=new Map;for(let t=0;t<this.geometry.indices.length;t++){let i=this.geometry.materials[t],s=this.materials[i],n=e.get(s);n||(n={material:s,indices:[]},e.set(s,n),this.materialIndices.push(n));let r=this.geometry.indices[t];n.indices.push(this.vboOffset+r)}for(let e of this.materialIndices)e.indexBuffer=new Uint32Array(e.indices)}}class Wt{constructor(){this.differentiator="",this.diffuseMap=null,this.envMap=null,this.normalMap=null,this.specularMap=null,this.noiseMap=null,this.emissive=!1,this.transparent=!1,this.depthWrite=!0,this.opacity=1,this.blending=re.Normal,this.normalizeNormals=!1,this.invertU=!1,this.flipY=!1,this.isSky=!1,this.isShadow=!1,this.receiveShadows=!1,this.reflectivity=0,this.envMapZUp=!0,this.useFresnel=!1,this.useAccurateReflectionRay=!1,this.specularIntensity=0,this.shininess=30,this.saturateIncomingLight=!0,this.visible=!0,this.renderOrder=0,this.secondaryMapUvFactor=1,this.hashCache=null,this.defineChunkCache=null}getHash(){var e,t,i,s,n;if(this.hashCache)return this.hashCache;let r=[this.differentiator,null===(e=this.diffuseMap)||void 0===e?void 0:e.id,null===(t=this.envMap)||void 0===t?void 0:t.id,null===(i=this.normalMap)||void 0===i?void 0:i.id,null===(s=this.specularMap)||void 0===s?void 0:s.id,null===(n=this.noiseMap)||void 0===n?void 0:n.id,this.emissive,this.transparent,this.depthWrite,this.opacity,this.blending,this.normalizeNormals,this.invertU,this.flipY,this.isSky,this.isShadow,this.receiveShadows,this.reflectivity,this.envMapZUp,this.useFresnel,this.specularIntensity,this.shininess,this.saturateIncomingLight,this.renderOrder,this.secondaryMapUvFactor];return this.hashCache=r.map(e=>""+e).join(" ")}getDefineChunk(){if(this.defineChunkCache)return this.defineChunkCache;let e=[];return this.diffuseMap&&e.push("USE_DIFFUSE_MAP"),this.envMap&&e.push("USE_ENV_MAP"),this.normalMap&&e.push("USE_NORMAL_MAP"),this.specularMap&&e.push("USE_SPECULAR_MAP"),this.noiseMap&&e.push("USE_NOISE_MAP"),this.emissive&&e.push("EMISSIVE"),this.transparent&&e.push("TRANSPARENT"),this.normalizeNormals&&e.push("NORMALIZE_NORMALS"),this.invertU&&e.push("INVERT_U"),this.flipY&&e.push("FLIP_Y"),this.isSky&&e.push("IS_SKY"),this.isShadow&&e.push("IS_SHADOW"),this.receiveShadows&&e.push("RECEIVE_SHADOWS"),this.envMapZUp&&e.push("ENV_MAP_Z_UP"),this.useFresnel&&e.push("USE_FRESNEL"),this.useAccurateReflectionRay&&e.push("USE_ACCURATE_REFLECTION_RAY"),this.specularIntensity&&e.push("USE_SPECULAR"),this.saturateIncomingLight&&e.push("SATURATE_INCOMING_LIGHT"),this.blending===re.Normal&&e.push("USE_PREMULTIPLIED_ALPHA"),this.defineChunkCache=e.map(e=>`#define ${e}\n`).join("")}}var Ht;!function(e){e[e.Dynamic=0]="Dynamic",e[e.Static=1]="Static"}(Ht||(Ht={}));let Xt=new t,Yt=new i,Qt=new t;class Kt{constructor(){this.world=null,this.type=Ht.Dynamic,this.enabled=!0,this.position=new i,this.orientation=new t,this.linearVelocity=new i,this.angularVelocity=new i,this.prevPosition=new i,this.prevOrientation=new t,this.prevLinearVelocity=new i,this.prevAngularVelocity=new i,this.prevValid=!1,this.shapes=[],this.collisions=[],this.evaluationOrder=0}transformPoint(e){return e.applyQuaternion(this.orientation).add(this.position)}transformPointInv(e){return Qt.copy(this.orientation).conjugate(),e.sub(this.position).applyQuaternion(Qt)}integrate(e){if(this.type!==Ht.Dynamic)return;let t=this.linearVelocity.clone().multiplyScalar(e),i=this.angularVelocity.clone().multiplyScalar(e);0===t.lengthSq()&&0===i.lengthSq()||(this.applyTranslation(t),this.applyRotation(i),this.syncShapes())}applyTranslation(e){this.position.add(e)}applyRotation(e){Xt.setFromAxisAngle(Yt.copy(e).normalize(),e.length()),this.orientation.multiplyQuaternions(Xt,this.orientation).normalize()}storePrevious(){this.prevPosition.copy(this.position),this.prevOrientation.copy(this.orientation),this.prevValid=!0}revert(e){let t=this.position.equals(this.prevPosition),i=this.orientation.equals(this.prevOrientation);t&&i||(this.position.lerpVectors(this.prevPosition,this.position,e),Qt.copy(this.orientation),this.orientation.copy(this.prevOrientation).slerp(Qt,e))}addCollisionShape(e){if(e.body)throw new Error("Shape has already been added to a RigidBody.");this.shapes.push(e),e.body=this,e.updateBoundingBox(),this.type===Ht.Static&&(e.mass=1/0,e.invInertia.multiplyScalar(0))}removeCollisionShape(e){this.shapes.includes(e)&&(I.removeFromArray(this.shapes,e),e.body=null)}syncShapes(){for(let e=0;e<this.shapes.length;e++)this.shapes[e].updateBoundingBox()}getRelativeMotionVector(e,t){return e.copy(this.position).sub(this.prevPosition).sub(t.position).add(t.prevPosition)}onBeforeIntegrate(e){}onAfterIntegrate(e){}onBeforeCollisionResponse(e,t){}onAfterCollisionResponse(e,t){}}const $t=new i,Zt=new i,Jt=new l;class ei{constructor(e=new i(1,0,0),t=0){this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,s){return this.normal.set(e,t,i),this.constant=s,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const s=$t.subVectors(i,t).cross(Zt.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}projectPoint(e,t){return t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||Jt.getNormalMatrix(e),s=this.coplanarPoint($t).applyMatrix4(e),n=this.normal.applyMatrix3(i).normalize();return this.constant=-s.dot(n),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new ei).copy(this)}}const ti=1,ii=1,si=Math.cos(I.degToRad(15)),ni={friction_high:1.5,friction_low:.2,friction_none:.01,friction_ramp_yellow:2,grass:1.5,mmg_grass:.9,tarmac:.35,sand:4,mmg_sand:6,carpet:6,rug:6,water:6,mmg_water:6,ice1:.03,mmg_ice:.03,floor_bounce:.2,mbp_chevron_friction:0,mbp_chevron_friction2:0,mbp_chevron_friction3:0},ri={friction_high:.5,friction_low:.5,friction_none:.5,grass:.35,mmg_grass:.5,tarmac:.7,sand:.1,mmg_sand:.1,carpet:.5,rug:.5,water:0,mmg_water:0,ice1:.95,mmg_ice:.95},ai={floor_bounce:15},oi=new Set([...Object.keys(ni),...Object.keys(ri),...Object.keys(ai)]),li=async(e,t,i)=>{let s=await e.level.mission.getTexture(`interiors_mbu/${t}`),n=await e.level.mission.getTexture(`shaders/tex/${i}`),r=new Wt;return r.normalMap=n,r.diffuseMap=s,r.saturateIncomingLight=!1,r.receiveShadows=!0,r.invertU=!0,r},hi=async(e,t,i,s,n,r,a=1,o=!0)=>{let l=i&&await e.level.mission.getTexture(`shaders/tex/${i}`),h=s&&await e.level.mission.getTexture(`shaders/tex/${s}`),d=await e.level.mission.getTexture(`interiors_mbu/${t}`),c=new Wt;return c.diffuseMap=d,c.specularMap=l,c.normalMap=h,c.shininess=n,c.specularIntensity=r,c.secondaryMapUvFactor=a,c.saturateIncomingLight=!1,c.receiveShadows=!0,c.invertU=o,c},di=async(e,t,i)=>{let s=await e.level.mission.getTexture(`interiors_mbu/${t}`),n=await e.level.mission.getTexture("shaders/tex/tile_mbu.spec.jpg"),r=await e.level.mission.getTexture(`shaders/tex/noise${i}.jpg`),a=await e.level.mission.getTexture("shaders/tex/tile_mbu.normal.png"),o=new Wt;return o.diffuseMap=s,o.specularMap=n,o.normalMap=a,o.noiseMap=r,o.shininess=40,o.specularIntensity=.7,o.saturateIncomingLight=!1,o.receiveShadows=!0,o.invertU=!0,o},ci={plate_1:e=>hi(e,"plate_1.jpg","plate_mbu.spec.jpg","plate_mbu.normal.png",30,.5),tile_beginner:e=>di(e,"tile_beginner.png",""),tile_beginner_shadow:e=>di(e,"tile_beginner_shadow.png",""),tile_beginner_red:e=>di(e,"tile_beginner_red.jpg",""),tile_beginner_red_shadow:e=>di(e,"tile_beginner_red_shadow.png",""),tile_beginner_blue:e=>di(e,"tile_beginner_blue.jpg",""),tile_beginner_blue_shadow:e=>di(e,"tile_beginner_blue_shadow.png",""),tile_intermediate:e=>di(e,"tile_intermediate.png",""),tile_intermediate_shadow:e=>di(e,"tile_intermediate_shadow.png",""),tile_intermediate_red:e=>di(e,"tile_intermediate_red.jpg",""),tile_intermediate_red_shadow:e=>di(e,"tile_intermediate_red_shadow.png",""),tile_intermediate_green:e=>di(e,"tile_intermediate_green.jpg",""),tile_intermediate_green_shadow:e=>di(e,"tile_intermediate_green_shadow.png",""),tile_advanced:e=>di(e,"tile_advanced.png",""),tile_advanced_shadow:e=>di(e,"tile_advanced_shadow.png",""),tile_advanced_blue:e=>di(e,"tile_advanced_blue.jpg",""),tile_advanced_blue_shadow:e=>di(e,"tile_advanced_blue_shadow.png",""),tile_advanced_green:e=>di(e,"tile_advanced_green.jpg",""),tile_advanced_green_shadow:e=>di(e,"tile_advanced_green_shadow.png",""),tile_underside:e=>di(e,"tile_underside.jpg",""),wall_beginner:e=>hi(e,"wall_beginner.png","wall_mbu.spec.png","wall_mbu.normal.png",30,.5),edge_white:e=>hi(e,"edge_white.jpg","edge_white_mbu.spec.jpg","edge_white_mbu.normal.jpg",50,4,1,!1),edge_white_shadow:e=>hi(e,"edge_white_shadow.png","edge_white_mbu.spec.jpg","edge_white_mbu.normal.jpg",50,4,1,!1),beam:e=>li(e,"beam.png","beam_side_mbu.normal.png"),beam_side:e=>li(e,"beam_side.png","beam_side_mbu.normal.png"),friction_low:e=>hi(e,"friction_low.jpg",null,"friction_low_mbu.normal.png",100,3),friction_low_shadow:e=>hi(e,"friction_low_shadow.png",null,"friction_low_mbu.normal.png",100,3),friction_high:e=>hi(e,"friction_high.png","friction_high_mbu.spec.png","friction_high_mbu.normal.png",30,.8,2),friction_high_shadow:e=>hi(e,"friction_high_shadow.png","friction_high_mbu.spec.png","friction_high_mbu.normal.png",30,.8,2)};class ui{constructor(e,t,i,s){this.worldMatrix=new h,this.materialNames=[],this.allowSpecialMaterials=!0,this.dif=e,this.difPath=t,this.level=i,this.detailLevel=void 0===s?e.interiors[0]:e.subObjects[s],this.materialNames=this.detailLevel.materialList.map(e=>e.split("/").pop().toLowerCase()),this.body=new Kt,this.body.type=Ht.Static,this.body.onAfterCollisionResponse=((e,t)=>{for(let e of this.body.collisions)this.onMarbleContact(e,t)}),this.specialMaterials=new Set([...oi,...Object.keys(this.level.mission.misFile.materialMappings)])}async init(e){this.id=e,await ui.initCachePromises.get(this.detailLevel);let t=ui.initCache.get(this.detailLevel);if(t&&t.fancyShaders!==Y.data.settings.fancyShaders&&(ui.initCache.delete(this.detailLevel),t=null),!t){let e,s=new Promise(t=>e=t);ui.initCachePromises.set(this.detailLevel,s);let n=[];for(let e=0;e<this.detailLevel.materialList.length;e++){let t=this.detailLevel.materialList[e].toLowerCase().split("/").pop();if(Y.data.settings.fancyShaders&&"ultra"===this.level.mission.modification&&ci[t]){n.push(await ci[t](this));continue}let i=new Wt;if(i.receiveShadows=!0,n.push(i),"ultra"===this.level.mission.modification&&"tools_invisible"===t){i.opacity=0;continue}let s=this.difPath.includes("data/")?this.difPath.slice(this.difPath.indexOf("data/")+"data/".length):this.difPath.slice(this.difPath.indexOf("data_mbp/")+"data_mbp/".length);const r=async()=>{let e=s;for(;e=e.slice(0,Math.max(0,e.lastIndexOf("/")));){let s=this.level.mission.getFullNamesOf(e+"/"+t);if(s.length>0){let t=s.find(e=>!e.endsWith(".dif"));if(!t)break;let n=await this.level.mission.getTexture(e+"/"+t);i.diffuseMap=n;break}}};await r(),!i.diffuseMap&&s.includes("interiors/")&&(s=s.replace("interiors/","interiors_mbp/"),await r())}let r=new Nt,a=new Map;for(let e of this.detailLevel.surfaces)this.addSurface(r,e,a);for(let[,e]of a)for(let t=0;t<e.length;t++){let s=e[t],n=new i;for(let e=0;e<s.normals.length;e++)n.add(s.normals[e]);n.multiplyScalar(1/s.normals.length);for(let e=0;e<s.normalIndices.length;e++){let t=r.normals,i=s.normalIndices[e];t[i+0]=n.x,t[i+1]=n.y,t[i+2]=n.z}}t={geometry:r,materials:n,fancyShaders:Y.data.settings.fancyShaders},ui.initCache.set(this.detailLevel,t),ui.initCachePromises.delete(this.detailLevel),e()}let s=new Gt(t.geometry,t.materials);this.mesh=s,this.level.loadingState.loaded++}addSurface(e,t,s){let n=this.detailLevel,r=n.texGenEQs[t.texGenIndex],a=new ei(new i(r.planeX.x,r.planeX.y,r.planeX.z),r.planeX.d),o=new ei(new i(r.planeY.x,r.planeY.y,r.planeY.z),r.planeY.d),l=n.planes[t.planeIndex],h=n.normals[l.normalIndex],d=this.materialNames[t.textureIndex],c=0;for(let n=t.windingStart;n<t.windingStart+t.windingCount-2;n++){let r=this.detailLevel.windings[n],l=this.detailLevel.windings[n+1],u=this.detailLevel.windings[n+2];if(c%2==0){let e=r;r=u,u=e}let m=new i(h.x,h.y,h.z);t.planeFlipped&&m.negate();for(let n of[r,l,u]){let r=this.detailLevel.points[n],l=a.distanceToPoint(new i(r.x,r.y,r.z)),h=o.distanceToPoint(new i(r.x,r.y,r.z));"ultra"===this.level.mission.modification&&"plate_1"===d&&(l/=2,h/=2),e.positions.push(r.x,r.y,r.z),e.normals.push(0,0,0),e.uvs.push(l,h),e.materials.push(t.textureIndex),e.indices.push(e.indices.length);let c,u=s.get(r);u||(u=[],s.set(r,u));for(let e=0;e<u.length&&(c=u[e],!(m.dot(c.referenceNormal)>si));e++)c=null;c||(c={referenceNormal:m,normalIndices:[],normals:[]},u.push(c)),c.normalIndices.push(e.normals.length-3),c.normals.push(m)}c++}}addConvexHull(e,t){let s=this.detailLevel.convexHulls[e],n=new Set;for(let e=s.surfaceStart;e<s.surfaceStart+s.surfaceCount;e++){let t=this.detailLevel.surfaces[this.detailLevel.hullSurfaceIndices[e]];if(!t)continue;let i=this.materialNames[t.textureIndex];i&&(this.specialMaterials.has(i)||(i=""),n.add(i))}if(0===n.size)return;let r=[];for(let e=s.hullStart;e<s.hullStart+s.hullCount;e++){let s=this.detailLevel.points[this.detailLevel.hullIndices[e]];r.push(new i(s.x*t.x,s.y*t.y,s.z*t.z))}let a=new k(r);if(1===n.size){let e=n.values().next().value,t=this.getCollisionMaterialProperties(e);a.friction=t.friction,a.restitution=t.restitution,a.userData=t}else for(let e=s.surfaceStart;e<s.surfaceStart+s.surfaceCount;e++){let t=this.detailLevel.surfaces[this.detailLevel.hullSurfaceIndices[e]];if(!t)continue;let s=this.materialNames[t.textureIndex];if(!s)continue;let n=this.detailLevel.planes[t.planeIndex],r=this.detailLevel.normals[n.normalIndex],o=new i(r.x,r.y,r.z);t.planeFlipped&&o.negate();let l=this.getCollisionMaterialProperties(s);a.materialOverrides.set(o,l)}this.body.addCollisionShape(a)}getCollisionMaterialProperties(e){var t,i,s,n,r;let a,o=ii,l=ii,h=!1;if(this.allowSpecialMaterials){let h=this.level.mission.misFile.materialProperties[this.level.mission.misFile.materialMappings[e]],d=null!==(i=null!==(t=null===h||void 0===h?void 0:h.friction)&&void 0!==t?t:ni[e])&&void 0!==i?i:1,c=null!==(n=null!==(s=null===h||void 0===h?void 0:h.restitution)&&void 0!==s?s:ri[e])&&void 0!==n?n:1;void 0!==(a=null!==(r=null===h||void 0===h?void 0:h.force)&&void 0!==r?r:ai[e])&&(c=1),l*=c,o*=d}return this.allowSpecialMaterials&&(null===e||void 0===e?void 0:e.startsWith("mbp_chevron_friction"))&&(h=!0),{friction:o,restitution:l,force:a,isRandom:h}}setTransform(e,t,i){this.worldMatrix.compose(e,t,i),this.scale=i,this.mesh.transform.copy(this.worldMatrix),this.body.position.copy(e),this.body.orientation.copy(t);for(let e=0;e<this.detailLevel.convexHulls.length;e++)this.addConvexHull(e,this.scale)}onMarbleContact(e,t){let i=e.s2,s=this.level.marble,n=i.userData||i.materialOverrides.get(e.s2MaterialOverride);if(void 0!==n.force)s.setLinearVelocityInDirection(e.normal,n.force,!1),s.slidingTimeout=2;else if(n.isRandom){let i=t/(1/ea),n=s.body.angularVelocity.clone().cross(e.normal);s.body.linearVelocity.addScaledVector(n,-.0015*i),s.body.angularVelocity.multiplyScalar(1+.07*s.speedFac*i)}}tick(e){}render(e){}reset(){}async onLevelStart(){}}ui.initCache=new WeakMap,ui.initCachePromises=new WeakMap;class mi{constructor(e){this.text=e}parse(){let e=this.text.split("\n"),t=[];for(let i of e){if((i=i.trim()).startsWith("//"))continue;if(!i)continue;let e=i.split(" "),s=e[1]?Number(e[1]):1;for(let i=0;i<s;i++)t.push(e[0])}return t}static async loadFile(e){if(this.cachedFiles.get(e))return this.cachedFiles.get(e);let t=await ne.loadResource(e),i=await ne.readBlobAsText(t),s=new mi(i).parse();return this.cachedFiles.set(e,s),s}}mi.cachedFiles=new Map;class pi extends jt{constructor(){super(...arguments),this.children=[]}add(e){e.parent&&e.parent.remove(e),this.children.push(e),e.parent=this}remove(e){I.removeFromArray(this.children,e),e.parent=null}updateWorldTransform(){if(this.needsWorldTransformUpdate){super.updateWorldTransform();for(let e of this.children)e.needsWorldTransformUpdate&&e.updateWorldTransform()}}changedTransform(){super.changedTransform();for(let e of this.children)e.changedTransform()}traverse(e){e(this);for(let t of this.children)t instanceof pi?t.traverse(e):e(t)}setOpacity(e){for(let t of this.children)t instanceof pi?t.setOpacity(e):t.opacity=e}}const gi=new Set(["shapes/items/superjump.dts","shapes/items/antigravity.dts"]);var fi,yi;!function(e){e[e.S_Wrap=1]="S_Wrap",e[e.T_Wrap=2]="T_Wrap",e[e.Translucent=4]="Translucent",e[e.Additive=8]="Additive",e[e.Subtractive=16]="Subtractive",e[e.SelfIlluminating=32]="SelfIlluminating",e[e.NeverEnvMap=64]="NeverEnvMap",e[e.NoMipMap=128]="NoMipMap",e[e.MipMap_ZeroBorder=256]="MipMap_ZeroBorder",e[e.IflMaterial=134217728]="IflMaterial",e[e.IflFrame=268435456]="IflFrame",e[e.DetailMapOnly=536870912]="DetailMapOnly",e[e.BumpMapOnly=1073741824]="BumpMapOnly",e[e.ReflectanceMapOnly=-2147483648]="ReflectanceMapOnly"}(fi||(fi={})),function(e){e[e.Triangles=0]="Triangles",e[e.Strip=1073741824]="Strip",e[e.Fan=-2147483648]="Fan",e[e.Indexed=536870912]="Indexed",e[e.NoMaterial=268435456]="NoMaterial",e[e.MaterialMask=268435455]="MaterialMask",e[e.TypeMask=-1073741824]="TypeMask"}(yi||(yi={}));class bi{constructor(){this.isTSStatic=!1,this.hasBeenRendered=!1,this.meshes=[],this.collideable=!0,this.colliders=[],this.shapeVertices=new Map,this.isCurrentlyColliding=!1,this.worldPosition=new i,this.worldOrientation=new t,this.worldScale=new i,this.worldMatrix=new h,this.matNamesOverride={},this.castShadows=!1,this.rootGraphNodes=[],this.nodeTransforms=[],this.showSequences=!0,this.hasNonVisualSequences=!1,this.sequenceKeyframeOverride=new WeakMap,this.lastSequenceKeyframes=new WeakMap,this.currentOpacity=1,this.restitution=ii,this.friction=ti,this.ambientRotate=!1,this.ambientSpinFactor=-1/3e3*Math.PI*2,this.receiveShadows=!0,this.materialPostprocessor=null,this.shareId=0,this.shareNodeTransforms=!0,this.shareMaterials=!0,this.isMaster=!1,this.sounds=[]}getShareHash(){return this.dtsPath+" "+this.constructor.name+" "+this.shareId}async init(e,t=null){var s,n,r;this.id=null!==(s=null===t||void 0===t?void 0:t._id)&&void 0!==s?s:0,this.level=e,this.srcElement=t,null!==(n=this.colliderDtsPath)&&void 0!==n||(this.colliderDtsPath=this.dtsPath),this.dts=await(this.level?this.level.mission.getDts(this.dtsPath):Ft.loadFile(ne.mainDataPath+this.dtsPath)),this.colliderDts=this.dtsPath===this.colliderDtsPath?this.dts:await(this.level?this.level.mission.getDts(this.colliderDtsPath):Ft.loadFile(ne.mainDataPath+this.colliderDtsPath)),this.directoryPath=this.dtsPath.slice(0,this.dtsPath.lastIndexOf("/")),this.group=new pi,this.bodies=[],this.materials=[],this.materialInfo=new WeakMap;let a,o=null===(r=this.level)||void 0===r?void 0:r.sharedShapeData.get(this.getShareHash());if(o)a=await o;else{let e;this.level&&(o=new Promise(t=>e=t),this.level.sharedShapeData.set(this.getShareHash(),o));for(let e=0;e<this.dts.nodes.length;e++)this.nodeTransforms.push(new h);await this.computeMaterials();let t=[];for(let e=0;e<this.dts.nodes.length;e++){let i={index:e,node:this.dts.nodes[e],children:[],parent:null};t.push(i)}for(let e=0;e<this.dts.nodes.length;e++){let i=this.dts.nodes[e];-1!==i.parentIndex&&(t[e].parent=t[i.parentIndex],t[i.parentIndex].children.push(t[e]))}this.graphNodes=t,this.rootGraphNodes=t.filter(e=>!e.parent),this.updateNodeTransforms();let s=[],n=[],r=new Set;for(let e=0;e<this.dts.nodes.length;e++){let t=this.dts.objects.filter(t=>t.nodeIndex===e);for(let a of t){let t=this.dts.names[a.nameIndex].toLowerCase().startsWith("col");if(!t||this.collideable)for(let o=a.startMeshIndex;o<a.startMeshIndex+a.numMeshes;o++){let a=this.dts.meshes[o];if(!a)continue;if(a.parentMesh>=0)continue;if(0===a.verts.length)continue;let l=a.verts.map(e=>new i(e.x,e.y,e.z)),h=a.norms.map(e=>new i(e.x,e.y,e.z)),d=this.generateGeometryFromMesh(a,l,h);s.push(d),n.push(e),t&&r.add(d)}}}let l=null;for(let e=0;e<this.dts.meshes.length;e++){let t=this.dts.meshes[e];if(!t||t.type!==Pt.Skin)continue;let r=new Array(t.verts.length).fill(null).map(()=>new i),a=new Array(t.norms.length).fill(null).map(()=>new i),o=this.generateGeometryFromMesh(t,r,a);s.push(o),n.push(null),l=e;break}a={materials:this.materials,rootGraphNodes:this.rootGraphNodes,nodeTransforms:this.nodeTransforms,geometries:s,geometryMatrixIndices:n,collisionGeometries:r,skinnedMeshIndex:l},this.isMaster=!0,null===e||void 0===e||e(a)}this.isMaster||(this.nodeTransforms=a.nodeTransforms,this.shareNodeTransforms||(this.nodeTransforms=this.nodeTransforms.map(e=>e.clone())),this.shareMaterials?this.materials=a.materials:await this.computeMaterials(),this.rootGraphNodes=a.rootGraphNodes);for(let[e,t]of a.geometries.entries()){let s=this.materials;if(a.collisionGeometries.has(t)){let e=new Wt;e.isShadow=!0,e.transparent=!0,e.depthWrite=!1,s=[e],t.materials.fill(0)}let n=new Gt(t,s),r=this.nodeTransforms[a.geometryMatrixIndices[e]];r&&(n.transform=r),this.castShadows&&(n.castShadows=!0),this.group.add(n),this.meshes.push(n),null===a.skinnedMeshIndex||this.skinMeshInfo||(this.skinMeshInfo={meshIndex:a.skinnedMeshIndex,vertices:this.dts.meshes[a.skinnedMeshIndex].verts.map(e=>new i),normals:this.dts.meshes[a.skinnedMeshIndex].norms.map(e=>new i),mesh:n})}for(let e=0;e<this.colliderDts.nodes.length;e++){let t=this.colliderDts.objects.filter(t=>t.nodeIndex===e);for(let i of t)if(this.colliderDts.names[i.nameIndex].toLowerCase().startsWith("col")){let t=new Kt;t.type=Ht.Static,t.userData={nodeIndex:e},this.bodies.push(t)}}if(0===this.bodies.length&&!this.isTSStatic){let e=new Kt;e.type=Ht.Static,this.bodies.push(e)}for(let e of this.bodies)e.onBeforeIntegrate=(()=>{this.isCurrentlyColliding&&0===e.collisions.length&&(this.isCurrentlyColliding=!1,this.onMarbleLeave())}),e.onBeforeCollisionResponse=(e=>{this.isCurrentlyColliding||this.onMarbleEnter(e),this.onMarbleInside(e),this.isCurrentlyColliding=!0}),e.onAfterCollisionResponse=(()=>{let t=e.collisions[0];this.onMarbleContact(t)});await(null===e||void 0===e?void 0:e.audio.loadBuffers(this.sounds)),this.level&&this.level.loadingState.loaded++}async computeMaterials(){var e;let t=null;for(let i=0;i<this.dts.matNames.length;i++){let s=this.matNamesOverride[this.dts.matNames[i]]||this.dts.matNames[i],n=this.dts.matFlags[i],r=ne.getFullNamesOf(this.directoryPath+"/"+s).filter(e=>!e.endsWith(".dts")),a=r.find(e=>e.endsWith(".ifl"))||r[0];if(this.isTSStatic&&t&&gi.has(this.dtsPath)){this.materials.push(t);continue}let o=new Wt;if((n&fi.SelfIlluminating||t)&&(o.emissive=!0),this.materials.push(o),s instanceof te)o.diffuseMap=s;else if(!a||this.isTSStatic&&n&fi.ReflectanceMapOnly)this.isTSStatic&&(o.emissive=!0,n&fi.ReflectanceMapOnly&&(t=o));else if(a.endsWith(".ifl")){let e=await mi.loadFile(ne.mainDataPath+this.directoryPath+"/"+a),t=new Map;e=e.map(e=>{var i;if(t.has(e))return t.get(e);let s=null!==(i=ne.getFullNamesOf(this.directoryPath+"/"+e).filter(e=>!e.endsWith(".dts"))[0])&&void 0!==i?i:e;return t.set(e,s),s}),this.materialInfo.set(o,{keyframes:e});let i=[];for(let t of new Set(e))i.push(ne.getTexture(this.directoryPath+"/"+t));let s=await Promise.all(i);o.diffuseMap=s[0],o.differentiator=this.isTSStatic+ne.mainDataPath+this.directoryPath+"/"+a}else{let e=await ne.getTexture(this.directoryPath+"/"+a);o.diffuseMap=e}n&fi.Translucent&&(o.transparent=!0,o.depthWrite=!1),n&fi.Additive&&(o.blending=re.Additive),n&fi.Subtractive&&(o.blending=re.Subtractve),!this.isTSStatic||n&fi.NeverEnvMap||(o.reflectivity=1===this.dts.matNames.length?1:t?.5:.333,o.envMap=this.level.envMap),null===(e=this.materialPostprocessor)||void 0===e||e.call(this,o)}if(0===this.materials.length){let e=new Wt;e.emissive=!0,e.envMap=this.level.envMap,e.reflectivity=1,this.materials.push(e)}}generateGeometryFromMesh(e,t,s){let n=new Nt;for(let i=0;i<t.length;i++){let r=t[i],a=e.tverts[i],o=s[i];n.positions.push(r.x,r.y,r.z),n.normals.push(o.x,o.y,o.z),n.uvs.push(a.x,a.y)}let r=new i,a=new i;const o=(e,i,o,l)=>{r.set(t[i].x-t[e].x,t[i].y-t[e].y,t[i].z-t[e].z),a.set(t[o].x-t[e].x,t[o].y-t[e].y,t[o].z-t[e].z);let h=r.cross(a).normalize(),d=h.dot(s[e]),c=h.dot(s[i]),u=h.dot(s[o]);this.dtsPath.includes("helicopter.dts")||d<0&&c<0&&u<0&&([e,o]=[o,e]),n.indices.push(e,i,o),n.materials.push(l,l,l)};for(let t of e.primitives){let i=t.matIndex&yi.MaterialMask,s=t.matIndex&yi.TypeMask;if(s===yi.Triangles)for(let s=t.start;s<t.start+t.numElements;s+=3)o(e.indices[s],e.indices[s+1],e.indices[s+2],i);else if(s===yi.Strip){let s=0;for(let n=t.start;n<t.start+t.numElements-2;n++){let t=e.indices[n],r=e.indices[n+1],a=e.indices[n+2];if(s%2==0){let e=t;t=a,a=e}o(t,r,a,i),s++}}else if(s===yi.Fan)for(let s=t.start;s<t.start+t.numElements-2;s++)o(e.indices[t.start],e.indices[s+1],e.indices[s+2],i)}return n}generateCollisionObjects(){let e=0,t=this.colliderDts;for(let s=0;s<t.nodes.length;s++){let n=t.objects.filter(e=>e.nodeIndex===s);for(let s of n){if(!t.names[s.nameIndex].toLowerCase().startsWith("col"))continue;let n=this.bodies[e];e++;for(let e=s.startMeshIndex;e<s.startMeshIndex+s.numMeshes;e++){let s=t.meshes[e];if(s)for(let e of s.primitives){let t=new k(Array(e.numElements).fill(null).map(e=>new i));t.restitution=this.restitution,t.friction=this.friction,this.collideable||(t.collisionDetectionMask=2),n.addCollisionShape(t);let r=s.indices.slice(e.start,e.start+e.numElements).map(e=>s.verts[e]).map(e=>new i(e.x,e.y,e.z));this.shapeVertices.set(t,r)}}}}if(0===e&&!this.isTSStatic){let e=this.bodies[0],s=new r;s.min.set(t.bounds.min.x,t.bounds.min.y,t.bounds.min.z),s.max.set(t.bounds.max.x,t.bounds.max.y,t.bounds.max.z);let n=new k(Array(8).fill(null).map(e=>new i));n.restitution=this.restitution,n.friction=this.friction,this.collideable||(n.collisionDetectionMask=2),e.addCollisionShape(n);let a=I.getBoxVertices(s);this.shapeVertices.set(n,a)}}updateNodeTransforms(e,s,n,r=4294967295){e||(e=this.dts.nodes.map((e,i)=>{let s=this.dts.defaultRotations[i],n=new t(s.x,s.y,s.z,s.w);return n.normalize(),n.conjugate(),n})),s||(s=this.dts.nodes.map((e,t)=>{let s=this.dts.defaultTranslations[t];return new i(s.x,s.y,s.z)})),n||(n=this.dts.nodes.map(()=>(new i).setScalar(1)));let a=new h;const o=(t,i)=>{if(0!=(1<<t.index&r)&&(i=!0),i){let i=this.nodeTransforms[t.index];t.parent?i.copy(this.nodeTransforms[t.parent.index]):i.identity(),a.compose(s[t.index],e[t.index],n[t.index]),i.multiplyMatrices(i,a)}for(let e=0;e<t.children.length;e++)o(t.children[e],i)};for(let e=0;e<this.rootGraphNodes.length;e++){let t=this.rootGraphNodes[e];o(t,!1)}}updateCollisionGeometry(e){var t;for(let i=0;i<this.bodies.length;i++){let s,n=this.bodies[i];if(void 0!==(null===(t=n.userData)||void 0===t?void 0:t.nodeIndex)){if(0==(1<<n.userData.nodeIndex&e))continue;(s=this.worldMatrix.clone()).multiplyMatrices(this.worldMatrix,this.nodeTransforms[n.userData.nodeIndex])}else s=this.worldMatrix;for(let e of n.shapes){let t=this.shapeVertices.get(e);for(let i=0;i<t.length;i++)e.points[i].copy(t[i]).applyMatrix4(s);e.computeLocalBoundingBox()}n.syncShapes()}}tick(e,s=!1){var n,r,a,o;if(this.showSequences&&(s||this.hasNonVisualSequences)){if(!this.shareNodeTransforms||this.isMaster)for(let l of this.dts.sequences){let h,d,c,u=null!==(n=l.rotationMatters[0])&&void 0!==n?n:0,m=null!==(r=l.translationMatters[0])&&void 0!==r?r:0,p=null!==(a=l.scaleMatters[0])&&void 0!==a?a:0,g=0,f=e.timeSinceLoad/(1e3*l.duration),y=null!==(o=this.sequenceKeyframeOverride.get(l))&&void 0!==o?o:f*l.numKeyframes%l.numKeyframes;if(this.lastSequenceKeyframes.get(l)===y)continue;this.lastSequenceKeyframes.set(l,y);let b=Math.floor(y),v=Math.ceil(y)%l.numKeyframes,w=(y-b)%1;u>0&&(h=this.dts.nodes.map((e,i)=>{if(0!=(1<<i&u)){let e=this.dts.nodeRotations[l.numKeyframes*g+b],i=this.dts.nodeRotations[l.numKeyframes*g+v],s=new t(e.x,e.y,e.z,e.w);s.normalize(),s.conjugate();let n=new t(i.x,i.y,i.z,i.w);return n.normalize(),n.conjugate(),s.slerp(n,w),g++,s}{let e=this.dts.defaultRotations[i],s=new t(e.x,e.y,e.z,e.w);return s.normalize(),s.conjugate(),s}})),g=0,m>0&&(d=this.dts.nodes.map((e,t)=>{if(0!=(1<<t&m)){let e=this.dts.nodeTranslations[l.numKeyframes*g+b],t=this.dts.nodeTranslations[l.numKeyframes*g+v];return g++,new i(I.lerp(e.x,t.x,w),I.lerp(e.y,t.y,w),I.lerp(e.z,t.z,w))}{let e=this.dts.defaultTranslations[t];return new i(e.x,e.y,e.z)}})),g=0,p>0&&(c=this.dts.nodes.map((e,t)=>{if(0!=(1<<t&p)){let e=this.dts.nodeAlignedScales[l.numKeyframes*g+b],t=this.dts.nodeAlignedScales[l.numKeyframes*g+v];return g++,new i(I.lerp(e.x,t.x,w),I.lerp(e.y,t.y,w),I.lerp(e.z,t.z,w))}return(new i).setScalar(1)})),u|m|p&&(this.updateNodeTransforms(h,d,c,u|m|p),s||this.updateCollisionGeometry(u|m|p))}for(let e of this.meshes)e.changedTransform()}}render(e){if(!this.isTSStatic||!this.hasBeenRendered){if(this.tick(e,!0),this.skinMeshInfo&&this.isMaster){let e=this.skinMeshInfo,t=this.dts.meshes[e.meshIndex];for(let t=0;t<e.vertices.length;t++)e.vertices[t].set(0,0,0),e.normals[t].set(0,0,0);let s=[],n=[];for(let e=0;e<t.nodeIndices.length;e++){let i=new h;i.elements=t.initialTransforms[e].slice(),i.transpose(),i.multiplyMatrices(this.nodeTransforms[t.nodeIndices[e]],i),s.push(i),n.push(i.clone().transpose())}let r=new i,a=new i;for(let i=0;i<t.vertIndices.length;i++){let n=t.vertIndices[i],o=t.verts[n],l=t.norms[n];r.set(o.x,o.y,o.z),a.set(l.x,l.y,l.z);let h=s[t.boneIndices[i]];r.applyMatrix4(h),r.multiplyScalar(t.weights[i]),I.m_matF_x_vectorF(h,a),a.multiplyScalar(t.weights[i]),e.vertices[n].add(r),e.normals[n].add(a)}for(let t=0;t<e.normals.length;t++){let i=e.normals[t];i.dot(i)>.01&&i.normalize()}let o=e.mesh.geometry;for(let t=0;t<e.vertices.length;t++){let i=e.vertices[t],s=e.normals[t];o.positions[3*t+0]=i.x,o.positions[3*t+1]=i.y,o.positions[3*t+2]=i.z,o.normals[3*t+0]=s.x,o.normals[3*t+1]=s.y,o.normals[3*t+2]=s.z}}if(this.skinMeshInfo&&(this.skinMeshInfo.mesh.needsVertexBufferUpdate=!0),!this.shareMaterials||this.isMaster)for(let t=0;t<this.materials.length;t++){let i=this.materialInfo.get(this.materials[t]);if(!i)continue;let s=this.dts.sequences.find(e=>e.iflMatters[0]>0);if(!s||!this.showSequences)continue;let n=e.timeSinceLoad/(1e3*s.duration),r=Math.floor(n*i.keyframes.length)%i.keyframes.length,a=i.keyframes[r],o=ne.getTextureFromCache(this.directoryPath+"/"+a);this.materials[t].diffuseMap=o}if(this.ambientRotate){let s=new t,n=new i(0,0,1);s.setFromAxisAngle(n,e.timeSinceLoad*this.ambientSpinFactor);let r=this.worldOrientation.clone();s.multiplyQuaternions(r,s),this.group.orientation.copy(s),this.group.recomputeTransform()}this.hasBeenRendered=!0}}setTransform(e,s,n){let r=0!==n.clone().sub(this.worldScale).length();this.worldPosition=e,this.worldOrientation=s,this.worldScale=n,this.worldMatrix.compose(e,s,n),this.group.position.copy(e),this.group.orientation.copy(s),this.group.scale.copy(n),this.group.recomputeTransform();let a=new h;a.compose(this.worldPosition,this.worldOrientation,new i(1,1,1));for(let e of this.colliders){let s=e.transform.clone();s.multiplyMatrices(a,s);let n=new i,r=new t;for(s.decompose(n,r,new i),e.body.position.copy(n),e.body.orientation.copy(r);e.body.shapes.length;)e.body.removeCollisionShape(e.body.shapes[0]);let o=e.generateShape(this.worldScale);o.collisionDetectionMask=4,e.body.addCollisionShape(o)}r&&this.generateCollisionObjects(),this.updateCollisionGeometry(4294967295)}setOpacity(e){e!==this.currentOpacity&&(this.currentOpacity=e,this.group.setOpacity(e))}addCollider(e,t,i){let s=new Kt;s.type=Ht.Static,this.colliders.push({generateShape:e,body:s,transform:i}),s.onAfterCollisionResponse=t}setCollisionEnabled(e){for(let t of this.bodies)t.enabled=e}reset(){this.isCurrentlyColliding=!1}onMarbleContact(e){}onMarbleInside(e){}onMarbleEnter(e){}onMarbleLeave(){}async onLevelStart(){}}class vi{constructor(e,t,i){this.updateRange={start:1/0,end:0},this.renderer=e,this.buffer=e.gl.createBuffer(),this.data=t,this.attributes=i,this.stride=Object.values(i).reduce((e,t)=>e+t,0),1===Object.keys(i).length&&(this.stride=0);let{gl:s}=e;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,t,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null)}set(e,t){this.data.set(e,t),this.updateRange.start=Math.min(this.updateRange.start,t),this.updateRange.end=Math.max(this.updateRange.end,t+e.length)}update(){if(this.updateRange.start>=this.updateRange.end)return;let{gl:e}=this.renderer;if(e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e instanceof WebGLRenderingContext){let t=this.data.subarray(this.updateRange.start,this.updateRange.end);e.bufferSubData(e.ARRAY_BUFFER,this.updateRange.start*Float32Array.BYTES_PER_ELEMENT,t)}else e.bufferSubData(e.ARRAY_BUFFER,this.updateRange.start*Float32Array.BYTES_PER_ELEMENT,this.data,this.updateRange.start,this.updateRange.end-this.updateRange.start);this.updateRange.start=1/0,this.updateRange.end=0}dispose(){let{gl:e}=this.renderer;e.deleteBuffer(this.buffer)}}class wi{constructor(e){this.buffers=e}}const xi=["particles/bubble.png","particles/saturn.png","particles/smoke.png","particles/spark.png","particles/star.png","particles/twirl.png"],Si=16384,Ti=new Float32Array(Array(Si).fill([-.5,-.5,.5,-.5,.5,.5,-.5,.5]).flat()),Mi=new Float32Array(Array(Si).fill([0,0,1,0,1,1,0,1]).flat()),Ci=[];for(let e=0;e<Si;e++)Ci.push(4*e+0,4*e+1,4*e+2,4*e+0,4*e+2,4*e+3);class ki{constructor(e){this.emitters=[],this.particleGroups=new Map,this.particles=[],this.level=e}async init(e){this.renderer=e;let{gl:t}=e;this.positionBuffer=new vi(e,Ti,{position:2}),this.uvBuffer=new vi(e,Mi,{uv:2}),this.bufferGroup=new wi([this.positionBuffer,this.uvBuffer]),this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint32Array(Ci),t.STATIC_DRAW);let i=[];for(let e of xi)i.push(ne.getTexture(e));let s=await Promise.all(i);for(let t of s)t.getGLTexture(e)}getParticleGroup(e){let t=this.particleGroups.get(e);return t||(t=this.createParticleGroup(e),this.particleGroups.set(e,t)),t}createParticleGroup(e){var t,i,s,n,r,a,o,l,d,c,u,m,p,g,f,y,b,v,w,x;let S={particleSpawnTime:1,particleLifetime:1,particlePosition:3,particleVelocity:3,particleInitialSpin:1};const T=Object.values(S).reduce((e,t)=>e+t,0);let M=new Float32Array(4*T*Si),C=new vi(this.renderer,M,S),k=new h;return k.set((null===(t=e.colors[0])||void 0===t?void 0:t.r)||0,(null===(i=e.colors[0])||void 0===i?void 0:i.g)||0,(null===(s=e.colors[0])||void 0===s?void 0:s.b)||0,(null===(n=e.colors[0])||void 0===n?void 0:n.a)||0,(null===(r=e.colors[1])||void 0===r?void 0:r.r)||0,(null===(a=e.colors[1])||void 0===a?void 0:a.g)||0,(null===(o=e.colors[1])||void 0===o?void 0:o.b)||0,(null===(l=e.colors[1])||void 0===l?void 0:l.a)||0,(null===(d=e.colors[2])||void 0===d?void 0:d.r)||0,(null===(c=e.colors[2])||void 0===c?void 0:c.g)||0,(null===(u=e.colors[2])||void 0===u?void 0:u.b)||0,(null===(m=e.colors[2])||void 0===m?void 0:m.a)||0,(null===(p=e.colors[3])||void 0===p?void 0:p.r)||0,(null===(g=e.colors[3])||void 0===g?void 0:g.g)||0,(null===(f=e.colors[3])||void 0===f?void 0:f.b)||0,(null===(y=e.colors[3])||void 0===y?void 0:y.a)||0),k.transpose(),{vertexBuffer:C,uniforms:{acceleration:e.acceleration,spinSpeed:I.degToRad(e.spinSpeed),dragCoefficient:e.dragCoefficient,times:new Float32Array([null!==(b=e.times[0])&&void 0!==b?b:1/0,null!==(v=e.times[1])&&void 0!==v?v:1/0,null!==(w=e.times[2])&&void 0!==w?w:1/0,null!==(x=e.times[3])&&void 0!==x?x:1/0]),sizes:new Float32Array([e.sizes[0]||0,e.sizes[1]||0,e.sizes[2]||0,e.sizes[3]||0]),colors:new Float32Array(k.elements)},particles:[]}}getTime(){return this.level.timeState.timeSinceLoad}createEmitter(e,t,i,s){var n;let r=new Ai(e,this,i,s);return r.currPos=null!==(n=null===i||void 0===i?void 0:i())&&void 0!==n?n:t.clone(),r.currPosTime=this.getTime(),r.spawn(this.getTime()),this.emitters.push(r),r}removeEmitter(e){I.removeFromArray(this.emitters,e)}tick(){let e=this.getTime();for(let t=0;t<this.emitters.length;t++){let i=this.emitters[t];i.getPos&&i.setPos(i.getPos(),e),i.tick(e)||this.emitters.splice(t--,1)}}render(e){this.currentRenderTime=e;for(let[,t]of this.particleGroups){for(let i=0;i<t.particles.length;i++)!t.particles[i].isAlive(e)&&(i<t.particles.length-1&&(t.particles[i]=t.particles[t.particles.length-1],t.particles[i].applyToGroup(t,i)),t.particles.length--,i--);t.vertexBuffer.update()}}dispose(){for(let[,e]of this.particleGroups)e.vertexBuffer.dispose()}}class Ai{constructor(e,t,s,n){this.vel=new i,this.o=e,this.manager=t,this.getPos=s,this.spawnSphereSquish=null!==n&&void 0!==n?n:new i(1,1,1)}spawn(e){this.spawnTime=e,this.emit(e)}tick(e){for(e-this.lastEmitTime>=1e3&&(this.lastEmitTime=e-1e3);this.lastEmitTime+this.currentWaitPeriod<=e;)if(this.emit(this.lastEmitTime+this.currentWaitPeriod),1===I.clamp((this.lastEmitTime-this.spawnTime)/this.o.emitterLifetime,0,1))return!1;return!0}emit(e){this.lastEmitTime=e,this.currentWaitPeriod=this.o.ejectionPeriod;let t=this.getPosAtTime(e).clone();this.o.spawnOffset&&t.add(this.o.spawnOffset());let s=(new i).randomDirection();s.multiply(this.spawnSphereSquish);let n=this.vel.clone().multiplyScalar(this.o.inheritedVelFactor).add(s.multiplyScalar(this.o.ejectionVelocity+this.o.velocityVariance*(2*Math.random()-1))).add(this.o.ambientVelocity),r=this.manager.getParticleGroup(this.o.particleOptions);if(r.particles.length===Si)return;let a=new _i(this.o.particleOptions,this.manager,e,t,n);a.applyToGroup(r,r.particles.length),r.particles.push(a)}getPosAtTime(e){if(!this.lastPos)return this.currPos;let t=I.clamp((e-this.lastPosTime)/(this.currPosTime-this.lastPosTime),0,1);return this.lastPos.clone().lerp(this.currPos,t)}setPos(e,t){this.lastPos=this.currPos,this.lastPosTime=this.currPosTime,this.currPos=e.clone(),this.currPosTime=t,this.vel=this.currPos.clone().sub(this.lastPos).multiplyScalar(1e3/(this.currPosTime-this.lastPosTime))}static cloneOptions(e){let t=I.jsonClone(e);return t.ambientVelocity=new i(e.ambientVelocity.x,e.ambientVelocity.y,e.ambientVelocity.z),t.spawnOffset=e.spawnOffset,t}}class _i{constructor(e,t,i,s,n){this.o=e,this.manager=t,this.spawnTime=i,this.pos=s,this.vel=n,this.lifetime=this.o.lifetime+this.o.lifetimeVariance*(2*Math.random()-1),this.initialSpin=I.lerp(this.o.spinRandomMin,this.o.spinRandomMax,Math.random())}applyToGroup(e,t){let i=[this.spawnTime,this.lifetime,this.pos.x,this.pos.y,this.pos.z,this.vel.x,this.vel.y,this.vel.z,I.degToRad(this.initialSpin)],s=e.vertexBuffer;s.set(i,4*t*s.stride+0*s.stride),s.set(i,4*t*s.stride+1*s.stride),s.set(i,4*t*s.stride+2*s.stride),s.set(i,4*t*s.stride+3*s.stride)}isAlive(e){let t=e-this.spawnTime;return I.clamp(t/this.lifetime,0,1)<1}}const Ii={MarbleTrailEmitter:{ejectionPeriod:5,ambientVelocity:new i(0,0,0),ejectionVelocity:0,velocityVariance:.25,emitterLifetime:1e4,inheritedVelFactor:0,particleOptions:{texture:"particles/smoke.png",blending:re.Normal,spinSpeed:0,spinRandomMin:0,spinRandomMax:0,lifetime:100,lifetimeVariance:10,dragCoefficient:0,acceleration:0,colors:[{r:1,g:1,b:0,a:0},{r:1,g:1,b:0,a:1},{r:1,g:1,b:1,a:0}],sizes:[.4,.4,.4],times:[0,.15,1]}},LandMineEmitter:{ejectionPeriod:10,ambientVelocity:new i(0,0,0),ejectionVelocity:.5,velocityVariance:.25,emitterLifetime:1/0,inheritedVelFactor:.2,particleOptions:{texture:"particles/smoke.png",blending:re.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.8,acceleration:0,colors:[{r:.56,g:.36,b:.26,a:1},{r:.56,g:.36,b:.26,a:0}],sizes:[.5,1],times:[0,1]}}};class Ei{constructor(e,t){this.id=I.getRandomId(),this.nextFaceToRender=0,this.renderer=e;let{gl:i}=e,s=i.createTexture();if(i.bindTexture(i.TEXTURE_CUBE_MAP,s),Array.isArray(t)){let e=t;if(e.some(e=>!e.complete))throw new Error("Can only pass loaded images into CubeTexture.");this.size=e[0].naturalWidth,i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[0]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_X,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[1]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Y,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[2]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[3]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Z,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[4]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[5]),i.generateMipmap(i.TEXTURE_CUBE_MAP)}else{let e=t;this.size=e;let s=new Uint8Array(e*e*4);i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_X,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Y,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Z,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)}i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),this.glTexture=s}createFramebuffer(){let{gl:e}=this.renderer,t=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);let i=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,i),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.size,this.size),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,i),this.framebuffer=t,this.depthBuffer=i}render(e,t,i=1/0){let{gl:s}=this.renderer;this.framebuffer||this.createFramebuffer();let n=performance.now(),r=0;s.bindFramebuffer(s.FRAMEBUFFER,this.framebuffer);for(let a=0;a<6;a++){let o=(this.nextFaceToRender+a)%6,l=t.cameras[o];l.position.copy(t.position),l.updateMatrixWorld();let h=s.TEXTURE_CUBE_MAP_POSITIVE_X+o;if(s.bindTexture(s.TEXTURE_CUBE_MAP,null),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,h,this.glTexture,0),this.renderer.render(e,l,{framebuffer:this.framebuffer,width:this.size,height:this.size,colorTexture:this.glTexture}),r++,(performance.now()-n)/r*(r+1)>=i)break}s.bindTexture(s.TEXTURE_CUBE_MAP,this.glTexture),s.generateMipmap(s.TEXTURE_CUBE_MAP),this.nextFaceToRender+=r,this.nextFaceToRender%=6}dispose(){let{gl:e}=this.renderer;e.deleteTexture(this.glTexture),e.deleteFramebuffer(this.framebuffer),e.deleteRenderbuffer(this.depthBuffer)}}let Bi=new h;class Pi{constructor(){this.position=new i,this.orientation=new t,this.up=new i(0,0,1),this.matrixWorld=new h,this.matrixWorldInverse=new h,this.projectionMatrix=new h,this.projectionMatrixInverse=new h}updateMatrixWorld(){this.matrixWorld.compose(this.position,this.orientation,(new i).setScalar(1)),this.matrixWorldInverse.copy(this.matrixWorld).invert()}lookAt(e){Bi.lookAt(this.position,e,this.up),this.orientation.setFromRotationMatrix(Bi)}}class Li extends Pi{constructor(e=50,t=1,i=.1,s=2e3){super(),this.fov=e,this.zoom=1,this.near=i,this.far=s,this.aspect=t,this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(I.degToRad(.5*this.fov))/this.zoom,i=2*t,s=this.aspect*i,n=-.5*s;this.projectionMatrix.makePerspective(n,n+s,t,t-i,e,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}}class Ri extends Pi{constructor(e=-1,t=1,i=1,s=-1,n=.1,r=2e3){super(),this.zoom=1,this.left=e,this.right=t,this.top=i,this.bottom=s,this.near=n,this.far=r,this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let n=i-e,r=i+e,a=s+t,o=s-t;this.projectionMatrix.makeOrthographic(n,r,a,o,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}}class Fi{constructor(e,t){this.cameras=[],this.position=new i;const s=new Li(90,1,e,t);s.up.set(0,-1,0),s.lookAt(new i(1,0,0)),this.cameras.push(s);const n=new Li(90,1,e,t);n.up.set(0,-1,0),n.lookAt(new i(-1,0,0)),this.cameras.push(n);const r=new Li(90,1,e,t);r.up.set(0,0,1),r.lookAt(new i(0,1,0)),this.cameras.push(r);const a=new Li(90,1,e,t);a.up.set(0,0,-1),a.lookAt(new i(0,-1,0)),this.cameras.push(a);const o=new Li(90,1,e,t);o.up.set(0,-1,0),o.lookAt(new i(0,0,1)),this.cameras.push(o);const l=new Li(90,1,e,t);l.up.set(0,-1,0),l.lookAt(new i(0,0,-1)),this.cameras.push(l)}}const zi=new h,Di=new t;class Ui{constructor(e=0,t=0,i=0,s=Ui.defaultOrder){this.x=e,this.y=t,this.z=i,this.order=s}set(e,t,i,s=this.order){return this.x=e,this.y=t,this.z=i,this.order=s,this}clone(){return new Ui(this.x,this.y,this.z,this.order)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.order=e.order,this}setFromRotationMatrix(e,t=this.order){const i=e.elements,s=i[0],n=i[4],r=i[8],a=i[1],o=i[5],l=i[9],h=i[2],d=i[6],c=i[10];switch(t){case"XYZ":this.y=Math.asin(I.clamp(r,-1,1)),Math.abs(r)<.9999999?(this.x=Math.atan2(-l,c),this.z=Math.atan2(-n,s)):(this.x=Math.atan2(d,o),this.z=0);break;case"YXZ":this.x=Math.asin(-I.clamp(l,-1,1)),Math.abs(l)<.9999999?(this.y=Math.atan2(r,c),this.z=Math.atan2(a,o)):(this.y=Math.atan2(-h,s),this.z=0);break;case"ZXY":this.x=Math.asin(I.clamp(d,-1,1)),Math.abs(d)<.9999999?(this.y=Math.atan2(-h,c),this.z=Math.atan2(-n,o)):(this.y=0,this.z=Math.atan2(a,s));break;case"ZYX":this.y=Math.asin(-I.clamp(h,-1,1)),Math.abs(h)<.9999999?(this.x=Math.atan2(d,c),this.z=Math.atan2(a,s)):(this.x=0,this.z=Math.atan2(-n,o));break;case"YZX":this.z=Math.asin(I.clamp(a,-1,1)),Math.abs(a)<.9999999?(this.x=Math.atan2(-l,o),this.y=Math.atan2(-h,s)):(this.x=0,this.y=Math.atan2(r,c));break;case"XZY":this.z=Math.asin(-I.clamp(n,-1,1)),Math.abs(n)<.9999999?(this.x=Math.atan2(d,o),this.y=Math.atan2(r,s)):(this.x=Math.atan2(-l,c),this.y=0);break;default:console.warn("Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this.order=t,this}setFromQuaternion(e,t){return zi.makeRotationFromQuaternion(e),this.setFromRotationMatrix(zi,t)}setFromVector3(e,t=this.order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Di.setFromEuler(this),this.setFromQuaternion(Di,e)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.order===this.order}fromArray(e){return this.x=e[0],this.y=e[1],this.z=e[2],void 0!==e[3]&&(this.order=e[3]),this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.order,e}toVector3(e){return e?e.set(this.x,this.y,this.z):new i(this.x,this.y,this.z)}}Ui.defaultOrder="XYZ",Ui.rotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const Vi=.2,Oi=.3,Ni=.6666,qi=40,ji=500,Gi={ejectionPeriod:1,ambientVelocity:new i(0,0,0),ejectionVelocity:2.6,velocityVariance:.125,emitterLifetime:3,inheritedVelFactor:0,particleOptions:{texture:"particles/star.png",blending:re.Normal,spinSpeed:90,spinRandomMin:-90,spinRandomMax:90,lifetime:500,lifetimeVariance:100,dragCoefficient:.5,acceleration:-2,colors:[{r:.9,g:0,b:0,a:1},{r:.9,g:.9,b:0,a:1},{r:.9,g:.9,b:0,a:0}],sizes:[.25,.25,.25],times:[0,.75,1]}},Wi={ejectionPeriod:.9,ambientVelocity:new i(0,0,-.3),ejectionVelocity:3,velocityVariance:.4,emitterLifetime:300,inheritedVelFactor:.25,particleOptions:{texture:"particles/smoke.png",blending:re.Additive,spinSpeed:20,spinRandomMin:-90,spinRandomMax:90,lifetime:600,lifetimeVariance:250,dragCoefficient:.2,acceleration:-.1,colors:[{r:25/255,g:244/255,b:1,a:.2},{r:25/255,g:244/255,b:1,a:1},{r:25/255,g:244/255,b:1,a:1},{r:25/255,g:244/255,b:1,a:0}],sizes:[.1,.1,.1],times:[0,.2,.75,1]}},Hi=Ai.cloneOptions(Wi);Hi.ejectionVelocity=4,Hi.ejectionPeriod=.7,Hi.particleOptions.dragCoefficient=.3,Hi.particleOptions.colors=Hi.particleOptions.colors.map(e=>(e.r=1,e.g=159/255,e.b=25/255,e));class Xi{constructor(e){this.predictedPosition=new i,this.predictedOrientation=new t,this.radius=null,this.jumpImpulse=7.3,this.bounceRestitution=.5,this.superBounceEnableTime=-1/0,this.shockAbsorberEnableTime=-1/0,this.helicopterEnableTime=-1/0,this.megaMarbleEnableTime=-1/0,this.helicopterSound=null,this.shockAbsorberSound=null,this.superBounceSound=null,this.lastMovementVec=new i,this.beforeVel=new i,this.beforeAngVel=new i,this.lastContactNormal=new i,this.slidingTimeout=0,this.level=e}get speedFac(){return Vi/this.radius}async init(){var e,t;let i;this.group=new pi,this.innerGroup=new pi,this.group.add(this.innerGroup),void 0!==this.level.mission.misFile.marbleAttributes.jumpImpulse&&(this.jumpImpulse=It.parseNumber(this.level.mission.misFile.marbleAttributes.jumpImpulse)),void 0!==this.level.mission.misFile.marbleAttributes.bounceRestitution&&(this.bounceRestitution=It.parseNumber(this.level.mission.misFile.marbleAttributes.bounceRestitution));let s=void 0!==(null===(e=this.level.offlineSettings)||void 0===e?void 0:e.marbleTexture)?this.level.offlineSettings.marbleTexture:await Y.databaseGet("keyvalue","marbleTexture");if(s)try{let e=ne.getUrlToBlob(s);i=await ne.getTexture(e,"")}catch(e){console.error("Failed to load custom marble texture:",e)}else i=await ne.getTexture("shapes/balls/base.marble.png");let n=i.image.width===2*i.image.height;this.isReflective()&&(this.cubeMap=new Ei(he,128),this.cubeCamera=new Fi(.025,this.level.camera.far));const r=e=>{e.envMap=this.cubeMap,e.envMapZUp=!1,e.reflectivity=.7,e.useFresnel=!0,e.useAccurateReflectionRay=!0};if(n||"ultra"===this.level.mission.modification&&!s){let e=new bi;e.shareMaterials=!1,e.dtsPath="shapes/balls/pack1/pack1marble.dts",e.castShadows=!0,e.materialPostprocessor=(e=>{e.normalizeNormals=!0,e.flipY=!0,this.isReflective()&&r(e)}),s&&(e.matNamesOverride["base.marble"]=i),await e.init(this.level),this.innerGroup.add(e.group),this.ballShape=e}let a=Nt.createSphereGeometry(1,32,16),o=new Wt;o.diffuseMap=i,o.normalizeNormals=!0,o.flipY=!0,this.isReflective()&&r(o);let l=new Gt(a,[o]);l.castShadows=!0,this.sphere=l,this.innerGroup.add(l),this.body=new Kt,this.body.evaluationOrder=1e3;let h=new C(0);h.restitution=this.bounceRestitution,this.shape=h,this.body.addCollisionShape(h);let d=new C(0);d.collisionDetectionMask=2,d.collisionResponseMask=0,this.body.addCollisionShape(d);let c=new C(0);c.collisionDetectionMask=4,c.collisionResponseMask=0,this.body.addCollisionShape(c),h.broadphaseShape=d,c.broadphaseShape=d,this.largeAuxShape=d,this.smallAuxShape=c,this.body.onBeforeIntegrate=this.onBeforeIntegrate.bind(this),this.body.onAfterIntegrate=this.onAfterIntegrate.bind(this),this.body.onBeforeCollisionResponse=this.onBeforeCollisionResponse.bind(this),this.body.onAfterCollisionResponse=this.onAfterCollisionResponse.bind(this),this.body.orientation.setFromEuler(new Ui(Math.PI/2,7*Math.PI/6,0)),this.forcefield=new bi,this.forcefield.dtsPath="shapes/images/glow_bounce.dts",await this.forcefield.init(this.level),this.forcefield.setOpacity(0),this.forcefield.showSequences=!1,this.innerGroup.add(this.forcefield.group),this.helicopter=new bi,this.helicopter.dtsPath=Math.random()<.001?"shapes/images/glow_bounce.dts":"shapes/images/helicopter.dts",this.helicopter.castShadows=!0,await this.helicopter.init(this.level),this.helicopter.setOpacity(0),this.group.add(this.helicopter.group);let u=["jump.wav","bouncehard1.wav","bouncehard2.wav","bouncehard3.wav","bouncehard4.wav","rolling_hard.wav","sliding.wav"];this.level.mission.hasBlast&&u.push("blast.wav"),await this.level.audio.loadBuffers(u),this.rollingSound=this.level.audio.createAudioSource("rolling_hard.wav"),this.rollingSound.play(),this.rollingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingSound.setLoop(!0),this.level.mission.allElements.some(e=>{var t;return e._type===vt.Item&&"megamarbleitem"===(null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase())})&&(this.rollingMegaMarbleSound=this.level.audio.createAudioSource("mega_roll.wav"),this.rollingMegaMarbleSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingMegaMarbleSound.setLoop(!0)),this.slidingSound=this.level.audio.createAudioSource("sliding.wav"),this.slidingSound.play(),this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.slidingSound.setLoop(!0),await Promise.all([this.rollingSound.promise,this.slidingSound.promise,null===(t=this.rollingMegaMarbleSound)||void 0===t?void 0:t.promise])}isReflective(){var e;return void 0!==(null===(e=this.level.offlineSettings)||void 0===e?void 0:e.reflectiveMarble)?this.level.offlineSettings.reflectiveMarble:(2===Y.data.settings.marbleReflectivity||0===Y.data.settings.marbleReflectivity&&"ultra"===this.level.mission.modification)&&!I.isIOS()}findBestCollision(e){let t,i=-1/0;for(let s of this.body.collisions){if(s.s1!==this.shape)continue;let n=e(s);n>i&&(t=s,i=n)}if(!t)return null;let s=t.normal,n=t.s2;return t.s1!==this.body.shapes[0]&&(s.negate(),n=t.s2),{collision:t,contactNormal:s,contactShape:n,contactNormalUpDot:Math.abs(s.dot(this.level.currentUp))}}onBeforeIntegrate(s){var n;let r=!e.menu.finishScreen.showing,a=new i(0,0,0);Te("up")&&a.add(new i(1,0,0)),Te("down")&&a.add(new i(-1,0,0)),Te("left")&&a.add(new i(0,1,0)),Te("right")&&a.add(new i(0,-1,0)),a.add(new i(-Ie.marbleY,-Ie.marbleX)),Ye&&a.add(new i(-I.signedSquare(Ye.y),-I.signedSquare(Ye.x))),a.x>1&&(a.x=1),a.x<-1&&(a.x=-1),a.y>1&&(a.y=1),a.y<-1&&(a.y=-1),r||a.multiplyScalar(0);let o=a.length();a.multiplyScalar(5*qi*s),a.applyAxisAngle(new i(0,0,1),this.level.yaw);let l=this.level.newOrientationQuat;a.applyQuaternion(l),this.lastMovementVec.copy(a);let h=this.level.currentUp.clone().cross(a),d=this.findBestCollision(e=>e.normal.dot(this.level.currentUp));if(d){let{collision:e,contactNormal:i,contactNormalUpDot:n}=d,r=(new t).setFromUnitVectors(this.level.currentUp,i);h.applyQuaternion(r);let l=-a.clone().normalize().dot(i),c=Math.max(0,l-Math.max(0,e.s2Friction-1));h.multiplyScalar(1-c);let u=this.body.angularVelocity,m=h.clone().normalize(),p=Math.max(0,u.dot(m));u.addScaledVector(m,-p);let g=this.level.currentUp.clone().cross(i),f=Math.max(u.dot(g),0);if(u.addScaledVector(g,-f),u.multiplyScalar(.02**(Math.min(1,e.friction)*s)),u.addScaledVector(g,f),u.addScaledVector(m,p),u.length()>300*this.speedFac&&u.multiplyScalar(300*this.speedFac/u.length()),p+h.length()>12*Math.PI*2*o/n*this.speedFac){let e=Math.max(0,12*Math.PI*2*o/n*this.speedFac-p);h.normalize().multiplyScalar(e)}}else{h.multiplyScalar(.5);let e=this.level.timeState,t=a.clone(),i=e.currentAttemptTime-this.helicopterEnableTime<5e3?5:3.2;this.level.finishTime&&(i=0),t.multiplyScalar(i*s),this.body.linearVelocity.add(t),this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingSound.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02),null===(n=this.rollingMegaMarbleSound)||void 0===n||n.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02)}h.multiplyScalar(this.speedFac),I.addToVectorCapped(this.body.angularVelocity,h,120*this.speedFac),this.level.finishTime&&this.body.linearVelocity.multiplyScalar(.9),r&&this.level.heldPowerUp&&(Te("use")||this.level.useQueued)&&ke("use")&&(this.level.replay.recordUsePowerUp(this.level.heldPowerUp),this.level.heldPowerUp.use(0),this.level.useQueued=!1),r&&(Te("blast")||this.level.blastQueued)&&ke("blast")&&(this.useBlast(),this.level.blastQueued=!1),this.slidingTimeout--}onAfterIntegrate(){this.beforeVel.copy(this.body.linearVelocity),this.beforeAngVel.copy(this.body.angularVelocity);let e=this.level.timeState,t="playback"===this.level.replay.mode;if(e.currentAttemptTime<na&&!t){let{position:e}=this.level.getStartPositionAndOrientation(),t=this.body.position;t.x=e.x,t.y=e.y;let i=this.body.linearVelocity;i.x=i.y=0;let s=this.body.angularVelocity;s.length()>60&&s.normalize().multiplyScalar(60),this.shape.friction=0}else this.shape.friction=1}onBeforeCollisionResponse(){}onAfterCollisionResponse(){var t,i,s;let n=this.findBestCollision(e=>e.normal.dot(this.level.currentUp));if(!n)return;let{collision:r,contactNormal:a,contactShape:o,contactNormalUpDot:l}=n;this.lastContactNormal.copy(a);let h=this.beforeVel.clone().sub(o.body.linearVelocity),d=this.body.linearVelocity.clone().sub(o.body.linearVelocity),c=-a.dot(h.clone().normalize());if(l>.1&&this.slidingTimeout<=0&&c>.001&&c<=.5&&this.lastMovementVec.length()>0){let e=a.dot(d),t=this.body.linearVelocity,i=t.length();t.addScaledVector(a,-e);let s=t.length(),n=i-s;t.normalize().multiplyScalar(s+2*n)}e:if(r.restitution<.5){let e=-this.beforeVel.dot(a);if(e<0)break e;let t=this.beforeAngVel.clone().cross(a).multiplyScalar(2*(.5-r.restitution)*e/300/.98);this.body.linearVelocity.add(t)}let u=this.body.angularVelocity.clone().cross(a).multiplyScalar((1-Math.abs(l))*a.dot(this.body.linearVelocity)/(2*Math.PI)/15);if(u.length()>=.01){let e=this.body.linearVelocity,t=u.length()/e.length();e.multiplyScalar(1/(1+.5*t)).add(u)}l>1e-6&&!e.menu.finishScreen.showing&&(Te("jump")||this.level.jumpQueued)&&(this.setLinearVelocityInDirection(a,this.jumpImpulse+o.body.linearVelocity.dot(a),!0,()=>{this.playJumpSound(),this.level.replay.canStore&&this.level.replay.jumpSoundTimes.push(this.level.replay.currentTickIndex)}),this.level.jumpQueued=!1);let m=-this.findBestCollision(e=>-e.normal.dot(this.beforeVel.clone().sub(e.s2.body.linearVelocity))).contactNormal.dot(this.beforeVel.clone().sub(o.body.linearVelocity));m>6&&this.showBounceParticles();let p=I.clamp((m/12)**1.5,0,1);if(m>1&&(this.playBounceSound(p),this.level.replay.canStore&&this.level.replay.bounceTimes.push({tickIndex:this.level.replay.currentTickIndex,volume:p,showParticles:m>6})),a.dot(d)<.01){let e=this.body.angularVelocity.clone().cross(this.level.currentUp).multiplyScalar(1/Math.PI/2);if(e.dot(d)<-1e-5||e.length()>.5&&e.length()>1.5*d.length())this.slidingSound.gain.gain.setValueAtTime(.6,this.level.audio.currentTime),this.rollingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingMegaMarbleSound&&this.rollingMegaMarbleSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime);else{this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime);let e=.75*I.clamp(d.length()/15,0,1)+.75;this.rollingSound.gain.gain.linearRampToValueAtTime(I.clamp(e-.75,0,1),this.level.audio.currentTime+.02),null===(t=this.rollingMegaMarbleSound)||void 0===t||t.gain.gain.linearRampToValueAtTime(I.clamp(e-.75,0,1),this.level.audio.currentTime+.02),this.rollingSound.setPlaybackRate(e),null===(i=this.rollingMegaMarbleSound)||void 0===i||i.setPlaybackRate(e)}}else this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingSound.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02),null===(s=this.rollingMegaMarbleSound)||void 0===s||s.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02)}tick(e){var t,s,n,r,a,o;e.currentAttemptTime-this.shockAbsorberEnableTime<5e3?(this.forcefield.setOpacity(1),this.shape.restitution=.01,this.shockAbsorberSound||(this.shockAbsorberSound=this.level.audio.createAudioSource("superbounceactive.wav"),this.shockAbsorberSound.setLoop(!0),this.shockAbsorberSound.play())):e.currentAttemptTime-this.superBounceEnableTime<5e3?(this.forcefield.setOpacity(1),this.shape.restitution=.9,null===(t=this.shockAbsorberSound)||void 0===t||t.stop(),this.shockAbsorberSound=null):(this.forcefield.setOpacity(0),this.shape.restitution=this.bounceRestitution,null===(s=this.shockAbsorberSound)||void 0===s||s.stop(),this.shockAbsorberSound=null,null===(n=this.superBounceSound)||void 0===n||n.stop(),this.superBounceSound=null),e.currentAttemptTime-this.superBounceEnableTime<5e3&&!this.superBounceSound&&(this.superBounceSound=this.level.audio.createAudioSource("forcefield.wav"),this.superBounceSound.setLoop(!0),this.superBounceSound.play()),e.currentAttemptTime-this.helicopterEnableTime<5e3?(this.helicopter.setOpacity(1),this.helicopter.setTransform(new i(0,0,this.radius-Vi).applyQuaternion(this.level.newOrientationQuat),this.level.newOrientationQuat,new i(1,1,1)),this.level.setGravityIntensity(.25*this.level.defaultGravity),this.helicopterSound||(this.helicopterSound=this.level.audio.createAudioSource("use_gyrocopter.wav"),this.helicopterSound.setLoop(!0),this.helicopterSound.play())):(this.helicopter.setOpacity(0),this.level.setGravityIntensity(this.level.defaultGravity),null===(r=this.helicopterSound)||void 0===r||r.stop(),this.helicopterSound=null),this.radius!==Ni&&e.currentAttemptTime-this.megaMarbleEnableTime<1e4?(this.setRadius(Ni),this.body.linearVelocity.addScaledVector(this.level.currentUp,6),this.rollingSound.stop(),null===(a=this.rollingMegaMarbleSound)||void 0===a||a.play()):e.currentAttemptTime-this.megaMarbleEnableTime>=1e4&&(this.setRadius(this.level.mission.hasUltraMarble?Oi:Vi),this.rollingSound.play(),null===(o=this.rollingMegaMarbleSound)||void 0===o||o.stop())}playJumpSound(){this.level.audio.play(["jump.wav"])}playBounceSound(e){let t=this.radius===Ni?"mega_":"";this.level.audio.play(["bouncehard1.wav","bouncehard2.wav","bouncehard3.wav","bouncehard4.wav"].map(e=>t+e),e)}showBounceParticles(){this.level.particles.createEmitter(Gi,this.body.position,null,new i(1,1,1).addScaledVector(I.absVector(this.level.currentUp.clone()),-.8))}setLinearVelocityInDirection(e,t,i,s=(()=>{})){let n=this.body.linearVelocity.clone().normalize().dot(e)*this.body.linearVelocity.length();if(n<t||!i){let i=this.body.linearVelocity;i.addScaledVector(e,-n),i.addScaledVector(e,t),n<t&&s()}}calculatePredictiveTransforms(){var e;let i=this.body.position,s=this.body.orientation,n=this.body.linearVelocity,r=this.body.angularVelocity,a=i.clone().addScaledVector(n,1/ea).addScaledVector(this.level.world.gravity,1/ea**2/2),o=a.clone().sub(i),l=r.clone().multiplyScalar(1/ea),h=l.length(),d=(new t).setFromAxisAngle(l.normalize(),h).multiply(s),c=this.level.world.castShape(this.shape,o,1).find(e=>!this.body.collisions.some(t=>t.s2===e.shape)),u=null!==(e=null===c||void 0===c?void 0:c.lambda)&&void 0!==e?e:1;this.predictedPosition.lerpVectors(i,a,u),this.predictedOrientation.copy(s).slerp(d,u)}render(e){this.group.position.copy(this.body.position).lerp(this.predictedPosition,e.physicsTickCompletion),this.innerGroup.orientation.copy(this.body.orientation).slerp(this.predictedOrientation,e.physicsTickCompletion),this.group.recomputeTransform(),this.innerGroup.recomputeTransform(),this.forcefield.render(e),e.currentAttemptTime-this.helicopterEnableTime<5e3&&this.helicopter.render(e);let t=0;null!==this.teleportEnableTime&&(t=I.clamp((e.currentAttemptTime-this.teleportEnableTime)/ji,0,1)),null!==this.teleportDisableTime&&(t=I.clamp(1-(e.currentAttemptTime-this.teleportDisableTime)/ji,0,1)),this.sphere.opacity=t>0?I.lerp(1,.25,t):Number(!this.ballShape)}renderReflection(){this.isReflective()&&(this.cubeCamera.position.copy(this.group.position),this.cubeMap.render(this.level.scene,this.cubeCamera,4))}enableSuperBounce(e){this.superBounceEnableTime=e.currentAttemptTime}enableShockAbsorber(e){this.shockAbsorberEnableTime=e.currentAttemptTime}enableHelicopter(e){this.helicopterEnableTime=e.currentAttemptTime}enableTeleportingLook(e){let t=null!==this.teleportDisableTime?I.clamp((e.currentAttemptTime-this.teleportDisableTime)/ji,0,1):1;this.teleportEnableTime=e.currentAttemptTime-ji*(1-t),this.teleportDisableTime=null}disableTeleportingLook(e){var t;let i=null!==(t=I.clamp((e.currentAttemptTime-this.teleportEnableTime)/ji,0,1))&&void 0!==t?t:1;this.teleportDisableTime=e.currentAttemptTime-ji*(1-i),this.teleportEnableTime=null}enableMegaMarble(e){this.megaMarbleEnableTime=e.currentAttemptTime}useBlast(){if(this.level.blastAmount<.2||!this.level.mission.hasBlast)return;let e=this.level.currentUp.clone().multiplyScalar(10*Math.max(Math.sqrt(this.level.blastAmount),this.level.blastAmount));this.body.linearVelocity.add(e),this.level.audio.play("blast.wav"),this.level.particles.createEmitter(this.level.blastAmount>1?Hi:Wi,null,()=>this.body.position.clone().addScaledVector(this.level.currentUp,.4*-this.radius),new i(1,1,1).addScaledVector(I.absVector(this.level.currentUp.clone()),-.8)),this.level.blastAmount=0,this.level.replay.recordUseBlast()}setRadius(e){var s;this.radius!==e&&(this.radius=e,this.sphere.scale.setScalar(e),this.sphere.recomputeTransform(),null===(s=this.ballShape)||void 0===s||s.setTransform(new i,new t,(new i).setScalar(e/Vi)),this.shape.radius=e,this.shape.updateInertiaTensor(),this.largeAuxShape.radius=2*e,this.smallAuxShape.radius=e,this.body.syncShapes(),this.forcefield.group.scale.setScalar(this.radius/Vi),this.forcefield.group.recomputeTransform())}reset(){this.body.linearVelocity.setScalar(0),this.body.angularVelocity.setScalar(0),this.superBounceEnableTime=-1/0,this.shockAbsorberEnableTime=-1/0,this.helicopterEnableTime=-1/0,this.teleportEnableTime=null,this.teleportDisableTime=null,this.megaMarbleEnableTime=-1/0,this.lastContactNormal.set(0,0,0),this.beforeVel.set(0,0,0),this.beforeAngVel.set(0,0,0),this.slidingTimeout=0,this.predictedPosition.copy(this.body.position),this.predictedOrientation.copy(this.body.orientation),this.setRadius(this.level.mission.hasUltraMarble?Oi:Vi)}dispose(){var e;null===(e=this.cubeMap)||void 0===e||e.dispose()}}class Yi extends bi{constructor(){super(...arguments),this.dtsPath="shapes/pads/startarea.dts"}}class Qi extends bi{constructor(){super(...arguments),this.dtsPath="shapes/signs/finishlinesign.dts"}}class Ki extends bi{constructor(e){switch(super(),this.dtsPath="shapes/signs/plainsign.dts",this.shareMaterials=!1,e.datablock.slice("SignPlain".length).toLowerCase()){case"right":this.matNamesOverride["base.plainsign"]="right.plainsign";break;case"left":this.matNamesOverride["base.plainsign"]="left.plainsign";break;case"up":this.matNamesOverride["base.plainsign"]="up.plainsign";break;case"down":this.matNamesOverride["base.plainsign"]="down.plainsign"}}}class $i extends bi{constructor(e){if(super(),this.dtsPath="shapes/pads/endarea.dts",this.fireworks=[],this.sounds=["firewrks.wav"],this.inArea=0,!e)return;let s=new h;s.compose(new i(0,0,2.6),(new t).setFromEuler(new Ui(-Math.PI/2,0,0)),new i(1,1,1)),this.addCollider(e=>{let t=I.createCylinderConvexHull(1.7,2.4,64,new i(e.x,1,e.y));return t.margin=.005,t},e=>{let t=this.inArea>0;this.inArea=2,t||this.level.touchFinish(e)},s)}spawnFirework(e){let t=new ss(this.level,this.worldPosition,e.timeSinceLoad);this.fireworks.push(t),this.level.audio.play(this.sounds[0],1,void 0,this.worldPosition)}tick(e,t){if(!t){super.tick(e);for(let t of this.fireworks.slice())t.tick(e.timeSinceLoad),e.timeSinceLoad-t.spawnTime>=1e4&&I.removeFromArray(this.fireworks,t);this.inArea--}}}const Zi={ejectionPeriod:100,ambientVelocity:new i(0,0,1),ejectionVelocity:0,velocityVariance:0,emitterLifetime:4e3,spawnOffset(){let e=I.randomPointInUnitCircle();return new i(1.6*e.x,1.6*e.y,.4*Math.random()-.5)},inheritedVelFactor:0,particleOptions:{texture:"particles/saturn.png",blending:re.Normal,spinSpeed:0,spinRandomMin:-90,spinRandomMax:90,lifetime:2e3,lifetimeVariance:200,dragCoefficient:.5,acceleration:0,colors:[{r:1,g:1,b:0,a:0},{r:1,g:0,b:0,a:1},{r:1,g:0,b:0,a:0}],sizes:[.1,.2,.3],times:[0,.2,1]}},Ji={ejectionPeriod:30,ambientVelocity:new i(0,0,0),ejectionVelocity:0,velocityVariance:0,emitterLifetime:1e4,inheritedVelFactor:0,particleOptions:{texture:"particles/spark.png",blending:re.Normal,spinSpeed:0,spinRandomMin:-90,spinRandomMax:90,lifetime:600,lifetimeVariance:100,dragCoefficient:0,acceleration:0,colors:[{r:1,g:1,b:0,a:1},{r:1,g:0,b:0,a:1},{r:1,g:0,b:0,a:0}],sizes:[.1,.05,.01],times:[0,.5,1]}},es={ejectionPeriod:30,ambientVelocity:new i(0,0,0),ejectionVelocity:0,velocityVariance:0,emitterLifetime:1e4,inheritedVelFactor:0,particleOptions:{texture:"particles/spark.png",blending:re.Normal,spinSpeed:0,spinRandomMin:-90,spinRandomMax:90,lifetime:600,lifetimeVariance:100,dragCoefficient:0,acceleration:0,colors:[{r:0,g:0,b:1,a:1},{r:.5,g:.5,b:1,a:1},{r:1,g:1,b:1,a:0}],sizes:[.1,.05,.01],times:[0,.5,1]}},ts={ejectionPeriod:1,ambientVelocity:new i(0,0,0),ejectionVelocity:.8,velocityVariance:.25,emitterLifetime:10,inheritedVelFactor:0,particleOptions:{texture:"particles/star.png",blending:re.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:500,lifetimeVariance:50,dragCoefficient:.5,acceleration:0,colors:[{r:1,g:1,b:0,a:1},{r:1,g:1,b:0,a:1},{r:1,g:0,b:0,a:0}],sizes:[.2,.2,.2],times:[0,.5,1]}},is={ejectionPeriod:1,ambientVelocity:new i(0,0,0),ejectionVelocity:.5,velocityVariance:.25,emitterLifetime:10,inheritedVelFactor:0,particleOptions:{texture:"particles/bubble.png",blending:re.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:2e3,lifetimeVariance:200,dragCoefficient:0,acceleration:0,colors:[{r:0,g:0,b:1,a:1},{r:.5,g:.5,b:1,a:1},{r:1,g:1,b:1,a:0}],sizes:[.2,.2,.2],times:[0,.5,1]}};class ss extends E{constructor(e,t,i){super(),this.trails=[],this.wavesLeft=4,this.level=e,this.pos=t,this.spawnTime=i,this.level.particles.createEmitter(Zi,this.pos),this.doWave(this.spawnTime)}tick(e){this.tickSchedule(e);for(let t of this.trails.slice()){let s=I.clamp((e-t.spawnTime)/t.lifetime,0,1);s=1-(1-s)**2;let n=this.pos.clone().multiplyScalar(1-s).add(t.targetPos.clone().multiplyScalar(s));n.sub(new i(0,0,1).multiplyScalar(s**2)),t.smokeEmitter.setPos(n,e),1===s&&(this.level.particles.removeEmitter(t.smokeEmitter),I.removeFromArray(this.trails,t),"red"===t.type?this.level.particles.createEmitter(ts,n):this.level.particles.createEmitter(is,n))}}doWave(e){let t=Math.floor(17+10*Math.random());for(let i=0;i<t;i++)this.spawnTrail(e);if(this.wavesLeft--,this.wavesLeft>0){let t=e+500+1e3*Math.random();this.schedule(t,()=>this.doWave(t))}}spawnTrail(e){let t=Math.random()<.5?"red":"blue",s=250+2e3*Math.random(),n=.5+s/5e3,r=this.level.particles.createEmitter("red"===t?Ji:es,this.pos),a=I.randomPointInUnitCircle(),o={type:t,smokeEmitter:r,targetPos:new i(3*a.x,3*a.y,1+3*Math.sqrt(Math.random())).multiplyScalar(n).add(this.pos),spawnTime:e,lifetime:s};this.trails.push(o)}}const ns=["blue","red","yellow","purple","green","turquoise","orange","black"];class rs extends bi{constructor(e){super(),this.dtsPath="shapes/items/gem.dts",this.ambientRotate=!0,this.collideable=!1,this.pickedUp=!1,this.shareMaterials=!1,this.showSequences=!1,this.sounds=["gotgem.wav","gotallgems.wav","missinggems.wav"];let t=e.datablock.slice("GemItem".length);0===t.length&&(t=rs.pickRandomColor()),this.matNamesOverride["base.gem"]=t.toLowerCase()+".gem"}onMarbleInside(e){this.pickedUp||(this.pickedUp=!0,this.setOpacity(0),this.level.pickUpGem(e),this.level.replay.recordMarbleInside(this),this.setCollisionEnabled(!1))}reset(){super.reset(),this.pickedUp=!1,this.setOpacity(1),this.setCollisionEnabled(!0)}static pickRandomColor(){return I.randomFromArray(ns)}}const as=7e3;class os extends bi{constructor(e){super(),this.lastPickUpTime=null,this.cooldownDuration=as,this.autoUse=!1,this.ambientRotate=!0,this.collideable=!1,this.shareMaterials=!1,this.customPickUpAlert=null,this.an=!1,this.element=e}onMarbleInside(t){var i;let s=this.level.timeState;(null===this.lastPickUpTime||s.currentAttemptTime-this.lastPickUpTime>=this.cooldownDuration)&&this.pickUp()&&(this.level.replay.recordMarbleInside(this),this.lastPickUpTime=s.currentAttemptTime,this.autoUse&&this.use(t),e.menu.hud.displayAlert(null!==(i=this.customPickUpAlert)&&void 0!==i?i:`You picked up ${this.an?"an":"a"} ${this.pickUpName}!`),"1"!==this.element.showhelponpickup||this.autoUse||e.menu.hud.displayHelp(`Press <func:bind mousefire> to use the ${this.pickUpName}!`),this.bodies[0].enabled=!1)}tick(e,t){if(super.tick(e,t),t)return;let i=null===this.lastPickUpTime||e.currentAttemptTime-this.lastPickUpTime>=this.cooldownDuration;this.setCollisionEnabled(i)}render(e){super.render(e);let t=1;if(this.lastPickUpTime&&this.cooldownDuration>0){let i=this.lastPickUpTime+this.cooldownDuration;t=I.clamp((e.currentAttemptTime-i)/1e3,0,1)}this.setOpacity(t)}reset(){super.reset(),this.bodies[0].enabled=!0,this.lastPickUpTime=null}}class ls extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/superjump.dts",this.pickUpName="gold"===e.modification?"Super Jump PowerUp":"Jump Boost PowerUp",this.sounds=["pusuperjumpvoice.wav","dosuperjump.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){let e=this.level.marble;e.body.linearVelocity.addScaledVector(this.level.currentUp,20),this.level.audio.play(this.sounds[1]),this.level.particles.createEmitter(hs,null,()=>e.body.position.clone()),this.level.deselectPowerUp()}}const hs={ejectionPeriod:10,ambientVelocity:new i(0,0,.05),ejectionVelocity:.5,velocityVariance:.125,emitterLifetime:1e3,inheritedVelFactor:.1,particleOptions:{texture:"particles/twirl.png",blending:re.Additive,spinSpeed:90,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.25,acceleration:0,colors:[{r:0,g:.5,b:1,a:0},{r:0,g:.6,b:1,a:1},{r:0,g:.6,b:1,a:0}],sizes:[.25,.25,.5],times:[0,.75,1]}};class ds extends bi{constructor(e){switch(super(),this.dtsPath="shapes/signs/cautionsign.dts",this.shareMaterials=!1,e.datablock.slice("SignCaution".length).toLowerCase()){case"caution":this.matNamesOverride["base.cautionsign"]="caution.cautionsign";break;case"danger":this.matNamesOverride["base.cautionsign"]="danger.cautionsign"}}}class cs extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/superbounce.dts",this.pickUpName="gold"===e.modification?"Super Bounce PowerUp":"Marble Recoil PowerUp",this.sounds=["pusuperbouncevoice.wav","forcefield.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableSuperBounce(this.level.timeState),this.level.deselectPowerUp()}}class us extends bi{constructor(){super(...arguments),this.wiggleAnimationStart=-1/0,this.shareNodeTransforms=!1}get animationDuration(){return 1e3*this.dts.sequences[0].duration}onMarbleContact(e){let t=this.level.timeState;if(this.wiggleAnimationStart=t.timeSinceLoad,this.level.audio.play(this.sounds[0]),!e)return;let i=this.level.marble;i.setLinearVelocityInDirection(e.normal,15,!1),i.slidingTimeout=2,this.level.replay.recordMarbleContact(this)}render(e){let t=I.clamp((e.timeSinceLoad-this.wiggleAnimationStart)/this.animationDuration,0,1);this.sequenceKeyframeOverride.set(this.dts.sequences[0],t*(this.dts.sequences[0].numKeyframes-1)),super.render(e)}}class ms extends us{constructor(){super(...arguments),this.dtsPath="shapes/bumpers/pball_round.dts",this.sounds=["bumperding1.wav"]}}class ps extends os{constructor(){super(...arguments),this.dtsPath="shapes/images/helicopter.dts",this.showSequences=!1,this.shareNodeTransforms=!1,this.pickUpName="gold"===e.modification?"Gyrocopter PowerUp":"Helicopter PowerUp",this.sounds=["pugyrocoptervoice.wav","use_gyrocopter.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableHelicopter(this.level.timeState),this.level.deselectPowerUp()}}class gs extends bi{addConicForce(e,t,s){let n=t/2,r=s-s*(.7/e),a=e-.7;this.addCollider(()=>new C(e),(e,t)=>{let s=this.level.marble,o=new i(0,0,1);o.applyQuaternion(this.worldOrientation);let l=this.worldPosition.clone().sub(o.multiplyScalar(.7)),h=s.body.position.clone().sub(l);if(0===h.length())return;if(h.length()>a)return;let d=I.lerp(r,0,h.length()/a),c=o.angleTo(h);if(c>n/2)return;let u=Math.abs(-d*(c-n)*(c+n));u*=Math.sign(r);let m=h.clone();m.normalize(),s.body.linearVelocity.addScaledVector(m,u*t)},new h)}addConicForceExceptItsAccurateThisTime(e,t,i){this.addCollider(()=>new C(e),(s,n)=>{let r=this.computeAccurateConicForce(e,t,i);r.multiplyScalar(n),this.level.marble.body.linearVelocity.add(r)},new h)}computeAccurateConicForce(e,t,s){let n=this.level.marble.body.position,r=0,a=0,o=new i,l=new i,h=this.worldMatrix.clone(),d=new i(h.elements[4],h.elements[5],h.elements[6]);if(d.normalize(),e<(a=(o=n.clone().sub((new i).setFromMatrixPosition(h))).length()))return l;r=(1-a/e)*s,o.multiplyScalar(1/a);let c=d.dot(o),u=t;return u<c&&l.add(o.multiplyScalar(r).multiplyScalar(c-u).multiplyScalar(1/(1-u))),l}addSphericalForce(e,t){this.addCollider(()=>new C(e),(i,s)=>{let n=this.level.marble,r=n.body.position.clone().sub(this.worldPosition);if(0===r.length())return;let a=1-I.clamp(r.length()/e,0,1)**2;n.body.linearVelocity.addScaledVector(r.normalize(),t*a*s)},new h)}addFieldForce(e,t){this.addCollider(()=>new C(e),(i,s)=>{let n=this.level.marble;n.body.position.distanceTo(this.worldPosition)>=e||n.body.linearVelocity.addScaledVector(t,s)},new h)}}class fs extends gs{constructor(){super(),this.dtsPath="shapes/hazards/ductfan.dts",this.sounds=["fan_loop.wav"],this.addConicForce(10,2.617,40)}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}class ys extends os{constructor(t,i=!1){super(t),this.dtsPath="shapes/items/antigravity.dts",this.autoUse=!0,this.pickUpName="gold"===e.modification?"Gravity Modifier":"Gravity Defier",this.sounds=["gravitychange.wav"],i&&(this.cooldownDuration=-1/0)}pickUp(){let e=new i(0,0,-1);return e.applyQuaternion(this.worldOrientation).normalize(),!I.isSameVector(e,this.level.currentUp)}use(){let e=new i(0,0,-1);e.applyQuaternion(this.worldOrientation),this.level.setUp(e),this.level.audio.play(this.sounds[0])}}class bs extends bi{constructor(){super(...arguments),this.dtsPath="shapes/hazards/landmine.dts",this.disappearTime=-1/0,this.sounds=["explode1.wav"],this.shareMaterials=!1}onMarbleContact(){let e=this.level.timeState,t=this.level.marble,i=this.worldPosition,s=t.body.position.clone().sub(i),n=this.computeExplosionStrength(s.length());t.body.linearVelocity.addScaledVector(s.normalize(),n),t.slidingTimeout=2,this.disappearTime=e.timeSinceLoad,this.setCollisionEnabled(!1),this.level.audio.play(this.sounds[0]),this.level.particles.createEmitter(vs,this.worldPosition),this.level.particles.createEmitter(ws,this.worldPosition),this.level.particles.createEmitter(xs,this.worldPosition),this.level.replay.recordMarbleContact(this)}computeExplosionStrength(e){return e>=10.25?0:e>=10?I.lerp(30.0087,30.7555,e-10):(e-5)**2/-.285744888+87.5}tick(e,t){if(t)return;let i=e.timeSinceLoad>=this.disappearTime+5e3;this.setCollisionEnabled(i)}render(e){let t=I.clamp((e.timeSinceLoad-(this.disappearTime+5e3))/1e3,0,1);this.setOpacity(t)}}const vs={ejectionPeriod:.2,ambientVelocity:new i(0,0,0),ejectionVelocity:2,velocityVariance:1,emitterLifetime:50,inheritedVelFactor:.2,particleOptions:{texture:"particles/smoke.png",blending:re.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.8,acceleration:0,colors:[{r:.56,g:.36,b:.26,a:1},{r:.56,g:.36,b:.26,a:0}],sizes:[.5,1],times:[0,1]}},ws={ejectionPeriod:.5,ambientVelocity:new i(0,0,0),ejectionVelocity:.8,velocityVariance:.4,emitterLifetime:50,inheritedVelFactor:.25,particleOptions:{texture:"particles/smoke.png",blending:re.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1200,lifetimeVariance:300,dragCoefficient:.85,acceleration:-8,colors:[{r:.56,g:.36,b:.26,a:1},{r:.2,g:.2,b:.2,a:1},{r:0,g:0,b:0,a:0}],sizes:[1,1.5,2],times:[0,.5,1]}},xs={ejectionPeriod:.4,ambientVelocity:new i(0,0,0),ejectionVelocity:3.25,velocityVariance:1.6875,emitterLifetime:100,inheritedVelFactor:.2,particleOptions:{texture:"particles/spark.png",blending:re.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:500,lifetimeVariance:350,dragCoefficient:.75,acceleration:-8,colors:[{r:.6,g:.4,b:.3,a:1},{r:.6,g:.4,b:.3,a:1},{r:1,g:.4,b:.3,a:0}],sizes:[.5,.25,.25],times:[0,.5,1]}};class Ss extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/shockabsorber.dts",this.pickUpName="gold"===e.modification?"Shock Absorber PowerUp":"Anti-Recoil PowerUp",this.an="gold"!==e.modification,this.sounds=["pushockabsorbervoice.wav","superbounceactive.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableShockAbsorber(this.level.timeState),this.level.deselectPowerUp()}}class Ts extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/superspeed.dts",this.pickUpName="gold"===e.modification?"Super Speed PowerUp":"Speed Booster PowerUp",this.sounds=["pusuperspeedvoice.wav","dosuperspeed.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){let e=this.level,s=this.level.marble,n=new i(1,0,0);n.applyAxisAngle(new i(0,0,1),e.yaw);let r=e.newOrientationQuat;n.applyQuaternion(r);let a=new t;a.setFromUnitVectors(this.level.currentUp,s.lastContactNormal),n.applyQuaternion(a),s.body.linearVelocity.addScaledVector(n,24.7),this.level.audio.play(this.sounds[1]),this.level.particles.createEmitter(Ms,null,()=>s.body.position.clone()),this.level.deselectPowerUp()}}const Ms={ejectionPeriod:5,ambientVelocity:new i(0,0,.2),ejectionVelocity:.5,velocityVariance:.125,emitterLifetime:1100,inheritedVelFactor:.25,particleOptions:{texture:"particles/spark.png",blending:re.Additive,spinSpeed:0,spinRandomMin:0,spinRandomMax:0,lifetime:1500,lifetimeVariance:150,dragCoefficient:.25,acceleration:0,colors:[{r:.8,g:.8,b:0,a:0},{r:.8,g:.8,b:0,a:1},{r:.8,g:.8,b:0,a:0}],sizes:[.25,.25,1],times:[0,.25,1]}};class Cs extends os{constructor(t){super(t),this.dtsPath="shapes/items/timetravel.dts",this.cooldownDuration=1/0,this.autoUse=!0,this.timeBonus=5e3,this.sounds=["putimetravelvoice.wav","timetravelactive.wav"],this.pickUpName="",t.timebonus&&(this.timeBonus=It.parseNumber(t.timebonus)),t.timepenalty&&(this.timeBonus=-It.parseNumber(t.timepenalty)),"gold"===e.modification?this.pickUpName=`${this.timeBonus/1e3} second Time Travel bonus`:this.pickUpName=`${Math.abs(this.timeBonus/1e3)} second Time ${this.timeBonus>=0?"Modifier":"Penalty"}`}pickUp(){return this.level.audio.play(this.sounds[0]),!0}use(e){let t=1e3*(1-e)/ea;"playback"===this.level.replay.mode?t=this.level.replay.timeTravelTimeToRevert.get(this.id):this.level.replay.timeTravelTimeToRevert.set(this.id,t),this.level.addTimeTravelBonus(this.timeBonus,t)}}class ks extends gs{constructor(){super(),this.dtsPath="shapes/hazards/tornado.dts",this.collideable=!1,this.sounds=["tornado.wav"],this.addSphericalForce(8,-60),this.addSphericalForce(3,60),this.addFieldForce(3,new i(0,0,150))}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}const As=5e3;class _s extends bi{constructor(e){super(),this.dtsPath="shapes/hazards/trapdoor.dts",this.hasNonVisualSequences=!0,this.shareNodeTransforms=!1,this.lastContactTime=-1/0,this.timeout=0,this.lastCompletion=0,this.sounds=["trapdooropen.wav"],e.timeout&&(this.timeout=It.parseNumber(e.timeout))}get animationDuration(){return 1e3*this.dts.sequences[0].duration}tick(e,t){let i=this.getCurrentCompletion(e);if(this.sequenceKeyframeOverride.set(this.dts.sequences[0],i*(this.dts.sequences[0].numKeyframes-1)),super.tick(e,t),t)return;let s=Math.sign(i-this.lastCompletion);0!==s&&s!==this.lastDirection&&this.level.audio.play(this.sounds[0],void 0,void 0,this.worldPosition),this.lastCompletion=i,this.lastDirection=s}getCurrentCompletion(e){let t=e.timeSinceLoad-this.lastContactTime,i=I.clamp(t/this.animationDuration,0,1);return t>As&&(i=I.clamp(1-(t-As)/this.animationDuration,0,1)),i}onMarbleContact(){let e=this.level.timeState;if(e.timeSinceLoad-this.lastContactTime<=0)return;let t=this.getCurrentCompletion(e);this.lastContactTime=e.timeSinceLoad-t*this.animationDuration,0===t&&(this.lastContactTime+=this.timeout),this.level.replay.recordMarbleContact(this)}}class Is extends us{constructor(){super(...arguments),this.dtsPath="shapes/bumpers/pball_tri.dts",this.sounds=["bumper1.wav"]}}class Es extends bi{constructor(){super(...arguments),this.dtsPath="shapes/hazards/oilslick.dts",this.friction=ni.friction_none}}class Bs extends gs{constructor(){super(),this.dtsPath="shapes/hazards/ductfan.dts",this.sounds=["fan_loop.wav"],this.addConicForce(5,2.617,10)}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}class Ps{constructor(e,t){this.sounds=[],this.isCurrentlyColliding=!1,this.id=e._id,this.element=e,this.level=t;let s=It.parseNumberList(e.polyhedron),n=new i(s[0],s[1],s[2]),a=new i(s[3],s[4],s[5]),o=new i(s[6],s[7],s[8]),l=new i(s[9],s[10],s[11]),d=n.clone(),c=n.clone().add(a),u=n.clone().add(o),m=n.clone().add(l),p=n.clone().add(a).add(o),g=n.clone().add(a).add(l),f=n.clone().add(o).add(l),y=n.clone().add(a).add(o).add(l),b=new h;b.compose(It.parseVector3(e.position),It.parseRotation(e.rotation),It.parseVector3(e.scale));let v=[d,c,u,m,p,g,f,y].map(e=>e.applyMatrix4(b));this.vertices=v;let w=(new r).setFromPoints(v),x=I.getBoxVertices(w),S=new k(x);S.collisionDetectionMask=4;let T=new Kt;T.type=Ht.Static,T.addCollisionShape(S),this.body=T,T.onBeforeIntegrate=(()=>{this.isCurrentlyColliding&&0===T.collisions.length&&(this.isCurrentlyColliding=!1,this.onMarbleLeave())}),T.onBeforeCollisionResponse=(()=>{this.isCurrentlyColliding||this.onMarbleEnter(),this.onMarbleInside(),this.isCurrentlyColliding=!0}),this.reset()}async init(){for(let e of this.sounds)await this.level.audio.loadBuffer(e)}reset(){this.isCurrentlyColliding=!1}onMarbleInside(){}onMarbleEnter(){}onMarbleLeave(){}tick(e){}}class Ls extends Ps{constructor(e,t){super(e,t.level),this.interior=t}onMarbleEnter(){let e=this.level.timeState;this.interior.setTargetTime(e,It.parseNumber(this.element.targettime)),"1"===this.element.instant&&(this.element.icontinuetottime&&"0"!==this.element.icontinuetottime?(this.interior.currentTime=this.interior.targetTime,this.interior.targetTime=It.parseNumber(this.element.icontinuetottime)):this.interior.changeTime=-1/0),this.level.replay.recordMarbleEnter(this)}}let Rs=new i,Fs=new h;class zs extends ui{constructor(){super(...arguments),this.triggers=[],this.currentTime=0,this.targetTime=0,this.changeTime=0,this.prevPosition=new i,this.currentPosition=new i,this.allowSpecialMaterials=!1}static async createFromSimGroup(e,t){let i=e.elements.find(e=>e._type===vt.PathedInterior),{dif:s,path:n}=await t.mission.getDif(i.interiorresource);if(!s)return null;let r=new zs(s,n,t,It.parseNumber(i.interiorindex));return r.simGroup=e,r.element=i,t.interiors.push(r),await I.wait(10),await r.init(i._id),r}async init(e){var t;await super.init(e),this.basePosition=It.parseVector3(this.element.baseposition),this.baseOrientation=It.parseRotation(this.element.baserotation),this.baseScale=It.parseVector3(this.element.basescale),this.hasCollision=0!==this.baseScale.x&&0!==this.baseScale.y&&0!==this.baseScale.z,0===this.baseScale.x&&(this.baseScale.x=1e-4),0===this.baseScale.y&&(this.baseScale.y=1e-4),0===this.baseScale.z&&(this.baseScale.z=1e-4),this.body.onBeforeIntegrate=this.onBeforeIntegrate.bind(this),this.body.orientation.copy(this.baseOrientation);for(let e=0;e<this.detailLevel.convexHulls.length;e++)this.addConvexHull(e,this.baseScale);this.path=this.simGroup.elements.find(e=>e._type===vt.Path),this.markerData=this.path.markers.map(e=>({msToNext:It.parseNumber(e.mstonext),smoothingType:e.smoothingtype,position:It.parseVector3(e.position),rotation:It.parseRotation(e.rotation)})),It.parseBoolean(this.path.isLooping)&&this.markerData.push(this.markerData[0]),this.computeDuration();let s=this.simGroup.elements.filter(e=>e._type===vt.Trigger);for(let e of s){if(!e.targettime)continue;let t=new Ls(e,this);this.triggers.push(t)}"pathedmovingblock"===(null===(t=this.element.datablock)||void 0===t?void 0:t.toLowerCase())&&(this.soundPosition=new i,this.soundSource=this.level.audio.createAudioSource("movingblockloop.wav",void 0,this.soundPosition),this.soundSource.setLoop(!0),await this.soundSource.promise),this.reset()}async onLevelStart(){var e;null===(e=this.soundSource)||void 0===e||e.play()}computeDuration(){let e=0;for(let t=0;t<this.markerData.length-1;t++)e+=this.markerData[t].msToNext;this.duration=e}setTargetTime(e,t){let i=this.getInternalTime(e.currentAttemptTime);this.currentTime=i,this.targetTime=t,this.changeTime=e.currentAttemptTime}getInternalTime(e){if(this.targetTime<0){let t=-1===this.targetTime?1:-2===this.targetTime?-1:0;return I.adjustedMod(this.currentTime+(e-this.changeTime)*t,this.duration)}{let t=Math.abs(this.currentTime-this.targetTime),i=I.clamp(t?(e-this.changeTime)/t:1,0,1);return I.clamp(I.lerp(this.currentTime,this.targetTime,i),0,this.duration)}}tick(e){var t,s,n;this.body.position.copy(this.currentPosition);let r=this.getTransformAtTime(Fs,this.getInternalTime(e.currentAttemptTime));this.prevPosition.copy(this.currentPosition),this.currentPosition.setFromMatrixPosition(r);let a=Rs.copy(this.currentPosition).sub(this.prevPosition).multiplyScalar(ea);this.body.linearVelocity.copy(a),null===(t=this.soundPosition)||void 0===t||t.copy(this.currentPosition).add(null!==(n=null===(s=this.markerData[0])||void 0===s?void 0:s.position)&&void 0!==n?n:new i)}onBeforeIntegrate(){this.body.position.copy(this.currentPosition),this.body.syncShapes()}getTransformAtTime(e,t){let i=this.markerData[0],s=this.markerData[1];if(!i)return e.compose(this.basePosition,this.baseOrientation,this.baseScale),e;let n=i.msToNext,r=2;for(;n<t&&r<this.markerData.length;)i=s,s=this.markerData[r++],n+=i.msToNext;s||(s=i);let a,o=n-i.msToNext,l=n-o,h=I.clamp(l?(t-o)/l:1,0,1);if("Accelerate"===i.smoothingType)h=.5*Math.sin(h*Math.PI-Math.PI/2)+.5;else if("Spline"===i.smoothingType){let e=r-2-1,t=r-1+1;t>=this.path.markers.length&&(t=0),e<0&&(e=this.path.markers.length-1);let n=this.markerData[e].position,o=i.position,l=s.position,d=this.markerData[t].position;(a=Rs).x=I.catmullRom(h,n.x,o.x,l.x,d.x),a.y=I.catmullRom(h,n.y,o.y,l.y,d.y),a.z=I.catmullRom(h,n.z,o.z,l.z,d.z)}if(!a){let e=i.position,t=s.position;a=Rs.copy(e).lerp(t,h)}let d=this.markerData[0].position;return a.sub(d),a.add(this.basePosition),e.compose(a,this.baseOrientation,this.baseScale),e}render(e){let t=this.getTransformAtTime(Fs,this.getInternalTime(e.currentAttemptTime));this.mesh.transform.copy(t),this.mesh.changedTransform(),this.body.position.setFromMatrixPosition(t),this.body.syncShapes()}reset(){var e,t,s;this.currentTime=0,this.targetTime=0,this.changeTime=0,this.element.initialposition&&(this.currentTime=It.parseNumber(this.element.initialposition)),this.element.initialtargetposition&&(this.targetTime=It.parseNumber(this.element.initialtargetposition),this.targetTime>0&&this.targetTime<50&&(this.currentTime=this.duration));let n=this.getTransformAtTime(Fs,this.getInternalTime(0));this.prevPosition.setFromMatrixPosition(n),this.currentPosition.setFromMatrixPosition(n),this.body.position.copy(this.currentPosition),this.body.syncShapes(),null===(e=this.soundPosition)||void 0===e||e.copy(this.currentPosition).add(null!==(s=null===(t=this.markerData[0])||void 0===t?void 0:t.position)&&void 0!==s?s:new i)}}class Ds extends Ps{onMarbleLeave(){this.level.goOutOfBounds(),this.level.replay.recordMarbleLeave(this)}}class Us extends Ps{constructor(){super(...arguments),this.sounds=["infotutorial.wav"]}onMarbleEnter(){this.element.text&&e.menu.hud.displayHelp(this.element.text,!0),this.level.replay.recordMarbleEnter(this)}}class Vs extends Ps{onMarbleInside(){this.level.goOutOfBounds(),this.level.replay.recordMarbleInside(this)}}const Os=5e3;class Ns extends bi{constructor(){super(...arguments),this.dtsPath="shapes/buttons/pushbutton.dts",this.lastContactTime=-1/0,this.shareNodeTransforms=!1}get animationDuration(){return 1e3*this.dts.sequences[0].duration}tick(e,t){let i=this.getCurrentCompletion(e);this.sequenceKeyframeOverride.set(this.dts.sequences[0],i*(this.dts.sequences[0].numKeyframes-1)),super.tick(e,t)}getCurrentCompletion(e){let t=e.timeSinceLoad-this.lastContactTime,i=I.clamp(t/this.animationDuration,0,1);return t>Os&&(i=I.clamp(1-(t-Os)/this.animationDuration,0,1)),i}onMarbleContact(){let e=this.level.timeState;0===this.getCurrentCompletion(e)&&(this.lastContactTime=e.timeSinceLoad),this.level.replay.recordMarbleContact(this)}}class qs extends bi{constructor(e){if(super(),this.dtsPath="shapes/signs/sign.dts","arrow"!==e.datablock.toLowerCase())switch(e.datablock.slice("Sign".length).toLowerCase()){case"":this.dtsPath="shapes/signs/sign.dts";break;case"down":this.dtsPath="shapes/signs/signdown.dts";break;case"up":this.dtsPath="shapes/signs/signup.dts";break;case"side":this.dtsPath="shapes/signs/signside.dts";break;case"downside":this.dtsPath="shapes/signs/signdown-side.dts";break;case"upside":this.dtsPath="shapes/signs/signup-side.dts"}}}class js extends gs{constructor(){super(),this.dtsPath="shapes/hazards/magnet/magnet.dts",this.collideable=!1,this.sounds=["magnet.wav"],this.addConicForceExceptItsAccurateThisTime(10,.7,-90)}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}class Gs extends bi{constructor(){super(...arguments),this.dtsPath="shapes/hazards/nuke/nuke.dts",this.disappearTime=-1/0,this.sounds=["nukeexplode.wav"],this.shareMaterials=!1}onMarbleContact(){let e=this.level.timeState,t=this.level.marble,i=this.worldPosition,s=this.computeExplosionForce(t.body.position.clone().sub(i));t.body.linearVelocity.add(s),t.slidingTimeout=2,this.disappearTime=e.timeSinceLoad,this.setCollisionEnabled(!1),this.level.audio.play(this.sounds[0]),this.level.particles.createEmitter(Ws,this.worldPosition),this.level.particles.createEmitter(Hs,this.worldPosition),this.level.particles.createEmitter(Xs,this.worldPosition),this.level.replay.recordMarbleContact(this)}computeExplosionForce(e){let t=e.length();if(t<10){let i=100*(1-t/10);e.multiplyScalar(i)}return e}tick(e,t){if(t)return;let i=e.timeSinceLoad>=this.disappearTime+15e3;this.setCollisionEnabled(i)}render(e){let t=I.clamp((e.timeSinceLoad-(this.disappearTime+15e3))/1e3,0,1);this.setOpacity(t)}}const Ws={ejectionPeriod:.2,ambientVelocity:new i(0,0,0),ejectionVelocity:2,velocityVariance:1,emitterLifetime:50,inheritedVelFactor:.2,particleOptions:{texture:"particles/smoke.png",blending:re.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.8,acceleration:0,colors:[{r:.56,g:.36,b:.26,a:1},{r:.56,g:.36,b:.26,a:0}],sizes:[.5,1],times:[0,1]}},Hs={ejectionPeriod:.5,ambientVelocity:new i(0,0,0),ejectionVelocity:1.3,velocityVariance:.5,emitterLifetime:50,inheritedVelFactor:.25,particleOptions:{texture:"particles/smoke.png",blending:re.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:2500,lifetimeVariance:300,dragCoefficient:.7,acceleration:-8,colors:[{r:.56,g:.36,b:.26,a:1},{r:.2,g:.2,b:.2,a:.85},{r:0,g:0,b:0,a:0}],sizes:[1,1.5,2],times:[0,.5,1]}},Xs={ejectionPeriod:1.7,ambientVelocity:new i(0,-.5,0),ejectionVelocity:13/1.5,velocityVariance:5,emitterLifetime:5e3,inheritedVelFactor:.2,particleOptions:{texture:"particles/spark.png",blending:re.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:4500,lifetimeVariance:2500,dragCoefficient:.5,acceleration:0,colors:[{r:.6,g:.4,b:.3,a:1},{r:.6,g:.4,b:.3,a:1},{r:1,g:.4,b:.3,a:0}],sizes:[.5,.4,.2],times:[0,.5,1]}};class Ys extends Ps{}class Qs extends Ps{constructor(e,t){super(e,t),this.delay=2e3,this.entryTime=null,this.exitTime=null,this.sounds=["teleport.wav"],this.teleportingSound=null,e.delay&&(this.delay=It.parseNumber(e.delay))}onMarbleEnter(){let t=this.level.timeState;this.exitTime=null,this.level.marble.enableTeleportingLook(t),this.level.replay.recordMarbleEnter(this),null===this.entryTime&&(this.entryTime=t.currentAttemptTime,e.menu.hud.displayAlert("Teleporter has been activated, please wait."),this.teleportingSound=this.level.audio.createAudioSource("teleport.wav"),this.teleportingSound.play())}onMarbleLeave(){let e=this.level.timeState;this.exitTime=e.currentAttemptTime,this.level.marble.disableTeleportingLook(e),this.level.replay.recordMarbleLeave(this)}tick(e){if(null!==this.entryTime){if(!(e.currentAttemptTime-this.entryTime>=this.delay))return null!==this.exitTime&&e.currentAttemptTime-this.exitTime>50?(this.entryTime=null,void(this.exitTime=null)):void 0;this.executeTeleport()}}executeTeleport(){var e;this.entryTime=null;let t=this.level.triggers.find(e=>{var t;return e instanceof Ys&&e.element._name.toLowerCase()===(null===(t=this.element.destination)||void 0===t?void 0:t.toLowerCase())});if(!t)return;let s,n=this.level.marble.body;if(s=It.parseBoolean(this.element.centerdestpoint||t.element.centerdestpoint)?t.vertices[0].clone().lerp(t.vertices[7],.5):t.vertices[0].clone().add(new i(0,0,3)),n.position.copy(s),n.prevPosition.copy(s),It.parseBoolean(this.element.keepvelocity||t.element.keepvelocity)||n.linearVelocity.setScalar(0),It.parseBoolean(this.element.inversevelocity||t.element.inversevelocity)&&n.linearVelocity.negate(),It.parseBoolean(this.element.keepangular||t.element.keepangular)||n.angularVelocity.setScalar(0),!It.parseBoolean(this.element.keepcamera||t.element.keepcamera)){let e;e=-(e=this.element.camerayaw?I.degToRad(It.parseNumber(this.element.camerayaw)):t.element.camerayaw?I.degToRad(It.parseNumber(t.element.camerayaw)):0),this.level.yaw=e+Math.PI/2,this.level.pitch=ra}this.level.audio.play("spawn.wav"),null===(e=this.teleportingSound)||void 0===e||e.stop(),this.teleportingSound=null}reset(){super.reset(),this.entryTime=null,this.exitTime=null}}class Ks extends bi{constructor(){super(...arguments),this.dtsPath="shapes/buttons/checkpoint.dts",this.sounds=["checkpoint.wav"]}onMarbleContact(){this.level.saveCheckpointState(this),this.level.replay.recordMarbleContact(this)}}class $s extends Ps{constructor(){super(...arguments),this.sounds=["checkpoint.wav"]}onMarbleEnter(){let e=this.level.shapes.find(e=>{var t,i;return(null===(t=e.srcElement)||void 0===t?void 0:t._name.toLowerCase())===(null===(i=this.element.respawnpoint)||void 0===i?void 0:i.toLowerCase())});e&&(this.level.saveCheckpointState(e,this),this.level.replay.recordMarbleEnter(this))}}class Zs extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/easteregg.dts",this.cooldownDuration=1/0,this.autoUse=!0,this.sounds=["easter.wav","easterfound.wav"],this.pickUpName=""}pickUp(){let t=Y.data.collectedEggs.includes(this.level.mission.path);return t||(Y.data.collectedEggs.push(this.level.mission.path),Y.store(),e.menu.levelSelect.displayMission()),this.level.audio.play(this.sounds[Number(t)]),this.customPickUpAlert=t?"You already found this Easter Egg.":"You found an Easter Egg!",!0}use(){}}const Js=[ls,Ts,ps,cs,Ss,Cs];class en extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/random.dts",this.sounds=Js.map(e=>new e(this.element).sounds).flat(),this.pickedUpCount=0,this.pickUpName=""}pickUp(){for(;;){let e,t=new(e="record"===this.level.replay.mode?Js[Math.floor(6*Math.random())]:Js[this.level.replay.randomPowerUpChoices.get(this.id)[this.pickedUpCount]])(this.element);if(t.level=this.level,t.id=this.id,t.pickUp()){if(this.pickUpName=t.pickUpName,this.customPickUpAlert=t.customPickUpAlert,this.an=t.an,this.autoUse=t.autoUse,this.cooldownDuration=t.cooldownDuration,this.lastInstance=t,this.pickedUpCount++,"record"===this.level.replay.mode){let t=this.level.replay.randomPowerUpChoices.get(this.id);t||(t=[],this.level.replay.randomPowerUpChoices.set(this.id,t)),t.push(Js.indexOf(e))}return!0}}}use(e){this.lastInstance.use(e)}getAllDtsPaths(){return Js.map(e=>new e(this.element).dtsPath)}reset(){super.reset(),this.pickedUpCount=0}}class tn{constructor(t){this.preventClose=!1,this.initProperties(),t.setupButton(this.yesButton,this.yesSrc,()=>{e.level&&e.level.stopAndExit()}),t.setupButton(this.noButton,this.noSrc,()=>e.level.unpause()),t.setupButton(this.restartButton,this.restartSrc,()=>{e.level.unpause(),e.level.restart(!0)}),window.addEventListener("keydown",i=>{e.level&&!e.level.offline&&e.menu===t&&("Escape"===i.key?e.level.paused?this.preventClose||(this.noButton.src=t.uiAssetPath+this.noSrc+"_d.png"):e.level.pause():i.code===Y.data.settings.gameButtonMapping.restart&&e.level.paused&&(this.restartButton.click(),e.level.pressingRestart=!0))}),window.addEventListener("keyup",i=>{e.level&&!e.level.offline&&e.menu===t&&e.level.paused&&"Escape"===i.key&&this.noButton.src.endsWith("_d.png")&&(this.noButton.src=t.uiAssetPath+this.noSrc+"_n.png",e.level.unpause())})}show(){this.div.classList.remove("hidden"),ye(!0)}hide(){this.div.classList.add("hidden"),ye(!1)}async onReplayButtonClick(t){let i=e.level;if(t){let t=await i.replay.serialize();ua.download(t,i.mission,!1,!0),I.isTouchDevice&&I.isInFullscreen()&&e.menu.showAlertPopup("Downloaded","The .wrec has been downloaded.")}else{if(!await e.menu.showConfirmPopup("Confirm","Do you want to watch this replay? Note that you can only watch it once. If you want to watch it more often, download it first. (alt-click (or long-press on touch devices))"))return;i.replay.mode="playback",this.restartButton.click()}}handleGamepadInput(t){t.buttons[0].value>.5&&!Le[0]&&(e.level.stopAndExit(),ft.play("buttonpress.wav")),t.buttons[1].value>.5&&!Le[1]&&(e.level.unpause(),ft.play("buttonpress.wav")),t.buttons[9].value>.5&&!Le[9]&&(e.level.unpause(),Ae("pause"),ft.play("buttonpress.wav")),t.buttons[8].value>.5&&!Le[8]&&(e.level.unpause(),e.level.restart(!0),e.level.pressingRestart=!0,ft.play("buttonpress.wav"))}}class sn extends tn{constructor(e){super(e),this.jukeboxButton=document.querySelector("#mbp-pause-jukebox"),e.setupButton(this.replayButton,"play/replay",e=>this.onReplayButtonClick(e.altKey)),I.onLongTouch(this.replayButton,()=>this.onReplayButtonClick(!0)),this.jukebox=new rn(e),e.setupButton(this.jukeboxButton,"jukebox/jb_pausemenu",()=>{this.jukebox.show()},void 0,void 0,!1)}initProperties(){this.div=document.querySelector("#mbp-pause-screen"),this.yesButton=document.querySelector("#mbp-pause-yes"),this.noButton=document.querySelector("#mbp-pause-no"),this.restartButton=document.querySelector("#mbp-pause-restart"),this.replayButton=document.querySelector("#mbp-pause-replay"),this.yesSrc="exit/yes",this.noSrc="exit/no",this.restartSrc="exit/restart"}}const nn={"astrolabe.ogg":"Astrolabe","beach party.ogg":"Beach Party","challenge.ogg":"Challenge","classic vibe.ogg":"Classic Vibe","comforting mystery.ogg":"Comforting Mystery","endurance.ogg":"Endurance","flanked.ogg":"Flanked","groove police.ogg":"Groove Police","grudge.ogg":"Grudge","mbp old shell.ogg":"MBP Old Shell","metropolis.ogg":"Metropolis","pianoforte.ogg":"Pianoforte","quiet lab.ogg":"Quiet Lab","rising temper.ogg":"Rising Temper","seaside revisited.ogg":"Seaside Revisited","shell.ogg":"Shell","the race.ogg":"The Race","tim trance.ogg":"Tim Trance","xmas trance.ogg":"Xmas Trance"};class rn{constructor(t){this.div=document.querySelector("#jukebox"),this.songsContainer=document.querySelector("#jukebox-songs"),this.textElement=document.querySelector("#jukebox-text"),this.closeButton=document.querySelector("#jukebox-close"),this.prevButton=document.querySelector("#jukebox-prev"),this.playButton=document.querySelector("#jukebox-play"),this.nextButton=document.querySelector("#jukebox-next"),this.selectedIndex=null,this._playing=!0,this.menu=t,t.setupButton(this.closeButton,"jukebox/close",()=>this.hide()),t.setupButton(this.prevButton,"play/prev",()=>this.select(Object.keys(nn)[this.selectedIndex-1]),!0),t.setupVaryingButton(this.playButton,["jukebox/stop","jukebox/play"],()=>{var t,i;this.playing?(null===(t=e.level.music)||void 0===t||t.stop(),this.playing=!1):null!==this.selectedIndex?this.select(Object.keys(nn)[this.selectedIndex]):(null===(i=e.level.music)||void 0===i||i.play(),this.playing=!0),this.updateText()}),t.setupButton(this.nextButton,"play/next",()=>this.select(Object.keys(nn)[this.selectedIndex+1]),!0),window.addEventListener("keydown",e=>{this.div.classList.contains("hidden")||"Escape"!==e.key||(this.closeButton.src=t.uiAssetPath+"jukebox/close_d.png")}),window.addEventListener("keyup",e=>{this.div.classList.contains("hidden")||"Escape"!==e.key||(this.closeButton.src=t.uiAssetPath+"jukebox/close_n.png",this.hide())});for(let e in nn){let t=document.createElement("div");t.textContent=nn[e],this.songsContainer.appendChild(t),t.addEventListener("mousedown",()=>this.select(e))}}get playing(){return this._playing}set playing(e){this._playing=e,this.menu.setButtonVariant(this.playButton,1-Number(e))}select(t){if(!nn[t])return;let i=Object.keys(nn).indexOf(t);this.selectedIndex=i;for(let e=0;e<this.songsContainer.children.length;e++)this.songsContainer.children[e].classList.remove("selected"),e===i&&this.songsContainer.children[e].classList.add("selected");let s=e.level;s.music&&s.music.stop(),s.music=s.audio.createAudioSource("music/"+t,s.audio.musicGain,void 0,!0),s.music.setLoop(!0),s.music.play(),this.playing=!0,this.updateNextPrevButtons(),this.updateText()}updateNextPrevButtons(){null===this.selectedIndex||this.selectedIndex===Object.keys(nn).length-1?(this.nextButton.src=this.menu.uiAssetPath+"play/next_i.png",this.nextButton.style.pointerEvents="none"):(this.nextButton.src.endsWith("i.png")&&(this.nextButton.src=this.menu.uiAssetPath+"play/next_n.png"),this.nextButton.style.pointerEvents=""),null===this.selectedIndex||0===this.selectedIndex?(this.prevButton.src=this.menu.uiAssetPath+"play/prev_i.png",this.prevButton.style.pointerEvents="none"):(this.prevButton.src.endsWith("i.png")&&(this.prevButton.src=this.menu.uiAssetPath+"play/prev_n.png"),this.prevButton.style.pointerEvents="")}updateText(){null===this.selectedIndex?this.textElement.innerHTML="":this.textElement.innerHTML=`Title: ${nn[Object.keys(nn)[this.selectedIndex]]}<br>${this.playing?"Playing":"Stopped"}`}show(){if(this.div.classList.remove("hidden"),e.menu.pauseScreen.preventClose=!0,null===this.selectedIndex){for(let e of this.songsContainer.children)e.classList.remove("selected");let t=Object.keys(nn).indexOf(e.level.originalMusicName);t>=0&&(this.songsContainer.children[t].classList.add("selected"),this.selectedIndex=t),this.playing=!0,this.updateNextPrevButtons(),this.updateText()}let t=[...this.songsContainer.children].find(e=>e.classList.contains("selected"));t&&t.scrollIntoView({block:"nearest",inline:"nearest"})}hide(){this.div.classList.add("hidden"),e.menu.pauseScreen.preventClose=!1}reset(){this.selectedIndex=null}}const an={up:"Move Forward",down:"Move Backward",left:"Move Left",right:"Move Right",use:"Use PowerUp",jump:"Jump",cameraUp:"Rotate Camera Up",cameraDown:"Rotate Camera Down",cameraLeft:"Rotate Camera Left",cameraRight:"Rotate Camera Right",freeLook:"Free Look",restart:"Restart",blast:"Use Blast"},on={up:"Move Forward",down:"Move Backward",left:"Move Left",right:"Move Right",use:"Use PowerUp",jump:"Jump",cameraUp:"Look Up",cameraDown:"Look Down",cameraLeft:"Look Left",cameraRight:"Look Right",freeLook:"Free Look",restart:"Respawn",blast:"Use Blast"};class ln{constructor(t){this.currentlyRebinding=null,this.rebindValue=null,this.rebindConfirmWarningEnding="Do you want to undo this<br>mapping?",this.menu=t,this.initProperties(),t.setupButton(this.homeButton,this.homeButtonSrc,()=>{this.hide(),t.home.show()},void 0,void 0,"gold"===e.modification),window.addEventListener("keydown",e=>{this.currentlyRebinding&&!this.rebindValue&&("Escape"===e.code?(this.currentlyRebinding=null,this.rebindDialog.classList.add("hidden")):this.setKeybinding(this.currentlyRebinding,e.code))}),window.addEventListener("mousedown",e=>{if(!this.currentlyRebinding||this.rebindValue)return;let t=["LMB","MMB","RMB"][e.button];t&&this.setKeybinding(this.currentlyRebinding,t)}),t.setupButton(this.rebindConfirmYes,this.rebindConfirmYesSrc,()=>{for(let e in Y.data.settings.gameButtonMapping){let t=e;Y.data.settings.gameButtonMapping[t]===this.rebindValue&&(Y.data.settings.gameButtonMapping[t]="")}Y.data.settings.gameButtonMapping[this.currentlyRebinding]=this.rebindValue,Y.store(),this.currentlyRebinding=null,this.rebindValue=null,this.rebindConfirm.classList.add("hidden"),this.refreshKeybindings()}),t.setupButton(this.rebindConfirmNo,this.rebindConfirmNoSrc,()=>{this.currentlyRebinding=null,this.rebindValue=null,this.rebindConfirm.classList.add("hidden")})}async init(){}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}formatKeybinding(e){let t=I.getKeyForButtonCode(Y.data.settings.gameButtonMapping[e]);return t.startsWith("the")?t.slice(t.indexOf(" ")+1,t.lastIndexOf(" ")):t}changeKeybinding(t){if(I.isTouchDevice)return;let i="gold"===e.modification?an:on;this.rebindDialog.classList.remove("hidden"),this.rebindDialog.children[1].innerHTML=`Press a new key or button for<br>"${i[t]}"`,this.currentlyRebinding=t}setKeybinding(t,i){let s="gold"===e.modification?an:on;for(let e in Y.data.settings.gameButtonMapping){let n=e;if(Y.data.settings.gameButtonMapping[n]===i&&n!==t)return this.rebindDialog.classList.add("hidden"),this.rebindConfirm.classList.remove("hidden"),this.rebindConfirm.children[1].innerHTML=`"${this.formatKeybinding(n)}" is already bound to "${s[n]}"!<br>`+this.rebindConfirmWarningEnding,void(this.rebindValue=i)}Y.data.settings.gameButtonMapping[t]=i,Y.store(),this.currentlyRebinding=null,this.rebindDialog.classList.add("hidden"),this.refreshKeybindings()}showMarbleTexturePicker(){return new Promise(e=>{let t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept","image/x-png,image/gif,image/jpeg"),t.onchange=(async()=>{let i=t.files[0];await Y.databasePut("keyvalue",i,"marbleTexture"),e()}),t.click()})}}const hn=217,dn=344,cn=[30,60,90,120,144,240,360,1/0];class un extends ln{constructor(){super(...arguments),this.applyButton=document.querySelector("#mbp-options-apply"),this.generalButton=document.querySelector("#mbp-options-general"),this.hotkeysButton=document.querySelector("#mbp-options-hotkeys"),this.generalContainer=document.querySelector("#mbp-options-general-container"),this.hotkeysContainer=document.querySelector("#mbp-options-hotkeys-container"),this.updateFuncs=[],this.rebindConfirmWarningEnding="Do you want to undo this mapping?"}initProperties(){this.div=document.querySelector("#mbp-options"),this.homeButton=document.querySelector("#mbp-options-home"),this.rebindDialog=document.querySelector("#mbp-rebind-dialog"),this.rebindConfirm=document.querySelector("#mbp-rebind-confirm"),this.rebindConfirmYes=document.querySelector("#mbp-rebind-confirm-yes"),this.rebindConfirmNo=document.querySelector("#mbp-rebind-confirm-no"),this.homeButtonSrc="options/home",this.rebindConfirmYesSrc="exit/yes",this.rebindConfirmNoSrc="exit/no"}async init(){this.menu.setupButton(this.applyButton,"options/apply",()=>{},void 0,void 0,!1),this.menu.setupButton(this.generalButton,"options/general",()=>{this.generalContainer.classList.remove("hidden"),this.hotkeysContainer.classList.add("hidden"),this.generalButton.src=this.generalButton.src.slice(0,-5)+"d.png",this.generalButton.setAttribute("data-locked",""),this.hotkeysButton.src=this.hotkeysButton.src.slice(0,-5)+"n.png",this.hotkeysButton.removeAttribute("data-locked")},void 0,void 0,!1),this.menu.setupButton(this.hotkeysButton,"options/hotkeys",()=>{this.generalContainer.classList.add("hidden"),this.hotkeysContainer.classList.remove("hidden"),this.hotkeysButton.src=this.hotkeysButton.src.slice(0,-5)+"d.png",this.hotkeysButton.setAttribute("data-locked",""),this.generalButton.src=this.generalButton.src.slice(0,-5)+"n.png",this.generalButton.removeAttribute("data-locked")},void 0,void 0,!1),this.generalButton.click(),this.updateSliders();const e=()=>{var e;this.currentSliderElement&&(Y.store(),this.currentSliderElement=null,null===(e=this.soundTestingSound)||void 0===e||e.stop(),this.soundTestingSound=null)};window.addEventListener("mouseup",e),window.addEventListener("touchend",e),this.addHeading(this.generalContainer,"General"),this.addDropdown(this.generalContainer,"alwaysFreeLook","Free-Look",["Disabled","Enabled"],!0),this.addDropdown(this.generalContainer,"invertMouse","Invert Mouse",["None","X Only","Y only","X and Y"]),this.addDropdown(this.generalContainer,"frameRateCap","Max Frame Rate",cn.map(e=>isFinite(e)?e.toString():"Unlimited"),void 0,void 0,void 0,()=>{this.menu.showAlertPopup("About unlocking frame rate",'Browsers are v-synced by default, causing some input lag. Chrome can unlock its FPS by starting it with a special flag. Check <a href="https://www.reddit.com/r/KrunkerIO/comments/esz4gt/unlock_browser_fps_this_one_is_for_you/" target="_blank">this Reddit post</a> for more info. Once your FPS are unlocked, use this setting to ensure your CPU doesn\'t overheat.')}),this.addDropdown(this.generalContainer,"showFrameRate","Frame Rate",["Hidden","Visible"],!0),this.addDropdown(this.generalContainer,"showThousandths","Thousandths",["Disabled","Enabled"],!0),this.addMarbleTexturePicker(this.generalContainer),this.addDropdown(this.generalContainer,"marbleReflectivity","Reflective Marble",["Contextual","Disabled","Enabled"]),this.addDropdown(this.generalContainer,"fancyShaders","Fancy Shaders",["Disabled","Enabled"],!0),this.addDropdown(this.generalContainer,"pixelRatio","Pixel Ratio",["Max 0.5","Max 1.0","Max 1.5","Max 2.0","Max ‚àû"]),this.addDropdown(this.generalContainer,"canvasDesynchronized","Low-latency mode",["Disabled","Enabled"],!0,()=>{location.reload()},void 0,()=>{this.menu.showAlertPopup("About low-latency mode","In Chromium-based browsers, enabling low-latency mode can considerably reduce visual latency during gameplay. On some systems however, this can introduce flickering artifacts.")}),this.addDropdown(this.generalContainer,"inputType","Input Type",["Auto","Keyboard + Mouse","Touch"],void 0,()=>{let e=I.isTouchDevice;I.isTouchDevice=1!==Y.data.settings.inputType&&(2===Y.data.settings.inputType||I.checkIsTouchDevice()),e!==I.isTouchDevice&&location.reload()}),this.addSlider(this.generalContainer,"fov","Field of View",30,120,void 0,void 0,1,e=>e.toString()),this.addSlider(this.generalContainer,"musicVolume","Music Volume",0,1,()=>ft.updateVolumes(),void 0,void 0,e=>Math.ceil(100*e).toString()),this.addSlider(this.generalContainer,"mouseSensitivity","Mouse Speed",0,1),this.addSlider(this.generalContainer,"soundVolume","Sound Volume",0,1,()=>ft.updateVolumes(),()=>{this.soundTestingSound||(this.soundTestingSound=ft.createAudioSource("testing.wav"),this.soundTestingSound.setLoop(!0),this.soundTestingSound.play())},void 0,e=>Math.ceil(100*e).toString()),this.addSlider(this.generalContainer,"keyboardSensitivity","Keyboard Speed",0,1),this.addHeading(this.generalContainer,"Touch Controls"),this.addDropdown(this.generalContainer,"joystickPosition","Joystick Position",["Fixed","Dynamic"],void 0,void 0,!0),this.addSlider(this.generalContainer,"joystickSize","Joystick Size",100,500,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"joystickLeftOffset","Joystick Left Offset",0,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"joystickVerticalPosition","Joystick Vertical Pos",0,1,void 0,void 0,void 0,e=>Math.floor(100*e)+"%",!0),this.addDropdown(this.generalContainer,"actionButtonOrder","Button Order (‚§æ)",I.getPermutations(["Blast","Jump","Use"]).map(e=>e.join(" - ")),void 0,void 0,!0),this.addSlider(this.generalContainer,"actionButtonSize","Button Size",50,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"actionButtonRightOffset","Button Right Offset",0,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"actionButtonBottomOffset","Button Bottom Offset",0,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"actionButtonAsJoystickMultiplier","Button Sensitivity Fac",0,3,void 0,void 0,.1,e=>(Math.floor(10*e)/10).toString(),!0),this.addHotkey(this.hotkeysContainer,"up"),this.addHotkey(this.hotkeysContainer,"left"),this.addHotkey(this.hotkeysContainer,"down"),this.addHotkey(this.hotkeysContainer,"right"),this.addHotkey(this.hotkeysContainer,"cameraUp"),this.addHotkey(this.hotkeysContainer,"cameraLeft"),this.addHotkey(this.hotkeysContainer,"cameraDown"),this.addHotkey(this.hotkeysContainer,"cameraRight"),this.addHotkey(this.hotkeysContainer,"jump"),this.addHotkey(this.hotkeysContainer,"use"),this.addHotkey(this.hotkeysContainer,"freeLook"),this.addHotkey(this.hotkeysContainer,"restart"),this.addHotkey(this.hotkeysContainer,"blast"),await ne.loadImages(["small","medium","large","xlarge"].map(e=>"./assets/ui_mbp/options/dropdown-"+e+".png"))}updateSliders(){if(requestAnimationFrame(()=>this.updateSliders()),!this.currentSliderElement)return;let e=this.currentSliderElement.getBoundingClientRect(),t=ve.x-e.left*de-hn,i=I.clamp(t/(dn-hn),0,1);this.currentSliderCallback(i)}addHeading(e,t){let i=document.createElement("div");i.classList.add("mbp-options-element","_heading"),i.textContent=t,e.appendChild(i)}addDropdown(e,t,i,s,n=!1,r,a=!1,o){const l=()=>{m.classList.add("hidden"),p.classList.add("hidden"),g.classList.add("hidden"),c.style.zIndex="",u.style.zIndex=""};let h=document.createElement("div");h.classList.add("mbp-options-element","_dropdown"),a&&h.classList.add("_small-text");let d=document.createElement("p");d.textContent=i+":";let c=document.createElement("img");this.menu.setupButton(c,"options/dropdown",()=>{m.classList.contains("hidden")?(m.classList.remove("hidden"),p.classList.remove("hidden"),g.classList.remove("hidden"),c.style.zIndex="2",u.style.zIndex="2"):l()});let u=document.createElement("p"),m=document.createElement("div");m.classList.add("hidden"),m.addEventListener("click",()=>l());let p=document.createElement("img");p.classList.add("hidden"),p.src="./assets/ui_mbp/options/dropdown-"+["small","medium","large","xlarge"][Math.min(3,s.length-2)]+".png";let g=document.createElement("div");g.classList.add("hidden");for(let e of s){let i=document.createElement("div");i.textContent=e,g.appendChild(i),i.addEventListener("mousedown",async()=>{l(),u.textContent=e;let i=Y.data.settings[t],a=n?Boolean(s.indexOf(e)):s.indexOf(e);i!==a&&(Y.data.settings[t]=a,await Y.store(),null===r||void 0===r||r())})}if(h.append(d,c,u,m,p,g),o){let e=document.createElement("img");e.src="./assets/svg/info_black_24dp.svg",e.classList.add("_info"),h.append(e),e.addEventListener("click",o)}e.appendChild(h),this.updateFuncs.push(()=>u.textContent=s[Number(Y.data.settings[t])])}addSlider(e,t,i,s,n,r,a,o=0,l,h=!1){const d=()=>{let e=(Y.data.settings[t]-s)/(n-s);g.style.left=Math.floor(I.lerp(hn,dn,e))+"px",l&&(f.textContent=l(Y.data.settings[t]))};let c=document.createElement("div");c.classList.add("mbp-options-element","_slider"),h&&c.classList.add("_small-text");let u=document.createElement("p");u.textContent=i+":";let m=document.createElement("img");m.src="./assets/ui_mbp/options/bar.png";const p=()=>{this.currentSliderElement=c,this.currentSliderCallback=(e=>{Y.data.settings[t]=I.roundToMultiple(I.lerp(s,n,e),o),d(),null===r||void 0===r||r()}),null===a||void 0===a||a()};m.addEventListener("mousedown",p),m.addEventListener("touchstart",p);let g=document.createElement("img");g.src="./assets/ui_mbp/options/slider.png";let f=document.createElement("p");c.append(u,m,g),l&&c.append(f),e.appendChild(c),this.updateFuncs.push(d)}addHotkey(t,i){let s=document.createElement("div");s.classList.add("mbp-options-element","_hotkey");let n=document.createElement("p"),r="gold"===e.modification?an:on;n.textContent=r[i]+":";let a=document.createElement("img");this.menu.setupButton(a,"options/bind",()=>{this.changeKeybinding(i)});let o=document.createElement("p");s.append(n,a,o),t.appendChild(s),this.updateFuncs.push(()=>o.textContent=this.formatKeybinding(i))}addButton(e,t,i,s){let n=document.createElement("div");n.classList.add("mbp-options-element","_button");let r=document.createElement("p");r.textContent=t+":";let a=document.createElement("img");this.menu.setupButton(a,"options/bind",()=>s());let o=document.createElement("p");return o.textContent=i,n.append(r,a,o),e.appendChild(n),n}addMarbleTexturePicker(e){let t=this.addButton(e,"Marble Texture","Select File",async()=>{await this.showMarbleTexturePicker(),i.classList.remove("hidden")}),i=document.createElement("img");i.src="./assets/ui_mbp/mp/team/nomarble.png",i.id="mbp-reset-marble-texture-button",i.title="Clear texture",i.classList.add("hidden"),i.addEventListener("click",()=>{Y.databaseDelete("keyvalue","marbleTexture"),i.classList.add("hidden")}),t.appendChild(i),this.updateFuncs.push(async()=>{0===await Y.databaseCount("keyvalue","marbleTexture")?i.classList.add("hidden"):i.classList.remove("hidden")})}refreshKeybindings(){this.updateAllElements()}updateAllElements(){for(let e of this.updateFuncs)e()}show(){super.show(),this.updateAllElements()}}const mn={0:"0.png",1:"1.png",2:"2.png",3:"3.png",4:"4.png",5:"5.png",6:"6.png",7:"7.png",8:"8.png",9:"9.png",":":"colon.png",".":"point.png","/":"slash.png","-":"dash.png"},pn=/<func:bind (\w+)>/g;class gn{constructor(e){this.frameTimeStore=[],this.centerText="none",this.helpText="",this.helpTextTimeState=null,this.alertText="",this.alertTextTimeState=null,this.menu=e,this.hudCanvas=document.querySelector("#hud-canvas"),this.hudCtx=this.hudCanvas.getContext("2d",{desynchronized:!1}),this.fpsMeter=document.querySelector("#fps-meter"),this.fpsMeterValue=document.querySelector("#fps-meter-value")}async load(){let t=[];t.push(...Object.values(mn).map(e=>{let t=[e];return!this.supportNumberColors||e.includes("slash")||e.includes("dash")||(t.push(e.slice(0,e.lastIndexOf("."))+"_red.png"),t.push(e.slice(0,e.lastIndexOf("."))+"_green.png")),t.map(e=>this.menu.uiAssetPath+"game/numbers/"+e)}).flat()),t.push(...["ready.png","set.png","go.png","outofbounds.png","powerup.png"].map(e=>this.menu.uiAssetPath+"game/"+e)),Y.data.settings.showFrameRate&&this.supportFpsMeter?this.fpsMeter.classList.remove("hidden"):this.fpsMeter.classList.add("hidden"),e.level.mission.hasBlast&&t.push(...["blastbar.png","blastbar_charged.png","blastbar_bargreen.png","blastbar_bargray.png"].map(e=>"./assets/ui_mbp/game/"+e)),t.push(...["./assets/ui_mbp/game/transparency.png"]),await ne.loadImages(t),I.isTouchDevice&&this.setupTouchControls(),this.helpTextTimeState=null,this.alertTextTimeState=null}setupTouchControls(){je.style.top=e.level.totalGems?"60px":"",Ge.style.top=e.level.totalGems?"60px":"",We.style.top=e.level.totalGems?"60px":"",qe.style.visibility=e.level.mission.hasBlast?"":"hidden",qe.style.pointerEvents=e.level.mission.hasBlast?"":"none",We.style.visibility=Y.data.settings.alwaysFreeLook?"hidden":"",We.style.pointerEvents=Y.data.settings.alwaysFreeLook?"none":"",this.fpsMeter.style.transform="scale(0.5)",this.fpsMeter.querySelector("img").style.borderRight="50px solid #ffffff4d",this.fpsMeterValue.style.marginRight="50px";let t=Y.data.settings.joystickSize,i=He*t;De.style.width=t+"px",De.style.height=t+"px",De.style.borderRadius=i/2+"px",Ue.style.width=i+"px",Ue.style.height=i+"px";let s=Y.data.settings.actionButtonSize/120;Ve.style.right=Y.data.settings.actionButtonRightOffset/s+"px",Ve.style.bottom=Y.data.settings.actionButtonBottomOffset/s+"px",Ve.style.transform=`scale(${s})`;let n=[{right:0,bottom:135},{right:0,bottom:0},{right:135,bottom:0}],r=I.getPermutations([qe,Oe,Ne])[Y.data.settings.actionButtonOrder];for(let e of r)e.style.right=n[r.indexOf(e)].right+"px",e.style.bottom=n[r.indexOf(e)].bottom+"px"}setSize(e,t,i){let s=Math.ceil(e*i),n=Math.ceil(t*i);this.hudCanvas.setAttribute("width",s.toString()),this.hudCanvas.setAttribute("height",n.toString());let r=ce(e,t);this.width=Math.ceil(e*r),this.height=Math.ceil(t*r)}renderHud(t){var i,s,n,r;const a=this.hudCtx,o=e.level,{width:l,height:h}=this;let d=this.hudCanvas.width/this.width;if(a.resetTransform(),a.scale(d,d),a.clearRect(0,0,l,h),this.showClockBackground){let e=ne.getImageFromCache("./assets/ui_mbp/game/transparency.png");a.drawImage(e,Math.floor(l/2-110+3),-10,220,79)}let c=t.gameplayClock;if(o.finishTime&&(c=o.finishTime.gameplayClock),0!==o.currentTimeTravelBonus||o.finishTime||(c=Math.max(c-1e3/ea,0)),o.maxDisplayedTime=Math.max(c,o.maxDisplayedTime),0!==o.currentTimeTravelBonus||o.finishTime||(c=o.maxDisplayedTime),c=Math.min(c,oa),this.drawNumbers(I.secondsToTimeString(c/1e3),l/2,0,!0,this.determineClockColor(c)),o.totalGems>0){let e=I.leftPadZeroes(o.gemCount.toString(),this.gemCountMinDigits)+"/"+I.leftPadZeroes(o.totalGems.toString(),this.gemCountMinDigits);this.drawNumbers(e,30,0,!1)}let u=ne.getImageFromCache(this.menu.uiAssetPath+"game/powerup.png");if(a.drawImage(u,l-u.width-5,5),"none"!==this.centerText){let e=ne.getImageFromCache(this.menu.uiAssetPath+"game/"+this.centerText+".png");a.drawImage(e,Math.floor((l-e.width)/2),Math.floor(.3*h))}let m=null!==(s=null===(i=this.helpTextTimeState)||void 0===i?void 0:i.timeSinceLoad)&&void 0!==s?s:-1/0,p=null!==(r=null===(n=this.alertTextTimeState)||void 0===n?void 0:n.timeSinceLoad)&&void 0!==r?r:-1/0,g=I.clamp((t.timeSinceLoad-m-3e3)/1e3,0,1)**2,f=I.clamp((t.timeSinceLoad-p-3e3)/1e3,0,1)**2;if(g<1){let t={r:255,g:255,b:255,a:255},i={r:0,g:0,b:0,a:255},s=I.lerpColors(t,i,I.lerp(0,.5,g));a.font="24px DomCasualRegular",a.fillStyle=`rgb(${s.r}, ${s.g}, ${s.b})`,a.textAlign="center",a.textBaseline="top",a.shadowColor="gold"===e.modification?"black":"#777777",a.shadowOffsetX=1,a.shadowOffsetY=1,a.globalAlpha=1-g;let n=this.breakTextIntoLines(this.helpText,l);for(let e=0;e<n.length;e++)a.fillText(n[e],Math.floor(l/2),Math.floor(.45*h)+24*1.2*e);a.shadowColor="transparent",a.shadowOffsetX=0,a.shadowOffsetY=0,a.globalAlpha=1}if(f<1){let t="gold"===e.modification?{r:255,g:226,b:64,a:255}:{r:228,g:211,b:64,a:129},i={r:0,g:0,b:0,a:255},s=I.lerpColors(t,i,I.lerp(0,.5,f));a.font="24px DomCasualRegular",a.fillStyle=`rgb(${s.r}, ${s.g}, ${s.b})`,a.textAlign="center",a.textBaseline="bottom",a.shadowColor="gold"===e.modification?"black":"rgb(119, 102, 34)",a.shadowOffsetX=1,a.shadowOffsetY=1,a.globalAlpha=1-f;let n=this.breakTextIntoLines(this.alertText,l);for(let e=0;e<n.length;e++)a.fillText(n[e],Math.floor(l/2),h-30-24*1.2*(n.length-e-1));a.shadowColor="transparent",a.shadowOffsetX=0,a.shadowOffsetY=0,a.globalAlpha=1}if(0!==he.debugMode){a.font="24px DomCasualRegular",a.fillStyle="white",a.textAlign="center",a.textBaseline="bottom",a.shadowColor="black",a.shadowOffsetX=1,a.shadowOffsetY=1,a.globalAlpha=1;let e="Debug Rendering: ";switch(he.debugMode){case 1:e+="UV";break;case 2:e+="Normal (World)";break;case 3:e+="Normal (Map)";break;case 4:e+="Normal (Multiplied)";break;case 5:e+="Tangent";break;case 6:e+="Tangent A";break;case 7:e+="TBN[T]";break;case 8:e+="TBN[B]";break;case 9:e+="TBN[N]";break;default:e=""}a.fillText(e,Math.floor(l/2),100),a.shadowColor="transparent",a.shadowOffsetX=0,a.shadowOffsetY=0,a.globalAlpha=1}if(o.mission.hasBlast){let e=o.blastAmount,t=new _(7,34);I.isTouchDevice&&t.set(20,47);let i=`./assets/ui_mbp/game/blastbar_bar${e>=.2?"green":"gray"}.png`,s=ne.getImageFromCache(i);a.drawImage(s,t.x+5,h-t.y+5,109*I.clamp(e,0,1),17);let n=ne.getImageFromCache(e>1?"./assets/ui_mbp/game/blastbar_charged.png":"./assets/ui_mbp/game/blastbar.png");a.drawImage(n,t.x,h-t.y)}}determineClockColor(t){if("gold"===e.modification)return;const i=e.level;if(i.finishTime)return"green";if(i.timeState.currentAttemptTime<na||i.currentTimeTravelBonus>0)return"green";if(t>=i.mission.qualifyTime)return"red";if(i.timeState.currentAttemptTime>=na&&isFinite(i.mission.qualifyTime)&&"platinum"===e.modification){let e=t-i.mission.computeAlarmStartTime();if(e<0)return;if(Math.floor(e/1e3)%2==0)return"red"}}drawNumbers(e,t,i,s,n){let r=0;if(s){let i=24*(e.length-1)-28+43;t=Math.floor(t-i/2)}for(let i=0;i<e.length;i++){let s=e[i],a=this.menu.uiAssetPath+"game/numbers/"+mn[s];this.supportNumberColors&&n&&(a=a.slice(0,a.lastIndexOf("."))+"_"+n+".png");let o=ne.getImageFromCache(a);":"!==s&&"."!==s||(r-=3),this.hudCtx.drawImage(o,t+r,0),r+=24,":"!==s&&"."!==s||(r-=7)}}breakTextIntoLines(e,t){let i=e.split("\n");for(let e=0;e<i.length;e++){let s=i[e];if(this.hudCtx.measureText(s).width>t){let n=s.split(" "),r=0,a=n.length-1,o=0;for(;r<=a;){let e=Math.floor(r+(a-r+1)/2),i=n.slice(0,e+1).join(" ");this.hudCtx.measureText(i).width<=t?(r=e+1,o=e):a=e-1}let l=n.slice(0,o+1).join(" "),h=n.slice(o+1).join(" ");i[e]=l,i.splice(e+1,0,h)}}return i}setPowerupButtonState(e,t=!1){I.isTouchDevice&&(et(e),(e||t)&&(Ne.style.opacity="0.5"),!e&&t&&(Ne.style.opacity="0.2"))}displayHelp(t,i=!1){let s;for(pn.lastIndex=0;null!==(s=pn.exec(t));){let e={moveforward:"up",movebackward:"down",moveleft:"left",moveright:"right",jump:"jump",mousefire:"use",panup:"cameraUp",pandown:"cameraDown",panleft:"cameraLeft",panright:"cameraRight",turnup:"cameraUp",turndown:"cameraDown",turnleft:"cameraLeft",turnright:"cameraRight",freelook:"freeLook",useblast:"blast"}[s[1].toLowerCase()];if(!e)continue;let i=I.getKeyForButtonCode(Y.data.settings.gameButtonMapping[e]);t=t.slice(0,s.index)+i+t.slice(s.index+s[0].length),pn.lastIndex-=s[0].length}"MSG_FINDALLTHEGEMS"===t&&(t="Find all the gems!"),"MSG_RACETOTHEFINISH"===t&&(t="Race to the finish!"),this.helpText=t,this.helpTextTimeState=I.jsonClone(e.level.timeState),i&&e.level.audio.play("infotutorial.wav")}displayAlert(t){this.alertText=t,this.alertTextTimeState=I.jsonClone(e.level.timeState)}setCenterText(e){this.centerText=e}displayFps(){var t;if(!Y.data.settings.showFrameRate||!this.supportFpsMeter)return;let i=performance.now();for(this.frameTimeStore.push(i);this.frameTimeStore.length&&this.frameTimeStore[0]+1e3<=i;)this.frameTimeStore.shift();let s=this.frameTimeStore.length;s/=Math.min(1,null!==(t=e.level.timeState.timeSinceLoad/1e3)&&void 0!==t?t:1),s=Math.floor(s);let n=cn[Y.data.settings.frameRateCap];59!==s&&119!==s&&143!==s&&239!==s&&s!==n-1||s++,61!==s&&121!==s&&145!==s&&241!==s&&s!==n+1||s--,this.fpsMeterValue.textContent="FPS: "+s}}class fn extends gn{constructor(){super(...arguments),this.gemCountMinDigits=3,this.showClockBackground=!0,this.supportNumberColors=!0,this.supportFpsMeter=!0}}class yn extends bi{constructor(e){super(),this.collideable=!1,this.dtsPath=`shapes/skies/${e}/${e}.dts`}}class bn extends bi{constructor(e){super();let t=/glass_(\d+)shape/.exec(e)[1];this.dtsPath=`shapes/glass/${t}x3.dts`,this.colliderDtsPath=`shapes/glass/col/${t}x3.dts`}}class vn extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/blast.dts",this.autoUse=!0,this.sounds=["publastvoice.wav"],this.pickUpName="Blast PowerUp"}pickUp(){return this.level.audio.play(this.sounds[0]),!0}use(){this.level.blastAmount=1.03}}class wn extends os{constructor(){super(...arguments),this.dtsPath="shapes/items/megamarble.dts",this.sounds=["pumegamarblevoice.wav","dosuperjump.wav","mega_bouncehard1.wav","mega_bouncehard2.wav","mega_bouncehard3.wav","mega_bouncehard4.wav","mega_roll.wav"],this.pickUpName="Mega Marble PowerUp"}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableMegaMarble(this.level.timeState),this.level.deselectPowerUp(),this.level.audio.play(this.sounds[1])}}var xn="precision highp float;\nprecision highp int;\n\n#include <definitions>\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 tangent;\nattribute vec2 uv;\nattribute float meshInfoIndex;\n\nuniform highp sampler2D meshInfos; // This is where mesh transformation and other things about the mesh are stored in\nuniform int meshInfoTextureWidth;\nuniform int meshInfoTextureHeight;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 inverseProjectionMatrix;\nuniform bool skipTransparent;\nuniform mat4 directionalLightTransform;\nuniform vec3 eyePosition;\nuniform float materialOpacity;\n\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying float vOpacity;\nvarying vec4 vShadowPosition;\nvarying vec3 vReflect;\nvarying mat3 vTbn;\nvarying vec4 vTangent;\nvarying float vFragDepth;\nvarying float vIsPerspective;\nvarying vec3 eyeDirection;\n\n#ifdef IS_WEBGL1\n\tmat3 transpose(mat3 inMatrix) {\n\t\tvec3 i0 = inMatrix[0];\n\t\tvec3 i1 = inMatrix[1];\n\t\tvec3 i2 = inMatrix[2];\n\n\t\tmat3 outMatrix = mat3(\n\t\t\tvec3(i0.x, i1.x, i2.x),\n\t\t\tvec3(i0.y, i1.y, i2.y),\n\t\t\tvec3(i0.z, i1.z, i2.z)\n\t\t);\n\n\t\treturn outMatrix;\n\t}\n\n\t// http://www.thetenthplanet.de/archives/1180\n\tmat3 inverse(mat3 M) {\n\t\tmat3 M_t = transpose(M);\n\t\tfloat det = dot(cross(M_t[0], M_t[1]), M_t[2]);\n\t\tmat3 adjugate = mat3(cross(M_t[1], M_t[2]), cross(M_t[2], M_t[0]), cross(M_t[0], M_t[1]));\n\t\treturn adjugate / det;\n\t}\n#endif\n\n// _ here because on some systems, \"mod\" is already defined?\nint _mod(int a, int n) {\n\t#ifdef IS_WEBGL1\n\t\treturn a - n * (a / n);\n\t#else\n\t\treturn a % n;\n\t#endif\n}\n\n// Gets the mesh info for the mesh at a specific index. The mesh info contains its transformation and other things.\nmat4 getMeshInfo(int index) {\n\t// Figure out where we need to sample the texture\n\tivec2 coords = ivec2(\n\t\t_mod(4 * index, meshInfoTextureWidth),\n\t\t(4 * index) / meshInfoTextureWidth\n\t);\n\n\t#ifdef IS_WEBGL1\n\t\t// Primitive way, sample with texture coordinates\n\t\treturn mat4(\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(0, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(1, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(2, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(3, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight))\n\t\t);\n\t#else\n\t\t// Better way, sample with pixel coordinates\n\t\treturn mat4(\n\t\t\ttexelFetch(meshInfos, coords + ivec2(0, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(1, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(2, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(3, 0), 0)\n\t\t);\n\t#endif\n}\n\nbool isPerspectiveMatrix(mat4 m) {\n\treturn m[2][3] == -1.0; // Taken from three.js, no clue how this works\n}\n\nvoid main() {\n\t#ifdef IS_SKY\n\t\t// https://gamedev.stackexchange.com/a/60377\n\t\tmat4 inverseProjection = inverseProjectionMatrix;\n\t\tmat3 inverseModelView = transpose(mat3(viewMatrix));\n\t\tvec3 unprojected = (inverseProjection * vec4(position, 1.0)).xyz;\n\t\teyeDirection = inverseModelView * unprojected;\n\t\t\n\t\tgl_Position = vec4(position, 1.0);\n\t#else\n\t\tmat4 meshInfo = getMeshInfo(int(meshInfoIndex + 0.1)); // + 0.1 to make sure it casts correctly, lol\n\t\tmat4 transform = meshInfo;\n\t\ttransform[0][3] = 0.0; // The last row of a transformation matrix is always the same, so set it to what it should be\n\t\ttransform[1][3] = 0.0;\n\t\ttransform[2][3] = 0.0;\n\t\ttransform[3][3] = 1.0;\n\t\tfloat opacity = meshInfo[0][3];\n\t\tint meshFlags = int(meshInfo[1][3]);\n\n\t\topacity *= materialOpacity;\n\t\tvOpacity = opacity;\n\n\t\tif (skipTransparent && opacity < 1.0) {\n\t\t\t// The object isn't fully opaque, so skip it\n\t\t\tgl_Position = vec4(0.0);\n\t\t\treturn;\n\t\t}\n\n\t\tvec4 worldPosition = transform * vec4(position, 1.0);\n\t\tvPosition = worldPosition;\n\n\t\tmat4 mvp = projectionMatrix * viewMatrix * transform; // Combine them into a single matrix to reduce possible precision errors\n\t\tgl_Position = mvp * vec4(position, 1.0);\n\n\t\tvUv = uv;\n\t\t#ifdef FLIP_Y\n\t\t\tvUv.y = 1.0 - vUv.y;\n\t\t#endif\n\n\t\t// Compute the transformation matrix for normals (not tangents, tho!)\n\t\t// Note that when the transformation doesn't involve any scaling, the upper mat3 part is orthonormal meaning its inverse is equal to its transpose. In this case, normalTransform == mat3(transform).\n\t\tmat3 normalTransform = transpose(inverse(mat3(transform)));\n\n\t\tvec3 transformedNormal = normalTransform * normal;\n\t\t#ifdef NORMALIZE_NORMALS\n\t\t\t// Many normals, like those used in the tornado, are actually not normalized\n\t\t\ttransformedNormal = normalize(transformedNormal);\n\t\t#endif\n\t\tvNormal = transformedNormal;\n\n\t\tvTangent = tangent; // Needed so that it doesn't get optimized out (fucks with vertex attributes somehow)\n\t\t#ifdef USE_NORMAL_MAP\n\t\t\tvec3 N = transformedNormal;\n\t\t\tvec3 T = normalize((transform * vec4(tangent.xyz, 0.0)).xyz);\n\t\t\t// re-orthogonalize T with respect to N\n\t\t\tT = normalize(T - dot(T, N) * N);\n\t\t\t// then retrieve perpendicular vector B with the cross product of T and N\n\t\t\tvec3 B = cross(N, T) * tangent.w;\n\t\t\tmat3 tbn = mat3(T, B, N);\n\t\t\tvTbn = tbn;\n\t\t#endif\n\n\t\t#if defined(RECEIVE_SHADOWS) || defined(IS_SHADOW)\n\t\t\t// Compute where we are within shadow camera view space\n\t\t\tvShadowPosition = directionalLightTransform * worldPosition;\n\t\t#endif\n\n\t\t#if defined(USE_ENV_MAP) && !defined(USE_ACCURATE_REFLECTION_RAY)\n\t\t\t// Compute the reflection ray\n\t\t\tvec3 incidentRay = normalize(worldPosition.xyz - eyePosition);\n\t\t\tvec3 reflected = reflect(incidentRay, normalize(transformedNormal));\n\t\t\tvReflect = reflected;\n\t\t#endif\n\n\t\t#ifdef LOG_DEPTH_BUF\n\t\t\t// Some values we need to pass along for logarithmic depth buffer stuffs\n\t\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\t\tvIsPerspective = float(isPerspectiveMatrix(projectionMatrix));\n\t\t#endif\n\t#endif\n}",Sn="precision mediump float;\n\n#define SHADOW_RADIUS 2\n#include <definitions>\n\n// This condition here is necessary to save on varying vectors; some mobile devices (*cough* iPhones *cough*) only support 8 varying vec4s, and this separation here makes sure we stay just under that. If, in the future, more varyings will be necessary, this condition can always be refined more. Also, apparently I'm not allowed to indent 'varying'.\n#ifdef IS_SKY\nvarying vec3 eyeDirection;\n#else\nvarying vec4 vPosition;\nvarying vec2 vUv;\nvarying vec3 vNormal;\n//varying vec4 vTangent; // Using this drops support with WebGL 1 on iOS, too many varyings\nvarying float vOpacity;\nvarying vec4 vShadowPosition;\nvarying vec3 vReflect;\nvarying mat3 vTbn; // Matrix used to transform the normal map vectors\nvarying float vFragDepth;\nvarying float vIsPerspective;\n#endif\n\nuniform sampler2D diffuseMap;\nuniform samplerCube envMap;\nuniform sampler2D normalMap;\nuniform sampler2D specularMap;\nuniform sampler2D noiseMap;\n\nuniform float reflectivity;\nuniform highp vec3 eyePosition;\nuniform float specularIntensity;\nuniform float shininess;\nuniform float logDepthBufFC;\nuniform float secondaryMapUvFactor;\nuniform int debugMode;\n\nuniform vec3 ambientLight;\nuniform vec3 directionalLightColor;\nuniform vec3 directionalLightDirection;\nuniform mediump sampler2D directionalLightShadowMap;\n\n#if defined(LOG_DEPTH_BUF) && defined(IS_WEBGL1)\n\t#extension GL_EXT_frag_depth : enable // For some reason, the extension needs to be enabled in-shader\n#endif\n\n// Computes standard Lambertian reflectance\nfloat lambert(vec3 normal, vec3 lightPosition) {\n\tfloat result = dot(normal, lightPosition);\n\treturn max(result, 0.0);\n}\n\n#ifdef IS_WEBGL1\n\tmat3 transpose(mat3 inMatrix) {\n\t\tvec3 i0 = inMatrix[0];\n\t\tvec3 i1 = inMatrix[1];\n\t\tvec3 i2 = inMatrix[2];\n\n\t\tmat3 outMatrix = mat3(\n\t\t\tvec3(i0.x, i1.x, i2.x),\n\t\t\tvec3(i0.y, i1.y, i2.y),\n\t\t\tvec3(i0.z, i1.z, i2.z)\n\t\t);\n\n\t\treturn outMatrix;\n\t}\n#endif\n\nvec4 sampleCubeTexture(samplerCube tex, vec3 uvw) {\n\t#ifdef ENV_MAP_Z_UP\n\t\tuvw.yz = vec2(uvw.z, -uvw.y); // Rotate the \"cube\" about the x-axis because by default, cubemaps are Y-up but we're in Z-up space\n\t#endif\n\n\treturn textureCube(tex, uvw);\n}\n\n// Gets the intensity of a shadow given a point in shadow camera view space\nfloat getShadowIntensity(sampler2D map, vec4 shadowPosition, int mapSize) {\n\tvec3 projectedTexcoord = shadowPosition.xyz / shadowPosition.w;\n\tprojectedTexcoord = (projectedTexcoord + vec3(1.0)) / 2.0; // From [-1, 1] to [0, 1]\n\n\t// Check if we're even within the bounds of the shadow texture\n\tbool inBounds =\n\t\tmin(projectedTexcoord.x, min(projectedTexcoord.y, projectedTexcoord.z)) > 0.0 &&\n\t\tmax(projectedTexcoord.x, max(projectedTexcoord.y, projectedTexcoord.z)) < 1.0;\n\t\n\tif (!inBounds) return 0.0; // If not, say there's no shadow\n\n\tfloat mapSizeF = float(mapSize);\n\tfloat total = 0.0;\n\n\t// Sample the texture in an area to soften it a bit\n\tfor (int x = -SHADOW_RADIUS; x <= SHADOW_RADIUS; x++) {\n\t\tfor (int y = -SHADOW_RADIUS; y <= SHADOW_RADIUS; y++) {\n\t\t\tvec2 uv = projectedTexcoord.xy + vec2(float(x) / mapSizeF, float(y) / mapSizeF);\n\t\t\tfloat depthValue = texture2D(map, uv.xy).r;\n\t\t\tif (depthValue < projectedTexcoord.z) total += 1.0;\n\t\t}\n\t}\n\n\treturn mix(total / float((SHADOW_RADIUS*2+1)*(SHADOW_RADIUS*2+1)), 0.0, projectedTexcoord.z * projectedTexcoord.z);\n}\n\n// Fresnel-Schlick approximation\nfloat fresnel(vec3 direction, vec3 normal, bool invert) {\n\tvec3 nDirection = normalize(direction);\n\tvec3 nNormal = normalize(normal);\n\tvec3 halfDirection = normalize(nNormal + nDirection);\n\n\tfloat exponent = 5.0;\n\tfloat cosine = dot(halfDirection, nDirection);\n\tfloat product = max(cosine, 0.0);\n\tfloat factor = invert ? 1.0 - pow(product, exponent) : pow(product, exponent);\n\t\n\treturn factor;\n}\n\nvoid main() {\n\t#if defined(LOG_DEPTH_BUF) && !defined(IS_SKY)\n\t\t// We always need to set gl_FragDepthEXT when it's present in the file, otherwise it gets real weird\n\t\t// Also: Doing a strict comparison with == 1.0 can cause noise artifacts\n\t\tgl_FragDepthEXT = (vIsPerspective != 0.0)? log2(vFragDepth) * logDepthBufFC * 0.5 : gl_FragCoord.z;\n\t#endif\n\n\t#ifdef IS_SKY\n\t\t// We simply sample the skybox cube texture and we're done.\n\t\tvec4 sampled = sampleCubeTexture(envMap, eyeDirection);\n\t\tgl_FragColor = sampled;\n\t#elif defined(IS_SHADOW)\n\t\tbool hasDirectionalLight = dot(directionalLightDirection, directionalLightDirection) > 0.0;\n\t\tfloat intensity = getShadowIntensity(directionalLightShadowMap, vShadowPosition, 250);\n\t\tif (!hasDirectionalLight) intensity = 0.0;\n\t\t\n\t\tgl_FragColor = vec4(vec3(0.0), intensity * 0.25); // Note that this intensity differs from the one used in the normal shader path. That's because with a separate shadow material, it's actually difficult to figure out how dark the shadow should be - so whatever value we picked here just looked the least odd.\n\t#else\n\t\tvec4 diffuse = vec4(1.0);\n\n\t\t#ifdef USE_DIFFUSE_MAP\n\t\t\tdiffuse = texture2D(diffuseMap, vUv);\n\t\t\t#ifndef TRANSPARENT\n\t\t\t\tdiffuse.a = 1.0;\n\t\t\t#endif\n\t\t#endif\n\n\t\t#ifdef USE_NOISE_MAP\n\t\t\t// Sample the noise texture multiple times to create the tiling effect found in MBU textures. Code is taken from MBU shaders!\n\n\t\t\tvec2 noiseIndex;\n\t\t\tvec4 noiseColor[4];\n\t\t\tvec2 halfPixel = vec2(1.0 / 64.0, 1.0 / 64.0);\n\n\t\t\tnoiseIndex.x = floor(vUv.x - halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y - halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[0] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tnoiseIndex.x = floor(vUv.x - halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y + halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[1] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tnoiseIndex.x = floor(vUv.x + halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y + halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[2] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tnoiseIndex.x = floor(vUv.x + halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y - halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[3] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tvec4 finalNoiseCol = (noiseColor[0] + noiseColor[1] + noiseColor[2] + noiseColor[3]) / 4.0;\n\t\t\tdiffuse.rgb *= 1.0 + finalNoiseCol.r; // This isn't how MBU does it afaik but it looks good :o\n\t\t#endif\n\n\t\tdiffuse.a *= vOpacity; // Multiply the diffuse by the whole mesh's opacity (and the material's opacity)\n\n\t\tvec3 incomingLight = vec3(0.0);\n\t\tvec3 specularLight = vec3(0.0);\n\n\t\t#ifdef EMISSIVE\n\t\t\tincomingLight = vec3(1.0);\n\t\t#else\n\t\t\tincomingLight += ambientLight;\n\n\t\t\tvec3 normal = vNormal;\n\n\t\t\t#ifdef USE_NORMAL_MAP\n\t\t\t\t// Overwrite the normal with the sampled one\n\t\t\t\tvec3 map = texture2D(normalMap, secondaryMapUvFactor * vUv).xyz;\n\t\t\t\tmap = map * 255.0/127.0 - 128.0/127.0;\n\t\t\t\t#ifdef INVERT_U\n\t\t\t\t\tmap.x = -map.x;\n\t\t\t\t#endif\n\t\t\t\tnormal = vTbn * map; // Don't normalize here! Reduces aliasing effects\n\t\t\t#endif\n\n\t\t\tvec3 addedLight = directionalLightColor * lambert(normal, -directionalLightDirection);\n\n\t\t\t#ifdef SATURATE_INCOMING_LIGHT\n\t\t\t\t// MBG saturates the incoming light to be at most 1.0\n\t\t\t\taddedLight = min(vec3(1.0), incomingLight + addedLight) - incomingLight;\n\t\t\t#endif\n\n\t\t\t#ifdef RECEIVE_SHADOWS\n\t\t\t\t// When the direction has zero length, we make the assumption that there is no directional light in the scene.\n\t\t\t\tbool hasDirectionalLight = dot(directionalLightDirection, directionalLightDirection) > 0.0;\n\t\t\t\tfloat intensity = getShadowIntensity(directionalLightShadowMap, vShadowPosition, 250);\n\t\t\t\tif (!hasDirectionalLight) intensity = 0.0;\n\n\t\t\t\taddedLight *= mix(1.0, 0.666, intensity);\n\t\t\t#endif\n\t\t\t\n\t\t\tincomingLight += addedLight;\n\n\t\t\t#ifdef USE_SPECULAR\n\t\t\t\tvec3 viewDir = normalize(eyePosition - vPosition.xyz);\n\t\t\t\tvec3 halfwayDir = normalize(-directionalLightDirection + viewDir); // Blinn-Phong\n\n\t\t\t\tfloat spec = pow(max(dot(normal, halfwayDir), 0.0), shininess);\n\n\t\t\t\t#ifdef USE_SPECULAR_MAP\n\t\t\t\t\tspec *= texture2D(specularMap, secondaryMapUvFactor * vUv).r;\n\t\t\t\t#endif\n\n\t\t\t\tspecularLight += vec3(specularIntensity * spec);\n\t\t\t#endif\n\t\t#endif\n\n\t\tvec4 shaded = diffuse * vec4(incomingLight, 1.0);\n\t\tshaded.rgb += specularLight;\n\n\t\t#ifdef USE_ENV_MAP\n\t\t\t#ifdef USE_FRESNEL\n\t\t\t\t// Fresnel causes the reflectivity to increase with incresing angle of incidence\n\t\t\t\tvec3 viewDir = normalize(eyePosition - vPosition.xyz);\n\t\t\t\tfloat fac = fresnel(viewDir, normal, true);\n\t\t\t#else\n\t\t\t\tfloat fac = 1.0;\n\t\t\t#endif\n\n\t\t\t#ifdef USE_ACCURATE_REFLECTION_RAY\n\t\t\t\t// The reflection ray tends to be much more accurate when computed using the interpolated normal rather than interpolating the reflection ray itself; but it's more expensive and sometimes looks too boring\n\t\t\t\tvec3 incidentRay = normalize(vPosition.xyz - eyePosition);\n\t\t\t\tvec3 reflectionRay = reflect(incidentRay, normalize(vNormal));\n\t\t\t#else\n\t\t\t\tvec3 reflectionRay = vReflect;\n\t\t\t#endif\n\n\t\t\tvec4 sampled = sampleCubeTexture(envMap, reflectionRay);\n\t\t\tsampled.a *= vOpacity;\n\t\t\t\n\t\t\tshaded = mix(shaded, sampled, fac * reflectivity);\n\t\t#endif\n\n\t\t#ifdef USE_NORMAL_MAP\n\t\t\tif (debugMode == 0) {}\n\t\t\telse if (debugMode == 1) {\n\t\t\t\tshaded = vec4(mod(vUv, 1.0f), 0, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 2) {\n\t\t\t\tshaded = vec4((vNormal + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 3) {\n\t\t\t\tshaded = vec4((map + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 4) {\n\t\t\t\tshaded = vec4((normal + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\t/*\n\t\t\tif (debugMode == 5) {\n\t\t\t\tshaded = vec4((vTangent.xyz + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\tif (debugMode == 6) {\n\t\t\t\tshaded = vec4(vec3((vTangent.w + 1.0f) / 2.0f), 1);\n\t\t\t}\n\t\t\t*/\n\t\t\telse if (debugMode == 7) {\n\t\t\t\tshaded = vec4((vTbn[0] + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 8) {\n\t\t\t\tshaded = vec4((vTbn[1] + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 9) {\n\t\t\t\tshaded = vec4((vTbn[2] + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t#endif\n\t\tgl_FragColor = shaded;\n\t\t#ifdef USE_PREMULTIPLIED_ALPHA\n\t\t\tgl_FragColor.rgb *= gl_FragColor.a;\n\t\t#endif\n\t#endif\n}";class Tn extends pi{constructor(e){super(),this.allDefineChunks=new Set,this.ambientLights=[],this.directionalLights=[],this.particleManager=null,this.firstUpdate=!0,this.compiled=!1,this.preparedForRender=!1,this.renderer=e}addAmbientLight(e){this.ambientLights.push(e)}addDirectionalLight(e){this.directionalLights.push(e)}compile(){let{gl:e}=this.renderer,t=new Map,s=[];this.traverse(e=>e instanceof Gt&&s.push(e)),this.allMeshes=s;let n=[],r=[],a=[],o=[],l=[],h=[];for(let[e,i]of s.entries()){i.geometry.validate(),i.vboOffset=l.length,i.compileMaterialIndices();let s=i.geometry.positions.length/3;I.pushArray(n,i.geometry.positions),I.pushArray(r,i.geometry.normals),I.pushArray(o,i.geometry.uvs),I.pushArray(l,Array(s).fill(e)),i.materials.some(e=>e.normalMap)?this.computeTangents(i.geometry.positions,i.geometry.normals,i.geometry.uvs,a):I.pushArray(a,Array(4*s).fill(0));for(let e of i.materialIndices){let s=e.material,n=s.getDefineChunk();if(this.allDefineChunks.add(n),!this.renderer.materialShaders.has(n)){let e=new Q(this.renderer,xn,Sn,n);this.renderer.materialShaders.set(n,e)}i.castShadows&&I.pushArray(h,e.indices),s.transparent||s.opacity<1?i.hasTransparentMaterials=!0:this.updateMaterialGroup(t,e)}}let d=[...t].map(e=>e[1]);d.sort((e,t)=>e.defineChunk.localeCompare(t.defineChunk)).sort((e,t)=>e.material.renderOrder-t.material.renderOrder),this.opaqueMaterialGroups=d;let c=[];for(let e of d){e.offset=c.length;for(let t of e.indexGroups)I.pushArray(c,t.indices)}this.positionBuffer=new vi(this.renderer,new Float32Array(n),{position:3}),this.normalBuffer=new vi(this.renderer,new Float32Array(r),{normal:3}),this.tangentBuffer=new vi(this.renderer,new Float32Array(a),{tangent:4}),this.uvBuffer=new vi(this.renderer,new Float32Array(o),{uv:2}),this.meshInfoIndexBuffer=new vi(this.renderer,new Float32Array(l),{meshInfoIndex:1}),this.bufferGroup=new wi([this.positionBuffer,this.normalBuffer,this.tangentBuffer,this.uvBuffer,this.meshInfoIndexBuffer]);let u=e.getParameter(e.MAX_TEXTURE_SIZE),m=this.meshInfoTextureWidth=I.ceilPowerOf2(Math.min(4*s.length,u)),p=this.meshInfoTextureHeight=I.ceilPowerOf2(Math.ceil(4*s.length/Math.max(u,m))),g=e instanceof WebGLRenderingContext?e.RGBA:e.RGBA32F;this.meshInfoBuffer=new Float32Array(4*m*p),this.meshInfoTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.meshInfoTexture),e.texImage2D(e.TEXTURE_2D,0,g,m,p,0,e.RGBA,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);let f=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint32Array(c),e.STATIC_DRAW),this.opaqueIndexBuffer=f,this.shadowCasterIndices=h,this.shadowCasterIndexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.shadowCasterIndexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint32Array(h),e.STATIC_DRAW);let y=s.map(e=>e.geometry.indices.length).reduce((e,t)=>e+t,0),b=e.createBuffer(),v=new Uint32Array(y);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,b),e.bufferData(e.ELEMENT_ARRAY_BUFFER,v,e.DYNAMIC_DRAW),this.transparentIndexBuffer=b,this.transparentIndexBufferData=v;let w=new i;this.ambientLights.forEach(e=>w.add(e.color)),this.ambientLightBuffer=new Float32Array(w.toArray());let x=new i,S=new i;for(let e of this.directionalLights)x.add(e.color),S.addScaledVector(e.direction,1/this.directionalLights.length);this.directionalLightColorBuffer=new Float32Array(x.toArray()),this.directionalLightDirectionBuffer=new Float32Array(S.toArray()),this.directionalLightTransformBuffer=new Float32Array(16),this.compiled=!0}updateMaterialGroup(e,t){let i=t.material,s=i.getHash(),n=e.get(s);return n||(n={material:i,indexGroups:[],defineChunk:i.getDefineChunk(),offset:0,count:0,minDistance:1/0},e.set(s,n)),n.indexGroups.push(t),n.count+=t.indices.length,n}computeTangents(e,t,s,n){let r=e.length/3/3,a=new i,o=new i,l=new i,h=new _,d=new _,c=new _,u=new i,m=new i,p=new i,g=new i;for(let i=0;i<r;i++){a.set(e[9*i+0],e[9*i+1],e[9*i+2]),o.set(e[9*i+3],e[9*i+4],e[9*i+5]),l.set(e[9*i+6],e[9*i+7],e[9*i+8]),h.set(s[6*i+0],s[6*i+1]),d.set(s[6*i+2],s[6*i+3]),c.set(s[6*i+4],s[6*i+5]);let r=o.x-a.x,f=l.x-a.x,y=o.y-a.y,b=l.y-a.y,v=o.z-a.z,w=l.z-a.z,x=d.x-h.x,S=c.x-h.x,T=d.y-h.y,M=c.y-h.y,C=1/(x*M-S*T);u.set((M*r-T*f)*C,(M*y-T*b)*C,(M*v-T*w)*C),m.set((x*f-S*r)*C,(x*b-S*y)*C,(x*w-S*v)*C);for(let e=0;e<3;e++){p.set(t[9*i+3*e+0],t[9*i+3*e+1],t[9*i+3*e+2]),g.copy(u).addScaledVector(p,-p.dot(u)).normalize();let s=p.cross(u).dot(m)<0?-1:1;n.push(g.x,g.y,g.z,s)}}}prepareForRender(e){var t;let{gl:s}=this.renderer;this.update(),null===(t=this.directionalLights[0])||void 0===t||t.renderShadowMap(this);let n=new i,r=e.position,a=this.allMeshes.filter(e=>e.hasTransparentMaterials||e.opacity<1&&e.opacity>0);for(let e of a)e.distanceToCamera=n.setFromMatrixPosition(e.worldTransform).distanceToSquared(r);let o=a.sort((e,t)=>t.distanceToCamera-e.distanceToCamera),l=new Map;for(let e of o)for(let t of e.materialIndices){let i=t.material,s=e.opacity*i.opacity;if(!i.transparent&&1===s||0===s)continue;let n=this.updateMaterialGroup(l,t);n.minDistance=Math.min(n.minDistance,e.distanceToCamera)}let h=[...l].map(e=>e[1]);h.sort((e,t)=>t.minDistance-e.minDistance),this.transparentMaterialGroups=h;let d=0;for(let e of h){e.offset=d;for(let t of e.indexGroups)this.transparentIndexBufferData.set(t.indexBuffer,d),d+=t.indices.length}s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.transparentIndexBuffer),s.bufferSubData(s.ELEMENT_ARRAY_BUFFER,0,this.transparentIndexBufferData,0,d),this.preparedForRender=!0}update(){let{gl:e}=this.renderer;this.updateWorldTransform();for(let e=0;e<this.allMeshes.length;e++){let t=this.allMeshes[e];if(t.needsVertexBufferUpdate){let e=t.vboOffset;this.positionBuffer.set(t.geometry.positions,3*e),this.normalBuffer.set(t.geometry.normals,3*e),this.uvBuffer.set(t.geometry.uvs,2*e),t.needsVertexBufferUpdate=!1}(this.firstUpdate||t.needsMeshInfoBufferUpdate)&&t.updateMeshInfoBuffer(this.meshInfoBuffer,16*e)}e.bindTexture(e.TEXTURE_2D,this.meshInfoTexture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,this.meshInfoTextureWidth,this.meshInfoTextureHeight,e.RGBA,e.FLOAT,this.meshInfoBuffer),this.positionBuffer.update(),this.normalBuffer.update(),this.uvBuffer.update(),this.updateDirectionalLights(),this.firstUpdate=!1}updateDirectionalLights(){let e=this.directionalLights[0];if(e&&e.camera){let t=new h;t.multiplyMatrices(e.camera.projectionMatrix,e.camera.matrixWorldInverse),this.directionalLightTransformBuffer.set(t.elements,0)}}dispose(){let{gl:e}=this.renderer;this.positionBuffer.dispose(),this.normalBuffer.dispose(),this.tangentBuffer.dispose(),this.uvBuffer.dispose(),this.meshInfoIndexBuffer.dispose(),e.deleteTexture(this.meshInfoTexture),e.deleteBuffer(this.opaqueIndexBuffer),e.deleteBuffer(this.transparentIndexBuffer),e.deleteBuffer(this.shadowCasterIndexBuffer),this.particleManager.dispose();for(let e of this.directionalLights)e.dispose()}}class Mn{constructor(e){this.color=e}}class Cn{constructor(e,t,i){this.camera=null,this.renderer=e,this.color=t,this.direction=i}enableShadowCasting(e,t){I.assert(I.isPowerOf2(e));let{gl:i}=this.renderer;this.camera=t;let s=i.createTexture(),n=i instanceof WebGLRenderingContext?i.DEPTH_COMPONENT:i.DEPTH_COMPONENT32F,r=i instanceof WebGLRenderingContext?i.UNSIGNED_INT:i.FLOAT;i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,n,e,e,0,i.DEPTH_COMPONENT,r,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),this.depthTexture=s;let a=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,s,0),this.depthFramebuffer=a;let o=i.createTexture();i.bindTexture(i.TEXTURE_2D,o),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),this.colorTexture=o,i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,o,0),this.depthTexture=s,this.textureResolution=e}updateCamera(e,t){this.camera&&(this.camera.position.copy(e.clone().addScaledVector(this.direction,t)),this.camera.lookAt(this.camera.position.clone().add(this.direction)),this.camera.updateMatrixWorld())}renderShadowMap(e){if(!this.camera)return;let{gl:t,shadowMapProgram:i}=this.renderer;t.depthMask(!0),t.bindFramebuffer(t.FRAMEBUFFER,this.depthFramebuffer),t.viewport(0,0,this.textureResolution,this.textureResolution),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),i.use(),i.bindVertexBufferGroup(e.bufferGroup),t.uniformMatrix4fv(i.getUniformLocation("viewMatrix"),!1,new Float32Array(this.camera.matrixWorldInverse.elements)),t.uniformMatrix4fv(i.getUniformLocation("projectionMatrix"),!1,new Float32Array(this.camera.projectionMatrix.elements)),t.uniform1i(i.getUniformLocation("meshInfoTextureWidth"),e.meshInfoTextureWidth),t.uniform1i(i.getUniformLocation("meshInfoTextureHeight"),e.meshInfoTextureHeight),t.uniform1i(i.getUniformLocation("meshInfos"),7),this.renderer.bindTexture(e.meshInfoTexture,7,t.TEXTURE_2D),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.shadowCasterIndexBuffer),t.drawElements(t.TRIANGLES,e.shadowCasterIndices.length,t.UNSIGNED_INT,0)}bindShadowMap(){let{gl:e}=this.renderer;this.renderer.bindTexture(this.depthTexture,2,e.TEXTURE_2D)}dispose(){if(!this.camera)return;let{gl:e}=this.renderer;e.deleteTexture(this.depthTexture),e.deleteTexture(this.colorTexture),e.deleteFramebuffer(this.depthFramebuffer)}}const kn=1,An=-52,_n=8;let In=new i,En=new i,Bn=new r;class Pn{constructor(){this.beforeOperation=null,this.root=new Ln(this,0),this.root.min.set(0,0,0),this.root.size=kn,this.objectToNode=new WeakMap}insert(e){if(this.objectToNode.get(e))return;for(;!this.root.largerThan(e)||!this.root.containsCenter(e);){if(this.root.depth===An)return console.log(e),console.warn(`Can't insert ${this.root.largerThan(e)?"distant":"large"} object into octree; the octree has already expanded to its maximum size.`),void this.shrink();this.grow(e)}let t=0===this.root.count;this.root.insert(e),t&&this.shrink()}remove(e){let t=this.objectToNode.get(e);t&&(t.remove(e),this.objectToNode.delete(e),this.shrink())}update(e){let t=this.objectToNode.get(e);t?t.update(e)||(this.objectToNode.delete(e),this.insert(e)):this.insert(e)}grow(e){let t=In.set(0,0,0),i=0;for(let s=0;s<8;s++){let n=En;n.setComponent(0,1&s?e.boundingBox.min.x:e.boundingBox.max.x),n.setComponent(1,2&s?e.boundingBox.min.y:e.boundingBox.max.y),n.setComponent(2,4&s?e.boundingBox.min.z:e.boundingBox.max.z),this.root.containsPoint(n)||(t.add(n),i++)}t.multiplyScalar(1/i);let s=En.copy(this.root.min).addScalar(this.root.size/2),n=t.sub(s),r=new Ln(this,this.root.depth-1);if(r.min.copy(this.root.min),r.size=2*this.root.size,n.x<0&&(r.min.x-=this.root.size),n.y<0&&(r.min.y-=this.root.size),n.z<0&&(r.min.z-=this.root.size),this.root.count>0){let e=(n.x<0?1:0)+(n.y<0?2:0)+(n.z<0?4:0);r.createOctants(),r.octants[e]=this.root,this.root.parent=r,r.count=this.root.count,r.merge()}this.root=r}shrink(){if(this.root.size<=kn)return;if(0===this.root.count)return this.root.min.set(0,0,0),this.root.size=kn,void(this.root.depth=0);if(!this.root.octants){this.root.createOctants();let e=null;for(let t of this.root.objects){if(!this.root.octants[0].largerThan(t))return;for(let i=0;i<8;i++){let s=this.root.octants[i];if(s.containsCenter(t)){if(e&&e!==s)return;e=s}}}return this.root.size/=2,this.root.min.copy(e.min),this.root.depth++,this.root.octants=null,void this.shrink()}let e;for(let t=0;t<8;t++){let i=this.root.octants[t];if(i.count>0){if(e)return;e=i}}this.root=e,e.parent=null,this.shrink()}intersectAabb(e){var t;null===(t=this.beforeOperation)||void 0===t||t.call(this);let i=[];return this.root.intersectAabb(e,i),i}}class Ln{constructor(e,t){this.parent=null,this.min=new i,this.octants=null,this.objects=new Set,this.count=0,this.octree=e,this.depth=t}insert(e){if(this.count++,this.octants){if(this.octants[0].largerThan(e))for(let t=0;t<8;t++){let i=this.octants[t];if(i.containsCenter(e))return void i.insert(e)}this.objects.add(e),this.octree.objectToNode.set(e,this)}else this.objects.add(e),this.octree.objectToNode.set(e,this),this.split()}split(){if(!(this.objects.size<=8||this.depth===_n)){this.createOctants();for(let e of this.objects)if(this.octants[0].largerThan(e))for(let t=0;t<8;t++){let i=this.octants[t];i.containsCenter(e)&&(i.insert(e),this.objects.delete(e))}for(let e=0;e<8;e++)this.octants[e].split()}}createOctants(){this.octants=[];for(let e=0;e<8;e++){let t=new Ln(this.octree,this.depth+1);t.parent=this,t.size=this.size/2,t.min.set(this.min.x+t.size*((1&e)>>0),this.min.y+t.size*((2&e)>>1),this.min.z+t.size*((4&e)>>2)),this.octants.push(t)}}remove(e){this.objects.delete(e),this.count--,this.merge();let t=this.parent;for(;t;)t.count--,t.merge(),t=t.parent}update(e){this.objects.delete(e);let t=this;for(;t;){if(t.count--,t.merge(),t.largerThan(e)&&t.containsCenter(e))return t.insert(e),!0;t=t.parent}return!1}merge(){if(!(this.count>8)&&this.octants){for(let e=0;e<8;e++){let t=this.octants[e];for(let e of t.objects)this.objects.add(e),this.octree.objectToNode.set(e,this)}this.octants=null}}largerThan(e){let t=e.boundingBox;return this.size>t.max.x-t.min.x&&this.size>t.max.y-t.min.y&&this.size>t.max.z-t.min.z}containsCenter(e){let t=e.boundingBox,i=t.min.x+(t.max.x-t.min.x)/2,s=t.min.y+(t.max.y-t.min.y)/2,n=t.min.z+(t.max.z-t.min.z)/2;return this.min.x<=i&&i<this.min.x+this.size&&this.min.y<=s&&s<this.min.y+this.size&&this.min.z<=n&&n<this.min.z+this.size}containsPoint(e){let{x:t,y:i,z:s}=e;return this.min.x<=t&&t<this.min.x+this.size&&this.min.y<=i&&i<this.min.y+this.size&&this.min.z<=s&&s<this.min.z+this.size}intersectAabb(e,t){let i=Bn;if(i.min.copy(this.min).addScalar(-this.size/2),i.max.copy(this.min).addScalar(3*this.size/2),e.intersectsBox(i)){if(this.objects.size>0)for(let i of this.objects)e.intersectsBox(i.boundingBox)&&t.push(i);if(this.octants)for(let i=0;i<8;i++){let s=this.octants[i];0!==s.count&&s.intersectAabb(e,t)}}}}let Rn=new i,Fn=new t;class zn{constructor(e,t){this.timeOfImpact=1,this.s1MaterialOverride=null,this.s2MaterialOverride=null,this.s1=e,this.s2=t,this.friction=e.friction*t.friction,this.restitution=e.restitution*t.restitution,this.s1Friction=e.friction,this.s1Restitution=e.restitution,this.s2Friction=t.friction,this.s2Restitution=t.restitution}supplyCollisionPlane(e){this.normal=e.normal.clone(),this.depth=e.constant,this.point1=this.s1.support(new i,Rn.copy(this.normal).negate()),this.point2=this.point1.clone().addScaledVector(this.normal,this.depth),this.point=this.point1.clone().add(this.point2).multiplyScalar(.5)}updateMaterialProperties(){if(this.normal&&(this.s1.materialOverrides.size>0||this.s2.materialOverrides.size>0)){let e=this.s1.friction,t=this.s2.friction,i=this.s1.restitution,s=this.s2.restitution,n=-1/0,r=1/0,a=Rn;Fn.copy(this.s1.body.orientation).conjugate(),a.copy(this.normal).applyQuaternion(Fn);for(let[t,s]of this.s1.materialOverrides){let n=t.dot(a);n<r&&(r=n,e=s.friction,i=s.restitution,this.s1MaterialOverride=t)}Fn.copy(this.s2.body.orientation).conjugate(),a.copy(this.normal).applyQuaternion(Fn);for(let[e,i]of this.s2.materialOverrides){let r=e.dot(a);r>n&&(n=r,t=i.friction,s=i.restitution,this.s2MaterialOverride=e)}this.friction=e*t,this.restitution=i*s,this.s1Friction=e,this.s1Restitution=i,this.s2Friction=t,this.s2Restitution=s}}}const Dn=64,Un=64,Vn=10*Number.EPSILON,On=64,Nn=64;let qn=[new i,new i,new i,new i],jn=0,Gn=new i,Wn=new i,Hn=new i,Xn=new i,Yn=new i,Qn=new i,Kn=new i,$n=new i,Zn=new i,Jn=new i,er=new i,tr=new i,ir=new i,sr=new i,nr=new i,rr=new i,ar=new i,or=new i,lr=new i,hr=new i,dr=new i,cr=new i,ur=0,mr=null,pr=null,gr=new i(0,0,0),fr=new A,yr=new Kt;yr.addCollisionShape(fr);let br=[],vr=[];for(let e=0;e<Nn;e++)br.push([new i,new i,new i,new i]);for(let e=0;e<On;e++)vr.push([new i,new i]);class wr{static support(e,t,i,s){return t.support(e,s).sub(i.support(nr,rr.copy(s).negate()))}static checkIntersection(e,t){return mr=e,pr=t,e instanceof C&&t instanceof C?this.checkBallBallIntersection(e,t):e instanceof C?this.checkBallConvexIntersection(e,t):this.checkConvexConvexIntersection(e,t)}static checkBallBallIntersection(e,t){return e.body.position.distanceTo(t.body.position)<=e.radius+t.radius}static checkBallConvexIntersection(e,t){return yr.position.copy(e.body.position),this.determineClosestPoint(new i,t,fr).lengthSq()<=e.radius**2}static checkConvexConvexIntersection(e,t){Wn.copy(t.body.position).sub(e.body.position).normalize(),this.support(Gn,e,t,Wn),jn=1,qn[0].copy(Gn),Wn.copy(Gn).negate();for(let i=0;i<Dn;i++){if(this.support(Gn,e,t,Wn),Gn.dot(Wn)<=0)return!1;if(this.addPointToSimplex(Gn),this.updateSimplexFast(),4===jn)return!0}return!1}static determineClosestPoint(e,t,i){Wn.copy(i.body.position).sub(t.body.position),jn=0;for(let e=0;e<Dn&&4!==jn&&(this.support(Gn,t,i,Wn),!(Wn.lengthSq()+Wn.dot(Gn)<=10*Number.EPSILON));e++)this.addPointToSimplex(Gn),this.updateSimplexAndClosestPoint(Wn),Wn.negate();return e.copy(Wn).negate()}static determineTimeOfImpact(e,t,i=.03){e.body.getRelativeMotionVector(ar,t.body);let s=ar.length();or.copy(e.body.position),lr.copy(t.body.position),e.body.position.copy(e.body.prevPosition),t.body.position.copy(t.body.prevPosition);let n=this.castRay(t,e,gr,ar,1);if(e.body.position.copy(or),t.body.position.copy(lr),!n)return null;let r=Math.min(i*s,i/s);return n.lambda+=r,n.lambda=I.clamp(n.lambda,0,1),n.lambda}static castRay(e,t,i,s,n){Wn.copy(t.body.position).sub(e.body.position).normalize(),this.support(Gn,e,t,Wn),jn=0,hr.copy(i),dr.setScalar(0);let r=0;Wn.copy(hr).sub(Gn);for(let a=0;a<Dn;a++){if(this.support(Gn,e,t,Wn),cr.copy(hr).sub(Gn),Wn.dot(cr)>0){if(Wn.dot(s)>=0)return null;if((r-=Wn.dot(cr)/Wn.dot(s))>n)return null;hr.copy(i).addScaledVector(s,r),dr.copy(Wn)}this.addPointToSimplex(Gn);for(let e=0;e<jn;e++)qn[e].sub(hr);this.updateSimplexAndClosestPoint(Wn),Wn.negate();for(let e=0;e<jn;e++)qn[e].add(hr);let a=0;for(let e=0;e<jn;e++)a=Math.max(a,qn[e].distanceToSquared(hr));if(Wn.lengthSq()<10*Number.EPSILON*a)return{point:hr.clone(),lambda:r,normal:dr.clone().normalize()}}return null}static addPointToSimplex(e){for(let t=0;t<jn;t++)if(e.distanceToSquared(qn[t])<10*Number.EPSILON)return;for(let e=jn;e>0;e--)qn[e].copy(qn[e-1]);qn[0].copy(e),jn++}static updateSimplexFast(){switch(jn){case 2:return this.updateLine();case 3:return this.updateTriangle();case 4:return this.updateTetrahedron();default:throw new Error("Shouldn't happen: "+jn)}}static updateLine(){let e=qn[0],t=qn[1];Qn.copy(t).sub(e),Hn.copy(e).negate(),Qn.dot(Hn)>0?Wn.copy(Qn).cross(Hn).cross(Qn):(jn--,Wn.copy(Hn))}static updateTriangle(){let e=qn[0],t=qn[1],i=qn[2];if(Qn.copy(t).sub(e),Kn.copy(i).sub(e),Hn.copy(e).negate(),er.copy(Qn).cross(Kn),nr.copy(er).cross(Kn).dot(Hn)>0){if(!(Kn.dot(Hn)>0))return jn--,this.updateLine();t.copy(i),jn--,Wn.copy(Kn).cross(Hn).cross(Kn)}else{if(nr.copy(Qn).cross(er).dot(Hn)>0)return jn--,this.updateLine();er.dot(Hn)>0?Wn.copy(er):(nr.copy(i),i.copy(t),t.copy(nr),Wn.copy(er).negate())}}static updateTetrahedron(){let e=qn[0],t=qn[1],i=qn[2],s=qn[3];return Qn.copy(t).sub(e),Kn.copy(i).sub(e),$n.copy(s).sub(e),Hn.copy(e).negate(),er.copy(Qn).cross(Kn),tr.copy(Kn).cross($n),ir.copy($n).cross(Qn),er.dot(Hn)>0?(jn--,this.updateTriangle()):tr.dot(Hn)>0?(t.copy(i),i.copy(s),jn--,this.updateTriangle()):ir.dot(Hn)>0?(i.copy(t),t.copy(s),jn--,this.updateTriangle()):void 0}static updateSimplexAndClosestPoint(e){let t;switch(ur=0,jn){case 1:t=this.closestPointPoint(e,qn[0]);break;case 2:t=this.closestPointLineSegment(e,qn[0],qn[1]);break;case 3:t=this.closestPointTriangle(e,qn[0],qn[1],qn[2]);break;case 4:t=this.closestPointTetrahedron(e,qn[0],qn[1],qn[2],qn[3]);break;default:throw new Error("Shouldn't get here! "+jn)}let i=0;for(let e=0;e<4;e++)t&1<<e&&(qn[i].copy(qn[e]),i++);jn=i,ur&&(nr.copy(qn[1]),qn[1].copy(qn[2]),qn[2].copy(nr))}static closestPointPoint(e,t){return e.copy(t),1}static closestPointLineSegment(e,t,i){Qn.copy(i).sub(t),Hn.copy(t).negate();let s=I.clamp(Qn.dot(Hn)/Qn.dot(Qn),0,1);return 0===s?(e.copy(t),1):1===s?(e.copy(i),2):(e.copy(t).addScaledVector(Qn,s),3)}static closestPointTriangle(e,t,i,s){Qn.copy(i).sub(t),Kn.copy(s).sub(t),Hn.copy(t).negate();let n=Qn.dot(Hn),r=Kn.dot(Hn);if(n<=0&&r<=0)return e.copy(t),1;Xn.copy(i).negate();let a=Qn.dot(Xn),o=Kn.dot(Xn);if(a>=0&&o<=a)return e.copy(i),2;let l=n*o-a*r;if(l<=0&&n>=0&&a<=0){let i=n/(n-a);return e.copy(t).addScaledVector(Qn,i),3}Yn.copy(s).negate();let h=Qn.dot(Yn),d=Kn.dot(Yn);if(d>=0&&h<=d)return e.copy(s),4;let c=h*r-n*d;if(c<=0&&r>=0&&d<=0){let i=r/(r-d);return e.copy(t).addScaledVector(Kn,i),5}let u=a*d-h*o;if(u<=0&&o-a>=0&&h-d>=0){Zn.copy(s).sub(i);let t=(o-a)/(o-a+(h-d));return e.copy(i).addScaledVector(Zn,t),6}let m=1/(u+c+l),p=c*m,g=l*m;return e.copy(t).addScaledVector(Qn,p).addScaledVector(Kn,g),er.copy(Qn).cross(Kn),er.dot(e)>0&&(ur^=1),7}static closestPointTetrahedron(e,t,i,s,n){Qn.copy(i).sub(t),Kn.copy(s).sub(t),$n.copy(n).sub(t),Zn.copy(s).sub(i),Jn.copy(n).sub(i),Hn.copy(t).negate(),Xn.copy(i).negate(),er.copy(Qn).cross(Kn),tr.copy(Kn).cross($n),ir.copy($n).cross(Qn),sr.copy(Jn).cross(Zn);let r,a,o=er.dot(Hn)>0,l=tr.dot(Hn)>0,h=ir.dot(Hn)>0,d=sr.dot(Xn)>0,c=Math.abs(er.dot($n))<10*Number.EPSILON,u=1/0;if(o||c){ur=0;let n=this.closestPointTriangle(nr,t,i,s),o=nr.lengthSq();e.copy(nr),u=o,r=n,a=ur}if(l||c){ur=0;let i=this.closestPointTriangle(nr,t,s,n),o=nr.lengthSq();o<u&&(e.copy(nr),u=o,r=1&i|(2&i)<<1|(4&i)<<1,a=ur)}if(h||c){ur=0;let s=this.closestPointTriangle(nr,t,n,i),o=nr.lengthSq();o<u&&(e.copy(nr),u=o,r=1&s|(2&s)<<2|(4&s)>>1,a=1^ur)}if(d||c){ur=0;let t=this.closestPointTriangle(nr,i,n,s),o=nr.lengthSq();o<u&&(e.copy(nr),u=o,r=(1&t)<<1|(2&t)<<2|4&t,a=1^ur)}return u===1/0&&(e.setScalar(0),r=15,a=0),ur=a,r}static determineCollisionPlane(e){return mr instanceof C&&pr instanceof C?this.determineBallBallCollisionPlane(e):mr instanceof C?this.determineBallConvexCollisionPlane(e):this.determineConvexConvexCollisionPlane(e)}static determineBallBallCollisionPlane(e){let t=mr.radius+pr.radius-mr.body.position.distanceTo(pr.body.position);return e.normal.copy(mr.body.position).sub(pr.body.position).normalize(),e.constant=t,e}static determineBallConvexCollisionPlane(e){let t=Wn.length();return 0===t?this.determineConvexConvexCollisionPlane(e):(e.normal.copy(Wn).normalize(),e.constant=mr.radius-t,e)}static determineConvexConvexCollisionPlane(e){let t=qn[0],i=qn[1],s=qn[2],n=qn[3];br[0][0].copy(t),br[0][1].copy(i),br[0][2].copy(s),br[0][3].copy(i).sub(t).cross(nr.copy(s).sub(t)).normalize(),br[1][0].copy(t),br[1][1].copy(s),br[1][2].copy(n),br[1][3].copy(s).sub(t).cross(nr.copy(n).sub(t)).normalize(),br[2][0].copy(t),br[2][1].copy(n),br[2][2].copy(i),br[2][3].copy(n).sub(t).cross(nr.copy(i).sub(t)).normalize(),br[3][0].copy(i),br[3][1].copy(n),br[3][2].copy(s),br[3][3].copy(n).sub(i).cross(nr.copy(s).sub(i)).normalize();let r=4,a=0;for(let t=0;t<Nn;t++){let t=br[0][0].dot(br[0][3]);a=0;for(let e=1;e<r;e++){let i=br[e][0].dot(br[e][3]);i<t&&(t=i,a=e)}Wn.copy(br[a][3]),this.support(Gn,mr,pr,Wn);let i=Gn.dot(Wn);if(e.constant=Math.abs(i),br[a][3].lengthSq()>0&&e.normal.copy(br[a][3]).multiplyScalar(Math.sign(i)||1).negate(),i-t<Vn)return e;let s=0,n=0;for(;n<r;){if(br[n][3].dot(nr.copy(Gn).sub(br[n][0]))>0){for(let e=0;e<3;e++){let t=[br[n][e],br[n][(e+1)%3]],i=!1;for(let e=0;e<s;e++)if(vr[e][1].equals(t[0])&&vr[e][0].equals(t[1])){vr[e][0].copy(vr[s-1][0]),vr[e][1].copy(vr[s-1][1]),s--,i=!0;break}if(!i){if(s>=On)break;vr[s][0].copy(t[0]),vr[s][1].copy(t[1]),s++}}br[n][0].copy(br[r-1][0]),br[n][1].copy(br[r-1][1]),br[n][2].copy(br[r-1][2]),br[n][3].copy(br[r-1][3]),r--,n--}n++}for(let e=0;e<s&&!(r>=Un);e++){br[r][0].copy(vr[e][0]),br[r][1].copy(vr[e][1]),br[r][2].copy(Gn),br[r][3].copy(vr[e][0]).sub(vr[e][1]).cross(nr.copy(vr[e][0]).sub(Gn)).normalize();let t=1e-6;if(br[r][0].dot(br[r][3])+t<0){let e=br[r][0];br[r][0].copy(br[r][1]),br[r][1].copy(e),br[r][3].negate()}r++}}let o=br[a][0].dot(br[a][3]);return e.constant=Math.abs(o),e.normal.copy(br[a][3]).multiplyScalar(Math.sign(o)||1).negate(),e}static clearReferences(){mr=null,pr=null}}let xr=new i,Sr=new i,Tr=new i,Mr=new i,Cr=new i,kr=new i,Ar=new i,_r=new l,Ir=new l,Er=new l,Br=new l,Pr=new l,Lr=new l,Rr=new l,Fr=new l,zr=new l,Dr=new i,Ur=new i,Vr=new i,Or=new i,Nr=new i,qr=new l;class jr{static solvePosition(e){if(e.depth<.002)return;let t=e.depth-.001;e.s1.body.position.addScaledVector(e.normal,t)}static solveVelocity(e){e.s1.getCenter(xr),e.s2.getCenter(Sr),Tr.copy(e.point).sub(xr),Mr.copy(e.point).sub(Sr),Cr.copy(e.normal),0===Cr.z?kr.set(Cr.y,-Cr.x,0):kr.set(0,Cr.z,-Cr.y),kr.normalize(),Ar.copy(Cr).cross(kr),_r.set(Cr.x,kr.x,Ar.x,Cr.y,kr.y,Ar.y,Cr.z,kr.z,Ar.z),Ir.copy(_r).transpose(),Er.identity().multiplyScalar(1/e.s1.mass),Br.identity().multiplyScalar(1/e.s2.mass),Pr.set(0,-Tr.z,Tr.y,Tr.z,0,-Tr.x,-Tr.y,Tr.x,0),Lr.set(0,-Mr.z,Mr.y,Mr.z,0,-Mr.x,-Mr.y,Mr.x,0),Rr.copy(Er).sub(qr.copy(Pr).multiply(e.s1.invInertia).multiply(Pr)).add(Br).sub(qr.copy(Lr).multiply(e.s2.invInertia).multiply(Lr)),Fr.copy(Ir).multiply(Rr).multiply(_r),zr.copy(Fr).invert();let t=e.s1.body,i=e.s2.body;Dr.copy(t.angularVelocity).cross(Tr).add(t.linearVelocity).applyMatrix3(Ir),Ur.copy(i.angularVelocity).cross(Mr).add(i.linearVelocity).applyMatrix3(Ir);let s=Dr.x-Ur.x;if(s>-1e-4)return;let n=e.restitution;s>-.5&&(n=0),Vr.set(-(1+n)*(Dr.x-Ur.x),-(Dr.y-Ur.y),-(Dr.z-Ur.z)),Or.copy(Vr).applyMatrix3(zr);let r=Or.y**2+Or.z**2;if(r>e.friction**2*Or.x**2){let t=e.friction/Math.sqrt(r);Or.x=Vr.x/(Fr.elements[0]+t*(Fr.elements[3]*Or.y+Fr.elements[6]*Or.z));let i=t*Or.x;Or.y*=i,Or.z*=i}Nr.copy(Or).applyMatrix3(_r),t.linearVelocity.addScaledVector(Nr,1/e.s1.mass),t.angularVelocity.add(Tr.cross(Nr).applyMatrix3(e.s1.invInertia)),i.linearVelocity.addScaledVector(Nr,-1/e.s2.mass),i.angularVelocity.sub(Mr.cross(Nr).applyMatrix3(e.s2.invInertia))}}const Gr=10;let Wr=new i,Hr=new i,Xr=new i,Yr=new ei,Qr=new r,Kr=new A,$r=new class extends M{constructor(e,t){super(),this.s1=e,this.s2=t}updateInertiaTensor(){}support(e,t){let i=this.s1.support(w,t),s=this.s2.support(x,t);return i.dot(t)>s.dot(t)?e.copy(i):e.copy(s),e}getCenter(e){return this.s1.getCenter(e).add(this.s2.getCenter(w)).multiplyScalar(.5)}}(null,null),Zr=new Kt;Zr.addCollisionShape(Kr),Zr.addCollisionShape($r);class Jr{constructor(){this.bodies=[],this.gravity=new i,this.octree=new Pn,this.inContactCcd=new Set,this.newInContactCcd=new Set,this.inContact=new Set,this.newInContact=new Set,this.cachedBroadphaseResults=new Map}add(e){if(e.world)throw new Error("RigidBody already belongs to a world.");this.bodies.push(e),e.world=this,e.syncShapes()}step(e){this.substep(e,0,0)}substep(e,t,i){if(e<1e-5||i>=Gr)return;let s=[];for(let t=0;t<this.bodies.length;t++){let i=this.bodies[t];i.enabled&&(i.storePrevious(),i.onBeforeIntegrate(e),i.integrate(e),i.onAfterIntegrate(e),i.collisions.length=0,i.type===Ht.Dynamic&&s.push(...i.shapes))}this.cachedBroadphaseResults.clear();let n=this.computeCollisions(s,!0),r=1;for(let e=0;e<n.length;e++){let t=n[e];this.inContactCcd.has(t.s2)||(r=Math.min(t.timeOfImpact,r))}let a=t+r*(1-t);for(let t=0;t<this.bodies.length;t++){let i=this.bodies[t];if(!i.enabled)continue;if(i.revert(r),i.collisions.length=0,i.type!==Ht.Dynamic)continue;let s=Wr.set(0,0,0);s.add(this.gravity),i.linearVelocity.addScaledVector(s,e*r)}let o=this.computeCollisions(s,!1),l=[];for(let e=0;e<o.length;e++){let t=o[e];l.includes(t.s1.body)||l.push(t.s1.body),l.includes(t.s2.body)||l.push(t.s2.body)}l.sort((e,t)=>e.evaluationOrder-t.evaluationOrder);for(let t=0;t<l.length;t++)l[t].onBeforeCollisionResponse(a,e*r);for(let e=0;e<o.length;e++){let t=o[e];0!=(t.s1.collisionResponseMask&t.s2.collisionResponseMask)&&(jr.solvePosition(t),jr.solveVelocity(t))}for(let t=0;t<l.length;t++)l[t].onAfterCollisionResponse(a,e*r);this.inContactCcd=this.newInContactCcd,this.newInContactCcd=new Set,this.inContact=this.newInContact,this.newInContact=new Set,this.substep(e*(1-r),a,i+1)}computeCollisions(e,t){let i=[];for(let s=0;s<e.length;s++){let n=e[s];if(!n.body.enabled)continue;let r=n.broadphaseShape||n,a=this.cachedBroadphaseResults.get(r),o=[];a||(a=this.octree.intersectAabb(r.boundingBox),this.cachedBroadphaseResults.set(r,a));e:for(let e=0;e<a.length;e++){let s=a[e];if(n!==s&&0!=(n.collisionDetectionMask&s.collisionDetectionMask)&&s.body.enabled){for(let e=0;e<i.length;e++){let t=i[e];if(t.s1===s&&t.s2===n)continue e}if(t){let e=wr.determineTimeOfImpact(n,s);if(null===e)continue;let t=new zn(n,s);t.timeOfImpact=e,this.newInContactCcd.add(s),i.push(t)}else{if(!wr.checkIntersection(n,s))continue;let e=new zn(n,s),t=!!(1&n.collisionDetectionMask);if(t){let t=wr.determineCollisionPlane(Yr);e.supplyCollisionPlane(t)}if(t)for(let t=0;t<o.length;t++){let i=o[t];if(e.point2.distanceToSquared(i.point2)>=.1**2)continue;$r.s1=i.s2,$r.s2=s,wr.checkIntersection(n,$r),wr.determineCollisionPlane(Yr);let r,a=Xr.copy(Yr.normal),l=e.normal.dot(i.normal);if(e.normal.dot(a)<l-1e-10||i.normal.dot(a)<l-1e-10)continue;r=s.boundingBox.min.distanceTo(s.boundingBox.max);let h=wr.castRay(s,Kr,s.getCenter(Wr).addScaledVector(a,r),Hr.copy(a).negate(),r);r=i.s2.boundingBox.min.distanceTo(i.s2.boundingBox.max);let d=wr.castRay(i.s2,Kr,i.s2.getCenter(Wr).addScaledVector(a,r),Hr.copy(a).negate(),r);h&&h.normal.dot(a)>=e.normal.dot(a)&&e.supplyCollisionPlane(Yr.set(h.normal,e.depth)),d&&d.normal.dot(a)>=i.normal.dot(a)&&i.supplyCollisionPlane(Yr.set(d.normal,i.depth));break}i.push(e),o.push(e),n.body.collisions.push(e),e.s2.body.collisions.push(e),this.newInContact.add(s)}}}}for(let e=0;e<i.length;e++)i[e].updateMaterialProperties();return i}castRay(e,t,i,s=1){Qr.makeEmpty(),Qr.expandByPoint(e),Qr.expandByPoint(Wr.copy(e).addScaledVector(t,i));let n=this.octree.intersectAabb(Qr),r=[];for(let a of n){if(0==(a.collisionDetectionMask&s))continue;let n=wr.castRay(a,Kr,e,t,i);n&&r.push(Object.assign(Object.assign({},n),{shape:a}))}return r.sort((e,t)=>e.lambda-t.lambda)}castShape(e,t,i){Qr.makeEmpty(),Qr.expandByPoint(e.boundingBox.min),Qr.expandByPoint(e.boundingBox.max),Qr.expandByPoint(Wr.copy(e.boundingBox.min).addScaledVector(t,i)),Qr.expandByPoint(Wr.copy(e.boundingBox.max).addScaledVector(t,i));let s=this.octree.intersectAabb(Qr),n=[],r=Hr.copy(t).negate();for(let t of s){if(e===t)continue;if(0==(e.collisionDetectionMask&t.collisionDetectionMask))continue;if(!t.body.enabled)continue;if(t.body.linearVelocity.lengthSq()>0)continue;let s=wr.castRay(e,t,Wr.setScalar(0),r,i);s&&n.push(Object.assign(Object.assign({},s),{shape:t}))}return n.sort((e,t)=>e.lambda-t.lambda)}}const ea=120,ta=1,ia={"shapes/images/helicopter.dts":-67,"shapes/items/superjump.dts":-70,"shapes/items/superbounce.dts":-55,"shapes/items/superspeed.dts":-53,"shapes/items/shockabsorber.dts":-53,"shapes/items/megamarble.dts":-70},sa={"shapes/items/megamarble.dts":60},na=3500,ra=.45,aa=25e3,oa=59999999,la=["astrolabe.ogg","endurance.ogg","flanked.ogg","grudge.ogg","mbp old shell.ogg","quiet lab.ogg","rising temper.ogg","seaside revisited.ogg","the race.ogg"],ha=document.querySelector("#decoy-canvas").getContext("2d"),da={MarbleBounceEmitter:Gi,MarbleTrailEmitter:Ii.MarbleTrailEmitter,MarbleSuperJumpEmitter:Object.assign(Ai.cloneOptions(hs),{emitterLifetime:5e3,ambientVelocity:new i(-.3,0,-.5)}),MarbleSuperSpeedEmitter:Object.assign(Ai.cloneOptions(Ms),{emitterLifetime:5e3,ambientVelocity:new i(-.5,0,-.5)}),LandMineEmitter:Ii.LandMineEmitter,LandMineSmokeEmitter:ws,LandMineSparkEmitter:xs,NukeEmitter:Ii.LandMineEmitter,NukeSmokeEmitter:Hs,NukeSparkEmitter:Xs,FireWorkSmokeEmitter:Zi,RedFireWorkSparkEmitter:ts,RedFireWorkTrailEmitter:Ji,BlueFireWorkSparkEmitter:is,BlueFireWorkTrailEmitter:es};class ca extends E{constructor(e,s=null){super(),this.interiors=[],this.sharedInteriorData=new Map,this.triggers=[],this.shapes=[],this.sharedShapeData=new Map,this.overlayShapes=[],this.lastPhysicsTick=null,this.lastFrameTime=null,this.offline=!1,this.offlineSettings=null,this.started=!1,this.paused=!0,this.pausedAt=null,this.stopped=!1,this.finishTime=null,this.maxDisplayedTime=0,this.pitch=0,this.yaw=0,this.lastVerticalTranslation=new i,this.currentUp=new i(0,0,1),this.orientationChangeTime=-1/0,this.oldOrientationQuat=new t,this.newOrientationQuat=new t,this.previousMouseMovementDistance=0,this.defaultGravity=20,this.currentTimeTravelBonus=0,this.heldPowerUp=null,this.totalGems=0,this.gemCount=0,this.blastAmount=0,this.outOfBounds=!1,this.jumpQueued=!1,this.useQueued=!1,this.blastQueued=!1,this.pressingRestart=!1,this.restartPressTime=null,this.currentCheckpoint=null,this.currentCheckpointTrigger=null,this.checkpointCollectedGems=new Set,this.checkpointHeldPowerUp=null,this.checkpointUp=null,this.checkpointBlast=null,this.analytics={missionPath:null,startTime:Date.now(),tries:0,finishes:0,outOfBoundsCount:0,timePaused:0,endTime:null,userRandomId:Y.data.randomId},this.mission=e,this.loadingState={loaded:0,total:0},this.offline=!!s,this.offlineSettings=s,this.analytics.missionPath=e.path}async init(){var e;for(let t of this.mission.allElements)[vt.InteriorInstance,vt.Item,vt.PathedInterior,vt.StaticShape,vt.TSStatic].includes(t._type)&&(this.loadingState.total++,t._type===vt.StaticShape&&["endpad","endpad_mbg","endpad_mbp"].includes(null===(e=t.datablock)||void 0===e?void 0:e.toLowerCase())&&(this.endPadElement=t));this.loadingState.total+=17,this.timeState={timeSinceLoad:-1e3/ea,currentAttemptTime:0,gameplayClock:0,physicsTickCompletion:0,tickIndex:0},void 0!==this.mission.misFile.marbleAttributes.gravity&&(this.defaultGravity=It.parseNumber(this.mission.misFile.marbleAttributes.gravity)),this.offline?(this.audio=new mt,this.audio.init({duration:this.offlineSettings.duration}),this.audio.setAssetPath(ft.assetPath),this.audio.soundGain.gain.value=this.offlineSettings.soundVolume**2,this.audio.musicGain.gain.value=this.offlineSettings.musicVolume**2,this.audio.currentTimeOverride=0):this.audio=ft,this.world=new Jr,await this.initScene(),await this.initMarble(),this.loadingState.loaded+=1,this.particles=new ki(this),await this.particles.init(he),this.scene.particleManager=this.particles;let t=this.initSounds();await this.addSimGroup(this.mission.root),await this.initUi(),this.loadingState.loaded+=3,await t,this.loadingState.loaded+=6,this.scene.compile(),this.loadingState.loaded+=1,this.replay=new ua(this)}async start(){if(!this.stopped){this.started=!0,this.paused=!1,this.restart(!0);for(let e of this.interiors)await e.onLevelStart();for(let e of this.shapes)await e.onLevelStart();this.audio.normalizePositionalAudioVolume(),this.music.play(),ue(!1),this.updateCamera(this.timeState),this.offline||(this.tryRender(),this.tickInterval=setInterval(this.tick.bind(this)),this.lastPhysicsTick=performance.now(),le.classList.remove("hidden"))}}async initScene(){this.scene=new Tn(he);let e=!1;for(let t of this.mission.allElements){if(t._type!==vt.Sun)continue;let s=It.parseVector4(t.color),n=It.parseVector4(t.ambient),r=It.parseVector3(t.direction);this.scene.addAmbientLight(new Mn(new i(n.x,n.y,n.z)));let a=new Cn(he,new i(s.x,s.y,s.z),r.clone());if(this.scene.addDirectionalLight(a),!e){e=!0;let t=new Ri(-1,1,1,-1,0,10);a.enableShadowCasting(256,t)}}let t=this.mission.allElements.find(e=>e._type===vt.Sky),s=It.parseVector4(t.fogcolor),n=It.parseVector4(t.skysolidcolor);if(.6===n.x&&.6===n.y&&.6===n.z||(s=n),s.x>1&&(s.x=1-(s.x-1)%256/256),s.y>1&&(s.y=1-(s.y-1)%256/256),s.z>1&&(s.z=1-(s.z-1)%256/256),he.setClearColor(s.x,s.y,s.z,1),this.camera=new Li(Y.data.settings.fov,window.innerWidth/window.innerHeight,.01,It.parseNumber(t.visibledistance)),"1"===t.useskytextures){let e=await this.createSkyboxCubeTexture(t.materiallist.slice(t.materiallist.indexOf("data/")+"data/".length),!0);if(e){let t=new Wt;t.isSky=!0,t.envMap=e,t.depthWrite=!1,t.renderOrder=-1e3;let i=new Nt;i.positions.push(-1,-1,0),i.positions.push(3,-1,0),i.positions.push(-1,3,0),i.materials.push(0,0,0),i.indices.push(0,1,2),i.fillRest();let s=new Gt(i,[t]);this.scene.add(s)}}let r=await this.createSkyboxCubeTexture("skies/sky_day.dml",!1,128);this.envMap=r}async createSkyboxCubeTexture(e,t,i){let s=e.slice(0,e.lastIndexOf("/")),n=await this.mission.getResource(e);if(n){let e=(await ne.readBlobAsText(n)).split("\n").map(e=>e.trim().toLowerCase()).slice(0,6).map(async e=>{let i,n=this.mission.getFullNamesOf(s+"/"+e)[0];if(n)try{i=await this.mission.getImage(s+"/"+n)}catch(e){console.error("Error loading skybox image:",e,"Defaulting to empty image."),i=new Image}else i=new Image;return t&&this.loadingState.loaded++,i}),r=await Promise.all(e);r=I.remapIndices(r,[1,3,4,5,0,2]),void 0!==i&&(r=await Promise.all(r.map(e=>I.resampleImage(e,i,i))));let a=r.flatMap(e=>[e.width,e.height]);if(new Set(a).size>1){let e=Math.max(...a);r=await Promise.all(r.map(t=>I.resampleImage(t,e,e)))}return new Ei(he,r)}return t&&(this.loadingState.loaded+=6),null}async initMarble(){this.marble=new Xi(this),await this.marble.init(),this.scene.add(this.marble.group),this.world.add(this.marble.body)}async initUi(){await e.menu.hud.load();let t=new Set;for(let e of this.shapes)if(e instanceof os||e instanceof rs){if(e instanceof os&&e.autoUse)continue;if(e instanceof en)for(let i of e.getAllDtsPaths())t.add(i);else t.add(e.dtsPath)}this.overlayScene=new Tn(he);let s=new Mn((new i).setScalar(1));this.overlayScene.addAmbientLight(s),this.overlayCamera=new Ri(-window.innerWidth/2,window.innerWidth/2,-window.innerHeight/2,window.innerHeight/2,1,1e3),this.overlayCamera.up.set(0,0,-1),this.overlayCamera.lookAt(new i(1,0,0));for(let i of t){let t=new bi;t.dtsPath=i,t.ambientRotate=!0,t.showSequences=!1,i.includes("gem")&&e.menu.hud instanceof fn&&(t.matNamesOverride["base.gem"]=rs.pickRandomColor()+".gem"),await t.init(),this.overlayShapes.push(t),this.overlayScene.add(t.group),i.includes("gem")?t.ambientSpinFactor/=-2:(t.ambientSpinFactor/=2,t.setOpacity(0))}this.overlayScene.compile(),e.menu.pauseScreen instanceof sn&&e.menu.pauseScreen.jukebox.reset()}async initSounds(){let t;if("ultra"===this.mission.modification)t="tim trance.ogg",this.originalMusicName=t;else if("gold"!==e.modification&&this.mission.missionInfo.music&&"pianoforte.ogg"!==this.mission.missionInfo.music.toLowerCase())t=this.mission.missionInfo.music.toLowerCase(),this.originalMusicName=t;else if("gold"===this.mission.modification){let e=Ot.allCategories.find(e=>e.includes(this.mission)).indexOf(this.mission);t=["groovepolice.ogg","classic vibe.ogg","beach party.ogg"][(e+1)%3],this.originalMusicName=["groove police.ogg","classic vibe.ogg","beach party.ogg"][(e+1)%3]}else t=I.randomFromArray(la),this.originalMusicName=t;"platinum"===e.modification&&(t="music/"+t);let i=["spawn.wav","ready.wav","set.wav","go.wav","whoosh.wav",t];isFinite(this.mission.qualifyTime)&&"platinum"===e.modification&&i.push("alarm.wav","alarm_timeout.wav","infotutorial.wav");try{await this.audio.loadBuffers(i)}catch(e){let s=I.randomFromArray(la);this.originalMusicName=s,i[i.indexOf(t)]="music/"+s,t="music/"+s,await this.audio.loadBuffers(i)}this.music=this.audio.createAudioSource(t,this.audio.musicGain),this.music.setLoop(!0),await this.music.promise}async addSimGroup(e){if(e.elements.find(e=>e._type===vt.PathedInterior)){let t=await zs.createFromSimGroup(e,this);if(!t)return;this.scene.add(t.mesh),t.hasCollision&&this.world.add(t.body);for(let e of t.triggers)this.world.add(e.body),this.triggers.push(e);return}let t=[];for(let i of e.elements)switch(i._type){case vt.SimGroup:t.push(this.addSimGroup(i));break;case vt.InteriorInstance:t.push(this.addInterior(i));break;case vt.StaticShape:case vt.Item:t.push(this.addShape(i));break;case vt.Trigger:t.push(this.addTrigger(i));break;case vt.TSStatic:t.push(this.addTSStatic(i));break;case vt.ParticleEmitterNode:this.addParticleEmitterNode(i)}await Promise.all(t)}async addInterior(e){let{dif:t,path:i}=await this.mission.getDif(e.interiorfile);if(!t)return;let s=new ui(t,i,this);this.interiors.push(s),await I.wait(10),await s.init(e._id),this.scene.add(s.mesh);let n=It.parseVector3(e.position),r=It.parseRotation(e.rotation),a=It.parseVector3(e.scale),o=0!==a.x&&0!==a.y&&0!==a.z;0===a.x&&(a.x=1e-4),0===a.y&&(a.y=1e-4),0===a.z&&(a.z=1e-4),s.setTransform(n,r,a),o&&this.world.add(s.body)}async addShape(e){var t;let i,s=null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase();if(s&&(["startpad","startpad_mbg","startpad_mbp"].includes(s)?i=new Yi:["endpad","endpad_mbg","endpad_mbp"].includes(s)?i=new $i(e===this.endPadElement):"signfinish"===s?i=new Qi:s.startsWith("signplain")?i=new Ki(e):s.startsWith("gemitem")?(i=new rs(e),this.totalGems++):"superjumpitem"===s?i=new ls(e):s.startsWith("signcaution")?i=new ds(e):"superbounceitem"===s?i=new cs(e):"roundbumper"===s?i=new ms:"trianglebumper"===s?i=new Is:"helicopteritem"===s?i=new ps(e):"ductfan"===s?i=new fs:"smallductfan"===s?i=new Bs:"antigravityitem"===s?i=new ys(e):"norespawnantigravityitem"===s?i=new ys(e,!0):"landmine"===s?i=new bs:"shockabsorberitem"===s?i=new Ss(e):"superspeeditem"===s?i=new Ts(e):["timetravelitem","timepenaltyitem"].includes(s)?i=new Cs(e):"tornado"===s?i=new ks:"trapdoor"===s?i=new _s(e):"oilslick"===s?i=new Es:"pushbutton"===s?i=new Ns:s.startsWith("sign")||"arrow"===s?i=new qs(e):"magnet"===s?i=new js:"nuke"===s?i=new Gs:"checkpoint"===s?i=new Ks:"easteregg"===s?i=new Zs(e):"randompowerupitem"===s?i=new en(e):["clear","cloudy","dusk","wintry"].includes(s)?i=new yn(s):/glass_\d+shape/.test(s)?i=new bn(s):"blastitem"===s?i=new vn(e):"megamarbleitem"===s&&(i=new wn(e))),!i)return;this.shapes.push(i),await I.wait(10),await i.init(this,e);let n=It.parseVector3(e.position),r=It.parseRotation(e.rotation),a=It.parseVector3(e.scale);0===a.x&&(a.x=1e-4),0===a.y&&(a.y=1e-4),0===a.z&&(a.z=1e-4),i.setTransform(n,r,a),this.scene.add(i.group);for(let e of i.bodies)this.world.add(e);for(let e of i.colliders)this.world.add(e.body)}async addTrigger(e){var t;let i,s=null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase();"outofboundstrigger"===s?i=new Vs(e,this):"inboundstrigger"===s?i=new Ds(e,this):"helptrigger"===s?i=new Us(e,this):"teleporttrigger"===s?i=new Qs(e,this):"destinationtrigger"===s?i=new Ys(e,this):"checkpointtrigger"===s&&(i=new $s(e,this)),i&&(this.triggers.push(i),this.world.add(i.body),await i.init())}async addTSStatic(e){let t=new bi,i=e.shapename.toLowerCase(),s=i.indexOf("data/");if(-1!==s){t.dtsPath=i.slice(s+"data/".length),t.isTSStatic=!0,t.shareId=1,i.includes("colmesh")&&(t.receiveShadows=!1),this.shapes.push(t),await I.wait(10);try{await t.init(this,e)}catch(e){return console.error("Error in creating TSStatic, skipping it for now.",e),void I.removeFromArray(this.shapes,t)}if(t.setTransform(It.parseVector3(e.position),It.parseRotation(e.rotation),It.parseVector3(e.scale)),this.scene.add(t.group),0!==t.worldScale.x&&0!==t.worldScale.y&&0!==t.worldScale.z){for(let e of t.bodies)this.world.add(e);for(let e of t.colliders)this.world.add(e.body)}}}addParticleEmitterNode(e){let t=da[e.emitter];t&&this.particles.createEmitter(t,It.parseVector3(e.position))}restart(i){var s,n;if(!i&&this.currentCheckpoint&&"playback"!==this.replay.mode)return void this.loadCheckpointState();let r=e.menu.hud;r.setPowerupButtonState(!1,!0),this.timeState.gameplayClock=0,this.replay&&this.replay.version<=4?(this.timeState.currentAttemptTime=0,this.timeState.tickIndex=0):(this.timeState.currentAttemptTime=-1e3/ea,this.timeState.tickIndex=-1),this.currentTimeTravelBonus=0,this.outOfBounds=!1,this.lastPhysicsTick=null,this.maxDisplayedTime=0,this.blastAmount=0,this.gemCount=0,this.currentCheckpoint=null,this.currentCheckpointTrigger=null,this.checkpointCollectedGems.clear(),this.checkpointHeldPowerUp=null,this.checkpointUp=null,this.checkpointBlast=null,this.restartPressTime=null,this.finishTime=null;let{position:a,euler:o}=this.getStartPositionAndOrientation();this.marble.body.position.set(a.x,a.y,a.z+3),this.marble.body.syncShapes(),this.marble.group.position.copy(this.marble.body.position),this.marble.group.recomputeTransform(),this.marble.reset(),this.marble.calculatePredictiveTransforms(),this.yaw=o.z+Math.PI/2,this.pitch=ra;let l=this.mission.missionInfo;l.starthelptext&&e.menu.hud.displayHelp(l.starthelptext);for(let e of this.shapes)e.reset();for(let e of this.interiors)e.reset();for(let e of this.triggers)e.reset();this.currentUp.set(0,0,1),this.orientationChangeTime=-1/0,this.oldOrientationQuat=new t,this.newOrientationQuat=new t,this.setGravityIntensity(this.defaultGravity),this.deselectPowerUp(),r.setCenterText("none"),ot(),lt("playback"===this.replay.mode?"replay":"normal"),null===(s=this.timeTravelSound)||void 0===s||s.stop(),this.timeTravelSound=null,null===(n=this.alarmSound)||void 0===n||n.stop(),this.alarmSound=null,this.replay.init(),this.analytics.tries++,this.audio.play("spawn.wav"),this.clearSchedule(),this.schedule(500,()=>{r.setCenterText("ready"),this.audio.play("ready.wav")}),this.schedule(2e3,()=>{r.setCenterText("set"),this.audio.play("set.wav")}),this.schedule(na,()=>{r.setCenterText("go"),this.audio.play("go.wav")}),this.schedule(5500,()=>{this.outOfBounds||r.setCenterText("none")})}tryRender(){if(this.stopped)return;requestAnimationFrame(this.tryRender.bind(this));let e=performance.now();if(null===this.lastFrameTime)this.lastFrameTime=e;else{let t=cn[Y.data.settings.frameRateCap];isFinite(t)&&ha.clearRect(0,0,1,1);let i=1e3/t;if(e-this.lastFrameTime<i)return;this.lastFrameTime+=i,this.lastFrameTime=Math.max(this.lastFrameTime,e-2*i)}this.render(e)}render(t){var i,s;if(this.stopped)return;if(this.tick(t),this.stopped)return;let n=1e3/ea,r=I.clamp((t-this.lastPhysicsTick)/n*ta,0,1),a={timeSinceLoad:this.timeState.timeSinceLoad+r*n,currentAttemptTime:this.timeState.currentAttemptTime+r*n,gameplayClock:this.currentTimeTravelBonus||this.timeState.currentAttemptTime<na?this.timeState.gameplayClock:this.timeState.gameplayClock+r*n,physicsTickCompletion:r,tickIndex:this.timeState.tickIndex+r};this.marble.render(a);for(let e of this.interiors)e.render(a);for(let e of this.shapes)e.render(a);this.particles.render(a.timeSinceLoad),this.updateCamera(a),this.camera.updateMatrixWorld(),null===(i=this.scene.directionalLights[0])||void 0===i||i.updateCamera(this.marble.group.position.clone(),-1),this.scene.prepareForRender(this.camera),this.marble.renderReflection(),he.render(this.scene,this.camera);for(let e of this.overlayShapes)e.group.position.x=500,e.render(this.timeState),e.dtsPath.includes("gem")?(e.group.scale.setScalar(45/de),e.group.position.y=25/de,e.group.position.z=-35/de):(e.group.scale.setScalar((null!==(s=sa[e.dtsPath])&&void 0!==s?s:40)/de),e.group.position.y=this.overlayCamera.right-55/de,e.group.position.z=ia[e.dtsPath]/de),e.group.recomputeTransform();this.overlayCamera.updateMatrixWorld(),this.overlayScene.prepareForRender(this.overlayCamera),he.render(this.overlayScene,this.overlayCamera,null,!1);let o=e.menu.hud;o.renderHud(a),o.displayFps()}updateCamera(e){let s=this.marble.group.position,n=this.getOrientationQuat(e),r=new i(0,0,1).applyQuaternion(n),a=new i(1,0,0),o=new i(0,0,.3);if("playback"===this.replay.mode){let t=Math.max(0,this.replay.currentTickIndex-1),i=this.replay.currentTickIndex;this.pitch=I.lerp(this.replay.cameraOrientations[t].pitch,this.replay.cameraOrientations[i].pitch,e.physicsTickCompletion),this.pitch=Math.max(-Math.PI/2+Math.PI/4,Math.min(Math.PI/2-1e-4,this.pitch)),this.yaw=I.lerp(this.replay.cameraOrientations[t].yaw,this.replay.cameraOrientations[i].yaw,e.physicsTickCompletion)}if(this.finishTime&&(this.pitch=I.lerp(this.finishPitch,ra,I.clamp((e.currentAttemptTime-this.finishTime.currentAttemptTime)/333,0,1)),this.yaw=this.finishYaw-(e.currentAttemptTime-this.finishTime.currentAttemptTime)/1e3*.6),this.outOfBounds)this.camera.position.copy(this.oobCameraPosition),this.camera.position.sub(this.lastVerticalTranslation),this.camera.lookAt(s),this.camera.position.add(this.lastVerticalTranslation);else{a.applyAxisAngle(new i(0,1,0),this.pitch),a.applyAxisAngle(new i(0,0,1),this.yaw),a.applyQuaternion(n),o.applyAxisAngle(new i(0,1,0),this.pitch),o.applyAxisAngle(new i(0,0,1),this.yaw),o.applyQuaternion(n),this.camera.up=r,this.camera.position.copy(s).sub(a.clone().multiplyScalar(2.5)),this.camera.lookAt(s),this.camera.position.add(o);const e=.1;let l=s,h=new Set;for(let n=0;n<3;n++){let n=this.camera.position.clone().sub(l);n.addScaledVector(n.clone().normalize(),2);let r=n.length(),a=this.world.castRay(l,n.normalize(),r).find(e=>e.shape!==this.marble.shape&&!h.has(e.shape));if(!a)break;{h.add(a.shape);let n=new ei,r=a.normal,o=a.point;n.setFromNormalAndCoplanarPoint(r,o);let l=new i,d=n.projectPoint(this.camera.position,l);if(n.distanceToPoint(this.camera.position)>=e)break;this.camera.position.copy(d).addScaledVector(r,e),I.cameraLookAtDirect(this.camera,s);let c=new i(1,0,0);c.applyQuaternion(this.camera.orientation);let u=Math.atan(.12),m=(new t).setFromAxisAngle(c,u);this.camera.orientation.premultiply(m)}}this.lastVerticalTranslation=o}}tick(t){var i,s;if(this.stopped)return;if(this.paused)return;void 0===t&&(t=performance.now());let n="playback"===this.replay.mode;if(!n&&!e.menu.finishScreen.showing&&(Te("use")||this.useQueued)&&ke("use")&&this.outOfBounds&&!this.finishTime)return void this.restart(!1);e.menu.finishScreen.handleGamepadInput(),Te("pause")&&ke("pause")&&(Ae("pause"),Ae("jump"),Ae("use"),Ae("restart"),this.pause());let r=!1;null===this.lastPhysicsTick&&(this.lastPhysicsTick=t-1e3/ea/ta,r=!0);let a=t-this.lastPhysicsTick;(a*=ta)>=1e3&&(a=1e3,this.lastPhysicsTick=t-1e3);let o=!1;for(;a>=1e3/ea||r;){let t=this.timeState.gameplayClock;this.timeState.currentAttemptTime>=na&&(this.currentTimeTravelBonus>0?(this.currentTimeTravelBonus-=1e3/ea,this.timeTravelSound||(this.timeTravelSound=this.audio.createAudioSource("timetravelactive.wav"),this.timeTravelSound.setLoop(!0),this.timeTravelSound.play())):(this.timeState.gameplayClock+=1e3/ea,null===(i=this.timeTravelSound)||void 0===i||i.stop(),this.timeTravelSound=null),this.currentTimeTravelBonus<0&&(this.timeState.gameplayClock+=-this.currentTimeTravelBonus,this.currentTimeTravelBonus=0)),this.timeState.timeSinceLoad+=1e3/ea,this.timeState.currentAttemptTime+=1e3/ea,this.timeState.tickIndex++,this.lastPhysicsTick+=1e3/ea/ta,a-=1e3/ea,r=!1,this.tickSchedule(this.timeState.currentAttemptTime),this.offline&&(this.audio.currentTimeOverride=this.timeState.currentAttemptTime/1e3),this.mission.hasBlast&&this.blastAmount<1&&(this.blastAmount=I.clamp(this.blastAmount+1e3/aa/ea,0,1));for(let e of this.interiors)e.tick(this.timeState);for(let e of this.triggers)e.tick(this.timeState);for(let e of this.shapes)e.isTSStatic||e.tick(this.timeState);if(this.marble.tick(this.timeState),!n){let e=this.world.gravity.clone();this.finishTime&&this.world.gravity.setScalar(0),this.world.step(1/ea),this.world.gravity.copy(e)}this.jumpQueued=!1,this.useQueued=!1,this.blastQueued=!1;let l=0,h=0,d=Y.data.settings.alwaysFreeLook||Te("freeLook"),c=I.lerp(1,6,Y.data.settings.keyboardSensitivity);if(Te("cameraLeft")&&(l+=c),Te("cameraRight")&&(l-=c),Te("cameraUp")&&(h-=c),Te("cameraDown")&&(h+=c),l-=Ie.cameraX*I.lerp(.5,10,Y.data.settings.mouseSensitivity),d&&(h+=Ie.cameraY*I.lerp(.5,10,Y.data.settings.mouseSensitivity)),this.yaw+=l/ea,this.pitch+=h/ea,this.particles.tick(),o=!0,this.timeState.currentAttemptTime>=na&&isFinite(this.mission.qualifyTime)&&"platinum"===e.modification&&!this.finishTime){let i=this.mission.computeAlarmStartTime();t<=i&&this.timeState.gameplayClock>=i&&!this.alarmSound&&(this.alarmSound=this.audio.createAudioSource("alarm.wav"),this.alarmSound.setLoop(!0),this.alarmSound.play(),e.menu.hud.displayHelp(`You have ${(this.mission.qualifyTime-i)/1e3} seconds remaining.`,!0)),t<this.mission.qualifyTime&&this.timeState.gameplayClock>=this.mission.qualifyTime&&(null===(s=this.alarmSound)||void 0===s||s.stop(),this.alarmSound=null,e.menu.hud.displayHelp("The clock has passed the Par Time.",!0),this.audio.play("alarm_timeout.wav"))}if(n){if(this.replay.playBack(),this.replay.isPlaybackComplete())return void this.stopAndExit()}else this.replay.record()}this.audio.updatePositionalAudio(this.timeState,this.camera.position,this.yaw),this.pitch=Math.max(-Math.PI/2+Math.PI/4,Math.min(Math.PI/2-1e-4,this.pitch)),o&&this.marble.calculatePredictiveTransforms(),this.finishTime||!Te("restart")||this.pressingRestart?Te("restart")||(this.pressingRestart=!1):(this.restart(!1),this.currentCheckpoint&&(this.restartPressTime=performance.now()),this.pressingRestart=!0),!this.finishTime&&Te("restart")&&null!==this.restartPressTime&&null!==this.restartPressTime&&performance.now()-this.restartPressTime>=1e3&&this.restart(!0)}getOrientationQuat(e){let t=I.clamp((e.currentAttemptTime-this.orientationChangeTime)/300,0,1);return this.oldOrientationQuat.clone().slerp(this.newOrientationQuat,t).normalize()}setUp(e,s=!1){let n=this.timeState;e.normalize(),this.currentUp.copy(e);let r=this.world.gravity.length();this.world.gravity.copy(e).multiplyScalar(-1*r);let a=this.getOrientationQuat(n),o=new i(0,0,1);o.applyQuaternion(a).normalize();let l=new t;if(e.dot(o)<=-(1-1e-15)&&!(this.replay.version<3)){let s=new i(0,0,1).applyQuaternion(this.camera.orientation),n=o.clone().cross(s).normalize();l.setFromUnitVectors(o,n),l.premultiply((new t).setFromUnitVectors(n,e))}else l.setFromUnitVectors(o,e);this.newOrientationQuat=l.multiply(a).normalize(),this.oldOrientationQuat=a,this.orientationChangeTime=s?-1/0:n.currentAttemptTime}getStartPositionAndOrientation(){let e,t=I.findLast(this.shapes,e=>e instanceof Yi),s=new Ui;if(t)e=t.worldPosition,s.setFromQuaternion(t.worldOrientation,"ZXY");else{let t=this.mission.allElements.find(e=>"SpawnPoints"===e._name);if(t){let i=t.elements[0];e=It.parseVector3(i.position)}else e=new i(0,0,300)}return{position:e,euler:s}}setGravityIntensity(e){let t=this.currentUp.clone().multiplyScalar(-1*e);this.world.gravity.copy(t)}onResize(t,i,s){this.camera&&this.overlayCamera&&(this.camera.aspect=t/i,this.camera.updateProjectionMatrix(),this.overlayCamera.left=0,this.overlayCamera.right=t,this.overlayCamera.top=0,this.overlayCamera.bottom=i,this.overlayCamera.updateProjectionMatrix(),e.menu.hud.setSize(t,i,s))}onMouseMove(e){if(!this.started||!document.pointerLockElement||this.finishTime||this.paused||"playback"===this.replay.mode)return;let t=Math.hypot(e.movementX,e.movementY);if(t>350&&4*this.previousMouseMovementDistance<t)return void(this.previousMouseMovementDistance*=1.5);this.previousMouseMovementDistance=t;let i=I.lerp(4e-4,.01,Y.data.settings.mouseSensitivity),s=1&Y.data.settings.invertMouse?-1:1,n=2&Y.data.settings.invertMouse?-1:1;(Y.data.settings.alwaysFreeLook||Te("freeLook"))&&(this.pitch+=e.movementY*i*n),this.yaw-=e.movementX*i*s}pickUpPowerUp(t,i=!0){if(!t)return!1;if(this.heldPowerUp&&t.constructor===this.heldPowerUp.constructor)return!1;this.heldPowerUp=t,e.menu.hud.setPowerupButtonState(!0);for(let e of this.overlayShapes)e.dtsPath.includes("gem")||e.setOpacity(Number(e.dtsPath===t.dtsPath));return i&&this.audio.play(t.sounds[0]),!0}deselectPowerUp(){if(this.heldPowerUp){this.heldPowerUp=null,e.menu.hud.setPowerupButtonState(!1);for(let e of this.overlayShapes)e.dtsPath.includes("gem")||e.setOpacity(0)}else e.menu.hud.setPowerupButtonState(!1)}pickUpGem(t){let i;this.gemCount++;let s="gold"===e.modification?"gem":"diamond";if(this.gemCount===this.totalGems)i=`You have all the ${s}s, head for the finish!`,this.audio.play("gotallgems.wav"),this.mission.misFile.activatedPackages.includes("endWithTheGems")&&this.touchFinish(t);else{i=`You picked up a ${s}${"gold"===e.modification?".":"!"}  `;let t=this.totalGems-this.gemCount;i+=1===t?`Only one ${s} to go!`:`${t} ${s}s to go!`,this.audio.play("gotgem.wav")}e.menu.hud.displayAlert(i)}addTimeTravelBonus(e,t){0===this.currentTimeTravelBonus&&(this.timeState.gameplayClock-=t,this.timeState.gameplayClock<0&&(this.timeState.gameplayClock=0),e-=t),this.currentTimeTravelBonus+=e}goOutOfBounds(){this.outOfBounds||this.finishTime||(e.menu.hud.setPowerupButtonState(!0),this.updateCamera(this.timeState),this.outOfBounds=!0,this.outOfBoundsTime=I.jsonClone(this.timeState),this.oobCameraPosition=this.camera.position.clone(),e.menu.hud.setCenterText("outofbounds"),this.audio.play("whoosh.wav"),this.analytics.outOfBoundsCount++,"playback"!==this.replay.mode&&this.schedule(this.timeState.currentAttemptTime+2e3,()=>this.restart(!1),"oobRestart"))}saveCheckpointState(t,i){var s,n;if(this.currentCheckpoint===t)return;if(null===(s=this.currentCheckpoint)||void 0===s?void 0:s.worldPosition.equals(t.worldPosition))return;let r=(null===(n=t.srcElement)||void 0===n?void 0:n.disableOob)||(null===i||void 0===i?void 0:i.element.disableOob);if(!It.parseBoolean(r)||!this.outOfBounds){this.currentCheckpoint=t,this.currentCheckpointTrigger=i,this.checkpointCollectedGems.clear(),this.checkpointUp=this.currentUp.clone(),this.checkpointBlast=this.blastAmount;for(let e of this.shapes)e instanceof rs&&e.pickedUp&&this.checkpointCollectedGems.add(e);this.checkpointHeldPowerUp=this.heldPowerUp,e.menu.hud.displayAlert("Checkpoint reached!"),this.audio.play("checkpoint.wav")}}loadCheckpointState(){var t,s,n,r,a,o;if(!this.currentCheckpoint)return;let l=this.marble,h=(null===(t=this.currentCheckpoint.srcElement)||void 0===t?void 0:t.gravity)||(null===(s=this.currentCheckpointTrigger)||void 0===s?void 0:s.element.gravity);if(It.parseBoolean(h)||"ultra"===this.mission.modification){let e=new i(0,0,1);e.applyQuaternion(this.currentCheckpoint.worldOrientation),this.setUp(e,!0)}else this.setUp(this.checkpointUp,!0);let d=new i,c=(null===(n=this.currentCheckpoint.srcElement)||void 0===n?void 0:n.add)||(null===(r=this.currentCheckpointTrigger)||void 0===r?void 0:r.element.add);c&&d.add(It.parseVector3(c));let u=(null===(a=this.currentCheckpoint.srcElement)||void 0===a?void 0:a.sub)||(null===(o=this.currentCheckpointTrigger)||void 0===o?void 0:o.element.sub);u&&d.sub(It.parseVector3(u)),c||u||(d.z=3,"ultra"===this.mission.modification&&d.applyQuaternion(this.currentCheckpoint.worldOrientation)),l.body.position.copy(this.currentCheckpoint.worldPosition).add(d),l.body.linearVelocity.setScalar(0),l.body.angularVelocity.setScalar(0),l.calculatePredictiveTransforms();let m=new Ui;m.setFromQuaternion(this.currentCheckpoint.worldOrientation,"ZXY"),this.yaw=m.z+Math.PI/2,this.pitch=ra;for(let e of this.shapes)e instanceof rs&&e.pickedUp&&!this.checkpointCollectedGems.has(e)&&(e.reset(),this.gemCount--);e.menu.hud.setCenterText("none"),l.superBounceEnableTime=-1/0,l.shockAbsorberEnableTime=-1/0,l.helicopterEnableTime=-1/0,l.megaMarbleEnableTime=-1/0,this.clearSchedule(),this.outOfBounds=!1,this.blastAmount=this.checkpointBlast,this.finishTime=null,this.deselectPowerUp(),this.checkpointHeldPowerUp&&this.schedule(this.timeState.currentAttemptTime+500,()=>this.pickUpPowerUp(this.checkpointHeldPowerUp,!1)),this.audio.play("spawn.wav"),this.replay.recordCheckpointRespawn()}touchFinish(t){var i;if(null===this.finishTime)if(this.replay.recordTouchFinish(),this.gemCount<this.totalGems)this.audio.play("missinggems.wav"),e.menu.hud.displayAlert("gold"===e.modification?"You can't finish without all the gems!!":"You may not finish without all the diamonds!");else{void 0===t&&(t=1);let s=1e3*(1-t)/ea;this.finishTime=I.jsonClone(this.timeState),this.finishTime.timeSinceLoad-=s,this.finishTime.currentAttemptTime-=s,0===this.currentTimeTravelBonus&&(this.finishTime.gameplayClock-=s),this.finishTime.gameplayClock=I.clamp(this.finishTime.gameplayClock,0,oa),this.finishTime.physicsTickCompletion=t,this.currentTimeTravelBonus=0,null===(i=this.alarmSound)||void 0===i||i.stop(),"playback"===this.replay.mode&&(this.finishTime=this.replay.finishTime),this.finishYaw=this.yaw,this.finishPitch=this.pitch;let n=I.findLast(this.shapes,e=>e instanceof $i);if(null===n||void 0===n||n.spawnFirework(this.timeState),e.menu.hud.displayAlert("Congratulations! You've finished!"),this.outOfBounds&&this.timeState.currentAttemptTime-this.outOfBoundsTime.currentAttemptTime>=500)return;this.clearScheduleId("oobRestart"),"playback"!==this.replay.mode&&this.schedule(this.timeState.currentAttemptTime+2e3,()=>{var t;null===(t=document.exitPointerLock)||void 0===t||t.call(document),e.menu.finishScreen.show(),at(),Ae("use"),Ae("jump"),Ae("restart")}),this.analytics.finishes++}}pause(){var t;this.paused||e.level.finishTime&&"record"===e.level.replay.mode||(this.paused=!0,this.pausedAt=Date.now(),null===(t=document.exitPointerLock)||void 0===t||t.call(document),_e(),e.menu.pauseScreen.show(),at())}unpause(){this.paused=!1,I.isTouchDevice||I.requestPointerLock(),e.menu.pauseScreen.hide(),this.lastPhysicsTick=performance.now(),ot(),null!==this.pausedAt&&(this.analytics.timePaused+=Date.now()-this.pausedAt,this.pausedAt=null)}stop(){var e,t,i,s,n,r,a;this.stopped=!0,clearInterval(this.tickInterval),this.dispose(),wr.clearReferences(),this.music.stop();for(let t of this.interiors)t instanceof zs&&(null===(e=t.soundSource)||void 0===e||e.stop());for(let e of this.shapes)(e instanceof ks||e instanceof fs)&&(null===(t=e.soundSource)||void 0===t||t.stop());null===(i=this.marble.rollingSound)||void 0===i||i.stop(),null===(s=this.marble.slidingSound)||void 0===s||s.stop(),null===(n=this.marble.helicopterSound)||void 0===n||n.stop(),null===(r=this.marble.shockAbsorberSound)||void 0===r||r.stop(),null===(a=this.marble.superBounceSound)||void 0===a||a.stop(),this.audio.stopAllAudio()}stopAndExit(){var t;this.stop(),e.level=null,le.classList.add("hidden"),e.menu.pauseScreen.hide(),e.menu.levelSelect.show(),e.menu.levelSelect.displayBestTimes(),e.menu.finishScreen.hide(),e.menu.hideGameUi(),e.menu.show(),null===(t=document.exitPointerLock)||void 0===t||t.call(document),"playback"!==this.replay.mode&&(null!==this.pausedAt&&(this.analytics.timePaused+=Date.now()-this.pausedAt),this.analytics.endTime=Date.now(),ne.retryFetch("/api/statistics",{method:"POST",headers:{"Content-Type":"text/plain"},body:btoa(JSON.stringify(this.analytics))}))}getLoadingCompletion(){return this.loadingState.total?this.loadingState.loaded/this.loadingState.total:0}dispose(){this.scene.dispose(),this.marble.dispose(),he.cleanUp()}}class ua{constructor(e){this.version=5,this.mode="record",this.canStore=!0,this.isInvalid=!1,this.marblePositions=[],this.marbleOrientations=[],this.marbleLinearVelocities=[],this.marbleAngularVelocities=[],this.marbleInside=[],this.marbleEnter=[],this.marbleLeave=[],this.marbleContact=[],this.uses=[],this.blasts=[],this.cameraOrientations=[],this.timeTravelTimeToRevert=new Map,this.touchFinishTickIndices=[],this.finishTime=null,this.trapdoorStartValues=[],this.landmineStartValues=[],this.pushButtonStartValues=[],this.nukeStartValues=[],this.rollingSoundGain=[],this.rollingSoundPlaybackRate=[],this.slidingSoundGain=[],this.jumpSoundTimes=[],this.bounceTimes=[],this.randomPowerUpChoices=new Map,this.checkpointRespawns=[],this.currentJumpSoundTime=0,this.currentBounceTime=0,e&&(this.level=e,this.missionPath=e.mission.path)}get currentTickIndex(){return Math.max(this.level.timeState.tickIndex,0)}init(){if("record"===this.mode){this.canStore=!0,this.isInvalid=!1,this.marblePositions.length=0,this.marbleOrientations.length=0,this.marbleLinearVelocities.length=0,this.marbleAngularVelocities.length=0,this.marbleInside.length=0,this.marbleEnter.length=0,this.marbleLeave.length=0,this.marbleContact.length=0,this.uses.length=0,this.blasts.length=0,this.cameraOrientations.length=0,this.timeTravelTimeToRevert.clear(),this.touchFinishTickIndices.length=0,this.finishTime=null,this.trapdoorStartValues.length=0,this.landmineStartValues.length=0,this.pushButtonStartValues.length=0,this.nukeStartValues.length=0,this.rollingSoundGain.length=0,this.rollingSoundPlaybackRate.length=0,this.slidingSoundGain.length=0,this.jumpSoundTimes.length=0,this.bounceTimes.length=0,this.randomPowerUpChoices.clear(),this.checkpointRespawns.length=0;for(let e of this.level.shapes)e instanceof _s?this.trapdoorStartValues.push({id:e.id,lastContactTime:e.lastContactTime,lastDirection:e.lastDirection,lastCompletion:e.lastCompletion}):e instanceof bs?this.landmineStartValues.push({id:e.id,disappearTime:e.disappearTime}):e instanceof Ns?this.pushButtonStartValues.push({id:e.id,lastContactTime:e.lastContactTime}):e instanceof Gs&&this.nukeStartValues.push({id:e.id,disappearTime:e.disappearTime});this.timeSinceLoad=this.level.timeState.timeSinceLoad}else for(let e of this.level.shapes)if(e instanceof _s){let t=this.trapdoorStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.lastContactTime&&(t.lastContactTime=-1/0),e.lastContactTime=t.lastContactTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad,e.lastDirection=t.lastDirection,e.lastCompletion=t.lastCompletion}else if(e instanceof bs){let t=this.landmineStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.disappearTime&&(t.disappearTime=-1/0),e.disappearTime=t.disappearTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad}else if(e instanceof Ns){let t=this.pushButtonStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.lastContactTime&&(t.lastContactTime=-1/0),e.lastContactTime=t.lastContactTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad}else if(e instanceof Gs){let t=this.nukeStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.disappearTime&&(t.disappearTime=-1/0),e.disappearTime=t.disappearTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad}}record(){var e;if("playback"===this.mode||!this.canStore)return;let t=this.level.marble;this.marblePositions.push(t.body.position.clone()),this.marbleOrientations.push(t.body.orientation.clone()),this.marbleLinearVelocities.push(t.body.linearVelocity.clone()),this.marbleAngularVelocities.push(t.body.angularVelocity.clone()),this.cameraOrientations.push({yaw:this.level.yaw,pitch:this.level.pitch});let i=(null===(e=t.rollingMegaMarbleSound)||void 0===e?void 0:e.playing)?t.rollingMegaMarbleSound:t.rollingSound;this.rollingSoundGain.push(i.gain.gain.value),this.rollingSoundPlaybackRate.push(i.node.playbackRate.value),this.slidingSoundGain.push(t.slidingSound.gain.gain.value),this.level.finishTime&&null===this.finishTime&&(this.finishTime=I.jsonClone(this.level.finishTime)),this.marblePositions.length>=60*ea*60&&(this.canStore=!1,this.isInvalid=null===this.level.finishTime)}recordMarbleInside(e){"playback"!==this.mode&&this.canStore&&this.marbleInside.push({tickIndex:this.currentTickIndex,id:e.id})}recordMarbleEnter(e){"playback"!==this.mode&&this.canStore&&this.marbleEnter.push({tickIndex:this.currentTickIndex,id:e.id})}recordMarbleLeave(e){"playback"!==this.mode&&this.canStore&&this.marbleLeave.push({tickIndex:this.currentTickIndex,id:e.id})}recordMarbleContact(e){"playback"!==this.mode&&this.canStore&&this.marbleContact.push({tickIndex:this.currentTickIndex,id:e.id})}recordUsePowerUp(e){"playback"!==this.mode&&this.canStore&&this.uses.push({tickIndex:this.currentTickIndex,id:e.id})}recordUseBlast(){"playback"!==this.mode&&this.canStore&&this.blasts.push({tickIndex:this.currentTickIndex})}recordTouchFinish(){"playback"!==this.mode&&this.canStore&&this.touchFinishTickIndices.push(this.currentTickIndex)}recordCheckpointRespawn(){"playback"!==this.mode&&this.canStore&&this.checkpointRespawns.push(this.currentTickIndex)}playBack(){var e,t,i,s,n,r;let a=this.currentTickIndex;if(!(a>=this.marblePositions.length)){for(let t of this.marbleInside)t.tickIndex===a&&(null!==(e=this.level.shapes.find(e=>e.id===t.id))&&void 0!==e?e:this.level.triggers.find(e=>e.id===t.id)).onMarbleInside(1);for(let e of this.marbleEnter)e.tickIndex===a&&(null!==(t=this.level.shapes.find(t=>t.id===e.id))&&void 0!==t?t:this.level.triggers.find(t=>t.id===e.id)).onMarbleEnter(1);for(let e of this.marbleLeave)e.tickIndex===a&&(null!==(i=this.level.shapes.find(t=>t.id===e.id))&&void 0!==i?i:this.level.triggers.find(t=>t.id===e.id)).onMarbleLeave();for(let e of this.marbleContact)e.tickIndex===a&&(null!==(s=this.level.shapes.find(t=>t.id===e.id))&&void 0!==s?s:this.level.interiors.find(t=>t.id===e.id)).onMarbleContact(null,1e3/ea);for(let e of this.uses)e.tickIndex===a&&this.level.shapes.find(t=>t.id===e.id).use(0);for(let e of this.blasts)e.tickIndex===a&&this.level.marble.useBlast();for(let e of this.touchFinishTickIndices)e===a&&this.level.touchFinish();for(let e of this.checkpointRespawns)e===a&&this.level.loadCheckpointState();this.level.marble.body.position.copy(this.marblePositions[a]),this.level.marble.body.orientation.copy(this.marbleOrientations[a]),this.level.marble.body.linearVelocity.copy(this.marbleLinearVelocities[a]),this.level.marble.body.angularVelocity.copy(this.marbleAngularVelocities[a]),this.level.yaw=this.cameraOrientations[a].yaw,this.level.pitch=this.cameraOrientations[a].pitch;for(let e=this.currentJumpSoundTime;e<this.jumpSoundTimes.length&&!(this.jumpSoundTimes[e]>a);e++)this.jumpSoundTimes[e]===a&&this.level.marble.playJumpSound();for(let e=this.currentBounceTime;e<this.bounceTimes.length&&!(this.bounceTimes[e].tickIndex>a);e++)this.bounceTimes[e].tickIndex===a&&(this.level.marble.playBounceSound(this.bounceTimes[e].volume),this.bounceTimes[e].showParticles&&this.level.marble.showBounceParticles());this.level.marble.rollingSound.gain.gain.setValueAtTime(this.rollingSoundGain[a],this.level.audio.currentTime),null===(n=this.level.marble.rollingMegaMarbleSound)||void 0===n||n.gain.gain.setValueAtTime(this.rollingSoundGain[a],this.level.audio.currentTime),this.level.marble.rollingSound.setPlaybackRate(this.rollingSoundPlaybackRate[a]),null===(r=this.level.marble.rollingMegaMarbleSound)||void 0===r||r.setPlaybackRate(this.rollingSoundPlaybackRate[a]),this.level.marble.slidingSound.gain.gain.setValueAtTime(this.slidingSoundGain[a],this.level.audio.currentTime)}}isPlaybackComplete(){return this.currentTickIndex===this.marblePositions.length-1}async serialize(){let e=new Float32Array(2*this.cameraOrientations.length);for(let t=0;t<this.cameraOrientations.length;t++)e[2*t+0]=this.cameraOrientations[t].yaw,e[2*t+1]=this.cameraOrientations[t].pitch;let t={version:this.version,timestamp:Date.now(),missionPath:this.missionPath,marblePositions:I.arrayBufferToString(ua.vec3sToBuffer(this.marblePositions).buffer),marbleOrientations:I.arrayBufferToString(ua.quatsToBuffer(this.marbleOrientations).buffer),marbleLinearVelocities:I.arrayBufferToString(ua.vec3sToBuffer(this.marbleLinearVelocities).buffer),marbleAngularVelocities:I.arrayBufferToString(ua.vec3sToBuffer(this.marbleAngularVelocities).buffer),marbleInside:this.marbleInside,marbleEnter:this.marbleEnter,marbleLeave:this.marbleLeave,marbleContact:this.marbleContact,uses:this.uses,blasts:this.blasts,cameraOrientations:I.arrayBufferToString(e.buffer),timeTravelTimeToRevert:[...this.timeTravelTimeToRevert.entries()],touchFinishTickIndices:this.touchFinishTickIndices,finishTime:this.finishTime,trapdoorStartValues:this.trapdoorStartValues,landmineStartValues:this.landmineStartValues,pushButtonStartValues:this.pushButtonStartValues,nukeStartValues:this.nukeStartValues,timeSinceLoad:this.timeSinceLoad,rollingSoundGain:I.arrayBufferToString(new Float32Array(this.rollingSoundGain).buffer),rollingSoundPlaybackRate:I.arrayBufferToString(new Float32Array(this.rollingSoundPlaybackRate).buffer),slidingSoundGain:I.arrayBufferToString(new Float32Array(this.slidingSoundGain).buffer),jumpSoundTimes:this.jumpSoundTimes,bounceTimes:this.bounceTimes,randomPowerUpChoices:[...this.randomPowerUpChoices.entries()],checkpointRespawns:this.checkpointRespawns};return await U("compress",JSON.stringify(t))}static fromSerialized(e){var t,i,s,n,r,a,o;let l=new ua,h=pako.inflate(new Uint8Array(e),{to:"string"}),d=JSON.parse(h),c=null!==(t=d.version)&&void 0!==t?t:0;l.version=c,l.missionPath=c>=1?d.missionPath:null,l.timestamp=c>=1?d.timestamp:0,l.marblePositions=ua.bufferToVec3s(new Float32Array(I.stringToArrayBuffer(d.marblePositions))),l.marbleOrientations=ua.bufferToQuats(new Float32Array(I.stringToArrayBuffer(d.marbleOrientations))),l.marbleLinearVelocities=ua.bufferToVec3s(new Float32Array(I.stringToArrayBuffer(d.marbleLinearVelocities))),l.marbleAngularVelocities=ua.bufferToVec3s(new Float32Array(I.stringToArrayBuffer(d.marbleAngularVelocities))),l.marbleInside=d.marbleInside,l.marbleEnter=d.marbleEnter,l.marbleLeave=null!==(i=d.marbleLeave)&&void 0!==i?i:[],l.marbleContact=d.marbleContact,l.uses=d.uses,l.blasts=null!==(s=d.blasts)&&void 0!==s?s:[];let u=[],m=new Float32Array(I.stringToArrayBuffer(d.cameraOrientations));for(let e=0;e<m.length/2;e++)u.push({yaw:m[2*e+0],pitch:m[2*e+1]});return l.cameraOrientations=u,l.timeTravelTimeToRevert=d.timeTravelTimeToRevert.reduce((e,t)=>(e.set(t[0],t[1]),e),new Map),l.touchFinishTickIndices=d.touchFinishTickIndices,l.finishTime=d.finishTime,l.trapdoorStartValues=d.trapdoorStartValues,l.landmineStartValues=d.landmineStartValues,l.pushButtonStartValues=null!==(n=d.pushButtonStartValues)&&void 0!==n?n:[],l.nukeStartValues=null!==(r=d.nukeStartValues)&&void 0!==r?r:[],l.timeSinceLoad=d.timeSinceLoad,l.rollingSoundGain=[...new Float32Array(I.stringToArrayBuffer(d.rollingSoundGain))],l.rollingSoundPlaybackRate=[...new Float32Array(I.stringToArrayBuffer(d.rollingSoundPlaybackRate))],l.slidingSoundGain=[...new Float32Array(I.stringToArrayBuffer(d.slidingSoundGain))],l.jumpSoundTimes=d.jumpSoundTimes,l.bounceTimes=d.bounceTimes,l.randomPowerUpChoices=(null!==(a=d.randomPowerUpChoices)&&void 0!==a?a:[]).reduce((e,t)=>(e.set(t[0],t[1]),e),new Map),l.checkpointRespawns=null!==(o=d.checkpointRespawns)&&void 0!==o?o:[],l}static vec3sToBuffer(e){let t=new Float32Array(3*e.length);for(let i=0;i<e.length;i++)t[3*i+0]=e[i].x,t[3*i+1]=e[i].y,t[3*i+2]=e[i].z;return t}static quatsToBuffer(e){let t=new Float32Array(4*e.length);for(let i=0;i<e.length;i++)t[4*i+0]=e[i].x,t[4*i+1]=e[i].y,t[4*i+2]=e[i].z,t[4*i+3]=e[i].w;return t}static bufferToVec3s(e){let t=[];for(let s=0;s<e.length/3;s++){let n=new i(e[3*s+0],e[3*s+1],e[3*s+2]);t.push(n)}return t}static bufferToQuats(e){let i=[];for(let s=0;s<e.length/4;s++){let n=new t(e[4*s+0],e[4*s+1],e[4*s+2],e[4*s+3]);i.push(n)}return i}static async download(e,t,i=!0,s=!1){i&&(e=await this.maybeUpdateReplay(e,t.path));let n=new Blob([e],{type:"application/octet-stream"}),r=URL.createObjectURL(n),a=I.removeSpecialChars(t.title.toLowerCase().split(" ").map(e=>I.uppercaseFirstLetter(e)).join(""));a+="-";for(let e=0;e<6;e++)a+="0123456789abcdef"[Math.floor(16*Math.random())];s&&(a+="u"),a+=".wrec",I.download(r,a),URL.revokeObjectURL(r)}static async maybeUpdateReplay(e,t){let i=pako.inflate(new Uint8Array(e),{to:"string"});if(!i.includes('"version"')){let s=JSON.parse(i);s.missionPath=t,s.timestamp=0,s.version=1,e=await U("compress",JSON.stringify(s))}return e}}var ma;class pa{static get isCompilation(){return!!this.directoryHandle}static updateOverviewText(){let e=Number(this.div.querySelectorAll("._config-row")[4].children[1].value)||1,t=this.tickLength/ea/e,i=`Video duration: ${I.secondsToTimeString(t,3)}\nDestination file: ${this.fileHandle?this.fileHandle.name:"‚Äì"}`;i=this.isCompilation?`Levels: ${this.compilation.schedule.filter(e=>"replay"===e.type).length}\n`+i:`Level: ${this.compilation.schedule[0].mission.title}\n`+i,this.overviewText.textContent=i}static updateMusicToSoundRatioDisplay(){let e=this.div.querySelectorAll("._config-row")[9].children[1],t=this.div.querySelectorAll("._config-row")[9].children[2],i=Math.tan(Number(e.value)*Math.PI/2);"0.5"===e.value&&(i=1),"1"===e.value&&(i=1/0),t.textContent=`${Math.min(I.cursedRound(i,10),1)} : ${Math.min(I.cursedRound(1/i,10),1)}`}static updateAudioSettingsEnabledness(){let e=this.div.querySelectorAll("._config-row")[7].children[1].checked;this.div.querySelectorAll("._config-row")[8].classList.toggle("disabled",!e),this.div.querySelectorAll("._config-row")[9].classList.toggle("disabled",!e)}static async createWorker(){let e=fa.toString(),t=e.slice(e.indexOf("{")+1,e.lastIndexOf("}")),i=new Blob([t]),s=new Worker(URL.createObjectURL(i));return s.postMessage(window.location.href.slice(0,window.location.href.lastIndexOf("/")+1)),await new Promise(e=>s.addEventListener("message",t=>"ready"===t.data&&e())),s}static async render(){this.process=new ga,await this.process.run(),this.hide()}static async stopRender(t){var i;(t||await e.menu.showConfirmPopup("Stop rendering","Are you sure you want to cancel the ongoing rendering process?"))&&(null===(i=this.process)||void 0===i||i.stop(),this.hide())}static show(){this.div.classList.remove("hidden"),e.menu.levelSelect.hide(),this.loaded||this.initUiFromStoredConfig()}static showForSingleReplay(e,t){"showSaveFilePicker"in window&&"VideoEncoder"in window?(this.show(),this.compilation={schedule:[{type:"replay",filename:null,replay:t,mission:e}],showInfo:!1},this.computeLength(),this.updateOverviewText(),this.selectDestinationButton.style.display=""):this.showNotSupportedAlert()}static async showForCompilation(t){var i,s;let n;this.directoryHandle=t;try{n=await t.getFileHandle("manifest.json")}catch(t){return void e.menu.showAlertPopup("Missing compilation manifest file","The selected directory does not contain a manifest.json file, which is required. For a tutorial on how to render compilations, click [here](https://github.com/Vanilagy/MarbleBlast/tree/master/docs/compilation_how_to.md).")}this.show(),this.selectDestinationButton.style.display="none",this.compilationLoadingElement.classList.remove("hidden");try{let r=await(await n.getFile()).text();this.compilation=JSON.parse(r);let a=this.compilation.schedule.filter(e=>"replay"===e.type).length,o=0;for(let i of this.compilation.schedule){if("replay"!==i.type)continue;let s,n=o++/a;this.compilationLoadingElement.textContent=`Loading... (${Math.floor(100*n)}%)`;try{let n=await t.getFileHandle(i.filename);s=await(await n.getFile()).arrayBuffer()}catch(t){return e.menu.showAlertPopup("Replay file does not exist",`The file "${i.filename}", which the manifest references, was not found.`),void this.hide()}let r=ua.fromSerialized(s),l=Ot.allMissions.find(e=>e.path===r.missionPath);if(!l)throw new Error("Mission not found.");if(i.replay=r,i.mission=l,"string"==typeof i.runner){let t=i.runner,s=this.compilation.runners.find(e=>e.id===t);if(!s)return e.menu.showAlertPopup("Runner definition not found",`Runner with ID "${i.runner}" referenced in the manifest but not defined.`),void this.hide();if(s.marbleTexture)try{await(await pa.directoryHandle.getFileHandle(s.marbleTexture)).getFile()}catch(t){return e.menu.showAlertPopup("Marble texture file not found.",`Texture file "${s.marbleTexture}" was referenced in the manifest but not found.`),void this.hide()}}}this.fileHandle=await t.getFileHandle(null!==(i=this.compilation.outputFilename)&&void 0!==i?i:"output.webm",{create:!0}),this.chapterFileHandle=await t.getFileHandle(null!==(s=this.compilation.chaptersFilename)&&void 0!==s?s:"chapters.txt",{create:!0}),this.compilationLoadingElement.classList.add("hidden"),this.renderButton.classList.remove("disabled"),this.computeLength(),this.updateOverviewText()}catch(t){console.error(t),this.hide(),e.menu.showAlertPopup("Error","An error occurred while loading the compilation. Your compilation manifest might be malformed - check the web console.")}}static computeTickLengthForReplay(e){var t;let i=e.marblePositions.length-1;if(e.finishTime){let s=null!==(t=e.finishTime.tickIndex)&&void 0!==t?t:Math.floor(e.finishTime.currentAttemptTime*ea/1e3);i=Math.min(i,s+2*ea)}return i}static computeLength(){this.tickLength=0;for(let e of this.compilation.schedule){if("replay"!==e.type)continue;let t=e.replay;this.tickLength+=this.computeTickLengthForReplay(t)}}static initUiFromStoredConfig(){this.loaded=!0;let e=Y.data.videoRecorderConfig.playbackSpeed.toString();e.includes(".")||(e+=".0"),this.div.querySelectorAll("._config-row")[0].children[1].value=Y.data.videoRecorderConfig.width.toString(),this.div.querySelectorAll("._config-row")[1].children[1].value=Y.data.videoRecorderConfig.height.toString(),this.div.querySelectorAll("._config-row")[2].children[1].value=Y.data.videoRecorderConfig.kilobitRate.toString(),this.div.querySelectorAll("._config-row")[3].children[1].value=Y.data.videoRecorderConfig.frameRate.toString(),this.div.querySelectorAll("._config-row")[4].children[1].value=e,this.div.querySelectorAll("._config-row")[5].children[1].checked=Y.data.videoRecorderConfig.fastMode,this.div.querySelectorAll("._config-row")[6].children[1].checked=Y.data.videoRecorderConfig.bt709,this.div.querySelectorAll("._config-row")[7].children[1].checked=Y.data.videoRecorderConfig.includeAudio,this.div.querySelectorAll("._config-row")[8].children[1].value=Y.data.videoRecorderConfig.audioKilobitRate.toString(),this.div.querySelectorAll("._config-row")[9].children[1].value=(2*Math.atan(Y.data.videoRecorderConfig.musicToSoundRatio)/Math.PI).toString(),this.updateMusicToSoundRatioDisplay(),this.updateAudioSettingsEnabledness()}static hide(){this.div.classList.add("hidden"),e.menu.levelSelect.show(),this.directoryHandle=null,this.fileHandle=null,this.chapterFileHandle=null,this.process=null,this.compilation=null,this.renderButton.classList.add("disabled"),this.progressBar.style.display="none",this.progressBar.value=0,this.statusText.textContent="",this.configContainer.classList.remove("disabled"),this.renderButton.textContent="Render",this.closeButton.style.display="",this.compilationLoadingElement.classList.add("hidden"),document.title="Marble Blast Web"}static showNotSupportedAlert(){e.menu.showAlertPopup("Not supported","Unfortunately, your browser does not support the technology required by the video renderer. To access this feature, try using Chromium 94 or above (Chrome 94, Edge 94, Opera 80) on desktop.")}}ma=pa,pa.loaded=!1,pa.compilation=null,pa.process=null,ma.div=document.querySelector("#video-renderer"),ma.configContainer=ma.div.querySelector("._config"),ma.selectDestinationButton=ma.div.querySelector("#video-renderer-select-destination"),ma.overviewText=ma.div.querySelector("#video-renderer-overview"),ma.renderButton=ma.div.querySelector("#video-renderer-render"),ma.closeButton=ma.div.querySelector("#video-renderer-close"),ma.progressBar=ma.div.querySelector("#video-renderer progress"),ma.statusText=ma.div.querySelector("#video-renderer-status"),ma.compilationLoadingElement=ma.div.querySelector("#video-renderer-compilation-loading"),ma.selectDestinationButton.addEventListener("click",async()=>{let e=ma.compilation.schedule[0].mission,t=I.removeSpecialChars(e.title.toLowerCase().split(" ").map(e=>I.uppercaseFirstLetter(e)).join(""));try{ma.fileHandle=await window.showSaveFilePicker({startIn:"videos",suggestedName:`${t}.webm`,types:[{description:"Video File",accept:{"video/webm":[".webm"]}}]})}catch(e){return}ma.updateOverviewText(),ma.renderButton.classList.remove("disabled")}),ma.renderButton.addEventListener("click",()=>{"Stop"===ma.renderButton.textContent?ma.stopRender(!1):ma.render()}),ma.closeButton.addEventListener("click",()=>{ma.stopRender(!0)}),ma.div.querySelectorAll("._config-row")[4].children[1].addEventListener("input",()=>{ma.updateOverviewText()}),ma.div.querySelectorAll("._config-row")[7].children[1].addEventListener("input",()=>{ma.updateAudioSettingsEnabledness()}),ma.div.querySelectorAll("._config-row")[9].children[1].addEventListener("input",()=>{ma.updateMusicToSoundRatioDisplay()});class ga{constructor(){this.renderedFrames=0,this.renderedLevels=0,this.stopped=!1,this.chaptersText=""}async run(){var e,t;try{if(this.readConfiguration(),!this.validateConfiguration())return;if(this.storeConfiguration(),this.prepareUi(),await this.createWorker(),this.setUpWorker(),await this.keepScreenAwake(),await this.renderLevels(),this.initFinalization(),this.stopped)return;await this.awaitEncoding(),await this.finalize()}catch(t){console.error(t),null===(e=this.level)||void 0===e||e.stop(),clearInterval(this.intervalId),this.exitWithError()}finally{null===(t=this.worker)||void 0===t||t.terminate(),this.releaseWakeLock()}}async renderLevels(){for(let t of pa.compilation.schedule){if("replay"!==t.type)continue;if(this.stopped)break;this.currentEntry=t;let{mission:i,replay:s}=t;await this.loadLevel(i,s),this.initRendering(),await this.renderFrames(),await this.renderAudio(),this.level.stop(),e.level=null,s.level=null,this.renderedLevels++}}readConfiguration(){const e=pa.div;this.width=Number(e.querySelectorAll("._config-row")[0].children[1].value),this.height=Number(e.querySelectorAll("._config-row")[1].children[1].value),this.kilobitRate=Number(e.querySelectorAll("._config-row")[2].children[1].value),this.frameRate=Number(e.querySelectorAll("._config-row")[3].children[1].value),this.playbackSpeed=Number(e.querySelectorAll("._config-row")[4].children[1].value),this.fastMode=e.querySelectorAll("._config-row")[5].children[1].checked,this.bt709=e.querySelectorAll("._config-row")[6].children[1].checked,this.includeAudio=e.querySelectorAll("._config-row")[7].children[1].checked,this.audioKilobitRate=Number(e.querySelectorAll("._config-row")[8].children[1].value),this.musicToSoundRatio=Math.tan(Number(e.querySelectorAll("._config-row")[9].children[1].value)*Math.PI/2)}validateConfiguration(){return!Number.isInteger(this.width)||this.width<1||this.width%2!=0?(e.menu.showAlertPopup("Error",'"Width" has to be a positive even integer.'),!1):!Number.isInteger(this.height)||this.height<1||this.height%2!=0?(e.menu.showAlertPopup("Error",'"Height" has to be a positive even integer.'),!1):!isFinite(this.kilobitRate)||this.kilobitRate<1?(e.menu.showAlertPopup("Error",'"Bit rate" has an illegal value.'),!1):!isFinite(this.frameRate)||this.frameRate<=0?(e.menu.showAlertPopup("Error",'"Frame rate" has to be positive.'),!1):!isFinite(this.playbackSpeed)||this.playbackSpeed<=0?(e.menu.showAlertPopup("Error",'"Playback speed" has to be positive.'),!1):!(!isFinite(this.audioKilobitRate)||this.audioKilobitRate<6)||(e.menu.showAlertPopup("Error",'"Audio bit rate" has to be at least 6 kbit/s.'),!1)}storeConfiguration(){Y.data.videoRecorderConfig.width=this.width,Y.data.videoRecorderConfig.height=this.height,Y.data.videoRecorderConfig.kilobitRate=this.kilobitRate,Y.data.videoRecorderConfig.frameRate=this.frameRate,Y.data.videoRecorderConfig.playbackSpeed=this.playbackSpeed,Y.data.videoRecorderConfig.fastMode=this.fastMode,Y.data.videoRecorderConfig.bt709=this.bt709,Y.data.videoRecorderConfig.includeAudio=this.includeAudio,Y.data.videoRecorderConfig.audioKilobitRate=this.audioKilobitRate,Y.data.videoRecorderConfig.musicToSoundRatio=this.musicToSoundRatio,Y.store()}computeFrameCountForReplay(e){return Math.floor(pa.computeTickLengthForReplay(e)/ea*this.frameRate/this.playbackSpeed)}prepareUi(){pa.configContainer.classList.add("disabled"),pa.progressBar.style.display="block",pa.renderButton.textContent="Stop",pa.closeButton.style.display="none";let e=pa.compilation.schedule.filter(e=>"replay"===e.type);this.totalFrameCount=e.reduce((e,t)=>e+this.computeFrameCountForReplay(t.replay),0),this.totalTimeUs=1e6*this.totalFrameCount/this.frameRate,this.levelCount=e.length}async createWorker(){let e=fa.toString(),t=e.slice(e.indexOf("{")+1,e.lastIndexOf("}")),i=new Blob([t]),s=new Worker(URL.createObjectURL(i));s.postMessage(window.location.href.slice(0,window.location.href.lastIndexOf("/")+1)),await new Promise(e=>s.addEventListener("message",t=>"ready"===t.data&&e())),this.worker=s}async loadLevel(t,i){this.beginUpdatingUiBasedOnLoadingProgress(),await t.load(),this.level=new ca(t,Object.assign({duration:this.computeFrameCountForReplay(i)/this.frameRate*this.playbackSpeed,musicVolume:Math.min(this.musicToSoundRatio,1),soundVolume:Math.min(1/this.musicToSoundRatio,1)},await this.getMarbleConfigForCurrentRunner())),e.level=this.level,await this.level.init(),this.level.replay=i,i.level=this.level,i.mode="playback",await this.level.start(),clearInterval(this.intervalId)}async getMarbleConfigForCurrentRunner(){let e,t;if("string"==typeof this.currentEntry.runner){let i=pa.compilation.runners.find(e=>e.id===this.currentEntry.runner),s=i.marbleTexture;s?e=await(await pa.directoryHandle.getFileHandle(s)).getFile():null===s&&(e=null),t=i.reflectiveMarble}return{marbleTexture:e,reflectiveMarble:t}}beginUpdatingUiBasedOnLoadingProgress(){this.intervalId=setInterval(()=>{var e,t;let i=Math.min(null!==(t=null===(e=this.level)||void 0===e?void 0:e.getLoadingCompletion())&&void 0!==t?t:0,1);pa.progressBar.value=(this.renderedLevels+.1*i)/this.levelCount,pa.progressBar.value*=.8,pa.statusText.textContent=`Loading (${Math.floor(100*i)}%)`},16)}setUpWorker(){this.worker.postMessage({command:"setup",width:this.width,height:this.height,kilobitRate:this.kilobitRate,frameRate:this.frameRate,includeAudio:this.includeAudio,audioKilobitRate:this.audioKilobitRate,fileHandle:pa.fileHandle}),this.worker.addEventListener("message",e=>{var t;"error"===e.data.command&&(console.error(e),null===(t=this.level)||void 0===t||t.stop(),clearInterval(this.intervalId),this.exitWithError())}),this.lastVideoChunkTimestamp=0,this.lastAudioChunkTimestamp=this.includeAudio?0:1/0,this.worker.addEventListener("message",e=>{"videoChunkEncoded"===e.data.command?this.lastVideoChunkTimestamp=e.data.timestamp:"audioChunkEncoded"===e.data.command&&(this.lastAudioChunkTimestamp=e.data.timestamp)})}initRendering(){he.setSize(this.width,this.height),he.setPixelRatio(1),this.level.onResize(this.width,this.height,1);let e=document.createElement("canvas");e.setAttribute("width",this.width.toString()),e.setAttribute("height",this.height.toString()),this.ctx=e.getContext("2d",{willReadFrequently:!0})}async renderFrames(){const e=this.computeFrameCountForReplay(this.currentEntry.replay);for(let t=0;t<e&&!this.stopped;t++){let i=1e3*t*this.playbackSpeed/this.frameRate;if(this.level.render(i),this.level.stopped)break;if(this.composeFrame(i),this.sendFrameToWorker(),0===t&&this.appendToChaptersText(),this.renderedFrames++,document.title=`Rendering (${(100*this.renderedFrames/this.totalFrameCount).toFixed(1)}%) - Marble Blast Web`,pa.statusText.textContent=`Rendering frame ${Math.min(this.renderedFrames,this.totalFrameCount)}/${this.totalFrameCount}`,pa.progressBar.value=(this.renderedLevels+.1+.9*Math.min(t+1,e)/e)/this.levelCount,pa.progressBar.value*=.8,await this.waitBeforeRenderingNextFrame(),he.gl.isContextLost())throw new Error("Context lost")}}composeFrame(t){this.ctx.globalAlpha=1,this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.resetTransform(),this.ctx.drawImage(le,0,0),this.ctx.drawImage(e.menu.hud.hudCanvas,0,0),this.maybeDrawRunInfo(t),this.drawSectionText(t)}maybeDrawRunInfo(e){if(!1===pa.compilation.showInfo)return;if(this.ctx.globalAlpha=1-I.clamp((e-(na-1e3))/1e3,0,1),0===this.ctx.globalAlpha)return;let t=this.width/1920,i=1-(1-I.clamp(e/500,0,1))**2,s=I.lerp(1.05,1,i);this.ctx.translate(this.width/2,this.height),this.ctx.scale(s,s),this.ctx.translate(-this.width/2,-this.height),this.ctx.fillStyle="white",this.ctx.font=`${64*t}px Chakra Petch`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.shadowColor="rgba(0, 0, 0, 0.75)",this.ctx.shadowBlur=4*t,this.ctx.shadowOffsetX=1*t,this.ctx.shadowOffsetY=2*t;let n=this.level.mission.title,{replay:r}=this.currentEntry;if(r.finishTime&&(n+=" - "+I.secondsToTimeString(r.finishTime.gameplayClock/1e3)),this.ctx.fillText(n,this.width/2,.73*this.height),"string"==typeof this.currentEntry.runner){let e=pa.compilation.runners.find(e=>e.id===this.currentEntry.runner).name;this.ctx.font=`${48*t}px Chakra Petch`,this.ctx.fillText(`Runner: ${e}`,this.width/2,.8*this.height)}}drawSectionText(e){let t=e-(1e3*pa.computeTickLengthForReplay(this.currentEntry.replay)/ea-3e3),i=I.clamp(t/500,0,1);if(0===i)return;let s=pa.compilation.schedule,n=s.findIndex(e=>e===this.currentEntry)+1,r=[];for(;s[n]&&"sectionEnd"===s[n].type;)r.push(s[n]),n++;for(let[e,t]of r.reverse().entries()){let r=I.findLastIndex(s,e=>"sectionStart"===e.type&&e.name===t.name,n-1);if(-1===r)continue;let a=0;for(let e=r+1;e<n;e++){let t=s[e];"replay"===t.type&&t.replay.finishTime&&(a+=t.replay.finishTime.gameplayClock)}let o=this.width/1920;this.ctx.globalAlpha=i,this.ctx.fillStyle="white",this.ctx.font=`${64*o}px Chakra Petch`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.shadowColor="rgba(0, 0, 0, 0.75)",this.ctx.shadowBlur=4*o,this.ctx.shadowOffsetX=1*o,this.ctx.shadowOffsetY=2*o,this.ctx.fillText(`${t.name}: ${I.secondsToTimeString(a/1e3)}`,this.width/2,.73*this.height-.07*this.height*e)}}sendFrameToWorker(){if(this.bt709){let e=this.ctx.getImageData(0,0,this.width,this.height).data.buffer;this.worker.postMessage({command:"imageBuffer",imageBuffer:e},[e])}else{let e=new VideoFrame(this.ctx.canvas,{timestamp:1e6*this.renderedFrames/this.frameRate});this.worker.postMessage({command:"videoFrame",videoFrame:e},[e])}}appendToChaptersText(){let e=this.renderedFrames/this.frameRate;this.chaptersText+=`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")} - ${this.level.mission.title}`,"string"==typeof this.currentEntry.runner&&(this.chaptersText+=` | ${pa.compilation.runners.find(e=>e.id===this.currentEntry.runner).name}`),this.chaptersText+="\n"}async waitBeforeRenderingNextFrame(){this.fastMode?await new Promise(e=>G(e,16)):await new Promise(e=>this.worker.addEventListener("message",t=>{"videoChunkEncoded"===t.data.command&&e()},{once:!0}))}async renderAudio(){if(this.includeAudio){let e=this.level.audio.context,t=await e.startRendering(),i=this.createAudioData(t,this.playbackSpeed);this.worker.postMessage({command:"audioData",audioData:i},[i])}}createAudioData(e,t){let i=Math.floor(e.length/t),s=new Float32Array(2*i);if(1===t)e.copyFromChannel(s,0),e.copyFromChannel(s.subarray(i),1);else{let n=[e.getChannelData(0),e.getChannelData(1)];for(let e=0;e<i;e++){let r=e*t;for(let t=0;t<2;t++){let a=n[t],o=a[Math.floor(r)],l=a[Math.ceil(r)],h=I.lerp(o,l,r%1);s[t*i+e]=h}}}return new AudioData({format:"f32-planar",sampleRate:dt,numberOfFrames:i,numberOfChannels:2,timestamp:0,data:s})}initFinalization(){this.stopped||this.worker.postMessage({command:"finishUp"})}async awaitEncoding(){let e=()=>Math.min(this.lastVideoChunkTimestamp,this.lastAudioChunkTimestamp),t=e();this.intervalId=setInterval(()=>{let i=(e()-t)/(this.totalTimeUs-t);pa.statusText.textContent=`Encoding (${(100*i).toFixed(1)}%)`,pa.progressBar.value=.8+.2*i},16),await new Promise(e=>this.worker.addEventListener("message",t=>"closing"===t.data&&e())),clearInterval(this.intervalId)}async finalize(){if(!this.stopped){if(pa.statusText.textContent="Writing and checking file... (might take a while)",pa.progressBar.value=1,await new Promise(e=>this.worker.addEventListener("message",t=>"done"===t.data&&e())),pa.statusText.textContent="Finalizing...",pa.progressBar.value=1,pa.chapterFileHandle){let e=await pa.chapterFileHandle.createWritable();await e.write(this.chaptersText),await e.close()}await I.wait(200),e.menu.showAlertPopup("Rendering complete","The replay has been successfully rendered to the specified destination video file.")}}exitWithError(){let t;t=he.gl.isContextLost()?"Your WebGL context has been lost during rendering, meaning that your browser thought the rendering task was too taxing on your hardware. Rendering using parallelized encoding might be the cause of this. Please reload the page to restore the context.":"There has been an error during video rendering.",e.menu.showAlertPopup("Rendering failed",t),e.level=null,this.stopped=!0}stop(){this.stopped=!0,clearInterval(this.intervalId)}async keepScreenAwake(){if("wakeLock"in navigator)try{this.wakeLock=await navigator.wakeLock.request("screen")}catch(e){}}releaseWakeLock(){var e;null===(e=this.wakeLock)||void 0===e||e.release()}}const fa=()=>{let e,t,i,s,n,r,a,o,l=-1/0,h=0;const d=e=>{let t=e.timestamp-l>=5e6;t&&(l=e.timestamp),i.encode(e,{keyFrame:t}),e.close()};self.onmessage=(async u=>{if(!e)return e=u.data,self.importScripts(e+"lib/webm.js"),void self.postMessage("ready");let m=u.data;try{"setup"===m.command?await(async e=>{n=await e.fileHandle.createWritable(),r=e.width,a=e.height,o=e.frameRate,t=new WebMMuxer({target:n,video:{codec:"V_VP9",width:e.width,height:e.height,frameRate:e.frameRate},audio:e.includeAudio?{codec:"A_OPUS",numberOfChannels:2,sampleRate:48e3}:void 0}),(i=new VideoEncoder({output:(e,i)=>{t.addVideoChunk(e,i),"key"===e.type&&(l=Math.max(l,e.timestamp)),self.postMessage({command:"videoChunkEncoded",timestamp:e.timestamp})},error:e=>console.error(e)})).configure({codec:"vp09.00.10.08",width:e.width,height:e.height,bitrate:1e3*e.kilobitRate,latencyMode:"realtime"}),e.includeAudio&&(s=new AudioEncoder({output:(e,i)=>{t.addAudioChunk(e,i),self.postMessage({command:"audioChunkEncoded",timestamp:e.timestamp})},error:e=>console.error(e)})).configure({codec:"opus",numberOfChannels:2,sampleRate:48e3,bitrate:1e3*e.audioKilobitRate})})(m):"imageBuffer"===m.command?(e=>{let t=c({width:r,height:a,data:new Uint8ClampedArray(e.imageBuffer)}),i=new VideoFrame(t,{format:"I420",codedWidth:r,codedHeight:a,timestamp:h,colorSpace:{matrix:"bt709",transfer:"bt709",primaries:"bt709",fullRange:!1}});h+=1e6/o,d(i)})(m):"videoFrame"===m.command?d(m.videoFrame):"audioData"===m.command?(m=m,s.encode(m.audioData),m.audioData.close()):"finishUp"===m.command&&await(async()=>{await Promise.all([i.flush(),null===s||void 0===s?void 0:s.flush()]),i.close(),null===s||void 0===s||s.close(),t.finalize(),self.postMessage("closing"),await n.close(),self.postMessage("done")})()}catch(u){self.postMessage({command:"error",error:u})}});const c=({width:e,height:t,data:i})=>{let s=new Uint8Array(e*t*1.5);for(let n=0;n<t;n+=64)for(let r=0;r<e;r+=64){let a=Math.min(e,r+64),o=Math.min(t,n+64);for(let l=n;l<o;l++)for(let n=r;n<a;n++){let r=i[4*(l*e+n)+0],a=i[4*(l*e+n)+1],o=i[4*(l*e+n)+2],h=.182586*r+.614231*a+.0620071*o+16,d=-.100668*r-.338547*a+.439216*o+128.439,c=.439216*r-.398984*a-.0426039*o+128.439;s[l*e+n]=h,n%2==0&&l%2==0&&(s[1*e*t+(l*e/4+n/2)]=d,s[1.25*e*t+(l*e/4+n/2)]=c)}}return s}};var ya;class ba{constructor(t){this.setImagesTimeout=null,this.clearImageTimeout=null,this.currentQuery="",this.currentQueryWords=[],this.currentSort="chronological",this.replayButtonData=new WeakMap,this.fetchingRemoteReplay=!1,this.menu=t,this.initProperties(),t.setupButton(this.homeButton,this.homeButtonSrc,()=>{this.hide(),t.home.show()},void 0,void 0,"gold"===e.modification),t.setupButton(this.prevButton,"play/prev",e=>this.cycleMission(-1*this.computeSeekMultiplier(e)),!0,!0,"gold"===e.modification,!0),t.setupButton(this.playButton,"play/play",()=>this.playCurrentMission(),!0,void 0,"gold"===e.modification),t.setupButton(this.nextButton,"play/next",e=>this.cycleMission(1*this.computeSeekMultiplier(e)),!0,!0,"gold"===e.modification,!0)}get currentMission(){var e;return null===(e=this.sortedMissionArray)||void 0===e?void 0:e[this.currentMissionIndex]}async init(){for(let e=0;e<this.localScoresCount;e++){let e=this.createScoreElement(async e=>await Y.databaseGet("replays",e));this.localBestTimesContainer.appendChild(e)}for(let e=0;e<18;e++){let e=this.createScoreElement(async()=>{if(!this.fetchingRemoteReplay)try{this.fetchingRemoteReplay=!0;let e=await ne.retryFetch(`./api/world_record_replay?missionPath=${encodeURIComponent(this.currentMission.path)}`),t=await e.arrayBuffer();return this.fetchingRemoteReplay=!1,t}catch(e){return this.fetchingRemoteReplay=!1,null}});this.leaderboardScores.appendChild(e)}this.scrollWindow.addEventListener("scroll",()=>this.updateOnlineLeaderboard()),window.addEventListener("keydown",e=>{this.div.classList.contains("hidden")||("ArrowLeft"!==e.code||this.searchInput.value&&document.activeElement!==document.body?"ArrowRight"!==e.code||this.searchInput.value&&document.activeElement!==document.body?"Escape"===e.code&&(this.homeButton.src=this.menu.uiAssetPath+this.homeButtonSrc+"_d.png"):(this.cycleMission(1*this.computeSeekMultiplier(e)),this.nextButton.style.pointerEvents||(this.nextButton.src=this.menu.uiAssetPath+"play/next_d.png")):(this.cycleMission(-1*this.computeSeekMultiplier(e)),this.prevButton.style.pointerEvents||(this.prevButton.src=this.menu.uiAssetPath+"play/prev_d.png")))}),window.addEventListener("keyup",e=>{this.div.classList.contains("hidden")||("ArrowLeft"===e.code?this.prevButton.style.pointerEvents||(this.prevButton.src=this.prevButton.hasAttribute("data-hovered")?this.menu.uiAssetPath+"play/prev_h.png":this.menu.uiAssetPath+"play/prev_n.png"):"ArrowRight"===e.code?this.nextButton.style.pointerEvents||(this.nextButton.src=this.nextButton.hasAttribute("data-hovered")?this.menu.uiAssetPath+"play/next_h.png":this.menu.uiAssetPath+"play/next_n.png"):"Escape"===e.code&&this.homeButton.click())}),this.searchInput.addEventListener("input",()=>{this.onSearchInputChange()}),this.searchInput.addEventListener("focus",()=>{this.searchInput.value="",this.onSearchInputChange()}),this.sortToggleButton.addEventListener("mouseenter",()=>{ft.play("buttonover.wav")}),this.sortToggleButton.addEventListener("mousedown",()=>{ft.play("buttonpress.wav"),this.currentSort="lexicographical"===this.currentSort?"chronological":"lexicographical",this.sortToggleButton.src="lexicographical"===this.currentSort?"./assets/svg/sort_by_alpha_FILL0_wght400_GRAD0_opsz24.svg":"./assets/svg/event_FILL0_wght400_GRAD0_opsz24.svg",this.sortMissions(),this.selectBasedOnSearchQuery(!1),this.displayMission()})}show(){this.div.classList.remove("hidden"),this.displayMission()}hide(){this.div.classList.add("hidden")}setMissionArray(e,t=!0){this.currentMissionArray=e,this.currentMissionIndex=this.getDefaultMissionIndex(),this.sortMissions(),this.selectBasedOnSearchQuery(!1),this.displayMission(t)}get currentSortFn(){return"lexicographical"===this.currentSort?Vt.compareLexicographically:Vt.compareChronologically}sortMissions(){this.sortedMissionArray=[...this.currentMissionArray].sort(this.currentSortFn)}getDefaultMissionIndex(){var e;if([Ot.goldCustom,Ot.platinumCustom,Ot.ultraCustom].includes(this.currentMissionArray))return this.currentMissionArray.length-1;let t=0;for(let i=0;i<this.currentMissionArray.length;i++){let s=this.currentMissionArray[i];(null===(e=Y.data.bestTimes[s.path])||void 0===e?void 0:e.length)&&(t=i+1)}return Math.min(t,this.currentMissionArray.length-1)}displayMission(e=!0){this.currentMission?("none"===this.playButton.style.pointerEvents&&(this.playButton.src=this.menu.uiAssetPath+"play/play_n.png",this.playButton.style.pointerEvents=""),this.levelImage.style.display="",this.displayMetadata(),this.displayBestTimes(),this.clearImageTimeout||(this.clearImageTimeout=setTimeout(()=>this.levelImage.src="",16))):(this.levelImage.style.display="none",this.playButton.src=this.menu.uiAssetPath+"play/play_i.png",this.playButton.style.pointerEvents="none",this.displayEmptyMetadata(),this.displayBestTimes()),this.setImages(!1,e),this.updateNextPrevButtons(),yt.loadLocal()}playCurrentMission(e){this.currentMission&&(this.div.classList.add("hidden"),this.menu.loadingScreen.loadLevel(this.currentMission,e?async()=>ua.fromSerialized(await e):void 0))}cycleMission(e){let t=this.getCycleMissionIndex(e);null!==t&&t!==this.currentMissionIndex&&(this.currentMissionIndex=t,this.displayMission())}getCycleMissionIndex(e){if(0===e)return this.currentMissionIndex;let t=null;for(let i=this.currentMissionIndex+Math.sign(e);i>=0&&i<this.sortedMissionArray.length&&0!==e;i+=Math.sign(e)){let s=i<0||i>=this.sortedMissionArray.length;if(i=I.clamp(i,0,this.sortedMissionArray.length-1),this.sortedMissionArray[i].matchesSearch(this.currentQueryWords,this.currentQuery)&&(e-=1*Math.sign(e),t=i),s)break}return t}canGoNext(){let e=!1;for(let t=this.currentMissionIndex+1;t<this.sortedMissionArray.length;t++)if(this.sortedMissionArray[t].matchesSearch(this.currentQueryWords,this.currentQuery)){e=!0;break}return e}canGoPrev(){let e=!1;for(let t=this.currentMissionIndex-1;t>=0;t--)if(this.sortedMissionArray[t].matchesSearch(this.currentQueryWords,this.currentQuery)){e=!0;break}return e}updateNextPrevButtons(){this.canGoNext()?(this.nextButton.src.endsWith("i.png")&&(this.nextButton.src=this.menu.uiAssetPath+"play/next_n.png"),this.nextButton.style.pointerEvents=""):(this.nextButton.src=this.menu.uiAssetPath+"play/next_i.png",this.nextButton.style.pointerEvents="none"),this.canGoPrev()?(this.prevButton.src.endsWith("i.png")&&(this.prevButton.src=this.menu.uiAssetPath+"play/prev_n.png"),this.prevButton.style.pointerEvents=""):(this.prevButton.src=this.menu.uiAssetPath+"play/prev_i.png",this.prevButton.style.pointerEvents="none")}setImages(e=!1,t=!0){if(e&&(clearTimeout(this.setImagesTimeout),this.setImagesTimeout=null),null!==this.setImagesTimeout&&t)return clearTimeout(this.setImagesTimeout),void(this.setImagesTimeout=setTimeout(()=>this.setImages(!0),75));let i=new Set;for(let e=0;e<=10;e++){let t=this.getCycleMissionIndex(Math.ceil(e/2)*(e%2?1:-1)),s=this.sortedMissionArray[t];s&&i.add(s)}for(let e of this.getNextShuffledMissions())i.add(e);for(let e of i){let i=e.getImagePath(),s=performance.now();ne.loadResource(i).then(async i=>{if(i){if(e===this.currentMission){let t=await ne.readBlobAsDataUrl(i);e===this.currentMission&&(clearTimeout(this.clearImageTimeout),this.clearImageTimeout=null,this.levelImage.src=t)}performance.now()-s>75&&!this.setImagesTimeout&&t&&(this.setImagesTimeout=setTimeout(()=>this.setImages(!0),75))}})}}shuffle(){if(this.sortedMissionArray.length<=1)return;let e=this.currentMissionIndex;for(;e===this.currentMissionIndex;)e=Math.floor(I.popRandomNumber()*this.sortedMissionArray.length);this.currentMissionIndex=e,this.displayMission()}getNextShuffledMissions(){let e=[];if(this.sortedMissionArray.length>1){let t=this.currentMissionIndex,i=0,s=0;for(;s<5;){let n=I.peekRandomNumber(i++),r=Math.floor(n*this.sortedMissionArray.length);if(t!==r){let t=this.sortedMissionArray[r];e.push(t),s++}t=r}}return e}displayBestTimes(){var e;let t=I.getRandomId();this.lastDisplayBestTimesId=t;let i=Y.getBestTimesForMission(null===(e=this.currentMission)||void 0===e?void 0:e.path,this.localScoresCount,this.scorePlaceholderName);for(let e=0;e<this.localScoresCount;e++){let t=this.localBestTimesContainer.children[e];this.updateScoreElement(this.localBestTimesContainer.children[e],i[e],e+1),this.updateReplayButton(this.getReplayButtonForScoreElement(t),i[e],e+1,!0,!1)}if(this.currentMission)this.leaderboardLoading.style.display=yt.isLoading(this.currentMission.path)?"block":"none",this.updateOnlineLeaderboard(),setTimeout(()=>this.updateOnlineLeaderboard());else{this.leaderboardLoading.style.display="none",this.leaderboardScores.style.paddingTop="0px",this.leaderboardScores.style.paddingBottom="0px";for(let e of this.leaderboardScores.children)e.style.display="none"}}createReplayButton(e){let t=document.createElement("img");t.src="./assets/img/round_videocam_black_18dp.png",t.title="Alt-Click to download, Shift-Click to render to video";const i=async i=>{let s=this.currentMission;if(!s)return;let n=e(this.replayButtonData.get(t));if("watch"===i)this.playCurrentMission(n);else if("download"===i){let e=await n;if(!e)return;ua.download(e,s),I.isTouchDevice&&I.isInFullscreen()&&this.menu.showAlertPopup("Downloaded","The .wrec has been downloaded.")}else{let e=await n;if(!e)return;let t=ua.fromSerialized(e);pa.showForSingleReplay(this.currentMission,t)}};return t.addEventListener("click",async e=>{0===e.button&&(e.shiftKey?i("render"):e.altKey?i("download"):i("watch"))}),I.onLongTouch(t,()=>{i("download")}),t.addEventListener("mouseenter",()=>{ft.play("buttonover.wav")}),t.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),t}async updateReplayButton(e,t,i,s,n){if(e.style.display="none",this.replayButtonData.delete(e),s){if(!t[2])return;let i=this.lastDisplayBestTimesId,s=await Y.databaseCount("replays",t[2]);if(i!==this.lastDisplayBestTimesId||0===s)return;this.replayButtonData.set(e,t[2])}else if(!n||1!==i)return;e.style.display="block"}updateOnlineLeaderboard(){var e;let t=this.currentMission;if(!t)return;let i=null!==(e=yt.scores.get(t.path))&&void 0!==e?e:[],s=this.leaderboardScores.children,n=0;this.leaderboardScores.style.paddingTop="0px",this.leaderboardScores.style.paddingBottom="0px",s[n].style.display="block";let r=s[0].offsetTop-this.scrollWindow.scrollTop;for(this.leaderboardScores.style.height=i.length*this.scoreElementHeight+"px";r<-this.scoreElementHeight&&n<i.length;)n++,r+=this.scoreElementHeight;this.leaderboardScores.style.paddingTop=n*this.scoreElementHeight+"px";for(let e=0;e<s.length;e++){let t=s[e];if(n<i.length){let e=i[n];t.style.display="block",this.updateScoreElement(t,e,n+1),this.updateReplayButton(this.getReplayButtonForScoreElement(t),e,n+1,!1,e[2])}else t.style.display="none";n++}this.leaderboardScores.style.paddingBottom=Math.max(i.length-n,0)*this.scoreElementHeight+"px"}onSearchInputChange(){let e=I.removeSpecialCharacters(I.normalizeString(this.searchInput.value.trim())).toLowerCase();this.currentQuery=e,this.currentQueryWords=e.split(" "),e||(this.currentQueryWords.length=0),this.selectBasedOnSearchQuery(),this.updateNextPrevButtons()}selectBasedOnSearchQuery(e=!0){var t;if(null===(t=this.currentMission)||void 0===t||!t.matchesSearch(this.currentQueryWords,this.currentQuery))for(let t=0;t<this.sortedMissionArray.length;t++)if(this.sortedMissionArray[t].matchesSearch(this.currentQueryWords,this.currentQuery)){this.currentMissionIndex=t,e&&this.displayMission();break}}showLoadReplayPrompt(t){if(t.shiftKey&&t.altKey)return void this.showCompilationDirectoryPrompt();let i=document.createElement("input");i.setAttribute("type","file"),i.setAttribute("accept",".wrec"),i.onchange=(async()=>{try{let s=i.files[0],n=await ne.readBlobAsArrayBuffer(s),r=ua.fromSerialized(n),a=Ot.allMissions.find(e=>e.path===r.missionPath);if(!a)throw new Error("Mission not found.");if("gold"===e.modification&&(a.path.startsWith("mbp")||a.path.startsWith("mbu")))return void e.menu.showAlertPopup("Warning",`You can't load replays of ${a.path.startsWith("mbp")?"Platinum":"Ultra"} levels inside Marble Blast Gold.`);t.shiftKey?pa.showForSingleReplay(a,r):(this.div.classList.add("hidden"),this.menu.loadingScreen.loadLevel(a,async()=>r))}catch(t){e.menu.showAlertPopup("Error","There was an error loading the replay."),console.error(t)}}),i.click()}async showCompilationDirectoryPrompt(){if(!("showDirectoryPicker"in window&&"VideoEncoder"in window))return void pa.showNotSupportedAlert();let e;try{e=await window.showDirectoryPicker({mode:"readwrite"})}catch(e){return}pa.showForCompilation(e)}handleControllerInput(e){e.buttons[0].value>.5&&!Le[0]&&(this.playCurrentMission(),ft.play("buttonpress.wav")),e.buttons[6].value>.5&&!Le[6]&&(this.currentMissionArray===Ot.goldIntermediate?this.setMissionArray(Ot.goldBeginner):this.currentMissionArray===Ot.goldAdvanced?this.setMissionArray(Ot.goldIntermediate):this.currentMissionArray===Ot.goldCustom?this.setMissionArray(Ot.goldAdvanced):this.currentMissionArray===Ot.platinumBeginner?this.setMissionArray(Ot.goldCustom):this.currentMissionArray===Ot.platinumIntermediate?this.setMissionArray(Ot.platinumBeginner):this.currentMissionArray===Ot.platinumAdvanced?this.setMissionArray(Ot.platinumIntermediate):this.currentMissionArray===Ot.platinumExpert?this.setMissionArray(Ot.platinumAdvanced):this.currentMissionArray===Ot.platinumCustom?this.setMissionArray(Ot.platinumExpert):this.currentMissionArray===Ot.ultraBeginner?this.setMissionArray(Ot.platinumCustom):this.currentMissionArray===Ot.ultraIntermediate?this.setMissionArray(Ot.ultraBeginner):this.currentMissionArray===Ot.ultraAdvanced?this.setMissionArray(Ot.ultraIntermediate):this.currentMissionArray===Ot.ultraCustom&&this.setMissionArray(Ot.ultraAdvanced),ft.play("buttonpress.wav")),e.buttons[7].value>.5&&!Le[7]&&(this.currentMissionArray===Ot.goldBeginner?this.setMissionArray(Ot.goldIntermediate):this.currentMissionArray===Ot.goldIntermediate?this.setMissionArray(Ot.goldAdvanced):this.currentMissionArray===Ot.goldAdvanced?this.setMissionArray(Ot.goldCustom):this.currentMissionArray===Ot.goldCustom?this.setMissionArray(Ot.platinumBeginner):this.currentMissionArray===Ot.platinumBeginner?this.setMissionArray(Ot.platinumIntermediate):this.currentMissionArray===Ot.platinumIntermediate?this.setMissionArray(Ot.platinumAdvanced):this.currentMissionArray===Ot.platinumAdvanced?this.setMissionArray(Ot.platinumExpert):this.currentMissionArray===Ot.platinumExpert?this.setMissionArray(Ot.platinumCustom):this.currentMissionArray===Ot.platinumCustom?this.setMissionArray(Ot.ultraBeginner):this.currentMissionArray===Ot.ultraBeginner?this.setMissionArray(Ot.ultraIntermediate):this.currentMissionArray===Ot.ultraIntermediate?this.setMissionArray(Ot.ultraAdvanced):this.currentMissionArray===Ot.ultraAdvanced&&this.setMissionArray(Ot.ultraCustom),ft.play("buttonpress.wav")),e.buttons[14].value>.5&&!Le[14]&&(this.cycleMission(-1),ft.play("buttonpress.wav")),e.buttons[15].value>.5&&!Le[15]&&(this.cycleMission(1),ft.play("buttonpress.wav"))}computeSeekMultiplier(e){return e.ctrlKey?100:e.shiftKey?10:1}}class va extends ba{constructor(){super(...arguments),this.localScoresCount=3,this.scorePlaceholderName="Nardo Polo",this.scoreElementHeight=14}initProperties(){this.div=document.querySelector("#level-select"),this.homeButton=document.querySelector("#level-select-home-button"),this.homeButtonSrc="play/back",this.tabBeginner=document.querySelector("#tab-beginner"),this.tabIntermediate=document.querySelector("#tab-intermediate"),this.tabAdvanced=document.querySelector("#tab-advanced"),this.tabCustom=document.querySelector("#tab-custom"),this.scrollWindow=document.querySelector("#level-select-text-window-scrollable"),this.levelTitle=document.querySelector("#level-title"),this.levelArtist=document.querySelector("#level-artist"),this.levelDescription=document.querySelector("#level-description"),this.levelQualifyTime=document.querySelector("#level-qualify-time"),this.localBestTimesContainer=document.querySelector("#level-select-local-best-times"),this.leaderboardLoading=document.querySelector("#online-leaderboard-loading"),this.leaderboardScores=document.querySelector("#leaderboard-scores"),this.levelImage=document.querySelector("#level-image"),this.levelNumberElement=document.querySelector("#level-number"),this.prevButton=document.querySelector("#level-select-prev"),this.playButton=document.querySelector("#level-select-play"),this.nextButton=document.querySelector("#level-select-next"),this.searchInput=document.querySelector("#search-input"),this.sortToggleButton=document.querySelector("#sort-icon"),this.loadReplayButton=document.querySelector("#load-replay-button"),this.shuffleButton=document.querySelector("#shuffle-button")}async init(){await super.init();const e=(e,t)=>{e.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),e.addEventListener("click",e=>0===e.button&&this.setMissionArray(t))};e(this.tabBeginner,Ot.goldBeginner),e(this.tabIntermediate,Ot.goldIntermediate),e(this.tabAdvanced,Ot.goldAdvanced),e(this.tabCustom,Ot.goldCustom),this.loadReplayButton.addEventListener("click",async e=>{this.showLoadReplayPrompt(e)}),this.loadReplayButton.addEventListener("mouseenter",()=>{ft.play("buttonover.wav")}),this.loadReplayButton.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),this.shuffleButton.addEventListener("click",()=>{this.shuffle()}),this.shuffleButton.addEventListener("mouseenter",()=>{ft.play("buttonover.wav")}),this.shuffleButton.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),this.setMissionArray(Ot.goldCustom,!1),this.setMissionArray(Ot.goldAdvanced,!1),this.setMissionArray(Ot.goldIntermediate,!1),this.setMissionArray(Ot.goldBeginner,!1)}setMissionArray(e,t){super.setMissionArray(e,t);for(let e of[this.tabBeginner,this.tabIntermediate,this.tabAdvanced,this.tabCustom])e.style.zIndex="-1";let i=[Ot.goldBeginner,Ot.goldIntermediate,Ot.goldAdvanced,Ot.goldCustom].indexOf(this.currentMissionArray);[this.tabBeginner,this.tabIntermediate,this.tabAdvanced,this.tabCustom][i].style.zIndex="0"}displayMetadata(){let e=this.currentMission;this.levelTitle.textContent=e.title,this.levelArtist.textContent="by "+e.artist.trim(),this.levelArtist.style.display="custom"===e.type?"block":"none",this.levelDescription.textContent=e.description;let t=0!==e.qualifyTime?e.qualifyTime:1/0;this.levelQualifyTime.textContent=isFinite(t)?"Time to Qualify: "+I.secondsToTimeString(t/1e3):"",this.levelNumberElement.textContent=`${I.uppercaseFirstLetter(e.type)} Level ${this.currentMissionIndex+1}`}displayEmptyMetadata(){this.levelTitle.innerHTML="<br>",this.levelArtist.style.display="none",this.levelDescription.innerHTML="<br>",this.levelQualifyTime.innerHTML="",this.levelNumberElement.textContent=`Level ${this.currentMissionIndex+1}`}createScoreElement(e){let t=document.createElement("div");t.classList.add("level-select-best-time");let i=document.createElement("div");t.appendChild(i);let s=document.createElement("img");s.src="./assets/ui/play/goldscore.png",t.appendChild(s);let n=document.createElement("div");return t.appendChild(n),t.appendChild(this.createReplayButton(e)),t}getReplayButtonForScoreElement(e){return e.children[3]}updateScoreElement(e,t,i){let s=0,n=this.currentMission;n&&(s=n.goldTime),e.children[0].textContent=i+". "+t[0],e.children[1].style.opacity=t[1]<=s?"":"0",e.children[2].textContent=I.secondsToTimeString(t[1]/1e3)}}class wa{constructor(t){this.initProperties(),t.setupButton(this.playButton,this.playSrc,()=>{this.hide(),t.levelSelect.show(),yt.syncLeaderboard()}),t.setupButton(this.helpButton,this.helpSrc,()=>{this.hide(),t.helpScreen.show()},void 0,void 0,"gold"===e.modification),t.setupButton(this.optionsButton,this.optionsSrc,()=>{this.hide(),t.optionsScreen.show()}),t.setupButton(this.exitButton,this.exitSrc,()=>{window.close(),location.search.includes("app")||(location.href="https://www.youtube.com/watch?v=dQw4w9WgXcQ")}),t.setupButton(this.showChangelogButton,this.showChangelogSrc,()=>{this.changelogContainer.classList.remove("hidden")},void 0,void 0,"gold"===e.modification),t.setupButton(this.changelogBackButton,this.changelogBackSrc,()=>{this.changelogContainer.classList.add("hidden")}),this.div.querySelector(".modification-switcher").addEventListener("click",()=>{Ya("gold"===e.modification?"platinum":"gold")})}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}async init(){let t=await ne.loadResource("/api/version_history"),i=await ne.readBlobAsText(t),s=/(^|\n)## (\d+\.\d+\.\d+)/.exec(i)[2];this.version.textContent=`MBW v${s}`,I.isTouchDevice&&(this.version.style.left="15px",this.version.style.bottom="15px");let n="gold"===e.modification?"changelog":"mbp-changelog";i=(i=(i=(i=(i=i.replace(/(^|\n)# (.*)/g,`$1<span class="${n}-h1">$2</span>`)).replace(/(^|\n)## (.*)/g,`$1<span class="${n}-h2">$2</span>`)).replace(/(^|\n)### (.*)/g,`$1<span class="${n}-h3">$2</span>`)).replace(/\*\*(.*?)\*\*/g,"<b>$1</b>")).replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank">$1</a>'),this.changelogContent.innerHTML=i,Y.data.lastSeenVersion?s!==Y.data.lastSeenVersion&&(this.changelogContainer.classList.remove("hidden"),await Y.onVersionUpgrade(Y.data.lastSeenVersion)):(Object.keys(Y.data.bestTimes).length>0||Y.hadOldDatabase)&&this.changelogContainer.classList.remove("hidden"),Y.data.lastSeenVersion=s,Y.store()}}class xa extends wa{initProperties(){this.div=document.querySelector("#home-screen"),this.playButton=document.querySelector("#home-play"),this.optionsButton=document.querySelector("#home-options"),this.helpButton=document.querySelector("#home-help"),this.exitButton=document.querySelector("#home-exit"),this.showChangelogButton=document.querySelector("#show-changelog"),this.showChangelogText=document.querySelector("#show-changelog-text"),this.changelogContainer=document.querySelector("#changelog"),this.changelogBackButton=document.querySelector("#changelog-back"),this.changelogContent=document.querySelector("#changelog-content"),this.version=document.querySelector("#version"),this.playSrc="home/play",this.optionsSrc="home/options",this.helpSrc="home/help",this.exitSrc="home/exit",this.showChangelogSrc="motd/motd_buttn_textless",this.changelogBackSrc="play/back"}}class Sa{constructor(){this.gameUiDiv=document.querySelector("#game-ui"),this.popupContainer=document.querySelector("#popup-container"),this.activeButtonVariant=new Map,this.variantChangeListeners=new Map,this.menuDiv=this.getMenuDiv(),this.backgroundImage=this.getBackgroundImage(),this.home=this.createHome(),this.levelSelect=this.createLevelSelect(),this.loadingScreen=this.createLoadingScreen(),this.optionsScreen=this.createOptionsScreen(),this.helpScreen=this.createHelpScreen(),this.hud=this.createHud(),this.pauseScreen=this.createPauseScreen(),this.finishScreen=this.createFinishScreen()}setupVaryingButton(e,t,i,s=!1,n=!1,r=!0,a=!1){let o=t.slice();t=t.map(e=>this.uiAssetPath+e);let l,h=!1,d=!1;const c=()=>t[this.activeButtonVariant.get(e)]+"_n.png",u=()=>t[this.activeButtonVariant.get(e)]+"_h.png",m=()=>t[this.activeButtonVariant.get(e)]+"_d.png",p=()=>t[this.activeButtonVariant.get(e)]+"_i.png",g=()=>{let t=ve.x/de,i=ve.y/de,s=e.getBoundingClientRect();return t>=s.x-10&&t<s.x+s.width+10&&i>=s.y-10&&i<s.y+s.height+10};e.addEventListener("mouseenter",()=>{I.isTouchDevice||(d=!0,e.setAttribute("data-hovered",""),"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=h?m():u()),!h&&r&&ft.play("buttonover.wav")))}),e.addEventListener("mouseleave",()=>{I.isTouchDevice||(d=!1,e.removeAttribute("data-hovered"),"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=c())))}),e.addEventListener("touchmove",()=>{"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=g()?m():c()))});const f=t=>{"none"!==e.style.pointerEvents&&0===t.button&&(h=!0,e.hasAttribute("data-locked")||(e.src=m()),ft.play("buttonpress.wav"),n&&(i(t),a&&(l=setTimeout(()=>l=setInterval(()=>i(t),30),500))),window.addEventListener("mouseup",y),window.addEventListener("touchend",b))};e.addEventListener("mousedown",e=>{I.isTouchDevice||f(e)}),e.addEventListener("touchstart",()=>{f({button:0})});const y=()=>{h=!1,clearTimeout(l),clearInterval(l),window.removeEventListener("mouseup",y),window.removeEventListener("touchend",b),"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=d?u():c()))},b=e=>{h&&!n&&g()&&i(e),y()};n||e.addEventListener("click",e=>{e.isTrusted&&I.isTouchDevice&&"ontouchstart"in window||0===e.button&&i(e)});for(let t of o)t&&(this.activeButtonVariant.set(e,o.indexOf(t)),ne.loadImage(c()),ne.loadImage(u()),ne.loadImage(m()),s&&ne.loadImage(p()));this.variantChangeListeners.set(e,()=>{e.src=h?m():d?u():c()}),this.setButtonVariant(e,0)}setupButton(e,t,i,s,n,r,a){this.setupVaryingButton(e,[t],i,s,n,r,a)}setButtonVariant(e,t){this.activeButtonVariant.set(e,t),this.variantChangeListeners.get(e)()}show(){if(ft.setAssetPath(this.audioAssetPath),this.menuDiv.classList.remove("hidden"),ye(!0),I.isWeeb){let e=ft.assetPath;ft.assetPath="",this.music=ft.createAudioSource("./assets/music/renai.ogg",ft.musicGain),ft.assetPath=e}else this.music=ft.createAudioSource(this.menuMusicSrc,ft.musicGain);this.music.setLoop(!0),this.music.play(),this.popupContainer.style.visibility="visible",this.popupContainer.style.pointerEvents="auto"}hide(){var e;this.menuDiv.classList.add("hidden"),null===(e=this.music)||void 0===e||e.stop(),ye(!1)}showGameUi(){this.gameUiDiv.classList.remove("hidden")}hideGameUi(){this.gameUiDiv.classList.add("hidden")}createAlertBase(t,i,s){let n=document.createElement("div");n.classList.add("hidden"),n.classList.add("popup"),n.classList.add("gold"===e.modification?"mbg":"mbp");let r=document.createElement("div"),a=document.createElement("img");a.onload=(()=>{n.style.width=("gold"===e.modification?400:a.width)+"px",n.style.height=("gold"===e.modification?250:a.height)+"px",a.style.width=n.style.width,a.style.height=n.style.height,n.classList.remove("hidden")}),a.src=this.popupBackgroundSrc;let o=document.createElement("p");o.classList.add("_heading"),o.innerHTML=t;let l=document.createElement("p");return l.classList.add("_body"),l.innerHTML=i,l.innerHTML=l.innerHTML.replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank">$1</a>'),n.append(r,a,o,l),s&&(s.classList.add("_custom"),setTimeout(()=>{s.style.top=44+l.clientHeight+"px",n.append(s)})),n}showAlertPopup(e,t,i){return new Promise(s=>{let n=this.createAlertBase(e,t,i),r=document.createElement("img");r.classList.add("_okay"),this.setupButton(r,this.popupOkaySrc,()=>{this.popupContainer.removeChild(n),0===this.popupContainer.children.length&&(this.popupContainer.style.display="none"),window.removeEventListener("keydown",a),window.removeEventListener("keyup",o),s()});let a=e=>{"Escape"===e.key&&(r.src=this.uiAssetPath+this.popupOkaySrc+"_d.png")},o=e=>{"Escape"===e.key&&r.click()};window.addEventListener("keydown",a),window.addEventListener("keyup",o),n.append(r),this.popupContainer.append(n),this.popupContainer.style.display=""})}showConfirmPopup(e,t,i){return new Promise(s=>{let n=this.createAlertBase(e,t,i),r=document.createElement("img");r.classList.add("_no"),this.setupButton(r,this.popupNoSrc,()=>{this.popupContainer.removeChild(n),0===this.popupContainer.children.length&&(this.popupContainer.style.display="none"),window.removeEventListener("keydown",o),window.removeEventListener("keyup",l),s(!1)});let a=document.createElement("img");a.classList.add("_yes"),this.setupButton(a,this.popupYesSrc,()=>{this.popupContainer.removeChild(n),0===this.popupContainer.children.length&&(this.popupContainer.style.display="none"),window.removeEventListener("keydown",o),window.removeEventListener("keyup",l),s(!0)});let o=e=>{"Escape"===e.key&&(r.src=this.uiAssetPath+this.popupNoSrc+"_d.png")},l=e=>{"Escape"===e.key&&r.click()};window.addEventListener("keydown",o),window.addEventListener("keyup",l),n.append(r,a),this.popupContainer.append(n),this.popupContainer.style.display=""})}async init(){ft.setAssetPath(this.audioAssetPath),await ft.loadBuffers([this.menuMusicSrc,"buttonover.wav","buttonpress.wav"]),await Promise.all([this.home.init(),this.levelSelect.init(),this.finishScreen.init(),this.optionsScreen.init(),this.helpScreen.init()]),await ne.loadImages([this.popupBackgroundSrc]);let e=document.createElement("img");this.setupButton(e,this.popupOkaySrc,null),this.setupButton(e,this.popupNoSrc,null),this.setupButton(e,this.popupYesSrc,null),this.home.show()}}class Ta{constructor(e){this.loadingIndex=0,this.menu=e,this.initProperties(),e.setupButton(this.cancelButton,"loading/cancel",()=>{this.hide(),e.levelSelect.show(),this.loadingIndex++,clearInterval(this.refresher)})}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}async loadLevel(t,i){this.show();let s=this.loadingIndex;this.levelNameElement.textContent=t.title,this.progressBar.style.width="0px",await I.wait(50);try{let n=i?i():Promise.resolve();if(await t.load(),this.loadingIndex!==s)return;this.refresher=setInterval(()=>{let e=r.getLoadingCompletion();this.progressBar.style.width=e*this.maxProgressBarWidth+"px"});let r=new ca(t);e.level=r,await r.init();let a=await n;if(a&&(r.replay=a,a.level=r,a.mode="playback"),this.loadingIndex!==s)return void r.dispose();clearInterval(this.refresher);let o=performance.now();if(this.refresher=setInterval(()=>{let e=I.clamp((performance.now()-o)/100,0,1);this.progressBar.style.width=e*this.maxProgressBarWidth+"px"}),await I.wait(150),this.loadingIndex!==s)return void r.dispose();clearInterval(this.refresher),r.start(),this.hide(),this.menu.hide(),this.menu.showGameUi()}catch(t){console.error(t),this.cancelButton.click(),e.level=null,e.menu.showAlertPopup("Error","There was an error due to which the level couldn't be loaded.")}}}class Ma extends Ta{constructor(){super(...arguments),this.maxProgressBarWidth=252}initProperties(){this.div=document.querySelector("#loading"),this.levelNameElement=document.querySelector("#loading-level-name"),this.cancelButton=document.querySelector("#loading-cancel"),this.progressBar=document.querySelector("#loading-progress")}}class Ca extends ln{constructor(e){super(e),this.trackLength=235,this.musicVolumeKnobLeft=155,this.soundVolumeKnobLeft=157,this.mouseSensitivityKnobLeft=148,this.draggingMusicVolume=!1,this.draggingSoundVolume=!1,this.draggingMouseSensitivity=!1,this.soundTestingSound=null,e.setupButton(this.resolution640,"options/graf640",()=>this.selectResolutionButton(this.resolution640,0)),e.setupButton(this.resolution800,"options/graf800",()=>this.selectResolutionButton(this.resolution800,1)),e.setupButton(this.resolution1024,"options/graf1024",()=>this.selectResolutionButton(this.resolution1024,2)),e.setupButton(this.openGl,"options/grafopgl",()=>this.selectVideoDriverButton(this.openGl,0)),e.setupButton(this.direct3D,"options/grafdir3d",()=>this.selectVideoDriverButton(this.direct3D,1)),e.setupButton(this.windowedButton,"options/grafwindo",()=>this.selectScreenStyleButton(this.windowedButton,0)),e.setupButton(this.fullButton,"options/grafful",()=>this.selectScreenStyleButton(this.fullButton,1)),e.setupButton(this.depth16,"options/graf16bt",()=>this.selectColorDepthButton(this.depth16,0)),e.setupButton(this.depth32,"options/graf32bt",()=>this.selectColorDepthButton(this.depth32,1)),e.setupButton(this.shadowsCheckbox,"options/graf_chkbx",()=>{Y.data.settings.shadows=!this.shadowsCheckbox.hasAttribute("data-locked"),Y.store(),this.shadowsCheckbox.hasAttribute("data-locked")?(this.shadowsCheckbox.removeAttribute("data-locked"),this.shadowsCheckbox.src="./assets/ui/options/graf_chkbx_h.png"):(this.shadowsCheckbox.setAttribute("data-locked",""),this.shadowsCheckbox.src="./assets/ui/options/graf_chkbx_d.png")}),e.setupButton(this.graphicsApply,"options/grafapply",()=>{});const t=()=>{(this.draggingMusicVolume||this.draggingSoundVolume||this.draggingMouseSensitivity)&&(this.draggingMusicVolume=this.draggingSoundVolume=this.draggingMouseSensitivity=!1,Y.store(),this.soundTestingSound&&(this.soundTestingSound.stop(),this.soundTestingSound=null))};window.addEventListener("mouseup",t),window.addEventListener("touchend",t),this.musicVolumeTrack.addEventListener("mousedown",()=>this.draggingMusicVolume=!0),this.musicVolumeTrack.addEventListener("touchstart",()=>this.draggingMusicVolume=!0),this.musicVolumeKnob.addEventListener("mousedown",()=>this.draggingMusicVolume=!0),this.musicVolumeKnob.addEventListener("touchstart",()=>this.draggingMusicVolume=!0),this.soundVolumeTrack.addEventListener("mousedown",()=>this.draggingSoundVolume=!0),this.soundVolumeTrack.addEventListener("touchstart",()=>this.draggingSoundVolume=!0),this.soundVolumeKnob.addEventListener("mousedown",()=>this.draggingSoundVolume=!0),this.soundVolumeKnob.addEventListener("touchstart",()=>this.draggingSoundVolume=!0),requestAnimationFrame(()=>this.updateSliders()),e.setupButton(this.marbleTab,"",()=>this.selectControlsTab("marble")),e.setupButton(this.cameraTab,"",()=>this.selectControlsTab("camera")),e.setupButton(this.mouseTab,"",()=>this.selectControlsTab("mouse")),e.setupButton(this.buttonMarbleLeft,"options/cntr_mrb_lft",()=>this.changeKeybinding("left")),e.setupButton(this.buttonMarbleRight,"options/cntr_mrb_rt",()=>this.changeKeybinding("right")),e.setupButton(this.buttonMarbleUp,"options/cntr_mrb_fw",()=>this.changeKeybinding("up")),e.setupButton(this.buttonMarbleDown,"options/cntr_mrb_bak",()=>this.changeKeybinding("down")),e.setupButton(this.buttonMarbleUse,"options/cntr_mrb_pwr",()=>this.changeKeybinding("use")),e.setupButton(this.buttonMarbleJump,"options/cntr_mrb_jmp",()=>this.changeKeybinding("jump")),e.setupButton(this.buttonCameraLeft,"options/cntr_cam_lft",()=>this.changeKeybinding("cameraLeft")),e.setupButton(this.buttonCameraRight,"options/cntr_cam_rt",()=>this.changeKeybinding("cameraRight")),e.setupButton(this.buttonCameraUp,"options/cntr_cam_up",()=>this.changeKeybinding("cameraUp")),e.setupButton(this.buttonCameraDown,"options/cntr_cam_dwn",()=>this.changeKeybinding("cameraDown")),this.mouseSensitivityKnob.addEventListener("mousedown",()=>this.draggingMouseSensitivity=!0),this.mouseSensitivityKnob.addEventListener("touchstart",()=>this.draggingMouseSensitivity=!0),e.setupButton(this.invertY,"options/cntrl_mous_invrt",()=>{Y.data.settings.invertMouse&=-3,Y.data.settings.invertMouse|=Number(!this.invertY.hasAttribute("data-locked"))<<1,Y.store(),this.invertY.hasAttribute("data-locked")?(this.invertY.removeAttribute("data-locked"),this.invertY.src="./assets/ui/options/cntrl_mous_invrt_h.png"):(this.invertY.setAttribute("data-locked",""),this.invertY.src="./assets/ui/options/cntrl_mous_invrt_d.png")}),e.setupButton(this.alwaysFreeLook,"options/cntrl_mous_freel",()=>{Y.data.settings.alwaysFreeLook=!this.alwaysFreeLook.hasAttribute("data-locked"),Y.store(),this.alwaysFreeLook.hasAttribute("data-locked")?(this.alwaysFreeLook.removeAttribute("data-locked"),this.alwaysFreeLook.src="./assets/ui/options/cntrl_mous_freel_h.png"):(this.alwaysFreeLook.setAttribute("data-locked",""),this.alwaysFreeLook.src="./assets/ui/options/cntrl_mous_freel_d.png")}),e.setupButton(this.freeLookKey,"options/cntrl_mous_bttn",()=>this.changeKeybinding("freeLook")),e.setupButton(this.chooseMarbleTexture,"options/cntr_cam_up",async()=>{await this.showMarbleTexturePicker(),this.setResetMarbleTextureState(!0)}),e.setupButton(this.resetMarbleTexture,"options/cntr_cam_dwn",()=>{Y.databaseDelete("keyvalue","marbleTexture"),this.setResetMarbleTextureState(!1)}),e.setupButton(this.buttonRestartLevel,"options/cntr_cam_dwn",()=>this.changeKeybinding("restart")),e.setupButton(this.reflectiveMarbleCheckbox,"options/cntrl_mous_freel",()=>{Y.data.settings.marbleReflectivity=this.reflectiveMarbleCheckbox.hasAttribute("data-locked")?0:2,Y.store(),this.reflectiveMarbleCheckbox.hasAttribute("data-locked")?(this.reflectiveMarbleCheckbox.removeAttribute("data-locked"),this.reflectiveMarbleCheckbox.src="./assets/ui/options/cntrl_mous_freel_h.png"):(this.reflectiveMarbleCheckbox.setAttribute("data-locked",""),this.reflectiveMarbleCheckbox.src="./assets/ui/options/cntrl_mous_freel_d.png")})}initProperties(){this.div=document.querySelector("#options"),this.homeButton=document.querySelector("#options-home"),this.rebindDialog=document.querySelector("#rebind-dialog"),this.rebindConfirm=document.querySelector("#rebind-confirm"),this.rebindConfirmYes=document.querySelector("#rebind-confirm-yes"),this.rebindConfirmNo=document.querySelector("#rebind-confirm-no"),this.homeButtonSrc="options/mainm",this.rebindConfirmYesSrc="common/yes",this.rebindConfirmNoSrc="common/no",this.tabGraphics=document.querySelector("#tab-graphics"),this.tabAudio=document.querySelector("#tab-audio"),this.tabControls=document.querySelector("#tab-controls"),this.graphicsDiv=document.querySelector("#options-graphics"),this.audioDiv=document.querySelector("#options-audio"),this.controlsDiv=document.querySelector("#options-controls"),this.resolution640=document.querySelector("#graphics-640"),this.resolution800=document.querySelector("#graphics-800"),this.resolution1024=document.querySelector("#graphics-1024"),this.openGl=document.querySelector("#graphics-opengl"),this.direct3D=document.querySelector("#graphics-direct3d"),this.windowedButton=document.querySelector("#graphics-windowed"),this.fullButton=document.querySelector("#graphics-full"),this.depth16=document.querySelector("#graphics-depth16"),this.depth32=document.querySelector("#graphics-depth32"),this.shadowsCheckbox=document.querySelector("#graphics-shadows"),this.graphicsApply=document.querySelector("#graphics-apply"),this.musicVolumeTrack=document.querySelector("#audio-music-track"),this.musicVolumeKnob=document.querySelector("#audio-music-knob"),this.soundVolumeTrack=document.querySelector("#audio-sound-track"),this.soundVolumeKnob=document.querySelector("#audio-sound-knob"),this.controlsBackground=document.querySelector("#controls-background"),this.marbleTab=document.querySelector("#tab-marble"),this.cameraTab=document.querySelector("#tab-camera"),this.mouseTab=document.querySelector("#tab-mouse"),this.marbleControlsDiv=document.querySelector("#controls-marble"),this.cameraControlsDiv=document.querySelector("#controls-camera"),this.mouseControlsDiv=document.querySelector("#controls-mouse"),this.buttonMarbleLeft=document.querySelector("#button-marble-left"),this.buttonMarbleRight=document.querySelector("#button-marble-right"),this.buttonMarbleUp=document.querySelector("#button-marble-up"),this.buttonMarbleDown=document.querySelector("#button-marble-down"),this.buttonMarbleUse=document.querySelector("#button-marble-use"),this.buttonMarbleJump=document.querySelector("#button-marble-jump"),this.buttonMarbleLeftContent=document.querySelector("#button-marble-left-content"),this.buttonMarbleRightContent=document.querySelector("#button-marble-right-content"),this.buttonMarbleUpContent=document.querySelector("#button-marble-up-content"),this.buttonMarbleDownContent=document.querySelector("#button-marble-down-content"),this.buttonMarbleUseContent=document.querySelector("#button-marble-use-content"),this.buttonMarbleJumpContent=document.querySelector("#button-marble-jump-content"),this.buttonCameraLeft=document.querySelector("#button-camera-left"),this.buttonCameraRight=document.querySelector("#button-camera-right"),this.buttonCameraUp=document.querySelector("#button-camera-up"),this.buttonCameraDown=document.querySelector("#button-camera-down"),this.buttonCameraLeftContent=document.querySelector("#button-camera-left-content"),this.buttonCameraRightContent=document.querySelector("#button-camera-right-content"),this.buttonCameraUpContent=document.querySelector("#button-camera-up-content"),this.buttonCameraDownContent=document.querySelector("#button-camera-down-content"),this.mouseSensitivityKnob=document.querySelector("#sensitivity-knob"),this.invertY=document.querySelector("#invert-y"),this.alwaysFreeLook=document.querySelector("#always-free-look"),this.freeLookKey=document.querySelector("#free-look-key"),this.freeLookKeyContent=document.querySelector("#free-look-key-content"),this.chooseMarbleTexture=document.querySelector("#graphics-marble-texture-choose"),this.resetMarbleTexture=document.querySelector("#graphics-marble-texture-reset"),this.buttonRestartLevel=document.querySelector("#button-restart-level"),this.buttonRestartLevelContent=document.querySelector("#button-restart-level-content"),this.reflectiveMarbleCheckbox=document.querySelector("#graphics-reflective-marble")}show(){super.show(),this.updateAllElements()}async init(){super.init(),this.setupTab(this.tabGraphics,"graphics"),this.setupTab(this.tabAudio,"audio"),this.setupTab(this.tabControls,"controls"),this.selectControlsTab("marble"),this.selectTab("graphics"),await ne.loadImages(["cntrl_marb_bse.png","cntrl_cam_bse.png","cntrl_mous_base.png"].map(e=>"./assets/ui/options/"+e)),await this.updateAllElements()}async updateAllElements(){this.selectResolutionButton([this.resolution640,this.resolution800,this.resolution1024][Y.data.settings.resolution],Y.data.settings.resolution),this.selectVideoDriverButton([this.openGl,this.direct3D][Y.data.settings.videoDriver],Y.data.settings.videoDriver),this.selectScreenStyleButton([this.windowedButton,this.fullButton][Y.data.settings.screenStyle],Y.data.settings.videoDriver),this.selectColorDepthButton([this.depth16,this.depth32][Y.data.settings.colorDepth],Y.data.settings.colorDepth),this.musicVolumeKnob.style.left=Math.floor(this.musicVolumeKnobLeft+Y.data.settings.musicVolume*this.trackLength)+"px",this.soundVolumeKnob.style.left=Math.floor(this.soundVolumeKnobLeft+Y.data.settings.soundVolume*this.trackLength)+"px",this.mouseSensitivityKnob.style.left=Math.floor(this.mouseSensitivityKnobLeft+Y.data.settings.mouseSensitivity*this.trackLength)+"px",this.refreshKeybindings(),!!(2&Y.data.settings.invertMouse)!==this.invertY.hasAttribute("data-locked")&&this.invertY.click(),Y.data.settings.alwaysFreeLook!==this.alwaysFreeLook.hasAttribute("data-locked")&&this.alwaysFreeLook.click(),2===Y.data.settings.marbleReflectivity!==this.reflectiveMarbleCheckbox.hasAttribute("data-locked")&&this.reflectiveMarbleCheckbox.click(),this.setResetMarbleTextureState(!(0===await Y.databaseCount("keyvalue","marbleTexture")))}selectTab(e){for(let e of[this.tabGraphics,this.tabAudio,this.tabControls])e.style.zIndex="-1";for(let e of[this.graphicsDiv,this.audioDiv,this.controlsDiv])e.classList.add("hidden");let t=["graphics","audio","controls"].indexOf(e);[this.tabGraphics,this.tabAudio,this.tabControls][t].style.zIndex="0",[this.graphicsDiv,this.audioDiv,this.controlsDiv][t].classList.remove("hidden")}setupTab(e,t){e.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),e.addEventListener("click",e=>0===e.button&&this.selectTab(t))}selectResolutionButton(e,t){this.unlockResolutionButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),Y.data.settings.resolution=t,Y.store()}unlockResolutionButtons(){this.resolution640.src="./assets/ui/options/graf640_n.png",this.resolution640.removeAttribute("data-locked"),this.resolution800.src="./assets/ui/options/graf800_n.png",this.resolution800.removeAttribute("data-locked"),this.resolution1024.src="./assets/ui/options/graf1024_n.png",this.resolution1024.removeAttribute("data-locked")}selectVideoDriverButton(e,t){this.unlockVideoDriverButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),Y.data.settings.videoDriver=t,Y.store()}unlockVideoDriverButtons(){this.openGl.src="./assets/ui/options/grafopgl_n.png",this.openGl.removeAttribute("data-locked"),this.direct3D.src="./assets/ui/options/grafdir3d_n.png",this.direct3D.removeAttribute("data-locked")}selectScreenStyleButton(e,t){this.unlockScreenStyleButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),Y.data.settings.screenStyle=t,Y.store()}unlockScreenStyleButtons(){this.windowedButton.src="./assets/ui/options/grafwindo_n.png",this.windowedButton.removeAttribute("data-locked"),this.fullButton.src="./assets/ui/options/grafful_n.png",this.fullButton.removeAttribute("data-locked")}selectColorDepthButton(e,t){this.unlockColorDepthButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),Y.data.settings.colorDepth=t,Y.store()}unlockColorDepthButtons(){this.depth16.src="./assets/ui/options/graf16bt_n.png",this.depth16.removeAttribute("data-locked"),this.depth32.src="./assets/ui/options/graf32bt_n.png",this.depth32.removeAttribute("data-locked")}async updateSliders(){if(requestAnimationFrame(()=>this.updateSliders()),!this.div.classList.contains("hidden")){if(this.draggingMusicVolume){let e=this.div.getBoundingClientRect().left*de+this.musicVolumeKnobLeft,t=I.clamp((ve.x-12-e)/this.trackLength,0,1);this.musicVolumeKnob.style.left=Math.floor(this.musicVolumeKnobLeft+t*this.trackLength)+"px",Y.data.settings.musicVolume=t,ft.updateVolumes()}if(this.draggingSoundVolume){let e=this.div.getBoundingClientRect().left*de+this.soundVolumeKnobLeft,t=I.clamp((ve.x-12-e)/this.trackLength,0,1);this.soundVolumeKnob.style.left=Math.floor(this.soundVolumeKnobLeft+t*this.trackLength)+"px",Y.data.settings.soundVolume=t,ft.updateVolumes(),this.soundTestingSound||(this.soundTestingSound=ft.createAudioSource("testing.wav"),this.soundTestingSound.setLoop(!0),this.soundTestingSound.play())}if(this.draggingMouseSensitivity){let e=this.div.getBoundingClientRect().left*de+this.mouseSensitivityKnobLeft,t=I.clamp((ve.x-12-e)/this.trackLength,0,1);this.mouseSensitivityKnob.style.left=Math.floor(this.mouseSensitivityKnobLeft+t*this.trackLength)+"px",Y.data.settings.mouseSensitivity=t}}}selectControlsTab(e){for(let e of[this.marbleControlsDiv,this.cameraControlsDiv,this.mouseControlsDiv])e.classList.add("hidden");let t=["marble","camera","mouse"].indexOf(e);[this.marbleControlsDiv,this.cameraControlsDiv,this.mouseControlsDiv][t].classList.remove("hidden"),this.controlsBackground.src="./assets/ui/options/"+["cntrl_marb_bse.png","cntrl_cam_bse.png","cntrl_mous_base.png"][t],"mouse"===e?(this.controlsBackground.style.left="2px",this.controlsBackground.style.top="-1px"):(this.controlsBackground.style.left="",this.controlsBackground.style.top="")}refreshKeybindings(){this.buttonMarbleLeftContent.textContent=this.formatKeybinding("left"),this.buttonMarbleRightContent.textContent=this.formatKeybinding("right"),this.buttonMarbleUpContent.textContent=this.formatKeybinding("up"),this.buttonMarbleDownContent.textContent=this.formatKeybinding("down"),this.buttonMarbleUseContent.textContent=this.formatKeybinding("use"),this.buttonMarbleJumpContent.textContent=this.formatKeybinding("jump"),this.buttonCameraLeftContent.textContent=this.formatKeybinding("cameraLeft"),this.buttonCameraRightContent.textContent=this.formatKeybinding("cameraRight"),this.buttonCameraUpContent.textContent=this.formatKeybinding("cameraUp"),this.buttonCameraDownContent.textContent=this.formatKeybinding("cameraDown"),this.freeLookKeyContent.textContent=this.formatKeybinding("freeLook"),this.buttonRestartLevelContent.textContent=this.formatKeybinding("restart")}setResetMarbleTextureState(e){e?(this.resetMarbleTexture.style.pointerEvents="",this.resetMarbleTexture.style.filter="",document.querySelector("#graphics-marble-texture-reset-text").style.opacity=""):(this.resetMarbleTexture.style.pointerEvents="none",this.resetMarbleTexture.style.filter="saturate(0)",this.resetMarbleTexture.src="./assets/ui/options/cntr_cam_dwn_n.png",document.querySelector("#graphics-marble-texture-reset-text").style.opacity="0.7")}}class ka{constructor(t){this.initProperties(),t.setupButton(this.homeButton,this.homeButtonSrc,()=>{this.hide(),t.home.show()},void 0,void 0,"gold"===e.modification)}async init(){}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}}const Aa={startPad:[{dtsPath:"shapes/pads/startarea.dts",distance:6}],endPad:[{dtsPath:"shapes/pads/endarea.dts",distance:6}],gems:[{dtsPath:"shapes/items/gem.dts",distance:1.6,translation:new i(.15,.1,.05),matNamesOverride:{"base.gem":"purple.gem"}},{dtsPath:"shapes/items/gem.dts",distance:1.6,translation:new i(-.2,0,-.2)},{dtsPath:"shapes/items/gem.dts",distance:1.6,translation:new i(.15,0,-.55),matNamesOverride:{"base.gem":"green.gem"}}],superSpeed:[{dtsPath:"shapes/items/superspeed.dts",distance:2.5}],superJump:[{dtsPath:"shapes/items/superjump.dts",distance:2.5,translation:new i(0,0,-.5)}],shockAbsorber:[{dtsPath:"shapes/items/shockabsorber.dts",distance:2.5}],superBounce:[{dtsPath:"shapes/items/superbounce.dts",distance:2.5}],gyrocopter:[{dtsPath:"shapes/images/helicopter.dts",distance:2.5,translation:new i(0,0,-.4)}],timeTravel:[{dtsPath:"shapes/items/timetravel.dts",distance:2.5}],gravityModifier:[{dtsPath:"shapes/items/antigravity.dts",distance:2.5}],ductFan:[{dtsPath:"shapes/hazards/ductfan.dts",distance:3.2}],tornado:[{dtsPath:"shapes/hazards/tornado.dts",distance:10,translation:new i(0,0,-6)}],trapDoor:[{dtsPath:"shapes/hazards/trapdoor.dts",distance:5,translation:new i(0,0,.8)}],bumper:[{dtsPath:"shapes/bumpers/pball_round.dts",distance:1.3,translation:new i(0,0,-.15)}],mine:[{dtsPath:"shapes/hazards/landmine.dts",distance:1.3,translation:new i(0,0,-.1)}],oilslick:[{dtsPath:"shapes/hazards/oilslick.dts",distance:7}]};class _a extends ka{constructor(e){super(e),this.pages=[...document.querySelectorAll(".help-page")],this.helpCanvas=document.createElement("canvas"),this.helpRenderer=new oe({canvas:this.helpCanvas,alpha:!0,desynchronized:!1}),this.helpCamera=new Li(40,1),this.scenes=new Map,this.shapes=new Map,e.setupButton(this.prevButton,"play/prev",()=>this.cyclePage(-1)),e.setupButton(this.nextButton,"play/next",()=>this.cyclePage(1)),this.showHelpPage(0),requestAnimationFrame(()=>this.update()),this.helpRenderer.setSize(80,80);let i=(new t).setFromRotationMatrix((new h).makeRotationX(1.1));this.helpCamera.orientation.premultiply(i),window.addEventListener("keydown",e=>{this.div.classList.contains("hidden")||"Escape"===e.code&&(this.homeButton.src="./assets/ui/play/back_d.png")}),window.addEventListener("keyup",e=>{this.div.classList.contains("hidden")||"Escape"===e.code&&this.homeButton.click()})}initProperties(){this.div=document.querySelector("#help"),this.homeButton=document.querySelector("#help-back"),this.homeButtonSrc="play/back",this.prevButton=document.querySelector("#help-prev"),this.nextButton=document.querySelector("#help-next")}show(){super.show(),this.initHelpScenes(),this.showHelpPage(0)}cyclePage(e){let t=this.pages.indexOf(this.currentPage);t=I.adjustedMod(t+e,this.pages.length),this.showHelpPage(t)}showHelpPage(e){for(let e of this.pages)e.classList.add("hidden");this.pages[e].classList.remove("hidden"),this.currentPage=this.pages[e];let t=this.currentPage.querySelector(".help-paragraph");if(t)for(let e of t.children){let t=e.getAttribute("data-button");if(t){let i=I.getKeyForButtonCode(Y.data.settings.gameButtonMapping[t]);e.textContent=i}}}async update(){if(requestAnimationFrame(this.update.bind(this)),this.div.classList.contains("hidden"))return;let e=performance.now(),t=this.currentPage.querySelectorAll(".help-canvas-row");for(let i of t){let t=i.children[0],s=t.getAttribute("data-scene"),n=this.scenes.get(s);if(!(null===n||void 0===n?void 0:n.compiled))continue;let r=this.shapes.get(s);for(let t of r){let i=new Ui(0,0,e/3e3*Math.PI);t.group.orientation.setFromEuler(i),t.group.recomputeTransform()}this.helpCamera.updateMatrixWorld(),n.prepareForRender(this.helpCamera),this.helpRenderer.render(n,this.helpCamera);let a=t.getContext("2d");a.clearRect(0,0,80,80),a.drawImage(this.helpCanvas,0,0)}}async initHelpScenes(){if(this.scenes.size>0)return;let e={timeSinceLoad:0,currentAttemptTime:0,gameplayClock:0,physicsTickCompletion:0,tickIndex:0};for(let e in Aa){let t=new Tn(this.helpRenderer),i=Aa[e],s=[];for(let e of i){let t=new bi;t.dtsPath=e.dtsPath,e.matNamesOverride&&(t.matNamesOverride=e.matNamesOverride),s.push(t)}this.scenes.set(e,t),this.shapes.set(e,s)}let s=[];for(let[,e]of this.shapes)for(let t of e)s.push(t.init());await Promise.all(s);let n=new i(0,0,-1);n.applyQuaternion(this.helpCamera.orientation);for(let[s,r]of this.scenes){let a=this.shapes.get(s);for(let o=0;o<a.length;o++){let l=a[o],h=Aa[s][o],d=n.clone().multiplyScalar(h.distance);h.translation&&d.add(h.translation),l.setTransform(d,new t,new i(1,1,1)),l.render(e),r.add(l.group)}let o=new Mn((new i).setScalar(1));r.addAmbientLight(o),r.compile()}}}class Ia extends gn{constructor(){super(...arguments),this.gemCountMinDigits=2,this.showClockBackground=!1,this.supportNumberColors=!1,this.supportFpsMeter=!1}}class Ea extends tn{initProperties(){this.div=document.querySelector("#pause-screen"),this.yesButton=document.querySelector("#pause-yes"),this.noButton=document.querySelector("#pause-no"),this.restartButton=document.querySelector("#pause-restart"),this.replayButton=document.querySelector("#pause-replay"),this.yesSrc="common/yes",this.noSrc="common/no",this.restartSrc="common/restart"}constructor(e){super(e),this.replayButton.addEventListener("click",async e=>{0===e.button&&this.onReplayButtonClick(e.altKey)}),I.onLongTouch(this.replayButton,()=>this.onReplayButtonClick(!0))}}class Ba{constructor(t){this.initProperties(),t.setupButton(this.replayButton,"endgame/replay",()=>{this.div.classList.add("hidden"),e.level.restart(!0),I.isTouchDevice||I.requestPointerLock()}),t.setupButton(this.continueButton,"endgame/continue",()=>e.level.stopAndExit()),t.setupButton(this.nameEntryButton,this.nameEntryButtonSrc,async()=>{let t=this.nameEntryInput.value.trim().slice(0,16);if(t.length<2)return void e.menu.showAlertPopup("Warning","Please enter a proper name for usage in the online leaderboard.");if(I.isNaughty(t))return void e.menu.showAlertPopup("Warning","The name you chose contains words deemed inappropriate. Please do the right thing and choose a non-offensive name.");Y.data.lastUsedName=t,Y.store();let i=e.level,s=Y.insertNewTime(i.mission.path,t,i.finishTime.gameplayClock);if(this.nameEntryScreenDiv.classList.add("hidden"),this.div.style.pointerEvents="",this.drawBestTimes(),s&&"record"===i.replay.mode&&!i.replay.isInvalid){i.replay.canStore=!1;let e=await i.replay.serialize();await Y.databasePut("replays",e,s.score[2])}i.finishTime.gameplayClock<=i.mission.qualifyTime&&yt.submitScore(i.mission.path,s.score)},void 0,void 0,"gold"===e.modification),window.addEventListener("keydown",i=>{e.level&&e.menu===t&&"Enter"===i.key&&(this.nameEntryScreenDiv.classList.contains("hidden")?this.div.classList.contains("hidden")||(this.continueButton.src=t.uiAssetPath+"endgame/continue_d.png"):this.nameEntryButton.src=t.uiAssetPath+this.nameEntryButtonSrc+"_d.png")}),window.addEventListener("keyup",i=>{e.level&&e.menu===t&&"Enter"===i.key&&(this.nameEntryScreenDiv.classList.contains("hidden")?this.div.classList.contains("hidden")||this.continueButton.click():this.nameEntryButton.click())})}get showing(){return!this.div.classList.contains("hidden")}async init(){for(let e=0;e<this.bestTimeCount;e++){let e=this.createBestTimeElement();this.bestTimeContainer.appendChild(e)}}show(){let t=e.level;this.div.classList.remove("hidden");let i=Math.max(t.finishTime.currentAttemptTime-na,0),s=I.roundToMultiple(Math.max(0,i-t.finishTime.gameplayClock),1e-8),n=!1;t.finishTime.gameplayClock>t.mission.qualifyTime?(this.showMessage("failed"),n=!0):t.finishTime.gameplayClock<=t.mission.ultimateTime?this.showMessage("ultimate"):t.finishTime.gameplayClock<=t.mission.goldTime?this.showMessage("gold"):this.showMessage("qualified"),this.updateTimeElements(i,s,n),this.drawBestTimes();let r=Y.getBestTimesForMission(t.mission.path,this.bestTimeCount,this.scorePlaceholderName).filter(e=>e[1]<=t.finishTime.gameplayClock).length;if(r<this.bestTimeCount&&(!n||this.storeNotQualified)?(this.nameEntryScreenDiv.classList.remove("hidden"),this.nameEntryText.textContent=this.generateNameEntryText(r),this.nameEntryInput.value=Y.data.lastUsedName,this.div.style.pointerEvents="none"):(this.nameEntryScreenDiv.classList.add("hidden"),this.div.style.pointerEvents=""),!n&&"custom"!==t.mission.type){let i=e.menu.levelSelect;i.currentMission===t.mission&&i.cycleMission(1)}this.viewReplayButton.style.display=t.replay.isInvalid?"none":""}hide(){this.div.classList.add("hidden")}drawBestTimes(){let t=Y.getBestTimesForMission(e.level.mission.path,this.bestTimeCount,this.scorePlaceholderName);for(let e=0;e<this.bestTimeCount;e++)this.updateBestTimeElement(this.bestTimeContainer.children[e],t[e],e+1)}async onViewReplayButtonClick(t){let i=e.level;if(t){let t=await i.replay.serialize();ua.download(t,i.mission,!1),I.isTouchDevice&&I.isInFullscreen()&&e.menu.showAlertPopup("Downloaded","The .wrec has been downloaded.")}else{if(!await e.menu.showConfirmPopup("Confirm",`Do you want to start the replay for the last playthrough? This can be done only once if this isn't one of your top ${this.bestTimeCount} local scores.`))return;i.replay.mode="playback",this.replayButton.click()}}handleGamepadInput(){if(this.nameEntryScreenDiv.classList.contains("hidden")){if(!this.div.classList.contains("hidden")){if(Me("use")&&ke("use")&&(Ae("use"),this.viewReplayButton.click(),ft.play("buttonpress.wav")),Me("jump")&&ke("jump"))return Ae("jump"),this.continueButton.click(),void ft.play("buttonpress.wav");Me("restart")&&ke("restart")&&(Ae("restart"),this.replayButton.click(),ft.play("buttonpress.wav"))}}else Me("jump")&&ke("jump")&&(Ae("jump"),this.nameEntryButton.click(),ft.play("buttonpress.wav"))}}class Pa extends Ba{constructor(e){super(e),this.viewReplayButton=document.querySelector("#finish-view-replay"),this.bestTimeCount=3,this.scorePlaceholderName="Nardo Polo",this.storeNotQualified=!1,this.viewReplayButton.addEventListener("click",async e=>{0===e.button&&this.onViewReplayButtonClick(e.altKey)}),I.onLongTouch(this.viewReplayButton,()=>this.onViewReplayButtonClick(!0)),this.viewReplayButton.addEventListener("mouseenter",()=>ft.play("buttonover.wav")),this.viewReplayButton.addEventListener("mousedown",()=>ft.play("buttonpress.wav"))}initProperties(){this.div=document.querySelector("#finish-screen"),this.time=document.querySelector("#finish-screen-time-time"),this.message=document.querySelector("#finish-message"),this.qualifyTimeElement=document.querySelector("#finish-qualify-time"),this.goldTimeElement=document.querySelector("#finish-gold-time"),this.elapsedTimeElement=document.querySelector("#finish-elapsed-time"),this.bonusTimeElement=document.querySelector("#finish-bonus-time"),this.replayButton=document.querySelector("#finish-replay"),this.continueButton=document.querySelector("#finish-continue"),this.bestTimeContainer=document.querySelector("#finish-best-times"),this.nameEntryScreenDiv=document.querySelector("#name-entry-screen"),this.nameEntryText=document.querySelector("#name-entry-screen > p:nth-child(3)"),this.nameEntryInput=document.querySelector("#name-entry-input"),this.nameEntryButton=this.nameEntryScreenDiv.querySelector("#name-entry-confirm"),this.nameEntryButtonSrc="common/ok"}showMessage(e){this.message.style.color="","ultimate"===e?this.message.innerHTML='You beat the <span style="color: #fff700;">ULTIMATE</span> time!':"gold"===e?this.message.innerHTML='You beat the <span style="color: #fff700;">GOLD</span> time!':"qualified"===e?this.message.innerHTML="You've qualified!":"failed"===e&&(this.message.innerHTML="You failed to qualify!",this.message.style.color="red")}updateTimeElements(t,i,s){let n=e.level;this.time.textContent=I.secondsToTimeString(n.finishTime.gameplayClock/1e3),this.qualifyTimeElement.textContent=isFinite(n.mission.qualifyTime)?I.secondsToTimeString(n.mission.qualifyTime/1e3):I.secondsToTimeString(5999.999),this.qualifyTimeElement.style.color=s?"red":"",this.qualifyTimeElement.style.textShadow=s?"1px 1px 0px black":"",I.monospaceNumbers(this.qualifyTimeElement);let r=n.mission.goldTime;this.goldTimeElement.textContent=I.secondsToTimeString(r/1e3),this.goldTimeElement.parentElement.style.display=r!==-1/0?"":"none",I.monospaceNumbers(this.goldTimeElement),this.elapsedTimeElement.textContent=I.secondsToTimeString(t/1e3),this.bonusTimeElement.textContent=I.secondsToTimeString(i/1e3),I.monospaceNumbers(this.elapsedTimeElement),I.monospaceNumbers(this.bonusTimeElement)}createBestTimeElement(){let e=document.createElement("div");return e.innerHTML="<p></p><p></p>",e.classList.add("finish-row"),e}updateBestTimeElement(t,i,s){let n=e.level.mission.goldTime;t.children[0].textContent=s+". "+i[0],t.children[1].textContent=I.secondsToTimeString(i[1]/1e3),I.monospaceNumbers(t.children[1]),t.children[1].style.color=i[1]<=n?"#fff700":"",t.children[1].style.textShadow=i[1]<=n?"1px 1px 0px black":""}generateNameEntryText(e){return`You got the ${["best","2nd best","3rd best"][e]} time!`}}const La="rgb(255, 204, 0)",Ra="rgb(204, 204, 204)",Fa="rgb(255, 221, 34)";class za extends Ba{constructor(t){super(t),this.viewReplayButton=document.querySelector("#mbp-finish-view-replay"),this.timeRows=document.querySelector("#mbp-finish-time-rows"),this.nextLevelImage=document.querySelector("#mbp-finish-next-level-image"),this.nextLevelButton=document.querySelector("#mbp-finish-next-level"),this.bestTimeCount=5,this.scorePlaceholderName="Matan W.",this.storeNotQualified=!0,t.setupButton(this.viewReplayButton,"play/replay",e=>this.onViewReplayButtonClick(e.altKey)),I.onLongTouch(this.viewReplayButton,()=>this.onViewReplayButtonClick(!0)),this.qualifyTimeElement=this.createTimeRow("Par Time").children[0],this.goldTimeElement=this.createTimeRow("Gold Time").children[0],this.platinumTimeElement=this.createTimeRow("Platinum Time").children[0],this.ultimateTimeElement=this.createTimeRow("Ultimate Time").children[0],this.elapsedTimeElement=this.createTimeRow("Time Passed").children[0],this.bonusTimeElement=this.createTimeRow("Clock Bonuses").children[0],this.goldTimeElement.parentElement.style.color="rgb(255, 204, 0)",this.platinumTimeElement.parentElement.style.color="rgb(204, 204, 204)",this.ultimateTimeElement.parentElement.style.color="rgb(255, 221, 34)",this.elapsedTimeElement.parentElement.style.marginTop="20px",t.setupButton(this.nextLevelButton,"endgame/level_window",()=>{let t=this.getNextLevel(),i=e.menu.levelSelect;this.continueButton.click(),i.setMissionArray(t.array),i.currentMissionIndex=t.index,i.playCurrentMission()},void 0,void 0,!1)}initProperties(){this.div=document.querySelector("#mbp-finish-screen"),this.time=document.querySelector("#mbp-finish-screen-time-time"),this.message=document.querySelector("#mbp-finish-message"),this.replayButton=document.querySelector("#mbp-finish-replay"),this.continueButton=document.querySelector("#mbp-finish-continue"),this.bestTimeContainer=document.querySelector("#mbp-finish-screen-top-times"),this.nameEntryScreenDiv=document.querySelector("#mbp-name-entry-screen"),this.nameEntryText=document.querySelector("#mbp-name-entry-screen > p:nth-child(3)"),this.nameEntryInput=document.querySelector("#mbp-name-entry-input"),this.nameEntryButton=this.nameEntryScreenDiv.querySelector("#mbp-name-entry-confirm"),this.nameEntryButtonSrc="endgame/ok"}createTimeRow(e){let t=document.createElement("p");return t.innerHTML=e+":<span></span>",this.timeRows.appendChild(t),t}show(){super.show();let t=this.getNextLevel(),i=[...t.array].sort(e.menu.levelSelect.currentSortFn)[t.index];this.nextLevelImage.src=i.getImagePath()}showMessage(t){this.message.style.color="","ultimate"===t?this.message.innerHTML=`You beat the <span style="color: ${Fa};">Ultimate</span> Time!`:"gold"===t?"gold"===e.level.mission.modification?this.message.innerHTML=`You beat the <span style="color: ${La};">Gold</span> Time!`:this.message.innerHTML=`You beat the <span style="color: ${Ra};">Platinum</span> Time!`:"qualified"===t?this.message.innerHTML="You beat the Par Time!":(this.message.innerHTML="You didn't pass the Par Time!",this.message.style.color="rgb(245, 85, 85)")}updateTimeElements(t,i){let s=e.level;this.time.textContent=I.secondsToTimeString(s.finishTime.gameplayClock/1e3),this.qualifyTimeElement.textContent=isFinite(s.mission.qualifyTime)?I.secondsToTimeString(s.mission.qualifyTime/1e3):I.secondsToTimeString(5999.999),I.monospaceNumbers(this.qualifyTimeElement);let n=s.mission.goldTime;this.goldTimeElement.parentElement.style.display="none",this.platinumTimeElement.parentElement.style.display="none",n!==-1/0&&("gold"===s.mission.modification?(this.goldTimeElement.textContent=I.secondsToTimeString(n/1e3),this.goldTimeElement.parentElement.style.display="",I.monospaceNumbers(this.goldTimeElement)):(this.platinumTimeElement.textContent=I.secondsToTimeString(n/1e3),this.platinumTimeElement.parentElement.style.display="",I.monospaceNumbers(this.platinumTimeElement)));let r=s.mission.ultimateTime;this.ultimateTimeElement.parentElement.style.display="none",r!==-1/0&&(this.ultimateTimeElement.textContent=I.secondsToTimeString(r/1e3),this.ultimateTimeElement.parentElement.style.display="",I.monospaceNumbers(this.ultimateTimeElement)),this.elapsedTimeElement.textContent=I.secondsToTimeString(t/1e3),this.bonusTimeElement.textContent=I.secondsToTimeString(i/1e3),I.monospaceNumbers(this.elapsedTimeElement),I.monospaceNumbers(this.bonusTimeElement)}createBestTimeElement(){return document.createElement("div")}updateBestTimeElement(t,i,s){let n=e.level.mission.goldTime,r=e.level.mission.ultimateTime,a=document.createElement("div");a.textContent=I.secondsToTimeString(i[1]/1e3),I.monospaceNumbers(a),t.innerHTML=`<div><span>${s}. </span>${I.htmlEscape(i[0])}</div><div>${a.innerHTML}</div>`,t.style.color="",i[1]<=n&&(t.style.color="gold"===e.level.mission.modification?La:Ra),i[1]<=r&&(t.style.color=Fa)}generateNameEntryText(e){return`You have the ${["top","second top","third top","fourth top","fifth top"][e]} time!`}getNextLevel(){let t=e.menu.levelSelect,i=t.sortedMissionArray.indexOf(e.level.mission);return i<t.currentMissionArray.length-1?{index:i+1,array:t.currentMissionArray}:"custom"===t.currentMission.type?{index:i,array:t.currentMissionArray}:{index:0,array:Ot.allCategories[Ot.allCategories.indexOf(t.currentMissionArray)+1]}}}class Da extends ba{constructor(){super(...arguments),this.loadReplayButton=document.querySelector("#mbp-load-replay-button"),this.shuffleButton=document.querySelector("#mbp-shuffle-button"),this.viewToggleButton=document.querySelector("#mbp-level-select-view-toggle"),this.metadataContainer=document.querySelector("#mbp-level-metadata"),this.scoresContainer=document.querySelector("#mbp-level-scores"),this.easterEggIcon=document.querySelector("#mbp-level-select-egg"),this.difficultySelectorCollapsed=document.querySelector("#mbp-difficulty-selector-collapsed"),this.difficultySelectorModificationIcon=document.querySelector("#mbp-difficulty-selector-modification-icon"),this.difficultySelectorWindow=document.querySelector("#mbp-difficulty-selector-window"),this.difficultySelectorContent=document.querySelector("#mbp-difficulty-selector-window > ._content"),this.localScoresCount=5,this.scorePlaceholderName="Matan W.",this.scoreElementHeight=16}initProperties(){this.div=document.querySelector("#mbp-level-select"),this.homeButton=document.querySelector("#mbp-level-select-home-button"),this.homeButtonSrc="play/menu",this.prevButton=document.querySelector("#mbp-level-select-prev"),this.playButton=document.querySelector("#mbp-level-select-play"),this.nextButton=document.querySelector("#mbp-level-select-next"),this.levelImage=document.querySelector("#mbp-level-image"),this.levelTitle=document.querySelector("#mbp-level-title"),this.levelArtist=document.querySelector("#mbp-level-artist"),this.levelDescription=document.querySelector("#mbp-level-description"),this.levelQualifyTime=document.querySelector("#mbp-level-qualify-time"),this.localBestTimesContainer=document.querySelector("#mbp-level-select-local-best-times"),this.leaderboardLoading=document.querySelector("#mbp-online-leaderboard-loading"),this.leaderboardScores=document.querySelector("#mbp-leaderboard-scores"),this.scrollWindow=document.querySelector("#mbp-level-select-text-window"),this.searchInput=document.querySelector("#mbp-search-input"),this.sortToggleButton=document.querySelector("#mbp-sort-icon")}async init(){await super.init(),this.menu.setupVaryingButton(this.difficultySelectorCollapsed,["play/difficulty_beginner","play/difficulty_intermediate","play/difficulty_advanced","play/difficulty_expert","play/difficulty_custom"],()=>{this.difficultySelectorWindow.classList.contains("hidden")?this.difficultySelectorWindow.classList.remove("hidden"):this.difficultySelectorWindow.classList.add("hidden")},void 0,void 0,!1),this.createDifficultySection("Gold","./assets/ui_mbp/play/marble_gold.png",[{name:"Beginner",arr:Ot.goldBeginner},{name:"Intermediate",arr:Ot.goldIntermediate},{name:"Advanced",arr:Ot.goldAdvanced},{name:"Custom",arr:Ot.goldCustom}]),this.createDifficultySection("Platinum","./assets/ui_mbp/play/marble_platinum.png",[{name:"Beginner",arr:Ot.platinumBeginner},{name:"Intermediate",arr:Ot.platinumIntermediate},{name:"Advanced",arr:Ot.platinumAdvanced},{name:"Expert",arr:Ot.platinumExpert},{name:"Custom",arr:Ot.platinumCustom}]),this.createDifficultySection("Ultra","./assets/ui_mbp/play/marble_ultra.png",[{name:"Beginner",arr:Ot.ultraBeginner},{name:"Intermediate",arr:Ot.ultraIntermediate},{name:"Advanced",arr:Ot.ultraAdvanced},{name:"Custom",arr:Ot.ultraCustom}]),this.difficultySelectorWindow.querySelector("._click-preventer").addEventListener("mousedown",()=>{ft.play("buttonpress.wav")}),this.difficultySelectorWindow.querySelector("._click-preventer").addEventListener("click",()=>{this.difficultySelectorWindow.classList.add("hidden")}),this.menu.setupVaryingButton(this.viewToggleButton,["mp/play/scoresactive","mp/play/settingsactive"],()=>{this.scoresContainer.classList.contains("hidden")?(this.metadataContainer.classList.add("hidden"),this.scoresContainer.classList.remove("hidden"),this.levelQualifyTime.classList.add("hidden"),this.scrollWindow.style.height="",this.menu.setButtonVariant(this.viewToggleButton,1),this.viewToggleButton.title="Show level information"):(this.metadataContainer.classList.remove("hidden"),this.scoresContainer.classList.add("hidden"),this.levelQualifyTime.classList.remove("hidden"),this.scrollWindow.style.height="150px",this.menu.setButtonVariant(this.viewToggleButton,0),this.viewToggleButton.title="Show scores")},void 0,void 0,!1),this.menu.setupButton(this.loadReplayButton,"play/replay",e=>{this.showLoadReplayPrompt(e)},void 0,void 0,!1),this.menu.setupButton(this.shuffleButton,"search/random",()=>{this.shuffle()},void 0,void 0,!1);for(let e of Ot.allCategories)this.setMissionArray(e,!1);this.setMissionArray(I.randomFromArray([Ot.goldBeginner,Ot.platinumBeginner,Ot.ultraBeginner]),!1),await ne.loadImages(["play/eggnotfound.png","play/eggfound.png","play/marble_gold.png","play/marble_platinum.png","play/marble_ultra.png","mp/menu/brown/joined.png","mp/menu/brown/divider-orange-joined.png","options/textentry.png"].map(e=>"./assets/ui_mbp/"+e))}createDifficultySection(e,t,i){let s=document.createElement("div"),n=document.createElement("p"),r=document.createElement("img");s.classList.add("_section"),s.append(n,r),n.textContent=e,r.src=t;for(let e of i){let t=document.createElement("div"),i=document.createElement("p"),n=document.createElement("img");t.append(i,n),s.append(t),i.textContent=e.name,this.menu.setupButton(n,"play/difficulty_highlight-120",()=>{this.setMissionArray(e.arr),this.difficultySelectorWindow.classList.add("hidden")}),e.arr||(t.style.opacity="0.333",t.style.pointerEvents="none")}this.difficultySelectorContent.append(s)}setMissionArray(e,t){super.setMissionArray(e,t),e.length>0&&(this.menu.setButtonVariant(this.difficultySelectorCollapsed,["beginner","intermediate","advanced","expert","custom"].indexOf(Ot.getDifficulty(e))),this.difficultySelectorModificationIcon.src="./assets/ui_mbp/play/"+("gold"===Ot.getModification(e)?"marble_gold.png":"ultra"===Ot.getModification(e)?"marble_ultra.png":"marble_platinum.png")),this.updateBackground()}displayMetadata(){let e=this.currentMission;this.levelTitle.textContent=`#${this.currentMissionIndex+1}: ${e.title}`,this.levelArtist.textContent="Author: "+e.artist.trim(),this.levelDescription.textContent=e.description;let t=0!==e.qualifyTime?e.qualifyTime:1/0;this.levelQualifyTime.innerHTML=`<span style="opacity: 0.8;">${"gold"===e.modification?"Qualify":"Par"} Time: </span>`+(isFinite(t)?I.secondsToTimeString(t/1e3):"N/A"),e.hasEasterEgg?(this.easterEggIcon.classList.remove("hidden"),this.easterEggIcon.src=Y.data.collectedEggs.includes(e.path)?"./assets/ui_mbp/play/eggfound.png":"./assets/ui_mbp/play/eggnotfound.png"):this.easterEggIcon.classList.add("hidden")}displayEmptyMetadata(){this.levelTitle.innerHTML="<br>",this.levelArtist.innerHTML="<br>",this.levelDescription.innerHTML="<br>",this.levelQualifyTime.innerHTML="",this.easterEggIcon.classList.add("hidden")}createScoreElement(e){let t=document.createElement("div");t.classList.add("mbp-level-select-best-time");let i=document.createElement("div");t.appendChild(i);let s=document.createElement("div");return t.appendChild(s),t.appendChild(this.createReplayButton(e)),t}getReplayButtonForScoreElement(e){return e.children[2]}updateScoreElement(e,t,i){e.children[0].innerHTML=`<span>${i}.</span> ${I.htmlEscape(t[0])}`,e.children[1].textContent=I.secondsToTimeString(t[1]/1e3),I.monospaceNumbers(e.children[1]),e.style.color="",this.currentMission&&(t[1]<=this.currentMission.goldTime&&(e.style.color="gold"===this.currentMission.modification?La:Ra),t[1]<=this.currentMission.ultimateTime&&(e.style.color=Fa))}show(){super.show(),this.updateBackground()}updateBackground(){let t=this.currentMissionArray;e.menu.backgroundImage.src="gold"===Ot.getModification(t)?e.menu.mbgBg:"ultra"===Ot.getModification(t)?e.menu.mbuBg:e.menu.mbpBg}}class Ua extends wa{constructor(e){super(e),this.onlineButton=document.querySelector("#mbp-home-online")}initProperties(){this.div=document.querySelector("#mbp-home-screen"),this.playButton=document.querySelector("#mbp-home-play"),this.optionsButton=document.querySelector("#mbp-home-options"),this.helpButton=document.querySelector("#mbp-home-help"),this.exitButton=document.querySelector("#mbp-home-quit"),this.showChangelogButton=document.querySelector("#mbp-show-changelog"),this.changelogContainer=document.querySelector("#mbp-changelog"),this.changelogBackButton=document.querySelector("#mbp-changelog-back"),this.changelogContent=document.querySelector("#mbp-changelog-content"),this.version=document.querySelector("#mbp-version"),this.playSrc="menu/play",this.optionsSrc="menu/options",this.helpSrc="menu/help",this.exitSrc="menu/quit",this.showChangelogSrc="menu/changelog",this.changelogBackSrc="motd/ok"}show(){super.show(),e.menu.backgroundImage.src=e.menu.homeBg}}class Va extends Ta{constructor(){super(...arguments),this.maxProgressBarWidth=219}initProperties(){this.div=document.querySelector("#mbp-loading"),this.levelNameElement=document.querySelector("#mbp-loading-level-name"),this.cancelButton=document.querySelector("#mbp-loading-cancel"),this.progressBar=document.querySelector("#mbp-loading-progress")}}const Oa=["webport","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22"],Na=/<.+?>/g,qa=/&lt;a:(.+?)&gt;(.+?)&lt;\/a&gt;/g;class ja extends ka{constructor(){super(...arguments),this.pagePicker=document.querySelector("#mbp-help-picker"),this.pageElements=[]}initProperties(){this.div=document.querySelector("#mbp-help"),this.homeButton=document.querySelector("#mbp-help-home"),this.homeButtonSrc="manual/home"}async init(){let e=[];for(let t of Oa){let i=`./assets/ui_mbp/manual/pages/${t}.txt`;e.push(ne.loadResource(i))}let t=await Promise.all(e),i=await Promise.all(t.map(e=>ne.readBlobAsText(e)));for(let e of i){let t=e.slice(0,e.indexOf("\n")),s=document.createElement("div");s.textContent=t,s.addEventListener("mousedown",()=>this.selectPage(i.indexOf(e))),this.pagePicker.appendChild(s);let n=document.createElement("div");n.classList.add("_page","hidden"),n.innerHTML=this.generatePageHtml(e),this.pageElements.push(n),this.div.appendChild(n)}this.selectPage(0)}selectPage(e){for(let e of this.pagePicker.children)e.classList.remove("selected");this.pagePicker.children[e].classList.add("selected");for(let e of this.pageElements)e.classList.add("hidden");this.pageElements[e].classList.remove("hidden"),this.pageElements[e].scrollTop=0}generatePageHtml(e){let t="",i=[],s="",n=e.slice(0,e.indexOf("\n")),r=document.createElement("h1");for(r.textContent=n,s+=r.outerHTML,e=e.slice(e.indexOf("\n")+1);;){let n;for(Na.lastIndex=0;(n=Na.exec(e))&&!n[0].startsWith("<just")&&!n[0].startsWith("<font")&&"<spush>"!==n[0]&&"<spop>"!==n[0];);let r=document.createElement("div");if(t&&r.setAttribute("style",t),!n){r.textContent=e,r.innerHTML&&(s+=r.outerHTML);break}r.textContent=e.slice(0,n.index),r.innerHTML&&(s+=r.outerHTML),n[0].startsWith("<just")?t+="text-align: "+n[0].slice(6,-1)+";":n[0].startsWith("<font")?t+=`font-family: ${n[0].slice(6,n[0].lastIndexOf(":"))};font-size: ${n[0].slice(n[0].lastIndexOf(":")+1,-1)}px;`:"<spush>"===n[0]?i.push(t):"<spop>"===n[0]&&(t=i.pop()),e=e.slice(n.index+n[0].length)}return s=s.replace(qa,'<a href="http://$1" target="_blank">$2</a>')}}const Ga={gold:12,platinum:28,ultra:9,multi:13};let Wa,Ha;const Xa=document.querySelector("#switching-message"),Ya=async t=>{var i;null===(i=e.menu)||void 0===i||i.hide(),e.menu&&Xa.classList.remove("hidden"),document.querySelector("#favicon").setAttribute("href","gold"===t?"./assets/img/marble-blast-gold-logo.png":"./assets/img/mbp.png"),"gold"===t?Wa?(e.modification="gold",e.menu=Wa,Wa.show()):(Wa=new class extends Sa{constructor(){super(...arguments),this.audioAssetPath="./assets/data/sound/",this.menuMusicSrc="shell.ogg",this.popupBackgroundSrc="./assets/ui/common/dialog.png",this.popupOkaySrc="common/ok",this.popupNoSrc="common/no",this.popupYesSrc="common/yes"}get uiAssetPath(){return"./assets/ui/"}createHome(){return new xa(this)}createLevelSelect(){return new va(this)}createLoadingScreen(){return new Ma(this)}createOptionsScreen(){return new Ca(this)}createHelpScreen(){return new _a(this)}createHud(){return new Ia(this)}createPauseScreen(){return new Ea(this)}createFinishScreen(){return new Pa(this)}getMenuDiv(){return document.querySelector("#menu")}getBackgroundImage(){return document.querySelector("#background-image")}async init(){I.isWeeb&&(this.backgroundImage.src=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`),await super.init()}},e.modification="gold",e.menu=Wa,await Wa.init(),Ha&&Wa.show()):Ha?(e.modification="platinum",e.menu=Ha,Ha.show()):(Ha=new class extends Sa{constructor(){super(...arguments),this.audioAssetPath="./assets/data_mbp/sound/",this.menuMusicSrc="music/pianoforte.ogg",this.popupBackgroundSrc="./assets/ui_mbp/play/text_window.png",this.popupOkaySrc="achiev/close",this.popupNoSrc="exit/no",this.popupYesSrc="exit/yes"}get uiAssetPath(){return"./assets/ui_mbp/"}createHome(){return new Ua(this)}createLevelSelect(){return new Da(this)}createLoadingScreen(){return new Va(this)}createOptionsScreen(){return new un(this)}createHelpScreen(){return new ja(this)}createHud(){return new fn(this)}createPauseScreen(){return new sn(this)}createFinishScreen(){return new za(this)}getMenuDiv(){return document.querySelector("#mbp-menu")}getBackgroundImage(){return document.querySelector("#mbp-background-image")}async init(){let e=I.randomFromArray(Object.keys(Ga)),t=Math.floor(Math.random()*Ga[e])+1,i=Math.floor(Math.random()*Ga.gold)+1,s=Math.floor(Math.random()*Ga.platinum)+1,n=Math.floor(Math.random()*Ga.ultra)+1;this.homeBg="./assets/ui_mbp/backgrounds/"+e+"/"+t+".jpg",this.mbgBg="./assets/ui_mbp/backgrounds/gold/"+i+".jpg",this.mbpBg="./assets/ui_mbp/backgrounds/platinum/"+s+".jpg",this.mbuBg="./assets/ui_mbp/backgrounds/ultra/"+n+".jpg",I.isWeeb&&(this.homeBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`,this.mbgBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`,this.mbpBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`,this.mbuBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`),await ne.loadImages([this.homeBg,this.mbgBg,this.mbpBg,this.mbuBg]),await super.init()}},e.modification="platinum",e.menu=Ha,await Ha.init(),Wa&&Ha.show()),Xa.classList.add("hidden"),Y.data.modification=t,Y.store()},Qa=document.querySelector("#loading-message"),Ka=document.querySelector("#loading-detail"),$a=document.querySelector("#start-game-dialog");window.onload=(async()=>{await I.init(),await Y.init(),await ne.init(),he=new oe({canvas:le,desynchronized:Y.data.settings.canvasDesynchronized}),ue(!1),Ka.textContent="Loading levels...",await Ot.init(),ft.init(),Ka.textContent="Loading UI...";let t=new URLSearchParams(location.search);if(t.has("mbg")?(Y.data.modification="gold",Y.store()):t.has("mbp")&&(Y.data.modification="platinum",Y.store()),await Ya(Y.data.modification),Ka.textContent="Loading leaderboard...",await yt.init(),I.isWeeb&&(document.title="Marble Blast Weeb"),I.isTouchDevice&&!location.search.includes("app")){let t=document.createElement("div");t.id="install-popup";let i=document.createElement("img");i.src="./assets/img/download.png",i.style.display="none",t.append(i),i.addEventListener("click",()=>{so.prompt()});let s=setInterval(()=>{so&&(i.style.display="")},100);e.menu.showAlertPopup("Install as app",'This website can be installed on your device\'s home screen to run in proper fullscreen and feel like a native app. To install it, press the icon below, or if there is none, follow <a href="https://natomasunified.org/kb/add-website-to-mobile-device-home-screen/" target="_blank">these</a> steps.',t).then(()=>{clearInterval(s)})}let i=!1;const s=async()=>{i=!0,$a.style.display="none",ft.context.resume(),e.menu.show(),Za(new URLSearchParams(window.location.search))};Qa.style.display="none",Ka.style.display="none","running"!==ft.context.state||I.isSafari()?(I.isInFullscreen()||I.isTouchDevice?($a.children[0].textContent="Click anywhere to start",$a.children[1].textContent=""):$a.children[0].textContent=`Press ${I.isMac()?"^‚åòF":"F11"} to start in fullscreen mode`,$a.style.display="block",window.addEventListener("mousedown",()=>{i||s()}),window.addEventListener("pointerdown",()=>{i||s()}),window.addEventListener("keydown",e=>{i||"F11"!==e.code||I.isInFullscreen()||s()})):s()});const Za=async t=>{const i=t.get("play-custom");if(null===i)return;if(!Number.isInteger(parseInt(i)))return;const s=parseInt(i);let n=Ot.allMissions.find(e=>e.id===s);void 0!==n&&("gold"===e.modification&&(n.path.startsWith("mbp")||n.path.startsWith("mbu"))&&await Ya("platinum"),e.menu.home.changelogContainer.classList.add("hidden"),e.menu.home.hide(),e.menu.levelSelect.show(),e.menu.levelSelect.hide(),e.menu.loadingScreen.loadLevel(n,void 0))};let Ja=null,eo=[];window.addEventListener("error",e=>{eo.push({message:e.error.stack,lineno:e.lineno,colno:e.colno,filename:e.filename}),null===Ja&&to()}),window.addEventListener("unhandledrejection",e=>{eo.push({message:e.reason instanceof Error?e.reason.stack:e.reason.toString(),lineno:0,colno:0,filename:"Unhandled in Promise"}),null===Ja&&to()});const to=()=>{if(Ja=null,0===eo.length)return;let e=[];eo.length=Math.min(eo.length,16);for(let t of eo)e.push({message:t.message,line:t.lineno,column:t.colno,filename:t.filename});eo.length=0,e.length>0&&fetch("./api/error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userAgent:navigator.userAgent,errors:e})}),Ja=setTimeout(to,5e3)},io=I.getRandomId();setInterval(()=>{fetch("/api/activity?id="+io)},3e4),navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js",{scope:"/"}).then(e=>{e.update()}).catch(e=>{console.log("Service worker registration failed, error:",e)});let so=null;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),so=e})}();