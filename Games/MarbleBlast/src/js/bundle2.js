!function e(){!function(){"use strict";const t={modification:null,level:null,menu:null};class i{constructor(e=0,t=0,i=0,s=1){this.x=e,this.y=t,this.z=i,this.w=s}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}clone(){return new i(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}setFromEuler(e){const t=e.x,i=e.y,s=e.z,n=e.order,a=Math.cos,r=Math.sin,o=a(t/2),l=a(i/2),h=a(s/2),d=r(t/2),c=r(i/2),u=r(s/2);switch(n){case"XYZ":this.x=d*l*h+o*c*u,this.y=o*c*h-d*l*u,this.z=o*l*u+d*c*h,this.w=o*l*h-d*c*u;break;case"YXZ":this.x=d*l*h+o*c*u,this.y=o*c*h-d*l*u,this.z=o*l*u-d*c*h,this.w=o*l*h+d*c*u;break;case"ZXY":this.x=d*l*h-o*c*u,this.y=o*c*h+d*l*u,this.z=o*l*u+d*c*h,this.w=o*l*h-d*c*u;break;case"ZYX":this.x=d*l*h-o*c*u,this.y=o*c*h+d*l*u,this.z=o*l*u-d*c*h,this.w=o*l*h+d*c*u;break;case"YZX":this.x=d*l*h+o*c*u,this.y=o*c*h+d*l*u,this.z=o*l*u-d*c*h,this.w=o*l*h-d*c*u;break;case"XZY":this.x=d*l*h-o*c*u,this.y=o*c*h-d*l*u,this.z=o*l*u+d*c*h,this.w=o*l*h+d*c*u;break;default:console.warn("Quaternion: .setFromEuler() encountered an unknown order: "+n)}return this}setFromAxisAngle(e,t){const i=t/2,s=Math.sin(i);return this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=Math.cos(i),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],s=t[4],n=t[8],a=t[1],r=t[5],o=t[9],l=t[2],h=t[6],d=t[10],c=i+r+d;if(c>0){const e=.5/Math.sqrt(c+1);this.w=.25/e,this.x=(h-o)*e,this.y=(n-l)*e,this.z=(a-s)*e}else if(i>r&&i>d){const e=2*Math.sqrt(1+i-r-d);this.w=(h-o)/e,this.x=.25*e,this.y=(s+a)/e,this.z=(n+l)/e}else if(r>d){const e=2*Math.sqrt(1+r-i-d);this.w=(n-l)/e,this.x=(s+a)/e,this.y=.25*e,this.z=(o+h)/e}else{const e=2*Math.sqrt(1+d-i-r);this.w=(a-s)/e,this.x=(n+l)/e,this.y=(o+h)/e,this.z=.25*e}return this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this.x=-e.y,this.y=e.x,this.z=0,this.w=i):(this.x=0,this.y=-e.z,this.z=e.y,this.w=i)):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(P.clamp(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const s=Math.min(1,t/i);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){let e=this.length();return 0===e?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e.x,s=e.y,n=e.z,a=e.w,r=t.x,o=t.y,l=t.z,h=t.w;return this.x=i*h+a*r+s*l-n*o,this.y=s*h+a*o+n*r-i*l,this.z=n*h+a*l+i*o-s*r,this.w=a*h-i*r-s*o-n*l,this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this.x,s=this.y,n=this.z,a=this.w;let r=a*e.w+i*e.x+s*e.y+n*e.z;if(r<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,r=-r):this.copy(e),r>=1)return this.w=a,this.x=i,this.y=s,this.z=n,this;const o=1-r*r;if(o<=Number.EPSILON){const e=1-t;return this.w=e*a+t*this.w,this.x=e*i+t*this.x,this.y=e*s+t*this.y,this.z=e*n+t*this.z,this.normalize(),this}const l=Math.sqrt(o),h=Math.atan2(l,r),d=Math.sin((1-t)*h)/l,c=Math.sin(t*h)/l;return this.w=a*d+this.w*c,this.x=i*d+this.x*c,this.y=s*d+this.y*c,this.z=n*d+this.z*c,this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=Math.random(),t=Math.sqrt(1-e),i=Math.sqrt(e),s=2*Math.PI*Math.random(),n=2*Math.PI*Math.random();return this.set(t*Math.cos(s),i*Math.sin(n),i*Math.cos(n),t*Math.sin(s))}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}}class s{constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}set(e,t,i){return this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new s(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(a.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(a.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*s,this.y=n[1]*t+n[4]*i+n[7]*s,this.z=n[2]*t+n[5]*i+n[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=e.elements,a=1/(n[3]*t+n[7]*i+n[11]*s+n[15]);return this.x=(n[0]*t+n[4]*i+n[8]*s+n[12])*a,this.y=(n[1]*t+n[5]*i+n[9]*s+n[13])*a,this.z=(n[2]*t+n[6]*i+n[10]*s+n[14])*a,this}applyQuaternion(e){const t=this.x,i=this.y,s=this.z,n=e.x,a=e.y,r=e.z,o=e.w,l=o*t+a*s-r*i,h=o*i+r*t-n*s,d=o*s+n*i-a*t,c=-n*t-a*i-r*s;return this.x=l*o+c*-n+h*-r-d*-a,this.y=h*o+c*-a+d*-n-l*-r,this.z=d*o+c*-r+l*-a-h*-n,this}transformDirection(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*s,this.y=n[1]*t+n[5]*i+n[9]*s,this.z=n[2]*t+n[6]*i+n[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,s=e.y,n=e.z,a=t.x,r=t.y,o=t.z;return this.x=s*o-n*r,this.y=n*a-i*o,this.z=i*r-s*a,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return n.copy(this).projectOnVector(e),this.sub(n)}reflect(e){return this.sub(n.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(P.clamp(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,s=this.z-e.z;return t*t+i*i+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=2*(Math.random()-.5),t=Math.random()*Math.PI*2,i=Math.sqrt(1-e**2);return this.x=i*Math.cos(t),this.y=i*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const n=new s,a=new i;class r{constructor(e=new s(1/0,1/0,1/0),t=new s(-1/0,-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=1/0,i=1/0,s=1/0,n=-1/0,a=-1/0,r=-1/0;for(let o=0,l=e.length;o<l;o+=3){const l=e[o],h=e[o+1],d=e[o+2];l<t&&(t=l),h<i&&(i=h),d<s&&(s=d),l>n&&(n=l),h>a&&(a=h),d>r&&(r=d)}return this.min.set(t,i,s),this.max.set(n,a,r),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=l.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}clone(){return(new r).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return l.copy(e).clamp(this.min,this.max).sub(e).length()}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()?this:(o[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),o[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),o[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),o[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),o[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),o[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),o[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),o[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(o),this)}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const o=[new s,new s,new s,new s,new s,new s,new s,new s],l=new s;class h{constructor(){this.elements=[1,0,0,0,1,0,0,0,1]}set(e,t,i,s,n,a,r,o,l){const h=this.elements;return h[0]=e,h[1]=s,h[2]=r,h[3]=t,h[4]=n,h[5]=o,h[6]=i,h[7]=a,h[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,a=i[0],r=i[3],o=i[6],l=i[1],h=i[4],d=i[7],c=i[2],u=i[5],m=i[8],p=s[0],g=s[3],f=s[6],y=s[1],b=s[4],v=s[7],w=s[2],x=s[5],S=s[8];return n[0]=a*p+r*y+o*w,n[3]=a*g+r*b+o*x,n[6]=a*f+r*v+o*S,n[1]=l*p+h*y+d*w,n[4]=l*g+h*b+d*x,n[7]=l*f+h*v+d*S,n[2]=c*p+u*y+m*w,n[5]=c*g+u*b+m*x,n[8]=c*f+u*v+m*S,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}add(e){for(let t=0;t<9;t++)this.elements[t]+=e.elements[t];return this}sub(e){for(let t=0;t<9;t++)this.elements[t]-=e.elements[t];return this}determinant(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],a=e[4],r=e[5],o=e[6],l=e[7],h=e[8];return t*a*h-t*r*l-i*n*h+i*r*o+s*n*l-s*a*o}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],a=e[4],r=e[5],o=e[6],l=e[7],h=e[8],d=h*a-r*l,c=r*o-h*n,u=l*n-a*o,m=t*d+i*c+s*u;if(0===m)return this.set(0,0,0,0,0,0,0,0,0);const p=1/m;return e[0]=d*p,e[1]=(s*l-h*i)*p,e[2]=(r*i-s*a)*p,e[3]=c*p,e[4]=(h*t-s*o)*p,e[5]=(s*n-r*t)*p,e[6]=u*p,e[7]=(i*o-l*t)*p,e[8]=(a*t-i*n)*p,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,s,n,a,r){const o=Math.cos(n),l=Math.sin(n);return this.set(i*o,i*l,-i*(o*a+l*r)+a+e,-s*l,s*o,-s*(-l*a+o*r)+r+t,0,0,1),this}scale(e,t){const i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=t,i[4]*=t,i[7]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),s=this.elements,n=s[0],a=s[3],r=s[6],o=s[1],l=s[4],h=s[7];return s[0]=t*n+i*o,s[3]=t*a+i*l,s[6]=t*r+i*h,s[1]=-i*n+t*o,s[4]=-i*a+t*l,s[7]=-i*r+t*h,this}translate(e,t){const i=this.elements;return i[0]+=e*i[2],i[3]+=e*i[5],i[6]+=e*i[8],i[1]+=t*i[2],i[4]+=t*i[5],i[7]+=t*i[8],this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new h).fromArray(this.elements)}}class d{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}set(e,t,i,s,n,a,r,o,l,h,d,c,u,m,p,g){const f=this.elements;return f[0]=e,f[4]=t,f[8]=i,f[12]=s,f[1]=n,f[5]=a,f[9]=r,f[13]=o,f[2]=l,f[6]=h,f[10]=d,f[14]=c,f[3]=u,f[7]=m,f[11]=p,f[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new d).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,s=1/c.setFromMatrixColumn(e,0).length(),n=1/c.setFromMatrixColumn(e,1).length(),a=1/c.setFromMatrixColumn(e,2).length();return t[0]=i[0]*s,t[1]=i[1]*s,t[2]=i[2]*s,t[3]=0,t[4]=i[4]*n,t[5]=i[5]*n,t[6]=i[6]*n,t[7]=0,t[8]=i[8]*a,t[9]=i[9]*a,t[10]=i[10]*a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,i=e.x,s=e.y,n=e.z,a=Math.cos(i),r=Math.sin(i),o=Math.cos(s),l=Math.sin(s),h=Math.cos(n),d=Math.sin(n);if("XYZ"===e.order){const e=a*h,i=a*d,s=r*h,n=r*d;t[0]=o*h,t[4]=-o*d,t[8]=l,t[1]=i+s*l,t[5]=e-n*l,t[9]=-r*o,t[2]=n-e*l,t[6]=s+i*l,t[10]=a*o}else if("YXZ"===e.order){const e=o*h,i=o*d,s=l*h,n=l*d;t[0]=e+n*r,t[4]=s*r-i,t[8]=a*l,t[1]=a*d,t[5]=a*h,t[9]=-r,t[2]=i*r-s,t[6]=n+e*r,t[10]=a*o}else if("ZXY"===e.order){const e=o*h,i=o*d,s=l*h,n=l*d;t[0]=e-n*r,t[4]=-a*d,t[8]=s+i*r,t[1]=i+s*r,t[5]=a*h,t[9]=n-e*r,t[2]=-a*l,t[6]=r,t[10]=a*o}else if("ZYX"===e.order){const e=a*h,i=a*d,s=r*h,n=r*d;t[0]=o*h,t[4]=s*l-i,t[8]=e*l+n,t[1]=o*d,t[5]=n*l+e,t[9]=i*l-s,t[2]=-l,t[6]=r*o,t[10]=a*o}else if("YZX"===e.order){const e=a*o,i=a*l,s=r*o,n=r*l;t[0]=o*h,t[4]=n-e*d,t[8]=s*d+i,t[1]=d,t[5]=a*h,t[9]=-r*h,t[2]=-l*h,t[6]=i*d+s,t[10]=e-n*d}else if("XZY"===e.order){const e=a*o,i=a*l,s=r*o,n=r*l;t[0]=o*h,t[4]=-d,t[8]=l*h,t[1]=e*d+n,t[5]=a*h,t[9]=i*d-s,t[2]=s*d-i,t[6]=r*h,t[10]=n*d+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(m,e,p)}lookAt(e,t,i){const s=this.elements;return y.subVectors(e,t),0===y.lengthSq()&&(y.z=1),y.normalize(),g.crossVectors(i,y),0===g.lengthSq()&&(1===Math.abs(i.z)?y.x+=1e-4:y.z+=1e-4,y.normalize(),g.crossVectors(i,y)),g.normalize(),f.crossVectors(y,g),s[0]=g.x,s[4]=f.x,s[8]=y.x,s[1]=g.y,s[5]=f.y,s[9]=y.y,s[2]=g.z,s[6]=f.z,s[10]=y.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,a=i[0],r=i[4],o=i[8],l=i[12],h=i[1],d=i[5],c=i[9],u=i[13],m=i[2],p=i[6],g=i[10],f=i[14],y=i[3],b=i[7],v=i[11],w=i[15],x=s[0],S=s[4],T=s[8],M=s[12],k=s[1],C=s[5],E=s[9],A=s[13],B=s[2],P=s[6],I=s[10],L=s[14],_=s[3],R=s[7],F=s[11],U=s[15];return n[0]=a*x+r*k+o*B+l*_,n[4]=a*S+r*C+o*P+l*R,n[8]=a*T+r*E+o*I+l*F,n[12]=a*M+r*A+o*L+l*U,n[1]=h*x+d*k+c*B+u*_,n[5]=h*S+d*C+c*P+u*R,n[9]=h*T+d*E+c*I+u*F,n[13]=h*M+d*A+c*L+u*U,n[2]=m*x+p*k+g*B+f*_,n[6]=m*S+p*C+g*P+f*R,n[10]=m*T+p*E+g*I+f*F,n[14]=m*M+p*A+g*L+f*U,n[3]=y*x+b*k+v*B+w*_,n[7]=y*S+b*C+v*P+w*R,n[11]=y*T+b*E+v*I+w*F,n[15]=y*M+b*A+v*L+w*U,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}add(e){for(let t=0;t<16;t++)this.elements[t]+=e.elements[t];return this}sub(e){for(let t=0;t<16;t++)this.elements[t]-=e.elements[t];return this}determinant(){const e=this.elements,t=e[0],i=e[4],s=e[8],n=e[12],a=e[1],r=e[5],o=e[9],l=e[13],h=e[2],d=e[6],c=e[10],u=e[14];return e[3]*(+n*o*d-s*l*d-n*r*c+i*l*c+s*r*u-i*o*u)+e[7]*(+t*o*u-t*l*c+n*a*c-s*a*u+s*l*h-n*o*h)+e[11]*(+t*l*d-t*r*u-n*a*d+i*a*u+n*r*h-i*l*h)+e[15]*(-s*r*h-t*o*d+t*r*c+s*a*d-i*a*c+i*o*h)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e){const t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],a=e[4],r=e[5],o=e[6],l=e[7],h=e[8],d=e[9],c=e[10],u=e[11],m=e[12],p=e[13],g=e[14],f=e[15],y=d*g*l-p*c*l+p*o*u-r*g*u-d*o*f+r*c*f,b=m*c*l-h*g*l-m*o*u+a*g*u+h*o*f-a*c*f,v=h*p*l-m*d*l+m*r*u-a*p*u-h*r*f+a*d*f,w=m*d*o-h*p*o-m*r*c+a*p*c+h*r*g-a*d*g,x=t*y+i*b+s*v+n*w;if(0===x)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const S=1/x;return e[0]=y*S,e[1]=(p*c*n-d*g*n-p*s*u+i*g*u+d*s*f-i*c*f)*S,e[2]=(r*g*n-p*o*n+p*s*l-i*g*l-r*s*f+i*o*f)*S,e[3]=(d*o*n-r*c*n-d*s*l+i*c*l+r*s*u-i*o*u)*S,e[4]=b*S,e[5]=(h*g*n-m*c*n+m*s*u-t*g*u-h*s*f+t*c*f)*S,e[6]=(m*o*n-a*g*n-m*s*l+t*g*l+a*s*f-t*o*f)*S,e[7]=(a*c*n-h*o*n+h*s*l-t*c*l-a*s*u+t*o*u)*S,e[8]=v*S,e[9]=(m*d*n-h*p*n-m*i*u+t*p*u+h*i*f-t*d*f)*S,e[10]=(a*p*n-m*r*n+m*i*l-t*p*l-a*i*f+t*r*f)*S,e[11]=(h*r*n-a*d*n-h*i*l+t*d*l+a*i*u-t*r*u)*S,e[12]=w*S,e[13]=(h*p*s-m*d*s+m*i*c-t*p*c-h*i*g+t*d*g)*S,e[14]=(m*r*s-a*p*s-m*i*o+t*p*o+a*i*g-t*r*g)*S,e[15]=(a*d*s-h*r*s+h*i*o-t*d*o-a*i*c+t*r*c)*S,this}scale(e){const t=this.elements,i=e.x,s=e.y,n=e.z;return t[0]*=i,t[4]*=s,t[8]*=n,t[1]*=i,t[5]*=s,t[9]*=n,t[2]*=i,t[6]*=s,t[10]*=n,t[3]*=i,t[7]*=s,t[11]*=n,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,s))}makeTranslation(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),s=Math.sin(t),n=1-i,a=e.x,r=e.y,o=e.z,l=n*a,h=n*r;return this.set(l*a+i,l*r-s*o,l*o+s*r,0,l*r+s*o,h*r+i,h*o-s*a,0,l*o-s*r,h*o+s*a,n*o*o+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,s,n,a){return this.set(1,i,n,0,e,1,a,0,t,s,1,0,0,0,0,1),this}compose(e,t,i){const s=this.elements,n=t.x,a=t.y,r=t.z,o=t.w,l=n+n,h=a+a,d=r+r,c=n*l,u=n*h,m=n*d,p=a*h,g=a*d,f=r*d,y=o*l,b=o*h,v=o*d,w=i.x,x=i.y,S=i.z;return s[0]=(1-(p+f))*w,s[1]=(u+v)*w,s[2]=(m-b)*w,s[3]=0,s[4]=(u-v)*x,s[5]=(1-(c+f))*x,s[6]=(g+y)*x,s[7]=0,s[8]=(m+b)*S,s[9]=(g-y)*S,s[10]=(1-(c+p))*S,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,i){const s=this.elements;let n=c.set(s[0],s[1],s[2]).length();const a=c.set(s[4],s[5],s[6]).length(),r=c.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),e.x=s[12],e.y=s[13],e.z=s[14],u.copy(this);const o=1/n,l=1/a,h=1/r;return u.elements[0]*=o,u.elements[1]*=o,u.elements[2]*=o,u.elements[4]*=l,u.elements[5]*=l,u.elements[6]*=l,u.elements[8]*=h,u.elements[9]*=h,u.elements[10]*=h,t.setFromRotationMatrix(u),i.x=n,i.y=a,i.z=r,this}makePerspective(e,t,i,s,n,a){const r=this.elements,o=2*n/(t-e),l=2*n/(i-s),h=(t+e)/(t-e),d=(i+s)/(i-s),c=-(a+n)/(a-n),u=-2*a*n/(a-n);return r[0]=o,r[4]=0,r[8]=h,r[12]=0,r[1]=0,r[5]=l,r[9]=d,r[13]=0,r[2]=0,r[6]=0,r[10]=c,r[14]=u,r[3]=0,r[7]=0,r[11]=-1,r[15]=0,this}makeOrthographic(e,t,i,s,n,a){const r=this.elements,o=1/(t-e),l=1/(i-s),h=1/(a-n),d=(t+e)*o,c=(i+s)*l,u=(a+n)*h;return r[0]=2*o,r[4]=0,r[8]=0,r[12]=-d,r[1]=0,r[5]=2*l,r[9]=0,r[13]=-c,r[2]=0,r[6]=0,r[10]=-2*h,r[14]=-u,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}const c=new s,u=new d,m=new s(0,0,0),p=new s(1,1,1),g=new s,f=new s,y=new s;let b=new s,v=new s,w=new s,x=new s,S=new s,T=new d,M=new i;class k{constructor(){this.body=null,this.boundingBox=new r,this.margin=0,this.broadphaseShape=null,this.collisionDetectionMask=1,this.collisionResponseMask=1,this.friction=1,this.restitution=1,this.mass=1,this.inertia=new h,this.invInertia=new h,this.materialOverrides=new Map}updateBoundingBox(){var e,t;if(T.compose(this.body.position,this.body.orientation,b.setScalar(1)),this.boundingBox.applyMatrix4(T),this.boundingBox.min.subScalar(this.margin),this.boundingBox.max.addScalar(this.margin),this.body.prevValid){let e=b.copy(this.body.position).sub(this.body.prevPosition);v.copy(this.boundingBox.min).sub(e),w.copy(this.boundingBox.max).sub(e),this.boundingBox.expandByPoint(v).expandByPoint(w)}null===(t=null===(e=this.body)||void 0===e?void 0:e.world)||void 0===t||t.octree.update(this)}}class C extends k{constructor(e){super(),this.radius=e,this.updateInertiaTensor()}updateInertiaTensor(){let e=.4*this.mass*this.radius**2;this.inertia.identity().multiplyScalar(e),this.invInertia.copy(this.inertia).invert()}support(e,t){return e.copy(t).setLength(this.radius).add(this.body.position),this.margin>0&&e.add(b.copy(t).setLength(this.margin)),e}getCenter(e){return e.copy(this.body.position)}updateBoundingBox(){this.boundingBox.min.setScalar(-this.radius),this.boundingBox.max.setScalar(this.radius),super.updateBoundingBox()}}class E extends k{constructor(e){super(),this.localCenter=new s,this.localAabb=new r,this.points=e,this.computeLocalBoundingBox(),this.updateInertiaTensor()}computeLocalBoundingBox(){this.localCenter.setScalar(0);for(let e of this.points)this.localCenter.addScaledVector(e,1/this.points.length);this.localAabb.setFromPoints(this.points)}updateInertiaTensor(){}support(e,t){M.copy(this.body.orientation).conjugate();let i=b.copy(t).applyQuaternion(M),s=-1/0;for(let t=0;t<this.points.length;t++){let n=this.points[t],a=n.dot(i);a>s&&(s=a,e.copy(n))}return this.body.transformPoint(e),this.margin>0&&e.add(b.copy(t).setLength(this.margin)),e}getCenter(e){return this.body.transformPoint(e.copy(this.localCenter))}updateBoundingBox(){this.boundingBox.copy(this.localAabb),super.updateBoundingBox()}}class A extends k{updateInertiaTensor(){}support(e){return e.copy(this.body.position)}getCenter(e){return e.copy(this.body.position)}}class B{constructor(e=0,t=0){this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new B(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,s=e.elements;return this.x=s[0]*t+s[3]*i+s[6],this.y=s[1]*t+s[4]*i+s[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}rotateAround(e,t){const i=Math.cos(t),s=Math.sin(t),n=this.x-e.x,a=this.y-e.y;return this.x=n*i-a*s+e.x,this.y=n*s+a*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class P{static async init(){var e;try{this.keyboardMap=await(null===(e=navigator.keyboard)||void 0===e?void 0:e.getLayoutMap())}catch(e){}}static degToRad(e){return e/180*Math.PI}static randomFromArray(e){return e[Math.floor(Math.random()*e.length)]}static modifyImageWithCanvas(e,t,i=!1){let s=document.createElement("canvas");s.setAttribute("width",e.width.toString()),s.setAttribute("height",e.height.toString());let n=s.getContext("2d");return n.translate(e.width/2,e.height/2),i&&n.scale(1,-1),n.rotate(t),n.translate(-e.width/2,-e.height/2),n.drawImage(e,0,0,e.width,e.height),s}static removeAlphaChannel(e){let t=document.createElement("canvas");t.setAttribute("width",e.width.toString()),t.setAttribute("height",e.height.toString());let i=t.getContext("2d");i.drawImage(e,0,0);let s=i.getImageData(0,0,e.width,e.height);for(let e=0;e<s.data.length;e+=4)s.data[e+3]=255;return i.putImageData(s,0,0),t}static async downsampleImage(e,t,i){let s=document.createElement("canvas");s.setAttribute("width",t.toString()),s.setAttribute("height",i.toString()),s.getContext("2d").drawImage(e,0,0,t,i);let n=s.toDataURL(),a=new Image;return a.src=n,await new Promise(e=>a.onload=e),a}static clamp(e,t,i){return e<t?t:e>i?i:e}static lerp(e,t,i){return(1-i)*e+i*t}static avg(e,t){return(e+t)/2}static isSameVector(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}static addToVectorCapped(e,t,i){let s=t.clone().normalize(),n=Math.max(0,e.dot(s));if(n+t.length()>i){let e=Math.max(0,i-n);t.normalize().multiplyScalar(e)}e.add(t)}static leftPadZeroes(e,t){return"0".repeat(Math.max(0,t-e.length))+e}static forceLayout(e){e.clientWidth}static getKeyForButtonCode(e){e:if(this.keyboardMap){let t=this.keyboardMap.get(e);if(!t)break e;return t.toUpperCase().length>1?t:t.toUpperCase()}return e.startsWith("Key")?e.slice(3):e.startsWith("Digit")?e.slice(5):e.startsWith("Arrow")?e.slice(5):"Space"===e?"Space Bar":"LMB"===e?"the Left Mouse Button":"MMB"===e?"the Middle Mouse Button":"RMB"===e?"the Right Mouse Button":e}static setsHaveOverlap(e,t){for(let i of e)if(t.has(i))return!0;return!1}static catmullRom(e,t,i,s,n){let a=e*e*e*(-1*t+3*i-3*s+n)/2;return a+=e*e*(2*t-5*i+4*s-n)/2,a+=e*(-1*t+s)/2,a+=i}static jsonClone(e){return JSON.parse(JSON.stringify(e))}static lerpColors(e,t,i){return{r:Math.floor(P.lerp(e.r,t.r,i)),g:Math.floor(P.lerp(e.g,t.g,i)),b:Math.floor(P.lerp(e.b,t.b,i)),a:Math.floor(P.lerp(e.a,t.a,i))}}static randomPointInUnitCircle(){let e=Math.sqrt(Math.random()),t=Math.random()*Math.PI*2;return new B(e*Math.cos(t),e*Math.sin(t))}static removeFromArray(e,t){let i=e.indexOf(t);-1!==i&&e.splice(i,1)}static m_matF_x_vectorF(e,t){let i=e.transpose().elements,s=t.x,n=t.y,a=t.z,r=i[0],o=i[1],l=i[2],h=i[4],d=i[5],c=i[6],u=i[8],m=i[9],p=i[10];e.transpose();let g=r*s+o*n+l*a,f=h*s+d*n+c*a,y=u*s+m*n+p*a;t.set(g,f,y)}static createCylinderConvexHull(e,t,i=32,n=new s(1,1,1)){let a=[];for(let r=0;r<2;r++)for(let o=0;o<i;o++){let l=o/i*Math.PI*2,h=Math.cos(l),d=Math.sin(l);a.push(new s(h*e*n.x,(r?t:-t)*n.y,d*e*n.z))}return new E(a)}static uppercaseFirstLetter(e){return e?e[0].toUpperCase()+e.slice(1):e}static wait(e){return new Promise(t=>setTimeout(t,e))}static adjustedMod(e,t){return(e%t+t)%t}static concatArrays(e){return 0===e.length?[]:e[0].concat(...e.slice(1))}static isInFullscreen(){var e,t;return window.innerHeight===screen.height||(null===(t=null===(e=screen.orientation)||void 0===e?void 0:e.type)||void 0===t?void 0:t.includes("portrait"))&&window.innerHeight===screen.width||!!document.fullscreenElement}static swapInArray(e,t,i){let s=e[t];e[t]=e[i],e[i]=s}static cameraLookAtDirect(e,t){let n=new s(0,0,-1);n.applyQuaternion(e.orientation);let a=new i;a.setFromUnitVectors(n,t.clone().sub(e.position).normalize()),e.orientation.copy(a.multiply(e.orientation))}static arrayBufferToString(e){let t="",i=new Uint8Array(e);for(let s=0;s<e.byteLength;s++)t+=String.fromCharCode(i[s]);return t}static stringToArrayBuffer(e){let t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t.buffer}static stringIsOnlyWhitespace(e){return 0===e.trim().length}static unescape(e){let t=/(^|[^\\])\\x([0-9a-f]{2})/gi,i=null;for(;null!==(i=t.exec(e));){let s=Number.parseInt(i[2],16),n=this.macRomanToUtf8(s);e=e.slice(0,i.index)+i[1]+n+e.slice(i.index+i[0].length),t.lastIndex-=3}let s=/\\(.)/g,n={"\\":"\\",t:"\t",v:"\v",0:"\0",f:"\f",n:"\n",r:"\r"};for(;null!==(i=s.exec(e));){let t;t=n[i[1]]?n[i[1]]:i[1],e=e.slice(0,i.index)+t+e.slice(i.index+i[0].length),s.lastIndex--}return e}static splitIgnoreStringLiterals(e,t,i='"'){let s=[],n=!1;for(let a=0;a<e.length;a++){let r=e[a];n?r===i&&"\\"!==e[a-1]&&(n=!1):r===i?n=!0:r===t&&s.push(a)}let a=[],r=e;for(let t=0;t<s.length;t++){let i=s[t]-(e.length-r.length),n=r.slice(0,i);r=r.slice(i+1),a.push(n)}return a.push(r),a}static indexOfIgnoreStringLiterals(e,t,i=0,s='"'){let n=!1;for(let a=i;a<e.length;a++){let i=e[a];if(n)i===s&&"\\"!==e[a-1]&&(n=!1);else if(i===s)n=!0;else if(e.startsWith(t,a))return a}return-1}static indexIsInStringLiteral(e,t,i='"'){let s=!1;for(let n=0;n<e.length;n++){let a=e[n];if(s){if(n===t)return!0;a===i&&"\\"!==e[n-1]&&(s=!1)}else a===i&&(s=!0)}return!1}static remapIndices(e,t){return t.map(t=>e[t])}static findLast(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return e[i]}static findLastIndex(e,t,i=e.length-1){for(let s=i;s>=0;s--)if(t(e[s]))return s;return-1}static normalizeString(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}static removeSpecialCharacters(e){return e.replace(/[-!$%^&*()_+|~=`{}\[\]:";'<>?,.\/]/g,"")}static last(e){return e[e.length-1]}static isSafari(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}static isFirefox(){return navigator.userAgent.includes("Firefox")}static download(e,t){let i=document.createElement("a");i.setAttribute("href",e),i.setAttribute("download",t),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}static removeSpecialChars(e){let t=/[^\w\d]/gi,i=null;for(;null!==(i=t.exec(e));)e=e.slice(0,i.index)+e.slice(i.index+i[0].length),t.lastIndex-=i[0].length;return e}static isNaughty(e){let t=e.toLowerCase().split(" ");for(let e of t)if(this.naughtyWords.includes(e))return!0;return!1}static shallowClone(e){let t={};for(let i in e)t[i]=e[i];return t}static isMac(){return window.navigator.platform.toLowerCase().includes("mac")}static isIOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}static secondsToTimeString(e,t=this.getDefaultSecondsToTimeStringDecimalDigits()){let i=Math.abs(e),s=Math.floor(i/60),n=P.leftPadZeroes(s.toString(),2)+":"+P.leftPadZeroes(Math.floor(i%60).toString(),2)+"."+P.leftPadZeroes(Math.floor(i*10**t%10**t).toString(),t);return e<0&&(n="-"+n),n}static async arrayBufferToBase64(e){let t=new Blob([e]),i=await new Promise(e=>{let i=new FileReader;i.onload=(t=>e(t.target.result)),i.readAsDataURL(t)});return i.slice(i.indexOf(",")+1)}static popRandomNumber(){return this.randomNumberQueue.length>0?this.randomNumberQueue.shift():Math.random()}static peekRandomNumber(e=0){for(;this.randomNumberQueue.length<=e;)this.randomNumberQueue.push(Math.random());return this.randomNumberQueue[e]}static compareVersions(e,t){let i=e.split(".").map(e=>Number(e)),s=t.split(".").map(e=>Number(e));for(let e=0;e<i.length;e++){let t=i[e],n=s[e];if(t>n)return 1;if(t<n)return-1}return 0}static checkIsTouchDevice(){return"ontouchstart"in window}static signedSqrt(e){return Math.sign(e)*Math.sqrt(Math.abs(e))}static signedSquare(e){return e*Math.abs(e)}static htmlEscape(e){return this.htmlEscapeElem.textContent=e,this.htmlEscapeElem.innerHTML}static getRandomId(){return Math.random().toString()}static roundToMultiple(e,t){return t?Math.round(e/t)*t:e}static rayIntersectsBox(e,t,i,s){let n=(i.min.x-e.x)/t.x,a=(i.max.x-e.x)/t.x,r=Math.min(n,a),o=Math.max(n,a),l=(i.min.y-e.y)/t.y,h=(i.max.y-e.y)/t.y;r=Math.max(r,Math.min(l,h)),o=Math.min(o,Math.max(l,h));let d=(i.min.z-e.z)/t.z,c=(i.max.z-e.z)/t.z;return r=Math.max(r,Math.min(d,c)),o=Math.min(o,Math.max(d,c)),s&&o>=r&&s.copy(e).addScaledVector(t,r>=0?r:o),o>=r}static macRomanToUtf8(e){return e<128?String.fromCharCode(e):this.macRomanToUtf8Map[e-128]}static monospaceNumbers(e,t=.5){e.innerHTML=e.textContent.split("").map(e=>e>="0"&&e<="9"?`<span style="width: ${t}em; display: inline-block; text-align: center;">${e}</span>`:e).join("")}static onLongTouch(e,t){let i,s=!1;e.addEventListener("touchstart",e=>{i=setTimeout(()=>{t(e),s=!0},500)}),e.addEventListener("touchend",e=>{clearTimeout(i),s&&(e.stopPropagation(),e.preventDefault(),s=!1)})}static absVector(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}static getPermutations(e){if(0===e.length)return[];if(1===e.length)return[e.slice()];let t=[];for(let i=0;i<e.length;i++){let s=e[i],n=e.slice();n.splice(i,1);let a=this.getPermutations(n);t.push(...a.map(e=>(e.unshift(s),e)))}return t}static pushArray(e,t){for(let i of t)e.push(i)}static requestPointerLock(){var e,t;let i=null===(t=(e=document.documentElement).requestPointerLock)||void 0===t?void 0:t.call(e);i&&i instanceof Promise&&i.catch(()=>{})}static isSubsequenceOf(e,t){if(e.length>t.length)return!1;let i=0;for(let s=0;s<e.length;s++){for(;t[i]!==e[s]&&i<t.length;)i++;if(i===t.length)return!1;i++}return!0}static isPowerOf2(e){return!(e&e-1)}static ceilPowerOf2(e){let t=1;for(;t<e;)t*=2;return t}static assert(e){if(!e)throw new Error("Assertion failed: "+e)}static getBoxVertices(e){let t=new s(e.max.x-e.min.x,0,0),i=new s(0,e.max.y-e.min.y,0),n=new s(0,0,e.max.z-e.min.z);return[e.min.clone(),e.min.clone().add(t),e.min.clone().add(i),e.min.clone().add(n),e.min.clone().add(t).add(i),e.min.clone().add(t).add(n),e.min.clone().add(i).add(n),e.max.clone()]}static cursedRound(e,t){return Math.floor((t-1)*e-Number.EPSILON+1)/t}}P.naughtyWords=["2g1c","2 girls 1 cup","acrotomophilia","alabama hot pocket","alaskan pipeline","anal","anilingus","anus","apeshit","arsehole","ass","asshole","assmunch","auto erotic","autoerotic","babeland","baby batter","baby juice","ball gag","ball gravy","ball kicking","ball licking","ball sack","ball sucking","bangbros","bangbus","bareback","barely legal","barenaked","bastard","bastardo","bastinado","bbw","bdsm","beaner","beaners","beaver cleaver","beaver lips","beastiality","bestiality","big black","big breasts","big knockers","big tits","bimbos","birdlock","bitch","bitches","black cock","blonde action","blonde on blonde action","blowjob","blow job","blow your load","blue waffle","blumpkin","bollocks","bondage","boner","boob","boobs","booty call","brown showers","brunette action","bukkake","bulldyke","bullet vibe","bullshit","bung hole","bunghole","busty","butt","buttcheeks","butthole","camel toe","camgirl","camslut","camwhore","carpet muncher","carpetmuncher","chocolate rosebuds","cialis","circlejerk","cleveland steamer","clit","clitoris","clover clamps","clusterfuck","cock","cocks","coprolagnia","coprophilia","cornhole","coon","coons","creampie","cum","cumming","cumshot","cumshots","cunnilingus","cunt","darkie","date rape","daterape","deep throat","deepthroat","dendrophilia","dick","dildo","dingleberry","dingleberries","dirty pillows","dirty sanchez","doggie style","doggiestyle","doggy style","doggystyle","dog style","dolcett","domination","dominatrix","dommes","donkey punch","double dong","double penetration","dp action","dry hump","dvda","eat my ass","ecchi","ejaculation","erotic","erotism","escort","eunuch","fag","faggot","fecal","felch","fellatio","feltch","female squirting","femdom","figging","fingerbang","fingering","fisting","foot fetish","footjob","frotting","fuck","fuck buttons","fuckin","fucking","fucktards","fudge packer","fudgepacker","futanari","gangbang","gang bang","gay sex","genitals","giant cock","girl on","girl on top","girls gone wild","goatcx","goatse","god damn","gokkun","golden shower","goodpoop","goo girl","goregasm","grope","group sex","g-spot","guro","hand job","handjob","hard core","hardcore","hentai","homoerotic","honkey","hooker","horny","hot carl","hot chick","how to kill","how to murder","huge fat","humping","incest","intercourse","jack off","jail bait","jailbait","jelly donut","jerk off","jigaboo","jiggaboo","jiggerboo","jizz","juggs","kike","kinbaku","kinkster","kinky","knobbing","leather restraint","leather straight jacket","lemon party","livesex","lolita","lovemaking","make me come","male squirting","masturbate","masturbating","masturbation","menage a trois","milf","missionary position","mong","motherfucker","mound of venus","mr hands","muff diver","muffdiving","nambla","nawashi","negro","neonazi","nigga","nigger","nig nog","nimphomania","nipple","nipples","nsfw","nsfw images","nude","nudity","nutten","nympho","nymphomania","octopussy","omorashi","one cup two girls","one guy one jar","orgasm","orgy","paedophile","paki","panties","panty","pedobear","pedophile","pegging","penis","phone sex","piece of shit","pikey","pissing","piss pig","pisspig","playboy","pleasure chest","pole smoker","ponyplay","poof","poon","poontang","punany","poop chute","poopchute","porn","porno","pornography","prince albert piercing","pthc","pubes","pussy","queaf","queef","quim","raghead","raging boner","rape","raping","rapist","rectum","reverse cowgirl","rimjob","rimming","rosy palm","rosy palm and her 5 sisters","rusty trombone","sadism","santorum","scat","schlong","scissoring","semen","sex","sexcam","sexo","sexy","sexual","sexually","sexuality","shaved beaver","shaved pussy","shemale","shibari","shit","shitblimp","shitty","shota","shrimping","skeet","slanteye","slut","s&m","smut","snatch","snowballing","sodomize","sodomy","spastic","spic","splooge","splooge moose","spooge","spread legs","spunk","strap on","strapon","strappado","strip club","style doggy","suck","sucks","suicide girls","sultry women","swastika","swinger","tainted love","taste my","tea bagging","threesome","throating","thumbzilla","tied up","tight white","tit","tits","titties","titty","tongue in a","topless","tosser","towelhead","tranny","tribadism","tub girl","tubgirl","tushy","twat","twink","twinkie","two girls one cup","undressing","upskirt","urethra play","urophilia","vagina","venus mound","viagra","vibrator","violet wand","vorarephilia","voyeur","voyeurweb","voyuer","vulva","wank","wetback","wet dream","white power","whore","worldsex","wrapping men","wrinkled starfish","xx","xxx","yaoi","yellow showers","yiffy","zoophilia","üñï"],P.getDefaultSecondsToTimeStringDecimalDigits=(()=>3),P.randomNumberQueue=[],P.htmlEscapeElem=document.createElement("p"),P.macRomanToUtf8Map=["√Ñ","√Ö","√á","√â","√ë","√ñ","√ú","√°","√†","√¢","√§","√£","√•","√ß","√©","√®","√™","√´","√≠","√¨","√Æ","√Ø","√±","√≥","√≤","√¥","√∂","√µ","√∫","√π","√ª","√º","‚Ä†","¬∞","¬¢","¬£","¬ß","‚Ä¢","¬∂","√ü","¬Æ","¬©","‚Ñ¢","¬¥","¬®","‚â†","√Ü","√ò","‚àû","¬±","‚â§","‚â•","¬•","¬µ","‚àÇ","‚àë","‚àè","œÄ","‚à´","¬™","¬∫","Œ©","√¶","√∏","¬ø","¬°","¬¨","‚àö","∆í","‚âà","‚àÜ","¬´","¬ª","‚Ä¶","‚ÄØ","√Ä","√É","√ï","≈í","≈ì","‚Äì","‚Äî","‚Äú","‚Äù","‚Äò","‚Äô","√∑","‚óä","√ø","≈∏","‚ÅÑ","‚Ç¨","‚Äπ","‚Ä∫","Ô¨Å","Ô¨Ç","‚Ä°","¬∑","‚Äö","‚Äû","‚Ä∞","√Ç","√ä","√Å","√ã","√à","√ç","√é","√è","√å","√ì","√î","üçé","√í","√ö","√õ","√ô","ƒ±","ÀÜ","Àú","¬Ø","Àò","Àô","Àö","¬∏","Àù","Àõ","Àá"],P.isWeeb=Math.random()<.001,P.isTouchDevice=P.checkIsTouchDevice();class I{constructor(){this.scheduled=[]}tickSchedule(e){for(let t of this.scheduled.slice())e>=t.time&&(P.removeFromArray(this.scheduled,t),t.callback())}schedule(e,t,i=null){this.scheduled.push({time:e,callback:t,id:i})}clearSchedule(){this.scheduled.length=0}clearScheduleId(e){for(let t=0;t<this.scheduled.length;t++)this.scheduled[t].id===e&&this.scheduled.splice(t--,1)}}var L,_;let R=(()=>{let e=null;self.onmessage=(t=>{if(!e)return e=t.data,void self.importScripts(e+"lib/pako.js");let i=t.data;if("compress"===i.command){let e=pako.deflate(i.data);L=t.data.msgId,_=e,self.postMessage({msgId:L,data:_})}})}).toString(),F=R.slice(R.indexOf("{")+1,R.lastIndexOf("}")),U=new Blob([F]),z=new Worker(URL.createObjectURL(U)),D=new Map;z.postMessage(window.location.href.slice(0,window.location.href.lastIndexOf("/")+1)),z.onmessage=(e=>{D.get(e.data.msgId)(e.data.data)});const V=(e,t)=>{let i=P.getRandomId();return z.postMessage({msgId:i,command:e,data:t}),new Promise(e=>{D.set(i,e)})};let O=(()=>{let e=new Map;self.onmessage=(t=>{let i=t.data;if("setTimeout"===i.command){let t=setTimeout(()=>{self.postMessage({externalId:i.externalId})},i.timeout);e.set(i.externalId,t)}else if("setInterval"===i.command){let t=setInterval(()=>{self.postMessage({externalId:i.externalId})},i.timeout);e.set(i.externalId,t)}else"clear"===i.command&&(clearTimeout(e.get(i.externalId)),clearInterval(e.get(i.externalId)))})}).toString(),N=O.slice(O.indexOf("{")+1,O.lastIndexOf("}")),q=new Worker(URL.createObjectURL(new Blob([N]))),j=0,G=new Map;q.onmessage=(e=>{let t=G.get(e.data.externalId);null===t||void 0===t||t.func(),(null===t||void 0===t?void 0:t.once)&&G.delete(e.data.externalId)});const W=(e,t=0)=>(q.postMessage({command:"setTimeout",timeout:t,externalId:j}),G.set(j,{func:e,once:!0}),j++),H=5999999.99,X={settings:{resolution:2,videoDriver:0,screenStyle:0,colorDepth:1,shadows:!1,musicVolume:.5,soundVolume:.7,gameButtonMapping:{up:"KeyW",down:"KeyS",left:"KeyA",right:"KeyD",jump:"Space",use:"LMB",cameraUp:"ArrowUp",cameraDown:"ArrowDown",cameraLeft:"ArrowLeft",cameraRight:"ArrowRight",freeLook:"RMB",restart:"KeyR",blast:"KeyE"},mouseSensitivity:.2,keyboardSensitivity:.1,invertMouse:0,alwaysFreeLook:!0,marbleReflectivity:0,showFrameRate:!0,showThousandths:!0,fov:60,fancyShaders:!0,pixelRatio:2,inputType:0,frameRateCap:7,canvasDesynchronized:!/(CrOS)/.test(navigator.userAgent),joystickPosition:0,joystickSize:250,joystickLeftOffset:75,joystickVerticalPosition:.5,actionButtonOrder:0,actionButtonSize:120,actionButtonRightOffset:30,actionButtonBottomOffset:30,actionButtonAsJoystickMultiplier:1.5},bestTimes:{},lastUsedName:"",randomId:P.getRandomId(),bestTimeSubmissionQueue:{},lastSeenVersion:null,collectedEggs:[],modification:"platinum",videoRecorderConfig:{width:1280,height:720,kilobitRate:5e3,frameRate:60,playbackSpeed:1,fastMode:!0,bt709:!1,includeAudio:!0,audioKilobitRate:64,musicToSoundRatio:.7},domainMigrationDone:!1},Y={"2.1.5":async()=>{K.data.settings.marbleReflectivity=0,await K.store()},"2.3.0":async()=>{K.data.settings.marbleReflectivity=0,await K.store()}};class K{static async init(){this.idbDatabaseLoading=new Promise(e=>{let t=indexedDB.open("mb-database",3);t.onsuccess=(t=>{e(),this.idbDatabase=t.target.result,this.idbDatabaseLoading=null}),t.onupgradeneeded=(e=>{let t=e.target.result,i=e.target.transaction;try{t.createObjectStore("replays",{})}catch(e){i.objectStore("replays")}try{t.createObjectStore("keyvalue",{})}catch(e){i.objectStore("keyvalue")}})}),localStorage.getItem("mb-storage")&&await this.migrate();let e=await this.databaseGet("keyvalue","storageData");this.data=e?this.correctFields(X,e):X,1===this.data.settings.inputType?P.isTouchDevice=!1:2===this.data.settings.inputType&&(P.isTouchDevice=!0),this.data.bestTimes={};let t=await this.databaseGet("keyvalue","bestTimes");if(t)try{let e=pako.inflate(t,{to:"string"}),i=JSON.parse(e);this.data.bestTimes=i}catch(e){console.error("Error decoding best times!",e)}let i=!1;for(let e in this.data.bestTimes)if(e.startsWith("mbu/")){for(let t=0;t<this.data.bestTimes[e].length;t++){this.data.bestTimes[e][t][3]<1634861292099&&(this.data.bestTimes[e].splice(t--,1),i=!0)}0===this.data.bestTimes[e].length&&delete this.data.bestTimes[e]}i&&await this.storeBestTimes(),P.getDefaultSecondsToTimeStringDecimalDigits=(()=>this.data.settings.showThousandths?3:2),location.search.includes("migrate-domains")?this.transmitDomainMigration():this.data.domainMigrationDone||this.receiveDomainMigration()}static async migrate(){let e=JSON.parse(localStorage.getItem("mb-storage"));this.data=e;for(let t in e.bestTimes)for(let i of e.bestTimes[t])i[3]=0;await this.store(),await this.storeBestTimes(),localStorage.removeItem("mb-storage")}static async store(){let e=P.shallowClone(this.data);delete e.bestTimes,await this.databasePut("keyvalue",e,"storageData")}static async storeBestTimes(){let e=JSON.stringify(this.data.bestTimes),t=await V("compress",e);await this.databasePut("keyvalue",t,"bestTimes")}static getBestTimesForMission(e,t,i){let s=[],n=this.data.bestTimes[e];n&&s.push(...n),s.sort((e,t)=>e[1]-t[1]);let a=t-s.length;for(let e=0;e<a;e++)s.push([i,H,"",0]);return s}static insertNewTime(e,t,i){var s;let n,a=null!==(s=this.data.bestTimes[e])&&void 0!==s?s:[],r=[t,i,P.getRandomId(),Date.now()];for(n=0;n<a.length&&!(a[n][1]>i);n++);if(a.splice(n,0,r),a.length>this.maxScoresPerLevel){let e=a[this.maxScoresPerLevel];a=a.slice(0,this.maxScoresPerLevel),e[2]&&this.databaseGet("replays",e[2]).then(t=>{t&&this.databaseDelete("replays",e[2])})}return this.data.bestTimes[e]=a,this.storeBestTimes(),n===this.maxScoresPerLevel?null:{index:n,score:r}}static async databaseGet(e,t){var i;await this.idbDatabaseLoading;let s=this.idbDatabase.transaction(e,"readonly").objectStore(e).get(t);return await new Promise(e=>s.onsuccess=e),null!==(i=s.result)&&void 0!==i?i:null}static async databasePut(e,t,i){await this.idbDatabaseLoading;let s=this.idbDatabase.transaction(e,"readwrite");s.objectStore(e).put(t,i),await new Promise(e=>s.addEventListener("complete",e))}static async databaseDelete(e,t){await this.idbDatabaseLoading;let i=this.idbDatabase.transaction(e,"readwrite");i.objectStore(e).delete(t),await new Promise(e=>i.addEventListener("complete",e))}static async databaseCount(e,t){var i;await this.idbDatabaseLoading;let s=this.idbDatabase.transaction(e,"readonly").objectStore(e).count(t);return await new Promise(e=>s.onsuccess=e),null!==(i=s.result)&&void 0!==i?i:null}static correctFields(e,t){for(let i in e)i in t||(t[i]=e[i]),e[i]&&"object"==typeof e[i]&&!Array.isArray(e[i])&&Object.keys(e[i]).length&&this.correctFields(e[i],t[i]);for(let i in t)i in e||delete t[i];return t}static async onVersionUpgrade(e){for(let t in Y)P.compareVersions(e,t)>=0||await Y[t]()}static async transmitDomainMigration(){await this.idbDatabaseLoading,console.log("Sending migration data..."),window.parent.postMessage({type:"bestTimes",data:this.data.bestTimes},"https://marbleblast.vaniverse.io"),this.idbDatabase.transaction(["replays"],"readonly").objectStore("replays").openCursor().onsuccess=(e=>{const t=e.target.result;t?(window.parent.postMessage({type:"replay",key:t.key,data:t.value},"https://marbleblast.vaniverse.io"),t.continue()):window.parent.postMessage({type:"done"},"https://marbleblast.vaniverse.io")})}static async receiveDomainMigration(){console.log("Receiving migration data...");const e=document.createElement("iframe");e.src="https://marbleblast.vani.ga/?migrate-domains",e.style.display="none",document.body.appendChild(e),window.addEventListener("message",e=>{const t=e.data;if(console.log(t),"bestTimes"===t.type){for(let e in t.data){let i=this.data.bestTimes[e];i||(i=this.data.bestTimes[e]=[]),i.push(...t.data[e]),i.sort((e,t)=>e[1]-t[1]),this.data.bestTimes[e]=i.slice(0,5)}this.storeBestTimes()}else"replay"===t.type?this.databasePut("replays",t.data,t.key):"done"===t.type&&(this.data.domainMigrationDone=!0,this.store())})}}K.maxScoresPerLevel=5;class Q{constructor(e,t,i,s=""){this.vertexArrayObjects=new Map,this.uniformLocations=new Map,this.attributeLocations=new Map,this.compileStatusChecked=!1,this.renderer=e;let{gl:n}=e;n instanceof WebGLRenderingContext||([t,i]=this.convertFromGLSL100ToGLSL300(t,i));let a=`\n\t\t\t${!(n instanceof WebGLRenderingContext&&!e.extensions.EXT_frag_depth)?"#define LOG_DEPTH_BUF":""}\n\t\t\t${n instanceof WebGLRenderingContext?"#define IS_WEBGL1":""}\n\t\t\t${s}\n\t\t`;t=t.replace("#include <definitions>",a),i=i.replace("#include <definitions>",a),this.vertexShader=n.createShader(n.VERTEX_SHADER),this.fragmentShader=n.createShader(n.FRAGMENT_SHADER),n.shaderSource(this.vertexShader,t),n.shaderSource(this.fragmentShader,i),n.compileShader(this.vertexShader),n.compileShader(this.fragmentShader);let r=n.createProgram();n.attachShader(r,this.vertexShader),n.attachShader(r,this.fragmentShader),n.linkProgram(r),this.glProgram=r}convertFromGLSL100ToGLSL300(e,t){t="#version 300 es\n"+t,e=(e=(e="#version 300 es\n"+e).replace(/\nattribute /g,"\nin ")).replace(/\nvarying /g,"\nout "),t=(t=(t=(t=t.replace(/\nvarying /g,"\nin ")).replace("\nvoid main()","out vec4 FragColor;\nvoid main()")).replace(/gl_FragColor/g,"FragColor")).replace(/gl_FragDepthEXT/g,"gl_FragDepth");let i="\n\t\t\t#define texture2D texture\n\t\t\t#define textureCube texture\n\t\t\t#include <definitions>\n\t\t";return[e=e.replace("#include <definitions>",i),t=t.replace("#include <definitions>",i)]}checkCompileStatus(){let{gl:e}=this.renderer;this.compileStatusChecked=!0,e.getShaderParameter(this.vertexShader,e.COMPILE_STATUS)?e.getShaderParameter(this.fragmentShader,e.COMPILE_STATUS)?e.getProgramParameter(this.glProgram,e.LINK_STATUS)||console.error("Unable to initialize the shader program: "+e.getProgramInfoLog(this.glProgram)):console.error("An error occurred compiling the shaders: "+e.getShaderInfoLog(this.fragmentShader)):console.error("An error occurred compiling the shaders: "+e.getShaderInfoLog(this.vertexShader))}use(){var e;this.renderer.currentProgram!==this&&(this.compileStatusChecked||this.checkCompileStatus(),null===(e=this.renderer.currentProgram)||void 0===e||e.unuse(),this.renderer.gl.useProgram(this.glProgram),this.renderer.currentProgram=this)}unuse(){let{gl:e}=this.renderer;this.renderer.bindVertexArray(null);for(let[,t]of this.attributeLocations)e.disableVertexAttribArray(t)}bindVertexBufferGroup(e){if(this.vertexArrayObjects.has(e))return void this.renderer.bindVertexArray(this.vertexArrayObjects.get(e));let{gl:t}=this.renderer,i=this.renderer.createVertexArray();this.renderer.bindVertexArray(i);for(let t of e.buffers)this.bindVertexBuffer(t);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.vertexArrayObjects.set(e,i)}bindVertexBuffer(e){let{gl:t}=this.renderer;t.bindBuffer(t.ARRAY_BUFFER,e.buffer);let i=0;for(let s in e.attributes){let n=e.attributes[s],a=i;i+=n;let r=this.attributeLocations.get(s);void 0===r&&(r=t.getAttribLocation(this.glProgram,s))>=0&&this.attributeLocations.set(s,r),-1!==r&&(t.enableVertexAttribArray(r),t.vertexAttribPointer(r,n,t.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*e.stride,Float32Array.BYTES_PER_ELEMENT*a))}}getUniformLocation(e){if(this.uniformLocations.has(e))return this.uniformLocations.get(e);let{gl:t}=this.renderer,i=t.getUniformLocation(this.glProgram,e);return this.uniformLocations.set(e,i),i}cleanUp(){this.renderer.bindVertexArray(null);for(let[,e]of this.vertexArrayObjects)this.renderer.deleteVertexArray(e);this.vertexArrayObjects.clear()}}var $="precision highp float;\nprecision highp int;\n\n#include <definitions>\n\nattribute vec3 position;\nattribute float meshInfoIndex;\n\nuniform highp sampler2D meshInfos;\nuniform int meshInfoTextureWidth;\nuniform int meshInfoTextureHeight;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nint _mod(int a, int n) {\n\t#ifdef IS_WEBGL1\n\t\treturn a - n * (a / n);\n\t#else\n\t\treturn a % n;\n\t#endif\n}\n\n// Refer to material_vert.glsl for an explanation of what this does\nmat4 getMeshInfo(int index) {\n\tivec2 coords = ivec2(\n\t\t_mod(4 * index, meshInfoTextureWidth),\n\t\t(4 * index) / meshInfoTextureWidth\n\t);\n\n\t#ifdef IS_WEBGL1\n\t\treturn mat4(\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(0, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(1, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(2, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(3, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight))\n\t\t);\n\t#else\n\t\treturn mat4(\n\t\t\ttexelFetch(meshInfos, coords + ivec2(0, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(1, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(2, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(3, 0), 0)\n\t\t);\n\t#endif\n}\n\nvoid main() {\n\tmat4 meshInfo = getMeshInfo(int(meshInfoIndex + 0.1)); // + 0.1 to make sure it casts correctly, lol\n\tmat4 transform = meshInfo;\n\ttransform[0][3] = 0.0;\n\ttransform[1][3] = 0.0;\n\ttransform[2][3] = 0.0;\n\ttransform[3][3] = 1.0;\n\tfloat opacity = meshInfo[0][3];\n\n\tif (opacity < 1.0) {\n\t\t// Non-opaque objects don't cast shadows in our perfect world\n\t\tgl_Position = vec4(0.0);\n\t\treturn;\n\t}\n\n\t// Simply transform the vertex and we're done\n\tmat4 mvp = projectionMatrix * viewMatrix * transform;\n\tgl_Position = mvp * vec4(position, 1.0);\n}",Z="precision mediump float;\n\n#include <definitions>\n\nvoid main() {\n\tgl_FragColor = vec4(1.0); // Simple pass-through shader\n}",J="precision highp float;\n\n#include <definitions>\n\nattribute vec2 position;\nattribute vec2 uv;\nattribute float particleSpawnTime;\nattribute float particleLifetime;\nattribute vec3 particlePosition;\nattribute vec3 particleVelocity;\nattribute float particleInitialSpin;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nuniform float time;\nuniform float acceleration;\nuniform float spinSpeed;\nuniform float dragCoefficient;\nuniform vec4 times;\nuniform vec4 sizes;\nuniform mat4 colors;\n\nvarying vec2 vUv;\nvarying float vFragDepth;\nvarying float vIsPerspective;\nvarying vec4 color;\n\nbool isPerspectiveMatrix(mat4 m) {\n\treturn m[2][3] == -1.0;\n}\n\n// Dynamic access of vecs and mats doesn't work properly in WebGL, so wrap the functionality in a function that does it the ugly way.\nfloat accessDynamically(vec4 data, int idx) {\n\t#ifdef IS_WEBGL1\n\t\t// Since all these indices are known at compile-time, this works just fine\n\t\tif (idx == 0) return data[0];\n\t\tif (idx == 1) return data[1];\n\t\tif (idx == 2) return data[2];\n\t\treturn data[3];\n\t#else\n\t\treturn data[idx];\n\t#endif\n}\n\nvec4 accessDynamically(mat4 data, int idx) {\n\t#ifdef IS_WEBGL1\n\t\tif (idx == 0) return data[0];\n\t\tif (idx == 1) return data[1];\n\t\tif (idx == 2) return data[2];\n\t\treturn data[3];\n\t#else\n\t\treturn data[idx];\n\t#endif\n}\n\nvoid main() {\n\tfloat elapsed = time - particleSpawnTime;\n\tfloat completion = clamp(elapsed / particleLifetime, 0.0, 1.0);\n\n\tif (completion == 1.0) {\n\t\t// We're dead, don't render\n\t\tgl_Position = vec4(0.0);\n\t\treturn;\n\t}\n\n\tfloat velElapsed = elapsed / 1000.0;\n\tvelElapsed = pow(velElapsed, 1.0 - dragCoefficient);\n\n\t// Compute the position\n\tvec3 computedPosition = particlePosition + particleVelocity * (velElapsed + acceleration * velElapsed * velElapsed / 2.0);\n\tfloat rotation = particleInitialSpin + spinSpeed * elapsed / 1000.0;\n\n\t// Check where we are in the times array\n\tint indexLow = 0;\n\tint indexHigh = 1;\n\tfor (int i = 2; i < 4; i++) {\n\t\tif (times[indexHigh] >= completion) break;\n\n\t\tindexLow = indexHigh;\n\t\tindexHigh = i;\n\t}\n\tif (times[1] > 1.0) indexHigh = indexLow; // Basically checking if (this.o.times.length === 1)\n\tfloat timeLow = accessDynamically(times, indexLow);\n\tfloat timeHigh = accessDynamically(times, indexHigh);\n\tfloat t = (completion - timeLow) / (timeHigh - timeLow);\n\n\t// Compute the color to send to the fragment shader\n\tcolor = mix(accessDynamically(colors, indexLow), accessDynamically(colors, indexHigh), t);\n\tcolor.a = pow(color.a, 1.5); // Adjusted because additive mixing can be kind of extreme\n\n\tvec4 viewPosition = viewMatrix * vec4(computedPosition, 1.0);\n\n\tvec2 scale = vec2(1.0);\n\tscale *= mix(accessDynamically(sizes, indexLow), accessDynamically(sizes, indexHigh), t); // Adjust sizing\n\n\t// Enable the following code if you don't want to attenuate the size with growing distance:\n\t// scale *= -viewPosition.z;\n\n\tvec2 center = vec2(0.5, 0.5); // Fixed, for now\n\tvec2 alignedPosition = (position - (center - vec2(0.5))) * scale;\n\tvec2 rotatedPosition;\n\n\trotatedPosition.x = cos(rotation) * alignedPosition.x - sin(rotation) * alignedPosition.y;\n\trotatedPosition.y = sin(rotation) * alignedPosition.x + cos(rotation) * alignedPosition.y;\n\tviewPosition.xy += rotatedPosition;\n\n\tgl_Position = projectionMatrix * viewPosition;\n\n\tvUv = uv;\n\n\t#ifdef LOG_DEPTH_BUF\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float(isPerspectiveMatrix(projectionMatrix));\n\t#endif\n}",ee="precision mediump float;\n\n#include <definitions>\n\nvarying vec2 vUv;\nvarying float vFragDepth;\nvarying float vIsPerspective;\nvarying vec4 color;\n\nuniform sampler2D diffuseMap;\nuniform float logDepthBufFC;\n\n#if defined(LOG_DEPTH_BUF) && defined(IS_WEBGL1)\n\t#extension GL_EXT_frag_depth : enable\n#endif\n\nvoid main() {\n\tgl_FragColor = color * texture2D(diffuseMap, vUv);\n\t\n\t#ifdef LOG_DEPTH_BUF\n\t\t// We always need to set gl_FragDepthEXT when it's present in the file, otherwise it gets real weird\n\t\t// Also: Doing a strict comparison with == 1.0 can cause noise artifacts\n\t\tgl_FragDepthEXT = (vIsPerspective != 0.0)? log2(vFragDepth) * logDepthBufFC * 0.5 : gl_FragCoord.z;\n\t#endif\n}";class te{constructor(e){if(this.id=P.getRandomId(),this.glTextures=new Map,!e.complete)throw new Error("Can only pass loaded images into Texture.");this.image=e}getGLTexture(e){let t=this.glTextures.get(e);if(t)return t;let{gl:i}=e;t=i.createTexture(),i.bindTexture(i.TEXTURE_2D,t),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this.image),i.generateMipmap(i.TEXTURE_2D),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),e.extensions.EXT_texture_filter_anisotropic&&i.texParameteri(i.TEXTURE_2D,e.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,4),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),this.glTextures.set(e,t)}}const ie=document.querySelector("#image-cache"),se={"assets/data_mbp/sound/gotgem.wav":"assets/data_mbp/sound/gotdiamond.wav","assets/data_mbp/sound/gotallgems.wav":"assets/data_mbp/sound/gotalldiamonds.wav","assets/data_mbp/sound/music/groovepolice":"assets/data_mbp/sound/music/groove police"};class ne{static get mainDataPath(){return"gold"===t.modification?"./assets/data/":"./assets/data_mbp/"}static async init(){let e=this.loadResource("./api/directory_structure"),t=this.loadResource("./api/directory_structure_mbp"),[i,s]=await Promise.all([e,t]);this.dataDirectoryStructure=JSON.parse(await this.readBlobAsText(i)),this.dataMbpDirectoryStructure=JSON.parse(await this.readBlobAsText(s))}static getTexture(e,t=this.mainDataPath){let i=t+e,s=this.textureCache.get(i);if(s)return Promise.resolve(s);if(this.loadTexturePromises.get(i))return this.loadTexturePromises.get(i);let n=new Promise(async e=>{let t=await this.loadImage(i),s=new te(t);s.getGLTexture(he),this.textureCache.set(i,s),this.loadTexturePromises.delete(i),e(s)});return this.loadTexturePromises.set(i,n),n}static getTextureFromCache(e,t=this.mainDataPath){let i=t+e,s=this.textureCache.get(i);return s||null}static getFullNamesOf(e,i="platinum"===t.modification){let s=e.split("/"),n=i?this.dataMbpDirectoryStructure:this.dataDirectoryStructure;for(;s.length;){let e=s.shift();if(0===s.length){let t=[];for(let i in n)!i.toLowerCase().startsWith(e.toLowerCase())||i.length!==e.length&&e.length!==i.lastIndexOf(".")||t.push(i);return t}if(!(n=n[e]))return[]}}static redirectPath(e){if("gold"!==t.modification)for(let t in se)if(e.includes(t))return e.replace(t,se[t]);return e}static loadResource(e){e=this.redirectPath(e);let t=this.cachedResources.get(e);if(t)return Promise.resolve(t);if(this.loadResourcePromises.get(e))return this.loadResourcePromises.get(e);let i=new Promise((t,i)=>{const s=async()=>{try{let n=await fetch(e);if(404===n.status)return this.cachedResources.set(e,null),this.loadResourcePromises.delete(e),void t(null);if(!n.ok)return i(`Error getting resource (${n.status}): `+e),void this.loadResourcePromises.delete(e);let a=await n.blob();this.cachedResources.set(e,a),this.loadResourcePromises.delete(e),t(a)}catch(e){setTimeout(s,1e3)}};s()});return this.loadResourcePromises.set(e,i),i}static loadImage(e){if(this.loadedImages.get(e))return Promise.resolve(this.loadedImages.get(e));if(this.loadImagePromises.get(e))return this.loadImagePromises.get(e);let t=new Promise(t=>{let i=new Image;i.src=e,i.onload=(()=>{ie.appendChild(i),this.loadedImages.set(e,i),this.loadImagePromises.delete(e),t(i),i.onload=null})});return this.loadImagePromises.set(e,t),t}static loadImages(e){return Promise.all(e.map(e=>this.loadImage(e)))}static getImageFromCache(e){return this.loadedImages.get(e)||null}static readBlobAsText(e,t){return e.text?e.text():new Promise(i=>{let s=new FileReader;s.onload=(e=>i(e.target.result)),s.readAsText(e,t)})}static async readBlobAsJson(e,t){let i=await this.readBlobAsText(e,t);return JSON.parse(i)}static readBlobAsArrayBuffer(e){return e.arrayBuffer?e.arrayBuffer():new Promise(t=>{let i=new FileReader;i.onload=(e=>t(e.target.result)),i.readAsArrayBuffer(e)})}static readBlobAsDataUrl(e){return new Promise(t=>{let i=new FileReader;i.onload=(e=>t(e.target.result)),i.readAsDataURL(e)})}static getUrlToBlob(e){if(this.urlCache.get(e))return this.urlCache.get(e);let t=URL.createObjectURL(e);return this.urlCache.set(e,t),t}static retryFetch(e,t){return new Promise(i=>{const s=async()=>{try{let n=await fetch(e,t);if(404===n.status)return void i(null);let a=await n.blob();i(a)}catch(e){setTimeout(s,1e3)}};s()})}}var ae;ne.textureCache=new Map,ne.loadTexturePromises=new Map,ne.dataDirectoryStructure={},ne.dataMbpDirectoryStructure={},ne.loadResourcePromises=new Map,ne.cachedResources=new Map,ne.loadImagePromises=new Map,ne.loadedImages=new Map,ne.urlCache=new Map,function(e){e[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Subtractve=2]="Subtractve"}(ae||(ae={}));const re={alpha:!1,desynchronized:!1};class oe{constructor(e){this.currentProgram=null,this.materialShaders=new Map,this.pixelRatio=1,this.currentFramebuffer=null,this.debugMode=0,this.extensions={EXT_texture_filter_anisotropic:null,EXT_frag_depth:null,OES_element_index_uint:null,WEBGL_depth_texture:null,OES_standard_derivatives:null,KHR_parallel_shader_compile:null,OES_texture_float:null,OES_vertex_array_object:null},e=Object.assign(Object.assign({},re),e),this.options=e;let t={desynchronized:e.desynchronized,depth:!0,stencil:!0,antialias:!1,powerPreference:"high-performance",alpha:e.alpha,premultipliedAlpha:!0};this.gl=e.canvas.getContext("webgl2",t),this.gl||(this.gl=e.canvas.getContext("webgl",t));let{gl:i}=this;this.extensions.EXT_texture_filter_anisotropic=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extensions.EXT_frag_depth=i.getExtension("EXT_frag_depth"),this.extensions.OES_element_index_uint=i.getExtension("OES_element_index_uint"),this.extensions.WEBGL_depth_texture=i.getExtension("WEBGL_depth_texture"),this.extensions.OES_standard_derivatives=i.getExtension("OES_standard_derivatives"),this.extensions.KHR_parallel_shader_compile=i.getExtension("KHR_parallel_shader_compile"),this.extensions.OES_texture_float=i.getExtension("OES_texture_float"),this.extensions.OES_vertex_array_object=i.getExtension("OES_vertex_array_object"),this.shadowMapProgram=new Q(this,$,Z),this.particleProgram=new Q(this,J,ee),i.clearColor(0,0,0,Number(!e.alpha)),i.clearDepth(1),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.enable(i.CULL_FACE),i.cullFace(i.BACK),i.frontFace(i.CCW)}setSize(e,t){this.width=e,this.height=t,this.updateCanvasDimensions()}setPixelRatio(e){this.pixelRatio=e,this.updateCanvasDimensions()}updateCanvasDimensions(){this.options.canvas.setAttribute("width",Math.ceil(this.width*this.pixelRatio).toString()),this.options.canvas.setAttribute("height",Math.ceil(this.height*this.pixelRatio).toString())}setClearColor(e,t,i,s){this.gl.clearColor(e,t,i,s)}render(e,t,i=null,s=!0){if(!e.compiled)throw new Error("Scene not compiled! Can't render it.");if(!e.preparedForRender)throw new Error("Scene not prepared for render! Can't render it.");let{gl:n}=this;this.drawCalls=0,i?(n.bindFramebuffer(n.FRAMEBUFFER,i.framebuffer),n.viewport(0,0,i.width,i.height)):(n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,Math.ceil(this.width*this.pixelRatio),Math.ceil(this.height*this.pixelRatio))),this.currentFramebuffer=i,n.depthMask(!0),n.clear(n.DEPTH_BUFFER_BIT),s&&n.clear(n.COLOR_BUFFER_BIT);let a=new Float32Array(t.matrixWorldInverse.elements),r=new Float32Array(t.projectionMatrix.elements),o=new Float32Array(t.projectionMatrix.clone().invert().elements),l=2/(Math.log(t.far+1)/Math.LN2),h=new Float32Array(t.position.toArray());for(let t of e.allDefineChunks){let i=this.materialShaders.get(t);i.use(),n.uniformMatrix4fv(i.getUniformLocation("viewMatrix"),!1,a),n.uniformMatrix4fv(i.getUniformLocation("projectionMatrix"),!1,r),n.uniformMatrix4fv(i.getUniformLocation("inverseProjectionMatrix"),!1,o),n.uniform1f(i.getUniformLocation("logDepthBufFC"),l),n.uniform3fv(i.getUniformLocation("eyePosition"),h),n.uniform1i(i.getUniformLocation("meshInfoTextureWidth"),e.meshInfoTextureWidth),n.uniform1i(i.getUniformLocation("meshInfoTextureHeight"),e.meshInfoTextureHeight),n.uniform3fv(i.getUniformLocation("ambientLight"),e.ambientLightBuffer),n.uniform3fv(i.getUniformLocation("directionalLightColor"),e.directionalLightColorBuffer),n.uniform3fv(i.getUniformLocation("directionalLightDirection"),e.directionalLightDirectionBuffer),n.uniformMatrix4fv(i.getUniformLocation("directionalLightTransform"),!1,e.directionalLightTransformBuffer),n.uniform1i(i.getUniformLocation("meshInfos"),7),this.bindTexture(e.meshInfoTexture,7,n.TEXTURE_2D),n.uniform1i(i.getUniformLocation("diffuseMap"),0),n.uniform1i(i.getUniformLocation("envMap"),1),n.uniform1i(i.getUniformLocation("directionalLightShadowMap"),2),n.uniform1i(i.getUniformLocation("normalMap"),3),n.uniform1i(i.getUniformLocation("specularMap"),4),n.uniform1i(i.getUniformLocation("noiseMap"),5),n.uniform1i(i.getUniformLocation("debugMode"),Number(this.debugMode))}n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.opaqueIndexBuffer),n.disable(n.BLEND),this.renderMaterialGroups(e,e.opaqueMaterialGroups,e.opaqueIndexBuffer,!0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.transparentIndexBuffer),n.enable(n.BLEND),this.renderMaterialGroups(e,e.transparentMaterialGroups,e.transparentIndexBuffer,!1),e.particleManager&&this.renderParticles(e.particleManager,t)}renderMaterialGroups(e,t,i,s){var n,a,r,o,l,h;let{gl:d}=this;for(let c of t){if(0===c.indexGroups.length||0===c.indexGroups[0].indices.length)continue;let t=c.material;if(!t.visible)continue;let u=this.materialShaders.get(c.defineChunk);u.use(),u.bindVertexBufferGroup(e.bufferGroup),d.uniform1i(u.getUniformLocation("skipTransparent"),Number(s)),d.uniform1f(u.getUniformLocation("materialOpacity"),t.opacity),d.uniform1f(u.getUniformLocation("specularIntensity"),t.specularIntensity),d.uniform1f(u.getUniformLocation("shininess"),t.shininess),d.uniform1f(u.getUniformLocation("reflectivity"),t.reflectivity),d.uniform1f(u.getUniformLocation("secondaryMapUvFactor"),t.secondaryMapUvFactor),t.blending===ae.Normal?d.blendFunc(d.ONE,d.ONE_MINUS_SRC_ALPHA):t.blending===ae.Additive?d.blendFunc(d.SRC_ALPHA,d.ONE):t.blending===ae.Subtractve&&d.blendFunc(d.ONE,d.ONE_MINUS_SRC_ALPHA),d.depthMask(t.depthWrite),(t.receiveShadows||t.isShadow)&&(null===(n=e.directionalLights[0])||void 0===n||n.bindShadowMap()),this.bindTexture(null===(a=t.diffuseMap)||void 0===a?void 0:a.getGLTexture(this),0,d.TEXTURE_2D),this.bindTexture(null===(r=t.envMap)||void 0===r?void 0:r.glTexture,1,d.TEXTURE_CUBE_MAP),this.bindTexture(null===(o=t.normalMap)||void 0===o?void 0:o.getGLTexture(this),3,d.TEXTURE_2D),this.bindTexture(null===(l=t.specularMap)||void 0===l?void 0:l.getGLTexture(this),4,d.TEXTURE_2D),this.bindTexture(null===(h=t.noiseMap)||void 0===h?void 0:h.getGLTexture(this),5,d.TEXTURE_2D),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,i),d.drawElements(d.TRIANGLES,c.count,d.UNSIGNED_INT,c.offset*Uint32Array.BYTES_PER_ELEMENT),this.drawCalls++}}renderParticles(e,t){let{gl:i}=this,s=this.particleProgram;s.use(),s.bindVertexBufferGroup(e.bufferGroup);let n=new Float32Array(t.matrixWorldInverse.elements),a=new Float32Array(t.projectionMatrix.elements),r=2/(Math.log(t.far+1)/Math.LN2);i.uniformMatrix4fv(s.getUniformLocation("viewMatrix"),!1,n),i.uniformMatrix4fv(s.getUniformLocation("projectionMatrix"),!1,a),i.uniform1f(s.getUniformLocation("logDepthBufFC"),r),i.uniform1i(s.getUniformLocation("diffuseMap"),0),i.uniform1f(s.getUniformLocation("time"),e.currentRenderTime),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.indexBuffer),i.depthMask(!1),i.enable(i.BLEND);for(let[t,n]of e.particleGroups){if(0===n.particles.length)continue;let e=ne.getTextureFromCache(t.texture);this.bindTexture(e.getGLTexture(this),0,i.TEXTURE_2D),t.blending===ae.Normal?i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA):t.blending===ae.Additive?i.blendFunc(i.SRC_ALPHA,i.ONE):t.blending===ae.Subtractve&&i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.uniform1f(s.getUniformLocation("acceleration"),n.uniforms.acceleration),i.uniform1f(s.getUniformLocation("spinSpeed"),n.uniforms.spinSpeed),i.uniform1f(s.getUniformLocation("dragCoefficient"),n.uniforms.dragCoefficient),i.uniform4fv(s.getUniformLocation("times"),n.uniforms.times),i.uniform4fv(s.getUniformLocation("sizes"),n.uniforms.sizes),i.uniformMatrix4fv(s.getUniformLocation("colors"),!1,n.uniforms.colors),s.bindVertexBuffer(n.vertexBuffer),i.drawElements(i.TRIANGLES,6*n.particles.length,i.UNSIGNED_INT,0),this.drawCalls++}}bindTexture(e,t,i){var s;let{gl:n}=this;n.activeTexture(n.TEXTURE0+t),(null===(s=this.currentFramebuffer)||void 0===s?void 0:s.colorTexture)!==e&&e?n.bindTexture(i,e):n.bindTexture(i,null)}createVertexArray(){let{gl:e}=this,t=this.extensions.OES_vertex_array_object;return e instanceof WebGLRenderingContext?t.createVertexArrayOES():e.createVertexArray()}bindVertexArray(e){let{gl:t}=this,i=this.extensions.OES_vertex_array_object;t instanceof WebGLRenderingContext?i.bindVertexArrayOES(e):t.bindVertexArray(e)}deleteVertexArray(e){let{gl:t}=this,i=this.extensions.OES_vertex_array_object;t instanceof WebGLRenderingContext?i.deleteVertexArrayOES(e):t.deleteVertexArray(e)}cleanUp(){for(let[,e]of this.materialShaders)e.cleanUp()}}const le=document.querySelector("#main-canvas");let he;let de=1;const ce=(e,t)=>Math.max(1,640/e,600/t),ue=async(e=!0)=>{var i,s;e&&await P.wait(100);let n=ce(window.innerWidth,window.innerHeight);if(document.body.style.width=Math.ceil(window.innerWidth*n)+"px",document.body.style.height=Math.ceil(window.innerHeight*n)+"px",document.body.style.transform=`scale(${1/n})`,de=n,t.level&&t.level.offline)return;let a=Math.min(window.devicePixelRatio,[.5,1,1.5,2,1/0][null===(i=K.data)||void 0===i?void 0:i.settings.pixelRatio]);le.style.width="100%",le.style.height="100%",null===he||void 0===he||he.setSize(window.innerWidth,window.innerHeight),null===he||void 0===he||he.setPixelRatio(a),null===(s=t.level)||void 0===s||s.onResize(window.innerWidth,window.innerHeight,Math.max(a,1))};window.addEventListener("resize",ue),ue();let me=!1;const pe=document.querySelector("#fullscreen-enforcer");pe.addEventListener("click",()=>{document.documentElement.requestFullscreen()}),pe.querySelector("img").addEventListener("click",e=>{me=!0,pe.classList.add("hidden"),e.stopPropagation()});const ge=document.querySelector("#enter-fullscreen");ge.addEventListener("click",()=>{document.documentElement.requestFullscreen(),me=!1});let fe=!0;const ye=e=>{fe=e,e&&P.isTouchDevice&&!P.isSafari()&&!P.isInFullscreen()?ge.classList.remove("hidden"):ge.classList.add("hidden")};let be=-1/0;setInterval(()=>{var e,t;"INPUT"===(null===(e=document.activeElement)||void 0===e?void 0:e.tagName)&&(be=performance.now()),P.isTouchDevice&&!P.isSafari()&&(P.isInFullscreen()?pe.classList.add("hidden"):!me&&"INPUT"!==(null===(t=document.activeElement)||void 0===t?void 0:t.tagName)&&performance.now()-be>666&&pe.classList.remove("hidden")),ye(fe)},250),window.addEventListener("dragstart",e=>{var t;"IMG"===(null===(t=e.target.nodeName)||void 0===t?void 0:t.toUpperCase())&&e.preventDefault()});const ve={x:0,y:0};window.addEventListener("mousemove",e=>{var i;ve.x=e.clientX*de,ve.y=e.clientY*de,null===(i=t.level)||void 0===i||i.onMouseMove(e)}),window.addEventListener("touchstart",e=>{let t=e.changedTouches[0];ve.x=t.clientX*de,ve.y=t.clientY*de}),window.addEventListener("touchmove",e=>{let t=e.changedTouches[0];ve.x=t.clientX*de,ve.y=t.clientY*de}),window.addEventListener("mousedown",e=>{if(!K.data)return;!t.level||t.level.offline||t.level.paused||t.level.finishTime||P.isTouchDevice||P.requestPointerLock();let i=["LMB","MMB","RMB"][e.button];if(i&&document.pointerLockElement)for(let e in K.data.settings.gameButtonMapping){let s=e;i===K.data.settings.gameButtonMapping[s]&&(Se(s,i,!0),t.level&&("jump"===s&&ke(s)&&(t.level.jumpQueued=!0),"use"===s&&ke(s)&&(t.level.useQueued=!0),"blast"===s&&ke(s)&&(t.level.blastQueued=!0)))}}),window.addEventListener("mouseup",e=>{if(!K.data)return;let t=["LMB","MMB","RMB"][e.button];if(t)for(let e in K.data.settings.gameButtonMapping){let i=e;t===K.data.settings.gameButtonMapping[i]&&Se(i,t,!1)}}),window.addEventListener("keydown",e=>{if(K.data)for(let i in K.data.settings.gameButtonMapping){let s=i;e.code===K.data.settings.gameButtonMapping[s]&&(Se(s,e.code,!0),t.level&&("jump"===s&&ke(s)&&(t.level.jumpQueued=!0),"use"===s&&ke(s)&&(t.level.useQueued=!0)))}}),window.addEventListener("keyup",e=>{if(K.data)for(let t in K.data.settings.gameButtonMapping){let i=t;e.code===K.data.settings.gameButtonMapping[i]&&Se(i,e.code,!1)}}),window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("beforeunload",e=>{t.level&&(e.preventDefault(),e.returnValue="")}),document.addEventListener("pointerlockchange",()=>{var e;document.pointerLockElement||null===(e=t.level)||void 0===e||e.pause()});const we={up:[],down:[],left:[],right:[],jump:[],use:[],cameraUp:[],cameraDown:[],cameraLeft:[],cameraRight:[],freeLook:[],restart:[],pause:[],blast:[]},xe={up:!1,down:!1,left:!1,right:!1,jump:!1,use:!1,cameraUp:!1,cameraDown:!1,cameraLeft:!1,cameraRight:!1,freeLook:!1,restart:!1,pause:!1,blast:!1},Se=(e,t,i)=>{let s=we[e].includes(t);!i&&s?we[e]=we[e].filter(e=>e!==t):i&&!s&&(we[e].push(t),xe[e]=!0)},Te=e=>we[e].length>0,Me=e=>void 0!==we[e].find(e=>e.startsWith("gamepadButton")),ke=e=>1===we[e].length,Ce=e=>xe[e],Ee=e=>{xe[e]=!1},Ae=()=>{for(let e in we)"pause"!==e&&(we[e]=[])},Be={marbleX:0,marbleY:0,cameraX:0,cameraY:0},Pe=["marbleX","marbleY","cameraX","cameraY"],Ie=["jump","use","blast","","","blast","jump","use","restart","pause","","","up","down","left","right","",""];let Le=0;const _e=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];window.setInterval(()=>{var e,i;let s=[...navigator.getGamepads()].filter(e=>e);if(0!==s.length){for(let e=0;e<s.length;e++)for(let t=0;t<s[e].buttons.length;t++)if(s[e].buttons[t].value>.5){Le=e;break}for(let e=0;e<s[Le].buttons.length&&e<18;e++){let t=s[Le].buttons[e].value>.5,i=Ie[e];""!==i&&Se(i,"gamepadButton"+e,t)}for(let e=0;e<s[Le].axes.length&&e<4;e++){let t=Pe[e];""!==t&&(Be[t]=s[Le].axes[e],Math.abs(Be[t])<.1&&(Be[t]=0))}(null===(e=t.menu)||void 0===e?void 0:e.levelSelect)&&!t.menu.levelSelect.div.classList.contains("hidden")&&t.menu.levelSelect.handleControllerInput(s[Le]),(null===(i=t.level)||void 0===i?void 0:i.paused)&&t.menu.pauseScreen.handleGamepadInput(s[Le]);for(let e=0;e<s[Le].buttons.length&&e<18;e++)_e[e]=s[Le].buttons[e].value>.5}else for(let e in Be)Be[e]=0},4);const Re=document.querySelector("#touch-input-container"),Fe=document.querySelector("#movement-area"),Ue=document.querySelector("#camera-area"),ze=document.querySelector("#movement-joystick"),De=document.querySelector("#movement-joystick-handle"),Ve=document.querySelector("#action-buttons"),Oe=document.querySelector("#jump-button"),Ne=document.querySelector("#use-button"),qe=document.querySelector("#blast-button"),je=document.querySelector("#pause-button"),Ge=document.querySelector("#restart-button"),We=document.querySelector("#free-look-button"),He=.4;let Xe=null,Ye=null,Ke=null,Qe=null,$e=null,Ze=[],Je=!1;const et=e=>{Je=e};let tt=[];const it=(e,t,i,s,n)=>{let a=null;e.addEventListener("touchstart",s=>{var r;let o=s.changedTouches[0];a=o.identifier;let l=null===(r=null===n||void 0===n?void 0:n().enabled)||void 0===r||r;e.style.opacity=l?"0.9":"0.4",Se(t,"touch",!0),null===i||void 0===i||i(o)}),tt.push((i,r)=>{var o;(r||i.identifier===a)&&(a=null,e.style.opacity=null!==(o=null===n||void 0===n?void 0:n().opacity)&&void 0!==o?o:"",Se(t,"touch",!1),null===s||void 0===s||s(i))})},st=e=>{Qe=e.identifier,$e=e},nt=e=>{st(e),Ze.push(e)},at=e=>{Ze.splice(Ze.indexOf(e),1)};it(Oe,"jump",nt,at),it(Ne,"use",nt,at,()=>({opacity:Je?"0.5":"0.2",enabled:Je})),it(qe,"blast",nt,at,()=>({opacity:"0.2",enabled:!1})),it(je,"pause"),it(Ge,"restart"),it(We,"freeLook");const rt=()=>{Re.style.display="none"},ot=()=>{Re.style.display=P.isTouchDevice?"block":"none"},lt=e=>{"normal"===e?[ze,Oe,Ne,qe,We].forEach(e=>e.style.display=""):"replay"===e&&[ze,Oe,Ne,qe,We].forEach(e=>e.style.display="none")};Fe.addEventListener("touchstart",e=>{let t,i,s=e.changedTouches[0];Ke=s.identifier;let n=K.data.settings.joystickSize;0===K.data.settings.joystickPosition?(t=K.data.settings.joystickLeftOffset+n/2,i=window.innerHeight*(1-K.data.settings.joystickVerticalPosition)*de):(t=P.clamp(s.clientX*de,n/2,(window.innerWidth*de-n)/2),i=P.clamp(s.clientY*de,n/2,window.innerHeight*de-n/2)),ze.style.visibility="visible",ze.style.left=t-n/2+"px",ze.style.top=i-n/2+"px",Xe={x:t,y:i},Ye={x:0,y:0},ht(s)}),Fe.addEventListener("touchmove",e=>{let t=[...e.changedTouches].find(e=>e.identifier===Ke);t&&t.identifier===Ke&&ht(t)});const ht=e=>{let t=K.data.settings.joystickSize,i=He*K.data.settings.joystickSize,s=(t-i)/2;Ye.x=P.clamp((e.clientX*de-Xe.x)/s,-1,1),Ye.y=P.clamp((e.clientY*de-Xe.y)/s,-1,1),De.style.left=Ye.x*s+t/2-i/2+"px",De.style.top=Ye.y*s+t/2-i/2+"px"};window.addEventListener("touchend",e=>{for(let t of e.changedTouches){t.identifier===Ke&&(Ke=null,ze.style.visibility="hidden",Ye=null),t.identifier===Qe&&(Qe=null);for(let e of tt)e(t,!1)}if(0===e.touches.length){Ke=null,ze.style.visibility="hidden",Ye=null,Qe=null;for(let e of tt)e(null,!0)}}),Ue.addEventListener("touchstart",e=>{let t=e.changedTouches[0];st(t)}),Re.addEventListener("touchmove",e=>{let i=[...e.changedTouches].find(e=>e.identifier===Qe),s=t.level;if(i&&i.identifier===Qe){let e=(i.clientX-$e.clientX)*de,t=(i.clientY-$e.clientY)*de,n=P.lerp(1/1500,.02,K.data.settings.mouseSensitivity)*(0!==Ze.length?K.data.settings.actionButtonAsJoystickMultiplier:1),a=2&K.data.settings.invertMouse?-1:1,r=K.data.settings.alwaysFreeLook||Te("freeLook");s.yaw-=e*n,r&&(s.pitch+=t*n*a),$e=i}});const dt=48e3,ct=new Map,ut=new Map;class mt{constructor(){this.audioSources=[],this.currentTimeOverride=null}get currentTime(){var e;return null!==(e=this.currentTimeOverride)&&void 0!==e?e:this.context.currentTime}init(e){window.AudioContext?this.context=e?new OfflineAudioContext(2,e.duration*dt,dt):new AudioContext:this.context=e?new window.webkitOfflineAudioContext(2,e.duration*dt,dt):new window.webkitAudioContext,this.masterGain=this.context.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this.context.destination),this.soundGain=this.context.createGain(),this.soundGain.gain.value=0,this.soundGain.connect(this.masterGain),this.musicGain=this.context.createGain(),this.musicGain.gain.value=0,this.musicGain.connect(this.masterGain),e||this.updateVolumes(),window.onfocus=(()=>{P.isTouchDevice&&(this.masterGain.gain.value=1)}),window.onblur=(()=>{P.isTouchDevice&&(this.masterGain.gain.value=0)})}setAssetPath(e){this.assetPath=e}toFullPath(e){return this.assetPath+e}async loadBuffer(e){var i;let s,n=this.toFullPath(e),a=null===(i=t.level)||void 0===i?void 0:i.mission;if(a&&a.zipDirectory&&a.zipDirectory.files["data/sound/"+e])s=a.zipDirectory.files["data/sound/"+e];else if(await ct.get(n),ut.has(n))return ut.get(n);let r=(async()=>{let t,i=s?await s.async("blob"):await ne.loadResource(n),a=await ne.readBlobAsArrayBuffer(i);if(e.endsWith(".ogg")&&P.isSafari())t=await gt.decodeOggData(a);else if(window.AudioContext)try{t=await this.context.decodeAudioData(a)}catch(e){t=await gt.decodeOggData(a)}else t=await new Promise((e,t)=>{this.context.decodeAudioData(a,t=>e(t),e=>t(e))});return ut.set(n,t),ct.delete(n),t})();return s||ct.set(n,r),r}loadBuffers(e){return Promise.all(e.map(e=>this.loadBuffer(e)))}createAudioSource(e,t=this.soundGain,i,s=!1){let n,a="string"==typeof e?e:P.randomFromArray(e),r=this.toFullPath(a);if(a.endsWith(".ogg")&&P.isSafari()&&(s=!1),s)if(ut.has(r))s=!1;else{let e=new Audio;e.src=r,e.preload="auto",n=new pt(this,e,t,i)}if(!s){let e=this.loadBuffer(a);n=new pt(this,e,t,i)}return i&&n.gain.gain.setValueAtTime(0,this.currentTime),this.audioSources.push(n),n}play(e,t=1,i=this.soundGain,s){let n=this.createAudioSource(e,i,s);n.gain.gain.setValueAtTime(s?0:t,this.currentTime),n.play()}updatePositionalAudio(e,i,n){let a=t.level.getOrientationQuat(e);a.conjugate();for(let e of this.audioSources){if(!e.position)continue;let t=e.position.clone().sub(i);t.applyQuaternion(a),t.applyAxisAngle(new s(0,0,1),-n),t.normalize(),t.z=0;let r=e.position.distanceTo(i),o=P.clamp(r/1,0,1);e.setPannerValue(.7*-t.y*o),e.gain.gain.setValueAtTime(P.clamp(1-r/30,0,1)*e.gainFactor,this.currentTime)}}updateVolumes(){this.musicGain.gain.linearRampToValueAtTime(K.data.settings.musicVolume**2,this.currentTime+.01),this.soundGain.gain.linearRampToValueAtTime(K.data.settings.soundVolume**2,this.currentTime+.01)}stopAllAudio(){for(let e of this.audioSources.slice())e.stop()}normalizePositionalAudioVolume(){let e=this.audioSources.filter(e=>e.position);for(let t=0;t<e.length;t++){let i=e[t],s=0;for(let n=0;n<e.length;n++){if(t===n)continue;let a=e[n],r=i.position.distanceTo(a.position);s+=P.clamp(1-r/30,0,1)}i.gainFactor=Math.min(1/s,1)}}}class pt{constructor(e,t,i,s){this.stopped=!1,this.playing=!1,this.gainFactor=1,this.loop=!1,this.playbackRate=1,this.manager=e,t instanceof Promise?this.promise=t:(this.audioElement=t,this.promise=new Promise(e=>{t.addEventListener("canplaythrough",()=>e())})),this.destination=i,this.position=s,this.gain=this.manager.context.createGain(),this.manager.context.createStereoPanner?this.panner=this.manager.context.createStereoPanner():this.panner=this.manager.context.createPanner(),this.gain.connect(this.panner),this.panner.connect(this.destination),t instanceof Promise?this.node=this.manager.context.createBufferSource():this.node=this.manager.context.createMediaElementSource(t),this.node.connect(this.gain)}setPannerValue(e){this.manager.context.createStereoPanner?this.panner.pan.setValueAtTime(e,this.manager.currentTime):(this.panner.panningModel="equalpower",this.panner.setPosition(e,0,1-Math.abs(e)))}setLoop(e){this.audioElement?this.audioElement.loop=e:this.node.loop=e,this.loop=e}setPlaybackRate(e){this.audioElement?this.audioElement.playbackRate=e:this.node.playbackRate.setValueAtTime(e,this.manager.currentTime),this.playbackRate=e}async play(){var e,t;if(this.playing)return;this.stopped&&(this.stopped=!1,this.node instanceof AudioBufferSourceNode&&(this.node=this.manager.context.createBufferSource(),this.node.connect(this.gain),this.node.loop=this.loop,this.node.playbackRate.setValueAtTime(this.playbackRate,this.manager.currentTime),this.stopped=!1,this.manager.audioSources.push(this)));let i=await this.promise;if(!this.stopped){if(this.node instanceof AudioBufferSourceNode){if(this.node.buffer)return;this.node.buffer=i,this.node.start(this.manager.currentTime),this.node.onended=(()=>{this.stop()})}else null===(e=this.audioElement)||void 0===e||e.play(),null===(t=this.audioElement)||void 0===t||t.addEventListener("ended",()=>this.stop());this.playing=!0}}stop(){if(!this.stopped){this.stopped=!0,this.playing=!1;try{this.audioElement?(this.audioElement.pause(),this.audioElement.currentTime=0,this.audioElement.load()):this.node.stop(this.manager.currentTime)}catch(e){}P.removeFromArray(this.manager.audioSources,this)}}}const gt=OggdecModule(),ft=new mt;class yt{constructor(){this.positions=[],this.normals=[],this.uvs=[],this.indices=[],this.materials=[]}fillRest(){for(;this.normals.length/3<this.positions.length/3;)this.normals.push(0,0,0);for(;this.uvs.length/2<this.positions.length/3;)this.uvs.push(0,0)}validate(){if(1!==new Set([this.positions.length/3,this.normals.length/3,this.uvs.length/2]).size)throw console.error(this),new Error(`Geometry is invalid (vertex counts don't match):\nPositions: ${this.positions.length/3}\nNormals: ${this.normals.length/3}\nUvs: ${this.uvs.length/2},\nMaterial Indices: ${this.materials.length/1}\n\t\t\t`);for(let e=0;e<this.indices.length;e++){if(this.indices[e]>=this.positions.length/3)throw console.error(this),new Error("Geometry is invalid (index points out of bounds)")}let e=this.indices.length;if(e%3)throw new Error("Geometry is invalid (triangle count isn't a whole number): "+e/3)}static createSphereGeometry(e=1,t=32,i=16,n=0,a=2*Math.PI,r=0,o=Math.PI){let l=new yt;t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const h=Math.min(r+o,Math.PI);let d=0;const c=[],u=new s,m=new s,p=[],g=[],f=[];for(let s=0;s<=i;s++){const l=[],y=s/i;let b=0;0===s&&0===r?b=.5/t:s===i&&h===Math.PI&&(b=-.5/t);for(let i=0;i<=t;i++){const s=i/t;u.x=-e*Math.cos(n+s*a)*Math.sin(r+y*o),u.y=e*Math.cos(r+y*o),u.z=e*Math.sin(n+s*a)*Math.sin(r+y*o),p.push(u.x,u.y,u.z),m.copy(u).normalize(),g.push(m.x,m.y,m.z),f.push(s+b,1-y),l.push(d++)}c.push(l)}P.pushArray(l.positions,p),P.pushArray(l.normals,g),P.pushArray(l.uvs,f);for(let e=0;e<i;e++)for(let s=0;s<t;s++){const t=c[e][s+1],n=c[e][s],a=c[e+1][s],o=c[e+1][s+1];(0!==e||r>0)&&l.indices.push(t,n,o),(e!==i-1||h<Math.PI)&&l.indices.push(n,a,o)}return P.pushArray(l.materials,Array(l.indices.length).fill(0)),l}}const bt=new d;class vt{constructor(){this.parent=null,this.transform=new d,this.position=new s,this.orientation=new i,this.scale=new s(1,1,1),this.worldTransform=new d,this.needsWorldTransformUpdate=!0}updateWorldTransform(){var e,t;this.worldTransform.copy(null!==(t=null===(e=this.parent)||void 0===e?void 0:e.worldTransform)&&void 0!==t?t:bt).multiply(this.transform),this.needsWorldTransformUpdate=!1,this.transform.decompose(this.position,this.orientation,this.scale)}changedTransform(){this.needsWorldTransformUpdate=!0;let e=this.parent;for(;e&&!e.needsWorldTransformUpdate;)e.needsWorldTransformUpdate=!0,e=e.parent}recomputeTransform(){this.transform.compose(this.position,this.orientation,this.scale),this.changedTransform()}}class wt extends vt{constructor(e,t){super(),this.needsMeshInfoBufferUpdate=!0,this.needsVertexBufferUpdate=!1,this._opacity=1,this.castShadows=!1,this.materialIndices=[],this.hasTransparentMaterials=!1,this.geometry=e,this.materials=t}changedTransform(){this.needsWorldTransformUpdate||(super.changedTransform(),this.needsMeshInfoBufferUpdate=!0)}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this.needsMeshInfoBufferUpdate=!0)}updateMeshInfoBuffer(e,t){e.set(this.worldTransform.elements,t),e[t+3]=this._opacity;e[t+7]=0,this.needsMeshInfoBufferUpdate=!1}compileMaterialIndices(){let e=new Map;for(let t=0;t<this.geometry.indices.length;t++){let i=this.geometry.materials[t],s=this.materials[i],n=e.get(s);n||(n={material:s,indices:[]},e.set(s,n),this.materialIndices.push(n));let a=this.geometry.indices[t];n.indices.push(this.vboOffset+a)}for(let e of this.materialIndices)e.indexBuffer=new Uint32Array(e.indices)}}class xt{constructor(){this.differentiator="",this.diffuseMap=null,this.envMap=null,this.normalMap=null,this.specularMap=null,this.noiseMap=null,this.emissive=!1,this.transparent=!1,this.depthWrite=!0,this.opacity=1,this.blending=ae.Normal,this.normalizeNormals=!1,this.invertU=!1,this.flipY=!1,this.isSky=!1,this.isShadow=!1,this.receiveShadows=!1,this.reflectivity=0,this.envMapZUp=!0,this.useFresnel=!1,this.useAccurateReflectionRay=!1,this.specularIntensity=0,this.shininess=30,this.saturateIncomingLight=!0,this.visible=!0,this.renderOrder=0,this.secondaryMapUvFactor=1,this.hashCache=null,this.defineChunkCache=null}getHash(){var e,t,i,s,n;if(this.hashCache)return this.hashCache;let a=[this.differentiator,null===(e=this.diffuseMap)||void 0===e?void 0:e.id,null===(t=this.envMap)||void 0===t?void 0:t.id,null===(i=this.normalMap)||void 0===i?void 0:i.id,null===(s=this.specularMap)||void 0===s?void 0:s.id,null===(n=this.noiseMap)||void 0===n?void 0:n.id,this.emissive,this.transparent,this.depthWrite,this.opacity,this.blending,this.normalizeNormals,this.invertU,this.flipY,this.isSky,this.isShadow,this.receiveShadows,this.reflectivity,this.envMapZUp,this.useFresnel,this.specularIntensity,this.shininess,this.saturateIncomingLight,this.renderOrder,this.secondaryMapUvFactor];return this.hashCache=a.map(e=>""+e).join(" ")}getDefineChunk(){if(this.defineChunkCache)return this.defineChunkCache;let e=[];return this.diffuseMap&&e.push("USE_DIFFUSE_MAP"),this.envMap&&e.push("USE_ENV_MAP"),this.normalMap&&e.push("USE_NORMAL_MAP"),this.specularMap&&e.push("USE_SPECULAR_MAP"),this.noiseMap&&e.push("USE_NOISE_MAP"),this.emissive&&e.push("EMISSIVE"),this.transparent&&e.push("TRANSPARENT"),this.normalizeNormals&&e.push("NORMALIZE_NORMALS"),this.invertU&&e.push("INVERT_U"),this.flipY&&e.push("FLIP_Y"),this.isSky&&e.push("IS_SKY"),this.isShadow&&e.push("IS_SHADOW"),this.receiveShadows&&e.push("RECEIVE_SHADOWS"),this.envMapZUp&&e.push("ENV_MAP_Z_UP"),this.useFresnel&&e.push("USE_FRESNEL"),this.useAccurateReflectionRay&&e.push("USE_ACCURATE_REFLECTION_RAY"),this.specularIntensity&&e.push("USE_SPECULAR"),this.saturateIncomingLight&&e.push("SATURATE_INCOMING_LIGHT"),this.blending===ae.Normal&&e.push("USE_PREMULTIPLIED_ALPHA"),this.defineChunkCache=e.map(e=>`#define ${e}\n`).join("")}}var St;!function(e){e[e.Dynamic=0]="Dynamic",e[e.Static=1]="Static"}(St||(St={}));let Tt=new i,Mt=new s,kt=new i;class Ct{constructor(){this.world=null,this.type=St.Dynamic,this.enabled=!0,this.position=new s,this.orientation=new i,this.linearVelocity=new s,this.angularVelocity=new s,this.prevPosition=new s,this.prevOrientation=new i,this.prevLinearVelocity=new s,this.prevAngularVelocity=new s,this.prevValid=!1,this.shapes=[],this.collisions=[],this.evaluationOrder=0}transformPoint(e){return e.applyQuaternion(this.orientation).add(this.position)}transformPointInv(e){return kt.copy(this.orientation).conjugate(),e.sub(this.position).applyQuaternion(kt)}integrate(e){if(this.type!==St.Dynamic)return;let t=this.linearVelocity.clone().multiplyScalar(e),i=this.angularVelocity.clone().multiplyScalar(e);0===t.lengthSq()&&0===i.lengthSq()||(this.applyTranslation(t),this.applyRotation(i),this.syncShapes())}applyTranslation(e){this.position.add(e)}applyRotation(e){Tt.setFromAxisAngle(Mt.copy(e).normalize(),e.length()),this.orientation.multiplyQuaternions(Tt,this.orientation).normalize()}storePrevious(){this.prevPosition.copy(this.position),this.prevOrientation.copy(this.orientation),this.prevValid=!0}revert(e){let t=this.position.equals(this.prevPosition),i=this.orientation.equals(this.prevOrientation);t&&i||(this.position.lerpVectors(this.prevPosition,this.position,e),kt.copy(this.orientation),this.orientation.copy(this.prevOrientation).slerp(kt,e))}addCollisionShape(e){if(e.body)throw new Error("Shape has already been added to a RigidBody.");this.shapes.push(e),e.body=this,e.updateBoundingBox(),this.type===St.Static&&(e.mass=1/0,e.invInertia.multiplyScalar(0))}removeCollisionShape(e){this.shapes.includes(e)&&(P.removeFromArray(this.shapes,e),e.body=null)}syncShapes(){for(let e=0;e<this.shapes.length;e++){this.shapes[e].updateBoundingBox()}}getRelativeMotionVector(e,t){return e.copy(this.position).sub(this.prevPosition).sub(t.position).add(t.prevPosition)}onBeforeIntegrate(e){}onAfterIntegrate(e){}onBeforeCollisionResponse(e,t){}onAfterCollisionResponse(e,t){}}const Et=new s,At=new s,Bt=new h;class Pt{constructor(e=new s(1,0,0),t=0){this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,s){return this.normal.set(e,t,i),this.constant=s,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const s=Et.subVectors(i,t).cross(At.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}projectPoint(e,t){return t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||Bt.getNormalMatrix(e),s=this.coplanarPoint(Et).applyMatrix4(e),n=this.normal.applyMatrix3(i).normalize();return this.constant=-s.dot(n),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new Pt).copy(this)}}const It=1,Lt=1,_t=Math.cos(P.degToRad(15)),Rt={friction_high:1.5,friction_low:.2,friction_none:.01,friction_ramp_yellow:2,grass:1.5,mmg_grass:.9,tarmac:.35,sand:4,mmg_sand:6,carpet:6,rug:6,water:6,mmg_water:6,ice1:.03,mmg_ice:.03,floor_bounce:.2,mbp_chevron_friction:0,mbp_chevron_friction2:0,mbp_chevron_friction3:0},Ft={friction_high:.5,friction_low:.5,friction_none:.5,grass:.35,mmg_grass:.5,tarmac:.7,sand:.1,mmg_sand:.1,carpet:.5,rug:.5,water:0,mmg_water:0,ice1:.95,mmg_ice:.95},Ut={floor_bounce:15},zt=new Set([...Object.keys(Rt),...Object.keys(Ft),...Object.keys(Ut)]),Dt=async(e,t,i)=>{let s=await e.level.mission.getTexture(`interiors_mbu/${t}`),n=await e.level.mission.getTexture(`shaders/tex/${i}`),a=new xt;return a.normalMap=n,a.diffuseMap=s,a.saturateIncomingLight=!1,a.receiveShadows=!0,a.invertU=!0,a},Vt=async(e,t,i,s,n,a,r=1,o=!0)=>{let l=i&&await e.level.mission.getTexture(`shaders/tex/${i}`),h=s&&await e.level.mission.getTexture(`shaders/tex/${s}`),d=await e.level.mission.getTexture(`interiors_mbu/${t}`),c=new xt;return c.diffuseMap=d,c.specularMap=l,c.normalMap=h,c.shininess=n,c.specularIntensity=a,c.secondaryMapUvFactor=r,c.saturateIncomingLight=!1,c.receiveShadows=!0,c.invertU=o,c},Ot=async(e,t,i)=>{let s=await e.level.mission.getTexture(`interiors_mbu/${t}`),n=await e.level.mission.getTexture("shaders/tex/tile_mbu.spec.jpg"),a=await e.level.mission.getTexture(`shaders/tex/noise${i}.jpg`),r=await e.level.mission.getTexture("shaders/tex/tile_mbu.normal.png"),o=new xt;return o.diffuseMap=s,o.specularMap=n,o.normalMap=r,o.noiseMap=a,o.shininess=40,o.specularIntensity=.7,o.saturateIncomingLight=!1,o.receiveShadows=!0,o.invertU=!0,o},Nt={plate_1:e=>Vt(e,"plate_1.jpg","plate_mbu.spec.jpg","plate_mbu.normal.png",30,.5),tile_beginner:e=>Ot(e,"tile_beginner.png",""),tile_beginner_shadow:e=>Ot(e,"tile_beginner_shadow.png",""),tile_beginner_red:e=>Ot(e,"tile_beginner_red.jpg",""),tile_beginner_red_shadow:e=>Ot(e,"tile_beginner_red_shadow.png",""),tile_beginner_blue:e=>Ot(e,"tile_beginner_blue.jpg",""),tile_beginner_blue_shadow:e=>Ot(e,"tile_beginner_blue_shadow.png",""),tile_intermediate:e=>Ot(e,"tile_intermediate.png",""),tile_intermediate_shadow:e=>Ot(e,"tile_intermediate_shadow.png",""),tile_intermediate_red:e=>Ot(e,"tile_intermediate_red.jpg",""),tile_intermediate_red_shadow:e=>Ot(e,"tile_intermediate_red_shadow.png",""),tile_intermediate_green:e=>Ot(e,"tile_intermediate_green.jpg",""),tile_intermediate_green_shadow:e=>Ot(e,"tile_intermediate_green_shadow.png",""),tile_advanced:e=>Ot(e,"tile_advanced.png",""),tile_advanced_shadow:e=>Ot(e,"tile_advanced_shadow.png",""),tile_advanced_blue:e=>Ot(e,"tile_advanced_blue.jpg",""),tile_advanced_blue_shadow:e=>Ot(e,"tile_advanced_blue_shadow.png",""),tile_advanced_green:e=>Ot(e,"tile_advanced_green.jpg",""),tile_advanced_green_shadow:e=>Ot(e,"tile_advanced_green_shadow.png",""),tile_underside:e=>Ot(e,"tile_underside.jpg",""),wall_beginner:e=>Vt(e,"wall_beginner.png","wall_mbu.spec.png","wall_mbu.normal.png",30,.5),edge_white:e=>Vt(e,"edge_white.jpg","edge_white_mbu.spec.jpg","edge_white_mbu.normal.jpg",50,4,1,!1),edge_white_shadow:e=>Vt(e,"edge_white_shadow.png","edge_white_mbu.spec.jpg","edge_white_mbu.normal.jpg",50,4,1,!1),beam:e=>Dt(e,"beam.png","beam_side_mbu.normal.png"),beam_side:e=>Dt(e,"beam_side.png","beam_side_mbu.normal.png"),friction_low:e=>Vt(e,"friction_low.jpg",null,"friction_low_mbu.normal.png",100,3),friction_low_shadow:e=>Vt(e,"friction_low_shadow.png",null,"friction_low_mbu.normal.png",100,3),friction_high:e=>Vt(e,"friction_high.png","friction_high_mbu.spec.png","friction_high_mbu.normal.png",30,.8,2),friction_high_shadow:e=>Vt(e,"friction_high_shadow.png","friction_high_mbu.spec.png","friction_high_mbu.normal.png",30,.8,2)};class qt{constructor(e,t,i,s){this.worldMatrix=new d,this.materialNames=[],this.allowSpecialMaterials=!0,this.dif=e,this.difPath=t,this.level=i,this.detailLevel=void 0===s?e.detailLevels[0]:e.subObjects[s],this.materialNames=this.detailLevel.materialList.materials.map(e=>e.split("/").pop().toLowerCase()),this.body=new Ct,this.body.type=St.Static,this.body.onAfterCollisionResponse=((e,t)=>{for(let e of this.body.collisions)this.onMarbleContact(e,t)}),this.specialMaterials=new Set([...zt,...Object.keys(this.level.mission.misFile.materialMappings)])}async init(e){this.id=e,await qt.initCachePromises.get(this.detailLevel);let t=qt.initCache.get(this.detailLevel);if(t&&t.fancyShaders!==K.data.settings.fancyShaders&&(qt.initCache.delete(this.detailLevel),t=null),!t){let e,i=new Promise(t=>e=t);qt.initCachePromises.set(this.detailLevel,i);let n=[];for(let e=0;e<this.detailLevel.materialList.materials.length;e++){let t=this.detailLevel.materialList.materials[e].toLowerCase().split("/").pop();if(K.data.settings.fancyShaders&&"ultra"===this.level.mission.modification&&Nt[t]){n.push(await Nt[t](this));continue}let i=new xt;if(i.receiveShadows=!0,n.push(i),"ultra"===this.level.mission.modification&&"tools_invisible"===t){i.opacity=0;continue}let s=this.difPath.includes("data/")?this.difPath.slice(this.difPath.indexOf("data/")+"data/".length):this.difPath.slice(this.difPath.indexOf("data_mbp/")+"data_mbp/".length);const a=async()=>{let e=s;for(;e=e.slice(0,Math.max(0,e.lastIndexOf("/")));){let s=this.level.mission.getFullNamesOf(e+"/"+t);if(s.length>0){let t=s.find(e=>!e.endsWith(".dif"));if(!t)break;let n=await this.level.mission.getTexture(e+"/"+t);i.diffuseMap=n;break}}};await a(),!i.diffuseMap&&s.includes("interiors/")&&(s=s.replace("interiors/","interiors_mbp/"),await a())}let a=new yt,r=new Map;for(let e of this.detailLevel.surfaces)this.addSurface(a,e,r);for(let[,e]of r)for(let t=0;t<e.length;t++){let i=e[t],n=new s;for(let e=0;e<i.normals.length;e++)n.add(i.normals[e]);n.multiplyScalar(1/i.normals.length);for(let e=0;e<i.normalIndices.length;e++){let t=a.normals,s=i.normalIndices[e];t[s+0]=n.x,t[s+1]=n.y,t[s+2]=n.z}}t={geometry:a,materials:n,fancyShaders:K.data.settings.fancyShaders},qt.initCache.set(this.detailLevel,t),qt.initCachePromises.delete(this.detailLevel),e()}let i=new wt(t.geometry,t.materials);this.mesh=i,this.level.loadingState.loaded++}addSurface(e,t,i){let n=this.detailLevel,a=n.texGenEqs[t.texGenIndex],r=new Pt(new s(a.planeX.x,a.planeX.y,a.planeX.z),a.planeX.d),o=new Pt(new s(a.planeY.x,a.planeY.y,a.planeY.z),a.planeY.d),l=n.planes[-32769&t.planeIndex],h=n.normals[l.normalIndex],d=this.materialNames[t.textureIndex],c=0;for(let n=t.windingStart;n<t.windingStart+t.windingCount-2;n++){let a=this.detailLevel.windings[n],l=this.detailLevel.windings[n+1],u=this.detailLevel.windings[n+2];if(c%2==0){let e=a;a=u,u=e}let m=new s(h.x,h.y,h.z);32768&t.planeIndex&&m.negate();for(let n of[a,l,u]){let a=this.detailLevel.points[n],l=r.distanceToPoint(new s(a.x,a.y,a.z)),h=o.distanceToPoint(new s(a.x,a.y,a.z));"ultra"===this.level.mission.modification&&"plate_1"===d&&(l/=2,h/=2),e.positions.push(a.x,a.y,a.z),e.normals.push(0,0,0),e.uvs.push(l,h),e.materials.push(t.textureIndex),e.indices.push(e.indices.length);let c,u=i.get(a);u||(u=[],i.set(a,u));for(let e=0;e<u.length&&(c=u[e],!(m.dot(c.referenceNormal)>_t));e++)c=null;c||(c={referenceNormal:m,normalIndices:[],normals:[]},u.push(c)),c.normalIndices.push(e.normals.length-3),c.normals.push(m)}c++}}addConvexHull(e,t){let i=this.detailLevel.convexHulls[e],n=new Set;for(let e=i.surfaceStart;e<i.surfaceStart+i.surfaceCount;e++){let t=this.detailLevel.surfaces[this.detailLevel.hullSurfaceIndices[e]];if(!t)continue;let i=this.materialNames[t.textureIndex];i&&(this.specialMaterials.has(i)||(i=""),n.add(i))}if(0===n.size)return;let a=[];for(let e=i.hullStart;e<i.hullStart+i.hullCount;e++){let i=this.detailLevel.points[this.detailLevel.hullIndices[e]];a.push(new s(i.x*t.x,i.y*t.y,i.z*t.z))}let r=new E(a);if(1===n.size){let e=n.values().next().value,t=this.getCollisionMaterialProperties(e);r.friction=t.friction,r.restitution=t.restitution,r.userData=t}else for(let e=i.surfaceStart;e<i.surfaceStart+i.surfaceCount;e++){let t=this.detailLevel.surfaces[this.detailLevel.hullSurfaceIndices[e]];if(!t)continue;let i=this.materialNames[t.textureIndex];if(!i)continue;let n=this.detailLevel.planes[-32769&t.planeIndex],a=this.detailLevel.normals[n.normalIndex],o=new s(a.x,a.y,a.z);32768&t.planeIndex&&o.negate();let l=this.getCollisionMaterialProperties(i);r.materialOverrides.set(o,l)}this.body.addCollisionShape(r)}getCollisionMaterialProperties(e){var t,i,s,n,a;let r,o=Lt,l=Lt,h=!1;if(this.allowSpecialMaterials){let h=this.level.mission.misFile.materialProperties[this.level.mission.misFile.materialMappings[e]],d=null!==(i=null!==(t=null===h||void 0===h?void 0:h.friction)&&void 0!==t?t:Rt[e])&&void 0!==i?i:1,c=null!==(n=null!==(s=null===h||void 0===h?void 0:h.restitution)&&void 0!==s?s:Ft[e])&&void 0!==n?n:1;void 0!==(r=null!==(a=null===h||void 0===h?void 0:h.force)&&void 0!==a?a:Ut[e])&&(c=1),l*=c,o*=d}return this.allowSpecialMaterials&&(null===e||void 0===e?void 0:e.startsWith("mbp_chevron_friction"))&&(h=!0),{friction:o,restitution:l,force:r,isRandom:h}}setTransform(e,t,i){this.worldMatrix.compose(e,t,i),this.scale=i,this.mesh.transform.copy(this.worldMatrix),this.body.position.copy(e),this.body.orientation.copy(t);for(let e=0;e<this.detailLevel.convexHulls.length;e++)this.addConvexHull(e,this.scale)}onMarbleContact(e,t){let i=e.s2,s=this.level.marble,n=i.userData||i.materialOverrides.get(e.s2MaterialOverride);if(void 0!==n.force)s.setLinearVelocityInDirection(e.normal,n.force,!1),s.slidingTimeout=2;else if(n.isRandom){let i=t/(1/Za),n=s.body.angularVelocity.clone().cross(e.normal);s.body.linearVelocity.addScaledVector(n,-.0015*i),s.body.angularVelocity.multiplyScalar(1+.07*s.speedFac*i)}}tick(e){}render(e){}reset(){}async onLevelStart(){}}qt.initCache=new WeakMap,qt.initCachePromises=new WeakMap;class jt{constructor(e){this.index=0,this.buffer=e,this.view=new DataView(e)}readU8(){return this.view.getUint8(this.index++)}readU16(){return this.view.getUint16((this.index=this.index+2)-2,!0)}readU32(){return this.view.getUint32((this.index=this.index+4)-4,!0)}readS8(){return this.view.getInt8(this.index++)}readS16(){return this.view.getInt16((this.index=this.index+2)-2,!0)}readS32(){return this.view.getInt32((this.index=this.index+4)-4,!0)}readF32(){return this.view.getFloat32((this.index=this.index+4)-4,!0)}readBool(){return 1===this.readU8()}readPoint3F(){return{x:this.readF32(),y:this.readF32(),z:this.readF32()}}readBox3F(){return{min:this.readPoint3F(),max:this.readPoint3F()}}readSphereF(){return{center:this.readPoint3F(),radius:this.readF32()}}readPlaneF(){return{x:this.readF32(),y:this.readF32(),z:this.readF32(),d:this.readF32()}}readString(){let e=this.readU8(),t="";for(let i=0;i<e;i++)t+=String.fromCharCode(this.readU8());for(;0===t.charCodeAt(t.length-1);)t=t.slice(0,-1);return t}}var Gt;!function(e){e[e.Standard=0]="Standard",e[e.Skin=1]="Skin",e[e.Decal=2]="Decal",e[e.Sorted=3]="Sorted",e[e.Null=4]="Null"}(Gt||(Gt={}));class Wt{constructor(e,t,i,s){this.lastGuardValue=0,this.buf=e,this.view=new DataView(this.buf),this.index32=t,this.index16=t+4*i,this.index8=t+4*s}readU32(){let e=this.view.getUint32(this.index32,!0);return this.index32+=4,e}readS32(){let e=this.view.getInt32(this.index32,!0);return this.index32+=4,e}readF32(){let e=this.view.getFloat32(this.index32,!0);return this.index32+=4,e}readPoint2F(){return{x:this.readF32(),y:this.readF32()}}readPoint3F(){return{x:this.readF32(),y:this.readF32(),z:this.readF32()}}readBoxF(){return{min:this.readPoint3F(),max:this.readPoint3F()}}readU16(){let e=this.view.getUint16(this.index16,!0);return this.index16+=2,e}readS16(){let e=this.view.getInt16(this.index16,!0);return this.index16+=2,e}readU8(){let e=this.view.getUint8(this.index8);return this.index8+=1,e}readQuat16(){return{x:this.readS16(),y:this.readS16(),z:this.readS16(),w:this.readS16()}}readMatrixF(){return new Array(16).fill(null).map(()=>this.readF32())}guard(){let e=this.readU32(),t=this.readU16(),i=this.readU8();if(e!==t||t!==i||i!==this.lastGuardValue)throw new Error("Guard fail! Expected "+this.lastGuardValue+" but got "+e+" for 32, "+t+" for 16 and "+i+" for 8.");this.lastGuardValue++}}class Ht{constructor(e,t){this.sourceIndex=0,this.index32=0,this.index16=0,this.index8=0,this.nextGuard=0,this.sourceView=e,this.sourceIndex=t,this.buffer32=new DataView(new ArrayBuffer(25e3)),this.buffer16=new DataView(new ArrayBuffer(25e3)),this.buffer8=new DataView(new ArrayBuffer(25e3))}skip(e){this.sourceIndex+=e}allocate32(e){this.index32+=4*e}allocate16(e){this.index16+=2*e}allocate8(e){this.index8+=1*e}copyInto32(e){for(let t=0;t<e;t++)this.buffer32.setUint32(this.index32+4*t,this.sourceView.getUint32(this.sourceIndex+4*t,!0),!0);this.sourceIndex+=4*e,this.index32+=4*e}copyInto16(e){for(let t=0;t<e;t++)this.buffer16.setUint16(this.index16+2*t,this.sourceView.getUint16(this.sourceIndex+2*t,!0),!0);this.sourceIndex+=2*e,this.index16+=2*e}copyInto8(e){for(let t=0;t<1*e;t++)this.buffer8.setUint8(this.index8+1*t,this.sourceView.getUint8(this.sourceIndex+1*t));this.sourceIndex+=1*e,this.index8+=1*e}readS32(e=this.index32/4){let t=this.sourceView.getInt32(this.sourceIndex,!0);return this.sourceIndex+=4,null!==e&&(this.buffer32.setInt32(4*e,t,!0),4*e===this.index32&&(this.index32+=4)),t}writeS32(e){this.buffer32.setInt32(this.index32,e,!0),this.index32+=4}writeU8(e){this.buffer8.setUint8(this.index8,e),this.index8+=1}guard(){this.buffer32.setUint32(this.index32,this.nextGuard,!0),this.buffer16.setUint16(this.index16,this.nextGuard,!0),this.buffer8.setUint8(this.index8,this.nextGuard),this.nextGuard++,this.index32+=4,this.index16+=2,this.index8+=1}createBuffer(){this.index16=4*Math.ceil(this.index16/4),this.index8=4*Math.ceil(this.index8/4);let e=new ArrayBuffer(this.index32+this.index16+this.index8),t=new Uint8Array(e),i=0;for(let e=0;e<this.index32;e++)t[i++]=this.buffer32.getUint8(e);for(let e=0;e<this.index16;e++)t[i++]=this.buffer16.getUint8(e);for(let e=0;e<this.index8;e++)t[i++]=this.buffer8.getUint8(e);return{buffer:e,start16:this.index32/4,start8:(this.index32+this.index16)/4}}}class Xt extends jt{parse(e=!1){let t,i,s,n,a,r,o=this.readU16(),l=this.readU16();if(o<19){let e=this.readOldShape(o);t=e.bufferInfo.buffer,i=0,s=e.bufferInfo.start16,n=e.bufferInfo.start8,a=e.sequences,r=e.materialList}else{let e=this.readU32();t=this.buffer,s=this.readU32(),n=this.readU32(),i=this.index,this.index+=4*e;let l=this.readS32();a=[];for(let e=0;e<l;e++)a.push(this.parseSequence());r=this.parseMaterialList(o)}let h={};if(!e){let e=new Wt(t,i,s,n);h=this.assembleShape(e,o)}let d={version:o,exporterVersion:l,sequences:a};return d=Object.assign(d,r),d=Object.assign(d,h)}assembleShape(e,t){let i,s,n,a,r,o=e.readS32(),l=e.readS32(),h=e.readS32(),d=e.readS32(),c=e.readS32();t<22?(i=s=e.readS32()-o,n=a=r=0):(i=e.readS32(),s=e.readS32(),n=e.readS32(),a=e.readS32(),r=e.readS32());let u=0;t>23&&(u=e.readS32());let m=e.readS32(),p=e.readS32(),g=e.readS32(),f=e.readS32(),y=e.readS32(),b=0;t<23&&e.readS32();let v=e.readS32(),w=e.readF32();e.readS32();e.guard();let x=e.readF32(),S=e.readF32(),T=e.readPoint3F(),M=e.readBoxF();e.guard();let k=0,C=Array(o).fill(null).map(()=>({index:k++,nameIndex:e.readS32(),parentIndex:e.readS32(),firstObject:e.readS32(),firstChild:e.readS32(),nextSibling:e.readS32()}));e.guard();let E=Array(l).fill(null).map(()=>({nameIndex:e.readS32(),numMeshes:e.readS32(),startMeshIndex:e.readS32(),nodeIndex:e.readS32(),nextSibling:e.readS32(),firstDecal:e.readS32()}));e.guard();let A=Array(h).fill(null).map(()=>({nameIndex:e.readS32(),numMeshes:e.readS32(),startMeshIndex:e.readS32(),objectIndex:e.readS32(),nextSibling:e.readS32()}));e.guard();let B=Array(c).fill(null).map(()=>({nameIndex:e.readS32(),materialSlot:e.readS32(),firstFrame:e.readS32(),firstFrameOffTimeIndex:e.readS32(),numFrames:e.readS32()}));e.guard();let P=Array(d).fill(null).map(()=>e.readS32()),I=Array(d).fill(null).map(()=>e.readS32()),L=Array(d).fill(null).map(()=>e.readS32());e.guard();let _=Array(d).fill(null).map(()=>e.readS32()),R=Array(d).fill(null).map(()=>e.readS32()),F=Array(d).fill(null).map(()=>e.readS32());e.guard();let U=Array(o).fill(null).map(()=>e.readQuat16()),z=Array(o).fill(null).map(()=>e.readPoint3F()),D=Array(i).fill(null).map(()=>e.readQuat16()),V=Array(s).fill(null).map(()=>e.readPoint3F());e.guard();let O=[],N=[],q=[],j=[];t>21&&(O=Array(n).fill(null).map(()=>e.readF32()),N=Array(a).fill(null).map(()=>e.readPoint3F()),q=Array(r).fill(null).map(()=>e.readPoint3F()),j=Array(r).fill(null).map(()=>e.readQuat16()),e.guard());let G=Array(u).fill(null).map(()=>e.readPoint3F()),W=Array(u).fill(null).map(()=>e.readQuat16());t>23&&e.guard();let H=Array(m).fill(null).map(()=>({vis:e.readF32(),frameIndex:e.readS32(),matFrame:e.readS32()}));e.guard();let X=Array(p).fill(null).map(()=>e.readS32());e.guard();let Y=Array(g).fill(null).map(()=>({state:e.readU32(),pos:e.readF32()}));e.guard();let K=Array(f).fill(null).map(()=>({nameIndex:e.readS32(),subShapeNum:e.readS32(),objectDetailNum:e.readS32(),size:e.readF32(),averageError:e.readF32(),maxError:e.readF32(),polyCount:e.readS32()}));e.guard();let Q=[];for(let i=0;i<y;i++){let i=e.readU32();if(i===Gt.Null){Q.push(null);continue}e.guard();let s=e.readS32(),n=e.readS32(),a=e.readS32(),r=e.readBoxF(),o=e.readPoint3F(),l=e.readF32(),h=e.readS32(),d=a<0?Array(h).fill(null).map(()=>e.readPoint3F()):Q[a].verts,c=e.readS32(),u=a<0?Array(c).fill(null).map(()=>e.readPoint2F()):Q[a].tverts,m=a<0?Array(h).fill(null).map(()=>e.readPoint3F()):Q[a].norms,p=[];t>21&&(p=a<0?Array(h).fill(null).map(()=>e.readU8()):Q[a].encodedNorms);let g=e.readS32(),f=Array(g).fill(null).map(()=>({start:e.readU16(),numElements:e.readU16(),matIndex:e.readU32()})),y=e.readS32(),b=Array(y).fill(null).map(()=>e.readS16()),v=e.readS32(),w=Array(v).fill(null).map(()=>e.readS16()),x=e.readS32(),S=e.readS32();e.guard();let T={type:i,numFrames:s,numMatFrames:n,parentMesh:a,bounds:r,center:o,radius:l,verts:d,tverts:u,norms:m,encodedNorms:p,primitives:f,indices:b,mergeIndices:w,vertsPerFrame:x,flags:S};if(i===Gt.Skin){let t=e.readS32(),i=Array(t).fill(null).map(()=>e.readPoint3F()),s=Array(t).fill(null).map(()=>e.readPoint3F()),n=Array(t).fill(null).map(()=>e.readU8()),a=e.readS32(),r=Array(a).fill(null).map(()=>e.readMatrixF()),o=e.readS32(),l=Array(o).fill(null).map(()=>e.readS32()),h=Array(o).fill(null).map(()=>e.readS32()),d=Array(o).fill(null).map(()=>e.readF32()),c=e.readS32(),u=Array(c).fill(null).map(()=>e.readS32());T.verts=i,T.norms=s,T.encodedNorms=n,T.initialTransforms=r,T.vertIndices=l,T.boneIndices=h,T.weights=d,T.nodeIndices=u,e.guard()}Q.push(T)}e.guard();let $=[];for(let t=0;t<v;t++){let t="";for(;;){let i=e.readU8();if(0===i)break;t+=String.fromCharCode(i)}$.push(t)}return e.guard(),{smallestVisibleSize:w,radius:x,tubeRadius:S,center:T,bounds:M,nodes:C,objects:E,decals:A,iflMaterials:B,subShapeFirstNode:P,subShapeFirstObject:I,subShapeFirstDecal:L,subShapeNumNodes:_,subShapeNumObjects:R,subShapeNumDecals:F,defaultRotations:U,defaultTranslations:z,nodeRotations:D,nodeTranslations:V,nodeUniformScales:O,nodeAlignedScales:N,nodeArbScaleFactors:q,nodeArbScaleRots:j,groundTranslations:G,groundRotations:W,objectStates:H,decalStates:X,triggers:Y,details:K,meshes:Q,names:$,alphaIn:new Array(f).fill(null).map(()=>e.readF32()),alphaOut:new Array(f).fill(null).map(()=>e.readF32())}}parseSequence(){return{nameIndex:this.readS32(),flags:this.readU32(),numKeyframes:this.readS32(),duration:this.readF32(),priority:this.readS32(),firstGroundFrame:this.readS32(),numGroundFrames:this.readS32(),baseRotation:this.readS32(),baseTranslation:this.readS32(),baseScale:this.readS32(),baseObjectState:this.readS32(),baseDecalState:this.readS32(),firstTrigger:this.readS32(),numTriggers:this.readS32(),toolBegin:this.readF32(),rotationMatters:this.readBitSet(),translationMatters:this.readBitSet(),scaleMatters:this.readBitSet(),decalMatters:this.readBitSet(),iflMatters:this.readBitSet(),visMatters:this.readBitSet(),frameMatters:this.readBitSet(),matFrameMatters:this.readBitSet()}}parseMaterialList(e){this.readS8();let t=this.readS32(),i=Array(t).fill(null).map(e=>this.readString()),s=Array(t).fill(null).map(e=>this.readU32()),n=Array(t).fill(null).map(e=>this.readS32()),a=Array(t).fill(null).map(e=>this.readS32()),r=Array(t).fill(null).map(e=>this.readS32());return 25===e&&Array(t).fill(null).map(e=>this.readS32()),{matNames:i,matFlags:s,matReflectanceMaps:n,matBumpMaps:a,matDetailMaps:r,matDetailScales:Array(t).fill(null).map(e=>this.readF32()),matReflectance:Array(t).fill(null).map(e=>this.readF32())}}readBitSet(){this.index+=4;let e=this.readS32(),t=[];for(let i=0;i<e;i++)t.push(this.readU32());return t}readOldShape(e){let t=new Ht(this.view,this.index);t.allocate32(15),t.guard(),t.copyInto32(1),t.copyInto32(1),t.copyInto32(3),t.copyInto32(6),t.guard();let i=t.readS32(0);for(let e=0;e<i;e++)t.copyInto32(2),t.allocate32(3);t.guard();let s=t.readS32(1);for(let e=0;e<s;e++)t.copyInto32(4),t.allocate32(2);t.guard();let n=t.readS32(2);for(let e=0;e<n;e++)t.copyInto32(4),t.allocate32(1);t.guard();let a=t.readS32(4);for(let e=0;e<a;e++)t.copyInto32(2),t.allocate32(3);t.guard();let r=t.readS32(3),o=t.index32;t.copyInto32(r),t.skip(4),t.copyInto32(r),t.skip(4),t.copyInto32(r),t.guard();let l,h,d=t.index32;t.allocate32(3*r),t.guard();for(let e=0;e<3;e++){l=0===e?i:1===e?s:n;for(let e=r-1;e>=0;e--)h=t.buffer32.getInt32(o+4*e,!0),t.buffer32.setInt32(d+4*e,l-h,!0),l=h;o+=r,d+=r}let c=t.readS32(5);for(let e=0;e<c;e++)t.copyInto16(4),t.copyInto32(3);t.guard();let u=t.readS32(6);t.copyInto32(3*u),t.guard();let m=t.readS32(7);t.copyInto32(m),t.guard();let p=t.readS32(8);t.copyInto32(2*p),t.guard();let g=t.readS32(9);for(let e=0;e<g;e++)t.copyInto32(4),t.allocate32(3);t.guard(),this.index=t.sourceIndex;let f=this.readS32(),y=[];for(let e=0;e<f;e++){let e=this.parseSequence();y.push(e)}t.sourceIndex=this.index;let b=t.readS32(10);for(let e=0;e<b;e++){let e=t.readS32();this.readAllocMesh(t,e)}t.guard();let v=t.readS32(12);for(let e=0;e<v;e++){let e=t.readS32(null);t.copyInto8(e),t.writeU8(0)}t.guard();let w=null;return this.index=t.sourceIndex,this.readS32()&&(w=this.parseMaterialList(e)),t.sourceIndex=this.index,t.allocate32(16),{bufferInfo:t.createBuffer(),sequences:y,materialList:w}}readAllocMesh(e,t){if(t===Gt.Null)return;e.guard(),e.copyInto32(2),e.writeS32(-1),e.allocate32(10);let i=e.readS32();e.copyInto32(3*i);let s=e.readS32();e.copyInto32(2*s);let n=e.readS32(null);e.copyInto32(3*n);let a=e.readS32();for(let t=0;t<a;t++)e.copyInto16(2),e.copyInto32(1);let r=e.readS32();if(e.copyInto16(r),e.writeS32(0),e.copyInto32(2),e.guard(),t===Gt.Skin){let t=e.readS32();e.copyInto32(3*t);let i=e.readS32(null);e.copyInto32(3*i);let s=e.readS32();e.copyInto32(16*s);let n=e.readS32();e.copyInto32(n);let a=e.readS32(null);e.copyInto32(a);let r=e.index32;e.allocate32(a);let o=e.readS32();e.copyInto32(o);let l=e.index32,h=e.readS32(null);e.index32=r,e.copyInto32(h),e.index32=l,e.guard()}}static async loadFile(e){if(await this.cachedFilePromises.get(e),this.cachedFiles.get(e))return this.cachedFiles.get(e);let t=(async()=>{let t=await ne.loadResource(e);if(!t)throw new Error("Missing DTS resource: "+e);let i=await ne.readBlobAsArrayBuffer(t),s=new Xt(i).parse();return this.cachedFiles.set(e,s),this.cachedFilePromises.delete(e),s})();return this.cachedFilePromises.set(e,t),t}}Xt.cachedFilePromises=new Map,Xt.cachedFiles=new Map;class Yt{constructor(e){this.text=e}parse(){let e=this.text.split("\n"),t=[];for(let i of e){if((i=i.trim()).startsWith("//"))continue;if(!i)continue;let e=i.split(" "),s=e[1]?Number(e[1]):1;for(let i=0;i<s;i++)t.push(e[0])}return t}static async loadFile(e){if(this.cachedFiles.get(e))return this.cachedFiles.get(e);let t=await ne.loadResource(e),i=await ne.readBlobAsText(t),s=new Yt(i).parse();return this.cachedFiles.set(e,s),s}}Yt.cachedFiles=new Map;class Kt extends vt{constructor(){super(...arguments),this.children=[]}add(e){e.parent&&e.parent.remove(e),this.children.push(e),e.parent=this}remove(e){P.removeFromArray(this.children,e),e.parent=null}updateWorldTransform(){if(this.needsWorldTransformUpdate){super.updateWorldTransform();for(let e of this.children)e.needsWorldTransformUpdate&&e.updateWorldTransform()}}changedTransform(){super.changedTransform();for(let e of this.children)e.changedTransform()}traverse(e){e(this);for(let t of this.children)t instanceof Kt?t.traverse(e):e(t)}setOpacity(e){for(let t of this.children)t instanceof Kt?t.setOpacity(e):t.opacity=e}}const Qt=new Set(["shapes/items/superjump.dts","shapes/items/antigravity.dts"]);var $t,Zt,Jt;!function(e){e[e.S_Wrap=1]="S_Wrap",e[e.T_Wrap=2]="T_Wrap",e[e.Translucent=4]="Translucent",e[e.Additive=8]="Additive",e[e.Subtractive=16]="Subtractive",e[e.SelfIlluminating=32]="SelfIlluminating",e[e.NeverEnvMap=64]="NeverEnvMap",e[e.NoMipMap=128]="NoMipMap",e[e.MipMap_ZeroBorder=256]="MipMap_ZeroBorder",e[e.IflMaterial=134217728]="IflMaterial",e[e.IflFrame=268435456]="IflFrame",e[e.DetailMapOnly=536870912]="DetailMapOnly",e[e.BumpMapOnly=1073741824]="BumpMapOnly",e[e.ReflectanceMapOnly=-2147483648]="ReflectanceMapOnly"}($t||($t={})),function(e){e[e.Triangles=0]="Triangles",e[e.Strip=1073741824]="Strip",e[e.Fan=-2147483648]="Fan",e[e.Indexed=536870912]="Indexed",e[e.NoMaterial=268435456]="NoMaterial",e[e.MaterialMask=268435455]="MaterialMask",e[e.TypeMask=-1073741824]="TypeMask"}(Zt||(Zt={}));class ei{constructor(){this.isTSStatic=!1,this.hasBeenRendered=!1,this.meshes=[],this.collideable=!0,this.colliders=[],this.shapeVertices=new Map,this.isCurrentlyColliding=!1,this.worldPosition=new s,this.worldOrientation=new i,this.worldScale=new s,this.worldMatrix=new d,this.matNamesOverride={},this.castShadows=!1,this.rootGraphNodes=[],this.nodeTransforms=[],this.showSequences=!0,this.hasNonVisualSequences=!1,this.sequenceKeyframeOverride=new WeakMap,this.lastSequenceKeyframes=new WeakMap,this.currentOpacity=1,this.restitution=Lt,this.friction=It,this.ambientRotate=!1,this.ambientSpinFactor=-1/3e3*Math.PI*2,this.receiveShadows=!0,this.materialPostprocessor=null,this.shareId=0,this.shareNodeTransforms=!0,this.shareMaterials=!0,this.isMaster=!1,this.sounds=[]}getShareHash(){return this.dtsPath+" "+this.constructor.name+" "+this.shareId}async init(e,t=null){var i,n,a;this.id=null!==(i=null===t||void 0===t?void 0:t._id)&&void 0!==i?i:0,this.level=e,this.srcElement=t,null!==(n=this.colliderDtsPath)&&void 0!==n||(this.colliderDtsPath=this.dtsPath),this.dts=await(this.level?this.level.mission.getDts(this.dtsPath):Xt.loadFile(ne.mainDataPath+this.dtsPath)),this.colliderDts=this.dtsPath===this.colliderDtsPath?this.dts:await(this.level?this.level.mission.getDts(this.colliderDtsPath):Xt.loadFile(ne.mainDataPath+this.colliderDtsPath)),this.directoryPath=this.dtsPath.slice(0,this.dtsPath.lastIndexOf("/")),this.group=new Kt,this.bodies=[],this.materials=[],this.materialInfo=new WeakMap;let r,o=null===(a=this.level)||void 0===a?void 0:a.sharedShapeData.get(this.getShareHash());if(o)r=await o;else{let e;this.level&&(o=new Promise(t=>e=t),this.level.sharedShapeData.set(this.getShareHash(),o));for(let e=0;e<this.dts.nodes.length;e++)this.nodeTransforms.push(new d);await this.computeMaterials();let t=[];for(let e=0;e<this.dts.nodes.length;e++){let i={index:e,node:this.dts.nodes[e],children:[],parent:null};t.push(i)}for(let e=0;e<this.dts.nodes.length;e++){let i=this.dts.nodes[e];-1!==i.parentIndex&&(t[e].parent=t[i.parentIndex],t[i.parentIndex].children.push(t[e]))}this.graphNodes=t,this.rootGraphNodes=t.filter(e=>!e.parent),this.updateNodeTransforms();let i=[],n=[],a=new Set;for(let e=0;e<this.dts.nodes.length;e++){let t=this.dts.objects.filter(t=>t.nodeIndex===e);for(let r of t){let t=this.dts.names[r.nameIndex].toLowerCase().startsWith("col");if(!t||this.collideable)for(let o=r.startMeshIndex;o<r.startMeshIndex+r.numMeshes;o++){let r=this.dts.meshes[o];if(!r)continue;if(r.parentMesh>=0)continue;if(0===r.verts.length)continue;let l=r.verts.map(e=>new s(e.x,e.y,e.z)),h=r.norms.map(e=>new s(e.x,e.y,e.z)),d=this.generateGeometryFromMesh(r,l,h);i.push(d),n.push(e),t&&a.add(d)}}}let l=null;for(let e=0;e<this.dts.meshes.length;e++){let t=this.dts.meshes[e];if(!t||t.type!==Gt.Skin)continue;let a=new Array(t.verts.length).fill(null).map(()=>new s),r=new Array(t.norms.length).fill(null).map(()=>new s),o=this.generateGeometryFromMesh(t,a,r);i.push(o),n.push(null),l=e;break}r={materials:this.materials,rootGraphNodes:this.rootGraphNodes,nodeTransforms:this.nodeTransforms,geometries:i,geometryMatrixIndices:n,collisionGeometries:a,skinnedMeshIndex:l},this.isMaster=!0,null===e||void 0===e||e(r)}this.isMaster||(this.nodeTransforms=r.nodeTransforms,this.shareNodeTransforms||(this.nodeTransforms=this.nodeTransforms.map(e=>e.clone())),this.shareMaterials?this.materials=r.materials:await this.computeMaterials(),this.rootGraphNodes=r.rootGraphNodes);for(let[e,t]of r.geometries.entries()){let i=this.materials;if(r.collisionGeometries.has(t)){let e=new xt;e.isShadow=!0,e.transparent=!0,e.depthWrite=!1,i=[e],t.materials.fill(0)}let n=new wt(t,i),a=this.nodeTransforms[r.geometryMatrixIndices[e]];a&&(n.transform=a),this.castShadows&&(n.castShadows=!0),this.group.add(n),this.meshes.push(n),null===r.skinnedMeshIndex||this.skinMeshInfo||(this.skinMeshInfo={meshIndex:r.skinnedMeshIndex,vertices:this.dts.meshes[r.skinnedMeshIndex].verts.map(e=>new s),normals:this.dts.meshes[r.skinnedMeshIndex].norms.map(e=>new s),mesh:n})}for(let e=0;e<this.colliderDts.nodes.length;e++){let t=this.colliderDts.objects.filter(t=>t.nodeIndex===e);for(let i of t){if(this.colliderDts.names[i.nameIndex].toLowerCase().startsWith("col")){let t=new Ct;t.type=St.Static,t.userData={nodeIndex:e},this.bodies.push(t)}}}if(0===this.bodies.length&&!this.isTSStatic){let e=new Ct;e.type=St.Static,this.bodies.push(e)}for(let e of this.bodies)e.onBeforeIntegrate=(()=>{this.isCurrentlyColliding&&0===e.collisions.length&&(this.isCurrentlyColliding=!1,this.onMarbleLeave())}),e.onBeforeCollisionResponse=(e=>{this.isCurrentlyColliding||this.onMarbleEnter(e),this.onMarbleInside(e),this.isCurrentlyColliding=!0}),e.onAfterCollisionResponse=(()=>{let t=e.collisions[0];this.onMarbleContact(t)});await(null===e||void 0===e?void 0:e.audio.loadBuffers(this.sounds)),this.level&&this.level.loadingState.loaded++}async computeMaterials(){var e;let t=null;for(let i=0;i<this.dts.matNames.length;i++){let s=this.matNamesOverride[this.dts.matNames[i]]||this.dts.matNames[i],n=this.dts.matFlags[i],a=ne.getFullNamesOf(this.directoryPath+"/"+s).filter(e=>!e.endsWith(".dts")),r=a.find(e=>e.endsWith(".ifl"))||a[0];if(this.isTSStatic&&t&&Qt.has(this.dtsPath)){this.materials.push(t);continue}let o=new xt;if((n&$t.SelfIlluminating||t)&&(o.emissive=!0),this.materials.push(o),s instanceof te)o.diffuseMap=s;else if(!r||this.isTSStatic&&n&$t.ReflectanceMapOnly)this.isTSStatic&&(o.emissive=!0,n&$t.ReflectanceMapOnly&&(t=o));else if(r.endsWith(".ifl")){let e=await Yt.loadFile(ne.mainDataPath+this.directoryPath+"/"+r),t=new Map;e=e.map(e=>{var i;if(t.has(e))return t.get(e);let s=null!==(i=ne.getFullNamesOf(this.directoryPath+"/"+e).filter(e=>!e.endsWith(".dts"))[0])&&void 0!==i?i:e;return t.set(e,s),s}),this.materialInfo.set(o,{keyframes:e});let i=[];for(let t of new Set(e))i.push(ne.getTexture(this.directoryPath+"/"+t));let s=await Promise.all(i);o.diffuseMap=s[0],o.differentiator=this.isTSStatic+ne.mainDataPath+this.directoryPath+"/"+r}else{let e=await ne.getTexture(this.directoryPath+"/"+r);o.diffuseMap=e}n&$t.Translucent&&(o.transparent=!0,o.depthWrite=!1),n&$t.Additive&&(o.blending=ae.Additive),n&$t.Subtractive&&(o.blending=ae.Subtractve),!this.isTSStatic||n&$t.NeverEnvMap||(o.reflectivity=1===this.dts.matNames.length?1:t?.5:.333,o.envMap=this.level.envMap),null===(e=this.materialPostprocessor)||void 0===e||e.call(this,o)}if(0===this.materials.length){let e=new xt;e.emissive=!0,e.envMap=this.level.envMap,e.reflectivity=1,this.materials.push(e)}}generateGeometryFromMesh(e,t,i){let n=new yt;for(let s=0;s<t.length;s++){let a=t[s],r=e.tverts[s],o=i[s];n.positions.push(a.x,a.y,a.z),n.normals.push(o.x,o.y,o.z),n.uvs.push(r.x,r.y)}let a=new s,r=new s;const o=(e,s,o,l)=>{a.set(t[s].x-t[e].x,t[s].y-t[e].y,t[s].z-t[e].z),r.set(t[o].x-t[e].x,t[o].y-t[e].y,t[o].z-t[e].z);let h=a.cross(r).normalize(),d=h.dot(i[e]),c=h.dot(i[s]),u=h.dot(i[o]);this.dtsPath.includes("helicopter.dts")||d<0&&c<0&&u<0&&([e,o]=[o,e]),n.indices.push(e,s,o),n.materials.push(l,l,l)};for(let t of e.primitives){let i=t.matIndex&Zt.MaterialMask,s=t.matIndex&Zt.TypeMask;if(s===Zt.Triangles)for(let s=t.start;s<t.start+t.numElements;s+=3){o(e.indices[s],e.indices[s+1],e.indices[s+2],i)}else if(s===Zt.Strip){let s=0;for(let n=t.start;n<t.start+t.numElements-2;n++){let t=e.indices[n],a=e.indices[n+1],r=e.indices[n+2];if(s%2==0){let e=t;t=r,r=e}o(t,a,r,i),s++}}else if(s===Zt.Fan)for(let s=t.start;s<t.start+t.numElements-2;s++){o(e.indices[t.start],e.indices[s+1],e.indices[s+2],i)}}return n}generateCollisionObjects(){let e=0,t=this.colliderDts;for(let i=0;i<t.nodes.length;i++){let n=t.objects.filter(e=>e.nodeIndex===i);for(let i of n){if(!t.names[i.nameIndex].toLowerCase().startsWith("col"))continue;let n=this.bodies[e];e++;for(let e=i.startMeshIndex;e<i.startMeshIndex+i.numMeshes;e++){let i=t.meshes[e];if(i)for(let e of i.primitives){let t=new E(Array(e.numElements).fill(null).map(e=>new s));t.restitution=this.restitution,t.friction=this.friction,this.collideable||(t.collisionDetectionMask=2),n.addCollisionShape(t);let a=i.indices.slice(e.start,e.start+e.numElements).map(e=>i.verts[e]).map(e=>new s(e.x,e.y,e.z));this.shapeVertices.set(t,a)}}}}if(0===e&&!this.isTSStatic){let e=this.bodies[0],i=new r;i.min.set(t.bounds.min.x,t.bounds.min.y,t.bounds.min.z),i.max.set(t.bounds.max.x,t.bounds.max.y,t.bounds.max.z);let n=new E(Array(8).fill(null).map(e=>new s));n.restitution=this.restitution,n.friction=this.friction,this.collideable||(n.collisionDetectionMask=2),e.addCollisionShape(n);let a=P.getBoxVertices(i);this.shapeVertices.set(n,a)}}updateNodeTransforms(e,t,n,a=4294967295){e||(e=this.dts.nodes.map((e,t)=>{let s=this.dts.defaultRotations[t],n=new i(s.x,s.y,s.z,s.w);return n.normalize(),n.conjugate(),n})),t||(t=this.dts.nodes.map((e,t)=>{let i=this.dts.defaultTranslations[t];return new s(i.x,i.y,i.z)})),n||(n=this.dts.nodes.map(()=>(new s).setScalar(1)));let r=new d;const o=(i,s)=>{if(0!=(1<<i.index&a)&&(s=!0),s){let s=this.nodeTransforms[i.index];i.parent?s.copy(this.nodeTransforms[i.parent.index]):s.identity(),r.compose(t[i.index],e[i.index],n[i.index]),s.multiplyMatrices(s,r)}for(let e=0;e<i.children.length;e++)o(i.children[e],s)};for(let e=0;e<this.rootGraphNodes.length;e++){let t=this.rootGraphNodes[e];o(t,!1)}}updateCollisionGeometry(e){var t;for(let i=0;i<this.bodies.length;i++){let s,n=this.bodies[i];if(void 0!==(null===(t=n.userData)||void 0===t?void 0:t.nodeIndex)){if(0==(1<<n.userData.nodeIndex&e))continue;(s=this.worldMatrix.clone()).multiplyMatrices(this.worldMatrix,this.nodeTransforms[n.userData.nodeIndex])}else s=this.worldMatrix;for(let e of n.shapes){let t=this.shapeVertices.get(e);for(let i=0;i<t.length;i++)e.points[i].copy(t[i]).applyMatrix4(s);e.computeLocalBoundingBox()}n.syncShapes()}}tick(e,t=!1){var n,a,r,o;if(this.showSequences&&(t||this.hasNonVisualSequences)){if(!this.shareNodeTransforms||this.isMaster)for(let l of this.dts.sequences){let h,d,c,u=null!==(n=l.rotationMatters[0])&&void 0!==n?n:0,m=null!==(a=l.translationMatters[0])&&void 0!==a?a:0,p=null!==(r=l.scaleMatters[0])&&void 0!==r?r:0,g=0,f=e.timeSinceLoad/(1e3*l.duration),y=null!==(o=this.sequenceKeyframeOverride.get(l))&&void 0!==o?o:f*l.numKeyframes%l.numKeyframes;if(this.lastSequenceKeyframes.get(l)===y)continue;this.lastSequenceKeyframes.set(l,y);let b=Math.floor(y),v=Math.ceil(y)%l.numKeyframes,w=(y-b)%1;u>0&&(h=this.dts.nodes.map((e,t)=>{if(0!=(1<<t&u)){let e=this.dts.nodeRotations[l.numKeyframes*g+b],t=this.dts.nodeRotations[l.numKeyframes*g+v],s=new i(e.x,e.y,e.z,e.w);s.normalize(),s.conjugate();let n=new i(t.x,t.y,t.z,t.w);return n.normalize(),n.conjugate(),s.slerp(n,w),g++,s}{let e=this.dts.defaultRotations[t],s=new i(e.x,e.y,e.z,e.w);return s.normalize(),s.conjugate(),s}})),g=0,m>0&&(d=this.dts.nodes.map((e,t)=>{if(0!=(1<<t&m)){let e=this.dts.nodeTranslations[l.numKeyframes*g+b],t=this.dts.nodeTranslations[l.numKeyframes*g+v];return g++,new s(P.lerp(e.x,t.x,w),P.lerp(e.y,t.y,w),P.lerp(e.z,t.z,w))}{let e=this.dts.defaultTranslations[t];return new s(e.x,e.y,e.z)}})),g=0,p>0&&(c=this.dts.nodes.map((e,t)=>{if(0!=(1<<t&p)){let e=this.dts.nodeAlignedScales[l.numKeyframes*g+b],t=this.dts.nodeAlignedScales[l.numKeyframes*g+v];return g++,new s(P.lerp(e.x,t.x,w),P.lerp(e.y,t.y,w),P.lerp(e.z,t.z,w))}return(new s).setScalar(1)})),u|m|p&&(this.updateNodeTransforms(h,d,c,u|m|p),t||this.updateCollisionGeometry(u|m|p))}for(let e of this.meshes)e.changedTransform()}}render(e){if(!this.isTSStatic||!this.hasBeenRendered){if(this.tick(e,!0),this.skinMeshInfo&&this.isMaster){let e=this.skinMeshInfo,t=this.dts.meshes[e.meshIndex];for(let t=0;t<e.vertices.length;t++)e.vertices[t].set(0,0,0),e.normals[t].set(0,0,0);let i=[],n=[];for(let e=0;e<t.nodeIndices.length;e++){let s=new d;s.elements=t.initialTransforms[e].slice(),s.transpose(),s.multiplyMatrices(this.nodeTransforms[t.nodeIndices[e]],s),i.push(s),n.push(s.clone().transpose())}let a=new s,r=new s;for(let s=0;s<t.vertIndices.length;s++){let n=t.vertIndices[s],o=t.verts[n],l=t.norms[n];a.set(o.x,o.y,o.z),r.set(l.x,l.y,l.z);let h=i[t.boneIndices[s]];a.applyMatrix4(h),a.multiplyScalar(t.weights[s]),P.m_matF_x_vectorF(h,r),r.multiplyScalar(t.weights[s]),e.vertices[n].add(a),e.normals[n].add(r)}for(let t=0;t<e.normals.length;t++){let i=e.normals[t];i.dot(i)>.01&&i.normalize()}let o=e.mesh.geometry;for(let t=0;t<e.vertices.length;t++){let i=e.vertices[t],s=e.normals[t];o.positions[3*t+0]=i.x,o.positions[3*t+1]=i.y,o.positions[3*t+2]=i.z,o.normals[3*t+0]=s.x,o.normals[3*t+1]=s.y,o.normals[3*t+2]=s.z}}if(this.skinMeshInfo&&(this.skinMeshInfo.mesh.needsVertexBufferUpdate=!0),!this.shareMaterials||this.isMaster)for(let t=0;t<this.materials.length;t++){let i=this.materialInfo.get(this.materials[t]);if(!i)continue;let s=this.dts.sequences.find(e=>e.iflMatters[0]>0);if(!s||!this.showSequences)continue;let n=e.timeSinceLoad/(1e3*s.duration),a=Math.floor(n*i.keyframes.length)%i.keyframes.length,r=i.keyframes[a],o=ne.getTextureFromCache(this.directoryPath+"/"+r);this.materials[t].diffuseMap=o}if(this.ambientRotate){let t=new i,n=new s(0,0,1);t.setFromAxisAngle(n,e.timeSinceLoad*this.ambientSpinFactor);let a=this.worldOrientation.clone();t.multiplyQuaternions(a,t),this.group.orientation.copy(t),this.group.recomputeTransform()}this.hasBeenRendered=!0}}setTransform(e,t,n){let a=0!==n.clone().sub(this.worldScale).length();this.worldPosition=e,this.worldOrientation=t,this.worldScale=n,this.worldMatrix.compose(e,t,n),this.group.position.copy(e),this.group.orientation.copy(t),this.group.scale.copy(n),this.group.recomputeTransform();let r=new d;r.compose(this.worldPosition,this.worldOrientation,new s(1,1,1));for(let e of this.colliders){let t=e.transform.clone();t.multiplyMatrices(r,t);let n=new s,a=new i;for(t.decompose(n,a,new s),e.body.position.copy(n),e.body.orientation.copy(a);e.body.shapes.length;)e.body.removeCollisionShape(e.body.shapes[0]);let o=e.generateShape(this.worldScale);o.collisionDetectionMask=4,e.body.addCollisionShape(o)}a&&this.generateCollisionObjects(),this.updateCollisionGeometry(4294967295)}setOpacity(e){e!==this.currentOpacity&&(this.currentOpacity=e,this.group.setOpacity(e))}addCollider(e,t,i){let s=new Ct;s.type=St.Static,this.colliders.push({generateShape:e,body:s,transform:i}),s.onAfterCollisionResponse=t}setCollisionEnabled(e){for(let t of this.bodies)t.enabled=e}reset(){this.isCurrentlyColliding=!1}onMarbleContact(e){}onMarbleInside(e){}onMarbleEnter(e){}onMarbleLeave(){}async onLevelStart(){}}class ti{constructor(e=0,t=0,i=0,s=1){this.x=e,this.y=t,this.z=i,this.w=s}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new ti(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=this.w,a=e.elements;return this.x=a[0]*t+a[4]*i+a[8]*s+a[12]*n,this.y=a[1]*t+a[5]*i+a[9]*s+a[13]*n,this.z=a[2]*t+a[6]*i+a[10]*s+a[14]*n,this.w=a[3]*t+a[7]*i+a[11]*s+a[15]*n,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,s,n;const a=e.elements,r=a[0],o=a[4],l=a[8],h=a[1],d=a[5],c=a[9],u=a[2],m=a[6],p=a[10];if(Math.abs(o-h)<.01&&Math.abs(l-u)<.01&&Math.abs(c-m)<.01){if(Math.abs(o+h)<.1&&Math.abs(l+u)<.1&&Math.abs(c+m)<.1&&Math.abs(r+d+p-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;const e=(r+1)/2,a=(d+1)/2,g=(p+1)/2,f=(o+h)/4,y=(l+u)/4,b=(c+m)/4;return e>a&&e>g?e<.01?(i=0,s=.707106781,n=.707106781):(s=f/(i=Math.sqrt(e)),n=y/i):a>g?a<.01?(i=.707106781,s=0,n=.707106781):(i=f/(s=Math.sqrt(a)),n=b/s):g<.01?(i=.707106781,s=.707106781,n=0):(i=y/(n=Math.sqrt(g)),s=b/n),this.set(i,s,n,t),this}let g=Math.sqrt((m-c)*(m-c)+(l-u)*(l-u)+(h-o)*(h-o));return Math.abs(g)<.001&&(g=1),this.x=(m-c)/g,this.y=(l-u)/g,this.z=(h-o)/g,this.w=Math.acos((r+d+p-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}!function(e){e[e.SimGroup=0]="SimGroup",e[e.ScriptObject=1]="ScriptObject",e[e.MissionArea=2]="MissionArea",e[e.Sky=3]="Sky",e[e.Sun=4]="Sun",e[e.InteriorInstance=5]="InteriorInstance",e[e.StaticShape=6]="StaticShape",e[e.Item=7]="Item",e[e.Path=8]="Path",e[e.Marker=9]="Marker",e[e.PathedInterior=10]="PathedInterior",e[e.Trigger=11]="Trigger",e[e.AudioProfile=12]="AudioProfile",e[e.MessageVector=13]="MessageVector",e[e.TSStatic=14]="TSStatic",e[e.ParticleEmitterNode=15]="ParticleEmitterNode"}(Jt||(Jt={}));const ii=/new\s+(\w+)\((.*?)\)\s*{/g,si=/\/\*(.|\n)*?\*\//g,ni=/\/\/.*/g,ai=/(\$(?:\w|\d)+)\s*=\s*(.+?);/g,ri=/setMarbleAttributes\("(\w+)",\s*(.+?)\);/g,oi=/activatePackage\((.+?)\);/g,li=/new MaterialProperty *\( *(.+?) *\)\s*{\s*((?:\w+ *= *(\d|\.)+;\s*)*)}/gi,hi=/addMaterialMapping *\( *"(.+?)" *, *(.+?) *\)/gi,di=/([^\s]+?)\s*=\s*"(.*?)"\s*;/g;class ci{constructor(e){this.index=0,this.currentElementId=0,this.text=e}parse(){this.text=ui+"\n\n"+this.text;let e=this.text.indexOf("//--- OBJECT WRITE BEGIN ---"),t=this.text.lastIndexOf("//--- OBJECT WRITE END ---"),i=this.text.slice(0,e)+this.text.slice(t);this.variables={$usermods:'""'},ai.lastIndex=0;let s=null;for(;null!==(s=ai.exec(i));)this.variables[s[1]]||(this.variables[s[1]]=s[2]);let n={};for(s=null,ri.lastIndex=0;null!==(s=ri.exec(i));)n[s[1]]=this.resolveExpression(s[2]);let a=[];for(s=null,oi.lastIndex=0;null!==(s=oi.exec(i));)a.push(this.resolveExpression(s[1]));let r={};for(s=null,li.lastIndex=0;null!==(s=li.exec(i));){let e=s[2].split(";").filter(e=>e.trim()).map(e=>e.split("=").map(e=>e.trim()));r[s[1]]={};for(let t of e)r[s[1]][t[0]]=Number(t[1])}let o={};for(s=null,hi.lastIndex=0;null!==(s=hi.exec(i));)o[s[1]]=s[2];-1!==e&&-1!==t&&(this.text=this.text.slice(e,t));let l=0;for(;;){si.lastIndex=l,ni.lastIndex=l;let e=si.exec(this.text),t=ni.exec(this.text);if(e&&P.indexIsInStringLiteral(this.text,e.index)&&(e=null),t&&P.indexIsInStringLiteral(this.text,t.index)&&(t=null),!e&&!t)break;!t||e&&t&&e.index<t.index?(this.text=this.text.slice(0,e.index)+this.text.slice(e.index+e[0].length),l=e.index):(this.text=this.text.slice(0,t.index)+this.text.slice(t.index+t[0].length),l=t.index)}let h=this.text.indexOf("new SimGroup(MissionGroup)");-1!==h&&(this.index=h);let d=[];for(;this.hasNextElement();){let e=this.readElement();e&&d.push(e)}if(1!==d.length)throw console.log(d),new Error("Mission file doesn't have exactly 1 outer element!");return{root:d[0],marbleAttributes:n,activatedPackages:a,materialProperties:r,materialMappings:o}}readElement(){ii.lastIndex=this.index;let e=ii.exec(this.text);this.index=e.index+e[0].length;let t=e[1],i=e[2];this.index=e.index+e[0].length;let s=null;switch(t){case"SimGroup":s=this.readSimGroup(i);break;case"ScriptObject":s=this.readScriptObject(i);break;case"MissionArea":s=this.readMissionArea(i);break;case"Sky":s=this.readSky(i);break;case"Sun":s=this.readSun(i);break;case"InteriorInstance":s=this.readInteriorInstance(i);break;case"StaticShape":s=this.readStaticShape(i);break;case"Item":s=this.readItem(i);break;case"Path":s=this.readPath(i);break;case"Marker":s=this.readMarker(i);break;case"PathedInterior":s=this.readPathedInterior(i);break;case"Trigger":s=this.readTrigger(i);break;case"AudioProfile":s=this.readAudioProfile(i);break;case"MessageVector":s=this.readMessageVector(i);break;case"TSStatic":s=this.readTSStatic(i);break;case"ParticleEmitterNode":s=this.readParticleEmitterNode(i);break;default:{console.warn("Unknown element type! "+t);let e=P.indexOfIgnoreStringLiterals(this.text,"};",this.index);-1===e&&(e=this.text.length),this.index=e+2}}return s&&(s._id=this.currentElementId++),s}hasNextElement(){ii.lastIndex=this.index;let e=ii.exec(this.text);return!!e&&-1===P.indexOfIgnoreStringLiterals(this.text.slice(this.index,e.index),"}")}readSimGroup(e){let t=[],i={};for(;;){ii.lastIndex=this.index,di.lastIndex=this.index;let e=ii.exec(this.text),s=di.exec(this.text),n=Math.min(null===e||void 0===e?void 0:e.index,null===s||void 0===s?void 0:s.index);if(!isFinite(n))break;if(-1!==P.indexOfIgnoreStringLiterals(this.text.slice(this.index,n),"}"))break;if(n===(null===e||void 0===e?void 0:e.index)){let e=this.readElement();if(!e)continue;t.push(e)}else i[s[1]]=this.resolveExpression(s[2]),this.index+=s[0].length}let s=P.indexOfIgnoreStringLiterals(this.text,"};",this.index);return-1===s&&(s=this.text.length),this.index=s+2,t?Object.assign(i,{_type:Jt.SimGroup,_name:e,elements:t}):null}readValues(){var e;let t={},i=P.indexOfIgnoreStringLiterals(this.text,"};",this.index);-1===i&&(i=this.text.length);let s=this.text.slice(this.index,i).trim(),n=P.splitIgnoreStringLiterals(s,";").map(e=>e.trim());for(let i of n){if(!i)continue;let s=i.indexOf("=");if(-1===s)continue;let n=[i.slice(0,s),i.slice(s+1)].map(e=>e.trim());if(2!==n.length)continue;let a=n[0];if((a=a.toLowerCase()).endsWith("]")){let i=a.indexOf("["),s=a.slice(0,i);(null!==(e=t[s])&&void 0!==e?e:t[s]=[])[Number(a.slice(i+1,-1))]=this.resolveExpression(n[1])}else t[a]=this.resolveExpression(n[1])}return this.index=i+2,t}resolveExpression(e){return P.splitIgnoreStringLiterals(e,"@").map(e=>((e=e.trim()).startsWith("$")&&void 0!==this.variables[e]?e=this.resolveExpression(this.variables[e]):e.startsWith('"')&&e.endsWith('"')&&(e=P.unescape(e.slice(1,-1))),e)).join("")}readScriptObject(e){return Object.assign({_type:Jt.ScriptObject,_name:e},this.readValues())}readMissionArea(e){return Object.assign({_type:Jt.MissionArea,_name:e},this.readValues())}readSky(e){return Object.assign({_type:Jt.Sky,_name:e},this.readValues())}readSun(e){return Object.assign({_type:Jt.Sun,_name:e},this.readValues())}readInteriorInstance(e){return Object.assign({_type:Jt.InteriorInstance,_name:e},this.readValues())}readStaticShape(e){return Object.assign({_type:Jt.StaticShape,_name:e},this.readValues())}readItem(e){return Object.assign({_type:Jt.Item,_name:e},this.readValues())}readPath(e){let t=this.readSimGroup(e);return t.markers=t.elements.sort((e,t)=>ci.parseNumber(e.seqnum)-ci.parseNumber(t.seqnum)),delete t.elements,t._type=Jt.Path,t}readMarker(e){return Object.assign({_type:Jt.Marker,_name:e},this.readValues())}readPathedInterior(e){return Object.assign({_type:Jt.PathedInterior,_name:e},this.readValues())}readTrigger(e){return Object.assign({_type:Jt.Trigger,_name:e},this.readValues())}readAudioProfile(e){return Object.assign({_type:Jt.AudioProfile,_name:e},this.readValues())}readMessageVector(e){return Object.assign({_type:Jt.MessageVector,_name:e},this.readValues())}readTSStatic(e){return Object.assign({_type:Jt.TSStatic,_name:e},this.readValues())}readParticleEmitterNode(e){return Object.assign({_type:Jt.ParticleEmitterNode,_name:e},this.readValues())}static async loadFile(e){if(this.cachedFiles.get(e))return this.cachedFiles.get(e);let t=await ne.loadResource(e),i=await ne.readBlobAsText(t),s=new ci(i).parse();return this.cachedFiles.set(e,s),s}static parseVector3(e){if(!e)return new s;let t=e.split(" ").map(e=>Number(e));return t.length<3?new s:void 0!==t.find(e=>!isFinite(e))?new s:new s(t[0],t[1],t[2])}static parseVector4(e){if(!e)return new ti;let t=e.split(" ").map(e=>Number(e));return t.length<4?new ti:void 0!==t.find(e=>!isFinite(e))?new ti:new ti(t[0],t[1],t[2],t[3])}static parseRotation(e){if(!e)return new i;let t=e.split(" ").map(e=>Number(e));if(t.length<4)return new i;if(void 0!==t.find(e=>!isFinite(e)))return new i;let n=new i;return n.setFromAxisAngle(new s(t[0],t[1],t[2]),-P.degToRad(t[3])),n}static parseNumber(e){if(!e||"string"!=typeof e)return 0;let t=Number(e.split(",")[0]);return isNaN(t)?0:t}static parseNumberList(e){let t=e.split(" "),i=[];for(let e of t){let t=Number(e);if(isNaN(t)){const t=7;for(;e.length>0;){let s=e.indexOf(".");if(-1===s)break;let n=e.slice(0,Math.min(s+t+1,e.length));i.push(Number(n)),e=e.slice(s+t+1)}}else i.push(t)}return i}static parseBoolean(e){return!!e&&"0"!==e}}ci.cachedFiles=new Map;const ui="\nnew MaterialProperty(GrassFrictionMaterial) {\n\tfriction = 1.50;\n\trestitution = 0.35;\n};\n\nnew MaterialProperty(TarmacFrictionMaterial) {\n\tfriction = 0.35;\n\trestitution = 0.7;\n};\n\nnew MaterialProperty(RugFrictionMaterial) {\n\tfriction = 6;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(IceFrictionMaterial) {\n\tfriction = 0.03;\n\trestitution = 0.95;\n};\n\nnew MaterialProperty(CarpetFrictionMaterial) {\n\tfriction = 6;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(SandFrictionMaterial) {\n\tfriction = 4;\n\trestitution = 0.1;\n};\n\nnew MaterialProperty(WaterFrictionMaterial) {\n\tfriction = 6;\n\trestitution = 0;\n};\n\nnew MaterialProperty(BouncyFrictionMaterial) {\n\tfriction = 0.2;\n\trestitution = 0;\n\tforce = 15;\n};\n\nnew MaterialProperty(RandomForceMaterial) {\n\tfriction = -1;\n\trestitution = 1;\n};\n\n// MBU/O values...\n\nnew MaterialProperty(HighFrictionMultiplayerMaterial) {\n\tfriction = 6;\n\trestitution = 0.3;\n};\n\n// added to stop the game from popping an error in the console log that it cannot find the\n// material property even though the game runs fine without that minor piece of code\n// so these lines of code are an extra to shut the game up and you can remove them if you wish\n\nnew MaterialProperty(DefaultMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n};\n\n// these values are for a balanced game play with Mini Marble Golf (the levels)\n// they might be a tad different to their MBP equivalent and are more realistic\n\nnew MaterialProperty(MMGGrassMaterial) {\n\tfriction = 0.9;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(MMGSandMaterial) {\n\tfriction = 6;\n\trestitution = 0.1;\n};\n\nnew MaterialProperty(MMGWaterMaterial) {\n\tfriction = 6;\n\trestitution = 0;\n};\n\nnew MaterialProperty(MMGIceMaterial) {\n\tfriction = 0.03;\n\trestitution = 0.95;\n};\n\nnew MaterialProperty(MMGIceShadowMaterial) {\n\tfriction = 0.2;\n\trestitution = 0.95;\n};\n\n// These are some old values\n\nnew MaterialProperty(BumperMaterial) {\n\tfriction = 0.5;\n\trestitution = 0;\n\tforce = 15;\n};\n\nnew MaterialProperty(ButtonMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n};\n\n// MBG Values for their frictions. MBP ones still rock, though.\n\n// Space\n\nnew MaterialProperty(NoFrictionMaterial) {\n\tfriction = 0.01;\n\trestitution = 0.5;\n};\n\n// Mud\n\nnew MaterialProperty(LowFrictionMaterial) {\n\tfriction = 0.20;\n\trestitution = 0.5;\n};\n\n// Grass\n\nnew MaterialProperty(HighFrictionMaterial) {\n\tfriction = 1.50;\n\trestitution = 0.5;\n};\n\n// Yellow ramps with arrows from Three Fold Maze and Escher's Race\n\nnew MaterialProperty(VeryHighFrictionMaterial) {\n\tfriction = 2;\n\trestitution = 1;\n};\n\n// Normal floor\n\nnew MaterialProperty(RubberFloorMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n};\n\n// Oil Slick\n\nnew MaterialProperty(IceMaterial) {\n\tfriction = 0.05;\n\trestitution = 0.5;\n};\n\nnew MaterialProperty(XmasSnowMaterial) {\n\tfriction = 3;\n\trestitution = 0.2;\n};\n\n// PlatinumQuest frictions\n\nnew MaterialProperty(PQSpaceMaterial) {\n\tfriction = 0.01;\n\trestitution = 0.35;\n};\n\n// It's elite\nnew MaterialProperty(PQIceMaterial) {\n\tfriction = 0.07331;\n\trestitution = 0.75;\n};\n\nnew MaterialProperty(PQMudMaterial) {\n\tfriction = 0.30;\n\trestitution = 0.5;\n};\n\n// Match 3FM/ER friction\nnew MaterialProperty(PQGrassMaterial) {\n\tfriction = 2;\n\trestitution = 0.5;\n};\n\n// Tad higher on rest. now\nnew MaterialProperty(PQSandMaterial) {\n\tfriction = 4;\n\trestitution = 0.15;\n};\n\nnew MaterialProperty(PQBouncyMaterial) {\n\tfriction = 0.2;\n\trestitution = 0;\n\tforce = 15;\n};\n\nnew MaterialProperty(IceShardMaterial) {\n\tfriction = 0;\n\trestitution = 0;\n\tforce = 0;\n};\n\nnew MaterialProperty(MORepulsionMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n\tforce = 10;\n};\n\nnew MaterialProperty(MOWeakRepulsionMaterial) {\n\tfriction = 1;\n\trestitution = 1;\n\tforce = 5;\n};\n\n// Spooky!!\n\nnew MaterialProperty(SpookyWaterMaterial) {\n\tfriction = 6;\n\trestitution = 0;\n};\n\nnew MaterialProperty(SpookyDirtMaterial) {\n\tfriction = 6;\n\trestitution = 0.3;\n};\n\nnew MaterialProperty(SpookyGrassMaterial) {\n\tfriction = 2;\n\trestitution = 0.75;\n};";class mi{constructor(e,t,i){this.updateRange={start:1/0,end:0},this.renderer=e,this.buffer=e.gl.createBuffer(),this.data=t,this.attributes=i,this.stride=Object.values(i).reduce((e,t)=>e+t,0),1===Object.keys(i).length&&(this.stride=0);let{gl:s}=e;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,t,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null)}set(e,t){this.data.set(e,t),this.updateRange.start=Math.min(this.updateRange.start,t),this.updateRange.end=Math.max(this.updateRange.end,t+e.length)}update(){if(this.updateRange.start>=this.updateRange.end)return;let{gl:e}=this.renderer;if(e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e instanceof WebGLRenderingContext){let t=this.data.subarray(this.updateRange.start,this.updateRange.end);e.bufferSubData(e.ARRAY_BUFFER,this.updateRange.start*Float32Array.BYTES_PER_ELEMENT,t)}else e.bufferSubData(e.ARRAY_BUFFER,this.updateRange.start*Float32Array.BYTES_PER_ELEMENT,this.data,this.updateRange.start,this.updateRange.end-this.updateRange.start);this.updateRange.start=1/0,this.updateRange.end=0}dispose(){let{gl:e}=this.renderer;e.deleteBuffer(this.buffer)}}class pi{constructor(e){this.buffers=e}}const gi=["particles/bubble.png","particles/saturn.png","particles/smoke.png","particles/spark.png","particles/star.png","particles/twirl.png"],fi=16384,yi=new Float32Array(Array(fi).fill([-.5,-.5,.5,-.5,.5,.5,-.5,.5]).flat()),bi=new Float32Array(Array(fi).fill([0,0,1,0,1,1,0,1]).flat()),vi=[];for(let e=0;e<fi;e++)vi.push(4*e+0,4*e+1,4*e+2,4*e+0,4*e+2,4*e+3);class wi{constructor(e){this.emitters=[],this.particleGroups=new Map,this.particles=[],this.level=e}async init(e){this.renderer=e;let{gl:t}=e;this.positionBuffer=new mi(e,yi,{position:2}),this.uvBuffer=new mi(e,bi,{uv:2}),this.bufferGroup=new pi([this.positionBuffer,this.uvBuffer]),this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint32Array(vi),t.STATIC_DRAW);let i=[];for(let e of gi)i.push(ne.getTexture(e));let s=await Promise.all(i);for(let t of s)t.getGLTexture(e)}getParticleGroup(e){let t=this.particleGroups.get(e);return t||(t=this.createParticleGroup(e),this.particleGroups.set(e,t)),t}createParticleGroup(e){var t,i,s,n,a,r,o,l,h,c,u,m,p,g,f,y,b,v,w,x;let S={particleSpawnTime:1,particleLifetime:1,particlePosition:3,particleVelocity:3,particleInitialSpin:1};const T=Object.values(S).reduce((e,t)=>e+t,0);let M=new Float32Array(4*T*fi),k=new mi(this.renderer,M,S),C=new d;return C.set((null===(t=e.colors[0])||void 0===t?void 0:t.r)||0,(null===(i=e.colors[0])||void 0===i?void 0:i.g)||0,(null===(s=e.colors[0])||void 0===s?void 0:s.b)||0,(null===(n=e.colors[0])||void 0===n?void 0:n.a)||0,(null===(a=e.colors[1])||void 0===a?void 0:a.r)||0,(null===(r=e.colors[1])||void 0===r?void 0:r.g)||0,(null===(o=e.colors[1])||void 0===o?void 0:o.b)||0,(null===(l=e.colors[1])||void 0===l?void 0:l.a)||0,(null===(h=e.colors[2])||void 0===h?void 0:h.r)||0,(null===(c=e.colors[2])||void 0===c?void 0:c.g)||0,(null===(u=e.colors[2])||void 0===u?void 0:u.b)||0,(null===(m=e.colors[2])||void 0===m?void 0:m.a)||0,(null===(p=e.colors[3])||void 0===p?void 0:p.r)||0,(null===(g=e.colors[3])||void 0===g?void 0:g.g)||0,(null===(f=e.colors[3])||void 0===f?void 0:f.b)||0,(null===(y=e.colors[3])||void 0===y?void 0:y.a)||0),C.transpose(),{vertexBuffer:k,uniforms:{acceleration:e.acceleration,spinSpeed:P.degToRad(e.spinSpeed),dragCoefficient:e.dragCoefficient,times:new Float32Array([null!==(b=e.times[0])&&void 0!==b?b:1/0,null!==(v=e.times[1])&&void 0!==v?v:1/0,null!==(w=e.times[2])&&void 0!==w?w:1/0,null!==(x=e.times[3])&&void 0!==x?x:1/0]),sizes:new Float32Array([e.sizes[0]||0,e.sizes[1]||0,e.sizes[2]||0,e.sizes[3]||0]),colors:new Float32Array(C.elements)},particles:[]}}getTime(){return this.level.timeState.timeSinceLoad}createEmitter(e,t,i,s){var n;let a=new xi(e,this,i,s);return a.currPos=null!==(n=null===i||void 0===i?void 0:i())&&void 0!==n?n:t.clone(),a.currPosTime=this.getTime(),a.spawn(this.getTime()),this.emitters.push(a),a}removeEmitter(e){P.removeFromArray(this.emitters,e)}tick(){let e=this.getTime();for(let t=0;t<this.emitters.length;t++){let i=this.emitters[t];i.getPos&&i.setPos(i.getPos(),e),i.tick(e)||this.emitters.splice(t--,1)}}render(e){this.currentRenderTime=e;for(let[,t]of this.particleGroups){for(let i=0;i<t.particles.length;i++){!t.particles[i].isAlive(e)&&(i<t.particles.length-1&&(t.particles[i]=t.particles[t.particles.length-1],t.particles[i].applyToGroup(t,i)),t.particles.length--,i--)}t.vertexBuffer.update()}}dispose(){for(let[,e]of this.particleGroups)e.vertexBuffer.dispose()}}class xi{constructor(e,t,i,n){this.vel=new s,this.o=e,this.manager=t,this.getPos=i,this.spawnSphereSquish=null!==n&&void 0!==n?n:new s(1,1,1)}spawn(e){this.spawnTime=e,this.emit(e)}tick(e){for(e-this.lastEmitTime>=1e3&&(this.lastEmitTime=e-1e3);this.lastEmitTime+this.currentWaitPeriod<=e;){if(this.emit(this.lastEmitTime+this.currentWaitPeriod),1===P.clamp((this.lastEmitTime-this.spawnTime)/this.o.emitterLifetime,0,1))return!1}return!0}emit(e){this.lastEmitTime=e,this.currentWaitPeriod=this.o.ejectionPeriod;let t=this.getPosAtTime(e).clone();this.o.spawnOffset&&t.add(this.o.spawnOffset());let i=(new s).randomDirection();i.multiply(this.spawnSphereSquish);let n=this.vel.clone().multiplyScalar(this.o.inheritedVelFactor).add(i.multiplyScalar(this.o.ejectionVelocity+this.o.velocityVariance*(2*Math.random()-1))).add(this.o.ambientVelocity),a=this.manager.getParticleGroup(this.o.particleOptions);if(a.particles.length===fi)return;let r=new Si(this.o.particleOptions,this.manager,e,t,n);r.applyToGroup(a,a.particles.length),a.particles.push(r)}getPosAtTime(e){if(!this.lastPos)return this.currPos;let t=P.clamp((e-this.lastPosTime)/(this.currPosTime-this.lastPosTime),0,1);return this.lastPos.clone().lerp(this.currPos,t)}setPos(e,t){this.lastPos=this.currPos,this.lastPosTime=this.currPosTime,this.currPos=e.clone(),this.currPosTime=t,this.vel=this.currPos.clone().sub(this.lastPos).multiplyScalar(1e3/(this.currPosTime-this.lastPosTime))}static cloneOptions(e){let t=P.jsonClone(e);return t.ambientVelocity=new s(e.ambientVelocity.x,e.ambientVelocity.y,e.ambientVelocity.z),t.spawnOffset=e.spawnOffset,t}}class Si{constructor(e,t,i,s,n){this.o=e,this.manager=t,this.spawnTime=i,this.pos=s,this.vel=n,this.lifetime=this.o.lifetime+this.o.lifetimeVariance*(2*Math.random()-1),this.initialSpin=P.lerp(this.o.spinRandomMin,this.o.spinRandomMax,Math.random())}applyToGroup(e,t){let i=[this.spawnTime,this.lifetime,this.pos.x,this.pos.y,this.pos.z,this.vel.x,this.vel.y,this.vel.z,P.degToRad(this.initialSpin)],s=e.vertexBuffer;s.set(i,4*t*s.stride+0*s.stride),s.set(i,4*t*s.stride+1*s.stride),s.set(i,4*t*s.stride+2*s.stride),s.set(i,4*t*s.stride+3*s.stride)}isAlive(e){let t=e-this.spawnTime;return P.clamp(t/this.lifetime,0,1)<1}}const Ti={MarbleTrailEmitter:{ejectionPeriod:5,ambientVelocity:new s(0,0,0),ejectionVelocity:0,velocityVariance:.25,emitterLifetime:1e4,inheritedVelFactor:0,particleOptions:{texture:"particles/smoke.png",blending:ae.Normal,spinSpeed:0,spinRandomMin:0,spinRandomMax:0,lifetime:100,lifetimeVariance:10,dragCoefficient:0,acceleration:0,colors:[{r:1,g:1,b:0,a:0},{r:1,g:1,b:0,a:1},{r:1,g:1,b:1,a:0}],sizes:[.4,.4,.4],times:[0,.15,1]}},LandMineEmitter:{ejectionPeriod:10,ambientVelocity:new s(0,0,0),ejectionVelocity:.5,velocityVariance:.25,emitterLifetime:1/0,inheritedVelFactor:.2,particleOptions:{texture:"particles/smoke.png",blending:ae.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.8,acceleration:0,colors:[{r:.56,g:.36,b:.26,a:1},{r:.56,g:.36,b:.26,a:0}],sizes:[.5,1],times:[0,1]}}};class Mi{constructor(e,t){this.id=P.getRandomId(),this.nextFaceToRender=0,this.renderer=e;let{gl:i}=e,s=i.createTexture();if(i.bindTexture(i.TEXTURE_CUBE_MAP,s),Array.isArray(t)){let e=t;if(e.some(e=>!e.complete))throw new Error("Can only pass loaded images into CubeTexture.");this.size=e[0].naturalWidth,i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[0]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_X,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[1]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Y,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[2]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[3]),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Z,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[4]),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[5]),i.generateMipmap(i.TEXTURE_CUBE_MAP)}else{let e=t;this.size=e;let s=new Uint8Array(e*e*4);i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_X,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Y,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_Z,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texImage2D(i.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,s),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)}i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR),this.glTexture=s}createFramebuffer(){let{gl:e}=this.renderer,t=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);let i=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,i),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.size,this.size),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,i),this.framebuffer=t,this.depthBuffer=i}render(e,t,i=1/0){let{gl:s}=this.renderer;this.framebuffer||this.createFramebuffer();let n=performance.now(),a=0;s.bindFramebuffer(s.FRAMEBUFFER,this.framebuffer);for(let r=0;r<6;r++){let o=(this.nextFaceToRender+r)%6,l=t.cameras[o];l.position.copy(t.position),l.updateMatrixWorld();let h=s.TEXTURE_CUBE_MAP_POSITIVE_X+o;if(s.bindTexture(s.TEXTURE_CUBE_MAP,null),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,h,this.glTexture,0),this.renderer.render(e,l,{framebuffer:this.framebuffer,width:this.size,height:this.size,colorTexture:this.glTexture}),a++,(performance.now()-n)/a*(a+1)>=i)break}s.bindTexture(s.TEXTURE_CUBE_MAP,this.glTexture),s.generateMipmap(s.TEXTURE_CUBE_MAP),this.nextFaceToRender+=a,this.nextFaceToRender%=6}dispose(){let{gl:e}=this.renderer;e.deleteTexture(this.glTexture),e.deleteFramebuffer(this.framebuffer),e.deleteRenderbuffer(this.depthBuffer)}}let ki=new d;class Ci{constructor(){this.position=new s,this.orientation=new i,this.up=new s(0,0,1),this.matrixWorld=new d,this.matrixWorldInverse=new d,this.projectionMatrix=new d,this.projectionMatrixInverse=new d}updateMatrixWorld(){this.matrixWorld.compose(this.position,this.orientation,(new s).setScalar(1)),this.matrixWorldInverse.copy(this.matrixWorld).invert()}lookAt(e){ki.lookAt(this.position,e,this.up),this.orientation.setFromRotationMatrix(ki)}}class Ei extends Ci{constructor(e=50,t=1,i=.1,s=2e3){super(),this.fov=e,this.zoom=1,this.near=i,this.far=s,this.aspect=t,this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(P.degToRad(.5*this.fov))/this.zoom,i=2*t,s=this.aspect*i,n=-.5*s;this.projectionMatrix.makePerspective(n,n+s,t,t-i,e,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}}class Ai extends Ci{constructor(e=-1,t=1,i=1,s=-1,n=.1,a=2e3){super(),this.zoom=1,this.left=e,this.right=t,this.top=i,this.bottom=s,this.near=n,this.far=a,this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let n=i-e,a=i+e,r=s+t,o=s-t;this.projectionMatrix.makeOrthographic(n,a,r,o,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}}class Bi{constructor(e,t){this.cameras=[],this.position=new s;const i=new Ei(90,1,e,t);i.up.set(0,-1,0),i.lookAt(new s(1,0,0)),this.cameras.push(i);const n=new Ei(90,1,e,t);n.up.set(0,-1,0),n.lookAt(new s(-1,0,0)),this.cameras.push(n);const a=new Ei(90,1,e,t);a.up.set(0,0,1),a.lookAt(new s(0,1,0)),this.cameras.push(a);const r=new Ei(90,1,e,t);r.up.set(0,0,-1),r.lookAt(new s(0,-1,0)),this.cameras.push(r);const o=new Ei(90,1,e,t);o.up.set(0,-1,0),o.lookAt(new s(0,0,1)),this.cameras.push(o);const l=new Ei(90,1,e,t);l.up.set(0,-1,0),l.lookAt(new s(0,0,-1)),this.cameras.push(l)}}const Pi=new d,Ii=new i;class Li{constructor(e=0,t=0,i=0,s=Li.defaultOrder){this.x=e,this.y=t,this.z=i,this.order=s}set(e,t,i,s=this.order){return this.x=e,this.y=t,this.z=i,this.order=s,this}clone(){return new Li(this.x,this.y,this.z,this.order)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.order=e.order,this}setFromRotationMatrix(e,t=this.order){const i=e.elements,s=i[0],n=i[4],a=i[8],r=i[1],o=i[5],l=i[9],h=i[2],d=i[6],c=i[10];switch(t){case"XYZ":this.y=Math.asin(P.clamp(a,-1,1)),Math.abs(a)<.9999999?(this.x=Math.atan2(-l,c),this.z=Math.atan2(-n,s)):(this.x=Math.atan2(d,o),this.z=0);break;case"YXZ":this.x=Math.asin(-P.clamp(l,-1,1)),Math.abs(l)<.9999999?(this.y=Math.atan2(a,c),this.z=Math.atan2(r,o)):(this.y=Math.atan2(-h,s),this.z=0);break;case"ZXY":this.x=Math.asin(P.clamp(d,-1,1)),Math.abs(d)<.9999999?(this.y=Math.atan2(-h,c),this.z=Math.atan2(-n,o)):(this.y=0,this.z=Math.atan2(r,s));break;case"ZYX":this.y=Math.asin(-P.clamp(h,-1,1)),Math.abs(h)<.9999999?(this.x=Math.atan2(d,c),this.z=Math.atan2(r,s)):(this.x=0,this.z=Math.atan2(-n,o));break;case"YZX":this.z=Math.asin(P.clamp(r,-1,1)),Math.abs(r)<.9999999?(this.x=Math.atan2(-l,o),this.y=Math.atan2(-h,s)):(this.x=0,this.y=Math.atan2(a,c));break;case"XZY":this.z=Math.asin(-P.clamp(n,-1,1)),Math.abs(n)<.9999999?(this.x=Math.atan2(d,o),this.y=Math.atan2(a,s)):(this.x=Math.atan2(-l,c),this.y=0);break;default:console.warn("Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this.order=t,this}setFromQuaternion(e,t){return Pi.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Pi,t)}setFromVector3(e,t=this.order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Ii.setFromEuler(this),this.setFromQuaternion(Ii,e)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.order===this.order}fromArray(e){return this.x=e[0],this.y=e[1],this.z=e[2],void 0!==e[3]&&(this.order=e[3]),this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.order,e}toVector3(e){return e?e.set(this.x,this.y,this.z):new s(this.x,this.y,this.z)}}Li.defaultOrder="XYZ",Li.rotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const _i=.2,Ri=.3,Fi=.6666,Ui=40,zi=500,Di={ejectionPeriod:1,ambientVelocity:new s(0,0,0),ejectionVelocity:2.6,velocityVariance:.125,emitterLifetime:3,inheritedVelFactor:0,particleOptions:{texture:"particles/star.png",blending:ae.Normal,spinSpeed:90,spinRandomMin:-90,spinRandomMax:90,lifetime:500,lifetimeVariance:100,dragCoefficient:.5,acceleration:-2,colors:[{r:.9,g:0,b:0,a:1},{r:.9,g:.9,b:0,a:1},{r:.9,g:.9,b:0,a:0}],sizes:[.25,.25,.25],times:[0,.75,1]}},Vi={ejectionPeriod:.9,ambientVelocity:new s(0,0,-.3),ejectionVelocity:3,velocityVariance:.4,emitterLifetime:300,inheritedVelFactor:.25,particleOptions:{texture:"particles/smoke.png",blending:ae.Additive,spinSpeed:20,spinRandomMin:-90,spinRandomMax:90,lifetime:600,lifetimeVariance:250,dragCoefficient:.2,acceleration:-.1,colors:[{r:25/255,g:244/255,b:1,a:.2},{r:25/255,g:244/255,b:1,a:1},{r:25/255,g:244/255,b:1,a:1},{r:25/255,g:244/255,b:1,a:0}],sizes:[.1,.1,.1],times:[0,.2,.75,1]}},Oi=xi.cloneOptions(Vi);Oi.ejectionVelocity=4,Oi.ejectionPeriod=.7,Oi.particleOptions.dragCoefficient=.3,Oi.particleOptions.colors=Oi.particleOptions.colors.map(e=>(e.r=1,e.g=159/255,e.b=25/255,e));class Ni{constructor(e){this.predictedPosition=new s,this.predictedOrientation=new i,this.radius=null,this.jumpImpulse=7.3,this.bounceRestitution=.5,this.superBounceEnableTime=-1/0,this.shockAbsorberEnableTime=-1/0,this.helicopterEnableTime=-1/0,this.megaMarbleEnableTime=-1/0,this.helicopterSound=null,this.shockAbsorberSound=null,this.superBounceSound=null,this.lastMovementVec=new s,this.beforeVel=new s,this.beforeAngVel=new s,this.lastContactNormal=new s,this.slidingTimeout=0,this.level=e}get speedFac(){return _i/this.radius}async init(){var e,t,i;let s;this.group=new Kt,this.innerGroup=new Kt,this.group.add(this.innerGroup),void 0!==this.level.mission.misFile.marbleAttributes.jumpImpulse&&(this.jumpImpulse=ci.parseNumber(this.level.mission.misFile.marbleAttributes.jumpImpulse)),void 0!==this.level.mission.misFile.marbleAttributes.bounceRestitution&&(this.bounceRestitution=ci.parseNumber(this.level.mission.misFile.marbleAttributes.bounceRestitution));let n=null!==(t=null===(e=this.level.offlineSettings)||void 0===e?void 0:e.marbleTexture)&&void 0!==t?t:await K.databaseGet("keyvalue","marbleTexture");if(n)try{let e=ne.getUrlToBlob(n);s=await ne.getTexture(e,"")}catch(e){console.error("Failed to load custom marble texture:",e)}else s=await ne.getTexture("shapes/balls/base.marble.png");let a=s.image.width===2*s.image.height;this.isReflective()&&(this.cubeMap=new Mi(he,128),this.cubeCamera=new Bi(.025,this.level.camera.far));const r=e=>{e.envMap=this.cubeMap,e.envMapZUp=!1,e.reflectivity=.7,e.useFresnel=!0,e.useAccurateReflectionRay=!0};if(a||"ultra"===this.level.mission.modification&&!n){let e=new ei;e.shareMaterials=!1,e.dtsPath="shapes/balls/pack1/pack1marble.dts",e.castShadows=!0,e.materialPostprocessor=(e=>{e.normalizeNormals=!0,e.flipY=!0,this.isReflective()&&r(e)}),n&&(e.matNamesOverride["base.marble"]=s),await e.init(this.level),this.innerGroup.add(e.group),this.ballShape=e}let o=yt.createSphereGeometry(1,32,16),l=new xt;l.diffuseMap=s,l.normalizeNormals=!0,l.flipY=!0,this.isReflective()&&r(l);let h=new wt(o,[l]);h.castShadows=!0,this.sphere=h,this.innerGroup.add(h),this.body=new Ct,this.body.evaluationOrder=1e3;let d=new C(0);d.restitution=this.bounceRestitution,this.shape=d,this.body.addCollisionShape(d);let c=new C(0);c.collisionDetectionMask=2,c.collisionResponseMask=0,this.body.addCollisionShape(c);let u=new C(0);u.collisionDetectionMask=4,u.collisionResponseMask=0,this.body.addCollisionShape(u),d.broadphaseShape=c,u.broadphaseShape=c,this.largeAuxShape=c,this.smallAuxShape=u,this.body.onBeforeIntegrate=this.onBeforeIntegrate.bind(this),this.body.onAfterIntegrate=this.onAfterIntegrate.bind(this),this.body.onBeforeCollisionResponse=this.onBeforeCollisionResponse.bind(this),this.body.onAfterCollisionResponse=this.onAfterCollisionResponse.bind(this),this.body.orientation.setFromEuler(new Li(Math.PI/2,7*Math.PI/6,0)),this.forcefield=new ei,this.forcefield.dtsPath="shapes/images/glow_bounce.dts",await this.forcefield.init(this.level),this.forcefield.setOpacity(0),this.forcefield.showSequences=!1,this.innerGroup.add(this.forcefield.group),this.helicopter=new ei,this.helicopter.dtsPath=Math.random()<.001?"shapes/images/glow_bounce.dts":"shapes/images/helicopter.dts",this.helicopter.castShadows=!0,await this.helicopter.init(this.level),this.helicopter.setOpacity(0),this.group.add(this.helicopter.group);let m=["jump.wav","bouncehard1.wav","bouncehard2.wav","bouncehard3.wav","bouncehard4.wav","rolling_hard.wav","sliding.wav"];this.level.mission.hasBlast&&m.push("blast.wav"),await this.level.audio.loadBuffers(m),this.rollingSound=this.level.audio.createAudioSource("rolling_hard.wav"),this.rollingSound.play(),this.rollingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingSound.setLoop(!0),this.level.mission.allElements.some(e=>{var t;return e._type===Jt.Item&&"megamarbleitem"===(null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase())})&&(this.rollingMegaMarbleSound=this.level.audio.createAudioSource("mega_roll.wav"),this.rollingMegaMarbleSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingMegaMarbleSound.setLoop(!0)),this.slidingSound=this.level.audio.createAudioSource("sliding.wav"),this.slidingSound.play(),this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.slidingSound.setLoop(!0),await Promise.all([this.rollingSound.promise,this.slidingSound.promise,null===(i=this.rollingMegaMarbleSound)||void 0===i?void 0:i.promise])}isReflective(){var e;return void 0!==(null===(e=this.level.offlineSettings)||void 0===e?void 0:e.reflectiveMarble)?this.level.offlineSettings.reflectiveMarble:(2===K.data.settings.marbleReflectivity||0===K.data.settings.marbleReflectivity&&"ultra"===this.level.mission.modification)&&!P.isIOS()}findBestCollision(e){let t,i=-1/0;for(let s of this.body.collisions){if(s.s1!==this.shape)continue;let n=e(s);n>i&&(t=s,i=n)}if(!t)return null;let s=t.normal,n=t.s2;return t.s1!==this.body.shapes[0]&&(s.negate(),n=t.s2),{collision:t,contactNormal:s,contactShape:n,contactNormalUpDot:Math.abs(s.dot(this.level.currentUp))}}onBeforeIntegrate(e){var n;let a=!t.menu.finishScreen.showing,r=new s(0,0,0);Te("up")&&r.add(new s(1,0,0)),Te("down")&&r.add(new s(-1,0,0)),Te("left")&&r.add(new s(0,1,0)),Te("right")&&r.add(new s(0,-1,0)),r.add(new s(-Be.marbleY,-Be.marbleX)),Ye&&r.add(new s(-P.signedSquare(Ye.y),-P.signedSquare(Ye.x))),r.x>1&&(r.x=1),r.x<-1&&(r.x=-1),r.y>1&&(r.y=1),r.y<-1&&(r.y=-1),a||r.multiplyScalar(0);let o=r.length();r.multiplyScalar(5*Ui*e),r.applyAxisAngle(new s(0,0,1),this.level.yaw);let l=this.level.newOrientationQuat;r.applyQuaternion(l),this.lastMovementVec.copy(r);let h=this.level.currentUp.clone().cross(r),d=this.findBestCollision(e=>e.normal.dot(this.level.currentUp));if(d){let{collision:t,contactNormal:s,contactNormalUpDot:n}=d,a=(new i).setFromUnitVectors(this.level.currentUp,s);h.applyQuaternion(a);let l=-r.clone().normalize().dot(s),c=Math.max(0,l-Math.max(0,t.s2Friction-1));h.multiplyScalar(1-c);let u=this.body.angularVelocity,m=h.clone().normalize(),p=Math.max(0,u.dot(m));u.addScaledVector(m,-p);let g=this.level.currentUp.clone().cross(s),f=Math.max(u.dot(g),0);if(u.addScaledVector(g,-f),u.multiplyScalar(.02**(Math.min(1,t.friction)*e)),u.addScaledVector(g,f),u.addScaledVector(m,p),u.length()>300*this.speedFac&&u.multiplyScalar(300*this.speedFac/u.length()),p+h.length()>12*Math.PI*2*o/n*this.speedFac){let e=Math.max(0,12*Math.PI*2*o/n*this.speedFac-p);h.normalize().multiplyScalar(e)}}else{h.multiplyScalar(.5);let t=this.level.timeState,i=r.clone(),s=t.currentAttemptTime-this.helicopterEnableTime<5e3?5:3.2;this.level.finishTime&&(s=0),i.multiplyScalar(s*e),this.body.linearVelocity.add(i),this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingSound.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02),null===(n=this.rollingMegaMarbleSound)||void 0===n||n.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02)}h.multiplyScalar(this.speedFac),P.addToVectorCapped(this.body.angularVelocity,h,120*this.speedFac),this.level.finishTime&&this.body.linearVelocity.multiplyScalar(.9),a&&this.level.heldPowerUp&&(Te("use")||this.level.useQueued)&&Ce("use")&&(this.level.replay.recordUsePowerUp(this.level.heldPowerUp),this.level.heldPowerUp.use(0),this.level.useQueued=!1),a&&(Te("blast")||this.level.blastQueued)&&Ce("blast")&&(this.useBlast(),this.level.blastQueued=!1),this.slidingTimeout--}onAfterIntegrate(){this.beforeVel.copy(this.body.linearVelocity),this.beforeAngVel.copy(this.body.angularVelocity);let e=this.level.timeState,t="playback"===this.level.replay.mode;if(e.currentAttemptTime<ir&&!t){let{position:e}=this.level.getStartPositionAndOrientation(),t=this.body.position;t.x=e.x,t.y=e.y;let i=this.body.linearVelocity;i.x=i.y=0;let s=this.body.angularVelocity;s.length()>60&&s.normalize().multiplyScalar(60),this.shape.friction=0}else this.shape.friction=1}onBeforeCollisionResponse(){}onAfterCollisionResponse(){var e,i,s;let n=this.findBestCollision(e=>e.normal.dot(this.level.currentUp));if(!n)return;let{collision:a,contactNormal:r,contactShape:o,contactNormalUpDot:l}=n;this.lastContactNormal.copy(r);let h=this.beforeVel.clone().sub(o.body.linearVelocity),d=this.body.linearVelocity.clone().sub(o.body.linearVelocity),c=-r.dot(h.clone().normalize());if(l>.1&&this.slidingTimeout<=0&&c>.001&&c<=.5&&this.lastMovementVec.length()>0){let e=r.dot(d),t=this.body.linearVelocity,i=t.length();t.addScaledVector(r,-e);let s=t.length(),n=i-s;t.normalize().multiplyScalar(s+2*n)}e:if(a.restitution<.5){let e=-this.beforeVel.dot(r);if(e<0)break e;let t=this.beforeAngVel.clone().cross(r).multiplyScalar(2*(.5-a.restitution)*e/300/.98);this.body.linearVelocity.add(t)}let u=this.body.angularVelocity.clone().cross(r).multiplyScalar((1-Math.abs(l))*r.dot(this.body.linearVelocity)/(2*Math.PI)/15);if(u.length()>=.01){let e=this.body.linearVelocity,t=u.length()/e.length();e.multiplyScalar(1/(1+.5*t)).add(u)}l>1e-6&&!t.menu.finishScreen.showing&&(Te("jump")||this.level.jumpQueued)&&(this.setLinearVelocityInDirection(r,this.jumpImpulse+o.body.linearVelocity.dot(r),!0,()=>{this.playJumpSound(),this.level.replay.canStore&&this.level.replay.jumpSoundTimes.push(this.level.replay.currentTickIndex)}),this.level.jumpQueued=!1);let m=-this.findBestCollision(e=>-e.normal.dot(this.beforeVel.clone().sub(e.s2.body.linearVelocity))).contactNormal.dot(this.beforeVel.clone().sub(o.body.linearVelocity));m>6&&this.showBounceParticles();let p=P.clamp((m/12)**1.5,0,1);if(m>1&&(this.playBounceSound(p),this.level.replay.canStore&&this.level.replay.bounceTimes.push({tickIndex:this.level.replay.currentTickIndex,volume:p,showParticles:m>6})),r.dot(d)<.01){let t=this.body.angularVelocity.clone().cross(this.level.currentUp).multiplyScalar(1/Math.PI/2);if(t.dot(d)<-1e-5||t.length()>.5&&t.length()>1.5*d.length())this.slidingSound.gain.gain.setValueAtTime(.6,this.level.audio.currentTime),this.rollingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingMegaMarbleSound&&this.rollingMegaMarbleSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime);else{this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime);let t=.75*P.clamp(d.length()/15,0,1)+.75;this.rollingSound.gain.gain.linearRampToValueAtTime(P.clamp(t-.75,0,1),this.level.audio.currentTime+.02),null===(e=this.rollingMegaMarbleSound)||void 0===e||e.gain.gain.linearRampToValueAtTime(P.clamp(t-.75,0,1),this.level.audio.currentTime+.02),this.rollingSound.setPlaybackRate(t),null===(i=this.rollingMegaMarbleSound)||void 0===i||i.setPlaybackRate(t)}}else this.slidingSound.gain.gain.setValueAtTime(0,this.level.audio.currentTime),this.rollingSound.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02),null===(s=this.rollingMegaMarbleSound)||void 0===s||s.gain.gain.linearRampToValueAtTime(0,this.level.audio.currentTime+.02)}tick(e){var t,i,n,a,r,o;e.currentAttemptTime-this.shockAbsorberEnableTime<5e3?(this.forcefield.setOpacity(1),this.shape.restitution=.01,this.shockAbsorberSound||(this.shockAbsorberSound=this.level.audio.createAudioSource("superbounceactive.wav"),this.shockAbsorberSound.setLoop(!0),this.shockAbsorberSound.play())):e.currentAttemptTime-this.superBounceEnableTime<5e3?(this.forcefield.setOpacity(1),this.shape.restitution=.9,null===(t=this.shockAbsorberSound)||void 0===t||t.stop(),this.shockAbsorberSound=null):(this.forcefield.setOpacity(0),this.shape.restitution=this.bounceRestitution,null===(i=this.shockAbsorberSound)||void 0===i||i.stop(),this.shockAbsorberSound=null,null===(n=this.superBounceSound)||void 0===n||n.stop(),this.superBounceSound=null),e.currentAttemptTime-this.superBounceEnableTime<5e3&&!this.superBounceSound&&(this.superBounceSound=this.level.audio.createAudioSource("forcefield.wav"),this.superBounceSound.setLoop(!0),this.superBounceSound.play()),e.currentAttemptTime-this.helicopterEnableTime<5e3?(this.helicopter.setOpacity(1),this.helicopter.setTransform(new s(0,0,this.radius-_i).applyQuaternion(this.level.newOrientationQuat),this.level.newOrientationQuat,new s(1,1,1)),this.level.setGravityIntensity(.25*this.level.defaultGravity),this.helicopterSound||(this.helicopterSound=this.level.audio.createAudioSource("use_gyrocopter.wav"),this.helicopterSound.setLoop(!0),this.helicopterSound.play())):(this.helicopter.setOpacity(0),this.level.setGravityIntensity(this.level.defaultGravity),null===(a=this.helicopterSound)||void 0===a||a.stop(),this.helicopterSound=null),this.radius!==Fi&&e.currentAttemptTime-this.megaMarbleEnableTime<1e4?(this.setRadius(Fi),this.body.linearVelocity.addScaledVector(this.level.currentUp,6),this.rollingSound.stop(),null===(r=this.rollingMegaMarbleSound)||void 0===r||r.play()):e.currentAttemptTime-this.megaMarbleEnableTime>=1e4&&(this.setRadius(this.level.mission.hasUltraMarble?Ri:_i),this.rollingSound.play(),null===(o=this.rollingMegaMarbleSound)||void 0===o||o.stop())}playJumpSound(){this.level.audio.play(["jump.wav"])}playBounceSound(e){let t=this.radius===Fi?"mega_":"";this.level.audio.play(["bouncehard1.wav","bouncehard2.wav","bouncehard3.wav","bouncehard4.wav"].map(e=>t+e),e)}showBounceParticles(){this.level.particles.createEmitter(Di,this.body.position,null,new s(1,1,1).addScaledVector(P.absVector(this.level.currentUp.clone()),-.8))}setLinearVelocityInDirection(e,t,i,s=(()=>{})){let n=this.body.linearVelocity.clone().normalize().dot(e)*this.body.linearVelocity.length();if(n<t||!i){let i=this.body.linearVelocity;i.addScaledVector(e,-n),i.addScaledVector(e,t),n<t&&s()}}calculatePredictiveTransforms(){var e;let t=this.body.position,s=this.body.orientation,n=this.body.linearVelocity,a=this.body.angularVelocity,r=t.clone().addScaledVector(n,1/Za).addScaledVector(this.level.world.gravity,1/Za**2/2),o=r.clone().sub(t),l=a.clone().multiplyScalar(1/Za),h=l.length(),d=(new i).setFromAxisAngle(l.normalize(),h).multiply(s),c=this.level.world.castShape(this.shape,o,1).find(e=>!this.body.collisions.some(t=>t.s2===e.shape)),u=null!==(e=null===c||void 0===c?void 0:c.lambda)&&void 0!==e?e:1;this.predictedPosition.lerpVectors(t,r,u),this.predictedOrientation.copy(s).slerp(d,u)}render(e){this.group.position.copy(this.body.position).lerp(this.predictedPosition,e.physicsTickCompletion),this.innerGroup.orientation.copy(this.body.orientation).slerp(this.predictedOrientation,e.physicsTickCompletion),this.group.recomputeTransform(),this.innerGroup.recomputeTransform(),this.forcefield.render(e),e.currentAttemptTime-this.helicopterEnableTime<5e3&&this.helicopter.render(e);let t=0;null!==this.teleportEnableTime&&(t=P.clamp((e.currentAttemptTime-this.teleportEnableTime)/zi,0,1)),null!==this.teleportDisableTime&&(t=P.clamp(1-(e.currentAttemptTime-this.teleportDisableTime)/zi,0,1)),this.sphere.opacity=t>0?P.lerp(1,.25,t):Number(!this.ballShape)}renderReflection(){this.isReflective()&&(this.cubeCamera.position.copy(this.group.position),this.cubeMap.render(this.level.scene,this.cubeCamera,4))}enableSuperBounce(e){this.superBounceEnableTime=e.currentAttemptTime}enableShockAbsorber(e){this.shockAbsorberEnableTime=e.currentAttemptTime}enableHelicopter(e){this.helicopterEnableTime=e.currentAttemptTime}enableTeleportingLook(e){let t=null!==this.teleportDisableTime?P.clamp((e.currentAttemptTime-this.teleportDisableTime)/zi,0,1):1;this.teleportEnableTime=e.currentAttemptTime-zi*(1-t),this.teleportDisableTime=null}disableTeleportingLook(e){var t;let i=null!==(t=P.clamp((e.currentAttemptTime-this.teleportEnableTime)/zi,0,1))&&void 0!==t?t:1;this.teleportDisableTime=e.currentAttemptTime-zi*(1-i),this.teleportEnableTime=null}enableMegaMarble(e){this.megaMarbleEnableTime=e.currentAttemptTime}useBlast(){if(this.level.blastAmount<.2||!this.level.mission.hasBlast)return;let e=this.level.currentUp.clone().multiplyScalar(10*Math.max(Math.sqrt(this.level.blastAmount),this.level.blastAmount));this.body.linearVelocity.add(e),this.level.audio.play("blast.wav"),this.level.particles.createEmitter(this.level.blastAmount>1?Oi:Vi,null,()=>this.body.position.clone().addScaledVector(this.level.currentUp,.4*-this.radius),new s(1,1,1).addScaledVector(P.absVector(this.level.currentUp.clone()),-.8)),this.level.blastAmount=0,this.level.replay.recordUseBlast()}setRadius(e){var t;this.radius!==e&&(this.radius=e,this.sphere.scale.setScalar(e),this.sphere.recomputeTransform(),null===(t=this.ballShape)||void 0===t||t.setTransform(new s,new i,(new s).setScalar(e/_i)),this.shape.radius=e,this.shape.updateInertiaTensor(),this.largeAuxShape.radius=2*e,this.smallAuxShape.radius=e,this.body.syncShapes(),this.forcefield.group.scale.setScalar(this.radius/_i),this.forcefield.group.recomputeTransform())}reset(){this.body.linearVelocity.setScalar(0),this.body.angularVelocity.setScalar(0),this.superBounceEnableTime=-1/0,this.shockAbsorberEnableTime=-1/0,this.helicopterEnableTime=-1/0,this.teleportEnableTime=null,this.teleportDisableTime=null,this.megaMarbleEnableTime=-1/0,this.lastContactNormal.set(0,0,0),this.beforeVel.set(0,0,0),this.beforeAngVel.set(0,0,0),this.slidingTimeout=0,this.predictedPosition.copy(this.body.position),this.predictedOrientation.copy(this.body.orientation),this.setRadius(this.level.mission.hasUltraMarble?Ri:_i)}dispose(){var e;null===(e=this.cubeMap)||void 0===e||e.dispose()}}class qi extends ei{constructor(){super(...arguments),this.dtsPath="shapes/pads/startarea.dts"}}class ji extends ei{constructor(){super(...arguments),this.dtsPath="shapes/signs/finishlinesign.dts"}}class Gi extends ei{constructor(e){switch(super(),this.dtsPath="shapes/signs/plainsign.dts",this.shareMaterials=!1,e.datablock.slice("SignPlain".length).toLowerCase()){case"right":this.matNamesOverride["base.plainsign"]="right.plainsign";break;case"left":this.matNamesOverride["base.plainsign"]="left.plainsign";break;case"up":this.matNamesOverride["base.plainsign"]="up.plainsign";break;case"down":this.matNamesOverride["base.plainsign"]="down.plainsign"}}}class Wi extends ei{constructor(e){if(super(),this.dtsPath="shapes/pads/endarea.dts",this.fireworks=[],this.sounds=["firewrks.wav"],this.inArea=0,!e)return;let t=new d;t.compose(new s(0,0,2.6),(new i).setFromEuler(new Li(-Math.PI/2,0,0)),new s(1,1,1)),this.addCollider(e=>{let t=P.createCylinderConvexHull(1.7,2.4,64,new s(e.x,1,e.y));return t.margin=.005,t},e=>{let t=this.inArea>0;this.inArea=2,t||this.level.touchFinish(e)},t)}spawnFirework(e){let t=new $i(this.level,this.worldPosition,e.timeSinceLoad);this.fireworks.push(t),this.level.audio.play(this.sounds[0],1,void 0,this.worldPosition)}tick(e,t){if(!t){super.tick(e);for(let t of this.fireworks.slice())t.tick(e.timeSinceLoad),e.timeSinceLoad-t.spawnTime>=1e4&&P.removeFromArray(this.fireworks,t);this.inArea--}}}const Hi={ejectionPeriod:100,ambientVelocity:new s(0,0,1),ejectionVelocity:0,velocityVariance:0,emitterLifetime:4e3,spawnOffset(){let e=P.randomPointInUnitCircle();return new s(1.6*e.x,1.6*e.y,.4*Math.random()-.5)},inheritedVelFactor:0,particleOptions:{texture:"particles/saturn.png",blending:ae.Normal,spinSpeed:0,spinRandomMin:-90,spinRandomMax:90,lifetime:2e3,lifetimeVariance:200,dragCoefficient:.5,acceleration:0,colors:[{r:1,g:1,b:0,a:0},{r:1,g:0,b:0,a:1},{r:1,g:0,b:0,a:0}],sizes:[.1,.2,.3],times:[0,.2,1]}},Xi={ejectionPeriod:30,ambientVelocity:new s(0,0,0),ejectionVelocity:0,velocityVariance:0,emitterLifetime:1e4,inheritedVelFactor:0,particleOptions:{texture:"particles/spark.png",blending:ae.Normal,spinSpeed:0,spinRandomMin:-90,spinRandomMax:90,lifetime:600,lifetimeVariance:100,dragCoefficient:0,acceleration:0,colors:[{r:1,g:1,b:0,a:1},{r:1,g:0,b:0,a:1},{r:1,g:0,b:0,a:0}],sizes:[.1,.05,.01],times:[0,.5,1]}},Yi={ejectionPeriod:30,ambientVelocity:new s(0,0,0),ejectionVelocity:0,velocityVariance:0,emitterLifetime:1e4,inheritedVelFactor:0,particleOptions:{texture:"particles/spark.png",blending:ae.Normal,spinSpeed:0,spinRandomMin:-90,spinRandomMax:90,lifetime:600,lifetimeVariance:100,dragCoefficient:0,acceleration:0,colors:[{r:0,g:0,b:1,a:1},{r:.5,g:.5,b:1,a:1},{r:1,g:1,b:1,a:0}],sizes:[.1,.05,.01],times:[0,.5,1]}},Ki={ejectionPeriod:1,ambientVelocity:new s(0,0,0),ejectionVelocity:.8,velocityVariance:.25,emitterLifetime:10,inheritedVelFactor:0,particleOptions:{texture:"particles/star.png",blending:ae.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:500,lifetimeVariance:50,dragCoefficient:.5,acceleration:0,colors:[{r:1,g:1,b:0,a:1},{r:1,g:1,b:0,a:1},{r:1,g:0,b:0,a:0}],sizes:[.2,.2,.2],times:[0,.5,1]}},Qi={ejectionPeriod:1,ambientVelocity:new s(0,0,0),ejectionVelocity:.5,velocityVariance:.25,emitterLifetime:10,inheritedVelFactor:0,particleOptions:{texture:"particles/bubble.png",blending:ae.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:2e3,lifetimeVariance:200,dragCoefficient:0,acceleration:0,colors:[{r:0,g:0,b:1,a:1},{r:.5,g:.5,b:1,a:1},{r:1,g:1,b:1,a:0}],sizes:[.2,.2,.2],times:[0,.5,1]}};class $i extends I{constructor(e,t,i){super(),this.trails=[],this.wavesLeft=4,this.level=e,this.pos=t,this.spawnTime=i,this.level.particles.createEmitter(Hi,this.pos),this.doWave(this.spawnTime)}tick(e){this.tickSchedule(e);for(let t of this.trails.slice()){let i=P.clamp((e-t.spawnTime)/t.lifetime,0,1);i=1-(1-i)**2;let n=this.pos.clone().multiplyScalar(1-i).add(t.targetPos.clone().multiplyScalar(i));n.sub(new s(0,0,1).multiplyScalar(i**2)),t.smokeEmitter.setPos(n,e),1===i&&(this.level.particles.removeEmitter(t.smokeEmitter),P.removeFromArray(this.trails,t),"red"===t.type?this.level.particles.createEmitter(Ki,n):this.level.particles.createEmitter(Qi,n))}}doWave(e){let t=Math.floor(17+10*Math.random());for(let i=0;i<t;i++)this.spawnTrail(e);if(this.wavesLeft--,this.wavesLeft>0){let t=e+500+1e3*Math.random();this.schedule(t,()=>this.doWave(t))}}spawnTrail(e){let t=Math.random()<.5?"red":"blue",i=250+2e3*Math.random(),n=.5+i/5e3,a=this.level.particles.createEmitter("red"===t?Xi:Yi,this.pos),r=P.randomPointInUnitCircle(),o={type:t,smokeEmitter:a,targetPos:new s(3*r.x,3*r.y,1+3*Math.sqrt(Math.random())).multiplyScalar(n).add(this.pos),spawnTime:e,lifetime:i};this.trails.push(o)}}const Zi=["blue","red","yellow","purple","green","turquoise","orange","black"];class Ji extends ei{constructor(e){super(),this.dtsPath="shapes/items/gem.dts",this.ambientRotate=!0,this.collideable=!1,this.pickedUp=!1,this.shareMaterials=!1,this.showSequences=!1,this.sounds=["gotgem.wav","gotallgems.wav","missinggems.wav"];let t=e.datablock.slice("GemItem".length);0===t.length&&(t=Ji.pickRandomColor()),this.matNamesOverride["base.gem"]=t.toLowerCase()+".gem"}onMarbleInside(e){this.pickedUp||(this.pickedUp=!0,this.setOpacity(0),this.level.pickUpGem(e),this.level.replay.recordMarbleInside(this),this.setCollisionEnabled(!1))}reset(){super.reset(),this.pickedUp=!1,this.setOpacity(1),this.setCollisionEnabled(!0)}static pickRandomColor(){return P.randomFromArray(Zi)}}const es=7e3;class ts extends ei{constructor(e){super(),this.lastPickUpTime=null,this.cooldownDuration=es,this.autoUse=!1,this.ambientRotate=!0,this.collideable=!1,this.shareMaterials=!1,this.customPickUpAlert=null,this.an=!1,this.element=e}onMarbleInside(e){var i;let s=this.level.timeState;if((null===this.lastPickUpTime||s.currentAttemptTime-this.lastPickUpTime>=this.cooldownDuration)&&this.pickUp()){this.level.replay.recordMarbleInside(this),this.lastPickUpTime=s.currentAttemptTime,this.autoUse&&this.use(e),t.menu.hud.displayAlert(null!==(i=this.customPickUpAlert)&&void 0!==i?i:`You picked up ${this.an?"an":"a"} ${this.pickUpName}!`),"1"!==this.element.showhelponpickup||this.autoUse||t.menu.hud.displayHelp(`Press <func:bind mousefire> to use the ${this.pickUpName}!`),this.bodies[0].enabled=!1}}tick(e,t){if(super.tick(e,t),t)return;let i=null===this.lastPickUpTime||e.currentAttemptTime-this.lastPickUpTime>=this.cooldownDuration;this.setCollisionEnabled(i)}render(e){super.render(e);let t=1;if(this.lastPickUpTime&&this.cooldownDuration>0){let i=this.lastPickUpTime+this.cooldownDuration;t=P.clamp((e.currentAttemptTime-i)/1e3,0,1)}this.setOpacity(t)}reset(){super.reset(),this.bodies[0].enabled=!0,this.lastPickUpTime=null}}class is extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/superjump.dts",this.pickUpName="gold"===t.modification?"Super Jump PowerUp":"Jump Boost PowerUp",this.sounds=["pusuperjumpvoice.wav","dosuperjump.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){let e=this.level.marble;e.body.linearVelocity.addScaledVector(this.level.currentUp,20),this.level.audio.play(this.sounds[1]),this.level.particles.createEmitter(ss,null,()=>e.body.position.clone()),this.level.deselectPowerUp()}}const ss={ejectionPeriod:10,ambientVelocity:new s(0,0,.05),ejectionVelocity:.5,velocityVariance:.125,emitterLifetime:1e3,inheritedVelFactor:.1,particleOptions:{texture:"particles/twirl.png",blending:ae.Additive,spinSpeed:90,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.25,acceleration:0,colors:[{r:0,g:.5,b:1,a:0},{r:0,g:.6,b:1,a:1},{r:0,g:.6,b:1,a:0}],sizes:[.25,.25,.5],times:[0,.75,1]}};class ns extends ei{constructor(e){switch(super(),this.dtsPath="shapes/signs/cautionsign.dts",this.shareMaterials=!1,e.datablock.slice("SignCaution".length).toLowerCase()){case"caution":this.matNamesOverride["base.cautionsign"]="caution.cautionsign";break;case"danger":this.matNamesOverride["base.cautionsign"]="danger.cautionsign"}}}class as extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/superbounce.dts",this.pickUpName="gold"===t.modification?"Super Bounce PowerUp":"Marble Recoil PowerUp",this.sounds=["pusuperbouncevoice.wav","forcefield.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableSuperBounce(this.level.timeState),this.level.deselectPowerUp()}}class rs extends ei{constructor(){super(...arguments),this.wiggleAnimationStart=-1/0,this.shareNodeTransforms=!1}get animationDuration(){return 1e3*this.dts.sequences[0].duration}onMarbleContact(e){let t=this.level.timeState;if(this.wiggleAnimationStart=t.timeSinceLoad,this.level.audio.play(this.sounds[0]),!e)return;let i=this.level.marble;i.setLinearVelocityInDirection(e.normal,15,!1),i.slidingTimeout=2,this.level.replay.recordMarbleContact(this)}render(e){let t=P.clamp((e.timeSinceLoad-this.wiggleAnimationStart)/this.animationDuration,0,1);this.sequenceKeyframeOverride.set(this.dts.sequences[0],t*(this.dts.sequences[0].numKeyframes-1)),super.render(e)}}class os extends rs{constructor(){super(...arguments),this.dtsPath="shapes/bumpers/pball_round.dts",this.sounds=["bumperding1.wav"]}}class ls extends ts{constructor(){super(...arguments),this.dtsPath="shapes/images/helicopter.dts",this.showSequences=!1,this.shareNodeTransforms=!1,this.pickUpName="gold"===t.modification?"Gyrocopter PowerUp":"Helicopter PowerUp",this.sounds=["pugyrocoptervoice.wav","use_gyrocopter.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableHelicopter(this.level.timeState),this.level.deselectPowerUp()}}class hs extends ei{addConicForce(e,t,i){let n=t/2,a=i-i*(.7/e),r=e-.7;this.addCollider(()=>new C(e),(e,t)=>{let i=this.level.marble,o=new s(0,0,1);o.applyQuaternion(this.worldOrientation);let l=this.worldPosition.clone().sub(o.multiplyScalar(.7)),h=i.body.position.clone().sub(l);if(0===h.length())return;if(h.length()>r)return;let d=P.lerp(a,0,h.length()/r),c=o.angleTo(h);if(c>n/2)return;let u=Math.abs(-d*(c-n)*(c+n));u*=Math.sign(a);let m=h.clone();m.normalize(),i.body.linearVelocity.addScaledVector(m,u*t)},new d)}addConicForceExceptItsAccurateThisTime(e,t,i){this.addCollider(()=>new C(e),(s,n)=>{let a=this.computeAccurateConicForce(e,t,i);a.multiplyScalar(n),this.level.marble.body.linearVelocity.add(a)},new d)}computeAccurateConicForce(e,t,i){let n=this.level.marble.body.position,a=0,r=0,o=new s,l=new s,h=this.worldMatrix.clone(),d=new s(h.elements[4],h.elements[5],h.elements[6]);if(d.normalize(),e<(r=(o=n.clone().sub((new s).setFromMatrixPosition(h))).length()))return l;a=(1-r/e)*i,o.multiplyScalar(1/r);let c=d.dot(o),u=t;return u<c&&l.add(o.multiplyScalar(a).multiplyScalar(c-u).multiplyScalar(1/(1-u))),l}addSphericalForce(e,t){this.addCollider(()=>new C(e),(i,s)=>{let n=this.level.marble,a=n.body.position.clone().sub(this.worldPosition);if(0===a.length())return;let r=1-P.clamp(a.length()/e,0,1)**2;n.body.linearVelocity.addScaledVector(a.normalize(),t*r*s)},new d)}addFieldForce(e,t){this.addCollider(()=>new C(e),(i,s)=>{let n=this.level.marble;n.body.position.distanceTo(this.worldPosition)>=e||n.body.linearVelocity.addScaledVector(t,s)},new d)}}class ds extends hs{constructor(){super(),this.dtsPath="shapes/hazards/ductfan.dts",this.sounds=["fan_loop.wav"],this.addConicForce(10,2.617,40)}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}class cs extends ts{constructor(e,i=!1){super(e),this.dtsPath="shapes/items/antigravity.dts",this.autoUse=!0,this.pickUpName="gold"===t.modification?"Gravity Modifier":"Gravity Defier",this.sounds=["gravitychange.wav"],i&&(this.cooldownDuration=-1/0)}pickUp(){let e=new s(0,0,-1);return e.applyQuaternion(this.worldOrientation).normalize(),!P.isSameVector(e,this.level.currentUp)}use(){let e=new s(0,0,-1);e.applyQuaternion(this.worldOrientation),this.level.setUp(e),this.level.audio.play(this.sounds[0])}}class us extends ei{constructor(){super(...arguments),this.dtsPath="shapes/hazards/landmine.dts",this.disappearTime=-1/0,this.sounds=["explode1.wav"],this.shareMaterials=!1}onMarbleContact(){let e=this.level.timeState,t=this.level.marble,i=this.worldPosition,s=t.body.position.clone().sub(i),n=this.computeExplosionStrength(s.length());t.body.linearVelocity.addScaledVector(s.normalize(),n),t.slidingTimeout=2,this.disappearTime=e.timeSinceLoad,this.setCollisionEnabled(!1),this.level.audio.play(this.sounds[0]),this.level.particles.createEmitter(ms,this.worldPosition),this.level.particles.createEmitter(ps,this.worldPosition),this.level.particles.createEmitter(gs,this.worldPosition),this.level.replay.recordMarbleContact(this)}computeExplosionStrength(e){if(e>=10.25)return 0;if(e>=10)return P.lerp(30.0087,30.7555,e-10);return(e-5)**2/-.285744888+87.5}tick(e,t){if(t)return;let i=e.timeSinceLoad>=this.disappearTime+5e3;this.setCollisionEnabled(i)}render(e){let t=P.clamp((e.timeSinceLoad-(this.disappearTime+5e3))/1e3,0,1);this.setOpacity(t)}}const ms={ejectionPeriod:.2,ambientVelocity:new s(0,0,0),ejectionVelocity:2,velocityVariance:1,emitterLifetime:50,inheritedVelFactor:.2,particleOptions:{texture:"particles/smoke.png",blending:ae.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.8,acceleration:0,colors:[{r:.56,g:.36,b:.26,a:1},{r:.56,g:.36,b:.26,a:0}],sizes:[.5,1],times:[0,1]}},ps={ejectionPeriod:.5,ambientVelocity:new s(0,0,0),ejectionVelocity:.8,velocityVariance:.4,emitterLifetime:50,inheritedVelFactor:.25,particleOptions:{texture:"particles/smoke.png",blending:ae.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1200,lifetimeVariance:300,dragCoefficient:.85,acceleration:-8,colors:[{r:.56,g:.36,b:.26,a:1},{r:.2,g:.2,b:.2,a:1},{r:0,g:0,b:0,a:0}],sizes:[1,1.5,2],times:[0,.5,1]}},gs={ejectionPeriod:.4,ambientVelocity:new s(0,0,0),ejectionVelocity:3.25,velocityVariance:1.6875,emitterLifetime:100,inheritedVelFactor:.2,particleOptions:{texture:"particles/spark.png",blending:ae.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:500,lifetimeVariance:350,dragCoefficient:.75,acceleration:-8,colors:[{r:.6,g:.4,b:.3,a:1},{r:.6,g:.4,b:.3,a:1},{r:1,g:.4,b:.3,a:0}],sizes:[.5,.25,.25],times:[0,.5,1]}};class fs extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/shockabsorber.dts",this.pickUpName="gold"===t.modification?"Shock Absorber PowerUp":"Anti-Recoil PowerUp",this.an="gold"!==t.modification,this.sounds=["pushockabsorbervoice.wav","superbounceactive.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableShockAbsorber(this.level.timeState),this.level.deselectPowerUp()}}class ys extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/superspeed.dts",this.pickUpName="gold"===t.modification?"Super Speed PowerUp":"Speed Booster PowerUp",this.sounds=["pusuperspeedvoice.wav","dosuperspeed.wav"]}pickUp(){return this.level.pickUpPowerUp(this)}use(){let e=this.level,t=this.level.marble,n=new s(1,0,0);n.applyAxisAngle(new s(0,0,1),e.yaw);let a=e.newOrientationQuat;n.applyQuaternion(a);let r=new i;r.setFromUnitVectors(this.level.currentUp,t.lastContactNormal),n.applyQuaternion(r),t.body.linearVelocity.addScaledVector(n,24.7),this.level.audio.play(this.sounds[1]),this.level.particles.createEmitter(bs,null,()=>t.body.position.clone()),this.level.deselectPowerUp()}}const bs={ejectionPeriod:5,ambientVelocity:new s(0,0,.2),ejectionVelocity:.5,velocityVariance:.125,emitterLifetime:1100,inheritedVelFactor:.25,particleOptions:{texture:"particles/spark.png",blending:ae.Additive,spinSpeed:0,spinRandomMin:0,spinRandomMax:0,lifetime:1500,lifetimeVariance:150,dragCoefficient:.25,acceleration:0,colors:[{r:.8,g:.8,b:0,a:0},{r:.8,g:.8,b:0,a:1},{r:.8,g:.8,b:0,a:0}],sizes:[.25,.25,1],times:[0,.25,1]}};class vs extends ts{constructor(e){super(e),this.dtsPath="shapes/items/timetravel.dts",this.cooldownDuration=1/0,this.autoUse=!0,this.timeBonus=5e3,this.sounds=["putimetravelvoice.wav","timetravelactive.wav"],this.pickUpName="",e.timebonus&&(this.timeBonus=ci.parseNumber(e.timebonus)),e.timepenalty&&(this.timeBonus=-ci.parseNumber(e.timepenalty)),"gold"===t.modification?this.pickUpName=`${this.timeBonus/1e3} second Time Travel bonus`:this.pickUpName=`${Math.abs(this.timeBonus/1e3)} second Time ${this.timeBonus>=0?"Modifier":"Penalty"}`}pickUp(){return this.level.audio.play(this.sounds[0]),!0}use(e){let t=1e3*(1-e)/Za;"playback"===this.level.replay.mode?t=this.level.replay.timeTravelTimeToRevert.get(this.id):this.level.replay.timeTravelTimeToRevert.set(this.id,t),this.level.addTimeTravelBonus(this.timeBonus,t)}}class ws extends hs{constructor(){super(),this.dtsPath="shapes/hazards/tornado.dts",this.collideable=!1,this.sounds=["tornado.wav"],this.addSphericalForce(8,-60),this.addSphericalForce(3,60),this.addFieldForce(3,new s(0,0,150))}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}const xs=5e3;class Ss extends ei{constructor(e){super(),this.dtsPath="shapes/hazards/trapdoor.dts",this.hasNonVisualSequences=!0,this.shareNodeTransforms=!1,this.lastContactTime=-1/0,this.timeout=0,this.lastCompletion=0,this.sounds=["trapdooropen.wav"],e.timeout&&(this.timeout=ci.parseNumber(e.timeout))}get animationDuration(){return 1e3*this.dts.sequences[0].duration}tick(e,t){let i=this.getCurrentCompletion(e);if(this.sequenceKeyframeOverride.set(this.dts.sequences[0],i*(this.dts.sequences[0].numKeyframes-1)),super.tick(e,t),t)return;let s=Math.sign(i-this.lastCompletion);0!==s&&s!==this.lastDirection&&this.level.audio.play(this.sounds[0],void 0,void 0,this.worldPosition),this.lastCompletion=i,this.lastDirection=s}getCurrentCompletion(e){let t=e.timeSinceLoad-this.lastContactTime,i=P.clamp(t/this.animationDuration,0,1);return t>xs&&(i=P.clamp(1-(t-xs)/this.animationDuration,0,1)),i}onMarbleContact(){let e=this.level.timeState;if(e.timeSinceLoad-this.lastContactTime<=0)return;let t=this.getCurrentCompletion(e);this.lastContactTime=e.timeSinceLoad-t*this.animationDuration,0===t&&(this.lastContactTime+=this.timeout),this.level.replay.recordMarbleContact(this)}}class Ts extends rs{constructor(){super(...arguments),this.dtsPath="shapes/bumpers/pball_tri.dts",this.sounds=["bumper1.wav"]}}class Ms extends ei{constructor(){super(...arguments),this.dtsPath="shapes/hazards/oilslick.dts",this.friction=Rt.friction_none}}class ks extends hs{constructor(){super(),this.dtsPath="shapes/hazards/ductfan.dts",this.sounds=["fan_loop.wav"],this.addConicForce(5,2.617,10)}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}class Cs{constructor(e,t){this.sounds=[],this.isCurrentlyColliding=!1,this.id=e._id,this.element=e,this.level=t;let i=ci.parseNumberList(e.polyhedron),n=new s(i[0],i[1],i[2]),a=new s(i[3],i[4],i[5]),o=new s(i[6],i[7],i[8]),l=new s(i[9],i[10],i[11]),h=n.clone(),c=n.clone().add(a),u=n.clone().add(o),m=n.clone().add(l),p=n.clone().add(a).add(o),g=n.clone().add(a).add(l),f=n.clone().add(o).add(l),y=n.clone().add(a).add(o).add(l),b=new d;b.compose(ci.parseVector3(e.position),ci.parseRotation(e.rotation),ci.parseVector3(e.scale));let v=[h,c,u,m,p,g,f,y].map(e=>e.applyMatrix4(b));this.vertices=v;let w=(new r).setFromPoints(v),x=P.getBoxVertices(w),S=new E(x);S.collisionDetectionMask=4;let T=new Ct;T.type=St.Static,T.addCollisionShape(S),this.body=T,T.onBeforeIntegrate=(()=>{this.isCurrentlyColliding&&0===T.collisions.length&&(this.isCurrentlyColliding=!1,this.onMarbleLeave())}),T.onBeforeCollisionResponse=(()=>{this.isCurrentlyColliding||this.onMarbleEnter(),this.onMarbleInside(),this.isCurrentlyColliding=!0}),this.reset()}async init(){for(let e of this.sounds)await this.level.audio.loadBuffer(e)}reset(){this.isCurrentlyColliding=!1}onMarbleInside(){}onMarbleEnter(){}onMarbleLeave(){}tick(e){}}class Es extends Cs{constructor(e,t){super(e,t.level),this.interior=t}onMarbleEnter(){let e=this.level.timeState;this.interior.setTargetTime(e,ci.parseNumber(this.element.targettime)),"1"===this.element.instant&&(this.element.icontinuetottime&&"0"!==this.element.icontinuetottime?(this.interior.currentTime=this.interior.targetTime,this.interior.targetTime=ci.parseNumber(this.element.icontinuetottime)):this.interior.changeTime=-1/0),this.level.replay.recordMarbleEnter(this)}}let As=new s,Bs=new d;class Ps extends qt{constructor(){super(...arguments),this.triggers=[],this.currentTime=0,this.targetTime=0,this.changeTime=0,this.prevPosition=new s,this.currentPosition=new s,this.allowSpecialMaterials=!1}static async createFromSimGroup(e,t){let i=e.elements.find(e=>e._type===Jt.PathedInterior),{dif:s,path:n}=await t.mission.getDif(i.interiorresource);if(!s)return null;let a=new Ps(s,n,t,ci.parseNumber(i.interiorindex));return a.simGroup=e,a.element=i,t.interiors.push(a),await P.wait(10),await a.init(i._id),a}async init(e){var t;await super.init(e),this.basePosition=ci.parseVector3(this.element.baseposition),this.baseOrientation=ci.parseRotation(this.element.baserotation),this.baseScale=ci.parseVector3(this.element.basescale),this.hasCollision=0!==this.baseScale.x&&0!==this.baseScale.y&&0!==this.baseScale.z,0===this.baseScale.x&&(this.baseScale.x=1e-4),0===this.baseScale.y&&(this.baseScale.y=1e-4),0===this.baseScale.z&&(this.baseScale.z=1e-4),this.body.onBeforeIntegrate=this.onBeforeIntegrate.bind(this),this.body.orientation.copy(this.baseOrientation);for(let e=0;e<this.detailLevel.convexHulls.length;e++)this.addConvexHull(e,this.baseScale);this.path=this.simGroup.elements.find(e=>e._type===Jt.Path),this.markerData=this.path.markers.map(e=>({msToNext:ci.parseNumber(e.mstonext),smoothingType:e.smoothingtype,position:ci.parseVector3(e.position),rotation:ci.parseRotation(e.rotation)})),ci.parseBoolean(this.path.isLooping)&&this.markerData.push(this.markerData[0]),this.computeDuration();let i=this.simGroup.elements.filter(e=>e._type===Jt.Trigger);for(let e of i){if(!e.targettime)continue;let t=new Es(e,this);this.triggers.push(t)}"pathedmovingblock"===(null===(t=this.element.datablock)||void 0===t?void 0:t.toLowerCase())&&(this.soundPosition=new s,this.soundSource=this.level.audio.createAudioSource("movingblockloop.wav",void 0,this.soundPosition),this.soundSource.setLoop(!0),await this.soundSource.promise),this.reset()}async onLevelStart(){var e;null===(e=this.soundSource)||void 0===e||e.play()}computeDuration(){let e=0;for(let t=0;t<this.markerData.length-1;t++)e+=this.markerData[t].msToNext;this.duration=e}setTargetTime(e,t){let i=this.getInternalTime(e.currentAttemptTime);this.currentTime=i,this.targetTime=t,this.changeTime=e.currentAttemptTime}getInternalTime(e){if(this.targetTime<0){let t=-1===this.targetTime?1:-2===this.targetTime?-1:0;return P.adjustedMod(this.currentTime+(e-this.changeTime)*t,this.duration)}{let t=Math.abs(this.currentTime-this.targetTime),i=P.clamp(t?(e-this.changeTime)/t:1,0,1);return P.clamp(P.lerp(this.currentTime,this.targetTime,i),0,this.duration)}}tick(e){var t,i,n;this.body.position.copy(this.currentPosition);let a=this.getTransformAtTime(Bs,this.getInternalTime(e.currentAttemptTime));this.prevPosition.copy(this.currentPosition),this.currentPosition.setFromMatrixPosition(a);let r=As.copy(this.currentPosition).sub(this.prevPosition).multiplyScalar(Za);this.body.linearVelocity.copy(r),null===(t=this.soundPosition)||void 0===t||t.copy(this.currentPosition).add(null!==(n=null===(i=this.markerData[0])||void 0===i?void 0:i.position)&&void 0!==n?n:new s)}onBeforeIntegrate(){this.body.position.copy(this.currentPosition),this.body.syncShapes()}getTransformAtTime(e,t){let i=this.markerData[0],s=this.markerData[1];if(!i)return e.compose(this.basePosition,this.baseOrientation,this.baseScale),e;let n=i.msToNext,a=2;for(;n<t&&a<this.markerData.length;)i=s,s=this.markerData[a++],n+=i.msToNext;s||(s=i);let r,o=n-i.msToNext,l=n-o,h=P.clamp(l?(t-o)/l:1,0,1);if("Accelerate"===i.smoothingType)h=.5*Math.sin(h*Math.PI-Math.PI/2)+.5;else if("Spline"===i.smoothingType){let e=a-2-1,t=a-1+1;t>=this.path.markers.length&&(t=0),e<0&&(e=this.path.markers.length-1);let n=this.markerData[e].position,o=i.position,l=s.position,d=this.markerData[t].position;(r=As).x=P.catmullRom(h,n.x,o.x,l.x,d.x),r.y=P.catmullRom(h,n.y,o.y,l.y,d.y),r.z=P.catmullRom(h,n.z,o.z,l.z,d.z)}if(!r){let e=i.position,t=s.position;r=As.copy(e).lerp(t,h)}let d=this.markerData[0].position;return r.sub(d),r.add(this.basePosition),e.compose(r,this.baseOrientation,this.baseScale),e}render(e){let t=this.getTransformAtTime(Bs,this.getInternalTime(e.currentAttemptTime));this.mesh.transform.copy(t),this.mesh.changedTransform(),this.body.position.setFromMatrixPosition(t),this.body.syncShapes()}reset(){var e,t,i;this.currentTime=0,this.targetTime=0,this.changeTime=0,this.element.initialposition&&(this.currentTime=ci.parseNumber(this.element.initialposition)),this.element.initialtargetposition&&(this.targetTime=ci.parseNumber(this.element.initialtargetposition),this.targetTime>0&&this.targetTime<50&&(this.currentTime=this.duration));let n=this.getTransformAtTime(Bs,this.getInternalTime(0));this.prevPosition.setFromMatrixPosition(n),this.currentPosition.setFromMatrixPosition(n),this.body.position.copy(this.currentPosition),this.body.syncShapes(),null===(e=this.soundPosition)||void 0===e||e.copy(this.currentPosition).add(null!==(i=null===(t=this.markerData[0])||void 0===t?void 0:t.position)&&void 0!==i?i:new s)}}class Is extends Cs{onMarbleLeave(){this.level.goOutOfBounds(),this.level.replay.recordMarbleLeave(this)}}class Ls extends Cs{constructor(){super(...arguments),this.sounds=["infotutorial.wav"]}onMarbleEnter(){t.menu.hud.displayHelp(this.element.text,!0),this.level.replay.recordMarbleEnter(this)}}class _s extends Cs{onMarbleInside(){this.level.goOutOfBounds(),this.level.replay.recordMarbleInside(this)}}const Rs=5e3;class Fs extends ei{constructor(){super(...arguments),this.dtsPath="shapes/buttons/pushbutton.dts",this.lastContactTime=-1/0,this.shareNodeTransforms=!1}get animationDuration(){return 1e3*this.dts.sequences[0].duration}tick(e,t){let i=this.getCurrentCompletion(e);this.sequenceKeyframeOverride.set(this.dts.sequences[0],i*(this.dts.sequences[0].numKeyframes-1)),super.tick(e,t)}getCurrentCompletion(e){let t=e.timeSinceLoad-this.lastContactTime,i=P.clamp(t/this.animationDuration,0,1);return t>Rs&&(i=P.clamp(1-(t-Rs)/this.animationDuration,0,1)),i}onMarbleContact(){let e=this.level.timeState;0===this.getCurrentCompletion(e)&&(this.lastContactTime=e.timeSinceLoad),this.level.replay.recordMarbleContact(this)}}class Us extends ei{constructor(e){if(super(),this.dtsPath="shapes/signs/sign.dts","arrow"!==e.datablock.toLowerCase()){switch(e.datablock.slice("Sign".length).toLowerCase()){case"":this.dtsPath="shapes/signs/sign.dts";break;case"down":this.dtsPath="shapes/signs/signdown.dts";break;case"up":this.dtsPath="shapes/signs/signup.dts";break;case"side":this.dtsPath="shapes/signs/signside.dts";break;case"downside":this.dtsPath="shapes/signs/signdown-side.dts";break;case"upside":this.dtsPath="shapes/signs/signup-side.dts"}}}}class zs extends hs{constructor(){super(),this.dtsPath="shapes/hazards/magnet/magnet.dts",this.collideable=!1,this.sounds=["magnet.wav"],this.addConicForceExceptItsAccurateThisTime(10,.7,-90)}async onLevelStart(){this.soundSource=this.level.audio.createAudioSource(this.sounds[0],void 0,this.worldPosition),this.soundSource.setLoop(!0),this.soundSource.play(),await this.soundSource.promise}}class Ds extends ei{constructor(){super(...arguments),this.dtsPath="shapes/hazards/nuke/nuke.dts",this.disappearTime=-1/0,this.sounds=["nukeexplode.wav"],this.shareMaterials=!1}onMarbleContact(){let e=this.level.timeState,t=this.level.marble,i=this.worldPosition,s=this.computeExplosionForce(t.body.position.clone().sub(i));t.body.linearVelocity.add(s),t.slidingTimeout=2,this.disappearTime=e.timeSinceLoad,this.setCollisionEnabled(!1),this.level.audio.play(this.sounds[0]),this.level.particles.createEmitter(Vs,this.worldPosition),this.level.particles.createEmitter(Os,this.worldPosition),this.level.particles.createEmitter(Ns,this.worldPosition),this.level.replay.recordMarbleContact(this)}computeExplosionForce(e){let t=e.length();if(t<10){let i=100*(1-t/10);e.multiplyScalar(i)}return e}tick(e,t){if(t)return;let i=e.timeSinceLoad>=this.disappearTime+15e3;this.setCollisionEnabled(i)}render(e){let t=P.clamp((e.timeSinceLoad-(this.disappearTime+15e3))/1e3,0,1);this.setOpacity(t)}}const Vs={ejectionPeriod:.2,ambientVelocity:new s(0,0,0),ejectionVelocity:2,velocityVariance:1,emitterLifetime:50,inheritedVelFactor:.2,particleOptions:{texture:"particles/smoke.png",blending:ae.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:1e3,lifetimeVariance:150,dragCoefficient:.8,acceleration:0,colors:[{r:.56,g:.36,b:.26,a:1},{r:.56,g:.36,b:.26,a:0}],sizes:[.5,1],times:[0,1]}},Os={ejectionPeriod:.5,ambientVelocity:new s(0,0,0),ejectionVelocity:1.3,velocityVariance:.5,emitterLifetime:50,inheritedVelFactor:.25,particleOptions:{texture:"particles/smoke.png",blending:ae.Normal,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:2500,lifetimeVariance:300,dragCoefficient:.7,acceleration:-8,colors:[{r:.56,g:.36,b:.26,a:1},{r:.2,g:.2,b:.2,a:.85},{r:0,g:0,b:0,a:0}],sizes:[1,1.5,2],times:[0,.5,1]}},Ns={ejectionPeriod:1.7,ambientVelocity:new s(0,-.5,0),ejectionVelocity:13/1.5,velocityVariance:5,emitterLifetime:5e3,inheritedVelFactor:.2,particleOptions:{texture:"particles/spark.png",blending:ae.Additive,spinSpeed:40,spinRandomMin:-90,spinRandomMax:90,lifetime:4500,lifetimeVariance:2500,dragCoefficient:.5,acceleration:0,colors:[{r:.6,g:.4,b:.3,a:1},{r:.6,g:.4,b:.3,a:1},{r:1,g:.4,b:.3,a:0}],sizes:[.5,.4,.2],times:[0,.5,1]}};class qs extends Cs{}class js extends Cs{constructor(e,t){super(e,t),this.delay=2e3,this.entryTime=null,this.exitTime=null,this.sounds=["teleport.wav"],this.teleportingSound=null,e.delay&&(this.delay=ci.parseNumber(e.delay))}onMarbleEnter(){let e=this.level.timeState;this.exitTime=null,this.level.marble.enableTeleportingLook(e),this.level.replay.recordMarbleEnter(this),null===this.entryTime&&(this.entryTime=e.currentAttemptTime,t.menu.hud.displayAlert("Teleporter has been activated, please wait."),this.teleportingSound=this.level.audio.createAudioSource("teleport.wav"),this.teleportingSound.play())}onMarbleLeave(){let e=this.level.timeState;this.exitTime=e.currentAttemptTime,this.level.marble.disableTeleportingLook(e),this.level.replay.recordMarbleLeave(this)}tick(e){if(null!==this.entryTime){if(!(e.currentAttemptTime-this.entryTime>=this.delay))return null!==this.exitTime&&e.currentAttemptTime-this.exitTime>50?(this.entryTime=null,void(this.exitTime=null)):void 0;this.executeTeleport()}}executeTeleport(){var e;this.entryTime=null;let t=this.level.triggers.find(e=>{var t;return e instanceof qs&&e.element._name.toLowerCase()===(null===(t=this.element.destination)||void 0===t?void 0:t.toLowerCase())});if(!t)return;let i,n=this.level.marble.body;if(i=ci.parseBoolean(this.element.centerdestpoint||t.element.centerdestpoint)?t.vertices[0].clone().lerp(t.vertices[7],.5):t.vertices[0].clone().add(new s(0,0,3)),n.position.copy(i),n.prevPosition.copy(i),ci.parseBoolean(this.element.keepvelocity||t.element.keepvelocity)||n.linearVelocity.setScalar(0),ci.parseBoolean(this.element.inversevelocity||t.element.inversevelocity)&&n.linearVelocity.negate(),ci.parseBoolean(this.element.keepangular||t.element.keepangular)||n.angularVelocity.setScalar(0),!ci.parseBoolean(this.element.keepcamera||t.element.keepcamera)){let e;e=-(e=this.element.camerayaw?P.degToRad(ci.parseNumber(this.element.camerayaw)):t.element.camerayaw?P.degToRad(ci.parseNumber(t.element.camerayaw)):0),this.level.yaw=e+Math.PI/2,this.level.pitch=sr}this.level.audio.play("spawn.wav"),null===(e=this.teleportingSound)||void 0===e||e.stop(),this.teleportingSound=null}reset(){super.reset(),this.entryTime=null,this.exitTime=null}}class Gs extends ei{constructor(){super(...arguments),this.dtsPath="shapes/buttons/checkpoint.dts",this.sounds=["checkpoint.wav"]}onMarbleContact(){this.level.saveCheckpointState(this),this.level.replay.recordMarbleContact(this)}}class Ws extends Cs{constructor(){super(...arguments),this.sounds=["checkpoint.wav"]}onMarbleEnter(){let e=this.level.shapes.find(e=>{var t,i;return(null===(t=e.srcElement)||void 0===t?void 0:t._name.toLowerCase())===(null===(i=this.element.respawnpoint)||void 0===i?void 0:i.toLowerCase())});e&&(this.level.saveCheckpointState(e,this),this.level.replay.recordMarbleEnter(this))}}class Hs extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/easteregg.dts",this.cooldownDuration=1/0,this.autoUse=!0,this.sounds=["easter.wav","easterfound.wav"],this.pickUpName=""}pickUp(){let e=K.data.collectedEggs.includes(this.level.mission.path);return e||(K.data.collectedEggs.push(this.level.mission.path),K.store(),t.menu.levelSelect.displayMission()),this.level.audio.play(this.sounds[Number(e)]),this.customPickUpAlert=e?"You already found this Easter Egg.":"You found an Easter Egg!",!0}use(){}}const Xs=[is,ys,ls,as,fs,vs];class Ys extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/random.dts",this.sounds=Xs.map(e=>new e(this.element).sounds).flat(),this.pickedUpCount=0,this.pickUpName=""}pickUp(){for(;;){let e,t=new(e="record"===this.level.replay.mode?Xs[Math.floor(6*Math.random())]:Xs[this.level.replay.randomPowerUpChoices.get(this.id)[this.pickedUpCount]])(this.element);if(t.level=this.level,t.id=this.id,t.pickUp()){if(this.pickUpName=t.pickUpName,this.customPickUpAlert=t.customPickUpAlert,this.an=t.an,this.autoUse=t.autoUse,this.cooldownDuration=t.cooldownDuration,this.lastInstance=t,this.pickedUpCount++,"record"===this.level.replay.mode){let t=this.level.replay.randomPowerUpChoices.get(this.id);t||(t=[],this.level.replay.randomPowerUpChoices.set(this.id,t)),t.push(Xs.indexOf(e))}return!0}}}use(e){this.lastInstance.use(e)}getAllDtsPaths(){return Xs.map(e=>new e(this.element).dtsPath)}reset(){super.reset(),this.pickedUpCount=0}}class Ks{constructor(e){this.preventClose=!1,this.initProperties(),e.setupButton(this.yesButton,this.yesSrc,()=>{t.level&&t.level.stopAndExit()}),e.setupButton(this.noButton,this.noSrc,()=>t.level.unpause()),e.setupButton(this.restartButton,this.restartSrc,()=>{t.level.unpause(),t.level.restart(!0)}),window.addEventListener("keydown",i=>{t.level&&!t.level.offline&&t.menu===e&&("Escape"===i.key?t.level.paused?this.preventClose||(this.noButton.src=e.uiAssetPath+this.noSrc+"_d.png"):t.level.pause():i.code===K.data.settings.gameButtonMapping.restart&&t.level.paused&&(this.restartButton.click(),t.level.pressingRestart=!0))}),window.addEventListener("keyup",i=>{t.level&&!t.level.offline&&t.menu===e&&t.level.paused&&"Escape"===i.key&&this.noButton.src.endsWith("_d.png")&&(this.noButton.src=e.uiAssetPath+this.noSrc+"_n.png",t.level.unpause())})}show(){this.div.classList.remove("hidden"),ye(!0)}hide(){this.div.classList.add("hidden"),ye(!1)}async onReplayButtonClick(e){let i=t.level;if(e){let e=await i.replay.serialize();dr.download(e,i.mission,!1,!0),P.isTouchDevice&&P.isInFullscreen()&&t.menu.showAlertPopup("Downloaded","The .wrec has been downloaded.")}else{if(!await t.menu.showConfirmPopup("Confirm","Do you want to watch this replay? Note that you can only watch it once. If you want to watch it more often, download it first. (alt-click (or long-press on touch devices))"))return;i.replay.mode="playback",this.restartButton.click()}}handleGamepadInput(e){e.buttons[0].value>.5&&!_e[0]&&(t.level.stopAndExit(),ft.play("buttonpress.wav")),e.buttons[1].value>.5&&!_e[1]&&(t.level.unpause(),ft.play("buttonpress.wav")),e.buttons[9].value>.5&&!_e[9]&&(t.level.unpause(),Ee("pause"),ft.play("buttonpress.wav")),e.buttons[8].value>.5&&!_e[8]&&(t.level.unpause(),t.level.restart(!0),t.level.pressingRestart=!0,ft.play("buttonpress.wav"))}}class Qs extends Ks{constructor(e){super(e),this.jukeboxButton=document.querySelector("#mbp-pause-jukebox"),e.setupButton(this.replayButton,"play/replay",e=>this.onReplayButtonClick(e.altKey)),P.onLongTouch(this.replayButton,()=>this.onReplayButtonClick(!0)),this.jukebox=new Zs(e),e.setupButton(this.jukeboxButton,"jukebox/jb_pausemenu",()=>{this.jukebox.show()},void 0,void 0,!1)}initProperties(){this.div=document.querySelector("#mbp-pause-screen"),this.yesButton=document.querySelector("#mbp-pause-yes"),this.noButton=document.querySelector("#mbp-pause-no"),this.restartButton=document.querySelector("#mbp-pause-restart"),this.replayButton=document.querySelector("#mbp-pause-replay"),this.yesSrc="exit/yes",this.noSrc="exit/no",this.restartSrc="exit/restart"}}const $s={"astrolabe.ogg":"Astrolabe","beach party.ogg":"Beach Party","challenge.ogg":"Challenge","classic vibe.ogg":"Classic Vibe","comforting mystery.ogg":"Comforting Mystery","endurance.ogg":"Endurance","flanked.ogg":"Flanked","groove police.ogg":"Groove Police","grudge.ogg":"Grudge","mbp old shell.ogg":"MBP Old Shell","metropolis.ogg":"Metropolis","pianoforte.ogg":"Pianoforte","quiet lab.ogg":"Quiet Lab","rising temper.ogg":"Rising Temper","seaside revisited.ogg":"Seaside Revisited","shell.ogg":"Shell","the race.ogg":"The Race","tim trance.ogg":"Tim Trance","xmas trance.ogg":"Xmas Trance"};class Zs{constructor(e){this.div=document.querySelector("#jukebox"),this.songsContainer=document.querySelector("#jukebox-songs"),this.textElement=document.querySelector("#jukebox-text"),this.closeButton=document.querySelector("#jukebox-close"),this.prevButton=document.querySelector("#jukebox-prev"),this.playButton=document.querySelector("#jukebox-play"),this.nextButton=document.querySelector("#jukebox-next"),this.selectedIndex=null,this._playing=!0,this.menu=e,e.setupButton(this.closeButton,"jukebox/close",()=>this.hide()),e.setupButton(this.prevButton,"play/prev",()=>this.select(Object.keys($s)[this.selectedIndex-1]),!0),e.setupVaryingButton(this.playButton,["jukebox/stop","jukebox/play"],()=>{var e,i;this.playing?(null===(e=t.level.music)||void 0===e||e.stop(),this.playing=!1):null!==this.selectedIndex?this.select(Object.keys($s)[this.selectedIndex]):(null===(i=t.level.music)||void 0===i||i.play(),this.playing=!0),this.updateText()}),e.setupButton(this.nextButton,"play/next",()=>this.select(Object.keys($s)[this.selectedIndex+1]),!0),window.addEventListener("keydown",t=>{this.div.classList.contains("hidden")||"Escape"!==t.key||(this.closeButton.src=e.uiAssetPath+"jukebox/close_d.png")}),window.addEventListener("keyup",t=>{this.div.classList.contains("hidden")||"Escape"!==t.key||(this.closeButton.src=e.uiAssetPath+"jukebox/close_n.png",this.hide())});for(let e in $s){let t=document.createElement("div");t.textContent=$s[e],this.songsContainer.appendChild(t),t.addEventListener("mousedown",()=>this.select(e))}}get playing(){return this._playing}set playing(e){this._playing=e,this.menu.setButtonVariant(this.playButton,1-Number(e))}select(e){if(!$s[e])return;let i=Object.keys($s).indexOf(e);this.selectedIndex=i;for(let e=0;e<this.songsContainer.children.length;e++)this.songsContainer.children[e].classList.remove("selected"),e===i&&this.songsContainer.children[e].classList.add("selected");let s=t.level;s.music&&s.music.stop(),s.music=s.audio.createAudioSource("music/"+e,s.audio.musicGain,void 0,!0),s.music.setLoop(!0),s.music.play(),this.playing=!0,this.updateNextPrevButtons(),this.updateText()}updateNextPrevButtons(){null===this.selectedIndex||this.selectedIndex===Object.keys($s).length-1?(this.nextButton.src=this.menu.uiAssetPath+"play/next_i.png",this.nextButton.style.pointerEvents="none"):(this.nextButton.src.endsWith("i.png")&&(this.nextButton.src=this.menu.uiAssetPath+"play/next_n.png"),this.nextButton.style.pointerEvents=""),null===this.selectedIndex||0===this.selectedIndex?(this.prevButton.src=this.menu.uiAssetPath+"play/prev_i.png",this.prevButton.style.pointerEvents="none"):(this.prevButton.src.endsWith("i.png")&&(this.prevButton.src=this.menu.uiAssetPath+"play/prev_n.png"),this.prevButton.style.pointerEvents="")}updateText(){null===this.selectedIndex?this.textElement.innerHTML="":this.textElement.innerHTML=`Title: ${$s[Object.keys($s)[this.selectedIndex]]}<br>${this.playing?"Playing":"Stopped"}`}show(){if(this.div.classList.remove("hidden"),t.menu.pauseScreen.preventClose=!0,null===this.selectedIndex){for(let e of this.songsContainer.children)e.classList.remove("selected");let e=Object.keys($s).indexOf(t.level.originalMusicName);e>=0&&(this.songsContainer.children[e].classList.add("selected"),this.selectedIndex=e),this.playing=!0,this.updateNextPrevButtons(),this.updateText()}let e=[...this.songsContainer.children].find(e=>e.classList.contains("selected"));e&&e.scrollIntoView({block:"nearest",inline:"nearest"})}hide(){this.div.classList.add("hidden"),t.menu.pauseScreen.preventClose=!1}reset(){this.selectedIndex=null}}const Js={up:"Move Forward",down:"Move Backward",left:"Move Left",right:"Move Right",use:"Use PowerUp",jump:"Jump",cameraUp:"Rotate Camera Up",cameraDown:"Rotate Camera Down",cameraLeft:"Rotate Camera Left",cameraRight:"Rotate Camera Right",freeLook:"Free Look",restart:"Restart",blast:"Use Blast"},en={up:"Move Forward",down:"Move Backward",left:"Move Left",right:"Move Right",use:"Use PowerUp",jump:"Jump",cameraUp:"Look Up",cameraDown:"Look Down",cameraLeft:"Look Left",cameraRight:"Look Right",freeLook:"Free Look",restart:"Respawn",blast:"Use Blast"};class tn{constructor(e){this.currentlyRebinding=null,this.rebindValue=null,this.rebindConfirmWarningEnding="Do you want to undo this<br>mapping?",this.menu=e,this.initProperties(),e.setupButton(this.homeButton,this.homeButtonSrc,()=>{this.hide(),e.home.show()},void 0,void 0,"gold"===t.modification),window.addEventListener("keydown",e=>{this.currentlyRebinding&&!this.rebindValue&&("Escape"===e.code?(this.currentlyRebinding=null,this.rebindDialog.classList.add("hidden")):this.setKeybinding(this.currentlyRebinding,e.code))}),window.addEventListener("mousedown",e=>{if(!this.currentlyRebinding||this.rebindValue)return;let t=["LMB","MMB","RMB"][e.button];t&&this.setKeybinding(this.currentlyRebinding,t)}),e.setupButton(this.rebindConfirmYes,this.rebindConfirmYesSrc,()=>{for(let e in K.data.settings.gameButtonMapping){let t=e;K.data.settings.gameButtonMapping[t]===this.rebindValue&&(K.data.settings.gameButtonMapping[t]="")}K.data.settings.gameButtonMapping[this.currentlyRebinding]=this.rebindValue,K.store(),this.currentlyRebinding=null,this.rebindValue=null,this.rebindConfirm.classList.add("hidden"),this.refreshKeybindings()}),e.setupButton(this.rebindConfirmNo,this.rebindConfirmNoSrc,()=>{this.currentlyRebinding=null,this.rebindValue=null,this.rebindConfirm.classList.add("hidden")})}async init(){}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}formatKeybinding(e){let t=P.getKeyForButtonCode(K.data.settings.gameButtonMapping[e]);return t.startsWith("the")?t.slice(t.indexOf(" ")+1,t.lastIndexOf(" ")):t}changeKeybinding(e){if(P.isTouchDevice)return;let i="gold"===t.modification?Js:en;this.rebindDialog.classList.remove("hidden"),this.rebindDialog.children[1].innerHTML=`Press a new key or button for<br>"${i[e]}"`,this.currentlyRebinding=e}setKeybinding(e,i){let s="gold"===t.modification?Js:en;for(let t in K.data.settings.gameButtonMapping){let n=t;if(K.data.settings.gameButtonMapping[n]===i&&n!==e)return this.rebindDialog.classList.add("hidden"),this.rebindConfirm.classList.remove("hidden"),this.rebindConfirm.children[1].innerHTML=`"${this.formatKeybinding(n)}" is already bound to "${s[n]}"!<br>`+this.rebindConfirmWarningEnding,void(this.rebindValue=i)}K.data.settings.gameButtonMapping[e]=i,K.store(),this.currentlyRebinding=null,this.rebindDialog.classList.add("hidden"),this.refreshKeybindings()}showMarbleTexturePicker(){return new Promise(e=>{let t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept","image/x-png,image/gif,image/jpeg"),t.onchange=(async()=>{let i=t.files[0];await K.databasePut("keyvalue",i,"marbleTexture"),e()}),t.click()})}}const sn=217,nn=344,an=[30,60,90,120,144,240,360,1/0];class rn extends tn{constructor(){super(...arguments),this.applyButton=document.querySelector("#mbp-options-apply"),this.generalButton=document.querySelector("#mbp-options-general"),this.hotkeysButton=document.querySelector("#mbp-options-hotkeys"),this.generalContainer=document.querySelector("#mbp-options-general-container"),this.hotkeysContainer=document.querySelector("#mbp-options-hotkeys-container"),this.updateFuncs=[],this.rebindConfirmWarningEnding="Do you want to undo this mapping?"}initProperties(){this.div=document.querySelector("#mbp-options"),this.homeButton=document.querySelector("#mbp-options-home"),this.rebindDialog=document.querySelector("#mbp-rebind-dialog"),this.rebindConfirm=document.querySelector("#mbp-rebind-confirm"),this.rebindConfirmYes=document.querySelector("#mbp-rebind-confirm-yes"),this.rebindConfirmNo=document.querySelector("#mbp-rebind-confirm-no"),this.homeButtonSrc="options/home",this.rebindConfirmYesSrc="exit/yes",this.rebindConfirmNoSrc="exit/no"}async init(){this.menu.setupButton(this.applyButton,"options/apply",()=>{},void 0,void 0,!1),this.menu.setupButton(this.generalButton,"options/general",()=>{this.generalContainer.classList.remove("hidden"),this.hotkeysContainer.classList.add("hidden"),this.generalButton.src=this.generalButton.src.slice(0,-5)+"d.png",this.generalButton.setAttribute("data-locked",""),this.hotkeysButton.src=this.hotkeysButton.src.slice(0,-5)+"n.png",this.hotkeysButton.removeAttribute("data-locked")},void 0,void 0,!1),this.menu.setupButton(this.hotkeysButton,"options/hotkeys",()=>{this.generalContainer.classList.add("hidden"),this.hotkeysContainer.classList.remove("hidden"),this.hotkeysButton.src=this.hotkeysButton.src.slice(0,-5)+"d.png",this.hotkeysButton.setAttribute("data-locked",""),this.generalButton.src=this.generalButton.src.slice(0,-5)+"n.png",this.generalButton.removeAttribute("data-locked")},void 0,void 0,!1),this.generalButton.click(),this.updateSliders();const e=()=>{var e;this.currentSliderElement&&(K.store(),this.currentSliderElement=null,null===(e=this.soundTestingSound)||void 0===e||e.stop(),this.soundTestingSound=null)};window.addEventListener("mouseup",e),window.addEventListener("touchend",e),this.addHeading(this.generalContainer,"General"),this.addDropdown(this.generalContainer,"alwaysFreeLook","Free-Look",["Disabled","Enabled"],!0),this.addDropdown(this.generalContainer,"invertMouse","Invert Mouse",["None","X Only","Y only","X and Y"]),this.addDropdown(this.generalContainer,"frameRateCap","Max Frame Rate",an.map(e=>isFinite(e)?e.toString():"Unlimited"),void 0,void 0,void 0,()=>{this.menu.showAlertPopup("About unlocking frame rate",'Browsers are v-synced by default, causing some input lag. Chrome can unlock its FPS by starting it with a special flag. Check <a href="https://www.reddit.com/r/KrunkerIO/comments/esz4gt/unlock_browser_fps_this_one_is_for_you/" target="_blank">this Reddit post</a> for more info. Once your FPS are unlocked, use this setting to ensure your CPU doesn\'t overheat.')}),this.addDropdown(this.generalContainer,"showFrameRate","Frame Rate",["Hidden","Visible"],!0),this.addDropdown(this.generalContainer,"showThousandths","Thousandths",["Disabled","Enabled"],!0),this.addMarbleTexturePicker(this.generalContainer),this.addDropdown(this.generalContainer,"marbleReflectivity","Reflective Marble",["Contextual","Disabled","Enabled"]),this.addDropdown(this.generalContainer,"fancyShaders","Fancy Shaders",["Disabled","Enabled"],!0),this.addDropdown(this.generalContainer,"pixelRatio","Pixel Ratio",["Max 0.5","Max 1.0","Max 1.5","Max 2.0","Max ‚àû"]),this.addDropdown(this.generalContainer,"canvasDesynchronized","Low-latency mode",["Disabled","Enabled"],!0,()=>{location.reload()},void 0,()=>{this.menu.showAlertPopup("About low-latency mode","In Chromium-based browsers, enabling low-latency mode can considerably reduce visual latency during gameplay. On some systems however, this can introduce flickering artifacts.")}),this.addDropdown(this.generalContainer,"inputType","Input Type",["Auto","Keyboard + Mouse","Touch"],void 0,()=>{let e=P.isTouchDevice;P.isTouchDevice=1!==K.data.settings.inputType&&(2===K.data.settings.inputType||P.checkIsTouchDevice()),e!==P.isTouchDevice&&location.reload()}),this.addSlider(this.generalContainer,"fov","Field of View",30,120,void 0,void 0,1,e=>e.toString()),this.addSlider(this.generalContainer,"musicVolume","Music Volume",0,1,()=>ft.updateVolumes(),void 0,void 0,e=>Math.ceil(100*e).toString()),this.addSlider(this.generalContainer,"mouseSensitivity","Mouse Speed",0,1),this.addSlider(this.generalContainer,"soundVolume","Sound Volume",0,1,()=>ft.updateVolumes(),()=>{this.soundTestingSound||(this.soundTestingSound=ft.createAudioSource("testing.wav"),this.soundTestingSound.setLoop(!0),this.soundTestingSound.play())},void 0,e=>Math.ceil(100*e).toString()),this.addSlider(this.generalContainer,"keyboardSensitivity","Keyboard Speed",0,1),this.addHeading(this.generalContainer,"Touch Controls"),this.addDropdown(this.generalContainer,"joystickPosition","Joystick Position",["Fixed","Dynamic"],void 0,void 0,!0),this.addSlider(this.generalContainer,"joystickSize","Joystick Size",100,500,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"joystickLeftOffset","Joystick Left Offset",0,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"joystickVerticalPosition","Joystick Vertical Pos",0,1,void 0,void 0,void 0,e=>Math.floor(100*e)+"%",!0),this.addDropdown(this.generalContainer,"actionButtonOrder","Button Order (‚§æ)",P.getPermutations(["Blast","Jump","Use"]).map(e=>e.join(" - ")),void 0,void 0,!0),this.addSlider(this.generalContainer,"actionButtonSize","Button Size",50,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"actionButtonRightOffset","Button Right Offset",0,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"actionButtonBottomOffset","Button Bottom Offset",0,300,void 0,void 0,1,e=>(0|e).toString(),!0),this.addSlider(this.generalContainer,"actionButtonAsJoystickMultiplier","Button Sensitivity Fac",0,3,void 0,void 0,.1,e=>(Math.floor(10*e)/10).toString(),!0),this.addHotkey(this.hotkeysContainer,"up"),this.addHotkey(this.hotkeysContainer,"left"),this.addHotkey(this.hotkeysContainer,"down"),this.addHotkey(this.hotkeysContainer,"right"),this.addHotkey(this.hotkeysContainer,"cameraUp"),this.addHotkey(this.hotkeysContainer,"cameraLeft"),this.addHotkey(this.hotkeysContainer,"cameraDown"),this.addHotkey(this.hotkeysContainer,"cameraRight"),this.addHotkey(this.hotkeysContainer,"jump"),this.addHotkey(this.hotkeysContainer,"use"),this.addHotkey(this.hotkeysContainer,"freeLook"),this.addHotkey(this.hotkeysContainer,"restart"),this.addHotkey(this.hotkeysContainer,"blast"),await ne.loadImages(["small","medium","large","xlarge"].map(e=>"./assets/ui_mbp/options/dropdown-"+e+".png"))}updateSliders(){if(requestAnimationFrame(()=>this.updateSliders()),!this.currentSliderElement)return;let e=this.currentSliderElement.getBoundingClientRect(),t=ve.x-e.left*de-sn,i=P.clamp(t/(nn-sn),0,1);this.currentSliderCallback(i)}addHeading(e,t){let i=document.createElement("div");i.classList.add("mbp-options-element","_heading"),i.textContent=t,e.appendChild(i)}addDropdown(e,t,i,s,n=!1,a,r=!1,o){const l=()=>{m.classList.add("hidden"),p.classList.add("hidden"),g.classList.add("hidden"),c.style.zIndex="",u.style.zIndex=""};let h=document.createElement("div");h.classList.add("mbp-options-element","_dropdown"),r&&h.classList.add("_small-text");let d=document.createElement("p");d.textContent=i+":";let c=document.createElement("img");this.menu.setupButton(c,"options/dropdown",()=>{m.classList.contains("hidden")?(m.classList.remove("hidden"),p.classList.remove("hidden"),g.classList.remove("hidden"),c.style.zIndex="2",u.style.zIndex="2"):l()});let u=document.createElement("p"),m=document.createElement("div");m.classList.add("hidden"),m.addEventListener("click",()=>l());let p=document.createElement("img");p.classList.add("hidden"),p.src="./assets/ui_mbp/options/dropdown-"+["small","medium","large","xlarge"][Math.min(3,s.length-2)]+".png";let g=document.createElement("div");g.classList.add("hidden");for(let e of s){let i=document.createElement("div");i.textContent=e,g.appendChild(i),i.addEventListener("mousedown",async()=>{l(),u.textContent=e;let i=K.data.settings[t],r=n?Boolean(s.indexOf(e)):s.indexOf(e);i!==r&&(K.data.settings[t]=r,await K.store(),null===a||void 0===a||a())})}if(h.append(d,c,u,m,p,g),o){let e=document.createElement("img");e.src="./assets/svg/info_black_24dp.svg",e.classList.add("_info"),h.append(e),e.addEventListener("click",o)}e.appendChild(h),this.updateFuncs.push(()=>u.textContent=s[Number(K.data.settings[t])])}addSlider(e,t,i,s,n,a,r,o=0,l,h=!1){const d=()=>{let e=(K.data.settings[t]-s)/(n-s);g.style.left=Math.floor(P.lerp(sn,nn,e))+"px",l&&(f.textContent=l(K.data.settings[t]))};let c=document.createElement("div");c.classList.add("mbp-options-element","_slider"),h&&c.classList.add("_small-text");let u=document.createElement("p");u.textContent=i+":";let m=document.createElement("img");m.src="./assets/ui_mbp/options/bar.png";const p=()=>{this.currentSliderElement=c,this.currentSliderCallback=(e=>{K.data.settings[t]=P.roundToMultiple(P.lerp(s,n,e),o),d(),null===a||void 0===a||a()}),null===r||void 0===r||r()};m.addEventListener("mousedown",p),m.addEventListener("touchstart",p);let g=document.createElement("img");g.src="./assets/ui_mbp/options/slider.png";let f=document.createElement("p");c.append(u,m,g),l&&c.append(f),e.appendChild(c),this.updateFuncs.push(d)}addHotkey(e,i){let s=document.createElement("div");s.classList.add("mbp-options-element","_hotkey");let n=document.createElement("p"),a="gold"===t.modification?Js:en;n.textContent=a[i]+":";let r=document.createElement("img");this.menu.setupButton(r,"options/bind",()=>{this.changeKeybinding(i)});let o=document.createElement("p");s.append(n,r,o),e.appendChild(s),this.updateFuncs.push(()=>o.textContent=this.formatKeybinding(i))}addButton(e,t,i,s){let n=document.createElement("div");n.classList.add("mbp-options-element","_button");let a=document.createElement("p");a.textContent=t+":";let r=document.createElement("img");this.menu.setupButton(r,"options/bind",()=>s());let o=document.createElement("p");return o.textContent=i,n.append(a,r,o),e.appendChild(n),n}addMarbleTexturePicker(e){let t=this.addButton(e,"Marble Texture","Select File",async()=>{await this.showMarbleTexturePicker(),i.classList.remove("hidden")}),i=document.createElement("img");i.src="./assets/ui_mbp/mp/team/nomarble.png",i.id="mbp-reset-marble-texture-button",i.title="Clear texture",i.classList.add("hidden"),i.addEventListener("click",()=>{K.databaseDelete("keyvalue","marbleTexture"),i.classList.add("hidden")}),t.appendChild(i),this.updateFuncs.push(async()=>{0===await K.databaseCount("keyvalue","marbleTexture")?i.classList.add("hidden"):i.classList.remove("hidden")})}refreshKeybindings(){this.updateAllElements()}updateAllElements(){for(let e of this.updateFuncs)e()}show(){super.show(),this.updateAllElements()}}const on={0:"0.png",1:"1.png",2:"2.png",3:"3.png",4:"4.png",5:"5.png",6:"6.png",7:"7.png",8:"8.png",9:"9.png",":":"colon.png",".":"point.png","/":"slash.png","-":"dash.png"},ln=/<func:bind (\w+)>/g;class hn{constructor(e){this.frameTimeStore=[],this.centerText="none",this.helpText="",this.helpTextTimeState=null,this.alertText="",this.alertTextTimeState=null,this.menu=e,this.hudCanvas=document.querySelector("#hud-canvas"),this.hudCtx=this.hudCanvas.getContext("2d",{desynchronized:!1}),this.fpsMeter=document.querySelector("#fps-meter"),this.fpsMeterValue=document.querySelector("#fps-meter-value")}async load(){let e=[];e.push(...Object.values(on).map(e=>{let t=[e];return!this.supportNumberColors||e.includes("slash")||e.includes("dash")||(t.push(e.slice(0,e.lastIndexOf("."))+"_red.png"),t.push(e.slice(0,e.lastIndexOf("."))+"_green.png")),t.map(e=>this.menu.uiAssetPath+"game/numbers/"+e)}).flat()),e.push(...["ready.png","set.png","go.png","outofbounds.png","powerup.png"].map(e=>this.menu.uiAssetPath+"game/"+e)),K.data.settings.showFrameRate&&this.supportFpsMeter?this.fpsMeter.classList.remove("hidden"):this.fpsMeter.classList.add("hidden"),t.level.mission.hasBlast&&e.push(...["blastbar.png","blastbar_charged.png","blastbar_bargreen.png","blastbar_bargray.png"].map(e=>"./assets/ui_mbp/game/"+e)),e.push(...["./assets/ui_mbp/game/transparency.png"]),await ne.loadImages(e),P.isTouchDevice&&this.setupTouchControls(),this.helpTextTimeState=null,this.alertTextTimeState=null}setupTouchControls(){je.style.top=t.level.totalGems?"60px":"",Ge.style.top=t.level.totalGems?"60px":"",We.style.top=t.level.totalGems?"60px":"",qe.style.visibility=t.level.mission.hasBlast?"":"hidden",qe.style.pointerEvents=t.level.mission.hasBlast?"":"none",We.style.visibility=K.data.settings.alwaysFreeLook?"hidden":"",We.style.pointerEvents=K.data.settings.alwaysFreeLook?"none":"",this.fpsMeter.style.transform="scale(0.5)",this.fpsMeter.querySelector("img").style.borderRight="50px solid #ffffff4d",this.fpsMeterValue.style.marginRight="50px";let e=K.data.settings.joystickSize,i=He*e;ze.style.width=e+"px",ze.style.height=e+"px",ze.style.borderRadius=i/2+"px",De.style.width=i+"px",De.style.height=i+"px";let s=K.data.settings.actionButtonSize/120;Ve.style.right=K.data.settings.actionButtonRightOffset/s+"px",Ve.style.bottom=K.data.settings.actionButtonBottomOffset/s+"px",Ve.style.transform=`scale(${s})`;let n=[{right:0,bottom:135},{right:0,bottom:0},{right:135,bottom:0}],a=P.getPermutations([qe,Oe,Ne])[K.data.settings.actionButtonOrder];for(let e of a)e.style.right=n[a.indexOf(e)].right+"px",e.style.bottom=n[a.indexOf(e)].bottom+"px"}setSize(e,t,i){let s=Math.ceil(e*i),n=Math.ceil(t*i);this.hudCanvas.setAttribute("width",s.toString()),this.hudCanvas.setAttribute("height",n.toString());let a=ce(e,t);this.width=Math.ceil(e*a),this.height=Math.ceil(t*a)}renderHud(e){var i,s,n,a;const r=this.hudCtx,o=t.level,{width:l,height:h}=this;let d=this.hudCanvas.width/this.width;if(r.resetTransform(),r.scale(d,d),r.clearRect(0,0,l,h),this.showClockBackground){let e=ne.getImageFromCache("./assets/ui_mbp/game/transparency.png");r.drawImage(e,Math.floor(l/2-110+3),-10,220,79)}let c=e.gameplayClock;if(o.finishTime&&(c=o.finishTime.gameplayClock),0!==o.currentTimeTravelBonus||o.finishTime||(c=Math.max(c-1e3/Za,0)),o.maxDisplayedTime=Math.max(c,o.maxDisplayedTime),0!==o.currentTimeTravelBonus||o.finishTime||(c=o.maxDisplayedTime),c=Math.min(c,ar),this.drawNumbers(P.secondsToTimeString(c/1e3),l/2,0,!0,this.determineClockColor(c)),o.totalGems>0){let e=P.leftPadZeroes(o.gemCount.toString(),this.gemCountMinDigits)+"/"+P.leftPadZeroes(o.totalGems.toString(),this.gemCountMinDigits);this.drawNumbers(e,30,0,!1)}let u=ne.getImageFromCache(this.menu.uiAssetPath+"game/powerup.png");if(r.drawImage(u,l-u.width-5,5),"none"!==this.centerText){let e=ne.getImageFromCache(this.menu.uiAssetPath+"game/"+this.centerText+".png");r.drawImage(e,Math.floor((l-e.width)/2),Math.floor(.3*h))}let m=null!==(s=null===(i=this.helpTextTimeState)||void 0===i?void 0:i.timeSinceLoad)&&void 0!==s?s:-1/0,p=null!==(a=null===(n=this.alertTextTimeState)||void 0===n?void 0:n.timeSinceLoad)&&void 0!==a?a:-1/0,g=P.clamp((e.timeSinceLoad-m-3e3)/1e3,0,1)**2,f=P.clamp((e.timeSinceLoad-p-3e3)/1e3,0,1)**2;if(g<1){let e={r:255,g:255,b:255,a:255},i={r:0,g:0,b:0,a:255},s=P.lerpColors(e,i,P.lerp(0,.5,g));r.font="24px DomCasualRegular",r.fillStyle=`rgb(${s.r}, ${s.g}, ${s.b})`,r.textAlign="center",r.textBaseline="top",r.shadowColor="gold"===t.modification?"black":"#777777",r.shadowOffsetX=1,r.shadowOffsetY=1,r.globalAlpha=1-g;let n=this.breakTextIntoLines(this.helpText,l);for(let e=0;e<n.length;e++)r.fillText(n[e],Math.floor(l/2),Math.floor(.45*h)+24*1.2*e);r.shadowColor="transparent",r.shadowOffsetX=0,r.shadowOffsetY=0,r.globalAlpha=1}if(f<1){let e="gold"===t.modification?{r:255,g:226,b:64,a:255}:{r:228,g:211,b:64,a:129},i={r:0,g:0,b:0,a:255},s=P.lerpColors(e,i,P.lerp(0,.5,f));r.font="24px DomCasualRegular",r.fillStyle=`rgb(${s.r}, ${s.g}, ${s.b})`,r.textAlign="center",r.textBaseline="bottom",r.shadowColor="gold"===t.modification?"black":"rgb(119, 102, 34)",r.shadowOffsetX=1,r.shadowOffsetY=1,r.globalAlpha=1-f;let n=this.breakTextIntoLines(this.alertText,l);for(let e=0;e<n.length;e++)r.fillText(n[e],Math.floor(l/2),h-30-24*1.2*(n.length-e-1));r.shadowColor="transparent",r.shadowOffsetX=0,r.shadowOffsetY=0,r.globalAlpha=1}if(0!==he.debugMode){r.font="24px DomCasualRegular",r.fillStyle="white",r.textAlign="center",r.textBaseline="bottom",r.shadowColor="black",r.shadowOffsetX=1,r.shadowOffsetY=1,r.globalAlpha=1;let e="Debug Rendering: ";switch(he.debugMode){case 1:e+="UV";break;case 2:e+="Normal (World)";break;case 3:e+="Normal (Map)";break;case 4:e+="Normal (Multiplied)";break;case 5:e+="Tangent";break;case 6:e+="Tangent A";break;case 7:e+="TBN[T]";break;case 8:e+="TBN[B]";break;case 9:e+="TBN[N]";break;default:e=""}r.fillText(e,Math.floor(l/2),100),r.shadowColor="transparent",r.shadowOffsetX=0,r.shadowOffsetY=0,r.globalAlpha=1}if(o.mission.hasBlast){let e=o.blastAmount,t=new B(7,34);P.isTouchDevice&&t.set(20,47);let i=`./assets/ui_mbp/game/blastbar_bar${e>=.2?"green":"gray"}.png`,s=ne.getImageFromCache(i);r.drawImage(s,t.x+5,h-t.y+5,109*P.clamp(e,0,1),17);let n=ne.getImageFromCache(e>1?"./assets/ui_mbp/game/blastbar_charged.png":"./assets/ui_mbp/game/blastbar.png");r.drawImage(n,t.x,h-t.y)}}determineClockColor(e){if("gold"===t.modification)return;const i=t.level;if(i.finishTime)return"green";if(i.timeState.currentAttemptTime<ir||i.currentTimeTravelBonus>0)return"green";if(e>=i.mission.qualifyTime)return"red";if(i.timeState.currentAttemptTime>=ir&&isFinite(i.mission.qualifyTime)&&"platinum"===t.modification){let t=e-i.mission.computeAlarmStartTime();if(t<0)return;if(Math.floor(t/1e3)%2==0)return"red"}}drawNumbers(e,t,i,s,n){let a=0;if(s){let i=24*(e.length-1)-28+43;t=Math.floor(t-i/2)}for(let i=0;i<e.length;i++){let s=e[i],r=this.menu.uiAssetPath+"game/numbers/"+on[s];this.supportNumberColors&&n&&(r=r.slice(0,r.lastIndexOf("."))+"_"+n+".png");let o=ne.getImageFromCache(r);":"!==s&&"."!==s||(a-=3),this.hudCtx.drawImage(o,t+a,0),a+=24,":"!==s&&"."!==s||(a-=7)}}breakTextIntoLines(e,t){let i=e.split("\n");for(let e=0;e<i.length;e++){let s=i[e];if(this.hudCtx.measureText(s).width>t){let n=s.split(" "),a=0,r=n.length-1,o=0;for(;a<=r;){let e=Math.floor(a+(r-a+1)/2),i=n.slice(0,e+1).join(" ");this.hudCtx.measureText(i).width<=t?(a=e+1,o=e):r=e-1}let l=n.slice(0,o+1).join(" "),h=n.slice(o+1).join(" ");i[e]=l,i.splice(e+1,0,h)}}return i}setPowerupButtonState(e,t=!1){P.isTouchDevice&&(et(e),(e||t)&&(Ne.style.opacity="0.5"),!e&&t&&(Ne.style.opacity="0.2"))}displayHelp(e,i=!1){let s;for(ln.lastIndex=0;null!==(s=ln.exec(e));){let t={moveforward:"up",movebackward:"down",moveleft:"left",moveright:"right",jump:"jump",mousefire:"use",panup:"cameraUp",pandown:"cameraDown",panleft:"cameraLeft",panright:"cameraRight",turnup:"cameraUp",turndown:"cameraDown",turnleft:"cameraLeft",turnright:"cameraRight",freelook:"freeLook",useblast:"blast"}[s[1].toLowerCase()];if(!t)continue;let i=P.getKeyForButtonCode(K.data.settings.gameButtonMapping[t]);e=e.slice(0,s.index)+i+e.slice(s.index+s[0].length),ln.lastIndex-=s[0].length}"MSG_FINDALLTHEGEMS"===e&&(e="Find all the gems!"),"MSG_RACETOTHEFINISH"===e&&(e="Race to the finish!"),this.helpText=e,this.helpTextTimeState=P.jsonClone(t.level.timeState),i&&t.level.audio.play("infotutorial.wav")}displayAlert(e){this.alertText=e,this.alertTextTimeState=P.jsonClone(t.level.timeState)}setCenterText(e){this.centerText=e}displayFps(){var e;if(!K.data.settings.showFrameRate||!this.supportFpsMeter)return;let i=performance.now();for(this.frameTimeStore.push(i);this.frameTimeStore.length&&this.frameTimeStore[0]+1e3<=i;)this.frameTimeStore.shift();let s=this.frameTimeStore.length;s/=Math.min(1,null!==(e=t.level.timeState.timeSinceLoad/1e3)&&void 0!==e?e:1),s=Math.floor(s);let n=an[K.data.settings.frameRateCap];59!==s&&119!==s&&143!==s&&239!==s&&s!==n-1||s++,61!==s&&121!==s&&145!==s&&241!==s&&s!==n+1||s--,this.fpsMeterValue.textContent="FPS: "+s}}class dn extends hn{constructor(){super(...arguments),this.gemCountMinDigits=3,this.showClockBackground=!0,this.supportNumberColors=!0,this.supportFpsMeter=!0}}class cn extends ei{constructor(e){super(),this.collideable=!1,this.dtsPath=`shapes/skies/${e}/${e}.dts`}}class un extends ei{constructor(e){super();let t=/glass_(\d+)shape/.exec(e)[1];this.dtsPath=`shapes/glass/${t}x3.dts`,this.colliderDtsPath=`shapes/glass/col/${t}x3.dts`}}class mn extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/blast.dts",this.autoUse=!0,this.sounds=["publastvoice.wav"],this.pickUpName="Blast PowerUp"}pickUp(){return this.level.audio.play(this.sounds[0]),!0}use(){this.level.blastAmount=1.03}}class pn extends ts{constructor(){super(...arguments),this.dtsPath="shapes/items/megamarble.dts",this.sounds=["pumegamarblevoice.wav","dosuperjump.wav","mega_bouncehard1.wav","mega_bouncehard2.wav","mega_bouncehard3.wav","mega_bouncehard4.wav","mega_roll.wav"],this.pickUpName="Mega Marble PowerUp"}pickUp(){return this.level.pickUpPowerUp(this)}use(){this.level.marble.enableMegaMarble(this.level.timeState),this.level.deselectPowerUp(),this.level.audio.play(this.sounds[1])}}var gn="precision highp float;\nprecision highp int;\n\n#include <definitions>\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 tangent;\nattribute vec2 uv;\nattribute float meshInfoIndex;\n\nuniform highp sampler2D meshInfos; // This is where mesh transformation and other things about the mesh are stored in\nuniform int meshInfoTextureWidth;\nuniform int meshInfoTextureHeight;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 inverseProjectionMatrix;\nuniform bool skipTransparent;\nuniform mat4 directionalLightTransform;\nuniform vec3 eyePosition;\nuniform float materialOpacity;\n\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying float vOpacity;\nvarying vec4 vShadowPosition;\nvarying vec3 vReflect;\nvarying mat3 vTbn;\nvarying vec4 vTangent;\nvarying float vFragDepth;\nvarying float vIsPerspective;\nvarying vec3 eyeDirection;\n\n#ifdef IS_WEBGL1\n\tmat3 transpose(mat3 inMatrix) {\n\t\tvec3 i0 = inMatrix[0];\n\t\tvec3 i1 = inMatrix[1];\n\t\tvec3 i2 = inMatrix[2];\n\n\t\tmat3 outMatrix = mat3(\n\t\t\tvec3(i0.x, i1.x, i2.x),\n\t\t\tvec3(i0.y, i1.y, i2.y),\n\t\t\tvec3(i0.z, i1.z, i2.z)\n\t\t);\n\n\t\treturn outMatrix;\n\t}\n\n\t// http://www.thetenthplanet.de/archives/1180\n\tmat3 inverse(mat3 M) {\n\t\tmat3 M_t = transpose(M);\n\t\tfloat det = dot(cross(M_t[0], M_t[1]), M_t[2]);\n\t\tmat3 adjugate = mat3(cross(M_t[1], M_t[2]), cross(M_t[2], M_t[0]), cross(M_t[0], M_t[1]));\n\t\treturn adjugate / det;\n\t}\n#endif\n\n// _ here because on some systems, \"mod\" is already defined?\nint _mod(int a, int n) {\n\t#ifdef IS_WEBGL1\n\t\treturn a - n * (a / n);\n\t#else\n\t\treturn a % n;\n\t#endif\n}\n\n// Gets the mesh info for the mesh at a specific index. The mesh info contains its transformation and other things.\nmat4 getMeshInfo(int index) {\n\t// Figure out where we need to sample the texture\n\tivec2 coords = ivec2(\n\t\t_mod(4 * index, meshInfoTextureWidth),\n\t\t(4 * index) / meshInfoTextureWidth\n\t);\n\n\t#ifdef IS_WEBGL1\n\t\t// Primitive way, sample with texture coordinates\n\t\treturn mat4(\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(0, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(1, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(2, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight)),\n\t\t\ttexture2D(meshInfos, vec2(coords + ivec2(3, 0)) / vec2(meshInfoTextureWidth, meshInfoTextureHeight))\n\t\t);\n\t#else\n\t\t// Better way, sample with pixel coordinates\n\t\treturn mat4(\n\t\t\ttexelFetch(meshInfos, coords + ivec2(0, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(1, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(2, 0), 0),\n\t\t\ttexelFetch(meshInfos, coords + ivec2(3, 0), 0)\n\t\t);\n\t#endif\n}\n\nbool isPerspectiveMatrix(mat4 m) {\n\treturn m[2][3] == -1.0; // Taken from three.js, no clue how this works\n}\n\nvoid main() {\n\t#ifdef IS_SKY\n\t\t// https://gamedev.stackexchange.com/a/60377\n\t\tmat4 inverseProjection = inverseProjectionMatrix;\n\t\tmat3 inverseModelView = transpose(mat3(viewMatrix));\n\t\tvec3 unprojected = (inverseProjection * vec4(position, 1.0)).xyz;\n\t\teyeDirection = inverseModelView * unprojected;\n\t\t\n\t\tgl_Position = vec4(position, 1.0);\n\t#else\n\t\tmat4 meshInfo = getMeshInfo(int(meshInfoIndex + 0.1)); // + 0.1 to make sure it casts correctly, lol\n\t\tmat4 transform = meshInfo;\n\t\ttransform[0][3] = 0.0; // The last row of a transformation matrix is always the same, so set it to what it should be\n\t\ttransform[1][3] = 0.0;\n\t\ttransform[2][3] = 0.0;\n\t\ttransform[3][3] = 1.0;\n\t\tfloat opacity = meshInfo[0][3];\n\t\tint meshFlags = int(meshInfo[1][3]);\n\n\t\topacity *= materialOpacity;\n\t\tvOpacity = opacity;\n\n\t\tif (skipTransparent && opacity < 1.0) {\n\t\t\t// The object isn't fully opaque, so skip it\n\t\t\tgl_Position = vec4(0.0);\n\t\t\treturn;\n\t\t}\n\n\t\tvec4 worldPosition = transform * vec4(position, 1.0);\n\t\tvPosition = worldPosition;\n\n\t\tmat4 mvp = projectionMatrix * viewMatrix * transform; // Combine them into a single matrix to reduce possible precision errors\n\t\tgl_Position = mvp * vec4(position, 1.0);\n\n\t\tvUv = uv;\n\t\t#ifdef FLIP_Y\n\t\t\tvUv.y = 1.0 - vUv.y;\n\t\t#endif\n\n\t\t// Compute the transformation matrix for normals (not tangents, tho!)\n\t\t// Note that when the transformation doesn't involve any scaling, the upper mat3 part is orthonormal meaning its inverse is equal to its transpose. In this case, normalTransform == mat3(transform).\n\t\tmat3 normalTransform = transpose(inverse(mat3(transform)));\n\n\t\tvec3 transformedNormal = normalTransform * normal;\n\t\t#ifdef NORMALIZE_NORMALS\n\t\t\t// Many normals, like those used in the tornado, are actually not normalized\n\t\t\ttransformedNormal = normalize(transformedNormal);\n\t\t#endif\n\t\tvNormal = transformedNormal;\n\n\t\tvTangent = tangent; // Needed so that it doesn't get optimized out (fucks with vertex attributes somehow)\n\t\t#ifdef USE_NORMAL_MAP\n\t\t\tvec3 N = transformedNormal;\n\t\t\tvec3 T = normalize((transform * vec4(tangent.xyz, 0.0)).xyz);\n\t\t\t// re-orthogonalize T with respect to N\n\t\t\tT = normalize(T - dot(T, N) * N);\n\t\t\t// then retrieve perpendicular vector B with the cross product of T and N\n\t\t\tvec3 B = cross(N, T) * tangent.w;\n\t\t\tmat3 tbn = mat3(T, B, N);\n\t\t\tvTbn = tbn;\n\t\t#endif\n\n\t\t#if defined(RECEIVE_SHADOWS) || defined(IS_SHADOW)\n\t\t\t// Compute where we are within shadow camera view space\n\t\t\tvShadowPosition = directionalLightTransform * worldPosition;\n\t\t#endif\n\n\t\t#if defined(USE_ENV_MAP) && !defined(USE_ACCURATE_REFLECTION_RAY)\n\t\t\t// Compute the reflection ray\n\t\t\tvec3 incidentRay = normalize(worldPosition.xyz - eyePosition);\n\t\t\tvec3 reflected = reflect(incidentRay, normalize(transformedNormal));\n\t\t\tvReflect = reflected;\n\t\t#endif\n\n\t\t#ifdef LOG_DEPTH_BUF\n\t\t\t// Some values we need to pass along for logarithmic depth buffer stuffs\n\t\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\t\tvIsPerspective = float(isPerspectiveMatrix(projectionMatrix));\n\t\t#endif\n\t#endif\n}",fn="precision mediump float;\n\n#define SHADOW_RADIUS 2\n#include <definitions>\n\n// This condition here is necessary to save on varying vectors; some mobile devices (*cough* iPhones *cough*) only support 8 varying vec4s, and this separation here makes sure we stay just under that. If, in the future, more varyings will be necessary, this condition can always be refined more. Also, apparently I'm not allowed to indent 'varying'.\n#ifdef IS_SKY\nvarying vec3 eyeDirection;\n#else\nvarying vec4 vPosition;\nvarying vec2 vUv;\nvarying vec3 vNormal;\n//varying vec4 vTangent; // Using this drops support with WebGL 1 on iOS, too many varyings\nvarying float vOpacity;\nvarying vec4 vShadowPosition;\nvarying vec3 vReflect;\nvarying mat3 vTbn; // Matrix used to transform the normal map vectors\nvarying float vFragDepth;\nvarying float vIsPerspective;\n#endif\n\nuniform sampler2D diffuseMap;\nuniform samplerCube envMap;\nuniform sampler2D normalMap;\nuniform sampler2D specularMap;\nuniform sampler2D noiseMap;\n\nuniform float reflectivity;\nuniform highp vec3 eyePosition;\nuniform float specularIntensity;\nuniform float shininess;\nuniform float logDepthBufFC;\nuniform float secondaryMapUvFactor;\nuniform int debugMode;\n\nuniform vec3 ambientLight;\nuniform vec3 directionalLightColor;\nuniform vec3 directionalLightDirection;\nuniform mediump sampler2D directionalLightShadowMap;\n\n#if defined(LOG_DEPTH_BUF) && defined(IS_WEBGL1)\n\t#extension GL_EXT_frag_depth : enable // For some reason, the extension needs to be enabled in-shader\n#endif\n\n// Computes standard Lambertian reflectance\nfloat lambert(vec3 normal, vec3 lightPosition) {\n\tfloat result = dot(normal, lightPosition);\n\treturn max(result, 0.0);\n}\n\n#ifdef IS_WEBGL1\n\tmat3 transpose(mat3 inMatrix) {\n\t\tvec3 i0 = inMatrix[0];\n\t\tvec3 i1 = inMatrix[1];\n\t\tvec3 i2 = inMatrix[2];\n\n\t\tmat3 outMatrix = mat3(\n\t\t\tvec3(i0.x, i1.x, i2.x),\n\t\t\tvec3(i0.y, i1.y, i2.y),\n\t\t\tvec3(i0.z, i1.z, i2.z)\n\t\t);\n\n\t\treturn outMatrix;\n\t}\n#endif\n\nvec4 sampleCubeTexture(samplerCube tex, vec3 uvw) {\n\t#ifdef ENV_MAP_Z_UP\n\t\tuvw.yz = vec2(uvw.z, -uvw.y); // Rotate the \"cube\" about the x-axis because by default, cubemaps are Y-up but we're in Z-up space\n\t#endif\n\n\treturn textureCube(tex, uvw);\n}\n\n// Gets the intensity of a shadow given a point in shadow camera view space\nfloat getShadowIntensity(sampler2D map, vec4 shadowPosition, int mapSize) {\n\tvec3 projectedTexcoord = shadowPosition.xyz / shadowPosition.w;\n\tprojectedTexcoord = (projectedTexcoord + vec3(1.0)) / 2.0; // From [-1, 1] to [0, 1]\n\n\t// Check if we're even within the bounds of the shadow texture\n\tbool inBounds =\n\t\tmin(projectedTexcoord.x, min(projectedTexcoord.y, projectedTexcoord.z)) > 0.0 &&\n\t\tmax(projectedTexcoord.x, max(projectedTexcoord.y, projectedTexcoord.z)) < 1.0;\n\t\n\tif (!inBounds) return 0.0; // If not, say there's no shadow\n\n\tfloat mapSizeF = float(mapSize);\n\tfloat total = 0.0;\n\n\t// Sample the texture in an area to soften it a bit\n\tfor (int x = -SHADOW_RADIUS; x <= SHADOW_RADIUS; x++) {\n\t\tfor (int y = -SHADOW_RADIUS; y <= SHADOW_RADIUS; y++) {\n\t\t\tvec2 uv = projectedTexcoord.xy + vec2(float(x) / mapSizeF, float(y) / mapSizeF);\n\t\t\tfloat depthValue = texture2D(map, uv.xy).r;\n\t\t\tif (depthValue < projectedTexcoord.z) total += 1.0;\n\t\t}\n\t}\n\n\treturn mix(total / float((SHADOW_RADIUS*2+1)*(SHADOW_RADIUS*2+1)), 0.0, projectedTexcoord.z * projectedTexcoord.z);\n}\n\n// Fresnel-Schlick approximation\nfloat fresnel(vec3 direction, vec3 normal, bool invert) {\n\tvec3 nDirection = normalize(direction);\n\tvec3 nNormal = normalize(normal);\n\tvec3 halfDirection = normalize(nNormal + nDirection);\n\n\tfloat exponent = 5.0;\n\tfloat cosine = dot(halfDirection, nDirection);\n\tfloat product = max(cosine, 0.0);\n\tfloat factor = invert ? 1.0 - pow(product, exponent) : pow(product, exponent);\n\t\n\treturn factor;\n}\n\nvoid main() {\n\t#if defined(LOG_DEPTH_BUF) && !defined(IS_SKY)\n\t\t// We always need to set gl_FragDepthEXT when it's present in the file, otherwise it gets real weird\n\t\t// Also: Doing a strict comparison with == 1.0 can cause noise artifacts\n\t\tgl_FragDepthEXT = (vIsPerspective != 0.0)? log2(vFragDepth) * logDepthBufFC * 0.5 : gl_FragCoord.z;\n\t#endif\n\n\t#ifdef IS_SKY\n\t\t// We simply sample the skybox cube texture and we're done.\n\t\tvec4 sampled = sampleCubeTexture(envMap, eyeDirection);\n\t\tgl_FragColor = sampled;\n\t#elif defined(IS_SHADOW)\n\t\tbool hasDirectionalLight = dot(directionalLightDirection, directionalLightDirection) > 0.0;\n\t\tfloat intensity = getShadowIntensity(directionalLightShadowMap, vShadowPosition, 250);\n\t\tif (!hasDirectionalLight) intensity = 0.0;\n\t\t\n\t\tgl_FragColor = vec4(vec3(0.0), intensity * 0.25); // Note that this intensity differs from the one used in the normal shader path. That's because with a separate shadow material, it's actually difficult to figure out how dark the shadow should be - so whatever value we picked here just looked the least odd.\n\t#else\n\t\tvec4 diffuse = vec4(1.0);\n\n\t\t#ifdef USE_DIFFUSE_MAP\n\t\t\tdiffuse = texture2D(diffuseMap, vUv);\n\t\t\t#ifndef TRANSPARENT\n\t\t\t\tdiffuse.a = 1.0;\n\t\t\t#endif\n\t\t#endif\n\n\t\t#ifdef USE_NOISE_MAP\n\t\t\t// Sample the noise texture multiple times to create the tiling effect found in MBU textures. Code is taken from MBU shaders!\n\n\t\t\tvec2 noiseIndex;\n\t\t\tvec4 noiseColor[4];\n\t\t\tvec2 halfPixel = vec2(1.0 / 64.0, 1.0 / 64.0);\n\n\t\t\tnoiseIndex.x = floor(vUv.x - halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y - halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[0] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tnoiseIndex.x = floor(vUv.x - halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y + halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[1] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tnoiseIndex.x = floor(vUv.x + halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y + halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[2] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tnoiseIndex.x = floor(vUv.x + halfPixel.x) / 63.0 + 0.5/64.0;\n\t\t\tnoiseIndex.y = floor(vUv.y - halfPixel.y) / 63.0 + 0.5/64.0;\n\t\t\tnoiseColor[3] = texture2D(noiseMap, noiseIndex) * 1.0 - 0.5;\n\n\t\t\tvec4 finalNoiseCol = (noiseColor[0] + noiseColor[1] + noiseColor[2] + noiseColor[3]) / 4.0;\n\t\t\tdiffuse.rgb *= 1.0 + finalNoiseCol.r; // This isn't how MBU does it afaik but it looks good :o\n\t\t#endif\n\n\t\tdiffuse.a *= vOpacity; // Multiply the diffuse by the whole mesh's opacity (and the material's opacity)\n\n\t\tvec3 incomingLight = vec3(0.0);\n\t\tvec3 specularLight = vec3(0.0);\n\n\t\t#ifdef EMISSIVE\n\t\t\tincomingLight = vec3(1.0);\n\t\t#else\n\t\t\tincomingLight += ambientLight;\n\n\t\t\tvec3 normal = vNormal;\n\n\t\t\t#ifdef USE_NORMAL_MAP\n\t\t\t\t// Overwrite the normal with the sampled one\n\t\t\t\tvec3 map = texture2D(normalMap, secondaryMapUvFactor * vUv).xyz;\n\t\t\t\tmap = map * 255.0/127.0 - 128.0/127.0;\n\t\t\t\t#ifdef INVERT_U\n\t\t\t\t\tmap.x = -map.x;\n\t\t\t\t#endif\n\t\t\t\tnormal = vTbn * map; // Don't normalize here! Reduces aliasing effects\n\t\t\t#endif\n\n\t\t\tvec3 addedLight = directionalLightColor * lambert(normal, -directionalLightDirection);\n\n\t\t\t#ifdef SATURATE_INCOMING_LIGHT\n\t\t\t\t// MBG saturates the incoming light to be at most 1.0\n\t\t\t\taddedLight = min(vec3(1.0), incomingLight + addedLight) - incomingLight;\n\t\t\t#endif\n\n\t\t\t#ifdef RECEIVE_SHADOWS\n\t\t\t\t// When the direction has zero length, we make the assumption that there is no directional light in the scene.\n\t\t\t\tbool hasDirectionalLight = dot(directionalLightDirection, directionalLightDirection) > 0.0;\n\t\t\t\tfloat intensity = getShadowIntensity(directionalLightShadowMap, vShadowPosition, 250);\n\t\t\t\tif (!hasDirectionalLight) intensity = 0.0;\n\n\t\t\t\taddedLight *= mix(1.0, 0.666, intensity);\n\t\t\t#endif\n\t\t\t\n\t\t\tincomingLight += addedLight;\n\n\t\t\t#ifdef USE_SPECULAR\n\t\t\t\tvec3 viewDir = normalize(eyePosition - vPosition.xyz);\n\t\t\t\tvec3 halfwayDir = normalize(-directionalLightDirection + viewDir); // Blinn-Phong\n\n\t\t\t\tfloat spec = pow(max(dot(normal, halfwayDir), 0.0), shininess);\n\n\t\t\t\t#ifdef USE_SPECULAR_MAP\n\t\t\t\t\tspec *= texture2D(specularMap, secondaryMapUvFactor * vUv).r;\n\t\t\t\t#endif\n\n\t\t\t\tspecularLight += vec3(specularIntensity * spec);\n\t\t\t#endif\n\t\t#endif\n\n\t\tvec4 shaded = diffuse * vec4(incomingLight, 1.0);\n\t\tshaded.rgb += specularLight;\n\n\t\t#ifdef USE_ENV_MAP\n\t\t\t#ifdef USE_FRESNEL\n\t\t\t\t// Fresnel causes the reflectivity to increase with incresing angle of incidence\n\t\t\t\tvec3 viewDir = normalize(eyePosition - vPosition.xyz);\n\t\t\t\tfloat fac = fresnel(viewDir, normal, true);\n\t\t\t#else\n\t\t\t\tfloat fac = 1.0;\n\t\t\t#endif\n\n\t\t\t#ifdef USE_ACCURATE_REFLECTION_RAY\n\t\t\t\t// The reflection ray tends to be much more accurate when computed using the interpolated normal rather than interpolating the reflection ray itself; but it's more expensive and sometimes looks too boring\n\t\t\t\tvec3 incidentRay = normalize(vPosition.xyz - eyePosition);\n\t\t\t\tvec3 reflectionRay = reflect(incidentRay, normalize(vNormal));\n\t\t\t#else\n\t\t\t\tvec3 reflectionRay = vReflect;\n\t\t\t#endif\n\n\t\t\tvec4 sampled = sampleCubeTexture(envMap, reflectionRay);\n\t\t\tsampled.a *= vOpacity;\n\t\t\t\n\t\t\tshaded = mix(shaded, sampled, fac * reflectivity);\n\t\t#endif\n\n\t\t#ifdef USE_NORMAL_MAP\n\t\t\tif (debugMode == 0) {}\n\t\t\telse if (debugMode == 1) {\n\t\t\t\tshaded = vec4(mod(vUv, 1.0f), 0, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 2) {\n\t\t\t\tshaded = vec4((vNormal + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 3) {\n\t\t\t\tshaded = vec4((map + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 4) {\n\t\t\t\tshaded = vec4((normal + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\t/*\n\t\t\tif (debugMode == 5) {\n\t\t\t\tshaded = vec4((vTangent.xyz + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\tif (debugMode == 6) {\n\t\t\t\tshaded = vec4(vec3((vTangent.w + 1.0f) / 2.0f), 1);\n\t\t\t}\n\t\t\t*/\n\t\t\telse if (debugMode == 7) {\n\t\t\t\tshaded = vec4((vTbn[0] + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 8) {\n\t\t\t\tshaded = vec4((vTbn[1] + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t\telse if (debugMode == 9) {\n\t\t\t\tshaded = vec4((vTbn[2] + 1.0f) / 2.0f, 1);\n\t\t\t}\n\t\t#endif\n\t\tgl_FragColor = shaded;\n\t\t#ifdef USE_PREMULTIPLIED_ALPHA\n\t\t\tgl_FragColor.rgb *= gl_FragColor.a;\n\t\t#endif\n\t#endif\n}";class yn extends Kt{constructor(e){super(),this.allDefineChunks=new Set,this.ambientLights=[],this.directionalLights=[],this.particleManager=null,this.firstUpdate=!0,this.compiled=!1,this.preparedForRender=!1,this.renderer=e}addAmbientLight(e){this.ambientLights.push(e)}addDirectionalLight(e){this.directionalLights.push(e)}compile(){let{gl:e}=this.renderer,t=new Map,i=[];this.traverse(e=>e instanceof wt&&i.push(e)),this.allMeshes=i;let n=[],a=[],r=[],o=[],l=[],h=[];for(let[e,s]of i.entries()){s.geometry.validate(),s.vboOffset=l.length,s.compileMaterialIndices();let i=s.geometry.positions.length/3;P.pushArray(n,s.geometry.positions),P.pushArray(a,s.geometry.normals),P.pushArray(o,s.geometry.uvs),P.pushArray(l,Array(i).fill(e)),s.materials.some(e=>e.normalMap)?this.computeTangents(s.geometry.positions,s.geometry.normals,s.geometry.uvs,r):P.pushArray(r,Array(4*i).fill(0));for(let e of s.materialIndices){let i=e.material,n=i.getDefineChunk();if(this.allDefineChunks.add(n),!this.renderer.materialShaders.has(n)){let e=new Q(this.renderer,gn,fn,n);this.renderer.materialShaders.set(n,e)}s.castShadows&&P.pushArray(h,e.indices),i.transparent||i.opacity<1?s.hasTransparentMaterials=!0:this.updateMaterialGroup(t,e)}}let d=[...t].map(e=>e[1]);d.sort((e,t)=>e.defineChunk.localeCompare(t.defineChunk)).sort((e,t)=>e.material.renderOrder-t.material.renderOrder),this.opaqueMaterialGroups=d;let c=[];for(let e of d){e.offset=c.length;for(let t of e.indexGroups)P.pushArray(c,t.indices)}this.positionBuffer=new mi(this.renderer,new Float32Array(n),{position:3}),this.normalBuffer=new mi(this.renderer,new Float32Array(a),{normal:3}),this.tangentBuffer=new mi(this.renderer,new Float32Array(r),{tangent:4}),this.uvBuffer=new mi(this.renderer,new Float32Array(o),{uv:2}),this.meshInfoIndexBuffer=new mi(this.renderer,new Float32Array(l),{meshInfoIndex:1}),this.bufferGroup=new pi([this.positionBuffer,this.normalBuffer,this.tangentBuffer,this.uvBuffer,this.meshInfoIndexBuffer]);let u=e.getParameter(e.MAX_TEXTURE_SIZE),m=this.meshInfoTextureWidth=P.ceilPowerOf2(Math.min(4*i.length,u)),p=this.meshInfoTextureHeight=P.ceilPowerOf2(Math.ceil(4*i.length/Math.max(u,m))),g=e instanceof WebGLRenderingContext?e.RGBA:e.RGBA32F;this.meshInfoBuffer=new Float32Array(4*m*p),this.meshInfoTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.meshInfoTexture),e.texImage2D(e.TEXTURE_2D,0,g,m,p,0,e.RGBA,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);let f=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint32Array(c),e.STATIC_DRAW),this.opaqueIndexBuffer=f,this.shadowCasterIndices=h,this.shadowCasterIndexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.shadowCasterIndexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint32Array(h),e.STATIC_DRAW);let y=i.map(e=>e.geometry.indices.length).reduce((e,t)=>e+t,0),b=e.createBuffer(),v=new Uint32Array(y);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,b),e.bufferData(e.ELEMENT_ARRAY_BUFFER,v,e.DYNAMIC_DRAW),this.transparentIndexBuffer=b,this.transparentIndexBufferData=v;let w=new s;this.ambientLights.forEach(e=>w.add(e.color)),this.ambientLightBuffer=new Float32Array(w.toArray());let x=new s,S=new s;for(let e of this.directionalLights)x.add(e.color),S.addScaledVector(e.direction,1/this.directionalLights.length);this.directionalLightColorBuffer=new Float32Array(x.toArray()),this.directionalLightDirectionBuffer=new Float32Array(S.toArray()),this.directionalLightTransformBuffer=new Float32Array(16),this.compiled=!0}updateMaterialGroup(e,t){let i=t.material,s=i.getHash(),n=e.get(s);return n||(n={material:i,indexGroups:[],defineChunk:i.getDefineChunk(),offset:0,count:0,minDistance:1/0},e.set(s,n)),n.indexGroups.push(t),n.count+=t.indices.length,n}computeTangents(e,t,i,n){let a=e.length/3/3,r=new s,o=new s,l=new s,h=new B,d=new B,c=new B,u=new s,m=new s,p=new s,g=new s;for(let s=0;s<a;s++){r.set(e[9*s+0],e[9*s+1],e[9*s+2]),o.set(e[9*s+3],e[9*s+4],e[9*s+5]),l.set(e[9*s+6],e[9*s+7],e[9*s+8]),h.set(i[6*s+0],i[6*s+1]),d.set(i[6*s+2],i[6*s+3]),c.set(i[6*s+4],i[6*s+5]);let a=o.x-r.x,f=l.x-r.x,y=o.y-r.y,b=l.y-r.y,v=o.z-r.z,w=l.z-r.z,x=d.x-h.x,S=c.x-h.x,T=d.y-h.y,M=c.y-h.y,k=1/(x*M-S*T);u.set((M*a-T*f)*k,(M*y-T*b)*k,(M*v-T*w)*k),m.set((x*f-S*a)*k,(x*b-S*y)*k,(x*w-S*v)*k);for(let e=0;e<3;e++){p.set(t[9*s+3*e+0],t[9*s+3*e+1],t[9*s+3*e+2]),g.copy(u).addScaledVector(p,-p.dot(u)).normalize();let i=p.cross(u).dot(m)<0?-1:1;n.push(g.x,g.y,g.z,i)}}}prepareForRender(e){var t;let{gl:i}=this.renderer;this.update(),null===(t=this.directionalLights[0])||void 0===t||t.renderShadowMap(this);let n=new s,a=e.position,r=this.allMeshes.filter(e=>e.hasTransparentMaterials||e.opacity<1&&e.opacity>0);for(let e of r)e.distanceToCamera=n.setFromMatrixPosition(e.worldTransform).distanceToSquared(a);let o=r.sort((e,t)=>t.distanceToCamera-e.distanceToCamera),l=new Map;for(let e of o)for(let t of e.materialIndices){let i=t.material,s=e.opacity*i.opacity;if(!i.transparent&&1===s||0===s)continue;let n=this.updateMaterialGroup(l,t);n.minDistance=Math.min(n.minDistance,e.distanceToCamera)}let h=[...l].map(e=>e[1]);h.sort((e,t)=>t.minDistance-e.minDistance),this.transparentMaterialGroups=h;let d=0;for(let e of h){e.offset=d;for(let t of e.indexGroups)this.transparentIndexBufferData.set(t.indexBuffer,d),d+=t.indices.length}i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.transparentIndexBuffer),i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,0,this.transparentIndexBufferData,0,d),this.preparedForRender=!0}update(){let{gl:e}=this.renderer;this.updateWorldTransform();for(let e=0;e<this.allMeshes.length;e++){let t=this.allMeshes[e];if(t.needsVertexBufferUpdate){let e=t.vboOffset;this.positionBuffer.set(t.geometry.positions,3*e),this.normalBuffer.set(t.geometry.normals,3*e),this.uvBuffer.set(t.geometry.uvs,2*e),t.needsVertexBufferUpdate=!1}(this.firstUpdate||t.needsMeshInfoBufferUpdate)&&t.updateMeshInfoBuffer(this.meshInfoBuffer,16*e)}e.bindTexture(e.TEXTURE_2D,this.meshInfoTexture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,this.meshInfoTextureWidth,this.meshInfoTextureHeight,e.RGBA,e.FLOAT,this.meshInfoBuffer),this.positionBuffer.update(),this.normalBuffer.update(),this.uvBuffer.update(),this.updateDirectionalLights(),this.firstUpdate=!1}updateDirectionalLights(){let e=this.directionalLights[0];if(e&&e.camera){let t=new d;t.multiplyMatrices(e.camera.projectionMatrix,e.camera.matrixWorldInverse),this.directionalLightTransformBuffer.set(t.elements,0)}}dispose(){let{gl:e}=this.renderer;this.positionBuffer.dispose(),this.normalBuffer.dispose(),this.tangentBuffer.dispose(),this.uvBuffer.dispose(),this.meshInfoIndexBuffer.dispose(),e.deleteTexture(this.meshInfoTexture),e.deleteBuffer(this.opaqueIndexBuffer),e.deleteBuffer(this.transparentIndexBuffer),e.deleteBuffer(this.shadowCasterIndexBuffer),this.particleManager.dispose();for(let e of this.directionalLights)e.dispose()}}class bn{constructor(e){this.color=e}}class vn{constructor(e,t,i){this.camera=null,this.renderer=e,this.color=t,this.direction=i}enableShadowCasting(e,t){P.assert(P.isPowerOf2(e));let{gl:i}=this.renderer;this.camera=t;let s=i.createTexture(),n=i instanceof WebGLRenderingContext?i.DEPTH_COMPONENT:i.DEPTH_COMPONENT32F,a=i instanceof WebGLRenderingContext?i.UNSIGNED_INT:i.FLOAT;i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,n,e,e,0,i.DEPTH_COMPONENT,a,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),this.depthTexture=s;let r=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,r),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,s,0),this.depthFramebuffer=r;let o=i.createTexture();i.bindTexture(i.TEXTURE_2D,o),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,e,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),this.colorTexture=o,i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,o,0),this.depthTexture=s,this.textureResolution=e}updateCamera(e,t){this.camera&&(this.camera.position.copy(e.clone().addScaledVector(this.direction,t)),this.camera.lookAt(this.camera.position.clone().add(this.direction)),this.camera.updateMatrixWorld())}renderShadowMap(e){if(!this.camera)return;let{gl:t,shadowMapProgram:i}=this.renderer;t.depthMask(!0),t.bindFramebuffer(t.FRAMEBUFFER,this.depthFramebuffer),t.viewport(0,0,this.textureResolution,this.textureResolution),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),i.use(),i.bindVertexBufferGroup(e.bufferGroup),t.uniformMatrix4fv(i.getUniformLocation("viewMatrix"),!1,new Float32Array(this.camera.matrixWorldInverse.elements)),t.uniformMatrix4fv(i.getUniformLocation("projectionMatrix"),!1,new Float32Array(this.camera.projectionMatrix.elements)),t.uniform1i(i.getUniformLocation("meshInfoTextureWidth"),e.meshInfoTextureWidth),t.uniform1i(i.getUniformLocation("meshInfoTextureHeight"),e.meshInfoTextureHeight),t.uniform1i(i.getUniformLocation("meshInfos"),7),this.renderer.bindTexture(e.meshInfoTexture,7,t.TEXTURE_2D),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.shadowCasterIndexBuffer),t.drawElements(t.TRIANGLES,e.shadowCasterIndices.length,t.UNSIGNED_INT,0)}bindShadowMap(){let{gl:e}=this.renderer;this.renderer.bindTexture(this.depthTexture,2,e.TEXTURE_2D)}dispose(){if(!this.camera)return;let{gl:e}=this.renderer;e.deleteTexture(this.depthTexture),e.deleteTexture(this.colorTexture),e.deleteFramebuffer(this.depthFramebuffer)}}const wn=1,xn=-52,Sn=8;let Tn=new s,Mn=new s,kn=new r;class Cn{constructor(){this.beforeOperation=null,this.root=new En(this,0),this.root.min.set(0,0,0),this.root.size=wn,this.objectToNode=new WeakMap}insert(e){if(this.objectToNode.get(e))return;for(;!this.root.largerThan(e)||!this.root.containsCenter(e);){if(this.root.depth===xn)return console.log(e),console.warn(`Can't insert ${this.root.largerThan(e)?"distant":"large"} object into octree; the octree has already expanded to its maximum size.`),void this.shrink();this.grow(e)}let t=0===this.root.count;this.root.insert(e),t&&this.shrink()}remove(e){let t=this.objectToNode.get(e);t&&(t.remove(e),this.objectToNode.delete(e),this.shrink())}update(e){let t=this.objectToNode.get(e);t?t.update(e)||(this.objectToNode.delete(e),this.insert(e)):this.insert(e)}grow(e){let t=Tn.set(0,0,0),i=0;for(let s=0;s<8;s++){let n=Mn;n.setComponent(0,1&s?e.boundingBox.min.x:e.boundingBox.max.x),n.setComponent(1,2&s?e.boundingBox.min.y:e.boundingBox.max.y),n.setComponent(2,4&s?e.boundingBox.min.z:e.boundingBox.max.z),this.root.containsPoint(n)||(t.add(n),i++)}t.multiplyScalar(1/i);let s=Mn.copy(this.root.min).addScalar(this.root.size/2),n=t.sub(s),a=new En(this,this.root.depth-1);if(a.min.copy(this.root.min),a.size=2*this.root.size,n.x<0&&(a.min.x-=this.root.size),n.y<0&&(a.min.y-=this.root.size),n.z<0&&(a.min.z-=this.root.size),this.root.count>0){let e=(n.x<0?1:0)+(n.y<0?2:0)+(n.z<0?4:0);a.createOctants(),a.octants[e]=this.root,this.root.parent=a,a.count=this.root.count,a.merge()}this.root=a}shrink(){if(this.root.size<=wn)return;if(0===this.root.count)return this.root.min.set(0,0,0),this.root.size=wn,void(this.root.depth=0);if(!this.root.octants){this.root.createOctants();let e=null;for(let t of this.root.objects){if(!this.root.octants[0].largerThan(t))return;for(let i=0;i<8;i++){let s=this.root.octants[i];if(s.containsCenter(t)){if(e&&e!==s)return;e=s}}}return this.root.size/=2,this.root.min.copy(e.min),this.root.depth++,this.root.octants=null,void this.shrink()}let e;for(let t=0;t<8;t++){let i=this.root.octants[t];if(i.count>0){if(e)return;e=i}}this.root=e,e.parent=null,this.shrink()}intersectAabb(e){var t;null===(t=this.beforeOperation)||void 0===t||t.call(this);let i=[];return this.root.intersectAabb(e,i),i}}class En{constructor(e,t){this.parent=null,this.min=new s,this.octants=null,this.objects=new Set,this.count=0,this.octree=e,this.depth=t}insert(e){if(this.count++,this.octants){if(this.octants[0].largerThan(e))for(let t=0;t<8;t++){let i=this.octants[t];if(i.containsCenter(e))return void i.insert(e)}this.objects.add(e),this.octree.objectToNode.set(e,this)}else this.objects.add(e),this.octree.objectToNode.set(e,this),this.split()}split(){if(!(this.objects.size<=8||this.depth===Sn)){this.createOctants();for(let e of this.objects)if(this.octants[0].largerThan(e))for(let t=0;t<8;t++){let i=this.octants[t];i.containsCenter(e)&&(i.insert(e),this.objects.delete(e))}for(let e=0;e<8;e++)this.octants[e].split()}}createOctants(){this.octants=[];for(let e=0;e<8;e++){let t=new En(this.octree,this.depth+1);t.parent=this,t.size=this.size/2,t.min.set(this.min.x+t.size*((1&e)>>0),this.min.y+t.size*((2&e)>>1),this.min.z+t.size*((4&e)>>2)),this.octants.push(t)}}remove(e){this.objects.delete(e),this.count--,this.merge();let t=this.parent;for(;t;)t.count--,t.merge(),t=t.parent}update(e){this.objects.delete(e);let t=this;for(;t;){if(t.count--,t.merge(),t.largerThan(e)&&t.containsCenter(e))return t.insert(e),!0;t=t.parent}return!1}merge(){if(!(this.count>8)&&this.octants){for(let e=0;e<8;e++){let t=this.octants[e];for(let e of t.objects)this.objects.add(e),this.octree.objectToNode.set(e,this)}this.octants=null}}largerThan(e){let t=e.boundingBox;return this.size>t.max.x-t.min.x&&this.size>t.max.y-t.min.y&&this.size>t.max.z-t.min.z}containsCenter(e){let t=e.boundingBox,i=t.min.x+(t.max.x-t.min.x)/2,s=t.min.y+(t.max.y-t.min.y)/2,n=t.min.z+(t.max.z-t.min.z)/2;return this.min.x<=i&&i<this.min.x+this.size&&this.min.y<=s&&s<this.min.y+this.size&&this.min.z<=n&&n<this.min.z+this.size}containsPoint(e){let{x:t,y:i,z:s}=e;return this.min.x<=t&&t<this.min.x+this.size&&this.min.y<=i&&i<this.min.y+this.size&&this.min.z<=s&&s<this.min.z+this.size}intersectAabb(e,t){let i=kn;if(i.min.copy(this.min).addScalar(-this.size/2),i.max.copy(this.min).addScalar(3*this.size/2),e.intersectsBox(i)){if(this.objects.size>0)for(let i of this.objects)e.intersectsBox(i.boundingBox)&&t.push(i);if(this.octants)for(let i=0;i<8;i++){let s=this.octants[i];0!==s.count&&s.intersectAabb(e,t)}}}}let An=new s,Bn=new i;class Pn{constructor(e,t){this.timeOfImpact=1,this.s1MaterialOverride=null,this.s2MaterialOverride=null,this.s1=e,this.s2=t,this.friction=e.friction*t.friction,this.restitution=e.restitution*t.restitution,this.s1Friction=e.friction,this.s1Restitution=e.restitution,this.s2Friction=t.friction,this.s2Restitution=t.restitution}supplyCollisionPlane(e){this.normal=e.normal.clone(),this.depth=e.constant,this.point1=this.s1.support(new s,An.copy(this.normal).negate()),this.point2=this.point1.clone().addScaledVector(this.normal,this.depth),this.point=this.point1.clone().add(this.point2).multiplyScalar(.5)}updateMaterialProperties(){if(this.normal&&(this.s1.materialOverrides.size>0||this.s2.materialOverrides.size>0)){let e=this.s1.friction,t=this.s2.friction,i=this.s1.restitution,s=this.s2.restitution,n=-1/0,a=1/0,r=An;Bn.copy(this.s1.body.orientation).conjugate(),r.copy(this.normal).applyQuaternion(Bn);for(let[t,s]of this.s1.materialOverrides){let n=t.dot(r);n<a&&(a=n,e=s.friction,i=s.restitution,this.s1MaterialOverride=t)}Bn.copy(this.s2.body.orientation).conjugate(),r.copy(this.normal).applyQuaternion(Bn);for(let[e,i]of this.s2.materialOverrides){let a=e.dot(r);a>n&&(n=a,t=i.friction,s=i.restitution,this.s2MaterialOverride=e)}this.friction=e*t,this.restitution=i*s,this.s1Friction=e,this.s1Restitution=i,this.s2Friction=t,this.s2Restitution=s}}}const In=64,Ln=64,_n=10*Number.EPSILON,Rn=64,Fn=64;let Un=[new s,new s,new s,new s],zn=0,Dn=new s,Vn=new s,On=new s,Nn=new s,qn=new s,jn=new s,Gn=new s,Wn=new s,Hn=new s,Xn=new s,Yn=new s,Kn=new s,Qn=new s,$n=new s,Zn=new s,Jn=new s,ea=new s,ta=new s,ia=new s,sa=new s,na=new s,aa=new s,ra=0,oa=null,la=null,ha=new s(0,0,0),da=new A,ca=new Ct;ca.addCollisionShape(da);let ua=[],ma=[];for(let e=0;e<Fn;e++)ua.push([new s,new s,new s,new s]);for(let e=0;e<Rn;e++)ma.push([new s,new s]);class pa{static support(e,t,i,s){return t.support(e,s).sub(i.support(Zn,Jn.copy(s).negate()))}static checkIntersection(e,t){return oa=e,la=t,e instanceof C&&t instanceof C?this.checkBallBallIntersection(e,t):e instanceof C?this.checkBallConvexIntersection(e,t):this.checkConvexConvexIntersection(e,t)}static checkBallBallIntersection(e,t){return e.body.position.distanceTo(t.body.position)<=e.radius+t.radius}static checkBallConvexIntersection(e,t){return ca.position.copy(e.body.position),this.determineClosestPoint(new s,t,da).lengthSq()<=e.radius**2}static checkConvexConvexIntersection(e,t){Vn.copy(t.body.position).sub(e.body.position).normalize(),this.support(Dn,e,t,Vn),zn=1,Un[0].copy(Dn),Vn.copy(Dn).negate();for(let i=0;i<In;i++){if(this.support(Dn,e,t,Vn),Dn.dot(Vn)<=0)return!1;if(this.addPointToSimplex(Dn),this.updateSimplexFast(),4===zn)return!0}return!1}static determineClosestPoint(e,t,i){Vn.copy(i.body.position).sub(t.body.position),zn=0;for(let e=0;e<In&&4!==zn&&(this.support(Dn,t,i,Vn),!(Vn.lengthSq()+Vn.dot(Dn)<=10*Number.EPSILON));e++)this.addPointToSimplex(Dn),this.updateSimplexAndClosestPoint(Vn),Vn.negate();return e.copy(Vn).negate()}static determineTimeOfImpact(e,t,i=.03){e.body.getRelativeMotionVector(ea,t.body);let s=ea.length();ta.copy(e.body.position),ia.copy(t.body.position),e.body.position.copy(e.body.prevPosition),t.body.position.copy(t.body.prevPosition);let n=this.castRay(t,e,ha,ea,1);if(e.body.position.copy(ta),t.body.position.copy(ia),!n)return null;let a=Math.min(i*s,i/s);return n.lambda+=a,n.lambda=P.clamp(n.lambda,0,1),n.lambda}static castRay(e,t,i,s,n){Vn.copy(t.body.position).sub(e.body.position).normalize(),this.support(Dn,e,t,Vn),zn=0,sa.copy(i),na.setScalar(0);let a=0;Vn.copy(sa).sub(Dn);for(let r=0;r<In;r++){if(this.support(Dn,e,t,Vn),aa.copy(sa).sub(Dn),Vn.dot(aa)>0){if(Vn.dot(s)>=0)return null;if((a-=Vn.dot(aa)/Vn.dot(s))>n)return null;sa.copy(i).addScaledVector(s,a),na.copy(Vn)}this.addPointToSimplex(Dn);for(let e=0;e<zn;e++)Un[e].sub(sa);this.updateSimplexAndClosestPoint(Vn),Vn.negate();for(let e=0;e<zn;e++)Un[e].add(sa);let r=0;for(let e=0;e<zn;e++)r=Math.max(r,Un[e].distanceToSquared(sa));if(Vn.lengthSq()<10*Number.EPSILON*r)return{point:sa.clone(),lambda:a,normal:na.clone().normalize()}}return null}static addPointToSimplex(e){for(let t=0;t<zn;t++)if(e.distanceToSquared(Un[t])<10*Number.EPSILON)return;for(let e=zn;e>0;e--)Un[e].copy(Un[e-1]);Un[0].copy(e),zn++}static updateSimplexFast(){switch(zn){case 2:return this.updateLine();case 3:return this.updateTriangle();case 4:return this.updateTetrahedron();default:throw new Error("Shouldn't happen: "+zn)}}static updateLine(){let e=Un[0],t=Un[1];jn.copy(t).sub(e),On.copy(e).negate(),jn.dot(On)>0?Vn.copy(jn).cross(On).cross(jn):(zn--,Vn.copy(On))}static updateTriangle(){let e=Un[0],t=Un[1],i=Un[2];if(jn.copy(t).sub(e),Gn.copy(i).sub(e),On.copy(e).negate(),Yn.copy(jn).cross(Gn),Zn.copy(Yn).cross(Gn).dot(On)>0){if(!(Gn.dot(On)>0))return zn--,this.updateLine();t.copy(i),zn--,Vn.copy(Gn).cross(On).cross(Gn)}else{if(Zn.copy(jn).cross(Yn).dot(On)>0)return zn--,this.updateLine();Yn.dot(On)>0?Vn.copy(Yn):(Zn.copy(i),i.copy(t),t.copy(Zn),Vn.copy(Yn).negate())}}static updateTetrahedron(){let e=Un[0],t=Un[1],i=Un[2],s=Un[3];return jn.copy(t).sub(e),Gn.copy(i).sub(e),Wn.copy(s).sub(e),On.copy(e).negate(),Yn.copy(jn).cross(Gn),Kn.copy(Gn).cross(Wn),Qn.copy(Wn).cross(jn),Yn.dot(On)>0?(zn--,this.updateTriangle()):Kn.dot(On)>0?(t.copy(i),i.copy(s),zn--,this.updateTriangle()):Qn.dot(On)>0?(i.copy(t),t.copy(s),zn--,this.updateTriangle()):void 0}static updateSimplexAndClosestPoint(e){let t;switch(ra=0,zn){case 1:t=this.closestPointPoint(e,Un[0]);break;case 2:t=this.closestPointLineSegment(e,Un[0],Un[1]);break;case 3:t=this.closestPointTriangle(e,Un[0],Un[1],Un[2]);break;case 4:t=this.closestPointTetrahedron(e,Un[0],Un[1],Un[2],Un[3]);break;default:throw new Error("Shouldn't get here! "+zn)}let i=0;for(let e=0;e<4;e++)t&1<<e&&(Un[i].copy(Un[e]),i++);zn=i,ra&&(Zn.copy(Un[1]),Un[1].copy(Un[2]),Un[2].copy(Zn))}static closestPointPoint(e,t){return e.copy(t),1}static closestPointLineSegment(e,t,i){jn.copy(i).sub(t),On.copy(t).negate();let s=P.clamp(jn.dot(On)/jn.dot(jn),0,1);return 0===s?(e.copy(t),1):1===s?(e.copy(i),2):(e.copy(t).addScaledVector(jn,s),3)}static closestPointTriangle(e,t,i,s){jn.copy(i).sub(t),Gn.copy(s).sub(t),On.copy(t).negate();let n=jn.dot(On),a=Gn.dot(On);if(n<=0&&a<=0)return e.copy(t),1;Nn.copy(i).negate();let r=jn.dot(Nn),o=Gn.dot(Nn);if(r>=0&&o<=r)return e.copy(i),2;let l=n*o-r*a;if(l<=0&&n>=0&&r<=0){let i=n/(n-r);return e.copy(t).addScaledVector(jn,i),3}qn.copy(s).negate();let h=jn.dot(qn),d=Gn.dot(qn);if(d>=0&&h<=d)return e.copy(s),4;let c=h*a-n*d;if(c<=0&&a>=0&&d<=0){let i=a/(a-d);return e.copy(t).addScaledVector(Gn,i),5}let u=r*d-h*o;if(u<=0&&o-r>=0&&h-d>=0){Hn.copy(s).sub(i);let t=(o-r)/(o-r+(h-d));return e.copy(i).addScaledVector(Hn,t),6}let m=1/(u+c+l),p=c*m,g=l*m;return e.copy(t).addScaledVector(jn,p).addScaledVector(Gn,g),Yn.copy(jn).cross(Gn),Yn.dot(e)>0&&(ra^=1),7}static closestPointTetrahedron(e,t,i,s,n){jn.copy(i).sub(t),Gn.copy(s).sub(t),Wn.copy(n).sub(t),Hn.copy(s).sub(i),Xn.copy(n).sub(i),On.copy(t).negate(),Nn.copy(i).negate(),Yn.copy(jn).cross(Gn),Kn.copy(Gn).cross(Wn),Qn.copy(Wn).cross(jn),$n.copy(Xn).cross(Hn);let a,r,o=Yn.dot(On)>0,l=Kn.dot(On)>0,h=Qn.dot(On)>0,d=$n.dot(Nn)>0,c=Math.abs(Yn.dot(Wn))<10*Number.EPSILON,u=1/0;if(o||c){ra=0;let n=this.closestPointTriangle(Zn,t,i,s),o=Zn.lengthSq();e.copy(Zn),u=o,a=n,r=ra}if(l||c){ra=0;let i=this.closestPointTriangle(Zn,t,s,n),o=Zn.lengthSq();o<u&&(e.copy(Zn),u=o,a=1&i|(2&i)<<1|(4&i)<<1,r=ra)}if(h||c){ra=0;let s=this.closestPointTriangle(Zn,t,n,i),o=Zn.lengthSq();o<u&&(e.copy(Zn),u=o,a=1&s|(2&s)<<2|(4&s)>>1,r=1^ra)}if(d||c){ra=0;let t=this.closestPointTriangle(Zn,i,n,s),o=Zn.lengthSq();o<u&&(e.copy(Zn),u=o,a=(1&t)<<1|(2&t)<<2|4&t,r=1^ra)}return u===1/0&&(e.setScalar(0),a=15,r=0),ra=r,a}static determineCollisionPlane(e){return oa instanceof C&&la instanceof C?this.determineBallBallCollisionPlane(e):oa instanceof C?this.determineBallConvexCollisionPlane(e):this.determineConvexConvexCollisionPlane(e)}static determineBallBallCollisionPlane(e){let t=oa.radius+la.radius-oa.body.position.distanceTo(la.body.position);return e.normal.copy(oa.body.position).sub(la.body.position).normalize(),e.constant=t,e}static determineBallConvexCollisionPlane(e){let t=Vn.length();return 0===t?this.determineConvexConvexCollisionPlane(e):(e.normal.copy(Vn).normalize(),e.constant=oa.radius-t,e)}static determineConvexConvexCollisionPlane(e){let t=Un[0],i=Un[1],s=Un[2],n=Un[3];ua[0][0].copy(t),ua[0][1].copy(i),ua[0][2].copy(s),ua[0][3].copy(i).sub(t).cross(Zn.copy(s).sub(t)).normalize(),ua[1][0].copy(t),ua[1][1].copy(s),ua[1][2].copy(n),ua[1][3].copy(s).sub(t).cross(Zn.copy(n).sub(t)).normalize(),ua[2][0].copy(t),ua[2][1].copy(n),ua[2][2].copy(i),ua[2][3].copy(n).sub(t).cross(Zn.copy(i).sub(t)).normalize(),ua[3][0].copy(i),ua[3][1].copy(n),ua[3][2].copy(s),ua[3][3].copy(n).sub(i).cross(Zn.copy(s).sub(i)).normalize();let a=4,r=0;for(let t=0;t<Fn;t++){let t=ua[0][0].dot(ua[0][3]);r=0;for(let e=1;e<a;e++){let i=ua[e][0].dot(ua[e][3]);i<t&&(t=i,r=e)}Vn.copy(ua[r][3]),this.support(Dn,oa,la,Vn);let i=Dn.dot(Vn);if(e.constant=Math.abs(i),ua[r][3].lengthSq()>0&&e.normal.copy(ua[r][3]).multiplyScalar(Math.sign(i)||1).negate(),i-t<_n)return e;let s=0,n=0;for(;n<a;){if(ua[n][3].dot(Zn.copy(Dn).sub(ua[n][0]))>0){for(let e=0;e<3;e++){let t=[ua[n][e],ua[n][(e+1)%3]],i=!1;for(let e=0;e<s;e++)if(ma[e][1].equals(t[0])&&ma[e][0].equals(t[1])){ma[e][0].copy(ma[s-1][0]),ma[e][1].copy(ma[s-1][1]),s--,i=!0;break}if(!i){if(s>=Rn)break;ma[s][0].copy(t[0]),ma[s][1].copy(t[1]),s++}}ua[n][0].copy(ua[a-1][0]),ua[n][1].copy(ua[a-1][1]),ua[n][2].copy(ua[a-1][2]),ua[n][3].copy(ua[a-1][3]),a--,n--}n++}for(let e=0;e<s&&!(a>=Ln);e++){ua[a][0].copy(ma[e][0]),ua[a][1].copy(ma[e][1]),ua[a][2].copy(Dn),ua[a][3].copy(ma[e][0]).sub(ma[e][1]).cross(Zn.copy(ma[e][0]).sub(Dn)).normalize();let t=1e-6;if(ua[a][0].dot(ua[a][3])+t<0){let e=ua[a][0];ua[a][0].copy(ua[a][1]),ua[a][1].copy(e),ua[a][3].negate()}a++}}let o=ua[r][0].dot(ua[r][3]);return e.constant=Math.abs(o),e.normal.copy(ua[r][3]).multiplyScalar(Math.sign(o)||1).negate(),e}static clearReferences(){oa=null,la=null}}let ga=new s,fa=new s,ya=new s,ba=new s,va=new s,wa=new s,xa=new s,Sa=new h,Ta=new h,Ma=new h,ka=new h,Ca=new h,Ea=new h,Aa=new h,Ba=new h,Pa=new h,Ia=new s,La=new s,_a=new s,Ra=new s,Fa=new s,Ua=new h;class za{static solvePosition(e){if(e.depth<.002)return;let t=e.depth-.001;e.s1.body.position.addScaledVector(e.normal,t)}static solveVelocity(e){e.s1.getCenter(ga),e.s2.getCenter(fa),ya.copy(e.point).sub(ga),ba.copy(e.point).sub(fa),va.copy(e.normal),0===va.z?wa.set(va.y,-va.x,0):wa.set(0,va.z,-va.y),wa.normalize(),xa.copy(va).cross(wa),Sa.set(va.x,wa.x,xa.x,va.y,wa.y,xa.y,va.z,wa.z,xa.z),Ta.copy(Sa).transpose(),Ma.identity().multiplyScalar(1/e.s1.mass),ka.identity().multiplyScalar(1/e.s2.mass),Ca.set(0,-ya.z,ya.y,ya.z,0,-ya.x,-ya.y,ya.x,0),Ea.set(0,-ba.z,ba.y,ba.z,0,-ba.x,-ba.y,ba.x,0),Aa.copy(Ma).sub(Ua.copy(Ca).multiply(e.s1.invInertia).multiply(Ca)).add(ka).sub(Ua.copy(Ea).multiply(e.s2.invInertia).multiply(Ea)),Ba.copy(Ta).multiply(Aa).multiply(Sa),Pa.copy(Ba).invert();let t=e.s1.body,i=e.s2.body;Ia.copy(t.angularVelocity).cross(ya).add(t.linearVelocity).applyMatrix3(Ta),La.copy(i.angularVelocity).cross(ba).add(i.linearVelocity).applyMatrix3(Ta);let s=Ia.x-La.x;if(s>-1e-4)return;let n=e.restitution;s>-.5&&(n=0),_a.set(-(1+n)*(Ia.x-La.x),-(Ia.y-La.y),-(Ia.z-La.z)),Ra.copy(_a).applyMatrix3(Pa);let a=Ra.y**2+Ra.z**2;if(a>e.friction**2*Ra.x**2){let t=e.friction/Math.sqrt(a);Ra.x=_a.x/(Ba.elements[0]+t*(Ba.elements[3]*Ra.y+Ba.elements[6]*Ra.z));let i=t*Ra.x;Ra.y*=i,Ra.z*=i}Fa.copy(Ra).applyMatrix3(Sa),t.linearVelocity.addScaledVector(Fa,1/e.s1.mass),t.angularVelocity.add(ya.cross(Fa).applyMatrix3(e.s1.invInertia)),i.linearVelocity.addScaledVector(Fa,-1/e.s2.mass),i.angularVelocity.sub(ba.cross(Fa).applyMatrix3(e.s2.invInertia))}}const Da=10;let Va=new s,Oa=new s,Na=new s,qa=new Pt,ja=new r,Ga=new A,Wa=new class extends k{constructor(e,t){super(),this.s1=e,this.s2=t}updateInertiaTensor(){}support(e,t){let i=this.s1.support(x,t),s=this.s2.support(S,t);return i.dot(t)>s.dot(t)?e.copy(i):e.copy(s),e}getCenter(e){return this.s1.getCenter(e).add(this.s2.getCenter(x)).multiplyScalar(.5)}}(null,null),Ha=new Ct;Ha.addCollisionShape(Ga),Ha.addCollisionShape(Wa);class Xa{constructor(){this.bodies=[],this.gravity=new s,this.octree=new Cn,this.inContactCcd=new Set,this.newInContactCcd=new Set,this.inContact=new Set,this.newInContact=new Set,this.cachedBroadphaseResults=new Map}add(e){if(e.world)throw new Error("RigidBody already belongs to a world.");this.bodies.push(e),e.world=this,e.syncShapes()}step(e){this.substep(e,0,0)}substep(e,t,i){if(e<1e-5||i>=Da)return;let s=[];for(let t=0;t<this.bodies.length;t++){let i=this.bodies[t];i.enabled&&(i.storePrevious(),i.onBeforeIntegrate(e),i.integrate(e),i.onAfterIntegrate(e),i.collisions.length=0,i.type===St.Dynamic&&s.push(...i.shapes))}this.cachedBroadphaseResults.clear();let n=this.computeCollisions(s,!0),a=1;for(let e=0;e<n.length;e++){let t=n[e];this.inContactCcd.has(t.s2)||(a=Math.min(t.timeOfImpact,a))}let r=t+a*(1-t);for(let t=0;t<this.bodies.length;t++){let i=this.bodies[t];if(!i.enabled)continue;if(i.revert(a),i.collisions.length=0,i.type!==St.Dynamic)continue;let s=Va.set(0,0,0);s.add(this.gravity),i.linearVelocity.addScaledVector(s,e*a)}let o=this.computeCollisions(s,!1),l=[];for(let e=0;e<o.length;e++){let t=o[e];l.includes(t.s1.body)||l.push(t.s1.body),l.includes(t.s2.body)||l.push(t.s2.body)}l.sort((e,t)=>e.evaluationOrder-t.evaluationOrder);for(let t=0;t<l.length;t++)l[t].onBeforeCollisionResponse(r,e*a);for(let e=0;e<o.length;e++){let t=o[e];0!=(t.s1.collisionResponseMask&t.s2.collisionResponseMask)&&(za.solvePosition(t),za.solveVelocity(t))}for(let t=0;t<l.length;t++)l[t].onAfterCollisionResponse(r,e*a);this.inContactCcd=this.newInContactCcd,this.newInContactCcd=new Set,this.inContact=this.newInContact,this.newInContact=new Set,this.substep(e*(1-a),r,i+1)}computeCollisions(e,t){let i=[];for(let s=0;s<e.length;s++){let n=e[s];if(!n.body.enabled)continue;let a=n.broadphaseShape||n,r=this.cachedBroadphaseResults.get(a),o=[];r||(r=this.octree.intersectAabb(a.boundingBox),this.cachedBroadphaseResults.set(a,r));e:for(let e=0;e<r.length;e++){let s=r[e];if(n!==s&&(0!=(n.collisionDetectionMask&s.collisionDetectionMask)&&s.body.enabled)){for(let e=0;e<i.length;e++){let t=i[e];if(t.s1===s&&t.s2===n)continue e}if(t){let e=pa.determineTimeOfImpact(n,s);if(null===e)continue;let t=new Pn(n,s);t.timeOfImpact=e,this.newInContactCcd.add(s),i.push(t)}else{if(!pa.checkIntersection(n,s))continue;let e=new Pn(n,s),t=!!(1&n.collisionDetectionMask);if(t){let t=pa.determineCollisionPlane(qa);e.supplyCollisionPlane(t)}if(t)for(let t=0;t<o.length;t++){let i=o[t];if(e.point2.distanceToSquared(i.point2)>=.1**2)continue;Wa.s1=i.s2,Wa.s2=s,pa.checkIntersection(n,Wa),pa.determineCollisionPlane(qa);let a,r=Na.copy(qa.normal),l=e.normal.dot(i.normal);if(e.normal.dot(r)<l-1e-10||i.normal.dot(r)<l-1e-10)continue;a=s.boundingBox.min.distanceTo(s.boundingBox.max);let h=pa.castRay(s,Ga,s.getCenter(Va).addScaledVector(r,a),Oa.copy(r).negate(),a);a=i.s2.boundingBox.min.distanceTo(i.s2.boundingBox.max);let d=pa.castRay(i.s2,Ga,i.s2.getCenter(Va).addScaledVector(r,a),Oa.copy(r).negate(),a);h&&h.normal.dot(r)>=e.normal.dot(r)&&e.supplyCollisionPlane(qa.set(h.normal,e.depth)),d&&d.normal.dot(r)>=i.normal.dot(r)&&i.supplyCollisionPlane(qa.set(d.normal,i.depth));break}i.push(e),o.push(e),n.body.collisions.push(e),e.s2.body.collisions.push(e),this.newInContact.add(s)}}}}for(let e=0;e<i.length;e++)i[e].updateMaterialProperties();return i}castRay(e,t,i,s=1){ja.makeEmpty(),ja.expandByPoint(e),ja.expandByPoint(Va.copy(e).addScaledVector(t,i));let n=this.octree.intersectAabb(ja),a=[];for(let r of n){if(0==(r.collisionDetectionMask&s))continue;let n=pa.castRay(r,Ga,e,t,i);n&&a.push(Object.assign(Object.assign({},n),{shape:r}))}return a.sort((e,t)=>e.lambda-t.lambda)}castShape(e,t,i){ja.makeEmpty(),ja.expandByPoint(e.boundingBox.min),ja.expandByPoint(e.boundingBox.max),ja.expandByPoint(Va.copy(e.boundingBox.min).addScaledVector(t,i)),ja.expandByPoint(Va.copy(e.boundingBox.max).addScaledVector(t,i));let s=this.octree.intersectAabb(ja),n=[],a=Oa.copy(t).negate();for(let t of s){if(e===t)continue;if(0==(e.collisionDetectionMask&t.collisionDetectionMask))continue;if(!t.body.enabled)continue;if(t.body.linearVelocity.lengthSq()>0)continue;let s=pa.castRay(e,t,Va.setScalar(0),a,i);s&&n.push(Object.assign(Object.assign({},s),{shape:t}))}return n.sort((e,t)=>e.lambda-t.lambda)}}const Ya=16;class Ka extends jt{parse(){let e=this.readU32(),t=this.readBool(),i=this.readU32(),s=[];for(let e=0;e<i;e++){let e=this.parseInterior();s.push(e)}let n=this.readU32(),a=[];for(let e=0;e<n;e++){let e=this.parseInterior();a.push(e)}return{version:e,previewIncluded:t,detailLevels:s,subObjects:a}}parseInterior(){let e=this.readU32(),t=this.readU32(),i=this.readU32(),s=this.readBox3F(),n=this.readSphereF(),a=this.readBool(),r=this.readU32(),o=this.readU32(),l=[];for(let e=0;e<o;e++)l.push(this.readPoint3F());let h=this.readU32(),d=[];for(let e=0;e<h;e++){let e=this.readU16(),t=this.readF32();d.push({normalIndex:e,planeDistance:t})}let c=this.readU32(),u=[];for(let e=0;e<c;e++)u.push(this.readPoint3F());let m=this.readU32(),p=[];for(let e=0;e<m;e++)p.push(this.readU8());let g=this.readU32(),f=[];for(let e=0;e<g;e++){let e=this.readPlaneF(),t=this.readPlaneF();f.push({planeX:e,planeY:t})}let y=this.readU32(),b=[];for(let e=0;e<y;e++){let e=this.readU16(),t=this.readU16(),i=this.readU16();b.push({planeIndex:e,frontIndex:t,backIndex:i})}let v=this.readU32(),w=[];for(let e=0;e<v;e++){let e=this.readU32(),t=this.readU16();w.push({surfaceIndex:e,surfaceCount:t})}let x={};x.version=this.readU8();let S=this.readU32(),T=[];for(let e=0;e<S;e++)T.push(this.readString());x.materials=T;let M=this.readU32(),k=[];for(let e=0;e<M;e++){let e=this.readU32();k.push(e)}let C=this.readU32(),E=[];for(let e=0;e<C;e++){let e=this.readU32(),t=this.readU32();E.push({windingStart:e,windingCount:t})}let A=this.readU32(),B=[];for(let e=0;e<A;e++){let e=this.readU16(),t=this.readU16(),i=this.readU32(),s=this.readU16(),n=0,a=0,r=this.readU16(),o=0;B.push({portalStart:e,portalCount:t,surfaceStart:i,surfaceCount:s,staticMeshStart:n,staticMeshCount:a,flags:r,zoneId:o})}let P=this.readU32(),I=[];for(let e=0;e<P;e++)I.push(this.readU16());let L=this.readU32(),_=[];for(let e=0;e<L;e++)_.push(this.readU16());let R=this.readU32(),F=[];for(let e=0;e<R;e++){let e=this.readU16(),t=this.readU16(),i=this.readU32(),s=this.readU16(),n=this.readU16();F.push({planeIndex:e,triFanCount:t,triFanStart:i,zoneFront:s,zoneBack:n})}let U=this.readU32(),z=[];for(let e=0;e<U;e++){let e=this.readU32(),t=this.readU8(),i=this.readU16(),s=this.readU16(),n=this.readU32(),a=this.readU8(),r=this.readU32(),o=this.readLightMapTexGen(),l=this.readU16(),h=this.readU32(),d=this.readU8(),c=this.readU8(),u=this.readU8(),m=this.readU8();z.push({windingStart:e,windingCount:t,planeIndex:i,textureIndex:s,texGenIndex:n,surfaceFlags:a,fanMask:r,lightMapTexGen:o,lightCount:l,lightStateInfoStart:h,mapOffsetX:d,mapOffsetY:c,mapSizeX:u,mapSizeY:m})}let D=this.readU32(),V=[];for(let e=0;e<D;e++)V.push(this.readU8());let O=this.readU32(),N=[];for(let e=0;e<O;e++)N.push(this.readU8());let q=this.readU32(),j=[];for(let e=0;e<q;e++){let e=this.readU32(),t=this.readU16(),i=this.readU8(),s=this.readU8();j.push({windingStart:e,planeIndex:t,surfaceFlags:i,windingCount:s})}let G=this.readU32(),W=[];for(let e=0;e<G;e++){let e=this.readPNG();W.push(e)}let H=this.readU32(),X=[];for(let e=0;e<H;e++)X.push(this.readU32());let Y=this.readU32(),K=[];for(let e=0;e<Y;e++){let e=this.readU32(),t=this.readU32(),i=this.readU16(),s=this.readU16(),n=this.readU32();K.push({nameIndex:e,stateIndex:t,stateCount:i,flags:s,duration:n})}let Q=this.readU32(),$=[];for(let e=0;e<Q;e++){let e=this.readU8(),t=this.readU8(),i=this.readU8(),s=this.readU32(),n=this.readU32(),a=this.readU16();$.push({red:e,green:t,blue:i,activeTime:s,dataIndex:n,dataCount:a})}let Z=this.readU32(),J=[];for(let e=0;e<Z;e++){let e=this.readU32(),t=this.readU32(),i=this.readU16();J.push({surfaceIndex:e,mapIndex:t,lightStateIndex:i})}let ee=this.readU32(),te=this.readU32(),ie=[];for(let e=0;e<ee;e++)ie.push(this.readU8());let se=this.readU32(),ne=[];for(let e=0;e<se;e++)ne.push(this.readU8());let ae=this.readU32(),re=[];for(let e=0;e<ae;e++){let e=this.readU32();re.push({soKey:e})}let oe=this.readU32(),le=[];for(let e=0;e<oe;e++){let e=this.readU32(),t=this.readU16(),i=this.readF32(),s=this.readF32(),n=this.readF32(),a=this.readF32(),r=this.readF32(),o=this.readF32(),l=this.readU32(),h=this.readU16(),d=this.readU32(),c=this.readU32(),u=this.readU32(),m=this.readU32(),p=!1;le.push({hullStart:e,hullCount:t,minX:i,maxX:s,minY:n,maxY:a,minZ:r,maxZ:o,surfaceStart:l,surfaceCount:h,planeStart:d,polyListPlaneStart:c,polyListPointStart:u,polyListStringStart:m,staticMesh:p})}let he=this.readU32(),de=[];for(let e=0;e<he;e++)de.push(String.fromCharCode(this.readU8()));let ce=this.readU32(),ue=[];for(let e=0;e<ce;e++)ue.push(this.readU32());let me=this.readU32(),pe=[];for(let e=0;e<me;e++)pe.push(this.readU16());let ge=this.readU32(),fe=[];for(let e=0;e<ge;e++)fe.push(this.readU32());let ye=this.readU32(),be=[];for(let e=0;e<ye;e++)be.push(this.readU32());let ve=this.readU32(),we=[];for(let e=0;e<ve;e++)we.push(this.readU16());let xe=this.readU32(),Se=[];for(let e=0;e<xe;e++)Se.push(this.readU32());let Te=this.readU32(),Me=[];for(let e=0;e<Te;e++)Me.push(String.fromCharCode(this.readU8()));let ke=[];for(let e=0;e<Ya**2;e++){let e=this.readU32(),t=this.readU32();ke.push({binStart:e,binCount:t})}let Ce=this.readU32(),Ee=[];for(let e=0;e<Ce;e++)Ee.push(this.readU16());let Ae=this.readU32(),Be=this.readColorF(),Pe=this.readColorF();this.readU32();o=this.readU32();this.readU32(),this.readU32();return{interiorFileVersion:e,detailLevel:t,minPixels:i,boundingBox:s,boundingSphere:n,hasAlarmState:a,numLightStateEntries:r,normals:l,planes:d,points:u,pointVisibilities:p,texGenEqs:f,bspNodes:b,bspSolidLeaves:w,materialList:x,windings:k,windingIndices:E,edges:[],zones:B,zoneSurfaces:I,zonePortalList:_,portals:F,surfaces:z,normalLMapIndices:V,alarmLMapIndices:N,nullSurfaces:j,lightmaps:W,lightDirMaps:[],lightmapKeep:[],solidLeafSurfaces:X,animatedLights:K,lightStates:$,lightStateData:J,lightStateDataBufferFlags:te,lightStateDataBuffer:ie,nameBuffer:ne,subObjects:re,convexHulls:le,convexHullEmitStrings:de,hullIndices:ue,hullPlaneIndices:pe,hullEmitStringIndices:fe,hullSurfaceIndices:be,polyListPlanes:we,polyListPoints:Se,polyListStrings:Me,coordBins:ke,coordBinIndices:Ee,coordBinMode:Ae,baseAmbientColor:Be,alarmAmbientColor:Pe}}readLightMapTexGen(){return{finalWord:this.readU16(),texGenXDistance:this.readF32(),texGenYDistance:this.readF32()}}readPNG(){let e=this.index;for(this.index;this.index<this.buffer.byteLength;this.index++)if(73===this.view.getUint8(this.index)&&69===this.view.getUint8(this.index+1)&&78===this.view.getUint8(this.index+2)&&68===this.view.getUint8(this.index+3))return this.index+=9,this.buffer.slice(e,this.index);throw new Error("PNG reading failed!")}readColorF(){return{red:this.readU8(),green:this.readU8(),blue:this.readU8(),alpha:this.readU8()}}static async loadFile(e){if(await this.cachedFilePromises.get(e),this.cachedFiles.get(e))return this.cachedFiles.get(e);let t=(async()=>{let t,i=await ne.loadResource(e);if(i){let e=await ne.readBlobAsArrayBuffer(i);t=new Ka(e).parse()}else t=null;return this.cachedFiles.set(e,t),this.cachedFilePromises.delete(e),t})();return this.cachedFilePromises.set(e,t),t}}Ka.cachedFilePromises=new Map,Ka.cachedFiles=new Map;class Qa{constructor(e,t){this.qualifyTime=1/0,this.goldTime=-1/0,this.ultimateTime=-1/0,this.type="custom",this.zipDirectory=null,this.fileToBlobPromises=new Map,this.difCachePromises=new Map,this.difCache=new Map,this.isNew=!1,this.hasEasterEgg=!1,this.hasBlast=!1,this.hasUltraMarble=!1,this.path=e,this.misFile=t,t&&(this.root=t.root,this.initAllElements())}static fromMisFile(e,t){var i,s;let n=new Qa(e,t),a=n.allElements.find(e=>e._type===Jt.ScriptObject&&"MissionInfo"===e._name);return n.missionInfo=a,n.title=a.name,n.artist=null!==(i=a.artist)&&void 0!==i?i:"",n.description=null!==(s=a.desc)&&void 0!==s?s:"",a.time&&"0"!==a.time&&(n.qualifyTime=ci.parseNumber(a.time)),a.goldtime&&(n.goldTime=ci.parseNumber(a.goldtime)),a.platinumtime&&(n.goldTime=ci.parseNumber(a.platinumtime)),a.ultimatetime&&(n.ultimateTime=ci.parseNumber(a.ultimatetime)),n.type=a.type.toLowerCase(),n.modification=e.startsWith("mbp/")?"platinum":e.startsWith("mbu/")?"ultra":"gold",n.hasEasterEgg=n.allElements.some(e=>{var t;return e._type===Jt.Item&&"easteregg"===(null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase())}),n.setUltraFlags(),n}static fromCLAEntry(e,t){var i,s;let n="custom/"+e.id;"platinum"===e.modification&&(n="mbp/"+n),"ultra"===e.modification&&(n="mbu/"+n);let a=new Qa(n);return a.title=e.name.trim(),a.artist=null!==(i=e.artist)&&void 0!==i?i:"",a.description=null!==(s=e.desc)&&void 0!==s?s:"",e.qualifyingTime&&(a.qualifyTime=e.qualifyingTime),e.goldTime&&(a.goldTime=e.goldTime),e.platinumTime&&(a.goldTime=e.platinumTime),e.ultimateTime&&(a.ultimateTime=e.ultimateTime),a.id=e.id,a.isNew=t,a.modification=e.modification,a.hasEasterEgg=e.hasEasterEgg,a}initAllElements(){this.allElements=[];const e=t=>{for(let i of t.elements)this.allElements.push(i),i._type===Jt.SimGroup&&e(i)};e(this.root)}initSearchString(e){this.searchString=P.removeSpecialCharacters(P.normalizeString(this.title+" "+this.artist+" "+(e+1))).toLowerCase().trim()}async load(){if(this.misFile)return;if("custom"!==this.type)return;let e=await ne.loadResource(`./api/custom/${this.id}.zip`),t=await ne.readBlobAsArrayBuffer(e),i=await JSZip.loadAsync(t);this.zipDirectory=i;for(let e in i.files){let t=i.files[e];delete i.files[e],i.files[e.toLowerCase()]=t,i.files[e.toLowerCase().replace("data/","data_mbp/")]=t,"gold"===this.modification&&e.includes("interiors_mbg/")&&(i.files[e.replace("interiors_mbg/","interiors/")]=t)}let s=Object.keys(i.files).find(e=>e.endsWith(".mis")),n=await ne.readBlobAsText(await i.files[s].async("blob"),"ISO-8859-1"),a=new ci(n).parse();this.misFile=a,this.root=a.root,this.initAllElements();let r=this.allElements.find(e=>e._type===Jt.ScriptObject&&"MissionInfo"===e._name);(null===r||void 0===r?void 0:r.time)&&(this.qualifyTime=ci.parseNumber(r.time),this.qualifyTime||(this.qualifyTime=1/0)),(null===r||void 0===r?void 0:r.goldtime)&&(this.goldTime=ci.parseNumber(r.goldtime),(null===r||void 0===r?void 0:r.platinumtime)&&(this.goldTime=ci.parseNumber(r.platinumtime)),this.goldTime||(this.goldTime=-1/0)),(null===r||void 0===r?void 0:r.ultimatetime)&&(this.ultimateTime=ci.parseNumber(r.ultimatetime),this.ultimateTime||(this.ultimateTime=-1/0)),this.missionInfo=r,this.setUltraFlags()}setUltraFlags(){var e,t;ci.parseBoolean(this.missionInfo.noblast)||!ci.parseBoolean(this.missionInfo.blast)&&"ultra"!==(null===(e=this.missionInfo.game)||void 0===e?void 0:e.toLowerCase())||(this.hasBlast=!0),("ultra"===(null===(t=this.missionInfo.game)||void 0===t?void 0:t.toLowerCase())||ci.parseBoolean(this.missionInfo.useultramarble))&&(this.hasUltraMarble=!0)}getDirectoryMissionPath(){return"gold"===this.modification?"missions/"+this.path:"ultra"===this.modification?"missions_mbu/"+this.path.slice(4):"platinum"===this.modification?"missions_mbp/"+this.path.slice(4):void 0}getImagePath(){if("custom"!==this.type){let e=this.getDirectoryMissionPath();"gold"!==t.modification&&(e=e.replace("missions/","missions_mbg/"));let i,s=e.slice(0,-4),n=ne.getFullNamesOf(s,"gold"!==t.modification);for(let e of n)if(!e.endsWith(".mis")){i=e;break}let a=e.slice(0,e.lastIndexOf("/")+1)+i;return"gold"===t.modification?"./assets/data/"+a:"./assets/data_mbp/"+a}return`./api/custom/${this.id}.jpg`}async getDif(e){let t=(e=e.toLowerCase()).slice(e.indexOf("data/"));"gold"===this.modification&&t.includes("interiors_mbg/")&&(t=t.replace("interiors_mbg/","interiors/")),"gold"!==this.modification&&(t=t.replace("data/","data_mbp/"));let i=null;if(await this.difCachePromises.get(t),this.difCache.get(t))i=this.difCache.get(t);else{let e=(async()=>{let e;if(this.zipDirectory&&this.zipDirectory.files[t]){let i=await this.zipDirectory.files[t].async("arraybuffer");e=new Ka(i).parse()}else e=await Ka.loadFile("./assets/"+t);return this.difCache.set(t,e),this.difCachePromises.delete(t),e})();this.difCachePromises.set(t,e),i=await e}return{dif:i,path:t}}async getDts(e){let i=null,s="gold"===t.modification?"data/":"data_mbp/";if(this.zipDirectory&&this.zipDirectory.files["data/"+e]){let t=await this.zipDirectory.files["data/"+e].async("arraybuffer");i=new Xt(t).parse()}else i=await Xt.loadFile("./assets/"+s+e);return i}getFullNamesOf(e){let t=[],i="data/"+(e=e.toLowerCase());if(this.zipDirectory)for(let e in this.zipDirectory.files)if(e.startsWith(i)){if(e.length!==i.length&&i.length!==e.lastIndexOf("."))continue;t.push(e.slice(e.lastIndexOf("/")+1))}return t.push(...ne.getFullNamesOf(e,"gold"!==this.modification)),t}getBlobForFile(e){let t=this.zipDirectory.files[e];if(this.fileToBlobPromises.get(t))return this.fileToBlobPromises.get(t);let i=t.async("blob");return this.fileToBlobPromises.set(t,i),i}async getTexture(e){e=e.toLowerCase();let t="gold"===this.modification?"data/":"data_mbp/";if(this.zipDirectory&&this.zipDirectory.files[t+e]){let i=await this.getBlobForFile(t+e),s=ne.getUrlToBlob(i);return await ne.getTexture(s,"")}return await ne.getTexture(e,"assets/"+t)}async getResource(e){e=e.toLowerCase();let t="gold"===this.modification?"data/":"data_mbp/";if(this.zipDirectory&&this.zipDirectory.files[t+e]){return await this.getBlobForFile(t+e)}return await ne.loadResource("./assets/"+t+e)}async getImage(e){e=e.toLowerCase();let t="gold"===this.modification?"data/":"data_mbp/";if(this.zipDirectory&&this.zipDirectory.files[t+e]){let i=await this.getBlobForFile(t+e),s=ne.getUrlToBlob(i);return await ne.loadImage(s)}return await ne.loadImage("./assets/"+t+e)}matchesSearch(e,t){for(let t=0;t<e.length;t++)if(!this.searchString.includes(e[t]))return!1;return!0}computeAlarmStartTime(){let e=this.qualifyTime;return this.missionInfo.alarmstarttime?e-=1e3*ci.parseNumber(this.missionInfo.alarmstarttime):e-=15e3,e=Math.max(0,e)}}class $a{static async init(){let e=[],t=[],i=[];const s=(e,t,i)=>{for(let n in t)t[n]?s(e,t[n],i+n+"/"):n.endsWith(".mis")&&e.push(i+n)};s(e,ne.dataDirectoryStructure.missions,""),s(t,ne.dataMbpDirectoryStructure.missions_mbp,""),s(i,ne.dataMbpDirectoryStructure.missions_mbu,"");let n=[],a=[],r=[];for(let t of e)n.push(ci.loadFile("./assets/data/missions/"+t));for(let e of t)a.push(ci.loadFile("./assets/data_mbp/missions_mbp/"+e));for(let e of i)r.push(ci.loadFile("./assets/data_mbp/missions_mbu/"+e));let o=ne.loadResource("./assets/customs_gold.json"),l=ne.loadResource("./assets/customs_platinum.json"),h=ne.loadResource("./assets/customs_ultra.json"),d=await Promise.all(n),c=await Promise.all(a),u=await Promise.all(r),m=new Map;for(let t=0;t<e.length;t++)m.set(d[t],e[t]);for(let e=0;e<t.length;e++)m.set(c[e],t[e]);for(let e=0;e<i.length;e++)m.set(u[e],i[e]);let p=[],g=[],f=[];for(let e of d){let t=Qa.fromMisFile(m.get(e),e);p.push(t)}for(let e of c){let t=Qa.fromMisFile("mbp/"+m.get(e),e);g.push(t)}for(let e of u){let t=Qa.fromMisFile("mbu/"+m.get(e),e);f.push(t)}const y=(e,t)=>ci.parseNumber(e.missionInfo.level)-ci.parseNumber(t.missionInfo.level);p.sort(y),g.sort(y),f.sort(y);let b=await ne.readBlobAsJson(await o);b=b.filter(e=>"gold"===e.modification);let v=await ne.readBlobAsJson(await l);v=v.filter(e=>"single"===e.gameType&&(!e.gameMode||"null"===e.gameMode));let w=await ne.readBlobAsJson(await h);w=w.filter(e=>"single"===e.gameType);let x=new Set;for(let e=0;e<v.length;e++){let t=v[e],i=t.name+t.desc;x.has(i)?v.splice(e--,1):x.add(i)}for(let e of[...b,...v,...w]){let t=Qa.fromCLAEntry(e,!1);"gold"===t.modification?p.push(t):"ultra"===t.modification?f.push(t):g.push(t)}for(let e of p){let t=e.type;"beginner"===t?this.goldBeginner.push(e):"intermediate"===t?this.goldIntermediate.push(e):"advanced"===t?this.goldAdvanced.push(e):this.goldCustom.push(e),this.allMissions.push(e)}for(let e of g){let t=e.type;"beginner"===t?this.platinumBeginner.push(e):"intermediate"===t?this.platinumIntermediate.push(e):"advanced"===t?this.platinumAdvanced.push(e):"expert"===t?this.platinumExpert.push(e):this.platinumCustom.push(e),this.allMissions.push(e)}for(let e of f){let t=e.type;"beginner"===t?this.ultraBeginner.push(e):"intermediate"===t?this.ultraIntermediate.push(e):"advanced"===t?this.ultraAdvanced.push(e):this.ultraCustom.push(e),this.allMissions.push(e)}P.swapInArray(this.goldIntermediate,11,12);const S=(e,t)=>P.normalizeString(e.title).localeCompare(P.normalizeString(t.title),void 0,{numeric:!0,sensitivity:"base"});this.goldCustom.sort(S),this.platinumCustom.sort(S),this.ultraCustom.sort(S);for(let e=0;e<this.goldBeginner.length;e++)this.goldBeginner[e].initSearchString(e);for(let e=0;e<this.goldIntermediate.length;e++)this.goldIntermediate[e].initSearchString(e);for(let e=0;e<this.goldAdvanced.length;e++)this.goldAdvanced[e].initSearchString(e);for(let e=0;e<this.goldCustom.length;e++)this.goldCustom[e].initSearchString(e);for(let e=0;e<this.platinumBeginner.length;e++)this.platinumBeginner[e].initSearchString(e);for(let e=0;e<this.platinumIntermediate.length;e++)this.platinumIntermediate[e].initSearchString(e);for(let e=0;e<this.platinumAdvanced.length;e++)this.platinumAdvanced[e].initSearchString(e);for(let e=0;e<this.platinumExpert.length;e++)this.platinumExpert[e].initSearchString(e);for(let e=0;e<this.platinumCustom.length;e++)this.platinumCustom[e].initSearchString(e);for(let e=0;e<this.ultraBeginner.length;e++)this.ultraBeginner[e].initSearchString(e);for(let e=0;e<this.ultraIntermediate.length;e++)this.ultraIntermediate[e].initSearchString(e);for(let e=0;e<this.ultraAdvanced.length;e++)this.ultraAdvanced[e].initSearchString(e);for(let e=0;e<this.ultraCustom.length;e++)this.ultraCustom[e].initSearchString(e);this.allCategories.push(this.goldBeginner,this.goldIntermediate,this.goldAdvanced,this.goldCustom,this.platinumBeginner,this.platinumIntermediate,this.platinumAdvanced,this.platinumExpert,this.platinumCustom,this.ultraBeginner,this.ultraIntermediate,this.ultraAdvanced,this.ultraCustom)}static getModification(e){var t,i;return null!==(i=null===(t=e[0])||void 0===t?void 0:t.modification)&&void 0!==i?i:null}static getDifficulty(e){var t,i;return null!==(i=null===(t=e[0])||void 0===t?void 0:t.type)&&void 0!==i?i:null}}$a.allMissions=[],$a.allCategories=[],$a.goldBeginner=[],$a.goldIntermediate=[],$a.goldAdvanced=[],$a.goldCustom=[],$a.platinumBeginner=[],$a.platinumIntermediate=[],$a.platinumAdvanced=[],$a.platinumExpert=[],$a.platinumCustom=[],$a.ultraBeginner=[],$a.ultraIntermediate=[],$a.ultraAdvanced=[],$a.ultraCustom=[];const Za=120,Ja=1,er={"shapes/images/helicopter.dts":-67,"shapes/items/superjump.dts":-70,"shapes/items/superbounce.dts":-55,"shapes/items/superspeed.dts":-53,"shapes/items/shockabsorber.dts":-53,"shapes/items/megamarble.dts":-70},tr={"shapes/items/megamarble.dts":60},ir=3500,sr=.45,nr=25e3,ar=59999999,rr=["astrolabe.ogg","endurance.ogg","flanked.ogg","grudge.ogg","mbp old shell.ogg","quiet lab.ogg","rising temper.ogg","seaside revisited.ogg","the race.ogg"],or=document.querySelector("#decoy-canvas").getContext("2d"),lr={MarbleBounceEmitter:Di,MarbleTrailEmitter:Ti.MarbleTrailEmitter,MarbleSuperJumpEmitter:Object.assign(xi.cloneOptions(ss),{emitterLifetime:5e3,ambientVelocity:new s(-.3,0,-.5)}),MarbleSuperSpeedEmitter:Object.assign(xi.cloneOptions(bs),{emitterLifetime:5e3,ambientVelocity:new s(-.5,0,-.5)}),LandMineEmitter:Ti.LandMineEmitter,LandMineSmokeEmitter:ps,LandMineSparkEmitter:gs,NukeEmitter:Ti.LandMineEmitter,NukeSmokeEmitter:Os,NukeSparkEmitter:Ns,FireWorkSmokeEmitter:Hi,RedFireWorkSparkEmitter:Ki,RedFireWorkTrailEmitter:Xi,BlueFireWorkSparkEmitter:Qi,BlueFireWorkTrailEmitter:Yi};class hr extends I{constructor(e,t=null){super(),this.interiors=[],this.sharedInteriorData=new Map,this.triggers=[],this.shapes=[],this.sharedShapeData=new Map,this.overlayShapes=[],this.lastPhysicsTick=null,this.lastFrameTime=null,this.offline=!1,this.offlineSettings=null,this.started=!1,this.paused=!0,this.stopped=!1,this.finishTime=null,this.maxDisplayedTime=0,this.pitch=0,this.yaw=0,this.lastVerticalTranslation=new s,this.currentUp=new s(0,0,1),this.orientationChangeTime=-1/0,this.oldOrientationQuat=new i,this.newOrientationQuat=new i,this.previousMouseMovementDistance=0,this.defaultGravity=20,this.currentTimeTravelBonus=0,this.heldPowerUp=null,this.totalGems=0,this.gemCount=0,this.blastAmount=0,this.outOfBounds=!1,this.jumpQueued=!1,this.useQueued=!1,this.blastQueued=!1,this.pressingRestart=!1,this.restartPressTime=null,this.currentCheckpoint=null,this.currentCheckpointTrigger=null,this.checkpointCollectedGems=new Set,this.checkpointHeldPowerUp=null,this.checkpointUp=null,this.checkpointBlast=null,this.mission=e,this.loadingState={loaded:0,total:0},this.offline=!!t,this.offlineSettings=t}async init(){var e;for(let t of this.mission.allElements)[Jt.InteriorInstance,Jt.Item,Jt.PathedInterior,Jt.StaticShape,Jt.TSStatic].includes(t._type)&&(this.loadingState.total++,t._type===Jt.StaticShape&&"endpad"===(null===(e=t.datablock)||void 0===e?void 0:e.toLowerCase())&&(this.endPadElement=t));this.loadingState.total+=17,this.timeState={timeSinceLoad:-1e3/Za,currentAttemptTime:0,gameplayClock:0,physicsTickCompletion:0,tickIndex:0},void 0!==this.mission.misFile.marbleAttributes.gravity&&(this.defaultGravity=ci.parseNumber(this.mission.misFile.marbleAttributes.gravity)),this.offline?(this.audio=new mt,this.audio.init({duration:this.offlineSettings.duration}),this.audio.setAssetPath(ft.assetPath),this.audio.soundGain.gain.value=this.offlineSettings.soundVolume**2,this.audio.musicGain.gain.value=this.offlineSettings.musicVolume**2,this.audio.currentTimeOverride=0):this.audio=ft,this.world=new Xa,await this.initScene(),await this.initMarble(),this.loadingState.loaded+=1,this.particles=new wi(this),await this.particles.init(he),this.scene.particleManager=this.particles;let t=this.initSounds();await this.addSimGroup(this.mission.root),await this.initUi(),this.loadingState.loaded+=3,await t,this.loadingState.loaded+=6,this.scene.compile(),this.loadingState.loaded+=1,this.replay=new dr(this)}async start(){if(!this.stopped){this.started=!0,this.paused=!1,this.restart(!0);for(let e of this.interiors)await e.onLevelStart();for(let e of this.shapes)await e.onLevelStart();this.audio.normalizePositionalAudioVolume(),this.music.play(),ue(!1),this.updateCamera(this.timeState),this.offline||(this.tryRender(),this.tickInterval=setInterval(this.tick.bind(this)),this.lastPhysicsTick=performance.now(),le.classList.remove("hidden"))}}async initScene(){this.scene=new yn(he);let e=!1;for(let t of this.mission.allElements){if(t._type!==Jt.Sun)continue;let i=ci.parseVector4(t.color),n=ci.parseVector4(t.ambient),a=ci.parseVector3(t.direction);this.scene.addAmbientLight(new bn(new s(n.x,n.y,n.z)));let r=new vn(he,new s(i.x,i.y,i.z),a.clone());if(this.scene.addDirectionalLight(r),!e){e=!0;let t=new Ai(-1,1,1,-1,0,10);r.enableShadowCasting(256,t)}}let t=this.mission.allElements.find(e=>e._type===Jt.Sky),i=ci.parseVector4(t.fogcolor),n=ci.parseVector4(t.skysolidcolor);if(.6===n.x&&.6===n.y&&.6===n.z||(i=n),i.x>1&&(i.x=1-(i.x-1)%256/256),i.y>1&&(i.y=1-(i.y-1)%256/256),i.z>1&&(i.z=1-(i.z-1)%256/256),he.setClearColor(i.x,i.y,i.z,1),this.camera=new Ei(K.data.settings.fov,window.innerWidth/window.innerHeight,.01,ci.parseNumber(t.visibledistance)),"1"===t.useskytextures){let e=await this.createSkyboxCubeTexture(t.materiallist.slice(t.materiallist.indexOf("data/")+"data/".length),!0);if(e){let t=new xt;t.isSky=!0,t.envMap=e,t.depthWrite=!1,t.renderOrder=-1e3;let i=new yt;i.positions.push(-1,-1,0),i.positions.push(3,-1,0),i.positions.push(-1,3,0),i.materials.push(0,0,0),i.indices.push(0,1,2),i.fillRest();let s=new wt(i,[t]);this.scene.add(s)}}let a=await this.createSkyboxCubeTexture("skies/sky_day.dml",!1,128);this.envMap=a}async createSkyboxCubeTexture(e,t,i){let s=e.slice(0,e.lastIndexOf("/")),n=await this.mission.getResource(e);if(n){let e=(await ne.readBlobAsText(n)).split("\n").map(e=>e.trim().toLowerCase()),a=[];for(let i=0;i<6;i++){let n=e[i],r=this.mission.getFullNamesOf(s+"/"+n)[0];if(r){let e=await this.mission.getImage(s+"/"+r);a.push(e)}else a.push(new Image);t&&this.loadingState.loaded++}return a=P.remapIndices(a,[1,3,4,5,0,2]),i&&(a=await Promise.all(a.map(e=>P.downsampleImage(e,i,i)))),new Mi(he,a)}return t&&(this.loadingState.loaded+=6),null}async initMarble(){this.marble=new Ni(this),await this.marble.init(),this.scene.add(this.marble.group),this.world.add(this.marble.body)}async initUi(){await t.menu.hud.load();let e=new Set;for(let t of this.shapes)if(t instanceof ts||t instanceof Ji){if(t instanceof ts&&t.autoUse)continue;if(t instanceof Ys)for(let i of t.getAllDtsPaths())e.add(i);else e.add(t.dtsPath)}this.overlayScene=new yn(he);let i=new bn((new s).setScalar(1));this.overlayScene.addAmbientLight(i),this.overlayCamera=new Ai(-window.innerWidth/2,window.innerWidth/2,-window.innerHeight/2,window.innerHeight/2,1,1e3),this.overlayCamera.up.set(0,0,-1),this.overlayCamera.lookAt(new s(1,0,0));for(let i of e){let e=new ei;e.dtsPath=i,e.ambientRotate=!0,e.showSequences=!1,i.includes("gem")&&t.menu.hud instanceof dn&&(e.matNamesOverride["base.gem"]=Ji.pickRandomColor()+".gem"),await e.init(),this.overlayShapes.push(e),this.overlayScene.add(e.group),i.includes("gem")?e.ambientSpinFactor/=-2:(e.ambientSpinFactor/=2,e.setOpacity(0))}this.overlayScene.compile(),t.menu.pauseScreen instanceof Qs&&t.menu.pauseScreen.jukebox.reset()}async initSounds(){let e;if("ultra"===this.mission.modification)e="tim trance.ogg",this.originalMusicName=e;else if("gold"!==t.modification&&this.mission.missionInfo.music&&"pianoforte.ogg"!==this.mission.missionInfo.music.toLowerCase())e=this.mission.missionInfo.music.toLowerCase(),this.originalMusicName=e;else if("gold"===this.mission.modification){let t=$a.allCategories.find(e=>e.includes(this.mission)).indexOf(this.mission);e=["groovepolice.ogg","classic vibe.ogg","beach party.ogg"][(t+1)%3],this.originalMusicName=["groove police.ogg","classic vibe.ogg","beach party.ogg"][(t+1)%3]}else e=P.randomFromArray(rr),this.originalMusicName=e;"platinum"===t.modification&&(e="music/"+e);let i=["spawn.wav","ready.wav","set.wav","go.wav","whoosh.wav",e];isFinite(this.mission.qualifyTime)&&"platinum"===t.modification&&i.push("alarm.wav","alarm_timeout.wav","infotutorial.wav");try{await this.audio.loadBuffers(i)}catch(t){let s=P.randomFromArray(rr);this.originalMusicName=s,i[i.indexOf(e)]="music/"+s,e="music/"+s,await this.audio.loadBuffers(i)}this.music=this.audio.createAudioSource(e,this.audio.musicGain),this.music.setLoop(!0),await this.music.promise}async addSimGroup(e){if(e.elements.find(e=>e._type===Jt.PathedInterior)){let t=await Ps.createFromSimGroup(e,this);if(!t)return;this.scene.add(t.mesh),t.hasCollision&&this.world.add(t.body);for(let e of t.triggers)this.world.add(e.body),this.triggers.push(e);return}let t=[];for(let i of e.elements)switch(i._type){case Jt.SimGroup:t.push(this.addSimGroup(i));break;case Jt.InteriorInstance:t.push(this.addInterior(i));break;case Jt.StaticShape:case Jt.Item:t.push(this.addShape(i));break;case Jt.Trigger:t.push(this.addTrigger(i));break;case Jt.TSStatic:t.push(this.addTSStatic(i));break;case Jt.ParticleEmitterNode:this.addParticleEmitterNode(i)}await Promise.all(t)}async addInterior(e){let{dif:t,path:i}=await this.mission.getDif(e.interiorfile);if(!t)return;let s=new qt(t,i,this);this.interiors.push(s),await P.wait(10),await s.init(e._id),this.scene.add(s.mesh);let n=ci.parseVector3(e.position),a=ci.parseRotation(e.rotation),r=ci.parseVector3(e.scale),o=0!==r.x&&0!==r.y&&0!==r.z;0===r.x&&(r.x=1e-4),0===r.y&&(r.y=1e-4),0===r.z&&(r.z=1e-4),s.setTransform(n,a,r),o&&this.world.add(s.body)}async addShape(e){var t;let i,s=null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase();if(s&&("startpad"===s?i=new qi:"endpad"===s?i=new Wi(e===this.endPadElement):"signfinish"===s?i=new ji:s.startsWith("signplain")?i=new Gi(e):s.startsWith("gemitem")?(i=new Ji(e),this.totalGems++):"superjumpitem"===s?i=new is(e):s.startsWith("signcaution")?i=new ns(e):"superbounceitem"===s?i=new as(e):"roundbumper"===s?i=new os:"trianglebumper"===s?i=new Ts:"helicopteritem"===s?i=new ls(e):"ductfan"===s?i=new ds:"smallductfan"===s?i=new ks:"antigravityitem"===s?i=new cs(e):"norespawnantigravityitem"===s?i=new cs(e,!0):"landmine"===s?i=new us:"shockabsorberitem"===s?i=new fs(e):"superspeeditem"===s?i=new ys(e):["timetravelitem","timepenaltyitem"].includes(s)?i=new vs(e):"tornado"===s?i=new ws:"trapdoor"===s?i=new Ss(e):"oilslick"===s?i=new Ms:"pushbutton"===s?i=new Fs:s.startsWith("sign")||"arrow"===s?i=new Us(e):"magnet"===s?i=new zs:"nuke"===s?i=new Ds:"checkpoint"===s?i=new Gs:"easteregg"===s?i=new Hs(e):"randompowerupitem"===s?i=new Ys(e):["clear","cloudy","dusk","wintry"].includes(s)?i=new cn(s):/glass_\d+shape/.test(s)?i=new un(s):"blastitem"===s?i=new mn(e):"megamarbleitem"===s&&(i=new pn(e))),!i)return;this.shapes.push(i),await P.wait(10),await i.init(this,e);let n=ci.parseVector3(e.position),a=ci.parseRotation(e.rotation),r=ci.parseVector3(e.scale);0===r.x&&(r.x=1e-4),0===r.y&&(r.y=1e-4),0===r.z&&(r.z=1e-4),i.setTransform(n,a,r),this.scene.add(i.group);for(let e of i.bodies)this.world.add(e);for(let e of i.colliders)this.world.add(e.body)}async addTrigger(e){var t;let i,s=null===(t=e.datablock)||void 0===t?void 0:t.toLowerCase();"outofboundstrigger"===s?i=new _s(e,this):"inboundstrigger"===s?i=new Is(e,this):"helptrigger"===s?i=new Ls(e,this):"teleporttrigger"===s?i=new js(e,this):"destinationtrigger"===s?i=new qs(e,this):"checkpointtrigger"===s&&(i=new Ws(e,this)),i&&(this.triggers.push(i),this.world.add(i.body),await i.init())}async addTSStatic(e){let t=new ei,i=e.shapename.toLowerCase(),s=i.indexOf("data/");if(-1!==s){t.dtsPath=i.slice(s+"data/".length),t.isTSStatic=!0,t.shareId=1,i.includes("colmesh")&&(t.receiveShadows=!1),this.shapes.push(t),await P.wait(10);try{await t.init(this,e)}catch(e){return console.error("Error in creating TSStatic, skipping it for now.",e),void P.removeFromArray(this.shapes,t)}if(t.setTransform(ci.parseVector3(e.position),ci.parseRotation(e.rotation),ci.parseVector3(e.scale)),this.scene.add(t.group),0!==t.worldScale.x&&0!==t.worldScale.y&&0!==t.worldScale.z){for(let e of t.bodies)this.world.add(e);for(let e of t.colliders)this.world.add(e.body)}}}addParticleEmitterNode(e){let t=lr[e.emitter];t&&this.particles.createEmitter(t,ci.parseVector3(e.position))}restart(e){var s,n;if(!e&&this.currentCheckpoint&&"playback"!==this.replay.mode)return void this.loadCheckpointState();let a=t.menu.hud;a.setPowerupButtonState(!1,!0),this.timeState.gameplayClock=0,this.replay&&this.replay.version<=4?(this.timeState.currentAttemptTime=0,this.timeState.tickIndex=0):(this.timeState.currentAttemptTime=-1e3/Za,this.timeState.tickIndex=-1),this.currentTimeTravelBonus=0,this.outOfBounds=!1,this.lastPhysicsTick=null,this.maxDisplayedTime=0,this.blastAmount=0,this.gemCount=0,this.currentCheckpoint=null,this.currentCheckpointTrigger=null,this.checkpointCollectedGems.clear(),this.checkpointHeldPowerUp=null,this.checkpointUp=null,this.checkpointBlast=null,this.restartPressTime=null,this.finishTime=null;let{position:r,euler:o}=this.getStartPositionAndOrientation();this.marble.body.position.set(r.x,r.y,r.z+3),this.marble.body.syncShapes(),this.marble.group.position.copy(this.marble.body.position),this.marble.group.recomputeTransform(),this.marble.reset(),this.marble.calculatePredictiveTransforms(),this.yaw=o.z+Math.PI/2,this.pitch=sr;let l=this.mission.missionInfo;l.starthelptext&&t.menu.hud.displayHelp(l.starthelptext);for(let e of this.shapes)e.reset();for(let e of this.interiors)e.reset();for(let e of this.triggers)e.reset();this.currentUp.set(0,0,1),this.orientationChangeTime=-1/0,this.oldOrientationQuat=new i,this.newOrientationQuat=new i,this.setGravityIntensity(this.defaultGravity),this.deselectPowerUp(),a.setCenterText("none"),ot(),lt("playback"===this.replay.mode?"replay":"normal"),null===(s=this.timeTravelSound)||void 0===s||s.stop(),this.timeTravelSound=null,null===(n=this.alarmSound)||void 0===n||n.stop(),this.alarmSound=null,this.replay.init(),this.audio.play("spawn.wav"),this.clearSchedule(),this.schedule(500,()=>{a.setCenterText("ready"),this.audio.play("ready.wav")}),this.schedule(2e3,()=>{a.setCenterText("set"),this.audio.play("set.wav")}),this.schedule(ir,()=>{a.setCenterText("go"),this.audio.play("go.wav")}),this.schedule(5500,()=>{this.outOfBounds||a.setCenterText("none")})}tryRender(){if(this.stopped)return;requestAnimationFrame(this.tryRender.bind(this));let e=performance.now();if(null===this.lastFrameTime)this.lastFrameTime=e;else{let t=an[K.data.settings.frameRateCap];isFinite(t)&&or.clearRect(0,0,1,1);let i=1e3/t;if(e-this.lastFrameTime<i)return;this.lastFrameTime+=i,this.lastFrameTime=Math.max(this.lastFrameTime,e-2*i)}this.render(e)}render(e){var i,s;if(this.stopped)return;if(this.tick(e),this.stopped)return;let n=1e3/Za,a=P.clamp((e-this.lastPhysicsTick)/n*Ja,0,1),r={timeSinceLoad:this.timeState.timeSinceLoad+a*n,currentAttemptTime:this.timeState.currentAttemptTime+a*n,gameplayClock:this.currentTimeTravelBonus||this.timeState.currentAttemptTime<ir?this.timeState.gameplayClock:this.timeState.gameplayClock+a*n,physicsTickCompletion:a,tickIndex:this.timeState.tickIndex+a};this.marble.render(r);for(let e of this.interiors)e.render(r);for(let e of this.shapes)e.render(r);this.particles.render(r.timeSinceLoad),this.updateCamera(r),this.camera.updateMatrixWorld(),null===(i=this.scene.directionalLights[0])||void 0===i||i.updateCamera(this.marble.group.position.clone(),-1),this.scene.prepareForRender(this.camera),this.marble.renderReflection(),he.render(this.scene,this.camera);for(let e of this.overlayShapes)e.group.position.x=500,e.render(this.timeState),e.dtsPath.includes("gem")?(e.group.scale.setScalar(45/de),e.group.position.y=25/de,e.group.position.z=-35/de):(e.group.scale.setScalar((null!==(s=tr[e.dtsPath])&&void 0!==s?s:40)/de),e.group.position.y=this.overlayCamera.right-55/de,e.group.position.z=er[e.dtsPath]/de),e.group.recomputeTransform();this.overlayCamera.updateMatrixWorld(),this.overlayScene.prepareForRender(this.overlayCamera),he.render(this.overlayScene,this.overlayCamera,null,!1);let o=t.menu.hud;o.renderHud(r),o.displayFps()}updateCamera(e){let t=this.marble.group.position,n=this.getOrientationQuat(e),a=new s(0,0,1).applyQuaternion(n),r=new s(1,0,0),o=new s(0,0,.3);if("playback"===this.replay.mode){let t=Math.max(0,this.replay.currentTickIndex-1),i=this.replay.currentTickIndex;this.pitch=P.lerp(this.replay.cameraOrientations[t].pitch,this.replay.cameraOrientations[i].pitch,e.physicsTickCompletion),this.pitch=Math.max(-Math.PI/2+Math.PI/4,Math.min(Math.PI/2-1e-4,this.pitch)),this.yaw=P.lerp(this.replay.cameraOrientations[t].yaw,this.replay.cameraOrientations[i].yaw,e.physicsTickCompletion)}if(this.finishTime&&(this.pitch=P.lerp(this.finishPitch,sr,P.clamp((e.currentAttemptTime-this.finishTime.currentAttemptTime)/333,0,1)),this.yaw=this.finishYaw-(e.currentAttemptTime-this.finishTime.currentAttemptTime)/1e3*.6),this.outOfBounds)this.camera.position.copy(this.oobCameraPosition),this.camera.position.sub(this.lastVerticalTranslation),this.camera.lookAt(t),this.camera.position.add(this.lastVerticalTranslation);else{r.applyAxisAngle(new s(0,1,0),this.pitch),r.applyAxisAngle(new s(0,0,1),this.yaw),r.applyQuaternion(n),o.applyAxisAngle(new s(0,1,0),this.pitch),o.applyAxisAngle(new s(0,0,1),this.yaw),o.applyQuaternion(n),this.camera.up=a,this.camera.position.copy(t).sub(r.clone().multiplyScalar(2.5)),this.camera.lookAt(t),this.camera.position.add(o);const e=.1;let l=t,h=new Set;for(let n=0;n<3;n++){let n=this.camera.position.clone().sub(l);n.addScaledVector(n.clone().normalize(),2);let a=n.length(),r=this.world.castRay(l,n.normalize(),a).find(e=>e.shape!==this.marble.shape&&!h.has(e.shape));if(!r)break;{h.add(r.shape);let n=new Pt,a=r.normal,o=r.point;n.setFromNormalAndCoplanarPoint(a,o);let l=new s,d=n.projectPoint(this.camera.position,l);if(n.distanceToPoint(this.camera.position)>=e)break;this.camera.position.copy(d).addScaledVector(a,e),P.cameraLookAtDirect(this.camera,t);let c=new s(1,0,0);c.applyQuaternion(this.camera.orientation);let u=Math.atan(.12),m=(new i).setFromAxisAngle(c,u);this.camera.orientation.premultiply(m)}}this.lastVerticalTranslation=o}}tick(e){var i,s;if(this.stopped)return;if(this.paused)return;void 0===e&&(e=performance.now());let n="playback"===this.replay.mode;if(!n&&!t.menu.finishScreen.showing&&(Te("use")||this.useQueued)&&Ce("use")&&this.outOfBounds&&!this.finishTime)return void this.restart(!1);t.menu.finishScreen.handleGamepadInput(),Te("pause")&&Ce("pause")&&(Ee("pause"),Ee("jump"),Ee("use"),Ee("restart"),this.pause());let a=!1;null===this.lastPhysicsTick&&(this.lastPhysicsTick=e-1e3/Za/Ja,a=!0);let r=e-this.lastPhysicsTick;(r*=Ja)>=1e3&&(r=1e3,this.lastPhysicsTick=e-1e3);let o=!1;for(;r>=1e3/Za||a;){let e=this.timeState.gameplayClock;this.timeState.currentAttemptTime>=ir&&(this.currentTimeTravelBonus>0?(this.currentTimeTravelBonus-=1e3/Za,this.timeTravelSound||(this.timeTravelSound=this.audio.createAudioSource("timetravelactive.wav"),this.timeTravelSound.setLoop(!0),this.timeTravelSound.play())):(this.timeState.gameplayClock+=1e3/Za,null===(i=this.timeTravelSound)||void 0===i||i.stop(),this.timeTravelSound=null),this.currentTimeTravelBonus<0&&(this.timeState.gameplayClock+=-this.currentTimeTravelBonus,this.currentTimeTravelBonus=0)),this.timeState.timeSinceLoad+=1e3/Za,this.timeState.currentAttemptTime+=1e3/Za,this.timeState.tickIndex++,this.lastPhysicsTick+=1e3/Za/Ja,r-=1e3/Za,a=!1,this.tickSchedule(this.timeState.currentAttemptTime),this.offline&&(this.audio.currentTimeOverride=this.timeState.currentAttemptTime/1e3),this.mission.hasBlast&&this.blastAmount<1&&(this.blastAmount=P.clamp(this.blastAmount+1e3/nr/Za,0,1));for(let e of this.interiors)e.tick(this.timeState);for(let e of this.triggers)e.tick(this.timeState);for(let e of this.shapes)e.isTSStatic||e.tick(this.timeState);if(this.marble.tick(this.timeState),!n){let e=this.world.gravity.clone();this.finishTime&&this.world.gravity.setScalar(0),this.world.step(1/Za),this.world.gravity.copy(e)}this.jumpQueued=!1,this.useQueued=!1,this.blastQueued=!1;let l=0,h=0,d=K.data.settings.alwaysFreeLook||Te("freeLook"),c=P.lerp(1,6,K.data.settings.keyboardSensitivity);if(Te("cameraLeft")&&(l+=c),Te("cameraRight")&&(l-=c),Te("cameraUp")&&(h-=c),Te("cameraDown")&&(h+=c),l-=Be.cameraX*P.lerp(.5,10,K.data.settings.mouseSensitivity),d&&(h+=Be.cameraY*P.lerp(.5,10,K.data.settings.mouseSensitivity)),this.yaw+=l/Za,this.pitch+=h/Za,this.particles.tick(),o=!0,this.timeState.currentAttemptTime>=ir&&isFinite(this.mission.qualifyTime)&&"platinum"===t.modification&&!this.finishTime){let i=this.mission.computeAlarmStartTime();e<=i&&this.timeState.gameplayClock>=i&&!this.alarmSound&&(this.alarmSound=this.audio.createAudioSource("alarm.wav"),this.alarmSound.setLoop(!0),this.alarmSound.play(),t.menu.hud.displayHelp(`You have ${(this.mission.qualifyTime-i)/1e3} seconds remaining.`,!0)),e<this.mission.qualifyTime&&this.timeState.gameplayClock>=this.mission.qualifyTime&&(null===(s=this.alarmSound)||void 0===s||s.stop(),this.alarmSound=null,t.menu.hud.displayHelp("The clock has passed the Par Time.",!0),this.audio.play("alarm_timeout.wav"))}if(n){if(this.replay.playBack(),this.replay.isPlaybackComplete())return void this.stopAndExit()}else this.replay.record()}this.audio.updatePositionalAudio(this.timeState,this.camera.position,this.yaw),this.pitch=Math.max(-Math.PI/2+Math.PI/4,Math.min(Math.PI/2-1e-4,this.pitch)),o&&this.marble.calculatePredictiveTransforms(),this.finishTime||!Te("restart")||this.pressingRestart?Te("restart")||(this.pressingRestart=!1):(this.restart(!1),this.currentCheckpoint&&(this.restartPressTime=performance.now()),this.pressingRestart=!0),!this.finishTime&&Te("restart")&&null!==this.restartPressTime&&null!==this.restartPressTime&&performance.now()-this.restartPressTime>=1e3&&this.restart(!0)}getOrientationQuat(e){let t=P.clamp((e.currentAttemptTime-this.orientationChangeTime)/300,0,1);return this.oldOrientationQuat.clone().slerp(this.newOrientationQuat,t).normalize()}setUp(e,t=!1){let n=this.timeState;e.normalize(),this.currentUp.copy(e);let a=this.world.gravity.length();this.world.gravity.copy(e).multiplyScalar(-1*a);let r=this.getOrientationQuat(n),o=new s(0,0,1);o.applyQuaternion(r).normalize();let l=new i;if(e.dot(o)<=-(1-1e-15)&&!(this.replay.version<3)){let t=new s(0,0,1).applyQuaternion(this.camera.orientation),n=o.clone().cross(t).normalize();l.setFromUnitVectors(o,n),l.premultiply((new i).setFromUnitVectors(n,e))}else l.setFromUnitVectors(o,e);this.newOrientationQuat=l.multiply(r).normalize(),this.oldOrientationQuat=r,this.orientationChangeTime=t?-1/0:n.currentAttemptTime}getStartPositionAndOrientation(){let e,t=P.findLast(this.shapes,e=>e instanceof qi),i=new Li;if(t)e=t.worldPosition,i.setFromQuaternion(t.worldOrientation,"ZXY");else{let t=this.mission.allElements.find(e=>"SpawnPoints"===e._name);if(t){let i=t.elements[0];e=ci.parseVector3(i.position)}else e=new s(0,0,300)}return{position:e,euler:i}}setGravityIntensity(e){let t=this.currentUp.clone().multiplyScalar(-1*e);this.world.gravity.copy(t)}onResize(e,i,s){this.camera&&this.overlayCamera&&(this.camera.aspect=e/i,this.camera.updateProjectionMatrix(),this.overlayCamera.left=0,this.overlayCamera.right=e,this.overlayCamera.top=0,this.overlayCamera.bottom=i,this.overlayCamera.updateProjectionMatrix(),t.menu.hud.setSize(e,i,s))}onMouseMove(e){if(!this.started||!document.pointerLockElement||this.finishTime||this.paused||"playback"===this.replay.mode)return;let t=Math.hypot(e.movementX,e.movementY);if(t>350&&4*this.previousMouseMovementDistance<t)return void(this.previousMouseMovementDistance*=1.5);this.previousMouseMovementDistance=t;let i=P.lerp(4e-4,.01,K.data.settings.mouseSensitivity),s=1&K.data.settings.invertMouse?-1:1,n=2&K.data.settings.invertMouse?-1:1;(K.data.settings.alwaysFreeLook||Te("freeLook"))&&(this.pitch+=e.movementY*i*n),this.yaw-=e.movementX*i*s}pickUpPowerUp(e,i=!0){if(!e)return!1;if(this.heldPowerUp&&e.constructor===this.heldPowerUp.constructor)return!1;this.heldPowerUp=e,t.menu.hud.setPowerupButtonState(!0);for(let t of this.overlayShapes)t.dtsPath.includes("gem")||t.setOpacity(Number(t.dtsPath===e.dtsPath));return i&&this.audio.play(e.sounds[0]),!0}deselectPowerUp(){if(this.heldPowerUp){this.heldPowerUp=null,t.menu.hud.setPowerupButtonState(!1);for(let e of this.overlayShapes)e.dtsPath.includes("gem")||e.setOpacity(0)}else t.menu.hud.setPowerupButtonState(!1)}pickUpGem(e){let i;this.gemCount++;let s="gold"===t.modification?"gem":"diamond";if(this.gemCount===this.totalGems)i=`You have all the ${s}s, head for the finish!`,this.audio.play("gotallgems.wav"),this.mission.misFile.activatedPackages.includes("endWithTheGems")&&this.touchFinish(e);else{i=`You picked up a ${s}${"gold"===t.modification?".":"!"}  `;let e=this.totalGems-this.gemCount;i+=1===e?`Only one ${s} to go!`:`${e} ${s}s to go!`,this.audio.play("gotgem.wav")}t.menu.hud.displayAlert(i)}addTimeTravelBonus(e,t){0===this.currentTimeTravelBonus&&(this.timeState.gameplayClock-=t,this.timeState.gameplayClock<0&&(this.timeState.gameplayClock=0),e-=t),this.currentTimeTravelBonus+=e}goOutOfBounds(){this.outOfBounds||this.finishTime||(t.menu.hud.setPowerupButtonState(!0),this.updateCamera(this.timeState),this.outOfBounds=!0,this.outOfBoundsTime=P.jsonClone(this.timeState),this.oobCameraPosition=this.camera.position.clone(),t.menu.hud.setCenterText("outofbounds"),this.audio.play("whoosh.wav"),"playback"!==this.replay.mode&&this.schedule(this.timeState.currentAttemptTime+2e3,()=>this.restart(!1),"oobRestart"))}saveCheckpointState(e,i){var s,n;if(this.currentCheckpoint===e)return;if(null===(s=this.currentCheckpoint)||void 0===s?void 0:s.worldPosition.equals(e.worldPosition))return;let a=(null===(n=e.srcElement)||void 0===n?void 0:n.disableOob)||(null===i||void 0===i?void 0:i.element.disableOob);if(!ci.parseBoolean(a)||!this.outOfBounds){this.currentCheckpoint=e,this.currentCheckpointTrigger=i,this.checkpointCollectedGems.clear(),this.checkpointUp=this.currentUp.clone(),this.checkpointBlast=this.blastAmount;for(let e of this.shapes)e instanceof Ji&&e.pickedUp&&this.checkpointCollectedGems.add(e);this.checkpointHeldPowerUp=this.heldPowerUp,t.menu.hud.displayAlert("Checkpoint reached!"),this.audio.play("checkpoint.wav")}}loadCheckpointState(){var e,i,n,a,r,o;if(!this.currentCheckpoint)return;let l=this.marble,h=(null===(e=this.currentCheckpoint.srcElement)||void 0===e?void 0:e.gravity)||(null===(i=this.currentCheckpointTrigger)||void 0===i?void 0:i.element.gravity);if(ci.parseBoolean(h)||"ultra"===this.mission.modification){let e=new s(0,0,1);e.applyQuaternion(this.currentCheckpoint.worldOrientation),this.setUp(e,!0)}else this.setUp(this.checkpointUp,!0);let d=new s,c=(null===(n=this.currentCheckpoint.srcElement)||void 0===n?void 0:n.add)||(null===(a=this.currentCheckpointTrigger)||void 0===a?void 0:a.element.add);c&&d.add(ci.parseVector3(c));let u=(null===(r=this.currentCheckpoint.srcElement)||void 0===r?void 0:r.sub)||(null===(o=this.currentCheckpointTrigger)||void 0===o?void 0:o.element.sub);u&&d.sub(ci.parseVector3(u)),c||u||(d.z=3,"ultra"===this.mission.modification&&d.applyQuaternion(this.currentCheckpoint.worldOrientation)),l.body.position.copy(this.currentCheckpoint.worldPosition).add(d),l.body.linearVelocity.setScalar(0),l.body.angularVelocity.setScalar(0),l.calculatePredictiveTransforms();let m=new Li;m.setFromQuaternion(this.currentCheckpoint.worldOrientation,"ZXY"),this.yaw=m.z+Math.PI/2,this.pitch=sr;for(let e of this.shapes)e instanceof Ji&&e.pickedUp&&!this.checkpointCollectedGems.has(e)&&(e.reset(),this.gemCount--);t.menu.hud.setCenterText("none"),l.superBounceEnableTime=-1/0,l.shockAbsorberEnableTime=-1/0,l.helicopterEnableTime=-1/0,l.megaMarbleEnableTime=-1/0,this.clearSchedule(),this.outOfBounds=!1,this.blastAmount=this.checkpointBlast,this.finishTime=null,this.deselectPowerUp(),this.checkpointHeldPowerUp&&this.schedule(this.timeState.currentAttemptTime+500,()=>this.pickUpPowerUp(this.checkpointHeldPowerUp,!1)),this.audio.play("spawn.wav"),this.replay.recordCheckpointRespawn()}touchFinish(e){var i;if(null===this.finishTime)if(this.replay.recordTouchFinish(),this.gemCount<this.totalGems)this.audio.play("missinggems.wav"),t.menu.hud.displayAlert("gold"===t.modification?"You can't finish without all the gems!!":"You may not finish without all the diamonds!");else{void 0===e&&(e=1);let s=1e3*(1-e)/Za;this.finishTime=P.jsonClone(this.timeState),this.finishTime.timeSinceLoad-=s,this.finishTime.currentAttemptTime-=s,0===this.currentTimeTravelBonus&&(this.finishTime.gameplayClock-=s),this.finishTime.gameplayClock=P.clamp(this.finishTime.gameplayClock,0,ar),this.finishTime.physicsTickCompletion=e,this.currentTimeTravelBonus=0,null===(i=this.alarmSound)||void 0===i||i.stop(),"playback"===this.replay.mode&&(this.finishTime=this.replay.finishTime),this.finishYaw=this.yaw,this.finishPitch=this.pitch;let n=P.findLast(this.shapes,e=>e instanceof Wi);if(null===n||void 0===n||n.spawnFirework(this.timeState),t.menu.hud.displayAlert("Congratulations! You've finished!"),this.outOfBounds&&this.timeState.currentAttemptTime-this.outOfBoundsTime.currentAttemptTime>=500)return;this.clearScheduleId("oobRestart"),"playback"!==this.replay.mode&&this.schedule(this.timeState.currentAttemptTime+2e3,()=>{var e;null===(e=document.exitPointerLock)||void 0===e||e.call(document),t.menu.finishScreen.show(),rt(),Ee("use"),Ee("jump"),Ee("restart")})}}pause(){var e;this.paused||t.level.finishTime&&"record"===t.level.replay.mode||(this.paused=!0,null===(e=document.exitPointerLock)||void 0===e||e.call(document),Ae(),t.menu.pauseScreen.show(),rt())}unpause(){this.paused=!1,P.isTouchDevice||P.requestPointerLock(),t.menu.pauseScreen.hide(),this.lastPhysicsTick=performance.now(),ot()}stop(){var e,t,i,s,n,a,r;this.stopped=!0,clearInterval(this.tickInterval),this.dispose(),pa.clearReferences(),this.music.stop();for(let t of this.interiors)t instanceof Ps&&(null===(e=t.soundSource)||void 0===e||e.stop());for(let e of this.shapes)(e instanceof ws||e instanceof ds)&&(null===(t=e.soundSource)||void 0===t||t.stop());null===(i=this.marble.rollingSound)||void 0===i||i.stop(),null===(s=this.marble.slidingSound)||void 0===s||s.stop(),null===(n=this.marble.helicopterSound)||void 0===n||n.stop(),null===(a=this.marble.shockAbsorberSound)||void 0===a||a.stop(),null===(r=this.marble.superBounceSound)||void 0===r||r.stop(),this.audio.stopAllAudio()}stopAndExit(){var e;this.stop(),t.level=null,le.classList.add("hidden"),t.menu.pauseScreen.hide(),t.menu.levelSelect.show(),t.menu.levelSelect.displayBestTimes(),t.menu.finishScreen.hide(),t.menu.hideGameUi(),t.menu.show(),null===(e=document.exitPointerLock)||void 0===e||e.call(document)}getLoadingCompletion(){return this.loadingState.total?this.loadingState.loaded/this.loadingState.total:0}dispose(){this.scene.dispose(),this.marble.dispose(),he.cleanUp()}}class dr{constructor(e){this.version=5,this.mode="record",this.canStore=!0,this.isInvalid=!1,this.marblePositions=[],this.marbleOrientations=[],this.marbleLinearVelocities=[],this.marbleAngularVelocities=[],this.marbleInside=[],this.marbleEnter=[],this.marbleLeave=[],this.marbleContact=[],this.uses=[],this.blasts=[],this.cameraOrientations=[],this.timeTravelTimeToRevert=new Map,this.touchFinishTickIndices=[],this.finishTime=null,this.trapdoorStartValues=[],this.landmineStartValues=[],this.pushButtonStartValues=[],this.nukeStartValues=[],this.rollingSoundGain=[],this.rollingSoundPlaybackRate=[],this.slidingSoundGain=[],this.jumpSoundTimes=[],this.bounceTimes=[],this.randomPowerUpChoices=new Map,this.checkpointRespawns=[],this.currentJumpSoundTime=0,this.currentBounceTime=0,e&&(this.level=e,this.missionPath=e.mission.path)}get currentTickIndex(){return Math.max(this.level.timeState.tickIndex,0)}init(){if("record"===this.mode){this.canStore=!0,this.isInvalid=!1,this.marblePositions.length=0,this.marbleOrientations.length=0,this.marbleLinearVelocities.length=0,this.marbleAngularVelocities.length=0,this.marbleInside.length=0,this.marbleEnter.length=0,this.marbleLeave.length=0,this.marbleContact.length=0,this.uses.length=0,this.blasts.length=0,this.cameraOrientations.length=0,this.timeTravelTimeToRevert.clear(),this.touchFinishTickIndices.length=0,this.finishTime=null,this.trapdoorStartValues.length=0,this.landmineStartValues.length=0,this.pushButtonStartValues.length=0,this.nukeStartValues.length=0,this.rollingSoundGain.length=0,this.rollingSoundPlaybackRate.length=0,this.slidingSoundGain.length=0,this.jumpSoundTimes.length=0,this.bounceTimes.length=0,this.randomPowerUpChoices.clear(),this.checkpointRespawns.length=0;for(let e of this.level.shapes)e instanceof Ss?this.trapdoorStartValues.push({id:e.id,lastContactTime:e.lastContactTime,lastDirection:e.lastDirection,lastCompletion:e.lastCompletion}):e instanceof us?this.landmineStartValues.push({id:e.id,disappearTime:e.disappearTime}):e instanceof Fs?this.pushButtonStartValues.push({id:e.id,lastContactTime:e.lastContactTime}):e instanceof Ds&&this.nukeStartValues.push({id:e.id,disappearTime:e.disappearTime});this.timeSinceLoad=this.level.timeState.timeSinceLoad}else for(let e of this.level.shapes)if(e instanceof Ss){let t=this.trapdoorStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.lastContactTime&&(t.lastContactTime=-1/0),e.lastContactTime=t.lastContactTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad,e.lastDirection=t.lastDirection,e.lastCompletion=t.lastCompletion}else if(e instanceof us){let t=this.landmineStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.disappearTime&&(t.disappearTime=-1/0),e.disappearTime=t.disappearTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad}else if(e instanceof Fs){let t=this.pushButtonStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.lastContactTime&&(t.lastContactTime=-1/0),e.lastContactTime=t.lastContactTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad}else if(e instanceof Ds){let t=this.nukeStartValues.find(t=>t.id===e.id);if(!t)continue;null===t.disappearTime&&(t.disappearTime=-1/0),e.disappearTime=t.disappearTime-this.timeSinceLoad+this.level.timeState.timeSinceLoad}}record(){var e;if("playback"===this.mode||!this.canStore)return;let t=this.level.marble;this.marblePositions.push(t.body.position.clone()),this.marbleOrientations.push(t.body.orientation.clone()),this.marbleLinearVelocities.push(t.body.linearVelocity.clone()),this.marbleAngularVelocities.push(t.body.angularVelocity.clone()),this.cameraOrientations.push({yaw:this.level.yaw,pitch:this.level.pitch});let i=(null===(e=t.rollingMegaMarbleSound)||void 0===e?void 0:e.playing)?t.rollingMegaMarbleSound:t.rollingSound;this.rollingSoundGain.push(i.gain.gain.value),this.rollingSoundPlaybackRate.push(i.node.playbackRate.value),this.slidingSoundGain.push(t.slidingSound.gain.gain.value),this.level.finishTime&&null===this.finishTime&&(this.finishTime=P.jsonClone(this.level.finishTime)),this.marblePositions.length>=60*Za*60&&(this.canStore=!1,this.isInvalid=null===this.level.finishTime)}recordMarbleInside(e){"playback"!==this.mode&&this.canStore&&this.marbleInside.push({tickIndex:this.currentTickIndex,id:e.id})}recordMarbleEnter(e){"playback"!==this.mode&&this.canStore&&this.marbleEnter.push({tickIndex:this.currentTickIndex,id:e.id})}recordMarbleLeave(e){"playback"!==this.mode&&this.canStore&&this.marbleLeave.push({tickIndex:this.currentTickIndex,id:e.id})}recordMarbleContact(e){"playback"!==this.mode&&this.canStore&&this.marbleContact.push({tickIndex:this.currentTickIndex,id:e.id})}recordUsePowerUp(e){"playback"!==this.mode&&this.canStore&&this.uses.push({tickIndex:this.currentTickIndex,id:e.id})}recordUseBlast(){"playback"!==this.mode&&this.canStore&&this.blasts.push({tickIndex:this.currentTickIndex})}recordTouchFinish(){"playback"!==this.mode&&this.canStore&&this.touchFinishTickIndices.push(this.currentTickIndex)}recordCheckpointRespawn(){"playback"!==this.mode&&this.canStore&&this.checkpointRespawns.push(this.currentTickIndex)}playBack(){var e,t,i,s,n,a;let r=this.currentTickIndex;if(!(r>=this.marblePositions.length)){for(let t of this.marbleInside){if(t.tickIndex!==r)continue;(null!==(e=this.level.shapes.find(e=>e.id===t.id))&&void 0!==e?e:this.level.triggers.find(e=>e.id===t.id)).onMarbleInside(1)}for(let e of this.marbleEnter){if(e.tickIndex!==r)continue;(null!==(t=this.level.shapes.find(t=>t.id===e.id))&&void 0!==t?t:this.level.triggers.find(t=>t.id===e.id)).onMarbleEnter(1)}for(let e of this.marbleLeave){if(e.tickIndex!==r)continue;(null!==(i=this.level.shapes.find(t=>t.id===e.id))&&void 0!==i?i:this.level.triggers.find(t=>t.id===e.id)).onMarbleLeave()}for(let e of this.marbleContact){if(e.tickIndex!==r)continue;(null!==(s=this.level.shapes.find(t=>t.id===e.id))&&void 0!==s?s:this.level.interiors.find(t=>t.id===e.id)).onMarbleContact(null,1e3/Za)}for(let e of this.uses){if(e.tickIndex!==r)continue;this.level.shapes.find(t=>t.id===e.id).use(0)}for(let e of this.blasts)e.tickIndex===r&&this.level.marble.useBlast();for(let e of this.touchFinishTickIndices)e===r&&this.level.touchFinish();for(let e of this.checkpointRespawns)e===r&&this.level.loadCheckpointState();this.level.marble.body.position.copy(this.marblePositions[r]),this.level.marble.body.orientation.copy(this.marbleOrientations[r]),this.level.marble.body.linearVelocity.copy(this.marbleLinearVelocities[r]),this.level.marble.body.angularVelocity.copy(this.marbleAngularVelocities[r]),this.level.yaw=this.cameraOrientations[r].yaw,this.level.pitch=this.cameraOrientations[r].pitch;for(let e=this.currentJumpSoundTime;e<this.jumpSoundTimes.length&&!(this.jumpSoundTimes[e]>r);e++)this.jumpSoundTimes[e]===r&&this.level.marble.playJumpSound();for(let e=this.currentBounceTime;e<this.bounceTimes.length&&!(this.bounceTimes[e].tickIndex>r);e++)this.bounceTimes[e].tickIndex===r&&(this.level.marble.playBounceSound(this.bounceTimes[e].volume),this.bounceTimes[e].showParticles&&this.level.marble.showBounceParticles());this.level.marble.rollingSound.gain.gain.setValueAtTime(this.rollingSoundGain[r],this.level.audio.currentTime),null===(n=this.level.marble.rollingMegaMarbleSound)||void 0===n||n.gain.gain.setValueAtTime(this.rollingSoundGain[r],this.level.audio.currentTime),this.level.marble.rollingSound.setPlaybackRate(this.rollingSoundPlaybackRate[r]),null===(a=this.level.marble.rollingMegaMarbleSound)||void 0===a||a.setPlaybackRate(this.rollingSoundPlaybackRate[r]),this.level.marble.slidingSound.gain.gain.setValueAtTime(this.slidingSoundGain[r],this.level.audio.currentTime)}}isPlaybackComplete(){return this.currentTickIndex===this.marblePositions.length-1}async serialize(){let e=new Float32Array(2*this.cameraOrientations.length);for(let t=0;t<this.cameraOrientations.length;t++)e[2*t+0]=this.cameraOrientations[t].yaw,e[2*t+1]=this.cameraOrientations[t].pitch;let t={version:this.version,timestamp:Date.now(),missionPath:this.missionPath,marblePositions:P.arrayBufferToString(dr.vec3sToBuffer(this.marblePositions).buffer),marbleOrientations:P.arrayBufferToString(dr.quatsToBuffer(this.marbleOrientations).buffer),marbleLinearVelocities:P.arrayBufferToString(dr.vec3sToBuffer(this.marbleLinearVelocities).buffer),marbleAngularVelocities:P.arrayBufferToString(dr.vec3sToBuffer(this.marbleAngularVelocities).buffer),marbleInside:this.marbleInside,marbleEnter:this.marbleEnter,marbleLeave:this.marbleLeave,marbleContact:this.marbleContact,uses:this.uses,blasts:this.blasts,cameraOrientations:P.arrayBufferToString(e.buffer),timeTravelTimeToRevert:[...this.timeTravelTimeToRevert.entries()],touchFinishTickIndices:this.touchFinishTickIndices,finishTime:this.finishTime,trapdoorStartValues:this.trapdoorStartValues,landmineStartValues:this.landmineStartValues,pushButtonStartValues:this.pushButtonStartValues,nukeStartValues:this.nukeStartValues,timeSinceLoad:this.timeSinceLoad,rollingSoundGain:P.arrayBufferToString(new Float32Array(this.rollingSoundGain).buffer),rollingSoundPlaybackRate:P.arrayBufferToString(new Float32Array(this.rollingSoundPlaybackRate).buffer),slidingSoundGain:P.arrayBufferToString(new Float32Array(this.slidingSoundGain).buffer),jumpSoundTimes:this.jumpSoundTimes,bounceTimes:this.bounceTimes,randomPowerUpChoices:[...this.randomPowerUpChoices.entries()],checkpointRespawns:this.checkpointRespawns,sauce:location.origin};return await V("compress",JSON.stringify(t))}static fromSerialized(e){var t,i,s,n,a,r,o;let l=new dr,h=pako.inflate(new Uint8Array(e),{to:"string"}),d=JSON.parse(h),c=null!==(t=d.version)&&void 0!==t?t:0;l.version=c,l.missionPath=c>=1?d.missionPath:null,l.timestamp=c>=1?d.timestamp:0,l.marblePositions=dr.bufferToVec3s(new Float32Array(P.stringToArrayBuffer(d.marblePositions))),l.marbleOrientations=dr.bufferToQuats(new Float32Array(P.stringToArrayBuffer(d.marbleOrientations))),l.marbleLinearVelocities=dr.bufferToVec3s(new Float32Array(P.stringToArrayBuffer(d.marbleLinearVelocities))),l.marbleAngularVelocities=dr.bufferToVec3s(new Float32Array(P.stringToArrayBuffer(d.marbleAngularVelocities))),l.marbleInside=d.marbleInside,l.marbleEnter=d.marbleEnter,l.marbleLeave=null!==(i=d.marbleLeave)&&void 0!==i?i:[],l.marbleContact=d.marbleContact,l.uses=d.uses,l.blasts=null!==(s=d.blasts)&&void 0!==s?s:[];let u=[],m=new Float32Array(P.stringToArrayBuffer(d.cameraOrientations));for(let e=0;e<m.length/2;e++)u.push({yaw:m[2*e+0],pitch:m[2*e+1]});return l.cameraOrientations=u,l.timeTravelTimeToRevert=d.timeTravelTimeToRevert.reduce((e,t)=>(e.set(t[0],t[1]),e),new Map),l.touchFinishTickIndices=d.touchFinishTickIndices,l.finishTime=d.finishTime,l.trapdoorStartValues=d.trapdoorStartValues,l.landmineStartValues=d.landmineStartValues,l.pushButtonStartValues=null!==(n=d.pushButtonStartValues)&&void 0!==n?n:[],l.nukeStartValues=null!==(a=d.nukeStartValues)&&void 0!==a?a:[],l.timeSinceLoad=d.timeSinceLoad,l.rollingSoundGain=[...new Float32Array(P.stringToArrayBuffer(d.rollingSoundGain))],l.rollingSoundPlaybackRate=[...new Float32Array(P.stringToArrayBuffer(d.rollingSoundPlaybackRate))],l.slidingSoundGain=[...new Float32Array(P.stringToArrayBuffer(d.slidingSoundGain))],l.jumpSoundTimes=d.jumpSoundTimes,l.bounceTimes=d.bounceTimes,l.randomPowerUpChoices=(null!==(r=d.randomPowerUpChoices)&&void 0!==r?r:[]).reduce((e,t)=>(e.set(t[0],t[1]),e),new Map),l.checkpointRespawns=null!==(o=d.checkpointRespawns)&&void 0!==o?o:[],l}static vec3sToBuffer(e){let t=new Float32Array(3*e.length);for(let i=0;i<e.length;i++)t[3*i+0]=e[i].x,t[3*i+1]=e[i].y,t[3*i+2]=e[i].z;return t}static quatsToBuffer(e){let t=new Float32Array(4*e.length);for(let i=0;i<e.length;i++)t[4*i+0]=e[i].x,t[4*i+1]=e[i].y,t[4*i+2]=e[i].z,t[4*i+3]=e[i].w;return t}static bufferToVec3s(e){let t=[];for(let i=0;i<e.length/3;i++){let n=new s(e[3*i+0],e[3*i+1],e[3*i+2]);t.push(n)}return t}static bufferToQuats(e){let t=[];for(let s=0;s<e.length/4;s++){let n=new i(e[4*s+0],e[4*s+1],e[4*s+2],e[4*s+3]);t.push(n)}return t}static async download(e,t,i=!0,s=!1){i&&(e=await this.maybeUpdateReplay(e,t.path));let n=new Blob([e],{type:"application/octet-stream"}),a=URL.createObjectURL(n),r=P.removeSpecialChars(t.title.toLowerCase().split(" ").map(e=>P.uppercaseFirstLetter(e)).join(""));r+="-";for(let e=0;e<6;e++)r+="0123456789abcdef"[Math.floor(16*Math.random())];s&&(r+="u"),r+=".wrec",P.download(a,r),URL.revokeObjectURL(a)}static async maybeUpdateReplay(e,t){let i=pako.inflate(new Uint8Array(e),{to:"string"});if(!i.includes('"version"')){let s=JSON.parse(i);s.missionPath=t,s.timestamp=0,s.version=1,e=await V("compress",JSON.stringify(s))}return e}}class cr{static async init(){await this.syncLeaderboard()}static loadLocal(){let e=new Set,i=t.menu.levelSelect.currentMissionArray;for(let s=-5;s<=5;s++){let n=i[t.menu.levelSelect.getCycleMissionIndex(s)];n&&e.add(n.path)}for(let i of t.menu.levelSelect.getNextShuffledMissions())e.add(i.path);this.loadForMissions([...e])}static async loadForMissions(e){if(0===(e=e.filter(e=>!this.loading.has(e)&&!this.scores.has(e))).length)return;e.forEach(e=>this.loading.add(e)),this.registerLeaderboardChange(e);let t=await ne.retryFetch("./api/scores",{method:"POST",body:JSON.stringify({missions:e})}),i=await ne.readBlobAsJson(t);for(let e in i)this.scores.set(e,i[e]),this.loading.delete(e);this.registerLeaderboardChange(e)}static isLoading(e){return this.loading.has(e)}static async submitBestTime(e,t){K.data.bestTimeSubmissionQueue[e]=t,K.store(),this.syncLeaderboard()}static async syncLeaderboard(){var t;let i=K.data.bestTimeSubmissionQueue,s={},n={},a="";for(let e in i){let r=i[e];s[e]=[r[0],r[1]];let o=null===(t=this.scores.get(e))||void 0===t?void 0:t[0];if(!o||r[1]<o[1]){let t=await K.databaseGet("replays",r[2]);if(!t)continue;let i=await P.arrayBufferToBase64(t);n[e]=i,a+=dr.fromSerialized(t).finishTime.gameplayClock}}let r={randomId:K.data.randomId,bestTimes:Object.keys(i).length?await P.arrayBufferToBase64(await V("compress",JSON.stringify(s))):null,latestTimestamp:this.latestTimestamp,replays:n,hash:"",version:K.data.lastSeenVersion},o=r.bestTimes+e.toString()+a,l=await crypto.subtle.digest("SHA-256",new Uint8Array(o.split("").map(e=>e.charCodeAt(0)))),h=[...new Uint8Array(l)].map(e=>e.toString(16).padStart(2,"0")).join("");r.hash=h;let d=await ne.retryFetch("./api/submit",{method:"POST",body:JSON.stringify(r)}),c=await ne.readBlobAsJson(d);this.latestTimestamp=c.latestTimestamp;for(let e in c.scores){if(!this.scores.has(e))continue;let t=this.scores.get(e),i=c.scores[e];(t=t.filter(e=>!i.some(t=>t[0]===e[0]))).push(...i),t.sort((e,t)=>e[1]-t[1]),this.scores.set(e,t)}this.registerLeaderboardChange(Object.keys(c.scores)),K.data.bestTimeSubmissionQueue={},K.store()}static registerLeaderboardChange(e){var i,s;let n=!1,a=K.data.bestTimeSubmissionQueue;for(let t of e){let e=null===(i=this.scores.get(t))||void 0===i?void 0:i[0],r=null===(s=K.data.bestTimes[t])||void 0===s?void 0:s[0];if(e&&r&&!(t in a)){for(;r&&r[1]<Number(e[1]);)K.data.bestTimes[t].splice(0,1),r=K.data.bestTimes[t][0],n=!0;0===K.data.bestTimes[t].length&&delete K.data.bestTimes[t]}}n&&K.storeBestTimes();let r=t.menu.levelSelect.currentMission;e.includes(null===r||void 0===r?void 0:r.path)&&t.menu.levelSelect.displayBestTimes()}}var ur;cr.scores=new Map,cr.loading=new Set,cr.latestTimestamp=null;class mr{static get isCompilation(){return!!this.directoryHandle}static updateOverviewText(){let e=Number(this.div.querySelectorAll("._config-row")[4].children[1].value)||1,t=this.tickLength/Za/e,i=`Video duration: ${P.secondsToTimeString(t,3)}\nDestination file: ${this.fileHandle?this.fileHandle.name:"‚Äì"}`;if(this.isCompilation){i=`Levels: ${this.compilation.schedule.filter(e=>"replay"===e.type).length}\n`+i}else{i=`Level: ${this.compilation.schedule[0].mission.title}\n`+i}this.overviewText.textContent=i}static updateMusicToSoundRatioDisplay(){let e=this.div.querySelectorAll("._config-row")[9].children[1],t=this.div.querySelectorAll("._config-row")[9].children[2],i=Math.tan(Number(e.value)*Math.PI/2);"0.5"===e.value&&(i=1),"1"===e.value&&(i=1/0),t.textContent=`${Math.min(P.cursedRound(i,10),1)} : ${Math.min(P.cursedRound(1/i,10),1)}`}static updateAudioSettingsEnabledness(){let e=this.div.querySelectorAll("._config-row")[7].children[1].checked;this.div.querySelectorAll("._config-row")[8].classList.toggle("disabled",!e),this.div.querySelectorAll("._config-row")[9].classList.toggle("disabled",!e)}static async createWorker(){let e=gr.toString(),t=e.slice(e.indexOf("{")+1,e.lastIndexOf("}")),i=new Blob([t]),s=new Worker(URL.createObjectURL(i));return s.postMessage(window.location.href.slice(0,window.location.href.lastIndexOf("/")+1)),await new Promise(e=>s.addEventListener("message",t=>"ready"===t.data&&e())),s}static async render(){this.process=new pr,await this.process.run(),this.hide()}static async stopRender(e){var i;(e||await t.menu.showConfirmPopup("Stop rendering","Are you sure you want to cancel the ongoing rendering process?"))&&(null===(i=this.process)||void 0===i||i.stop(),this.hide())}static show(){this.div.classList.remove("hidden"),t.menu.levelSelect.hide(),this.loaded||this.initUiFromStoredConfig()}static showForSingleReplay(e,t){"showSaveFilePicker"in window&&"VideoEncoder"in window?(this.show(),this.compilation={schedule:[{type:"replay",filename:null,replay:t,mission:e}],showInfo:!1},this.computeLength(),this.updateOverviewText(),this.selectDestinationButton.style.display=""):this.showNotSupportedAlert()}static async showForCompilation(e){var i,s;let n;this.directoryHandle=e;try{n=await e.getFileHandle("manifest.json")}catch(e){return void t.menu.showAlertPopup("Missing compilation manifest file","The selected directory does not contain a manifest.json file, which is required. For a tutorial on how to render compilations, click [here](https://github.com/Vanilagy/MarbleBlast/tree/master/docs/compilation_how_to.md).")}this.show(),this.selectDestinationButton.style.display="none",this.compilationLoadingElement.classList.remove("hidden");try{let a=await(await n.getFile()).text();this.compilation=JSON.parse(a);let r=this.compilation.schedule.filter(e=>"replay"===e.type).length,o=0;for(let t of this.compilation.schedule){if("replay"!==t.type)continue;let i=o++/r;this.compilationLoadingElement.textContent=`Loading... (${Math.floor(100*i)}%)`;let s=await e.getFileHandle(t.filename),n=await(await s.getFile()).arrayBuffer(),a=dr.fromSerialized(n),l=$a.allMissions.find(e=>e.path===a.missionPath);if(!l)throw new Error("Mission not found.");if(t.replay=a,t.mission=l,"string"==typeof t.runner){let e=t.runner;if(!this.compilation.runners.some(t=>t.id===e))throw new Error("Runner definition not found.")}}this.fileHandle=await e.getFileHandle(null!==(i=this.compilation.outputFilename)&&void 0!==i?i:"output.webm",{create:!0}),this.chapterFileHandle=await e.getFileHandle(null!==(s=this.compilation.chaptersFilename)&&void 0!==s?s:"chapters.txt",{create:!0}),this.compilationLoadingElement.classList.add("hidden"),this.renderButton.classList.remove("disabled"),this.computeLength(),this.updateOverviewText()}catch(e){console.error(e),this.hide(),t.menu.showAlertPopup("Error","An error occurred while loading the compilation. Your compilation manifest might be malformed.")}}static computeTickLengthForReplay(e){var t;let i=e.marblePositions.length-1;if(e.finishTime){let s=null!==(t=e.finishTime.tickIndex)&&void 0!==t?t:Math.floor(e.finishTime.currentAttemptTime*Za/1e3);i=Math.min(i,s+2*Za)}return i}static computeLength(){this.tickLength=0;for(let e of this.compilation.schedule){if("replay"!==e.type)continue;let t=e.replay;this.tickLength+=this.computeTickLengthForReplay(t)}}static initUiFromStoredConfig(){this.loaded=!0;let e=K.data.videoRecorderConfig.playbackSpeed.toString();e.includes(".")||(e+=".0"),this.div.querySelectorAll("._config-row")[0].children[1].value=K.data.videoRecorderConfig.width.toString(),this.div.querySelectorAll("._config-row")[1].children[1].value=K.data.videoRecorderConfig.height.toString(),this.div.querySelectorAll("._config-row")[2].children[1].value=K.data.videoRecorderConfig.kilobitRate.toString(),this.div.querySelectorAll("._config-row")[3].children[1].value=K.data.videoRecorderConfig.frameRate.toString(),this.div.querySelectorAll("._config-row")[4].children[1].value=e,this.div.querySelectorAll("._config-row")[5].children[1].checked=K.data.videoRecorderConfig.fastMode,this.div.querySelectorAll("._config-row")[6].children[1].checked=K.data.videoRecorderConfig.bt709,this.div.querySelectorAll("._config-row")[7].children[1].checked=K.data.videoRecorderConfig.includeAudio,this.div.querySelectorAll("._config-row")[8].children[1].value=K.data.videoRecorderConfig.audioKilobitRate.toString(),this.div.querySelectorAll("._config-row")[9].children[1].value=(2*Math.atan(K.data.videoRecorderConfig.musicToSoundRatio)/Math.PI).toString(),this.updateMusicToSoundRatioDisplay(),this.updateAudioSettingsEnabledness()}static hide(){this.div.classList.add("hidden"),t.menu.levelSelect.show(),this.directoryHandle=null,this.fileHandle=null,this.chapterFileHandle=null,this.process=null,this.compilation=null,this.renderButton.classList.add("disabled"),this.progressBar.style.display="none",this.progressBar.value=0,this.statusText.textContent="",this.configContainer.classList.remove("disabled"),this.renderButton.textContent="Render",this.closeButton.style.display="",this.compilationLoadingElement.classList.add("hidden"),document.title="Marble Blast Web"}static showNotSupportedAlert(){t.menu.showAlertPopup("Not supported","Unfortunately, your browser does not support the technology required by the video renderer. To access this feature, try using Chromium 94 or above (Chrome 94, Edge 94, Opera 80) on desktop.")}}ur=mr,mr.loaded=!1,mr.compilation=null,mr.process=null,ur.div=document.querySelector("#video-renderer"),ur.configContainer=ur.div.querySelector("._config"),ur.selectDestinationButton=ur.div.querySelector("#video-renderer-select-destination"),ur.overviewText=ur.div.querySelector("#video-renderer-overview"),ur.renderButton=ur.div.querySelector("#video-renderer-render"),ur.closeButton=ur.div.querySelector("#video-renderer-close"),ur.progressBar=ur.div.querySelector("#video-renderer progress"),ur.statusText=ur.div.querySelector("#video-renderer-status"),ur.compilationLoadingElement=ur.div.querySelector("#video-renderer-compilation-loading"),ur.selectDestinationButton.addEventListener("click",async()=>{let e=ur.compilation.schedule[0].mission,t=P.removeSpecialChars(e.title.toLowerCase().split(" ").map(e=>P.uppercaseFirstLetter(e)).join(""));try{ur.fileHandle=await window.showSaveFilePicker({startIn:"videos",suggestedName:`${t}.webm`,types:[{description:"Video File",accept:{"video/webm":[".webm"]}}]})}catch(e){return}ur.updateOverviewText(),ur.renderButton.classList.remove("disabled")}),ur.renderButton.addEventListener("click",()=>{"Stop"===ur.renderButton.textContent?ur.stopRender(!1):ur.render()}),ur.closeButton.addEventListener("click",()=>{ur.stopRender(!0)}),ur.div.querySelectorAll("._config-row")[4].children[1].addEventListener("input",()=>{ur.updateOverviewText()}),ur.div.querySelectorAll("._config-row")[7].children[1].addEventListener("input",()=>{ur.updateAudioSettingsEnabledness()}),ur.div.querySelectorAll("._config-row")[8].children[1].addEventListener("input",()=>{ur.updateMusicToSoundRatioDisplay()});class pr{constructor(){this.renderedFrames=0,this.renderedLevels=0,this.stopped=!1,this.chaptersText=""}async run(){var e,t;try{if(this.readConfiguration(),!this.validateConfiguration())return;if(this.storeConfiguration(),this.prepareUi(),await this.createWorker(),this.setUpWorker(),await this.keepScreenAwake(),await this.renderLevels(),this.initFinalization(),this.stopped)return;await this.awaitEncoding(),await this.finalize()}catch(t){console.error(t),null===(e=this.level)||void 0===e||e.stop(),clearInterval(this.intervalId),this.exitWithError()}finally{null===(t=this.worker)||void 0===t||t.terminate(),this.releaseWakeLock()}}async renderLevels(){for(let e of mr.compilation.schedule){if("replay"!==e.type)continue;if(this.stopped)break;this.currentEntry=e;let{mission:i,replay:s}=e;await this.loadLevel(i,s),this.initRendering(),await this.renderFrames(),await this.renderAudio(),this.level.stop(),t.level=null,s.level=null,this.renderedLevels++}}readConfiguration(){const e=mr.div;this.width=Number(e.querySelectorAll("._config-row")[0].children[1].value),this.height=Number(e.querySelectorAll("._config-row")[1].children[1].value),this.kilobitRate=Number(e.querySelectorAll("._config-row")[2].children[1].value),this.frameRate=Number(e.querySelectorAll("._config-row")[3].children[1].value),this.playbackSpeed=Number(e.querySelectorAll("._config-row")[4].children[1].value),this.fastMode=e.querySelectorAll("._config-row")[5].children[1].checked,this.bt709=e.querySelectorAll("._config-row")[6].children[1].checked,this.includeAudio=e.querySelectorAll("._config-row")[7].children[1].checked,this.audioKilobitRate=Number(e.querySelectorAll("._config-row")[8].children[1].value),this.musicToSoundRatio=Math.tan(Number(e.querySelectorAll("._config-row")[9].children[1].value)*Math.PI/2)}validateConfiguration(){return!Number.isInteger(this.width)||this.width<1||this.width%2!=0?(t.menu.showAlertPopup("Error",'"Width" has to be a positive even integer.'),!1):!Number.isInteger(this.height)||this.height<1||this.height%2!=0?(t.menu.showAlertPopup("Error",'"Height" has to be a positive even integer.'),!1):!isFinite(this.kilobitRate)||this.kilobitRate<1?(t.menu.showAlertPopup("Error",'"Bit rate" has an illegal value.'),!1):!isFinite(this.frameRate)||this.frameRate<=0?(t.menu.showAlertPopup("Error",'"Frame rate" has to be positive.'),!1):!isFinite(this.playbackSpeed)||this.playbackSpeed<=0?(t.menu.showAlertPopup("Error",'"Playback speed" has to be positive.'),!1):!(!isFinite(this.audioKilobitRate)||this.audioKilobitRate<6)||(t.menu.showAlertPopup("Error",'"Audio bit rate" has to be at least 6 kbit/s.'),!1)}storeConfiguration(){K.data.videoRecorderConfig.width=this.width,K.data.videoRecorderConfig.height=this.height,K.data.videoRecorderConfig.kilobitRate=this.kilobitRate,K.data.videoRecorderConfig.frameRate=this.frameRate,K.data.videoRecorderConfig.playbackSpeed=this.playbackSpeed,K.data.videoRecorderConfig.fastMode=this.fastMode,K.data.videoRecorderConfig.bt709=this.bt709,K.data.videoRecorderConfig.includeAudio=this.includeAudio,K.data.videoRecorderConfig.audioKilobitRate=this.audioKilobitRate,K.data.videoRecorderConfig.musicToSoundRatio=this.musicToSoundRatio,K.store()}computeFrameCountForReplay(e){return Math.floor(mr.computeTickLengthForReplay(e)/Za*this.frameRate/this.playbackSpeed)}prepareUi(){mr.configContainer.classList.add("disabled"),mr.progressBar.style.display="block",mr.renderButton.textContent="Stop",mr.closeButton.style.display="none";let e=mr.compilation.schedule.filter(e=>"replay"===e.type);this.totalFrameCount=e.reduce((e,t)=>e+this.computeFrameCountForReplay(t.replay),0),this.totalTimeUs=1e6*this.totalFrameCount/this.frameRate,this.levelCount=e.length}async createWorker(){let e=gr.toString(),t=e.slice(e.indexOf("{")+1,e.lastIndexOf("}")),i=new Blob([t]),s=new Worker(URL.createObjectURL(i));s.postMessage(window.location.href.slice(0,window.location.href.lastIndexOf("/")+1)),await new Promise(e=>s.addEventListener("message",t=>"ready"===t.data&&e())),this.worker=s}async loadLevel(e,i){this.beginUpdatingUiBasedOnLoadingProgress(),await e.load(),this.level=new hr(e,Object.assign({duration:this.computeFrameCountForReplay(i)/this.frameRate*this.playbackSpeed,musicVolume:Math.min(this.musicToSoundRatio,1),soundVolume:Math.min(1/this.musicToSoundRatio,1)},await this.getMarbleConfigForCurrentRunner())),t.level=this.level,await this.level.init(),this.level.replay=i,i.level=this.level,i.mode="playback",await this.level.start(),clearInterval(this.intervalId)}async getMarbleConfigForCurrentRunner(){let e,t;if("string"==typeof this.currentEntry.runner){let i=mr.compilation.runners.find(e=>e.id===this.currentEntry.runner),s=i.marbleTexture;s&&(e=await(await mr.directoryHandle.getFileHandle(s)).getFile()),t=i.reflectiveMarble}return{marbleTexture:e,reflectiveMarble:t}}beginUpdatingUiBasedOnLoadingProgress(){this.intervalId=setInterval(()=>{var e,t;let i=Math.min(null!==(t=null===(e=this.level)||void 0===e?void 0:e.getLoadingCompletion())&&void 0!==t?t:0,1);mr.progressBar.value=(this.renderedLevels+.1*i)/this.levelCount,mr.progressBar.value*=.8,mr.statusText.textContent=`Loading (${Math.floor(100*i)}%)`},16)}setUpWorker(){this.worker.postMessage({command:"setup",width:this.width,height:this.height,kilobitRate:this.kilobitRate,frameRate:this.frameRate,includeAudio:this.includeAudio,audioKilobitRate:this.audioKilobitRate,fileHandle:mr.fileHandle}),this.worker.addEventListener("message",e=>{var t;"error"===e.data.command&&(console.error(e),null===(t=this.level)||void 0===t||t.stop(),clearInterval(this.intervalId),this.exitWithError())}),this.lastVideoChunkTimestamp=0,this.lastAudioChunkTimestamp=this.includeAudio?0:1/0,this.worker.addEventListener("message",e=>{"videoChunkEncoded"===e.data.command?this.lastVideoChunkTimestamp=e.data.timestamp:"audioChunkEncoded"===e.data.command&&(this.lastAudioChunkTimestamp=e.data.timestamp)})}initRendering(){he.setSize(this.width,this.height),he.setPixelRatio(1),this.level.onResize(this.width,this.height,1);let e=document.createElement("canvas");e.setAttribute("width",this.width.toString()),e.setAttribute("height",this.height.toString()),this.ctx=e.getContext("2d",{willReadFrequently:!0})}async renderFrames(){const e=this.computeFrameCountForReplay(this.currentEntry.replay);for(let t=0;t<e&&!this.stopped;t++){let i=1e3*t*this.playbackSpeed/this.frameRate;if(this.level.render(i),this.level.stopped)break;if(this.composeFrame(i),this.sendFrameToWorker(),0===t&&this.appendToChaptersText(),this.renderedFrames++,document.title=`Rendering (${(100*this.renderedFrames/this.totalFrameCount).toFixed(1)}%) - Marble Blast Web`,mr.statusText.textContent=`Rendering frame ${Math.min(this.renderedFrames,this.totalFrameCount)}/${this.totalFrameCount}`,mr.progressBar.value=(this.renderedLevels+.1+.9*Math.min(t+1,e)/e)/this.levelCount,mr.progressBar.value*=.8,await this.waitBeforeRenderingNextFrame(),he.gl.isContextLost())throw new Error("Context lost")}}composeFrame(e){this.ctx.globalAlpha=1,this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.resetTransform(),this.ctx.drawImage(le,0,0),this.ctx.drawImage(t.menu.hud.hudCanvas,0,0),this.maybeDrawRunInfo(e),this.drawSectionText(e)}maybeDrawRunInfo(e){if(!1===mr.compilation.showInfo)return;if(this.ctx.globalAlpha=1-P.clamp((e-(ir-1e3))/1e3,0,1),0===this.ctx.globalAlpha)return;let t=this.width/1920,i=1-(1-P.clamp(e/500,0,1))**2,s=P.lerp(1.05,1,i);this.ctx.translate(this.width/2,this.height),this.ctx.scale(s,s),this.ctx.translate(-this.width/2,-this.height),this.ctx.fillStyle="white",this.ctx.font=`${64*t}px Chakra Petch`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.shadowColor="rgba(0, 0, 0, 0.75)",this.ctx.shadowBlur=4*t,this.ctx.shadowOffsetX=1*t,this.ctx.shadowOffsetY=2*t;let n=this.level.mission.title,{replay:a}=this.currentEntry;if(a.finishTime&&(n+=" - "+P.secondsToTimeString(a.finishTime.gameplayClock/1e3)),this.ctx.fillText(n,this.width/2,.73*this.height),"string"==typeof this.currentEntry.runner){let e=mr.compilation.runners.find(e=>e.id===this.currentEntry.runner).name;this.ctx.font=`${48*t}px Chakra Petch`,this.ctx.fillText(`Runner: ${e}`,this.width/2,.8*this.height)}}drawSectionText(e){let t=e-(1e3*mr.computeTickLengthForReplay(this.currentEntry.replay)/Za-3e3),i=P.clamp(t/500,0,1);if(0===i)return;let s=mr.compilation.schedule,n=s.findIndex(e=>e===this.currentEntry)+1,a=[];for(;s[n]&&"sectionEnd"===s[n].type;)a.push(s[n]),n++;for(let[e,t]of a.reverse().entries()){let a=P.findLastIndex(s,e=>"sectionStart"===e.type&&e.name===t.name,n-1);if(-1===a)continue;let r=0;for(let e=a+1;e<n;e++){let t=s[e];"replay"===t.type&&t.replay.finishTime&&(r+=t.replay.finishTime.gameplayClock)}let o=this.width/1920;this.ctx.globalAlpha=i,this.ctx.fillStyle="white",this.ctx.font=`${64*o}px Chakra Petch`,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.shadowColor="rgba(0, 0, 0, 0.75)",this.ctx.shadowBlur=4*o,this.ctx.shadowOffsetX=1*o,this.ctx.shadowOffsetY=2*o,this.ctx.fillText(`${t.name}: ${P.secondsToTimeString(r/1e3)}`,this.width/2,.73*this.height-.07*this.height*e)}}sendFrameToWorker(){if(this.bt709){let e=this.ctx.getImageData(0,0,this.width,this.height).data.buffer;this.worker.postMessage({command:"imageBuffer",imageBuffer:e},[e])}else{let e=new VideoFrame(this.ctx.canvas,{timestamp:1e6*this.renderedFrames/this.frameRate});this.worker.postMessage({command:"videoFrame",videoFrame:e},[e])}}appendToChaptersText(){let e=this.renderedFrames/this.frameRate;this.chaptersText+=`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")} - ${this.level.mission.title}`,"string"==typeof this.currentEntry.runner&&(this.chaptersText+=` | ${mr.compilation.runners.find(e=>e.id===this.currentEntry.runner).name}`),this.chaptersText+="\n"}async waitBeforeRenderingNextFrame(){this.fastMode?await new Promise(e=>W(e,16)):await new Promise(e=>this.worker.addEventListener("message",t=>{"videoChunkEncoded"===t.data.command&&e()},{once:!0}))}async renderAudio(){if(this.includeAudio){let e=this.level.audio.context,t=await e.startRendering(),i=this.createAudioData(t,this.playbackSpeed);this.worker.postMessage({command:"audioData",audioData:i},[i])}}createAudioData(e,t){let i=Math.floor(e.length/t),s=new Float32Array(2*i);if(1===t)e.copyFromChannel(s,0),e.copyFromChannel(s.subarray(i),1);else{let n=[e.getChannelData(0),e.getChannelData(1)];for(let e=0;e<i;e++){let a=e*t;for(let t=0;t<2;t++){let r=n[t],o=r[Math.floor(a)],l=r[Math.ceil(a)],h=P.lerp(o,l,a%1);s[t*i+e]=h}}}return new AudioData({format:"f32-planar",sampleRate:dt,numberOfFrames:i,numberOfChannels:2,timestamp:0,data:s})}initFinalization(){this.stopped||this.worker.postMessage({command:"finishUp"})}async awaitEncoding(){let e=()=>Math.min(this.lastVideoChunkTimestamp,this.lastAudioChunkTimestamp),t=e();this.intervalId=setInterval(()=>{let i=(e()-t)/(this.totalTimeUs-t);mr.statusText.textContent=`Encoding (${(100*i).toFixed(1)}%)`,mr.progressBar.value=.8+.2*i},16),await new Promise(e=>this.worker.addEventListener("message",t=>"closing"===t.data&&e())),clearInterval(this.intervalId)}async finalize(){if(!this.stopped){if(mr.statusText.textContent="Writing and checking file... (might take a while)",mr.progressBar.value=1,await new Promise(e=>this.worker.addEventListener("message",t=>"done"===t.data&&e())),mr.statusText.textContent="Finalizing...",mr.progressBar.value=1,mr.chapterFileHandle){let e=await mr.chapterFileHandle.createWritable();await e.write(this.chaptersText),await e.close()}await P.wait(200),t.menu.showAlertPopup("Rendering complete","The replay has been successfully rendered to the specified destination video file.")}}exitWithError(){let e;e=he.gl.isContextLost()?"Your WebGL context has been lost during rendering, meaning that your browser thought the rendering task was too taxing on your hardware. Rendering using parallelized encoding might be the cause of this. Please reload the page to restore the context.":"There has been an error during video rendering.",t.menu.showAlertPopup("Rendering failed",e),t.level=null,this.stopped=!0}stop(){this.stopped=!0,clearInterval(this.intervalId)}async keepScreenAwake(){if("wakeLock"in navigator)try{this.wakeLock=await navigator.wakeLock.request("screen")}catch(e){}}releaseWakeLock(){var e;null===(e=this.wakeLock)||void 0===e||e.release()}}const gr=()=>{let e,t,i,s,n,a,r,o,l=-1/0;let h=0;const d=e=>{let t=e.timestamp-l>=5e6;t&&(l=e.timestamp),i.encode(e,{keyFrame:t}),e.close()};self.onmessage=(async u=>{if(!e)return e=u.data,self.importScripts(e+"lib/webm.js"),void self.postMessage("ready");let m=u.data;try{"setup"===m.command?await(async e=>{n=await e.fileHandle.createWritable(),a=e.width,r=e.height,o=e.frameRate;t=new WebMMuxer({target:n,video:{codec:"V_VP9",width:e.width,height:e.height,frameRate:e.frameRate},audio:e.includeAudio?{codec:"A_OPUS",numberOfChannels:2,sampleRate:48e3}:void 0}),(i=new VideoEncoder({output:(e,i)=>{t.addVideoChunk(e,i),"key"===e.type&&(l=Math.max(l,e.timestamp)),self.postMessage({command:"videoChunkEncoded",timestamp:e.timestamp})},error:e=>console.error(e)})).configure({codec:"vp09.00.10.08",width:e.width,height:e.height,bitrate:1e3*e.kilobitRate,latencyMode:"realtime"}),e.includeAudio&&(s=new AudioEncoder({output:(e,i)=>{t.addAudioChunk(e,i),self.postMessage({command:"audioChunkEncoded",timestamp:e.timestamp})},error:e=>console.error(e)})).configure({codec:"opus",numberOfChannels:2,sampleRate:48e3,bitrate:1e3*e.audioKilobitRate})})(m):"imageBuffer"===m.command?(e=>{let t=c({width:a,height:r,data:new Uint8ClampedArray(e.imageBuffer)}),i=new VideoFrame(t,{format:"I420",codedWidth:a,codedHeight:r,timestamp:h,colorSpace:{matrix:"bt709",transfer:"bt709",primaries:"bt709",fullRange:!1}});h+=1e6/o,d(i)})(m):"videoFrame"===m.command?d(m.videoFrame):"audioData"===m.command?(m=m,s.encode(m.audioData),m.audioData.close()):"finishUp"===m.command&&await(async()=>{await Promise.all([i.flush(),null===s||void 0===s?void 0:s.flush()]),i.close(),null===s||void 0===s||s.close(),t.finalize(),self.postMessage("closing"),await n.close(),self.postMessage("done")})()}catch(u){self.postMessage({command:"error",error:u})}});const c=({width:e,height:t,data:i})=>{let s=new Uint8Array(e*t*1.5);for(let n=0;n<t;n+=64)for(let a=0;a<e;a+=64){let r=Math.min(e,a+64),o=Math.min(t,n+64);for(let l=n;l<o;l++)for(let n=a;n<r;n++){let a=i[4*(l*e+n)+0],r=i[4*(l*e+n)+1],o=i[4*(l*e+n)+2],h=.182586*a+.614231*r+.0620071*o+16,d=-.100668*a-.338547*r+.439216*o+128.439,c=.439216*a-.398984*r-.0426039*o+128.439;s[l*e+n]=h,n%2==0&&l%2==0&&(s[1*e*t+(l*e/4+n/2)]=d,s[1.25*e*t+(l*e/4+n/2)]=c)}}return s}};var fr;class yr{constructor(e){this.setImagesTimeout=null,this.clearImageTimeout=null,this.currentQuery="",this.currentQueryWords=[],this.replayButtonData=new WeakMap,this.fetchingRemoteReplay=!1,this.menu=e,this.initProperties(),e.setupButton(this.homeButton,this.homeButtonSrc,()=>{this.hide(),e.home.show()},void 0,void 0,"gold"===t.modification),e.setupButton(this.prevButton,"play/prev",()=>this.cycleMission(-1),!0,!0,"gold"===t.modification,!0),e.setupButton(this.playButton,"play/play",()=>this.playCurrentMission(),!0,void 0,"gold"===t.modification),e.setupButton(this.nextButton,"play/next",()=>this.cycleMission(1),!0,!0,"gold"===t.modification,!0)}get currentMission(){var e;return null===(e=this.currentMissionArray)||void 0===e?void 0:e[this.currentMissionIndex]}async init(){for(let e=0;e<this.localScoresCount;e++){let e=this.createScoreElement(async e=>await K.databaseGet("replays",e));this.localBestTimesContainer.appendChild(e)}for(let e=0;e<18;e++){let e=this.createScoreElement(async()=>{if(!this.fetchingRemoteReplay)try{this.fetchingRemoteReplay=!0;let e=await ne.retryFetch(`./api/world_record_replay?missionPath=${encodeURIComponent(this.currentMission.path)}`),t=await e.arrayBuffer();return this.fetchingRemoteReplay=!1,t}catch(e){return this.fetchingRemoteReplay=!1,null}});this.leaderboardScores.appendChild(e)}this.scrollWindow.addEventListener("scroll",()=>this.updateOnlineLeaderboard()),window.addEventListener("keydown",e=>{this.div.classList.contains("hidden")||("ArrowLeft"!==e.code||this.searchInput.value&&document.activeElement!==document.body?"ArrowRight"!==e.code||this.searchInput.value&&document.activeElement!==document.body?"Escape"===e.code&&(this.homeButton.src=this.menu.uiAssetPath+this.homeButtonSrc+"_d.png"):(this.cycleMission(1),this.nextButton.style.pointerEvents||(this.nextButton.src=this.menu.uiAssetPath+"play/next_d.png")):(this.cycleMission(-1),this.prevButton.style.pointerEvents||(this.prevButton.src=this.menu.uiAssetPath+"play/prev_d.png")))}),window.addEventListener("keyup",e=>{this.div.classList.contains("hidden")||("ArrowLeft"===e.code?this.prevButton.style.pointerEvents||(this.prevButton.src=this.prevButton.hasAttribute("data-hovered")?this.menu.uiAssetPath+"play/prev_h.png":this.menu.uiAssetPath+"play/prev_n.png"):"ArrowRight"===e.code?this.nextButton.style.pointerEvents||(this.nextButton.src=this.nextButton.hasAttribute("data-hovered")?this.menu.uiAssetPath+"play/next_h.png":this.menu.uiAssetPath+"play/next_n.png"):"Escape"===e.code&&this.homeButton.click())}),this.searchInput.addEventListener("input",()=>{this.onSearchInputChange()}),this.searchInput.addEventListener("focus",()=>{this.searchInput.value="",this.onSearchInputChange()})}show(){this.div.classList.remove("hidden"),this.displayMission()}hide(){this.div.classList.add("hidden")}setMissionArray(e,t=!0){this.currentMissionArray=e,this.currentMissionIndex=this.getDefaultMissionIndex(),this.selectBasedOnSearchQuery(!1),this.displayMission(t)}getDefaultMissionIndex(){var e;if([$a.goldCustom,$a.platinumCustom,$a.ultraCustom].includes(this.currentMissionArray))return this.currentMissionArray.length-1;let t=0;for(let i=0;i<this.currentMissionArray.length;i++){let s=this.currentMissionArray[i];(null===(e=K.data.bestTimes[s.path])||void 0===e?void 0:e.length)&&(t=i+1)}return Math.min(t,this.currentMissionArray.length-1)}displayMission(e=!0){this.currentMission?("none"===this.playButton.style.pointerEvents&&(this.playButton.src=this.menu.uiAssetPath+"play/play_n.png",this.playButton.style.pointerEvents=""),this.levelImage.style.display="",this.displayMetadata(),this.displayBestTimes(),this.clearImageTimeout||(this.clearImageTimeout=setTimeout(()=>this.levelImage.src="",16))):(this.levelImage.style.display="none",this.playButton.src=this.menu.uiAssetPath+"play/play_i.png",this.playButton.style.pointerEvents="none",this.displayEmptyMetadata(),this.displayBestTimes()),this.setImages(!1,e),this.updateNextPrevButtons(),cr.loadLocal()}playCurrentMission(e){this.currentMission&&(this.div.classList.add("hidden"),this.menu.loadingScreen.loadLevel(this.currentMission,e?()=>dr.fromSerialized(e):void 0))}cycleMission(e){let t=this.getCycleMissionIndex(e);null!==t&&t!==this.currentMissionIndex&&(this.currentMissionIndex=t,this.displayMission())}getCycleMissionIndex(e){if(0===e)return this.currentMissionIndex;for(let t=this.currentMissionIndex+Math.sign(e);t>=0&&t<this.currentMissionArray.length;t+=Math.sign(e))if(this.currentMissionArray[t].matchesSearch(this.currentQueryWords,this.currentQuery)&&(e=Math.sign(e)*(Math.abs(e)-1)),0===e)return t;return null}canGoNext(){let e=!1;for(let t=this.currentMissionIndex+1;t<this.currentMissionArray.length;t++)if(this.currentMissionArray[t].matchesSearch(this.currentQueryWords,this.currentQuery)){e=!0;break}return e}canGoPrev(){let e=!1;for(let t=this.currentMissionIndex-1;t>=0;t--)if(this.currentMissionArray[t].matchesSearch(this.currentQueryWords,this.currentQuery)){e=!0;break}return e}updateNextPrevButtons(){this.canGoNext()?(this.nextButton.src.endsWith("i.png")&&(this.nextButton.src=this.menu.uiAssetPath+"play/next_n.png"),this.nextButton.style.pointerEvents=""):(this.nextButton.src=this.menu.uiAssetPath+"play/next_i.png",this.nextButton.style.pointerEvents="none"),this.canGoPrev()?(this.prevButton.src.endsWith("i.png")&&(this.prevButton.src=this.menu.uiAssetPath+"play/prev_n.png"),this.prevButton.style.pointerEvents=""):(this.prevButton.src=this.menu.uiAssetPath+"play/prev_i.png",this.prevButton.style.pointerEvents="none")}setImages(e=!1,t=!0){if(e&&(clearTimeout(this.setImagesTimeout),this.setImagesTimeout=null),null!==this.setImagesTimeout&&t)return clearTimeout(this.setImagesTimeout),void(this.setImagesTimeout=setTimeout(()=>this.setImages(!0),75));let i=new Set;for(let e=0;e<=10;e++){let t=this.getCycleMissionIndex(Math.ceil(e/2)*(e%2?1:-1)),s=this.currentMissionArray[t];s&&i.add(s)}for(let e of this.getNextShuffledMissions())i.add(e);for(let e of i){let i=e.getImagePath(),s=performance.now();ne.loadResource(i).then(async i=>{if(!i)return;if(e===this.currentMission){let t=await ne.readBlobAsDataUrl(i);e===this.currentMission&&(clearTimeout(this.clearImageTimeout),this.clearImageTimeout=null,this.levelImage.src=t)}performance.now()-s>75&&!this.setImagesTimeout&&t&&(this.setImagesTimeout=setTimeout(()=>this.setImages(!0),75))})}}shuffle(){if(this.currentMissionArray.length<=1)return;let e=this.currentMissionIndex;for(;e===this.currentMissionIndex;)e=Math.floor(P.popRandomNumber()*this.currentMissionArray.length);this.currentMissionIndex=e,this.displayMission()}getNextShuffledMissions(){let e=[];if(this.currentMissionArray.length>1){let t=this.currentMissionIndex,i=0,s=0;for(;s<5;){let n=P.peekRandomNumber(i++),a=Math.floor(n*this.currentMissionArray.length);if(t!==a){let t=this.currentMissionArray[a];e.push(t),s++}t=a}}return e}displayBestTimes(){var e;let t=P.getRandomId();this.lastDisplayBestTimesId=t;let i=K.getBestTimesForMission(null===(e=this.currentMission)||void 0===e?void 0:e.path,this.localScoresCount,this.scorePlaceholderName);for(let e=0;e<this.localScoresCount;e++){let t=this.localBestTimesContainer.children[e];this.updateScoreElement(this.localBestTimesContainer.children[e],i[e],e+1),this.updateReplayButton(this.getReplayButtonForScoreElement(t),i[e],e+1,!0)}if(this.currentMission)this.leaderboardLoading.style.display=cr.isLoading(this.currentMission.path)?"block":"none",this.updateOnlineLeaderboard(),setTimeout(()=>this.updateOnlineLeaderboard());else{this.leaderboardLoading.style.display="none",this.leaderboardScores.style.paddingTop="0px",this.leaderboardScores.style.paddingBottom="0px";for(let e of this.leaderboardScores.children)e.style.display="none"}}createReplayButton(e){let t=document.createElement("img");t.src="./assets/img/round_videocam_black_18dp.png",t.title="Alt-Click to download, Shift-Click to render to video";const i=async i=>{let s=this.currentMission;if(!s)return;let n=await e(this.replayButtonData.get(t));if(n)if("watch"===i)this.playCurrentMission(n);else if("download"===i)dr.download(n,s),P.isTouchDevice&&P.isInFullscreen()&&this.menu.showAlertPopup("Downloaded","The .wrec has been downloaded.");else{let e=dr.fromSerialized(n);mr.showForSingleReplay(this.currentMission,e)}};return t.addEventListener("click",async e=>{0===e.button&&(e.shiftKey?i("render"):e.altKey?i("download"):i("watch"))}),P.onLongTouch(t,()=>{i("download")}),t.addEventListener("mouseenter",()=>{ft.play("buttonover.wav")}),t.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),t}async updateReplayButton(e,t,i,s){if(e.style.display="none",this.replayButtonData.delete(e),s){if(!t[2])return;let i=this.lastDisplayBestTimesId,s=await K.databaseCount("replays",t[2]);if(i!==this.lastDisplayBestTimesId||0===s)return;this.replayButtonData.set(e,t[2])}else if(1!==i||"custom"===this.currentMission.type)return;e.style.display="block"}updateOnlineLeaderboard(){var e;let t=this.currentMission;if(!t)return;let i=null!==(e=cr.scores.get(t.path))&&void 0!==e?e:[],s=this.leaderboardScores.children,n=0;this.leaderboardScores.style.paddingTop="0px",this.leaderboardScores.style.paddingBottom="0px",s[n].style.display="block";let a=s[0].offsetTop-this.scrollWindow.scrollTop;for(this.leaderboardScores.style.height=i.length*this.scoreElementHeight+"px";a<-this.scoreElementHeight&&n<i.length;)n++,a+=this.scoreElementHeight;this.leaderboardScores.style.paddingTop=n*this.scoreElementHeight+"px";for(let e=0;e<s.length;e++){let t=s[e];if(n<i.length){let e=i[n];t.style.display="block",this.updateScoreElement(t,e,n+1),this.updateReplayButton(this.getReplayButtonForScoreElement(t),e,n+1,!1)}else t.style.display="none";n++}this.leaderboardScores.style.paddingBottom=Math.max(i.length-n,0)*this.scoreElementHeight+"px"}onSearchInputChange(){let e=P.removeSpecialCharacters(P.normalizeString(this.searchInput.value.trim())).toLowerCase();this.currentQuery=e,this.currentQueryWords=e.split(" "),e||(this.currentQueryWords.length=0),this.selectBasedOnSearchQuery(),this.updateNextPrevButtons()}selectBasedOnSearchQuery(e=!0){var t;if(null===(t=this.currentMission)||void 0===t||!t.matchesSearch(this.currentQueryWords,this.currentQuery))for(let t=0;t<this.currentMissionArray.length;t++){if(this.currentMissionArray[t].matchesSearch(this.currentQueryWords,this.currentQuery)){this.currentMissionIndex=t,e&&this.displayMission();break}}}showLoadReplayPrompt(e){if(e.shiftKey&&e.altKey)return void this.showCompilationDirectoryPrompt();let i=document.createElement("input");i.setAttribute("type","file"),i.setAttribute("accept",".wrec"),i.onchange=(async()=>{try{let s=i.files[0],n=await ne.readBlobAsArrayBuffer(s),a=dr.fromSerialized(n),r=$a.allMissions.find(e=>e.path===a.missionPath);if(!r)throw new Error("Mission not found.");if("gold"===t.modification&&r.path.startsWith("mbp"))return void t.menu.showAlertPopup("Warning","You can't load replays of Platinum levels inside Marble Blast Gold.");e.shiftKey?mr.showForSingleReplay(r,a):(this.div.classList.add("hidden"),this.menu.loadingScreen.loadLevel(r,()=>a))}catch(e){t.menu.showAlertPopup("Error","There was an error loading the replay."),console.error(e)}}),i.click()}async showCompilationDirectoryPrompt(){if(!("showDirectoryPicker"in window&&"VideoEncoder"in window))return void mr.showNotSupportedAlert();let e;try{e=await window.showDirectoryPicker({mode:"readwrite"})}catch(e){return}mr.showForCompilation(e)}handleControllerInput(e){e.buttons[0].value>.5&&!_e[0]&&(this.playCurrentMission(),ft.play("buttonpress.wav")),e.buttons[6].value>.5&&!_e[6]&&(this.currentMissionArray===$a.goldIntermediate?this.setMissionArray($a.goldBeginner):this.currentMissionArray===$a.goldAdvanced?this.setMissionArray($a.goldIntermediate):this.currentMissionArray===$a.goldCustom?this.setMissionArray($a.goldAdvanced):this.currentMissionArray===$a.platinumBeginner?this.setMissionArray($a.goldCustom):this.currentMissionArray===$a.platinumIntermediate?this.setMissionArray($a.platinumBeginner):this.currentMissionArray===$a.platinumAdvanced?this.setMissionArray($a.platinumIntermediate):this.currentMissionArray===$a.platinumExpert?this.setMissionArray($a.platinumAdvanced):this.currentMissionArray===$a.platinumCustom?this.setMissionArray($a.platinumExpert):this.currentMissionArray===$a.ultraBeginner?this.setMissionArray($a.platinumCustom):this.currentMissionArray===$a.ultraIntermediate?this.setMissionArray($a.ultraBeginner):this.currentMissionArray===$a.ultraAdvanced?this.setMissionArray($a.ultraIntermediate):this.currentMissionArray===$a.ultraCustom&&this.setMissionArray($a.ultraAdvanced),ft.play("buttonpress.wav")),e.buttons[7].value>.5&&!_e[7]&&(this.currentMissionArray===$a.goldBeginner?this.setMissionArray($a.goldIntermediate):this.currentMissionArray===$a.goldIntermediate?this.setMissionArray($a.goldAdvanced):this.currentMissionArray===$a.goldAdvanced?this.setMissionArray($a.goldCustom):this.currentMissionArray===$a.goldCustom?this.setMissionArray($a.platinumBeginner):this.currentMissionArray===$a.platinumBeginner?this.setMissionArray($a.platinumIntermediate):this.currentMissionArray===$a.platinumIntermediate?this.setMissionArray($a.platinumAdvanced):this.currentMissionArray===$a.platinumAdvanced?this.setMissionArray($a.platinumExpert):this.currentMissionArray===$a.platinumExpert?this.setMissionArray($a.platinumCustom):this.currentMissionArray===$a.platinumCustom?this.setMissionArray($a.ultraBeginner):this.currentMissionArray===$a.ultraBeginner?this.setMissionArray($a.ultraIntermediate):this.currentMissionArray===$a.ultraIntermediate?this.setMissionArray($a.ultraAdvanced):this.currentMissionArray===$a.ultraAdvanced&&this.setMissionArray($a.ultraCustom),ft.play("buttonpress.wav")),e.buttons[14].value>.5&&!_e[14]&&(this.cycleMission(-1),ft.play("buttonpress.wav")),e.buttons[15].value>.5&&!_e[15]&&(this.cycleMission(1),ft.play("buttonpress.wav"))}}class br extends yr{constructor(){super(...arguments),this.localScoresCount=3,this.scorePlaceholderName="Nardo Polo",this.scoreElementHeight=14}initProperties(){this.div=document.querySelector("#level-select"),this.homeButton=document.querySelector("#level-select-home-button"),this.homeButtonSrc="play/back",this.tabBeginner=document.querySelector("#tab-beginner"),this.tabIntermediate=document.querySelector("#tab-intermediate"),this.tabAdvanced=document.querySelector("#tab-advanced"),this.tabCustom=document.querySelector("#tab-custom"),this.scrollWindow=document.querySelector("#level-select-text-window-scrollable"),this.levelTitle=document.querySelector("#level-title"),this.levelArtist=document.querySelector("#level-artist"),this.levelDescription=document.querySelector("#level-description"),this.levelQualifyTime=document.querySelector("#level-qualify-time"),this.localBestTimesContainer=document.querySelector("#level-select-local-best-times"),this.leaderboardLoading=document.querySelector("#online-leaderboard-loading"),this.leaderboardScores=document.querySelector("#leaderboard-scores"),this.levelImage=document.querySelector("#level-image"),this.levelNumberElement=document.querySelector("#level-number"),this.prevButton=document.querySelector("#level-select-prev"),this.playButton=document.querySelector("#level-select-play"),this.nextButton=document.querySelector("#level-select-next"),this.searchInput=document.querySelector("#search-input"),this.loadReplayButton=document.querySelector("#load-replay-button"),this.shuffleButton=document.querySelector("#shuffle-button")}async init(){await super.init();const e=(e,t)=>{e.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),e.addEventListener("click",e=>0===e.button&&this.setMissionArray(t))};e(this.tabBeginner,$a.goldBeginner),e(this.tabIntermediate,$a.goldIntermediate),e(this.tabAdvanced,$a.goldAdvanced),e(this.tabCustom,$a.goldCustom),this.loadReplayButton.addEventListener("click",async e=>{this.showLoadReplayPrompt(e)}),this.loadReplayButton.addEventListener("mouseenter",()=>{ft.play("buttonover.wav")}),this.loadReplayButton.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),this.shuffleButton.addEventListener("click",()=>{this.shuffle()}),this.shuffleButton.addEventListener("mouseenter",()=>{ft.play("buttonover.wav")}),this.shuffleButton.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),this.setMissionArray($a.goldCustom,!1),this.setMissionArray($a.goldAdvanced,!1),this.setMissionArray($a.goldIntermediate,!1),this.setMissionArray($a.goldBeginner,!1)}setMissionArray(e,t){super.setMissionArray(e,t);for(let e of[this.tabBeginner,this.tabIntermediate,this.tabAdvanced,this.tabCustom])e.style.zIndex="-1";let i=[$a.goldBeginner,$a.goldIntermediate,$a.goldAdvanced,$a.goldCustom].indexOf(this.currentMissionArray);[this.tabBeginner,this.tabIntermediate,this.tabAdvanced,this.tabCustom][i].style.zIndex="0"}displayMetadata(){let e=this.currentMission;this.levelTitle.textContent=e.title,this.levelArtist.textContent="by "+e.artist.trim(),this.levelArtist.style.display="custom"===e.type?"block":"none",this.levelDescription.textContent=e.description;let t=0!==e.qualifyTime?e.qualifyTime:1/0;this.levelQualifyTime.textContent=isFinite(t)?"Time to Qualify: "+P.secondsToTimeString(t/1e3):"",this.levelNumberElement.textContent=`${P.uppercaseFirstLetter(e.type)} Level ${this.currentMissionIndex+1}`}displayEmptyMetadata(){this.levelTitle.innerHTML="<br>",this.levelArtist.style.display="none",this.levelDescription.innerHTML="<br>",this.levelQualifyTime.innerHTML="",this.levelNumberElement.textContent=`Level ${this.currentMissionIndex+1}`}createScoreElement(e){let t=document.createElement("div");t.classList.add("level-select-best-time");let i=document.createElement("div");t.appendChild(i);let s=document.createElement("img");s.src="./assets/ui/play/goldscore.png",t.appendChild(s);let n=document.createElement("div");return t.appendChild(n),t.appendChild(this.createReplayButton(e)),t}getReplayButtonForScoreElement(e){return e.children[3]}updateScoreElement(e,t,i){let s=0,n=this.currentMission;n&&(s=n.goldTime),e.children[0].textContent=i+". "+t[0],e.children[1].style.opacity=t[1]<=s?"":"0",e.children[2].textContent=P.secondsToTimeString(t[1]/1e3)}}class vr{constructor(e){this.initProperties(),e.setupButton(this.playButton,this.playSrc,()=>{this.hide(),e.levelSelect.show(),cr.syncLeaderboard()}),e.setupButton(this.helpButton,this.helpSrc,()=>{this.hide(),e.helpScreen.show()},void 0,void 0,"gold"===t.modification),e.setupButton(this.optionsButton,this.optionsSrc,()=>{this.hide(),e.optionsScreen.show()}),e.setupButton(this.exitButton,this.exitSrc,()=>{window.close(),location.search.includes("app")||(location.href="https://www.youtube.com/watch?v=dQw4w9WgXcQ")}),e.setupButton(this.showChangelogButton,this.showChangelogSrc,()=>{this.changelogContainer.classList.remove("hidden")},void 0,void 0,"gold"===t.modification),e.setupButton(this.changelogBackButton,this.changelogBackSrc,()=>{this.changelogContainer.classList.add("hidden")}),this.div.querySelector(".modification-switcher").addEventListener("click",()=>{Xr("gold"===t.modification?"platinum":"gold")})}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}async init(){let e=await ne.loadResource("/api/version_history"),i=await ne.readBlobAsText(e),s=/(^|\n)## (\d+\.\d+\.\d+)/.exec(i)[2];this.version.textContent=`MBW v${s}`,P.isTouchDevice&&(this.version.style.left="15px",this.version.style.bottom="15px");let n="gold"===t.modification?"changelog":"mbp-changelog";if(i=(i=(i=(i=(i=i.replace(/(^|\n)# (.*)/g,`$1<span class="${n}-h1">$2</span>`)).replace(/(^|\n)## (.*)/g,`$1<span class="${n}-h2">$2</span>`)).replace(/(^|\n)### (.*)/g,`$1<span class="${n}-h3">$2</span>`)).replace(/\*\*(.*?)\*\*/g,"<b>$1</b>")).replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank">$1</a>'),this.changelogContent.innerHTML=i,K.data.lastSeenVersion){s!==K.data.lastSeenVersion&&(this.changelogContainer.classList.remove("hidden"),await K.onVersionUpgrade(K.data.lastSeenVersion))}else Object.keys(K.data.bestTimes).length>0&&this.changelogContainer.classList.remove("hidden");K.data.lastSeenVersion=s,K.store()}}class wr extends vr{initProperties(){this.div=document.querySelector("#home-screen"),this.playButton=document.querySelector("#home-play"),this.optionsButton=document.querySelector("#home-options"),this.helpButton=document.querySelector("#home-help"),this.exitButton=document.querySelector("#home-exit"),this.showChangelogButton=document.querySelector("#show-changelog"),this.showChangelogText=document.querySelector("#show-changelog-text"),this.changelogContainer=document.querySelector("#changelog"),this.changelogBackButton=document.querySelector("#changelog-back"),this.changelogContent=document.querySelector("#changelog-content"),this.version=document.querySelector("#version"),this.playSrc="home/play",this.optionsSrc="home/options",this.helpSrc="home/help",this.exitSrc="home/exit",this.showChangelogSrc="motd/motd_buttn_textless",this.changelogBackSrc="play/back"}}class xr{constructor(){this.gameUiDiv=document.querySelector("#game-ui"),this.popupContainer=document.querySelector("#popup-container"),this.activeButtonVariant=new Map,this.variantChangeListeners=new Map,this.menuDiv=this.getMenuDiv(),this.backgroundImage=this.getBackgroundImage(),this.home=this.createHome(),this.levelSelect=this.createLevelSelect(),this.loadingScreen=this.createLoadingScreen(),this.optionsScreen=this.createOptionsScreen(),this.helpScreen=this.createHelpScreen(),this.hud=this.createHud(),this.pauseScreen=this.createPauseScreen(),this.finishScreen=this.createFinishScreen()}setupVaryingButton(e,t,i,s=!1,n=!1,a=!0,r=!1){let o=t.slice();t=t.map(e=>this.uiAssetPath+e);let l,h=!1,d=!1;const c=()=>t[this.activeButtonVariant.get(e)]+"_n.png",u=()=>t[this.activeButtonVariant.get(e)]+"_h.png",m=()=>t[this.activeButtonVariant.get(e)]+"_d.png",p=()=>t[this.activeButtonVariant.get(e)]+"_i.png",g=()=>{let t=ve.x/de,i=ve.y/de,s=e.getBoundingClientRect();return t>=s.x-10&&t<s.x+s.width+10&&i>=s.y-10&&i<s.y+s.height+10};e.addEventListener("mouseenter",()=>{P.isTouchDevice||(d=!0,e.setAttribute("data-hovered",""),"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=h?m():u()),!h&&a&&ft.play("buttonover.wav")))}),e.addEventListener("mouseleave",()=>{P.isTouchDevice||(d=!1,e.removeAttribute("data-hovered"),"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=c())))}),e.addEventListener("touchmove",()=>{"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=g()?m():c()))});const f=t=>{"none"!==e.style.pointerEvents&&0===t.button&&(h=!0,e.hasAttribute("data-locked")||(e.src=m()),ft.play("buttonpress.wav"),n&&(i(t),r&&(l=setTimeout(()=>l=setInterval(()=>i(t),30),500))),window.addEventListener("mouseup",y),window.addEventListener("touchend",b))};e.addEventListener("mousedown",e=>{P.isTouchDevice||f(e)}),e.addEventListener("touchstart",()=>{f({button:0})});const y=()=>{h=!1,clearTimeout(l),clearInterval(l),window.removeEventListener("mouseup",y),window.removeEventListener("touchend",b),"none"!==e.style.pointerEvents&&(e.hasAttribute("data-locked")||(e.src=d?u():c()))},b=e=>{h&&!n&&g()&&i(e),y()};n||e.addEventListener("click",e=>{e.isTrusted&&P.isTouchDevice&&"ontouchstart"in window||0===e.button&&i(e)});for(let t of o)t&&(this.activeButtonVariant.set(e,o.indexOf(t)),ne.loadImage(c()),ne.loadImage(u()),ne.loadImage(m()),s&&ne.loadImage(p()));this.variantChangeListeners.set(e,()=>{e.src=h?m():d?u():c()}),this.setButtonVariant(e,0)}setupButton(e,t,i,s,n,a,r){this.setupVaryingButton(e,[t],i,s,n,a,r)}setButtonVariant(e,t){this.activeButtonVariant.set(e,t),this.variantChangeListeners.get(e)()}show(){if(ft.setAssetPath(this.audioAssetPath),this.menuDiv.classList.remove("hidden"),ye(!0),P.isWeeb){let e=ft.assetPath;ft.assetPath="",this.music=ft.createAudioSource("./assets/music/renai.ogg",ft.musicGain),ft.assetPath=e}else this.music=ft.createAudioSource(this.menuMusicSrc,ft.musicGain);this.music.setLoop(!0),this.music.play(),this.popupContainer.style.visibility="visible",this.popupContainer.style.pointerEvents="auto"}hide(){var e;this.menuDiv.classList.add("hidden"),null===(e=this.music)||void 0===e||e.stop(),ye(!1)}showGameUi(){this.gameUiDiv.classList.remove("hidden")}hideGameUi(){this.gameUiDiv.classList.add("hidden")}createAlertBase(e,i,s){let n=document.createElement("div");n.classList.add("hidden"),n.classList.add("popup"),n.classList.add("gold"===t.modification?"mbg":"mbp");let a=document.createElement("div"),r=document.createElement("img");r.onload=(()=>{n.style.width=("gold"===t.modification?400:r.width)+"px",n.style.height=("gold"===t.modification?250:r.height)+"px",r.style.width=n.style.width,r.style.height=n.style.height,n.classList.remove("hidden")}),r.src=this.popupBackgroundSrc;let o=document.createElement("p");o.classList.add("_heading"),o.innerHTML=e;let l=document.createElement("p");return l.classList.add("_body"),l.innerHTML=i,l.innerHTML=l.innerHTML.replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank">$1</a>'),n.append(a,r,o,l),s&&(s.classList.add("_custom"),setTimeout(()=>{s.style.top=44+l.clientHeight+"px",n.append(s)})),n}showAlertPopup(e,t,i){return new Promise(s=>{let n=this.createAlertBase(e,t,i),a=document.createElement("img");a.classList.add("_okay"),this.setupButton(a,this.popupOkaySrc,()=>{this.popupContainer.removeChild(n),0===this.popupContainer.children.length&&(this.popupContainer.style.display="none"),window.removeEventListener("keydown",r),window.removeEventListener("keyup",o),s()});let r=e=>{"Escape"===e.key&&(a.src=this.uiAssetPath+this.popupOkaySrc+"_d.png")},o=e=>{"Escape"===e.key&&a.click()};window.addEventListener("keydown",r),window.addEventListener("keyup",o),n.append(a),this.popupContainer.append(n),this.popupContainer.style.display=""})}showConfirmPopup(e,t,i){return new Promise(s=>{let n=this.createAlertBase(e,t,i),a=document.createElement("img");a.classList.add("_no"),this.setupButton(a,this.popupNoSrc,()=>{this.popupContainer.removeChild(n),0===this.popupContainer.children.length&&(this.popupContainer.style.display="none"),window.removeEventListener("keydown",o),window.removeEventListener("keyup",l),s(!1)});let r=document.createElement("img");r.classList.add("_yes"),this.setupButton(r,this.popupYesSrc,()=>{this.popupContainer.removeChild(n),0===this.popupContainer.children.length&&(this.popupContainer.style.display="none"),window.removeEventListener("keydown",o),window.removeEventListener("keyup",l),s(!0)});let o=e=>{"Escape"===e.key&&(a.src=this.uiAssetPath+this.popupNoSrc+"_d.png")},l=e=>{"Escape"===e.key&&a.click()};window.addEventListener("keydown",o),window.addEventListener("keyup",l),n.append(a,r),this.popupContainer.append(n),this.popupContainer.style.display=""})}async init(){ft.setAssetPath(this.audioAssetPath),await ft.loadBuffers([this.menuMusicSrc,"buttonover.wav","buttonpress.wav"]),await Promise.all([this.home.init(),this.levelSelect.init(),this.finishScreen.init(),this.optionsScreen.init(),this.helpScreen.init()]),await ne.loadImages([this.popupBackgroundSrc]);let e=document.createElement("img");this.setupButton(e,this.popupOkaySrc,null),this.setupButton(e,this.popupNoSrc,null),this.setupButton(e,this.popupYesSrc,null),this.home.show()}}class Sr{constructor(e){this.loadingIndex=0,this.menu=e,this.initProperties(),e.setupButton(this.cancelButton,"loading/cancel",()=>{this.hide(),e.levelSelect.show(),this.loadingIndex++,clearInterval(this.refresher)})}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}async loadLevel(e,i){this.show();let s=this.loadingIndex;this.levelNameElement.textContent=e.title,this.progressBar.style.width="0px",await P.wait(50);try{if(await e.load(),this.loadingIndex!==s)return;this.refresher=setInterval(()=>{let e=n.getLoadingCompletion();this.progressBar.style.width=e*this.maxProgressBarWidth+"px"});let n=new hr(e);if(t.level=n,await n.init(),i){let e=i();n.replay=e,e.level=n,e.mode="playback"}if(this.loadingIndex!==s)return void n.dispose();clearInterval(this.refresher);let a=performance.now();if(this.refresher=setInterval(()=>{let e=P.clamp((performance.now()-a)/100,0,1);this.progressBar.style.width=e*this.maxProgressBarWidth+"px"}),await P.wait(150),this.loadingIndex!==s)return void n.dispose();clearInterval(this.refresher),n.start(),this.hide(),this.menu.hide(),this.menu.showGameUi()}catch(e){console.error(e),this.cancelButton.click(),t.level=null,t.menu.showAlertPopup("Error","There was an error due to which the level couldn't be loaded.")}}}class Tr extends Sr{constructor(){super(...arguments),this.maxProgressBarWidth=252}initProperties(){this.div=document.querySelector("#loading"),this.levelNameElement=document.querySelector("#loading-level-name"),this.cancelButton=document.querySelector("#loading-cancel"),this.progressBar=document.querySelector("#loading-progress")}}class Mr extends tn{constructor(e){super(e),this.trackLength=235,this.musicVolumeKnobLeft=155,this.soundVolumeKnobLeft=157,this.mouseSensitivityKnobLeft=148,this.draggingMusicVolume=!1,this.draggingSoundVolume=!1,this.draggingMouseSensitivity=!1,this.soundTestingSound=null,e.setupButton(this.resolution640,"options/graf640",()=>this.selectResolutionButton(this.resolution640,0)),e.setupButton(this.resolution800,"options/graf800",()=>this.selectResolutionButton(this.resolution800,1)),e.setupButton(this.resolution1024,"options/graf1024",()=>this.selectResolutionButton(this.resolution1024,2)),e.setupButton(this.openGl,"options/grafopgl",()=>this.selectVideoDriverButton(this.openGl,0)),e.setupButton(this.direct3D,"options/grafdir3d",()=>this.selectVideoDriverButton(this.direct3D,1)),e.setupButton(this.windowedButton,"options/grafwindo",()=>this.selectScreenStyleButton(this.windowedButton,0)),e.setupButton(this.fullButton,"options/grafful",()=>this.selectScreenStyleButton(this.fullButton,1)),e.setupButton(this.depth16,"options/graf16bt",()=>this.selectColorDepthButton(this.depth16,0)),e.setupButton(this.depth32,"options/graf32bt",()=>this.selectColorDepthButton(this.depth32,1)),e.setupButton(this.shadowsCheckbox,"options/graf_chkbx",()=>{K.data.settings.shadows=!this.shadowsCheckbox.hasAttribute("data-locked"),K.store(),this.shadowsCheckbox.hasAttribute("data-locked")?(this.shadowsCheckbox.removeAttribute("data-locked"),this.shadowsCheckbox.src="./assets/ui/options/graf_chkbx_h.png"):(this.shadowsCheckbox.setAttribute("data-locked",""),this.shadowsCheckbox.src="./assets/ui/options/graf_chkbx_d.png")}),e.setupButton(this.graphicsApply,"options/grafapply",()=>{});const t=()=>{(this.draggingMusicVolume||this.draggingSoundVolume||this.draggingMouseSensitivity)&&(this.draggingMusicVolume=this.draggingSoundVolume=this.draggingMouseSensitivity=!1,K.store(),this.soundTestingSound&&(this.soundTestingSound.stop(),this.soundTestingSound=null))};window.addEventListener("mouseup",t),window.addEventListener("touchend",t),this.musicVolumeTrack.addEventListener("mousedown",()=>this.draggingMusicVolume=!0),this.musicVolumeTrack.addEventListener("touchstart",()=>this.draggingMusicVolume=!0),this.musicVolumeKnob.addEventListener("mousedown",()=>this.draggingMusicVolume=!0),this.musicVolumeKnob.addEventListener("touchstart",()=>this.draggingMusicVolume=!0),this.soundVolumeTrack.addEventListener("mousedown",()=>this.draggingSoundVolume=!0),this.soundVolumeTrack.addEventListener("touchstart",()=>this.draggingSoundVolume=!0),this.soundVolumeKnob.addEventListener("mousedown",()=>this.draggingSoundVolume=!0),this.soundVolumeKnob.addEventListener("touchstart",()=>this.draggingSoundVolume=!0),requestAnimationFrame(()=>this.updateSliders()),e.setupButton(this.marbleTab,"",()=>this.selectControlsTab("marble")),e.setupButton(this.cameraTab,"",()=>this.selectControlsTab("camera")),e.setupButton(this.mouseTab,"",()=>this.selectControlsTab("mouse")),e.setupButton(this.buttonMarbleLeft,"options/cntr_mrb_lft",()=>this.changeKeybinding("left")),e.setupButton(this.buttonMarbleRight,"options/cntr_mrb_rt",()=>this.changeKeybinding("right")),e.setupButton(this.buttonMarbleUp,"options/cntr_mrb_fw",()=>this.changeKeybinding("up")),e.setupButton(this.buttonMarbleDown,"options/cntr_mrb_bak",()=>this.changeKeybinding("down")),e.setupButton(this.buttonMarbleUse,"options/cntr_mrb_pwr",()=>this.changeKeybinding("use")),e.setupButton(this.buttonMarbleJump,"options/cntr_mrb_jmp",()=>this.changeKeybinding("jump")),e.setupButton(this.buttonCameraLeft,"options/cntr_cam_lft",()=>this.changeKeybinding("cameraLeft")),e.setupButton(this.buttonCameraRight,"options/cntr_cam_rt",()=>this.changeKeybinding("cameraRight")),e.setupButton(this.buttonCameraUp,"options/cntr_cam_up",()=>this.changeKeybinding("cameraUp")),e.setupButton(this.buttonCameraDown,"options/cntr_cam_dwn",()=>this.changeKeybinding("cameraDown")),this.mouseSensitivityKnob.addEventListener("mousedown",()=>this.draggingMouseSensitivity=!0),this.mouseSensitivityKnob.addEventListener("touchstart",()=>this.draggingMouseSensitivity=!0),e.setupButton(this.invertY,"options/cntrl_mous_invrt",()=>{K.data.settings.invertMouse&=-3,K.data.settings.invertMouse|=Number(!this.invertY.hasAttribute("data-locked"))<<1,K.store(),this.invertY.hasAttribute("data-locked")?(this.invertY.removeAttribute("data-locked"),this.invertY.src="./assets/ui/options/cntrl_mous_invrt_h.png"):(this.invertY.setAttribute("data-locked",""),this.invertY.src="./assets/ui/options/cntrl_mous_invrt_d.png")}),e.setupButton(this.alwaysFreeLook,"options/cntrl_mous_freel",()=>{K.data.settings.alwaysFreeLook=!this.alwaysFreeLook.hasAttribute("data-locked"),K.store(),this.alwaysFreeLook.hasAttribute("data-locked")?(this.alwaysFreeLook.removeAttribute("data-locked"),this.alwaysFreeLook.src="./assets/ui/options/cntrl_mous_freel_h.png"):(this.alwaysFreeLook.setAttribute("data-locked",""),this.alwaysFreeLook.src="./assets/ui/options/cntrl_mous_freel_d.png")}),e.setupButton(this.freeLookKey,"options/cntrl_mous_bttn",()=>this.changeKeybinding("freeLook")),e.setupButton(this.chooseMarbleTexture,"options/cntr_cam_up",async()=>{await this.showMarbleTexturePicker(),this.setResetMarbleTextureState(!0)}),e.setupButton(this.resetMarbleTexture,"options/cntr_cam_dwn",()=>{K.databaseDelete("keyvalue","marbleTexture"),this.setResetMarbleTextureState(!1)}),e.setupButton(this.buttonRestartLevel,"options/cntr_cam_dwn",()=>this.changeKeybinding("restart")),e.setupButton(this.reflectiveMarbleCheckbox,"options/cntrl_mous_freel",()=>{K.data.settings.marbleReflectivity=this.reflectiveMarbleCheckbox.hasAttribute("data-locked")?0:2,K.store(),this.reflectiveMarbleCheckbox.hasAttribute("data-locked")?(this.reflectiveMarbleCheckbox.removeAttribute("data-locked"),this.reflectiveMarbleCheckbox.src="./assets/ui/options/cntrl_mous_freel_h.png"):(this.reflectiveMarbleCheckbox.setAttribute("data-locked",""),this.reflectiveMarbleCheckbox.src="./assets/ui/options/cntrl_mous_freel_d.png")})}initProperties(){this.div=document.querySelector("#options"),this.homeButton=document.querySelector("#options-home"),this.rebindDialog=document.querySelector("#rebind-dialog"),this.rebindConfirm=document.querySelector("#rebind-confirm"),this.rebindConfirmYes=document.querySelector("#rebind-confirm-yes"),this.rebindConfirmNo=document.querySelector("#rebind-confirm-no"),this.homeButtonSrc="options/mainm",this.rebindConfirmYesSrc="common/yes",this.rebindConfirmNoSrc="common/no",this.tabGraphics=document.querySelector("#tab-graphics"),this.tabAudio=document.querySelector("#tab-audio"),this.tabControls=document.querySelector("#tab-controls"),this.graphicsDiv=document.querySelector("#options-graphics"),this.audioDiv=document.querySelector("#options-audio"),this.controlsDiv=document.querySelector("#options-controls"),this.resolution640=document.querySelector("#graphics-640"),this.resolution800=document.querySelector("#graphics-800"),this.resolution1024=document.querySelector("#graphics-1024"),this.openGl=document.querySelector("#graphics-opengl"),this.direct3D=document.querySelector("#graphics-direct3d"),this.windowedButton=document.querySelector("#graphics-windowed"),this.fullButton=document.querySelector("#graphics-full"),this.depth16=document.querySelector("#graphics-depth16"),this.depth32=document.querySelector("#graphics-depth32"),this.shadowsCheckbox=document.querySelector("#graphics-shadows"),this.graphicsApply=document.querySelector("#graphics-apply"),this.musicVolumeTrack=document.querySelector("#audio-music-track"),this.musicVolumeKnob=document.querySelector("#audio-music-knob"),this.soundVolumeTrack=document.querySelector("#audio-sound-track"),this.soundVolumeKnob=document.querySelector("#audio-sound-knob"),this.controlsBackground=document.querySelector("#controls-background"),this.marbleTab=document.querySelector("#tab-marble"),this.cameraTab=document.querySelector("#tab-camera"),this.mouseTab=document.querySelector("#tab-mouse"),this.marbleControlsDiv=document.querySelector("#controls-marble"),this.cameraControlsDiv=document.querySelector("#controls-camera"),this.mouseControlsDiv=document.querySelector("#controls-mouse"),this.buttonMarbleLeft=document.querySelector("#button-marble-left"),this.buttonMarbleRight=document.querySelector("#button-marble-right"),this.buttonMarbleUp=document.querySelector("#button-marble-up"),this.buttonMarbleDown=document.querySelector("#button-marble-down"),this.buttonMarbleUse=document.querySelector("#button-marble-use"),this.buttonMarbleJump=document.querySelector("#button-marble-jump"),this.buttonMarbleLeftContent=document.querySelector("#button-marble-left-content"),this.buttonMarbleRightContent=document.querySelector("#button-marble-right-content"),this.buttonMarbleUpContent=document.querySelector("#button-marble-up-content"),this.buttonMarbleDownContent=document.querySelector("#button-marble-down-content"),this.buttonMarbleUseContent=document.querySelector("#button-marble-use-content"),this.buttonMarbleJumpContent=document.querySelector("#button-marble-jump-content"),this.buttonCameraLeft=document.querySelector("#button-camera-left"),this.buttonCameraRight=document.querySelector("#button-camera-right"),this.buttonCameraUp=document.querySelector("#button-camera-up"),this.buttonCameraDown=document.querySelector("#button-camera-down"),this.buttonCameraLeftContent=document.querySelector("#button-camera-left-content"),this.buttonCameraRightContent=document.querySelector("#button-camera-right-content"),this.buttonCameraUpContent=document.querySelector("#button-camera-up-content"),this.buttonCameraDownContent=document.querySelector("#button-camera-down-content"),this.mouseSensitivityKnob=document.querySelector("#sensitivity-knob"),this.invertY=document.querySelector("#invert-y"),this.alwaysFreeLook=document.querySelector("#always-free-look"),this.freeLookKey=document.querySelector("#free-look-key"),this.freeLookKeyContent=document.querySelector("#free-look-key-content"),this.chooseMarbleTexture=document.querySelector("#graphics-marble-texture-choose"),this.resetMarbleTexture=document.querySelector("#graphics-marble-texture-reset"),this.buttonRestartLevel=document.querySelector("#button-restart-level"),this.buttonRestartLevelContent=document.querySelector("#button-restart-level-content"),this.reflectiveMarbleCheckbox=document.querySelector("#graphics-reflective-marble")}show(){super.show(),this.updateAllElements()}async init(){super.init(),this.setupTab(this.tabGraphics,"graphics"),this.setupTab(this.tabAudio,"audio"),this.setupTab(this.tabControls,"controls"),this.selectControlsTab("marble"),this.selectTab("graphics"),await ne.loadImages(["cntrl_marb_bse.png","cntrl_cam_bse.png","cntrl_mous_base.png"].map(e=>"./assets/ui/options/"+e)),await this.updateAllElements()}async updateAllElements(){this.selectResolutionButton([this.resolution640,this.resolution800,this.resolution1024][K.data.settings.resolution],K.data.settings.resolution),this.selectVideoDriverButton([this.openGl,this.direct3D][K.data.settings.videoDriver],K.data.settings.videoDriver),this.selectScreenStyleButton([this.windowedButton,this.fullButton][K.data.settings.screenStyle],K.data.settings.videoDriver),this.selectColorDepthButton([this.depth16,this.depth32][K.data.settings.colorDepth],K.data.settings.colorDepth),this.musicVolumeKnob.style.left=Math.floor(this.musicVolumeKnobLeft+K.data.settings.musicVolume*this.trackLength)+"px",this.soundVolumeKnob.style.left=Math.floor(this.soundVolumeKnobLeft+K.data.settings.soundVolume*this.trackLength)+"px",this.mouseSensitivityKnob.style.left=Math.floor(this.mouseSensitivityKnobLeft+K.data.settings.mouseSensitivity*this.trackLength)+"px",this.refreshKeybindings(),!!(2&K.data.settings.invertMouse)!==this.invertY.hasAttribute("data-locked")&&this.invertY.click(),K.data.settings.alwaysFreeLook!==this.alwaysFreeLook.hasAttribute("data-locked")&&this.alwaysFreeLook.click(),2===K.data.settings.marbleReflectivity!==this.reflectiveMarbleCheckbox.hasAttribute("data-locked")&&this.reflectiveMarbleCheckbox.click(),this.setResetMarbleTextureState(!(0===await K.databaseCount("keyvalue","marbleTexture")))}selectTab(e){for(let e of[this.tabGraphics,this.tabAudio,this.tabControls])e.style.zIndex="-1";for(let e of[this.graphicsDiv,this.audioDiv,this.controlsDiv])e.classList.add("hidden");let t=["graphics","audio","controls"].indexOf(e);[this.tabGraphics,this.tabAudio,this.tabControls][t].style.zIndex="0",[this.graphicsDiv,this.audioDiv,this.controlsDiv][t].classList.remove("hidden")}setupTab(e,t){e.addEventListener("mousedown",e=>{0===e.button&&ft.play("buttonpress.wav")}),e.addEventListener("click",e=>0===e.button&&this.selectTab(t))}selectResolutionButton(e,t){this.unlockResolutionButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),K.data.settings.resolution=t,K.store()}unlockResolutionButtons(){this.resolution640.src="./assets/ui/options/graf640_n.png",this.resolution640.removeAttribute("data-locked"),this.resolution800.src="./assets/ui/options/graf800_n.png",this.resolution800.removeAttribute("data-locked"),this.resolution1024.src="./assets/ui/options/graf1024_n.png",this.resolution1024.removeAttribute("data-locked")}selectVideoDriverButton(e,t){this.unlockVideoDriverButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),K.data.settings.videoDriver=t,K.store()}unlockVideoDriverButtons(){this.openGl.src="./assets/ui/options/grafopgl_n.png",this.openGl.removeAttribute("data-locked"),this.direct3D.src="./assets/ui/options/grafdir3d_n.png",this.direct3D.removeAttribute("data-locked")}selectScreenStyleButton(e,t){this.unlockScreenStyleButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),K.data.settings.screenStyle=t,K.store()}unlockScreenStyleButtons(){this.windowedButton.src="./assets/ui/options/grafwindo_n.png",this.windowedButton.removeAttribute("data-locked"),this.fullButton.src="./assets/ui/options/grafful_n.png",this.fullButton.removeAttribute("data-locked")}selectColorDepthButton(e,t){this.unlockColorDepthButtons(),e.src=e.src.slice(0,e.src.lastIndexOf("_"))+"_d.png",e.setAttribute("data-locked",""),K.data.settings.colorDepth=t,K.store()}unlockColorDepthButtons(){this.depth16.src="./assets/ui/options/graf16bt_n.png",this.depth16.removeAttribute("data-locked"),this.depth32.src="./assets/ui/options/graf32bt_n.png",this.depth32.removeAttribute("data-locked")}async updateSliders(){if(requestAnimationFrame(()=>this.updateSliders()),!this.div.classList.contains("hidden")){if(this.draggingMusicVolume){let e=this.div.getBoundingClientRect().left*de+this.musicVolumeKnobLeft,t=P.clamp((ve.x-12-e)/this.trackLength,0,1);this.musicVolumeKnob.style.left=Math.floor(this.musicVolumeKnobLeft+t*this.trackLength)+"px",K.data.settings.musicVolume=t,ft.updateVolumes()}if(this.draggingSoundVolume){let e=this.div.getBoundingClientRect().left*de+this.soundVolumeKnobLeft,t=P.clamp((ve.x-12-e)/this.trackLength,0,1);this.soundVolumeKnob.style.left=Math.floor(this.soundVolumeKnobLeft+t*this.trackLength)+"px",K.data.settings.soundVolume=t,ft.updateVolumes(),this.soundTestingSound||(this.soundTestingSound=ft.createAudioSource("testing.wav"),this.soundTestingSound.setLoop(!0),this.soundTestingSound.play())}if(this.draggingMouseSensitivity){let e=this.div.getBoundingClientRect().left*de+this.mouseSensitivityKnobLeft,t=P.clamp((ve.x-12-e)/this.trackLength,0,1);this.mouseSensitivityKnob.style.left=Math.floor(this.mouseSensitivityKnobLeft+t*this.trackLength)+"px",K.data.settings.mouseSensitivity=t}}}selectControlsTab(e){for(let e of[this.marbleControlsDiv,this.cameraControlsDiv,this.mouseControlsDiv])e.classList.add("hidden");let t=["marble","camera","mouse"].indexOf(e);[this.marbleControlsDiv,this.cameraControlsDiv,this.mouseControlsDiv][t].classList.remove("hidden"),this.controlsBackground.src="./assets/ui/options/"+["cntrl_marb_bse.png","cntrl_cam_bse.png","cntrl_mous_base.png"][t],"mouse"===e?(this.controlsBackground.style.left="2px",this.controlsBackground.style.top="-1px"):(this.controlsBackground.style.left="",this.controlsBackground.style.top="")}refreshKeybindings(){this.buttonMarbleLeftContent.textContent=this.formatKeybinding("left"),this.buttonMarbleRightContent.textContent=this.formatKeybinding("right"),this.buttonMarbleUpContent.textContent=this.formatKeybinding("up"),this.buttonMarbleDownContent.textContent=this.formatKeybinding("down"),this.buttonMarbleUseContent.textContent=this.formatKeybinding("use"),this.buttonMarbleJumpContent.textContent=this.formatKeybinding("jump"),this.buttonCameraLeftContent.textContent=this.formatKeybinding("cameraLeft"),this.buttonCameraRightContent.textContent=this.formatKeybinding("cameraRight"),this.buttonCameraUpContent.textContent=this.formatKeybinding("cameraUp"),this.buttonCameraDownContent.textContent=this.formatKeybinding("cameraDown"),this.freeLookKeyContent.textContent=this.formatKeybinding("freeLook"),this.buttonRestartLevelContent.textContent=this.formatKeybinding("restart")}setResetMarbleTextureState(e){e?(this.resetMarbleTexture.style.pointerEvents="",this.resetMarbleTexture.style.filter="",document.querySelector("#graphics-marble-texture-reset-text").style.opacity=""):(this.resetMarbleTexture.style.pointerEvents="none",this.resetMarbleTexture.style.filter="saturate(0)",this.resetMarbleTexture.src="./assets/ui/options/cntr_cam_dwn_n.png",document.querySelector("#graphics-marble-texture-reset-text").style.opacity="0.7")}}class kr{constructor(e){this.initProperties(),e.setupButton(this.homeButton,this.homeButtonSrc,()=>{this.hide(),e.home.show()},void 0,void 0,"gold"===t.modification)}async init(){}show(){this.div.classList.remove("hidden")}hide(){this.div.classList.add("hidden")}}const Cr={startPad:[{dtsPath:"shapes/pads/startarea.dts",distance:6}],endPad:[{dtsPath:"shapes/pads/endarea.dts",distance:6}],gems:[{dtsPath:"shapes/items/gem.dts",distance:1.6,translation:new s(.15,.1,.05),matNamesOverride:{"base.gem":"purple.gem"}},{dtsPath:"shapes/items/gem.dts",distance:1.6,translation:new s(-.2,0,-.2)},{dtsPath:"shapes/items/gem.dts",distance:1.6,translation:new s(.15,0,-.55),matNamesOverride:{"base.gem":"green.gem"}}],superSpeed:[{dtsPath:"shapes/items/superspeed.dts",distance:2.5}],superJump:[{dtsPath:"shapes/items/superjump.dts",distance:2.5,translation:new s(0,0,-.5)}],shockAbsorber:[{dtsPath:"shapes/items/shockabsorber.dts",distance:2.5}],superBounce:[{dtsPath:"shapes/items/superbounce.dts",distance:2.5}],gyrocopter:[{dtsPath:"shapes/images/helicopter.dts",distance:2.5,translation:new s(0,0,-.4)}],timeTravel:[{dtsPath:"shapes/items/timetravel.dts",distance:2.5}],gravityModifier:[{dtsPath:"shapes/items/antigravity.dts",distance:2.5}],ductFan:[{dtsPath:"shapes/hazards/ductfan.dts",distance:3.2}],tornado:[{dtsPath:"shapes/hazards/tornado.dts",distance:10,translation:new s(0,0,-6)}],trapDoor:[{dtsPath:"shapes/hazards/trapdoor.dts",distance:5,translation:new s(0,0,.8)}],bumper:[{dtsPath:"shapes/bumpers/pball_round.dts",distance:1.3,translation:new s(0,0,-.15)}],mine:[{dtsPath:"shapes/hazards/landmine.dts",distance:1.3,translation:new s(0,0,-.1)}],oilslick:[{dtsPath:"shapes/hazards/oilslick.dts",distance:7}]};class Er extends kr{constructor(e){super(e),this.pages=[...document.querySelectorAll(".help-page")],this.helpCanvas=document.createElement("canvas"),this.helpRenderer=new oe({canvas:this.helpCanvas,alpha:!0,desynchronized:!1}),this.helpCamera=new Ei(40,1),this.scenes=new Map,this.shapes=new Map,e.setupButton(this.prevButton,"play/prev",()=>this.cyclePage(-1)),e.setupButton(this.nextButton,"play/next",()=>this.cyclePage(1)),this.showHelpPage(0),requestAnimationFrame(()=>this.update()),this.helpRenderer.setSize(80,80);let t=(new i).setFromRotationMatrix((new d).makeRotationX(1.1));this.helpCamera.orientation.premultiply(t),window.addEventListener("keydown",e=>{this.div.classList.contains("hidden")||"Escape"===e.code&&(this.homeButton.src="./assets/ui/play/back_d.png")}),window.addEventListener("keyup",e=>{this.div.classList.contains("hidden")||"Escape"===e.code&&this.homeButton.click()})}initProperties(){this.div=document.querySelector("#help"),this.homeButton=document.querySelector("#help-back"),this.homeButtonSrc="play/back",this.prevButton=document.querySelector("#help-prev"),this.nextButton=document.querySelector("#help-next")}show(){super.show(),this.initHelpScenes(),this.showHelpPage(0)}cyclePage(e){let t=this.pages.indexOf(this.currentPage);t=P.adjustedMod(t+e,this.pages.length),this.showHelpPage(t)}showHelpPage(e){for(let e of this.pages)e.classList.add("hidden");this.pages[e].classList.remove("hidden"),this.currentPage=this.pages[e];let t=this.currentPage.querySelector(".help-paragraph");if(t)for(let e of t.children){let t=e.getAttribute("data-button");if(t){let i=P.getKeyForButtonCode(K.data.settings.gameButtonMapping[t]);e.textContent=i}}}async update(){if(requestAnimationFrame(this.update.bind(this)),this.div.classList.contains("hidden"))return;let e=performance.now(),t=this.currentPage.querySelectorAll(".help-canvas-row");for(let i of t){let t=i.children[0],s=t.getAttribute("data-scene"),n=this.scenes.get(s);if(!(null===n||void 0===n?void 0:n.compiled))continue;let a=this.shapes.get(s);for(let t of a){let i=new Li(0,0,e/3e3*Math.PI);t.group.orientation.setFromEuler(i),t.group.recomputeTransform()}this.helpCamera.updateMatrixWorld(),n.prepareForRender(this.helpCamera),this.helpRenderer.render(n,this.helpCamera);let r=t.getContext("2d");r.clearRect(0,0,80,80),r.drawImage(this.helpCanvas,0,0)}}async initHelpScenes(){if(this.scenes.size>0)return;let e={timeSinceLoad:0,currentAttemptTime:0,gameplayClock:0,physicsTickCompletion:0,tickIndex:0};for(let e in Cr){let t=new yn(this.helpRenderer),i=Cr[e],s=[];for(let e of i){let t=new ei;t.dtsPath=e.dtsPath,e.matNamesOverride&&(t.matNamesOverride=e.matNamesOverride),s.push(t)}this.scenes.set(e,t),this.shapes.set(e,s)}let t=[];for(let[,e]of this.shapes)for(let i of e)t.push(i.init());await Promise.all(t);let n=new s(0,0,-1);n.applyQuaternion(this.helpCamera.orientation);for(let[t,a]of this.scenes){let r=this.shapes.get(t);for(let o=0;o<r.length;o++){let l=r[o],h=Cr[t][o],d=n.clone().multiplyScalar(h.distance);h.translation&&d.add(h.translation),l.setTransform(d,new i,new s(1,1,1)),l.render(e),a.add(l.group)}let o=new bn((new s).setScalar(1));a.addAmbientLight(o),a.compile()}}}class Ar extends hn{constructor(){super(...arguments),this.gemCountMinDigits=2,this.showClockBackground=!1,this.supportNumberColors=!1,this.supportFpsMeter=!1}}class Br extends Ks{initProperties(){this.div=document.querySelector("#pause-screen"),this.yesButton=document.querySelector("#pause-yes"),this.noButton=document.querySelector("#pause-no"),this.restartButton=document.querySelector("#pause-restart"),this.replayButton=document.querySelector("#pause-replay"),this.yesSrc="common/yes",this.noSrc="common/no",this.restartSrc="common/restart"}constructor(e){super(e),this.replayButton.addEventListener("click",async e=>{0===e.button&&this.onReplayButtonClick(e.altKey)}),P.onLongTouch(this.replayButton,()=>this.onReplayButtonClick(!0))}}class Pr{constructor(e){this.initProperties(),e.setupButton(this.replayButton,"endgame/replay",()=>{this.div.classList.add("hidden"),t.level.restart(!0),P.isTouchDevice||P.requestPointerLock()}),e.setupButton(this.continueButton,"endgame/continue",()=>t.level.stopAndExit()),e.setupButton(this.nameEntryButton,this.nameEntryButtonSrc,async()=>{let e=this.nameEntryInput.value.trim().slice(0,16);if(e.length<2)return void t.menu.showAlertPopup("Warning","Please enter a proper name for usage in the online leaderboard.");if(P.isNaughty(e))return void t.menu.showAlertPopup("Warning","The name you chose contains words deemed inappropriate. Please do the right thing and choose a non-offensive name.");K.data.lastUsedName=e,K.store();let i=t.level,s=K.insertNewTime(i.mission.path,e,i.finishTime.gameplayClock);if(this.nameEntryScreenDiv.classList.add("hidden"),this.div.style.pointerEvents="",this.drawBestTimes(),s){if("record"===i.replay.mode&&!i.replay.isInvalid){i.replay.canStore=!1;let e=await i.replay.serialize();await K.databasePut("replays",e,s.score[2])}0===s.index&&i.finishTime.gameplayClock<=i.mission.qualifyTime&&cr.submitBestTime(i.mission.path,s.score)}},void 0,void 0,"gold"===t.modification),window.addEventListener("keydown",i=>{t.level&&t.menu===e&&"Enter"===i.key&&(this.nameEntryScreenDiv.classList.contains("hidden")?this.div.classList.contains("hidden")||(this.continueButton.src=e.uiAssetPath+"endgame/continue_d.png"):this.nameEntryButton.src=e.uiAssetPath+this.nameEntryButtonSrc+"_d.png")}),window.addEventListener("keyup",i=>{t.level&&t.menu===e&&"Enter"===i.key&&(this.nameEntryScreenDiv.classList.contains("hidden")?this.div.classList.contains("hidden")||this.continueButton.click():this.nameEntryButton.click())})}get showing(){return!this.div.classList.contains("hidden")}async init(){for(let e=0;e<this.bestTimeCount;e++){let e=this.createBestTimeElement();this.bestTimeContainer.appendChild(e)}}show(){let e=t.level;this.div.classList.remove("hidden");let i=Math.max(e.finishTime.currentAttemptTime-ir,0),s=P.roundToMultiple(Math.max(0,i-e.finishTime.gameplayClock),1e-8),n=!1;e.finishTime.gameplayClock>e.mission.qualifyTime?(this.showMessage("failed"),n=!0):e.finishTime.gameplayClock<=e.mission.ultimateTime?this.showMessage("ultimate"):e.finishTime.gameplayClock<=e.mission.goldTime?this.showMessage("gold"):this.showMessage("qualified"),this.updateTimeElements(i,s,n),this.drawBestTimes();let a=K.getBestTimesForMission(e.mission.path,this.bestTimeCount,this.scorePlaceholderName).filter(t=>t[1]<=e.finishTime.gameplayClock).length;if(a<this.bestTimeCount&&(!n||this.storeNotQualified)?(this.nameEntryScreenDiv.classList.remove("hidden"),this.nameEntryText.textContent=this.generateNameEntryText(a),this.nameEntryInput.value=K.data.lastUsedName,this.div.style.pointerEvents="none"):(this.nameEntryScreenDiv.classList.add("hidden"),this.div.style.pointerEvents=""),!n&&"custom"!==e.mission.type){let i=t.menu.levelSelect;i.currentMission===e.mission&&i.cycleMission(1)}this.viewReplayButton.style.display=e.replay.isInvalid?"none":""}hide(){this.div.classList.add("hidden")}drawBestTimes(){let e=K.getBestTimesForMission(t.level.mission.path,this.bestTimeCount,this.scorePlaceholderName);for(let t=0;t<this.bestTimeCount;t++)this.updateBestTimeElement(this.bestTimeContainer.children[t],e[t],t+1)}async onViewReplayButtonClick(e){let i=t.level;if(e){let e=await i.replay.serialize();dr.download(e,i.mission,!1),P.isTouchDevice&&P.isInFullscreen()&&t.menu.showAlertPopup("Downloaded","The .wrec has been downloaded.")}else{if(!await t.menu.showConfirmPopup("Confirm",`Do you want to start the replay for the last playthrough? This can be done only once if this isn't one of your top ${this.bestTimeCount} local scores.`))return;i.replay.mode="playback",this.replayButton.click()}}handleGamepadInput(){if(this.nameEntryScreenDiv.classList.contains("hidden")){if(!this.div.classList.contains("hidden")){if(Me("use")&&Ce("use")&&(Ee("use"),this.viewReplayButton.click(),ft.play("buttonpress.wav")),Me("jump")&&Ce("jump"))return Ee("jump"),this.continueButton.click(),void ft.play("buttonpress.wav");Me("restart")&&Ce("restart")&&(Ee("restart"),this.replayButton.click(),ft.play("buttonpress.wav"))}}else Me("jump")&&Ce("jump")&&(Ee("jump"),this.nameEntryButton.click(),ft.play("buttonpress.wav"))}}class Ir extends Pr{constructor(e){super(e),this.viewReplayButton=document.querySelector("#finish-view-replay"),this.bestTimeCount=3,this.scorePlaceholderName="Nardo Polo",this.storeNotQualified=!1,this.viewReplayButton.addEventListener("click",async e=>{0===e.button&&this.onViewReplayButtonClick(e.altKey)}),P.onLongTouch(this.viewReplayButton,()=>this.onViewReplayButtonClick(!0)),this.viewReplayButton.addEventListener("mouseenter",()=>ft.play("buttonover.wav")),this.viewReplayButton.addEventListener("mousedown",()=>ft.play("buttonpress.wav"))}initProperties(){this.div=document.querySelector("#finish-screen"),this.time=document.querySelector("#finish-screen-time-time"),this.message=document.querySelector("#finish-message"),this.qualifyTimeElement=document.querySelector("#finish-qualify-time"),this.goldTimeElement=document.querySelector("#finish-gold-time"),this.elapsedTimeElement=document.querySelector("#finish-elapsed-time"),this.bonusTimeElement=document.querySelector("#finish-bonus-time"),this.replayButton=document.querySelector("#finish-replay"),this.continueButton=document.querySelector("#finish-continue"),this.bestTimeContainer=document.querySelector("#finish-best-times"),this.nameEntryScreenDiv=document.querySelector("#name-entry-screen"),this.nameEntryText=document.querySelector("#name-entry-screen > p:nth-child(3)"),this.nameEntryInput=document.querySelector("#name-entry-input"),this.nameEntryButton=this.nameEntryScreenDiv.querySelector("#name-entry-confirm"),this.nameEntryButtonSrc="common/ok"}showMessage(e){this.message.style.color="","gold"===e?this.message.innerHTML='You beat the <span style="color: #fff700;">GOLD</span> time!':"qualified"===e?this.message.innerHTML="You've qualified!":(this.message.innerHTML="You failed to qualify!",this.message.style.color="red")}updateTimeElements(e,i,s){let n=t.level;this.time.textContent=P.secondsToTimeString(n.finishTime.gameplayClock/1e3),this.qualifyTimeElement.textContent=isFinite(n.mission.qualifyTime)?P.secondsToTimeString(n.mission.qualifyTime/1e3):P.secondsToTimeString(5999.999),this.qualifyTimeElement.style.color=s?"red":"",this.qualifyTimeElement.style.textShadow=s?"1px 1px 0px black":"",P.monospaceNumbers(this.qualifyTimeElement);let a=n.mission.goldTime;this.goldTimeElement.textContent=P.secondsToTimeString(a/1e3),this.goldTimeElement.parentElement.style.display=a!==-1/0?"":"none",P.monospaceNumbers(this.goldTimeElement),this.elapsedTimeElement.textContent=P.secondsToTimeString(e/1e3),this.bonusTimeElement.textContent=P.secondsToTimeString(i/1e3),P.monospaceNumbers(this.elapsedTimeElement),P.monospaceNumbers(this.bonusTimeElement)}createBestTimeElement(){let e=document.createElement("div");return e.innerHTML="<p></p><p></p>",e.classList.add("finish-row"),e}updateBestTimeElement(e,i,s){let n=t.level.mission.goldTime;e.children[0].textContent=s+". "+i[0],e.children[1].textContent=P.secondsToTimeString(i[1]/1e3),P.monospaceNumbers(e.children[1]),e.children[1].style.color=i[1]<=n?"#fff700":"",e.children[1].style.textShadow=i[1]<=n?"1px 1px 0px black":""}generateNameEntryText(e){return`You got the ${["best","2nd best","3rd best"][e]} time!`}}const Lr="rgb(255, 204, 0)",_r="rgb(204, 204, 204)",Rr="rgb(255, 221, 34)";class Fr extends Pr{constructor(e){super(e),this.viewReplayButton=document.querySelector("#mbp-finish-view-replay"),this.timeRows=document.querySelector("#mbp-finish-time-rows"),this.nextLevelImage=document.querySelector("#mbp-finish-next-level-image"),this.nextLevelButton=document.querySelector("#mbp-finish-next-level"),this.bestTimeCount=5,this.scorePlaceholderName="Matan W.",this.storeNotQualified=!0,e.setupButton(this.viewReplayButton,"play/replay",e=>this.onViewReplayButtonClick(e.altKey)),P.onLongTouch(this.viewReplayButton,()=>this.onViewReplayButtonClick(!0)),this.qualifyTimeElement=this.createTimeRow("Par Time").children[0],this.goldTimeElement=this.createTimeRow("Gold Time").children[0],this.platinumTimeElement=this.createTimeRow("Platinum Time").children[0],this.ultimateTimeElement=this.createTimeRow("Ultimate Time").children[0],this.elapsedTimeElement=this.createTimeRow("Time Passed").children[0],this.bonusTimeElement=this.createTimeRow("Clock Bonuses").children[0],this.goldTimeElement.parentElement.style.color="rgb(255, 204, 0)",this.platinumTimeElement.parentElement.style.color="rgb(204, 204, 204)",this.ultimateTimeElement.parentElement.style.color="rgb(255, 221, 34)",this.elapsedTimeElement.parentElement.style.marginTop="20px",e.setupButton(this.nextLevelButton,"endgame/level_window",()=>{let e=this.getNextLevel(),i=t.menu.levelSelect;this.continueButton.click(),i.setMissionArray(e.array),i.currentMissionIndex=e.index,i.playCurrentMission()},void 0,void 0,!1)}initProperties(){this.div=document.querySelector("#mbp-finish-screen"),this.time=document.querySelector("#mbp-finish-screen-time-time"),this.message=document.querySelector("#mbp-finish-message"),this.replayButton=document.querySelector("#mbp-finish-replay"),this.continueButton=document.querySelector("#mbp-finish-continue"),this.bestTimeContainer=document.querySelector("#mbp-finish-screen-top-times"),this.nameEntryScreenDiv=document.querySelector("#mbp-name-entry-screen"),this.nameEntryText=document.querySelector("#mbp-name-entry-screen > p:nth-child(3)"),this.nameEntryInput=document.querySelector("#mbp-name-entry-input"),this.nameEntryButton=this.nameEntryScreenDiv.querySelector("#mbp-name-entry-confirm"),this.nameEntryButtonSrc="endgame/ok"}createTimeRow(e){let t=document.createElement("p");return t.innerHTML=e+":<span></span>",this.timeRows.appendChild(t),t}show(){super.show();let e=this.getNextLevel(),t=e.array[e.index];this.nextLevelImage.src=t.getImagePath()}showMessage(e){this.message.style.color="","ultimate"===e?this.message.innerHTML=`You beat the <span style="color: ${Rr};">Ultimate</span> Time!`:"gold"===e?"gold"===t.level.mission.modification?this.message.innerHTML=`You beat the <span style="color: ${Lr};">Gold</span> Time!`:this.message.innerHTML=`You beat the <span style="color: ${_r};">Platinum</span> Time!`:"qualified"===e?this.message.innerHTML="You beat the Par Time!":(this.message.innerHTML="You didn't pass the Par Time!",this.message.style.color="rgb(245, 85, 85)")}updateTimeElements(e,i){let s=t.level;this.time.textContent=P.secondsToTimeString(s.finishTime.gameplayClock/1e3),this.qualifyTimeElement.textContent=isFinite(s.mission.qualifyTime)?P.secondsToTimeString(s.mission.qualifyTime/1e3):P.secondsToTimeString(5999.999),P.monospaceNumbers(this.qualifyTimeElement);let n=s.mission.goldTime;this.goldTimeElement.parentElement.style.display="none",this.platinumTimeElement.parentElement.style.display="none",n!==-1/0&&("gold"===s.mission.modification?(this.goldTimeElement.textContent=P.secondsToTimeString(n/1e3),this.goldTimeElement.parentElement.style.display="",P.monospaceNumbers(this.goldTimeElement)):(this.platinumTimeElement.textContent=P.secondsToTimeString(n/1e3),this.platinumTimeElement.parentElement.style.display="",P.monospaceNumbers(this.platinumTimeElement)));let a=s.mission.ultimateTime;this.ultimateTimeElement.parentElement.style.display="none",a!==-1/0&&(this.ultimateTimeElement.textContent=P.secondsToTimeString(a/1e3),this.ultimateTimeElement.parentElement.style.display="",P.monospaceNumbers(this.ultimateTimeElement)),this.elapsedTimeElement.textContent=P.secondsToTimeString(e/1e3),this.bonusTimeElement.textContent=P.secondsToTimeString(i/1e3),P.monospaceNumbers(this.elapsedTimeElement),P.monospaceNumbers(this.bonusTimeElement)}createBestTimeElement(){return document.createElement("div")}updateBestTimeElement(e,i,s){let n=t.level.mission.goldTime,a=t.level.mission.ultimateTime,r=document.createElement("div");r.textContent=P.secondsToTimeString(i[1]/1e3),P.monospaceNumbers(r),e.innerHTML=`<div><span>${s}. </span>${P.htmlEscape(i[0])}</div><div>${r.innerHTML}</div>`,e.style.color="",i[1]<=n&&(e.style.color="gold"===t.level.mission.modification?Lr:_r),i[1]<=a&&(e.style.color=Rr)}generateNameEntryText(e){return`You have the ${["top","second top","third top","fourth top","fifth top"][e]} time!`}getNextLevel(){let e=t.menu.levelSelect,i=e.currentMissionArray.indexOf(t.level.mission);if(i<e.currentMissionArray.length-1)return{index:i+1,array:e.currentMissionArray};if("custom"===e.currentMission.type)return{index:i,array:e.currentMissionArray};return{index:0,array:$a.allCategories[$a.allCategories.indexOf(e.currentMissionArray)+1]}}}class Ur extends yr{constructor(){super(...arguments),this.loadReplayButton=document.querySelector("#mbp-load-replay-button"),this.shuffleButton=document.querySelector("#mbp-shuffle-button"),this.viewToggleButton=document.querySelector("#mbp-level-select-view-toggle"),this.metadataContainer=document.querySelector("#mbp-level-metadata"),this.scoresContainer=document.querySelector("#mbp-level-scores"),this.easterEggIcon=document.querySelector("#mbp-level-select-egg"),this.difficultySelectorCollapsed=document.querySelector("#mbp-difficulty-selector-collapsed"),this.difficultySelectorModificationIcon=document.querySelector("#mbp-difficulty-selector-modification-icon"),this.difficultySelectorWindow=document.querySelector("#mbp-difficulty-selector-window"),this.difficultySelectorContent=document.querySelector("#mbp-difficulty-selector-window > ._content"),this.localScoresCount=5,this.scorePlaceholderName="Matan W.",this.scoreElementHeight=16}initProperties(){this.div=document.querySelector("#mbp-level-select"),this.homeButton=document.querySelector("#mbp-level-select-home-button"),this.homeButtonSrc="play/menu",this.prevButton=document.querySelector("#mbp-level-select-prev"),this.playButton=document.querySelector("#mbp-level-select-play"),this.nextButton=document.querySelector("#mbp-level-select-next"),this.levelImage=document.querySelector("#mbp-level-image"),this.levelTitle=document.querySelector("#mbp-level-title"),this.levelArtist=document.querySelector("#mbp-level-artist"),this.levelDescription=document.querySelector("#mbp-level-description"),this.levelQualifyTime=document.querySelector("#mbp-level-qualify-time"),this.localBestTimesContainer=document.querySelector("#mbp-level-select-local-best-times"),this.leaderboardLoading=document.querySelector("#mbp-online-leaderboard-loading"),this.leaderboardScores=document.querySelector("#mbp-leaderboard-scores"),this.scrollWindow=document.querySelector("#mbp-level-select-text-window"),this.searchInput=document.querySelector("#mbp-search-input")}async init(){await super.init(),this.menu.setupVaryingButton(this.difficultySelectorCollapsed,["play/difficulty_beginner","play/difficulty_intermediate","play/difficulty_advanced","play/difficulty_expert","play/difficulty_custom"],()=>{this.difficultySelectorWindow.classList.contains("hidden")?this.difficultySelectorWindow.classList.remove("hidden"):this.difficultySelectorWindow.classList.add("hidden")},void 0,void 0,!1),this.createDifficultySection("Gold","./assets/ui_mbp/play/marble_gold.png",[{name:"Beginner",arr:$a.goldBeginner},{name:"Intermediate",arr:$a.goldIntermediate},{name:"Advanced",arr:$a.goldAdvanced},{name:"Custom",arr:$a.goldCustom}]),this.createDifficultySection("Platinum","./assets/ui_mbp/play/marble_platinum.png",[{name:"Beginner",arr:$a.platinumBeginner},{name:"Intermediate",arr:$a.platinumIntermediate},{name:"Advanced",arr:$a.platinumAdvanced},{name:"Expert",arr:$a.platinumExpert},{name:"Custom",arr:$a.platinumCustom}]),this.createDifficultySection("Ultra","./assets/ui_mbp/play/marble_ultra.png",[{name:"Beginner",arr:$a.ultraBeginner},{name:"Intermediate",arr:$a.ultraIntermediate},{name:"Advanced",arr:$a.ultraAdvanced},{name:"Custom",arr:$a.ultraCustom}]),this.difficultySelectorWindow.querySelector("._click-preventer").addEventListener("mousedown",()=>{ft.play("buttonpress.wav")}),this.difficultySelectorWindow.querySelector("._click-preventer").addEventListener("click",()=>{this.difficultySelectorWindow.classList.add("hidden")}),this.menu.setupVaryingButton(this.viewToggleButton,["mp/play/scoresactive","mp/play/settingsactive"],()=>{this.scoresContainer.classList.contains("hidden")?(this.metadataContainer.classList.add("hidden"),this.scoresContainer.classList.remove("hidden"),this.levelQualifyTime.classList.add("hidden"),this.scrollWindow.style.height="",this.menu.setButtonVariant(this.viewToggleButton,1),this.viewToggleButton.title="Show level information"):(this.metadataContainer.classList.remove("hidden"),this.scoresContainer.classList.add("hidden"),this.levelQualifyTime.classList.remove("hidden"),this.scrollWindow.style.height="150px",this.menu.setButtonVariant(this.viewToggleButton,0),this.viewToggleButton.title="Show scores")},void 0,void 0,!1),this.menu.setupButton(this.loadReplayButton,"play/replay",e=>{this.showLoadReplayPrompt(e)},void 0,void 0,!1),this.menu.setupButton(this.shuffleButton,"search/random",()=>{this.shuffle()},void 0,void 0,!1);for(let e of $a.allCategories)this.setMissionArray(e,!1);this.setMissionArray(P.randomFromArray([$a.goldBeginner,$a.platinumBeginner,$a.ultraBeginner]),!1),await ne.loadImages(["play/eggnotfound.png","play/eggfound.png","play/marble_gold.png","play/marble_platinum.png","play/marble_ultra.png","mp/menu/brown/joined.png","mp/menu/brown/divider-orange-joined.png","options/textentry.png"].map(e=>"./assets/ui_mbp/"+e))}createDifficultySection(e,t,i){let s=document.createElement("div"),n=document.createElement("p"),a=document.createElement("img");s.classList.add("_section"),s.append(n,a),n.textContent=e,a.src=t;for(let e of i){let t=document.createElement("div"),i=document.createElement("p"),n=document.createElement("img");t.append(i,n),s.append(t),i.textContent=e.name,this.menu.setupButton(n,"play/difficulty_highlight-120",()=>{this.setMissionArray(e.arr),this.difficultySelectorWindow.classList.add("hidden")}),e.arr||(t.style.opacity="0.333",t.style.pointerEvents="none")}this.difficultySelectorContent.append(s)}setMissionArray(e,t){super.setMissionArray(e,t),e.length>0&&(this.menu.setButtonVariant(this.difficultySelectorCollapsed,["beginner","intermediate","advanced","expert","custom"].indexOf($a.getDifficulty(e))),this.difficultySelectorModificationIcon.src="./assets/ui_mbp/play/"+("gold"===$a.getModification(e)?"marble_gold.png":"ultra"===$a.getModification(e)?"marble_ultra.png":"marble_platinum.png")),this.updateBackground()}displayMetadata(){let e=this.currentMission;this.levelTitle.textContent=`#${this.currentMissionIndex+1}: ${e.title}`,this.levelArtist.textContent="Author: "+e.artist.trim(),this.levelDescription.textContent=e.description;let t=0!==e.qualifyTime?e.qualifyTime:1/0;this.levelQualifyTime.innerHTML=`<span style="opacity: 0.8;">${"gold"===e.modification?"Qualify":"Par"} Time: </span>`+(isFinite(t)?P.secondsToTimeString(t/1e3):"N/A"),e.hasEasterEgg?(this.easterEggIcon.classList.remove("hidden"),this.easterEggIcon.src=K.data.collectedEggs.includes(e.path)?"./assets/ui_mbp/play/eggfound.png":"./assets/ui_mbp/play/eggnotfound.png"):this.easterEggIcon.classList.add("hidden")}displayEmptyMetadata(){this.levelTitle.innerHTML="<br>",this.levelArtist.innerHTML="<br>",this.levelDescription.innerHTML="<br>",this.levelQualifyTime.innerHTML="",this.easterEggIcon.classList.add("hidden")}createScoreElement(e){let t=document.createElement("div");t.classList.add("mbp-level-select-best-time");let i=document.createElement("div");t.appendChild(i);let s=document.createElement("div");return t.appendChild(s),t.appendChild(this.createReplayButton(e)),t}getReplayButtonForScoreElement(e){return e.children[2]}updateScoreElement(e,t,i){e.children[0].innerHTML=`<span>${i}.</span> ${P.htmlEscape(t[0])}`,e.children[1].textContent=P.secondsToTimeString(t[1]/1e3),P.monospaceNumbers(e.children[1]),e.style.color="",this.currentMission&&(t[1]<=this.currentMission.goldTime&&(e.style.color="gold"===this.currentMission.modification?Lr:_r),t[1]<=this.currentMission.ultimateTime&&(e.style.color=Rr))}show(){super.show(),this.updateBackground()}updateBackground(){let e=this.currentMissionArray;t.menu.backgroundImage.src="gold"===$a.getModification(e)?t.menu.mbgBg:"ultra"===$a.getModification(e)?t.menu.mbuBg:t.menu.mbpBg}}class zr extends vr{constructor(e){super(e),this.onlineButton=document.querySelector("#mbp-home-online")}initProperties(){this.div=document.querySelector("#mbp-home-screen"),this.playButton=document.querySelector("#mbp-home-play"),this.optionsButton=document.querySelector("#mbp-home-options"),this.helpButton=document.querySelector("#mbp-home-help"),this.exitButton=document.querySelector("#mbp-home-quit"),this.showChangelogButton=document.querySelector("#mbp-show-changelog"),this.changelogContainer=document.querySelector("#mbp-changelog"),this.changelogBackButton=document.querySelector("#mbp-changelog-back"),this.changelogContent=document.querySelector("#mbp-changelog-content"),this.version=document.querySelector("#mbp-version"),this.playSrc="menu/play",this.optionsSrc="menu/options",this.helpSrc="menu/help",this.exitSrc="menu/quit",this.showChangelogSrc="menu/changelog",this.changelogBackSrc="motd/ok"}show(){super.show(),t.menu.backgroundImage.src=t.menu.homeBg}}class Dr extends Sr{constructor(){super(...arguments),this.maxProgressBarWidth=219}initProperties(){this.div=document.querySelector("#mbp-loading"),this.levelNameElement=document.querySelector("#mbp-loading-level-name"),this.cancelButton=document.querySelector("#mbp-loading-cancel"),this.progressBar=document.querySelector("#mbp-loading-progress")}}const Vr=["webport","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22"],Or=/<.+?>/g,Nr=/&lt;a:(.+?)&gt;(.+?)&lt;\/a&gt;/g;class qr extends kr{constructor(){super(...arguments),this.pagePicker=document.querySelector("#mbp-help-picker"),this.pageElements=[]}initProperties(){this.div=document.querySelector("#mbp-help"),this.homeButton=document.querySelector("#mbp-help-home"),this.homeButtonSrc="manual/home"}async init(){let e=[];for(let t of Vr){let i=`./assets/ui_mbp/manual/pages/${t}.txt`;e.push(ne.loadResource(i))}let t=await Promise.all(e),i=await Promise.all(t.map(e=>ne.readBlobAsText(e)));for(let e of i){let t=e.slice(0,e.indexOf("\n")),s=document.createElement("div");s.textContent=t,s.addEventListener("mousedown",()=>this.selectPage(i.indexOf(e))),this.pagePicker.appendChild(s);let n=document.createElement("div");n.classList.add("_page","hidden"),n.innerHTML=this.generatePageHtml(e),this.pageElements.push(n),this.div.appendChild(n)}this.selectPage(0)}selectPage(e){for(let e of this.pagePicker.children)e.classList.remove("selected");this.pagePicker.children[e].classList.add("selected");for(let e of this.pageElements)e.classList.add("hidden");this.pageElements[e].classList.remove("hidden"),this.pageElements[e].scrollTop=0}generatePageHtml(e){let t="",i=[],s="",n=e.slice(0,e.indexOf("\n")),a=document.createElement("h1");for(a.textContent=n,s+=a.outerHTML,e=e.slice(e.indexOf("\n")+1);;){let n;for(Or.lastIndex=0;(n=Or.exec(e))&&!n[0].startsWith("<just")&&!n[0].startsWith("<font")&&"<spush>"!==n[0]&&"<spop>"!==n[0];);let a=document.createElement("div");if(t&&a.setAttribute("style",t),!n){a.textContent=e,a.innerHTML&&(s+=a.outerHTML);break}if(a.textContent=e.slice(0,n.index),a.innerHTML&&(s+=a.outerHTML),n[0].startsWith("<just"))t+="text-align: "+n[0].slice(6,-1)+";";else if(n[0].startsWith("<font")){t+=`font-family: ${n[0].slice(6,n[0].lastIndexOf(":"))};font-size: ${n[0].slice(n[0].lastIndexOf(":")+1,-1)}px;`}else"<spush>"===n[0]?i.push(t):"<spop>"===n[0]&&(t=i.pop());e=e.slice(n.index+n[0].length)}return s=s.replace(Nr,'<a href="http://$1" target="_blank">$2</a>')}}const jr={gold:12,platinum:28,ultra:9,multi:13};let Gr,Wr;const Hr=document.querySelector("#switching-message"),Xr=async e=>{var i;null===(i=t.menu)||void 0===i||i.hide(),t.menu&&Hr.classList.remove("hidden"),document.querySelector("#favicon").setAttribute("href","gold"===e?"./assets/img/marble-blast-gold-logo.png":"./assets/img/mbp.png"),"gold"===e?Gr?(t.modification="gold",t.menu=Gr,Gr.show()):(Gr=new class extends xr{constructor(){super(...arguments),this.audioAssetPath="./assets/data/sound/",this.menuMusicSrc="shell.ogg",this.popupBackgroundSrc="./assets/ui/common/dialog.png",this.popupOkaySrc="common/ok",this.popupNoSrc="common/no",this.popupYesSrc="common/yes"}get uiAssetPath(){return"./assets/ui/"}createHome(){return new wr(this)}createLevelSelect(){return new br(this)}createLoadingScreen(){return new Tr(this)}createOptionsScreen(){return new Mr(this)}createHelpScreen(){return new Er(this)}createHud(){return new Ar(this)}createPauseScreen(){return new Br(this)}createFinishScreen(){return new Ir(this)}getMenuDiv(){return document.querySelector("#menu")}getBackgroundImage(){return document.querySelector("#background-image")}async init(){P.isWeeb&&(this.backgroundImage.src=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`),await super.init()}},t.modification="gold",t.menu=Gr,await Gr.init(),Wr&&Gr.show()):Wr?(t.modification="platinum",t.menu=Wr,Wr.show()):(Wr=new class extends xr{constructor(){super(...arguments),this.audioAssetPath="./assets/data_mbp/sound/",this.menuMusicSrc="music/pianoforte.ogg",this.popupBackgroundSrc="./assets/ui_mbp/play/text_window.png",this.popupOkaySrc="achiev/close",this.popupNoSrc="exit/no",this.popupYesSrc="exit/yes"}get uiAssetPath(){return"./assets/ui_mbp/"}createHome(){return new zr(this)}createLevelSelect(){return new Ur(this)}createLoadingScreen(){return new Dr(this)}createOptionsScreen(){return new rn(this)}createHelpScreen(){return new qr(this)}createHud(){return new dn(this)}createPauseScreen(){return new Qs(this)}createFinishScreen(){return new Fr(this)}getMenuDiv(){return document.querySelector("#mbp-menu")}getBackgroundImage(){return document.querySelector("#mbp-background-image")}async init(){let e=P.randomFromArray(Object.keys(jr)),t=Math.floor(Math.random()*jr[e])+1,i=Math.floor(Math.random()*jr.gold)+1,s=Math.floor(Math.random()*jr.platinum)+1,n=Math.floor(Math.random()*jr.ultra)+1;this.homeBg="./assets/ui_mbp/backgrounds/"+e+"/"+t+".jpg",this.mbgBg="./assets/ui_mbp/backgrounds/gold/"+i+".jpg",this.mbpBg="./assets/ui_mbp/backgrounds/platinum/"+s+".jpg",this.mbuBg="./assets/ui_mbp/backgrounds/ultra/"+n+".jpg",P.isWeeb&&(this.homeBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`,this.mbgBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`,this.mbpBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`,this.mbuBg=`./assets/img/weeb${Math.floor(4*Math.random()+1)}.jpg`),await ne.loadImages([this.homeBg,this.mbgBg,this.mbpBg,this.mbuBg]),await super.init()}},t.modification="platinum",t.menu=Wr,await Wr.init(),Gr&&Wr.show()),Hr.classList.add("hidden"),K.data.modification=e,K.store()},Yr=document.querySelector("#loading-message"),Kr=document.querySelector("#loading-detail"),Qr=document.querySelector("#start-game-dialog");window.onload=(async()=>{if(await P.init(),await K.init(),await ne.init(),he=new oe({canvas:le,desynchronized:K.data.settings.canvasDesynchronized}),ue(!1),Kr.textContent="Loading levels...",await $a.init(),ft.init(),Kr.textContent="Loading UI...",await Xr(K.data.modification),Kr.textContent="Loading leaderboard...",await cr.init(),P.isWeeb&&(document.title="Marble Blast Weeb"),P.isTouchDevice&&!location.search.includes("app")){let e=document.createElement("div");e.id="install-popup";let i=document.createElement("img");i.src="./assets/img/download.png",i.style.display="none",e.append(i),i.addEventListener("click",()=>{to.prompt()});let s=setInterval(()=>{to&&(i.style.display="")},100);t.menu.showAlertPopup("Install as app",'This website can be installed on your device\'s home screen to run in proper fullscreen and feel like a native app. To install it, press the icon below, or if there is none, follow <a href="https://natomasunified.org/kb/add-website-to-mobile-device-home-screen/" target="_blank">these</a> steps.',e).then(()=>{clearInterval(s)})}let e=!1;const i=async()=>{e=!0,Qr.style.display="none",ft.context.resume(),t.menu.show()};Yr.style.display="none",Kr.style.display="none","running"!==ft.context.state||P.isSafari()?(P.isInFullscreen()||P.isTouchDevice?(Qr.children[0].textContent="Click anywhere to start",Qr.children[1].textContent=""):Qr.children[0].textContent=`Press ${P.isMac()?"^‚åòF":"F11"} to start in fullscreen mode`,Qr.style.display="block",window.addEventListener("mousedown",()=>{e||i()}),window.addEventListener("pointerdown",()=>{e||i()}),window.addEventListener("keydown",t=>{e||"F11"!==t.code||P.isInFullscreen()||i()})):i()});let $r=null,Zr=[];window.addEventListener("error",e=>{Zr.push({message:e.error.stack,lineno:e.lineno,colno:e.colno,filename:e.filename}),null===$r&&Jr()}),window.addEventListener("unhandledrejection",e=>{Zr.push({message:e.reason instanceof Error?e.reason.stack:e.reason.toString(),lineno:0,colno:0,filename:"Unhandled in Promise"}),null===$r&&Jr()});const Jr=()=>{if($r=null,0===Zr.length)return;let e=[];Zr.length=Math.min(Zr.length,16);for(let t of Zr)e.push({message:t.message,line:t.lineno,column:t.colno,filename:t.filename});Zr.length=0,e.length>0&&fetch("./api/error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userAgent:navigator.userAgent,errors:e})}),$r=setTimeout(Jr,5e3)},eo=P.getRandomId();setInterval(()=>{fetch("/api/activity?id="+eo)},3e4),navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js",{scope:"/"}).then(e=>{e.update()}).catch(e=>{console.log("Service worker registration failed, error:",e)});let to=null;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),to=e})}()}();